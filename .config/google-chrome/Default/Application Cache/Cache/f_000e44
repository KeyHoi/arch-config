/*
 * tolino WebReader
 * Copyright (c) 2017 Rakuten Kobo Inc.
 */
angular.module("config",[]).constant("CONFIG",{globals:{SYNC_PATH:{DOGEAR:"/dogears",COMMENT:"/comments",BOOKMARK:"/bookmark",TAG:"/tags"},SYNC_OP:{ADD:"add",REMOVE:"remove",REPLACE:"replace"},SHELF_REVISION:"shelf_revision",SHELF_SYNC_TIME:"shelf_sync_time",SYNC_VALUES:{"/bookmark":{revision:"revision",modified:"modified",progress:"progress",position:"rmsdkPosition",currentPosition:"currentPage",lastPosition:"lastPage"},"/dogears":{revision:"revision",modified:"modified",position:"rmsdkPosition",name:"displayName"},"/comments":{revision:"revision",modified:"modified",startPosition:"rmsdkPosition",endPosition:"endPosition",note:"markerComment",text:"markedBookText"},"/tags":{revision:"revision",modified:"modified",name:"name",category:"category"}},SYNC_DEFAULTS:{"/bookmark":{progress:0},"/dogears":{},"/comments":{},"/tags":{}},INDEXED_CONFIG:{covers:{name:"_covers_",version:4,prefix:"tolino",objectStores:["covers"]},inventory:{name:"_inventory_",version:4,prefix:"tolino",objectStores:["inventory"]},comic:{name:"_comic_",version:4,prefix:"tolino",objectStores:["meta","file"]}},ANNOTATION:{COMMENT_COLORS:["rgba(251, 250,  56, 0.5)","rgba(251, 250,  56, 0.5)","rgba(249, 168, 244, 0.5)","rgba(235, 176, 110, 0.5)","rgba(181, 218, 236, 0.5)","rgba(176, 213, 132, 0.5)"],DOGEAR_CLASSNAME:"tw-dogear",SEARCHMARK_COLOR:"rgba(162, 203, 229, 1)"},ERROR:{ABORT:"ABORT",UNSUPPORTED_MEDIA:"UNSUPPORTED_MEDIA",LOCALSTORAGE_FAIL:"LOCALSTORAGE_FAIL",MISSING_ID:"MISSING_ID",DEVICE_LIMIT:"DEVICE_LIMIT",NETWORK_BOSH_FAIL:"NETWORK_BOSH_FAIL",NETWORK_OFFLINE:"NETWORK_OFFLINE",NETWORK_TIMEOUT:"NETWORK_TIMEOUT",NETWORK_AUTOLOGIN_PROGRESS:"NETWORK_AUTOLOGIN_PROGRESS",BROWSER_PRIVATE_MODE:"BROWSER_PRIVATE_MODE",BROWSER_STORAGE_FAIL:"BROWSER_STORAGE_FAIL",APP_SYNC_ERROR:"APP_SYNC_ERROR",APP_SYNC_BOOKMARK_CONFLICT:"APP_SYNC_BOOKMARK_CONFLICT",APP_CONTENT_DELIVERABLE_FAIL:"APP_CONTENT_DELIVERABLE_FAIL",APP_CONTENT_PARSER_FAIL:"APP_CONTENT_PARSER_FAIL",APP_DEVICE_LIMIT_REACHED:"APP_DEVICE_LIMIT_REACHED",APP_GENERAL_ERROR:"APP_GENERAL_ERROR",APP_INVALID_CONFIG:"APP_INVALID_CONFIG",APP_INVALID_CRYPTO:"APP_INVALID_CRYPTO",APP_INVALID_USER:"APP_INVALID_USER",APP_INVALID_TOKEN:"APP_INVALID_TOKEN",APP_NO_CONFIG:"APP_NO_CONFIG",APP_NO_COUNTRY:"APP_NO_COUNTRY",APP_NO_DELIVERABLE_ID:"APP_NO_DELIVERABLE_ID",APP_NO_DELIVERABLE:"APP_NO_DELIVERABLE",APP_NO_RESELLER:"APP_NO_RESELLER",RENDER_IN_PROGRESS:"Render already in progress"},FONT:{CUSTOM:{bitter:{id:"bitter",name:"Bitter",preview:"<path d='M2-1.28L0.64-0.96L0.64 0L5.2 0C7.84 0 9.28-0.96 9.28-3.2C9.28-4.48 8.48-5.42 6.8-5.81C8.14-6.14 8.88-6.96 8.88-8.4C8.88-10.32 7.44-11.2 5.44-11.2L3.6-11.2L0.64-11.12L0.64-10.24L2-9.92ZM3.6-6.4L3.6-9.92L5.36-9.92C6.4-9.92 7.2-9.36 7.2-8.24C7.2-6.96 6.24-6.4 4.8-6.4ZM3.6-1.28L3.6-5.2L4.8-5.2C6.56-5.2 7.6-4.72 7.6-3.12C7.6-1.92 6.8-1.28 5.28-1.28ZM11.76-11.12C11.76-10.4 12.16-10 12.8-10C13.28-10 13.84-10.4 13.84-11.12C13.84-11.92 13.44-12.24 12.8-12.24C12.24-12.24 11.76-11.84 11.76-11.12ZM14.88-0.88L13.68-1.28L13.68-8.48L10.72-8.4L10.72-7.52L12.08-7.2L12.08-1.28L10.72-0.88L10.72 0L14.88 0ZM21.28-8.4L18.96-8.4L18.96-10.74L17.36-10.42L17.36-8.4L15.76-8.24L15.76-7.2L17.36-7.2L17.36-2.16C17.36-0.37 18.24 0.16 19.2 0.16C20 0.16 20.72-0.11 21.44-0.64L21.01-1.49C20.59-1.26 20.14-1.09 19.76-1.09C19.31-1.09 18.96-1.33 18.96-2.06L18.96-7.2L21.28-7.2ZM27.6-8.4L25.28-8.4L25.28-10.74L23.68-10.42L23.68-8.4L22.08-8.24L22.08-7.2L23.68-7.2L23.68-2.16C23.68-0.37 24.56 0.16 25.52 0.16C26.32 0.16 27.04-0.11 27.76-0.64L27.33-1.49C26.91-1.26 26.46-1.09 26.08-1.09C25.63-1.09 25.28-1.33 25.28-2.06L25.28-7.2L27.6-7.2ZM35.92-4C35.92-4.03 36-4.48 36-4.88C36-7.28 34.96-8.64 32.64-8.64C30.32-8.64 28.72-6.72 28.72-4.16C28.72-1.52 30 0.16 32.56 0.16C34.48 0.16 35.97-1.17 35.97-1.17L35.41-2C35.41-2 34.32-1.12 32.72-1.12C31.34-1.12 30.4-2.24 30.4-4ZM30.46-5.2C30.56-6.4 31.28-7.39 32.56-7.39C33.84-7.39 34.3-6.4 34.3-5.2ZM40-8.48L37.36-8.4L37.36-7.52L38.72-7.2L38.72-1.28L37.36-0.88L37.36 0L41.92 0L41.92-0.88L40.32-1.28L40.32-6.03C40.67-6.5 41.44-7.28 42.64-7.28L42.88-6.08L43.92-6.08L44-8.4C44-8.4 43.36-8.64 42.56-8.64C41.47-8.64 40.54-7.76 40.14-7.31Z'/>",variants:[{style:"normal",src:"Bitter-Regular",weight:400},{style:"normal",src:"Bitter-Bold",weight:700},{style:"italic",src:"Bitter-Italic",weight:400},{style:"italic",src:"Bitter-BoldItalic",weight:700}]},droidSerif:{id:"droidSerif",name:"Droid Serif",preview:"<path d='M0.61 0L0.61-0.67L0.81-0.67Q1.09-0.67 1.32-0.71Q1.56-0.75 1.74-0.87Q1.92-0.99 2.02-1.22Q2.13-1.45 2.13-1.82L2.13-9.66Q2.13-10.02 2.02-10.23Q1.91-10.45 1.73-10.56Q1.55-10.68 1.32-10.71Q1.08-10.75 0.81-10.75L0.61-10.75L0.61-11.42L5.51-11.42Q6.74-11.42 7.71-11.04Q8.68-10.66 9.35-9.94Q10.02-9.21 10.37-8.15Q10.72-7.09 10.72-5.73Q10.72-4.41 10.39-3.36Q10.06-2.3 9.41-1.55Q8.77-0.8 7.79-0.40Q6.81 0 5.51 0L0.61 0M3.74-0.81L5.13-0.81Q6.09-0.81 6.8-1.14Q7.52-1.46 7.99-2.09Q8.47-2.71 8.71-3.63Q8.95-4.54 8.95-5.73Q8.95-8.11 8-9.37Q7.05-10.63 5.15-10.63L3.74-10.63L3.74-0.81ZM11.25 0L11.25-0.67L11.3-0.67Q11.57-0.67 11.81-0.71Q12.05-0.75 12.22-0.87Q12.4-0.99 12.5-1.22Q12.61-1.45 12.61-1.82L12.61-6.81Q12.61-7.16 12.5-7.38Q12.4-7.59 12.22-7.71Q12.04-7.83 11.8-7.87Q11.56-7.91 11.3-7.91L11.25-7.91L11.25-8.58L13.71-8.58L14.02-6.99L14.09-6.99Q14.25-7.35 14.41-7.67Q14.58-7.98 14.82-8.22Q15.05-8.46 15.41-8.60Q15.76-8.73 16.29-8.73Q17.16-8.73 17.59-8.43Q18.02-8.13 18.02-7.57Q18.02-7.32 17.93-7.11Q17.85-6.9 17.67-6.75Q17.49-6.59 17.21-6.51Q16.93-6.43 16.52-6.43Q16.52-7.09 16.34-7.39Q16.15-7.68 15.68-7.68Q15.38-7.68 15.15-7.51Q14.91-7.34 14.74-7.07Q14.56-6.79 14.44-6.43Q14.32-6.07 14.25-5.69Q14.17-5.31 14.14-4.94Q14.11-4.56 14.11-4.26L14.11-1.74Q14.11-1.39 14.21-1.18Q14.32-0.96 14.5-0.85Q14.68-0.74 14.92-0.71Q15.16-0.67 15.42-0.67L15.87-0.67L15.87 0L11.25 0ZM18.9-4.30Q18.9-6.55 19.85-7.64Q20.8-8.73 22.66-8.73Q23.52-8.73 24.21-8.46Q24.9-8.2 25.38-7.64Q25.86-7.09 26.11-6.26Q26.37-5.43 26.37-4.30Q26.37-2.05 25.41-0.95Q24.45 0.16 22.61 0.16Q21.74 0.16 21.05-0.12Q20.37-0.39 19.89-0.95Q19.41-1.5 19.15-2.34Q18.9-3.18 18.9-4.30M20.45-4.30Q20.45-3.41 20.56-2.73Q20.68-2.05 20.94-1.60Q21.2-1.14 21.62-0.91Q22.04-0.67 22.64-0.67Q23.24-0.67 23.66-0.91Q24.07-1.14 24.33-1.60Q24.59-2.05 24.7-2.73Q24.81-3.41 24.81-4.30Q24.81-5.2 24.7-5.87Q24.58-6.54 24.32-6.99Q24.06-7.44 23.64-7.66Q23.23-7.89 22.63-7.89Q22.02-7.89 21.61-7.66Q21.2-7.44 20.94-6.99Q20.68-6.54 20.56-5.87Q20.45-5.2 20.45-4.30ZM26.73 0L26.73-0.67L26.95-0.67Q27.21-0.67 27.45-0.71Q27.69-0.74 27.87-0.85Q28.05-0.96 28.15-1.18Q28.26-1.39 28.26-1.74L28.26-6.81Q28.26-7.16 28.15-7.38Q28.05-7.59 27.87-7.71Q27.69-7.83 27.45-7.87Q27.21-7.91 26.95-7.91L26.9-7.91L26.9-8.58L29.76-8.58L29.76-1.82Q29.76-1.45 29.86-1.22Q29.97-0.99 30.14-0.87Q30.32-0.75 30.56-0.71Q30.8-0.67 31.07-0.67L31.28-0.67L31.28 0L26.73 0M28.03-11.17Q28.03-11.45 28.1-11.64Q28.17-11.83 28.3-11.95Q28.42-12.06 28.59-12.11Q28.75-12.16 28.95-12.16Q29.13-12.16 29.3-12.11Q29.46-12.06 29.58-11.95Q29.7-11.83 29.78-11.64Q29.85-11.45 29.85-11.17Q29.85-10.89 29.78-10.70Q29.7-10.52 29.58-10.40Q29.46-10.28 29.3-10.23Q29.13-10.18 28.95-10.18Q28.75-10.18 28.59-10.23Q28.42-10.28 28.3-10.40Q28.17-10.52 28.1-10.70Q28.03-10.89 28.03-11.17ZM32.16-4.27Q32.16-5.43 32.38-6.27Q32.59-7.12 33-7.66Q33.41-8.21 34.02-8.47Q34.63-8.73 35.42-8.73Q35.88-8.73 36.26-8.63Q36.63-8.53 36.93-8.34Q37.23-8.16 37.47-7.90Q37.7-7.64 37.88-7.33L37.97-7.33Q37.95-7.72 37.92-8.06Q37.91-8.36 37.89-8.65Q37.88-8.95 37.88-9.09L37.88-10.40Q37.88-10.75 37.77-10.96Q37.66-11.18 37.48-11.30Q37.3-11.41 37.07-11.45Q36.83-11.48 36.56-11.48L36.43-11.48L36.43-12.16L39.38-12.16L39.38-1.76Q39.38-1.41 39.48-1.19Q39.59-0.98 39.77-0.86Q39.95-0.74 40.18-0.71Q40.42-0.67 40.69-0.67L40.82-0.67L40.82 0L38.11 0L37.94-1.44L37.88-1.44Q37.7-1.07 37.46-0.78Q37.23-0.48 36.94-0.28Q36.64-0.07 36.27 0.04Q35.89 0.16 35.42 0.16Q34.63 0.16 34.02-0.11Q33.41-0.37 33-0.91Q32.59-1.45 32.38-2.29Q32.16-3.13 32.16-4.27M33.71-4.26Q33.71-2.55 34.17-1.71Q34.63-0.87 35.7-0.87Q36.32-0.87 36.74-1.07Q37.16-1.28 37.41-1.70Q37.66-2.13 37.77-2.77Q37.88-3.41 37.88-4.27Q37.88-5.11 37.77-5.75Q37.66-6.39 37.41-6.82Q37.16-7.26 36.73-7.48Q36.31-7.71 35.68-7.71Q35.16-7.71 34.78-7.48Q34.41-7.26 34.17-6.82Q33.93-6.38 33.82-5.74Q33.71-5.09 33.71-4.26ZM41.59-2.09Q41.59-2.58 41.89-2.88Q42.19-3.17 42.74-3.17Q42.77-2.67 42.89-2.21Q43.02-1.75 43.28-1.40Q43.54-1.05 43.94-0.84Q44.34-0.63 44.9-0.63Q45.98-0.63 46.58-1.14Q47.19-1.66 47.19-2.64Q47.19-3.08 47.06-3.41Q46.94-3.75 46.65-4.04Q46.36-4.32 45.89-4.58Q45.41-4.84 44.71-5.13Q43.97-5.44 43.41-5.79Q42.86-6.13 42.49-6.56Q42.13-6.98 41.95-7.51Q41.77-8.03 41.77-8.69Q41.77-9.38 42.03-9.91Q42.29-10.45 42.76-10.82Q43.23-11.2 43.87-11.39Q44.51-11.59 45.27-11.59Q45.98-11.59 46.54-11.44Q47.09-11.29 47.48-11.04Q47.86-10.79 48.06-10.46Q48.26-10.14 48.26-9.79Q48.26-9.27 47.92-9.01Q47.58-8.75 47-8.75Q47-9.13 46.91-9.49Q46.82-9.85 46.61-10.14Q46.4-10.42 46.05-10.60Q45.71-10.78 45.2-10.78Q44.74-10.78 44.38-10.65Q44.02-10.52 43.77-10.29Q43.52-10.05 43.38-9.71Q43.25-9.38 43.25-8.96Q43.25-8.48 43.38-8.12Q43.5-7.76 43.79-7.46Q44.09-7.17 44.56-6.91Q45.04-6.65 45.73-6.37Q46.44-6.08 46.99-5.76Q47.54-5.44 47.92-5.04Q48.3-4.65 48.51-4.16Q48.71-3.67 48.71-3.05Q48.71-2.3 48.43-1.70Q48.16-1.1 47.64-0.69Q47.13-0.27 46.4-0.06Q45.67 0.16 44.77 0.16Q43.99 0.16 43.39-0.01Q42.8-0.17 42.39-0.46Q41.99-0.76 41.79-1.18Q41.59-1.59 41.59-2.09ZM49.59-4.23Q49.59-6.47 50.52-7.60Q51.44-8.73 53.14-8.73Q53.91-8.73 54.53-8.49Q55.15-8.25 55.58-7.77Q56.01-7.29 56.24-6.57Q56.47-5.86 56.47-4.91L56.47-4.18L51.14-4.18Q51.16-3.3 51.32-2.68Q51.48-2.05 51.78-1.64Q52.08-1.23 52.52-1.04Q52.95-0.85 53.52-0.85Q53.94-0.85 54.29-0.95Q54.65-1.04 54.94-1.20Q55.23-1.35 55.45-1.55Q55.67-1.75 55.81-1.97Q55.92-1.92 56.02-1.77Q56.12-1.63 56.12-1.42Q56.12-1.18 55.95-0.90Q55.77-0.63 55.42-0.39Q55.07-0.16 54.54 0Q54.02 0.16 53.3 0.16Q52.44 0.16 51.75-0.14Q51.05-0.43 50.58-0.99Q50.1-1.55 49.85-2.37Q49.59-3.19 49.59-4.23M51.17-5.04L54.85-5.04Q54.85-5.67 54.76-6.20Q54.66-6.72 54.46-7.09Q54.26-7.47 53.93-7.67Q53.59-7.88 53.11-7.88Q52.22-7.88 51.74-7.15Q51.26-6.43 51.17-5.04ZM57 0L57-0.67L57.05-0.67Q57.32-0.67 57.56-0.71Q57.8-0.75 57.97-0.87Q58.15-0.99 58.25-1.22Q58.36-1.45 58.36-1.82L58.36-6.81Q58.36-7.16 58.25-7.38Q58.15-7.59 57.97-7.71Q57.79-7.83 57.55-7.87Q57.31-7.91 57.05-7.91L57-7.91L57-8.58L59.46-8.58L59.77-6.99L59.84-6.99Q60-7.35 60.16-7.67Q60.33-7.98 60.57-8.22Q60.8-8.46 61.16-8.60Q61.51-8.73 62.04-8.73Q62.91-8.73 63.34-8.43Q63.77-8.13 63.77-7.57Q63.77-7.32 63.68-7.11Q63.6-6.9 63.42-6.75Q63.24-6.59 62.96-6.51Q62.68-6.43 62.27-6.43Q62.27-7.09 62.09-7.39Q61.9-7.68 61.43-7.68Q61.13-7.68 60.9-7.51Q60.66-7.34 60.49-7.07Q60.31-6.79 60.19-6.43Q60.07-6.07 60-5.69Q59.92-5.31 59.89-4.94Q59.86-4.56 59.86-4.26L59.86-1.74Q59.86-1.39 59.96-1.18Q60.07-0.96 60.25-0.85Q60.43-0.74 60.67-0.71Q60.91-0.67 61.17-0.67L61.62-0.67L61.62 0L57 0ZM64.13 0L64.13-0.67L64.34-0.67Q64.61-0.67 64.85-0.71Q65.09-0.74 65.27-0.85Q65.45-0.96 65.55-1.18Q65.66-1.39 65.66-1.74L65.66-6.81Q65.66-7.16 65.55-7.38Q65.45-7.59 65.27-7.71Q65.09-7.83 64.85-7.87Q64.61-7.91 64.34-7.91L64.3-7.91L64.3-8.58L67.16-8.58L67.16-1.82Q67.16-1.45 67.26-1.22Q67.37-0.99 67.54-0.87Q67.72-0.75 67.96-0.71Q68.2-0.67 68.47-0.67L68.68-0.67L68.68 0L64.13 0M65.43-11.17Q65.43-11.45 65.5-11.64Q65.57-11.83 65.7-11.95Q65.82-12.06 65.98-12.11Q66.15-12.16 66.34-12.16Q66.53-12.16 66.7-12.11Q66.86-12.06 66.98-11.95Q67.1-11.83 67.18-11.64Q67.25-11.45 67.25-11.17Q67.25-10.89 67.18-10.70Q67.1-10.52 66.98-10.40Q66.86-10.28 66.7-10.23Q66.53-10.18 66.34-10.18Q66.15-10.18 65.98-10.23Q65.82-10.28 65.7-10.40Q65.57-10.52 65.5-10.70Q65.43-10.89 65.43-11.17ZM69.11 0L69.11-0.67L69.32-0.67Q69.59-0.67 69.83-0.71Q70.07-0.75 70.25-0.87Q70.42-0.99 70.53-1.22Q70.63-1.45 70.63-1.82L70.63-7.82L69.17-7.82L69.17-8.58L70.63-8.58L70.63-9.38Q70.63-10.09 70.83-10.64Q71.02-11.19 71.39-11.56Q71.76-11.94 72.28-12.13Q72.8-12.32 73.46-12.32Q74.09-12.32 74.52-12.24Q74.95-12.16 75.21-12.01Q75.47-11.86 75.59-11.66Q75.7-11.45 75.7-11.20Q75.7-10.98 75.61-10.82Q75.51-10.65 75.33-10.54Q75.16-10.42 74.92-10.36Q74.68-10.3 74.39-10.30Q74.39-10.55 74.34-10.78Q74.29-11.01 74.17-11.19Q74.05-11.37 73.84-11.48Q73.64-11.59 73.34-11.59Q72.99-11.59 72.76-11.45Q72.53-11.32 72.39-11.06Q72.25-10.8 72.19-10.41Q72.13-10.03 72.13-9.52L72.13-8.58L74.39-8.58L74.39-7.82L72.13-7.82L72.13-1.82Q72.13-1.45 72.24-1.22Q72.34-0.99 72.52-0.87Q72.7-0.75 72.94-0.71Q73.18-0.67 73.45-0.67L74.05-0.67L74.05 0L69.11 0Z'/>",variants:[{style:"normal",src:"DroidSerif",weight:400},{style:"normal",src:"DroidSerif-Bold",weight:700},{style:"italic",src:"DroidSerif-Italic",weight:400},{style:"italic",src:"DroidSerif-BoldItalic",weight:700}]},firaSans:{id:"firaSans",name:"Fira Sans",preview:"<path d='M7.36-9.81L7.54-11.02L1.68-11.02L1.68 0L3.2 0L3.2-4.85L6.8-4.85L6.8-6.05L3.2-6.05L3.2-9.81ZM11.2-11.36C11.2-11.92 10.77-12.35 10.16-12.35C9.55-12.35 9.14-11.92 9.14-11.36C9.14-10.78 9.55-10.35 10.16-10.35C10.77-10.35 11.2-10.78 11.2-11.36ZM10.9 0L10.9-8.43L9.42-8.43L9.42 0ZM15.44 0L15.44-4.94C15.73-6.11 16.4-7.18 17.46-7.18C17.76-7.18 17.94-7.15 18.19-7.09L18.46-8.53C18.21-8.59 17.9-8.62 17.63-8.62C16.64-8.62 15.9-8 15.42-6.82L15.25-8.43L13.97-8.43L13.97 0ZM25.63-5.87C25.63-7.58 24.7-8.62 22.56-8.62C21.73-8.62 20.78-8.46 19.74-8.08L20.13-6.99C20.99-7.3 21.78-7.42 22.34-7.42C23.57-7.42 24.16-6.98 24.16-5.79L24.16-5.14L23.07-5.14C20.51-5.14 19.1-4.16 19.1-2.42C19.1-0.85 20.14 0.19 21.84 0.19C22.86 0.19 23.76-0.19 24.35-0.99C24.61-0.24 25.15 0.1 25.9 0.19L26.26-0.83C25.82-0.99 25.63-1.23 25.63-1.9ZM22.24-0.91C21.18-0.91 20.72-1.44 20.72-2.48C20.72-3.5 21.34-4.16 23.15-4.16L24.16-4.16L24.16-2.08C23.68-1.34 23.04-0.91 22.24-0.91ZM39.47-3.07C39.47-5.18 37.97-5.87 36.21-6.42C34.22-7.02 33.79-7.47 33.79-8.4C33.79-9.46 34.67-9.97 35.78-9.97C36.7-9.97 37.49-9.68 38.26-8.98L39.12-9.94C38.22-10.77 37.25-11.22 35.71-11.22C33.65-11.22 32.24-10.03 32.24-8.34C32.24-6.62 33.36-5.81 35.5-5.15C37.36-4.58 37.89-4.06 37.89-3.02C37.89-1.7 36.82-1.06 35.52-1.06C34.32-1.06 33.42-1.49 32.67-2.21L31.79-1.23C32.7-0.34 33.95 0.19 35.57 0.19C38.02 0.19 39.47-1.15 39.47-3.07ZM47.33-5.87C47.33-7.58 46.4-8.62 44.26-8.62C43.42-8.62 42.48-8.46 41.44-8.08L41.82-6.99C42.69-7.3 43.47-7.42 44.03-7.42C45.26-7.42 45.86-6.98 45.86-5.79L45.86-5.14L44.77-5.14C42.21-5.14 40.8-4.16 40.8-2.42C40.8-0.85 41.84 0.19 43.54 0.19C44.56 0.19 45.46-0.19 46.05-0.99C46.3-0.24 46.85 0.1 47.6 0.19L47.95-0.83C47.52-0.99 47.33-1.23 47.33-1.9ZM43.94-0.91C42.88-0.91 42.42-1.44 42.42-2.48C42.42-3.5 43.04-4.16 44.85-4.16L45.86-4.16L45.86-2.08C45.38-1.34 44.74-0.91 43.94-0.91ZM51.86-6.11C52.3-6.77 53.04-7.47 53.95-7.47C54.91-7.47 55.26-7.04 55.26-6.03L55.26 0L56.74 0L56.74-6.13C56.74-7.7 56.08-8.62 54.45-8.62C53.46-8.62 52.45-8.14 51.76-7.28L51.65-8.43L50.38-8.43L50.38 0L51.86 0ZM61.81-0.99C60.91-0.99 60.13-1.3 59.47-1.84L58.66-0.91C59.39-0.27 60.42 0.19 61.84 0.19C63.52 0.19 65.17-0.58 65.17-2.38C65.17-4.02 63.98-4.56 62.5-4.98C61.07-5.36 60.54-5.63 60.54-6.35C60.54-7.02 61.2-7.46 62.11-7.46C63.01-7.46 63.63-7.2 64.24-6.78L64.9-7.78C64.21-8.27 63.33-8.62 62.18-8.62C60.4-8.62 59.02-7.68 59.02-6.26C59.02-4.88 60-4.22 61.52-3.84C63.18-3.42 63.58-3.1 63.58-2.27C63.58-1.49 62.88-0.99 61.81-0.99Z'/>",variants:[{style:"normal",src:"FiraSansOT-Regular",weight:400},{style:"normal",src:"FiraSansOT-Bold",weight:700},{style:"italic",src:"FiraSansOT-RegularItalic",weight:400},{style:"italic",src:"FiraSansOT-BoldItalic",weight:700}]},openDyslexic:{id:"openDyslexic",name:"Open Dyslexic",preview:"<path d='M6.58-11.87C9.86-11.87 11.97-9.5 11.97-5.82C11.97-2.14 9.86 0.22 6.58 0.22C3.3 0.22 1.17-2.13 1.17-5.82C1.17-9.5 3.3-11.87 6.58-11.87ZM6.58-10.59C4.29-10.59 2.83-8.77 2.83-5.82C2.83-3.41 4.29-2.77 6.58-2.77C8.86-2.77 10.3-3.41 10.3-5.82C10.3-8.77 8.86-10.59 6.58-10.59ZM16.14 3.33L14.3 3.33L15.01-2.03L15.01-8.62L16.45-8.62L16.21-7.42C16.8-8.46 17.73-8.96 19.01-8.96C21.14-8.96 22.59-7.12 22.59-4.37C22.59-1.62 21.14 0.22 19.01 0.22C17.73 0.22 16.8-0.27 16.21-1.31ZM21.66-4.62C21.66-6.74 20.75-8 19.22-8C17.7-8 16.78-6.74 16.78-4.62C16.78-2.5 17.78-2.14 19.3-2.14C20.82-2.14 21.66-2.5 21.66-4.62ZM32.58-4.74L26.05-4.74C26.08-2.4 27.23-2 29.14-1.9C30.24-1.9 31.28-1.89 32.3-2.43L32.34-0.45C31.3 0 30.21 0.22 29.09 0.22C26.3 0.13 24.54-1.52 24.54-4.29C24.66-7.15 26.21-8.96 28.85-8.96C31.18-8.86 32.38-7.78 32.58-5.28ZM31.33-6C31.17-6.98 30.27-8.21 28.85-8.21C27.25-8.21 26.21-7.04 26.21-5.98ZM42.19 0L40.14 0L40.45-5.31C40.45-6.98 39.95-7.79 38.67-7.79C36.91-7.79 36.08-6.74 36.08-5.02L36.32 0L34.32 0L34.56-8.83L36-8.83L36-7.78C36.69-8.32 37.62-8.96 38.83-8.96C40.83-8.96 41.86-7.7 41.97-5.28ZM44.19 0L44.19-11.66L47.44-11.66C51.97-11.66 54-9.84 54-5.84C54-1.82 51.94 0 47.44 0ZM45.86-10.37L45.86-2.94L47.76-2.94C50.98-2.94 52.14-3.62 52.38-6C52.38-8.91 50.98-10.37 47.76-10.37ZM62.26-8.75L63.78-8.75L60.1 0.82C59.07 3.1 58.34 3.49 57.06 3.49L55.74 3.49L55.74 1.58L56.75 1.58C57.54 1.58 57.86 1.18 58.4 0.51L59.01-0.72L55.26-8.75L56.78-8.75L59.89-3.66ZM71.57-7.3C70.75-7.7 69.87-7.92 68.94-7.92C67.5-7.92 66.72-7.39 66.72-6.53C66.72-5.74 67.18-5.38 68.72-5.04L69.22-4.93C71.25-4.5 72.03-3.84 72.03-2.42C72.03-0.78 70.67 0.22 68.42 0.22C67.49 0.22 66.48 0.05 65.34-0.32L65.34-2.43C66.42-1.87 67.44-1.6 68.45-1.6C69.81-1.6 70.4-2.02 70.4-2.77C70.22-3.09 70.08-3.31 69.95-3.46C69.84-3.6 69.33-3.76 68.43-3.97L67.94-4.08C66.16-4.45 65.41-5.02 65.41-6.38C65.41-8.03 66.62-8.96 68.77-8.96C69.84-8.96 70.78-8.8 71.57-8.5ZM77.5 0L74.37 0C74.43-4.05 74.54-7.39 74.77-11.46L76.13-11.46C75.94-8 75.84-5.25 75.81-1.78L77.5-1.78ZM87.87-4.74L81.34-4.74C81.38-2.4 82.53-2 84.43-1.9C85.54-1.9 86.58-1.89 87.6-2.43L87.63-0.45C86.59 0 85.5 0.22 84.38 0.22C81.6 0.13 79.84-1.52 79.84-4.29C79.95-7.15 81.5-8.96 84.14-8.96C86.48-8.86 87.68-7.78 87.87-5.28ZM86.62-6C86.46-6.98 85.57-8.21 84.14-8.21C82.54-8.21 81.5-7.04 81.5-5.98ZM93.81-5.17L96.45-8.75L97.9-8.75L94.82-4.1L98.22 0L95.9 0L93.9-3.04L91.74 0L89.42 0L92.91-4.19L89.87-8.75L91.41-8.75ZM102.16-10.34L100.72-10.34L100.8-12.16L102.08-12.16ZM100.56 0C100.77-3.07 100.82-6 100.8-8.75L102.08-8.75C101.98-6.13 102.06-3.18 102.4 0ZM111.66-7.15C110.85-7.6 110.03-7.82 109.2-7.82C107.33-7.82 106.34-6.5 106.34-4.37C106.48-2.86 107.26-2.35 109.14-2.26C109.97-2.26 110.82-2.14 111.63-2.59L111.66-0.34C110.86 0.03 110.02 0.22 109.04 0.22C106.42 0.22 104.74-1.55 104.74-4.37C104.74-7.22 106.42-8.96 109.14-8.96C110.02-8.96 110.88-8.78 111.66-8.42Z'/>",variants:[{style:"normal",src:"OpenDyslexic-Regular",weight:400},{style:"normal",src:"OpenDyslexic-Bold",weight:700},{style:"italic",src:"OpenDyslexic-Italic",weight:400},{style:"italic",src:"OpenDyslexic-BoldItalic",weight:700}]},sourceSans:{id:"sourceSans",name:"SourceSans Pro",preview:"<path d='M0.67-1.36C1.58-0.42 2.88 0.19 4.35 0.19C6.56 0.19 7.92-1.14 7.92-2.8C7.92-4.35 6.98-5.07 5.76-5.6L4.27-6.24C3.44-6.59 2.53-6.98 2.53-7.98C2.53-8.93 3.31-9.52 4.48-9.52C5.46-9.52 6.22-9.14 6.86-8.53L7.58-9.39C6.83-10.16 5.73-10.69 4.48-10.69C2.58-10.69 1.18-9.5 1.18-7.9C1.18-6.37 2.32-5.62 3.31-5.2L4.82-4.54C5.81-4.1 6.56-3.76 6.56-2.69C6.56-1.66 5.74-0.98 4.37-0.98C3.28-0.98 2.22-1.5 1.47-2.29ZM9.28-3.87C9.28-1.3 10.98 0.19 12.88 0.19C14.78 0.19 16.48-1.3 16.48-3.87C16.48-6.48 14.78-7.97 12.88-7.97C10.98-7.97 9.28-6.48 9.28-3.87ZM10.64-3.87C10.64-5.66 11.55-6.88 12.88-6.88C14.22-6.88 15.12-5.66 15.12-3.87C15.12-2.1 14.22-0.9 12.88-0.9C11.55-0.9 10.64-2.1 10.64-3.87ZM18.42-2.85C18.42-0.86 19.15 0.19 20.8 0.19C21.87 0.19 22.64-0.37 23.36-1.22L23.41-1.22L23.52 0L24.61 0L24.61-7.78L23.3-7.78L23.3-2.26C22.56-1.34 22-0.94 21.2-0.94C20.18-0.94 19.74-1.57 19.74-3.02L19.74-7.78L18.42-7.78ZM27.23 0L28.54 0L28.54-4.99C29.07-6.3 29.86-6.78 30.51-6.78C30.83-6.78 31.01-6.74 31.26-6.66L31.52-7.81C31.26-7.92 31.02-7.97 30.69-7.97C29.81-7.97 29.01-7.34 28.48-6.37L28.43-6.37L28.32-7.78L27.23-7.78ZM32.05-3.87C32.05-1.3 33.63 0.19 35.7 0.19C36.62 0.19 37.52-0.19 38.22-0.82L37.63-1.68C37.17-1.26 36.54-0.9 35.81-0.9C34.38-0.9 33.41-2.1 33.41-3.87C33.41-5.66 34.43-6.88 35.84-6.88C36.46-6.88 36.94-6.59 37.41-6.19L38.06-7.04C37.54-7.54 36.82-7.97 35.79-7.97C33.79-7.97 32.05-6.48 32.05-3.87ZM39.01-3.87C39.01-1.33 40.66 0.19 42.74 0.19C43.79 0.19 44.62-0.18 45.3-0.61L44.83-1.47C44.26-1.1 43.63-0.86 42.9-0.86C41.41-0.86 40.4-1.92 40.3-3.6L45.55-3.6C45.58-3.79 45.6-4.05 45.6-4.32C45.6-6.54 44.48-7.97 42.5-7.97C40.72-7.97 39.01-6.42 39.01-3.87ZM40.29-4.46C40.45-6.03 41.44-6.93 42.53-6.93C43.74-6.93 44.45-6.05 44.45-4.46ZM50.11-1.36C51.02-0.42 52.32 0.19 53.79 0.19C56 0.19 57.36-1.14 57.36-2.8C57.36-4.35 56.42-5.07 55.2-5.6L53.71-6.24C52.88-6.59 51.97-6.98 51.97-7.98C51.97-8.93 52.75-9.52 53.92-9.52C54.9-9.52 55.66-9.14 56.3-8.53L57.02-9.39C56.27-10.16 55.17-10.69 53.92-10.69C52.02-10.69 50.62-9.5 50.62-7.9C50.62-6.37 51.76-5.62 52.75-5.2L54.26-4.54C55.25-4.1 56-3.76 56-2.69C56-1.66 55.18-0.98 53.81-0.98C52.72-0.98 51.66-1.5 50.91-2.29ZM58.91-2.02C58.91-0.62 59.89 0.19 61.2 0.19C62.16 0.19 63.02-0.32 63.78-0.93L63.81-0.93L63.92 0L65.01 0L65.01-4.77C65.01-6.7 64.21-7.97 62.3-7.97C61.06-7.97 59.97-7.42 59.25-6.96L59.78-6.05C60.38-6.46 61.18-6.88 62.1-6.88C63.36-6.88 63.7-5.92 63.7-4.93C60.38-4.56 58.91-3.71 58.91-2.02ZM60.21-2.11C60.21-3.1 61.09-3.74 63.7-4.06L63.7-1.9C62.94-1.23 62.32-0.86 61.57-0.86C60.8-0.86 60.21-1.23 60.21-2.11ZM67.49 0L68.8 0L68.8-5.63C69.58-6.42 70.13-6.83 70.93-6.83C71.95-6.83 72.4-6.21 72.4-4.75L72.4 0L73.71 0L73.71-4.93C73.71-6.91 72.98-7.97 71.34-7.97C70.27-7.97 69.47-7.39 68.74-6.66L68.69-6.66L68.58-7.78L67.49-7.78ZM75.38-0.88C76.11-0.27 77.17 0.19 78.27 0.19C80.11 0.19 81.12-0.86 81.12-2.13C81.12-3.6 79.87-4.06 78.75-4.48C77.87-4.82 77.02-5.09 77.02-5.82C77.02-6.42 77.47-6.94 78.45-6.94C79.14-6.94 79.7-6.66 80.22-6.26L80.85-7.09C80.26-7.57 79.41-7.97 78.43-7.97C76.75-7.97 75.76-7.01 75.76-5.76C75.76-4.45 76.98-3.92 78.08-3.52C78.93-3.2 79.86-2.85 79.86-2.05C79.86-1.38 79.34-0.83 78.32-0.83C77.39-0.83 76.7-1.22 76.03-1.76ZM86.3 0L87.63 0L87.63-4.16L89.52-4.16C91.82-4.16 93.39-5.2 93.39-7.41C93.39-9.71 91.84-10.5 89.52-10.5L86.3-10.5ZM87.63-5.25L87.63-9.42L89.36-9.42C91.17-9.42 92.06-8.93 92.06-7.41C92.06-5.92 91.18-5.25 89.36-5.25ZM95.39 0L96.7 0L96.7-4.99C97.23-6.3 98.02-6.78 98.67-6.78C98.99-6.78 99.17-6.74 99.42-6.66L99.68-7.81C99.42-7.92 99.18-7.97 98.85-7.97C97.97-7.97 97.17-7.34 96.64-6.37L96.59-6.37L96.48-7.78L95.39-7.78ZM100.21-3.87C100.21-1.3 101.9 0.19 103.81 0.19C105.71 0.19 107.41-1.3 107.41-3.87C107.41-6.48 105.71-7.97 103.81-7.97C101.9-7.97 100.21-6.48 100.21-3.87ZM101.57-3.87C101.57-5.66 102.48-6.88 103.81-6.88C105.15-6.88 106.05-5.66 106.05-3.87C106.05-2.1 105.15-0.9 103.81-0.9C102.48-0.9 101.57-2.1 101.57-3.87Z'/>",variants:[{style:"normal",src:"SourceSansPro-Regular",weight:400},{style:"normal",src:"SourceSansPro-Bold",weight:700},{style:"italic",src:"SourceSansPro-It",weight:400},{style:"italic",src:"SourceSansPro-BoldIt",weight:700}]},vollkorn:{id:"vollkorn",name:"Vollkorn",preview:"<path d='M8.94-10.82C8.45-10.82 8.05-10.83 7.58-10.86C7.58-10.69 7.6-10.42 7.66-10.18C8.67-10.06 8.77-9.41 8.37-8.22C7.68-6.18 6.98-4.24 6.18-2.27C5.31-4.45 4.46-6.45 3.6-8.43C2.98-9.87 3.17-10.11 4.19-10.18C4.24-10.4 4.27-10.67 4.27-10.86C3.66-10.83 3.01-10.82 2.34-10.82C1.66-10.82 0.82-10.83 0.4-10.86C0.4-10.69 0.42-10.43 0.48-10.18C1.07-10.11 1.18-9.9 1.89-8.34C2.9-6.11 4.19-3.01 5.44 0.1C5.7 0.1 5.86 0.08 6.06 0.03C7.14-2.75 8.16-5.54 9.15-8.29C9.54-9.34 9.84-10.02 10.5-10.18C10.56-10.42 10.58-10.62 10.58-10.86C10.11-10.83 9.44-10.82 8.94-10.82ZM13.71-7.47C11.58-7.47 10.1-5.84 10.1-3.66C10.1-1.36 11.52 0.14 13.71 0.14C15.87 0.14 17.33-1.47 17.33-3.66C17.33-5.94 15.98-7.47 13.71-7.47ZM13.55-6.7C14.74-6.7 15.73-5.46 15.73-3.47C15.73-1.79 15.12-0.62 13.84-0.62C12.54-0.62 11.71-1.84 11.71-4C11.71-5.6 12.32-6.7 13.55-6.7ZM19.57-2.03C19.57-0.96 19.31-0.64 18.46-0.64C18.4-0.43 18.38-0.16 18.38 0.05C18.91 0.02 19.62 0 20.22 0C20.83 0 21.47 0.02 22.03 0.05C22.03-0.1 22.02-0.42 21.95-0.64C21.26-0.64 21.01-0.96 21.01-2.03L21.01-10.83C21.01-11.23 20.85-11.41 20.66-11.47C20.27-11.2 18.99-10.93 18.51-10.93C18.4-10.75 18.37-10.58 18.37-10.34C19.46-10.34 19.57-9.95 19.57-9.2ZM24.35-2.03C24.35-0.96 24.1-0.64 23.25-0.64C23.18-0.43 23.17-0.16 23.17 0.05C23.7 0.02 24.4 0 25.01 0C25.62 0 26.26 0.02 26.82 0.05C26.82-0.1 26.8-0.42 26.74-0.64C26.05-0.64 25.79-0.96 25.79-2.03L25.79-10.83C25.79-11.23 25.63-11.41 25.44-11.47C25.06-11.2 23.78-10.93 23.3-10.93C23.18-10.75 23.15-10.58 23.15-10.34C24.24-10.34 24.35-9.95 24.35-9.2ZM34.11-1.7C33.14-2.93 32.48-3.73 31.82-4.45L33.22-5.71C34.02-6.45 34.54-6.67 35.17-6.69C35.25-6.88 35.28-7.15 35.28-7.36C34.7-7.33 34.13-7.33 33.78-7.33C33.34-7.33 32.8-7.33 32.11-7.36C32.11-7.12 32.14-6.91 32.21-6.7C32.5-6.7 32.67-6.62 32.67-6.45C32.67-6.22 32.37-5.82 31.65-5.17L30.58-4.19L30.58-10.83C30.58-11.23 30.42-11.41 30.22-11.47C29.84-11.2 28.56-10.93 28.08-10.93C27.97-10.75 27.94-10.58 27.94-10.34C29.02-10.34 29.14-9.95 29.14-9.2L29.14-2.03C29.14-0.96 28.88-0.64 28.03-0.64C27.97-0.43 27.95-0.16 27.95 0.05C28.48 0.02 29.18 0 29.79 0C30.4 0 31.04 0.02 31.6 0.05C31.6-0.1 31.58-0.42 31.52-0.64C30.83-0.64 30.58-0.96 30.58-2.03L30.58-3.73C31.65-2.59 33.14-0.67 33.65 0.14C34.35 0.03 34.93 0 35.7 0C35.76-0.18 35.78-0.38 35.78-0.69C35.04-0.72 34.85-0.78 34.11-1.7ZM40.11-7.47C37.98-7.47 36.5-5.84 36.5-3.66C36.5-1.36 37.92 0.14 40.11 0.14C42.27 0.14 43.73-1.47 43.73-3.66C43.73-5.94 42.38-7.47 40.11-7.47ZM39.95-6.7C41.14-6.7 42.13-5.46 42.13-3.47C42.13-1.79 41.52-0.62 40.24-0.62C38.94-0.62 38.11-1.84 38.11-4C38.11-5.6 38.72-6.7 39.95-6.7ZM49.65-7.33C48.82-7.33 48.18-6.77 47.71-6.03C47.58-5.84 47.5-5.57 47.38-5.2C47.47-5.68 47.58-6.16 47.58-6.77C47.58-7.23 47.42-7.41 47.23-7.47C46.74-7.22 45.74-6.98 45.09-6.93C44.98-6.75 44.94-6.58 44.94-6.34C46-6.3 46.14-5.95 46.14-5.2L46.14-2.03C46.14-0.96 45.89-0.69 45.04-0.64C44.98-0.46 44.96-0.24 44.96 0.05C45.38 0.02 46.32 0 47.07 0C47.82 0 48.59 0.02 49.09 0.05C49.09-0.24 49.07-0.46 49.01-0.64C48-0.69 47.58-0.96 47.58-2.35L47.58-3.89C47.58-5.14 48.38-6.16 48.94-6.16C49.36-6.16 49.68-5.94 49.73-4.91C50.08-4.91 50.45-4.99 50.64-5.06C50.64-5.62 50.67-6.42 50.75-6.94C50.42-7.2 50.08-7.33 49.65-7.33ZM59.97-0.64C59.33-0.64 59.02-0.93 59.02-2.03L59.02-4.78C59.02-6.74 57.95-7.39 56.74-7.39C55.6-7.39 54.77-6.74 54.42-6.24C54.29-6.06 54.24-5.94 54.18-5.82C54.27-6.19 54.29-6.51 54.29-6.77C54.29-7.23 54.13-7.41 53.94-7.47C53.44-7.22 52.45-6.98 51.79-6.93C51.68-6.75 51.65-6.58 51.65-6.34C52.7-6.3 52.85-5.95 52.85-5.2L52.85-2.03C52.85-0.96 52.58-0.64 51.74-0.64C51.68-0.46 51.66-0.24 51.66 0.05C52.13 0.02 52.91 0 53.57 0C54.22 0 55.02 0.03 55.47 0.05C55.47-0.24 55.46-0.45 55.39-0.64C54.56-0.64 54.29-0.96 54.29-2.03L54.29-3.74C54.29-5.7 55.26-6.42 56.1-6.42C56.96-6.42 57.58-5.97 57.58-4.46L57.58-2.03C57.58-0.96 57.25-0.64 56.48-0.64C56.42-0.46 56.4-0.24 56.4 0.05C56.9 0.03 57.65 0 58.3 0C58.96 0 59.58 0.02 60.05 0.05C60.05-0.24 60.03-0.45 59.97-0.64Z'/>",variants:[{style:"normal",src:"Vollkorn-Regular",weight:400},{style:"normal",src:"Vollkorn-Bold",weight:700},{style:"italic",src:"Vollkorn-Italic",weight:400},{style:"italic",src:"Vollkorn-BoldItalic",weight:700}]}},DEFAULTS:{fontSize:"fs_8",fontFamily:"default",textAlign:"default",lineHeight:"default",backgroundMode:"bgwhite",readingMode:"paged"},FONT_MAX_FILESIZE:2e6},LANGUAGES:[{id:"de_DE",label:"Deutsch (Deutschland)",translation:"LOCALE_GERMAN_DE"},{id:"en_US",label:"English (United States of America)",translation:"LOCALE_ENGLISH_US"},{id:"es_ES",label:"Español (España)",translation:"LOCALE_SPANISH_ES"},{id:"fr_FR",label:"Français (France)",translation:"LOCALE_FRENCH_FR"},{id:"it_IT",label:"Italiano (Italia)",translation:"LOCALE_ITALIAN_IT"},{id:"nl_BE",label:"Nederlands (België)",translation:"LOCALE_DUTCH_BE"},{id:"nl_NL",label:"Nederlands (Nederland)",translation:"LOCALE_DUTCH_NL"}],LANGUAGES_BOSH_MAP:{US:"EN",BE:"NL"},MEDIA:{COVERQUALITY:.8,FALLBACK_COVER_HEIGHT:229.7,FALLBACK_COVER_WIDTH:150.2,FALLBACK_AUDIO_COVER_HEIGHT:300,FALLBACK_AUDIO_COVER_WIDTH:300,GRID_COVER_HEIGHT:240,GRID_COVER_WIDTH:200,IMAGE_DEFAULT_AUDIO:"assets/common/fallback-cover-audio.svg",IMAGE_DEFAULT_PUB:"assets/common/fallback-cover-read.svg",IMAGE_DEFAULT_VIDEO:"assets/common/poster-image-video.svg",IMAGE_DEFAULT_VIDEO_UNSUPPORTED:"assets/common/poster-image-video-unsupported.svg",IMAGE_NULL:"data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw%3D%3D",IMAGE_PLACEHOLDER:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAKoAAACCCAYAAADWiVPZAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAE5lJREFUeNrsndlvHEXXxqt7xuPxvsZ2Qvb3AwmQ4BPcwAX/OlwCEkgvSHCDQhLHSex4txNvs731O9Wnp2YyY4+XrH0euTVbd/UsTz9nqXPKSavVcgbD+47UvgKDEdVgMKIajKgGgxHVYDCiGoyoBsO7Qzl+kCSJfSOG9wZxjt8U1WCm32B4I6a/B5KuWyO24SrRVCvfdXsuoibRBkFL2W1ihDVcAUFb2W0jetyXrIMoKgQdyrZy9rgUqazBcK4YKSMnW91vtWxrXEZR04ygFR+Bbdl3bLhqJEkyGxG4dVFFVTUdta/U8IYw2qWy547602yDzFX7Pg1vCNWMY+lpfDwrKFIftWLfp+ENoTJIzHOW6ddo/7X9trbMZTWcH7Ozs704WDpLNMsDjN03HdXjpAZDX/QRt9QNkEGyfKjhg4AR1WBENRiuCuXLHGyt1gZTVIPBiGowohoMRlSDEdVgMKIaDJeDpacMHz9RP2xb0p5eTlqvX4Bpmg58ga6trbmNjQ13cnLiyuWym5qacjdu3HBDQ0Oyr7ahNxoNud899nkv+CIKRNmu1R4c9kSCDAcHB+7w8NA1m00h4OjoqKtWqx3rH0DSZ8+e5eSu1+tCWo65c+dO/tz6+oYf60COnZiYcDMzM65UKplVMqJeHJAMAr548cLVajUhE6QaHq5Ixdj8/LxXy4q8trGx7l9vurGxcXft2jW3u7vrdnZ2ZJubm/OkHHcrK08y8oZOi62tTffy5b67efOWXADnIWtRiW1E7QKKB8lUJTHfkAmzjiI+e3bo9vZ2hWQQ+uTkSFRzYWFBSDw5OemOj49FjRnn+PhIiFkqpZ60ozL+/v5Lt7m57kZGRt3i4mJOwEFWqmEfM/2G3OQ3Gk1PpKon5E2vlmPy3Pr6mifZvlfDl+7Ro4fiBrB/pVKW+wBio6Tsj7ru7+/K84xx7949UdXl5cdue3vbE35P1Bm1NkW1qL+3Mp1Zq9sSJR0fHxfyVSoVMeMvXgSX4OjoSEx/mpZE5WIxRFk3NzdlH1rWIeL169f9OMPyOuOgtqg0AdZ5iFpUshY2j5o2Q7TP1kraG6SrViuOwByzjbmHtK0WhCp7wn3ibt++64k77OBLyx+E+kI4JRHEI2DCd0VBp6dnPOEn2+pQHspNuJIukD3eOGtTtrbzXNzAq7BEPe0nJ7pHQWu1E/EvIRwazC3EImK/deu2EC4QrdNv1MgeskH4iYnJLv8zyR53pq5evXqZuRb77sSfO03S/N0KqbOLyUx/oYjaytmKG9AKd8RUV6sjQsbV1VUx0ZBubu6aBE9KmunpaTH9T548keebzUZOUlCtDkuQxcORkeGOgAlScr9cTuV829ubckEcHBy6pldn5KPij7+xdMNNTU5l5y32wjSFJqr6qWJquyLrxcUlUTjI8/z5c4nQR0fHcsKxETShgNvbWx2mn+Mx//i4aZpIKismsd7HLVhZWZGgCn9VJgNQUf9X26u5p/WnbuT/quLbNlHsxIhauGCKmSkhqP8IJPWJ5Gu1uidP3ROsJFH8pFezk5OakOjJk2V39+49NzxczT87ikmQBKFJScWAqCMjI6KG3cGSfm0h5XUo7wMFn5qalAsCFQ8zXUcSkFUq1Q5nxdJTBYJq6IuNdbfmFROSBhIE8w4JdeYIIpFuevx42fumt4SAShjuLywsutrJUe5zhmNSITXEV39URDG7L05Gk7TVhFtaWpSLQqdWeS8QlYzCaVO5RtQiRJGeSK8OXolZb9YbEjxVKkNuyJtrl5ENNcQPrddrYtpJ9D94cCL5UPKi6gLMzs54FdwW9WWcQEjnhr1v2mpU8mBLSYpKMvbi4oIn6XU5JvihAXvencDnHfNBHRdCR+RvRC2aojZc/eTYk7Qm+rawMC/J95AXTTPFa8o8vc40YaZJ4j948MDdvn1bAiox7Z7ck1MzgeBQMQke8JA32d0FLwcHpLyO3M2bt8VtiN0IsOX9Xc6ReDWfX1iQlFij1cgCPj9qK3EtI2qBfFSXyty9To+ickpSyKf5zKC0FYn8AWTFh1xfXxe1ZX6fb4F98iAtC5oqQ0OulKQd3xf+LNOtBGJ6MWhwBUGfrjwV039tYU78VvF3k1KWngoXQHBPjKjFiPr9D1+tjooqQjqWmyFCv379ppBXCdSdkMcUs6GyROuQdhISl9KO5CyUgrxpZPa5IMjRxm6DThBA0uXlZSF/2T/mwnm8/Ni7IkNudGzUTY5PutSfo2lTqMVLUKGeS0tLOekoxTs+ronfyNRpTFQllarl8PCwuAoce+LJNZwO9w3Y9HguAK1RVdXG5DPv//jx46xeNZX39nJv3710++JOpH6D3NQdjIyMeY/VFLUwIIeZpk1RPfxN1AyyspE7xewyZ496qv8Yq6DWrELYbhKf5hLpaxwPMVFk1BzXgiwBkwPMeEFWgjjytPq+Hj165O7f/4/4rUbUApl+3SAIBKDgZGsrRO+kh3RWitI9FA01VIIqKTHFSQ8S9jqX3ufQmj/HoTfvEP3+/fuitl2XkmgyM2LMXD19+tT7t6+yOtd5I2pRgqlAOCcBVPgsYU7+1asDMefBpzzy5D2Q4mgmAEbHJ6T0b8TfR4mZceomJX4uSnh0dCiqXfbkZkpWFLQZWlEoNWHOfnxi3Lu2IVDSNpXcw80CJtSTCwU/msxDTHojahHSU0lJSEXQQg6UYIZKKS27Qz2Hh8dF8bgfCBb+m1Gd6VKviKhplZkqKXUK7gCq9/z5M7kVF0F6qKbdde/3lodCNX8iqauKHBNH/bEABP+1JIRF3SEpF4f6zkbUwhDVSc0oLSeBoHVRzTCVOSX3IWiY/mz/XzjVsiaVVM3MBUiywhZPMMbDPHMcr9VrdVFDVPre3XuuVC61fdpWLwuVZMUsLZnWXV9/IeNB6E8++URckHq9YUQtCjY3N8Tvq9UaQkiS78wwoVpJlPvUPichUZrkpG3XjLpMTUt5PjYUowRftpRF7QRDuBAoa8O1/dru9pOQaz2Uaqrd3eAv8/6I+EPu1dJThfJRUSpmncbGRt2tW3e8SdXcZjMjZ49kU6uzxbqZB1WhEipUTJW8Qrf9zVCZlUjif3d71837QGgoy9Ni9Gukt7JKf1SXKP/g4JUovNa1an1BKA+0Cv9CIZTVOSECJI0JOUg9HaY/rsiH4BB1dnYuTz3FEb8EZ7UTOW8zKwaQfzmTVVlVswAtuBwV8Z85jgmA0CR4nAVuxaz1K7CPGn5wTDI9UPQxhY7ToXONA4FQZoIuVBLzTEEJvmq4GNJMcZvi+4ailfZsF0SFgJybWSuOZ8ydnS3vnmyJulKzitJi/plN04vAiFoA4I+uroZAamVlWYhGPpUKKjYIi6/Z6UO2E/8oHfP+ujKKprvAtWuLXqUnskzCoTzP+EwgaB9/PEXL/dicQ+bFxet+3BlP+NXgr+7tOrfCohb3C6mqhfVRqeDHxGq3KOkfNjXlEC+Y31iB06wyv5mrJ1kCbZvWmlNANwCbqp+OGT/u18evvijj4p/S1rK2uibrATDdSrOgEbVApp+5eopSUD3MLRtKqcGNaGgWvfM8s0X1eljeBzPM8XE3qfqi3OIOhDRTu/GP5xTc5zzashKrd5iidRJQqd+LOh/vHvuL6th81CJBo2dmfiYmpryZzaZExQw3c5KSswzmd0vaovEjyWeSeFd1JdjRgCgugNbCE71tkzDNK7TIlaLk3Nf1A4aGynJR6PnDPoei8Ky4YkQtlqZGhG1KW0jcwgyBCWTIte5LxX1LfFHapLUQBVWkQwBl5LXu4pTYB9UJAB6zP2MouXmMYmLWmRwgGIOQnb3/ibStzMzMGlGL5KPGkXf8XJItQsGEACTEf+Xx3NysV9JbWS9/8CNplUZpcQNQSIjb7XdCUBRT1RJAStSS4IrXQ/C0KK6EZCHW17yK7knBNOOh4tPTs3IxMA7ENqIWzgXoXqmkla/kB/EgIFX8NOAlSVkUF6KgtLRJo4zkYnWSQE19fBEwDsSWQmpPUIpMKNnDZYCc2j3AawRnTJOuvXjuNjc2ZSxcDtJnnCv4yqaohQ2s1GRveHKsrj4X4kGMMLU6m/uurJ6CkqJ8mGciclpaMNc6BsEZpNQACaKizIHQTTH5EJRxUFuIiVpyyzkrQxV348YtN1Idk0Uw8E9JpeEbF7Ur1YgaBTgQDCVVklJQTdCkETxrUWnyHZMN6UZHR+Q+QQ+kRPEIfqSXKsoGcIwqtCb/SY3pmgJsvKatLmzarwXJ2e8iC6oZUT8yooZ1S/e9WT8WPxD1QgEhh5KYNVOVpJoXJVeqpp7ClL29rTx44ti4k5UxVFUhJfe1iEVJjv+KWitUQbWSK84qGFELGEyFRXlPJFCK6z4hGWqH36qk0sCJ25DsD+TR1hJ80Pi7CeO2pEY1rPIXXuMc1JoyDmv+4wawD/szvpISl4DOVUjbPYtlRC2Yj8qm7SAoGxE/jyEPKqpmF8JAJKJ9onFVuXK5IiRlf3xaVWlN7APNl6pPrH4sr+vyQJxbN1VzLd4u4hy/ETVSVlWo6alpqfanjQRfNZ5VwmekY3V6eso9fPgoU9RSPnMFAbe3tvNuU/V7dbaLsbiPKrO+lJp/CMjzKKm2UWsqS81+iPwbhf6dijsz1bl8n/QxDfsI/vadu24za/0gVYVSYq5ZwIzeJwIqFoigKqpUCkXWeA87u1tu/+WuzB7FgTl+qa7U12jUZKl0AjDGxrK315uq5RdNr/aU9oVlPmqhfNReaHgSjGSFILqGaShOSXNVa7VCcYpOwdJ7dXCwL9OsNO9ps54WoLAoL6QMbVUtCZaoL9CV/pSQGnid9g8n4k7WoqG4K05HqaMYQsh6u8JJO0R1X8w9eVOIiO/67NlT9+TJiifrsStn/fbtFQBD6on7pKNK2Qoo+L+hjrWW+69nEbTo/4+q0Cul9LvbjzTqf6KIkBSzjm9JEcmsf44VUzRqp6hkZ2dTJgh0ihSiMpfPqoDhH1WU85kmTVHFq1q/fn4n6mxELVKk30GEaP39qNO0m7AaxeOzkmeliARiQdzp6UlRVkBGALKSD4Vw+p9VICuPmXqltlQ7Tklxobhts95yvZr4Eltxuog+anKWzr72+eJ6U4hFvlT8p8yPJZpHLbUIm/a96khVZql0P1JQHLu3ty9qSpUW6SxSUHG9qjvjfRhRC+Sjuj7KOahvq9OZWjVFxT+mfnd3R5r/Jjxxl5Zu5HWqSnTSUHS/tltbXOHTT0bUfhF+o9VHR88zxuvkmp+/JlsMVgjsOtKYZ1G/wRT1o/JRDaaoBoMR1WBENRiMqAaDBVMGU1SDwYhqMBhRDeajmo9qMEU1GK5UUd8W/vrrLympo0XkPPj555/dl19+mZfjXcWYMXTFFM7xpo9h4YsYNBry79i7x+SWz/b9999f6XdpRB0AfPkUHr9vY1LhHy8W8abAeYCSjzpWLkJuP/vss459eY4VWN7md2lEvST6qcq7xFUoGURDUZWQH5o6fvTBVK/zoRB//PFHrhJffPFFbup/+eWX/DGLjf3999+yaAQdoNqrpGPymv7wkODTTz/Nn2d/2ku4Zbxe74v3wb56vn7jYcLZl/30Pu+d98ftt99+21fx4s/PcRRq81w8Znen6lmf24KptwC+dCXjd999Jz1J/CgKiKL/FOLPP/90X3/9tezHeqaxyf7nn3/k8Q8//CCv4/MpyXj+4cOH7quvvupJUjXNvA/GhaSnjRe7C9xnbI5jX9pXun3RmJicg+3HH3+Utmslfz8X5KzPbUR9S2A9KLo3w3+0c/JD6Ap5MVCVeD9uUZc4WOHY2KzGhGH/firHhfDbb78JaXSMs8aLEb8XVK9f3xQXAGRjg9TsG1+UvXDW5zYf9S0BQvLDojIxUKb4B2EfftgY8WNVNiUTx8evdx/brXSQKFaqs8a7Ch/17t277vfff++r8oN8biPq23rz5XKuNLG5705Hsd9pKzXzw/ODq/JAtEFXduYY/MqffvpJzq3qe9HxzkPWQb6fj2WF6g/a9Gvkqz8G91GZXvuheOoScBuncPBtcSMUBGfx40FIg+lXU3zZ8QYBwR2f66zv57TPHb9mUf8VIQ5I1Gf7/PPPJcjB9EMOTC3P6Wp6+h5pV4ZI5B7xHSENroG2PXPMr7/+KkTTJR/v3LnTMUbvlUvar2OKOf+///576ni9xozH7nUuzSqoi8N4XBzffPPNqWOe9bl5f6wpoEHZ+4zklP52SIyjhx2d9/v9t/uKTt6TpTtQBfUDTwsWdD9I3st06oWgJvuyuOrxLvv99PvcbzO9yIXRQcAk+X9/s4HA81ZxrXsJ4UeR8Nc17y+731UT6l0T9Lzfj/moBoMR1WBENRiMqAbD4LAKf4MpqsFgRDUYUQ2Gj8ZH7Z5hMBjetaISMTXtqzK8ITTdAEt+pwMMwjredfs+DW8I9YxjzcsQtZUNcmLfp+EN4STjWOuiPmoz22D8UZIkNKJP+I0S8aqzf/hruLiCHvntwG/72f16xLcLBVMwvZYNCo79VsmOs4yB4aI+aT1TUiVszZ3xr2LKAwRRtegxRC1lW2LfueECUHdSY59atp0aVJUHHFRv04ygpqaGq4j0m1EgdWEftRXdxkQ1GK6SsN1cu7CixreWTzW8E5hCGj4IdCiqle0ZTFENBiOqwYhqMBhRDQYjqsGIajAYUQ0GI6rhw8T/BBgAMlAZRpNGowIAAAAASUVORK5CYII="
},MIME_TYPES:{epub:"application/epub+zip",pdf:"application/pdf",jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",gif:"image/gif",svg:"image/svg+xml",otf:"application/x-font-opentype",ttf:"application/x-font-ttf",woff:"application/font-woff",acsm:"application/vnd.adobe.adept+xml",m4a:"audio/mp4",aac:"audio/mp4",mp3:"audio/mpeg",ogg:"audio/ogg",oga:"audio/ogg",wav:"audio/x-wav",mp4:"video/mp4",m4v:"video/mp4",webm:"video/webm",ogv:"video/ogg"},MISC:{COLLECTION_CATEGORY:"collection",SUBSCRIPTION_CATEGORY:"subscription",SYSTEM_CATEGORY:"system",COLLECTION_NAME_MAX_LENGTH:255,SEARCH_TERM_MIN_LENGTH:3,DIALOG_FADEOUT_TIME:3e3,DOUBLE_TAP_MAX_DELAY:250,LONGPRESS_MIN_DURATION:600,PATH_TO_WORKER:"tolinoweb-v",TAP_TRESHOLD:6,SWIPE_TRESHOLD:75},NET:{BOSH_LIVE:"https://bosh.pageplace.de/bosh/rest",BOSH_TEST:"https://bosh.prodref.pageplace.de/bosh/rest",CLIENT_TYPE:"tolinoweb",CONFIG_VERSION:"4.4.0",RESELLER_GROUP:27},ONEAPP_SPALTER:["boekhandelbe","clubbe","ibsit","indiebookit","libraccioit"],READER:{CONTAINER_ID:"tolino_webReader_container",CUSTOMFONT_ID:"tolino_customFonts",ELEMENT_ID:"tolino_webReader",TMP_ELEMENT_ID:"tolino_webReader_tmp",PUBLICATION_FONTS_ID:"tolino_publicationFonts",SPACER_CLASSNAME:"tolino_webReader_vspace",MIN_HEIGHT:240,IMG_HEIGHT_PADDING:32,SLIDER_UPDATE_INTERVAL:50,SYNC_BOOKMARK_DELAY:1e4,TIMEOUT_PAGE_LAYOUT:400,TAP_AREA_PAGING:.2,UI_FADEOUT_TIME:3e3,UI_FADEOUT_TIME_TOUCH:5e3},STORE:{EXTERNAL_LINKS:"tolino_external_links_granted",COLLECTION_DELETE_DIALOG:"tolino_collection_delete_dialog",FINISHED_DONT_ASK_AGAIN:"tolino_finished_dont_ask_again",TAG_FINISHED_READINGS:"collection_finished_readings_name",FONTSETTINGS:"tolino_fontSettings",FONTSETTINGS_DATAATTR:"data-fontSetting",MAX_SIZE_SAVE_ANDROID:10485760,MAX_SIZE_SAVE_IOS:4194304,RECALC_PP_INTERVAL:"tolino_recalc_pp_interval"},THEMES:{themes:[{id:"default",label:"Default",variants:[{id:"default",primary:"Default",secondary:"Default"},{id:"boekhandelbe",primary:"Default",secondary:"Light Orange"},{id:"clubbe",primary:"Default",secondary:"Yellow"},{id:"ibsit",primary:"Default",secondary:"Petrol"},{id:"indiebookit",primary:"Default",secondary:"Orange"},{id:"libraccioit",primary:"Default",secondary:"Green"}]}],resellerMapping:{60:{theme:"default",variant:"boekhandelbe"},61:{theme:"default",variant:"clubbe"},90:{theme:"default",variant:"ibsit"},91:{theme:"default",variant:"libraccioit"},92:{theme:"default",variant:"indiebookit"}},uifonts:[{id:"fira",label:"Fira"},{id:"droidserif",label:"Droid Serif"},{id:"bitter",label:"Bitter"}]},URL_WHITELIST:["vimeo.com","wikipedia.org","youtube.com"]}}),angular.module("templates-common",["../directives/abstract/abstract.tpl.html","../directives/action-menu/action-menu.tpl.html","../directives/activity-indicator/activity-indicator.tpl.html","../directives/annotation-list-item/annotation-list-item.tpl.html","../directives/audio-mini-player/audio-mini-player.tpl.html","../directives/audiobook-grid-item/audiobook-grid-item.tpl.html","../directives/audiobook-list-item/audiobook-list-item.tpl.html","../directives/basic-slider/basic-slider.tpl.html","../directives/collection-add-dialog/collection-add-dialog.tpl.html","../directives/collection-delete-dialog/collection-delete-dialog.tpl.html","../directives/collection-edit-dialog/collection-edit-dialog.tpl.html","../directives/collection-grid-item/collection-grid-item.tpl.html","../directives/collection-list-item/collection-list-item.tpl.html","../directives/collection-remove-deliverable-dialog/collection-remove-deliverable-dialog.tpl.html","../directives/conflict-dialog/conflict-dialog.tpl.html","../directives/context-menu/context-menu.tpl.html","../directives/cover-flow/cover-flow.tpl.html","../directives/cover-info/cover-info.tpl.html","../directives/delete-dialog/delete-dialog.tpl.html","../directives/dialog/dialog.tpl.html","../directives/download-dialog/download-dialog.tpl.html","../directives/dropdown-list/dropdown-list.tpl.html","../directives/empty-list/empty-list.tpl.html","../directives/error-dialog/error-dialog.tpl.html","../directives/finished-dialog/finished-dialog.tpl.html","../directives/font-select-list/font-select-list.tpl.html","../directives/grid-view/grid-view.tpl.html","../directives/item-select-list/item-select-list.tpl.html","../directives/label-button/label-button.tpl.html","../directives/library-bar/actions/add-to-collection.tpl.html","../directives/library-bar/actions/back.tpl.html","../directives/library-bar/actions/cancel.tpl.html","../directives/library-bar/actions/context.tpl.html","../directives/library-bar/actions/delete-collections.tpl.html","../directives/library-bar/actions/delete.tpl.html","../directives/library-bar/actions/display.tpl.html","../directives/library-bar/actions/menu.tpl.html","../directives/library-bar/actions/new-collection.tpl.html","../directives/library-bar/actions/remove-from-collection.tpl.html","../directives/library-bar/actions/search.tpl.html","../directives/library-bar/actions/upload.tpl.html","../directives/library-bar/library-bar.tpl.html","../directives/library-bar/menu/menu.tpl.html","../directives/list-view/list-view.tpl.html","../directives/loader/loader.tpl.html","../directives/menu-button/menu-button.tpl.html","../directives/meta-data-dialog/meta-data-dialog.tpl.html","../directives/mini-menu/mini-menu.tpl.html","../directives/overlay/overlay.tpl.html","../directives/pub-details/pub-details.tpl.html","../directives/publication-grid/publication-grid.tpl.html","../directives/publication-list/publication-list.tpl.html","../directives/recommendations/recommendations.tpl.html","../directives/scroller/scroller.tpl.html","../directives/search-input/search-input.tpl.html","../directives/select-list/select-list.tpl.html","../directives/selection-checkbox/selection-checkbox.tpl.html","../directives/selection-header-bar/selection-header-bar.tpl.html","../directives/sidebar-menu/sidebar-menu.tpl.html","../directives/slider/slider.tpl.html","../directives/tab-bar/tab-bar.tpl.html","../directives/text-note/text-note.tpl.html","../directives/toggle-button/toggle-button.tpl.html","../directives/toggle-switch/toggle-switch.tpl.html","../directives/tree-view/tree-node.tpl.html","../directives/upload-dialog/upload-dialog.tpl.html","../directives/upload-indicator/upload-indicator.tpl.html","../directives/welcome-doodle/welcome-doodle.tpl.html"]),angular.module("../directives/abstract/abstract.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/abstract/abstract.tpl.html",'<div class="abstract-title" translate>COMMON_DESCRIPTION</div>\n<div class="abstract" ng-class="{ \'full\': fullAbstract }" ng-bind-html=abstract></div>\n\n<div ng-if="!fullAbstract" class="toggle-abstract" ng-click="toggleAbstract()">\n  <svg>\n    <use xlink:href="assets/common/icons.svg#icon-arrow-down" />\n  </svg>\n  <span translate>COMMON_MORE</span>\n</div>\n<div ng-if="fullAbstract" class="toggle-abstract" ng-click="toggleAbstract()">\n  <svg>\n    <use xlink:href="assets/common/icons.svg#icon-arrow-up" />\n  </svg>\n  <span translate>COMMON_LESS</span>\n</div>\n')}]),angular.module("../directives/action-menu/action-menu.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/action-menu/action-menu.tpl.html",'<div class="action-menu-trigger"\n     ng-click="showActionMenu($event)"\n     title="{{ \'TOOLTIP_COMPONENT_ACTIONMENU_TRIGGER\' | translate }}"\n     data-test="directive-actionMenu-trigger">\n  <svg class="icon">\n    <use xlink:href="assets/common/icons.svg#icon-ellipsis-vertical" />\n  </svg>\n</div>\n\n<div class="action-menu-modal"\n     ng-if="visible == true"\n     ng-click="hideActionMenu()">\n</div>\n<div class="action-menu-content" \n     ng-if="visible == true"\n     ng-class="{ \'invisible\': positionNeedsToBeCalculated }"\n     ng-transclude></div>')}]),angular.module("../directives/activity-indicator/activity-indicator.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/activity-indicator/activity-indicator.tpl.html",'<div class="tw-activity-indicator hidden">\n  <div class="activity-indicator-container">\n    <svg><use xlink:href="assets/common/icons.svg#icon-sync" /></svg>\n  </div>\n</div>\n')}]),angular.module("../directives/annotation-list-item/annotation-list-item.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/annotation-list-item/annotation-list-item.tpl.html",'<div class="annotation-list-item" ng-click="goToAnnotation()">\n  <div class="annotation-type">\n    <svg class="icon centered">\n      <use ng-attr-xlink:href="{{ \'assets/common/icons.svg#icon-\' + (isDogEar ? \'bookmark-solid\' : \'mark\') }}" xlink:href="" />\n    </svg>\n  </div>\n  \n  <div class="annotation-info">\n    <div class="annotation-time" ng-if="model.modified > 0" ng-bind="model.modified | date:\'dd.MM.yyyy&nbsp;&nbsp;HH:mm\'"></div>\n    <div class="annotation-headline line-clamp">\n      <span ng-class="{comment: !isDogEar}" ng-bind="model.markedBookText || model.displayName"></span>\n    </div>\n    <div ng-if="!isDogEar" ng-click="isNoteMultiLine && toggleExpand($event)">\n      <div class="annotation-note line-clamp" ng-if="model.markerComment">\n        <span ng-bind="model.markerComment"></span>\n        <svg ng-if="isNoteMultiLine" class="expand-note icon" ng-click="toggleExpand($event)">\n          <use ng-attr-xlink:href="{{ \'assets/common/icons.svg#icon-arrow-\' + (isNoteExpanded ? \'up\' : \'down\') }}" xlink:href="" />\n        </svg>\n      </div>\n      <div class="add-note" ng-if="!model.markerComment">\n        <span ng-click="editNote($event)" ng-bind="\'ADD_A_NOTE\' | translate"></span>\n      </div>\n    </div>\n  </div>\n  \n  <div class="annotation-actions">\n    <div ng-click="removeItem($event)"\n         title="{{ \'TOOLTIP_ANNOTATION_LIST_ITEM_REMOVE\' | translate }}"\n         data-test="component-annotation-list-item-remove">\n      <svg class="icon"><use xlink:href="assets/common/icons.svg#icon-delete" /></svg>\n    </div>\n    <div ng-if="model.markerComment" ng-click="editNote($event)"\n         title="{{ \'TEXT_NOTE_EDIT\' | translate }}"\n         data-test="component-annotation-list-item-edit">\n      <svg class="icon"><use xlink:href="assets/common/icons.svg#icon-edit" /></svg>\n    </div>\n  </div>\n</div>\n\n')}]),angular.module("../directives/audio-mini-player/audio-mini-player.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/audio-mini-player/audio-mini-player.tpl.html",'<div ng-show="options.visible">\n  \n  <div class="cover-and-infos" ui-sref="audio({id : playlist.deliverable.id})">\n    <img ng-src="{{ playlist.coverimage }}"></img>\n    <div class="infos">\n      <span>{{ playlist.deliverable.title }}</span>\n      <span>{{ playlist.publication.author }}</span>\n    </div>\n  </div>\n\n  <div class="controls" ng-class="{ \'disabled\': playlist.readyToPlay == false }">\n\n    <span class="icon-container control" title="" ng-click="seek(false)" ng-class="{ \'disabled\': audio.cantSeek == true }">\n      <svg class="icon">\n        <use xlink:href="assets/common/icons.svg#icon-30sec-prev" />\n      </svg>\n    </span>\n\n    <span class="icon-container control" title="" ng-click="skip(false)">\n      <svg class="icon">\n        <use xlink:href="assets/common/icons.svg#icon-prev" />\n      </svg>\n    </span>\n\n    <tw-toggle-button name="pause-play" primary-icon="pause" primary-tooltip=""\n      secondary-icon="play" secondary-tooltip="" active-state="{{ audio.playing == true ? \'secondary\' : \'primary\' }}">\n    </tw-toggle-button>\n\n    <span class="icon-container control" title="" ng-click="skip(true)">\n      <svg class="icon">\n        <use xlink:href="assets/common/icons.svg#icon-next" />\n      </svg>\n    </span>\n\n    <span class="icon-container control" title="" ng-click="seek(true)" ng-class="{ \'disabled\': audio.cantSeek == true }">\n      <svg class="icon">\n        <use xlink:href="assets/common/icons.svg#icon-30sec-forward" />\n      </svg>\n    </span>\n\n  </div>\n\n\n</div>')}]),angular.module("../directives/audiobook-grid-item/audiobook-grid-item.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/audiobook-grid-item/audiobook-grid-item.tpl.html",'<div class="audiobook-grid-item-image"\n     ng-click="onClick($event)"\n     ng-style="coverStyles">\n  \n  <div ng-if="libSelection.isSelectionMode" \n       class="audiobook-selection" \n       ng-class="{ \'selected\': libSelection.isSelected(deliverable.id), \'disabled\': libSelection.isDisabled(deliverable.id) }" \n       role="option">\n    <div class="audiobook-selection-overlay"></div>\n    <div class="audiobook-selection-marker">\n      <svg class="icon centered">\n        <use xlink:href="assets/common/icons.svg#icon-checkmark" />\n      </svg>\n    </div>\n  </div>\n  \n  <div ng-show="isCurrent" class="audiobook-cover-badge-current">\n    <svg class="icon">\n      <use xlink:href="assets/common/icons.svg#icon-recently_read"/>\n    </svg>\n  </div>\n  \n  <div ng-show="isNew" class="audiobook-cover-badge-new">\n    <div class="audiobook-cover-badge-new-text" ng-bind="\'COMMON_NEW\' | translate"></div>\n    <svg class="icon">\n      <filter xmlns="http://www.w3.org/2000/svg" id="dropshadow-1" height="130%">\n        <feGaussianBlur in="SourceAlpha" stdDeviation="3" /> \n        <feOffset dx="0" dy="0" result="offsetblur" />\n        <feComponentTransfer>\n          <feFuncA type="linear" slope="0.35" />\n        </feComponentTransfer>\n        <feMerge> \n          <feMergeNode/>\n          <feMergeNode in="SourceGraphic" /> \n        </feMerge>\n      </filter>\n      <use xlink:href="assets/common/icons.svg#icon-banderole-fill"\n           style="filter:url(#dropshadow-1)" />\n    </svg>\n  </div>\n  \n  <div ng-show="deliverable.isSample" class="audiobook-cover-badge-sample">\n    <div class="audiobook-cover-badge-sample-text" ng-bind="\'COMMON_SAMPLE\' | translate"></div>\n    <svg class="icon">\n      <filter xmlns="http://www.w3.org/2000/svg" id="dropshadow-2" height="130%">\n        <feGaussianBlur in="SourceAlpha" stdDeviation="3" /> \n        <feOffset dx="0" dy="0" result="offsetblur" />\n        <feComponentTransfer>\n          <feFuncA type="linear" slope="0.35" />\n        </feComponentTransfer>\n        <feMerge> \n          <feMergeNode/>\n          <feMergeNode in="SourceGraphic" /> \n        </feMerge>\n      </filter>\n      <use xlink:href="assets/common/icons.svg#icon-banderole-fill"\n           style="filter:url(#dropshadow-2)" />\n    </svg>\n  </div>\n  \n  <div ng-show="!deliverable.isOffline" \n       class="audiobook-cover-badge-cloud">\n    <svg class="icon">\n      <filter xmlns="http://www.w3.org/2000/svg" id="dropshadow-3" height="130%">\n        <feGaussianBlur in="SourceAlpha" stdDeviation="1" /> \n        <feOffset dx="1" dy="1" result="offsetblur" />\n        <feComponentTransfer>\n          <feFuncA type="linear" slope="0.25" />\n        </feComponentTransfer>\n        <feMerge> \n          <feMergeNode/>\n          <feMergeNode in="SourceGraphic" /> \n        </feMerge>\n      </filter>\n      <use xlink:href="assets/common/icons.svg#icon-cloud-outline-stroke"\n           style="filter:url(#dropshadow-3)" />\n    </svg>\n  </div>\n</div>\n\n<div class="audiobook-grid-item-details">\n  <svg class="icon" ng-click="libModel.showContextMenu($event)">\n    <use xlink:href="assets/common/icons.svg#icon-ellipsis-vertical" />\n  </svg>\n  <div class="audiobook-grid-item-title" ng-bind="deliverable.title"></div>\n  <div class="audiobook-grid-item-author" ng-bind="deliverable.author"></div>\n  <div class="audiobook-progress" ng-show="!isNew">\n    <div class="max"></div>\n    <div class="current" ng-style="{width : (deliverable.bookmark.progress * 100) + \'%\'}"></div>\n  </div>\n</div>')}]),angular.module("../directives/audiobook-list-item/audiobook-list-item.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/audiobook-list-item/audiobook-list-item.tpl.html",'<div class="tw-audiobook-list-item">\n  <div class="library-selection"\n       ng-class="{ \'selected\': libSelection.isSelected(deliverable.id), \'disabled\': libSelection.isDisabled(deliverable.id), \'visible\': libSelection.isSelectionMode }" \n       ng-click="onSelectionClick($event)"\n       role="option">\n    <div class="library-selection-overlay"></div>\n    <div class="library-selection-marker">\n      <svg class="icon centered"><use xlink:href="assets/common/icons.svg#icon-checkmark" /></svg>\n    </div>\n  </div>\n  \n  <div class="library-list-item-content" ng-click="onClick($event)" ng-class="{\'selection-mode\': libSelection.isSelectionMode }">\n    <div class="library-list-item-image" ng-style="coverStyles">\n      <div ng-show="isCurrent" class="library-list-item-badge-current">\n        <svg>\n          <use xlink:href="assets/common/icons.svg#icon-recently_read"/>\n        </svg>\n      </div>\n      <div ng-show="!deliverable.isOffline" class="library-list-item-badge-cloud">\n        <svg>\n        <filter xmlns="http://www.w3.org/2000/svg" id="dropshadow" height="130%">\n          <feGaussianBlur in="SourceAlpha" stdDeviation="1" /> \n          <feOffset dx="1" dy="1" result="offsetblur" />\n          <feComponentTransfer>\n            <feFuncA type="linear" slope="0.25" />\n          </feComponentTransfer>\n          <feMerge> \n            <feMergeNode/>\n            <feMergeNode in="SourceGraphic" /> \n          </feMerge>\n        </filter>\n          <use xlink:href="assets/common/icons.svg#icon-cloud-outline-stroke"\n          style="filter:url(#dropshadow)" />\n        </svg>\n      </div>\n    </div>\n    <div class="library-list-item-meta">\n      <div class="library-list-item-meta-title-author">\n        <div class="library-list-item-meta-title" ng-bind="deliverable.title"></div>\n        <div class="library-list-item-meta-author" ng-bind="deliverable.author"></div>\n        <div ng-if="isNew" class="library-list-item-meta-new" ng-bind="\'COMMON_NEW\' | translate"></div>\n        <div class="library-list-item-meta-progress" ng-show="!isNew">\n          <div class="max"></div>\n          <div class="current" ng-style="{width: (deliverable.bookmark.progress * 100) + \'%\'}"></div>\n        </div>\n      </div>\n      <div ng-if="deliverable.duration" class="library-list-item-meta-duration" ng-bind="formattedDuration"></div>\n      <div ng-if="deliverable.isSample" class="library-list-item-meta-sample" ng-bind="\'COMMON_SAMPLE\' | translate"></div>\n      <div class="library-list-item-meta-reseller" ng-bind="deliverable.resellername"></div>\n      <div ng-if="!libSelection.isSelectionMode" ng-click="libModel.showContextMenu($event)" class="library-list-item-meta-menu">\n        <svg class="icon">\n          <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="assets/common/icons.svg#icon-ellipsis-vertical"></use>\n        </svg>\n      </div>\n    </div>\n  </div>\n</div>')}]),angular.module("../directives/basic-slider/basic-slider.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/basic-slider/basic-slider.tpl.html",'<div class="track" ng-show="active" >\n  <div class="knob"></div>\n</div>\n<ng-transclude></ng-transclude>\n')}]),angular.module("../directives/collection-add-dialog/collection-add-dialog.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/collection-add-dialog/collection-add-dialog.tpl.html",'<tw-dialog \n  show="dialogOptions.isVisible"\n  options="::dialogOptions"\n  dialog-title="{{ \'ADD_TO_COLLECTION\' }}"\n  role="dialog">\n</tw-dialog>\n')}]),angular.module("../directives/collection-delete-dialog/collection-delete-dialog.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/collection-delete-dialog/collection-delete-dialog.tpl.html",'<tw-dialog show="options.isVisible" class="tw-collection-delete" options="::options" dialog-title="{{ dialogTitle }}">\n  <div class="tw-collection-delete-message">\n    <div class="tw-collection-delete-text" translate>DELETING_A_COLLECTION_DOES_NOT_DELETE_THE_ACTUAL_TITLES</div>\n    <div class="tw-collection-delete-checkbox">\n      <input id="checkbox-collection-delete" type="checkbox"\n             ng-model="options.dontShowDialogAgain"\n             ng-change="onChangeDontShowDialogAgain()">\n      <label for="checkbox-collection-delete" translate>DONT_SHOW_THIS_MESSAGE_AGAIN</label>\n    </div>\n  </div>\n  \n  <button ng-click="cancelDialog()" data-test="mybooks-collection-delete-dialog-cancel" translate>COMMON_CANCEL</button>\n  <button ng-click="deleteCollections()"\n          data-test="mybooks-collection-delete-dialog-action" translate>COMMON_DELETE</button>\n</tw-dialog>')}]),angular.module("../directives/collection-edit-dialog/collection-edit-dialog.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/collection-edit-dialog/collection-edit-dialog.tpl.html",'<tw-dialog show="options.isVisible" class="tw-collection-edit" options="::options" dialog-title="{{ dialogTitle }}">\n  <div class="collection-name-input">\n    <input type="text" role="input" tabindex="0"\n           autocorrect="off"\n           autocapitalize="off"\n           autocomplete="off"\n           spellcheck="false"\n           ng-model="options.collectionName"\n           ng-keyup="onKeyUp($event)"\n           ng-change="onInputChange()">\n    </input>\n    <span class="collection-name-placeholder" ng-show="!options.collectionName" translate>COLLECTION_NAME</span>\n  </div>\n  \n  <div class="collection-name-hint">{{ collectionNameHint }}</div>\n  \n  <button ng-click="cancelDialog()" data-test="mybooks-collection-edit-dialog-cancel" translate>COMMON_CANCEL</button>\n  <button ng-click="editCollection()" ng-disabled="!isValidCollectionName" \n          data-test="mybooks-collection-edit-dialog-action">{{ buttonLabel }}</button>\n</tw-dialog>')}]),angular.module("../directives/collection-grid-item/collection-grid-item.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/collection-grid-item/collection-grid-item.tpl.html",'<div class="tw-collection-grid-item" \n     collection-id="{{ collection.id }}"\n     ng-click="onCollectionClick()"\n     data-test="component-collection{{ collection.category !== \'collection\' ? \'-\' + collection.category : \'\' }}">\n  \n  <div ng-if="collSelect.isSelectionMode"\n       class="collection-selection" \n       ng-class="{ \'selected\': collSelect.isSelected(collection.id), \'disabled\': collSelect.isDisabled(collection.id) }"\n       role="option">\n    <div class="collection-selection-overlay"></div>\n    <div class="collection-selection-marker">\n      <svg class="icon centered"><use xlink:href="assets/common/icons.svg#icon-checkmark" /></svg>\n    </div>\n    <canvas class="collection-mask"></canvas>\n  </div>\n  \n  <canvas class="collection-preview"></canvas>\n  \n  <div class="collection-footer">\n    <div class="collection-title">\n      {{ collection.title }}\n      <span>({{ numItems }})<span>\n    </div>\n    <span ng-click="showContextMenu($event)" ng-if="isContextMenuEnabled">\n      <svg  class="icon">\n        <use xlink:href="assets/common/icons.svg#icon-ellipsis-vertical" />\n      </svg>\n    </span>\n  </div>\n</div>\n')}]),angular.module("../directives/collection-list-item/collection-list-item.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/collection-list-item/collection-list-item.tpl.html",'<div ng-click="onCollectionClick($event)"\n     collection-id="{{ collection.id }}"\n     class="tw-collection-list-item"\n     ng-class="{ \'select-mode\': collSelect.isSelectionMode }"\n     data-test="component-collection{{ collection.category !== \'collection\' ? \'-\' + collection.category : \'\' }}">\n  \n  <div class="collection-selection"\n       ng-class="{ \'selected\': collSelect.isSelected(collection.id), \'disabled\': collSelect.isDisabled(collection.id) }"\n       ng-click="onSelectClick($event)"\n       role="option">\n    <div class="collection-selection-overlay"></div>\n    <div class="collection-selection-marker">\n      <svg class="icon centered"><use xlink:href="assets/common/icons.svg#icon-checkmark" /></svg>\n    </div>\n  </div>\n\n  <div class="collection-list-item">\n    <span class="collection-title" ng-bind="collection.title"></span>&nbsp;&nbsp;<span class="collection-num-items" ng-bind="\'(\' + numItems + \')\'"></span>\n    <svg ng-if="isContextMenuEnabled" class="icon float-right" ng-click="showContextMenu($event)">\n      <use xlink:href="assets/common/icons.svg#icon-ellipsis-vertical" />\n    </svg>\n  </div>\n</div>')}]),angular.module("../directives/collection-remove-deliverable-dialog/collection-remove-deliverable-dialog.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/collection-remove-deliverable-dialog/collection-remove-deliverable-dialog.tpl.html",'<tw-dialog show="options.isVisible" class="tw-collection-delete" options="::options" dialog-title="{{ \'REMOVE_FROM_COLLECTION\' | translate }}">\n  <div class="tw-collection-delete-message">\n    <div class="tw-collection-delete-text" translate>REMOVING_TITLES_FROM_COLLECTION_DOES_NOT_DELETE_THE_TITLES</div>\n    <div class="tw-collection-delete-checkbox">\n      <input id="checkbox-collection-remove-deliverable" type="checkbox"\n             ng-model="options.dontShowDialogAgain"\n             ng-change="onChangeDontShowDialogAgain()">\n      <label for="checkbox-collection-remove-deliverable" translate>DONT_SHOW_THIS_MESSAGE_AGAIN</label>\n    </div>\n  </div>\n  \n  <button ng-click="cancelDialog()" data-test="mybooks-collection-remove-deliverable-dialog-cancel" translate>COMMON_CANCEL</button>\n  <button ng-click="removeDeliverables()"\n          data-test="mybooks-collection-remove-deliverable-dialog-action" translate>COMMON_REMOVE</button>\n</tw-dialog>')}]),angular.module("../directives/conflict-dialog/conflict-dialog.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/conflict-dialog/conflict-dialog.tpl.html",'<tw-dialog show="options.isVisible" options="options" dialog-icon-text="exclam-solid" role="dialog">\n  <button ng-click="selectOption(clientState)" data-test="error-dialog-close" translate>COMMON_IGNORE</button>\n  <button ng-click="selectOption(serverState)" data-test="error-dialog-close">{{ continue | translate }}</button>\n</tw-dialog>')}]),angular.module("../directives/context-menu/context-menu.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/context-menu/context-menu.tpl.html",'<div class="context-menu-container" show-if="options.isVisible">\n  <div class="context-menu-modal"></div>\n  <ul class="context-menu" ng-style="contextMenuPosition">\n    <li ng-repeat="(action, menuItem) in options.items"\n        class="context-menu-item"\n        ng-if="menuItem.isVisible != false"\n        ng-class="{ disabled: !menuItem.isEnabled }"\n        ng-click="execContextMenu(action, menuItem, $event)"\n        data-action="{{action}}"\n        data-test="component-contextMenu-{{action}}"\n        title="{{ menuItem.tooltip | translate }}"\n        role="menuitem" translate="{{ menuItem.tooltip }}">\n    </li>\n  </ul>\n</div>\n')}]),angular.module("../directives/cover-flow/cover-flow.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/cover-flow/cover-flow.tpl.html",'<tw-activity-indicator id="cover-flow"></tw-activity-indicator>\n<div class="cover-flow scroll-container">\n  <div class="cover-flow-item"\n       ng-repeat="deliverable in coverFlowItems"\n       data-index="{{ $index }}"\n       deliverable-id="{{ deliverable.id }}">\n       \n    <div class="cover-flow-item-cover"\n         ng-class="{ \'is-focused\': deliverable.isFocused, \'animate\': animationsEnabled == true }"\n         ng-style="{\n'+"           'width': deliverable.isFocused ? deliverable.cover.dimensionsFocused.width + 'px' : deliverable.cover.dimensionsNotFocused.width + 'px',\n           'background-size': 'cover'\n         }\">\n      <div class=\"cover-flow-item-cover-fallback\"\n           ng-class=\"{ 'animate': animationsEnabled == true }\"\n           ng-style=\"{ 'background-image': deliverable.cover.urlFallback ? 'url(' + deliverable.cover.urlFallback + ')' : '//:0',\n                       'width': deliverable.isFocused ? \n                         deliverable.cover.dimensionsFocused.width + 'px' : \n                         deliverable.cover.dimensionsNotFocused.width + 'px',\n                       'height': deliverable.isFocused ? \n                         deliverable.cover.dimensionsFocused.height + 'px' : \n                         deliverable.cover.dimensionsNotFocused.height + 'px',\n                        'margin-top': deliverable.isFocused ?\n                          deliverable.cover.dimensionsFocused.marginTop + 'px' : \n                          deliverable.cover.dimensionsNotFocused.marginTop + 'px',\n                     }\">\n        <div class=\"cover-flow-item-title\">{{ deliverable.title }}</div>\n        <div class=\"cover-flow-item-author\">{{ deliverable.author }}</div>\n      </div>\n      <div class=\"cover-flow-item-cover-image\"\n           ng-class=\"{ 'animate': animationsEnabled == true }\"\n           ng-style=\"{ 'background-image': deliverable.cover.url ? 'url(' + deliverable.cover.url + ')' : '//:0',\n                       'width': deliverable.isFocused ? \n                         deliverable.cover.dimensionsFocused.width + 'px' : \n                         deliverable.cover.dimensionsNotFocused.width + 'px',\n                       'height': deliverable.isFocused ? \n                         deliverable.cover.dimensionsFocused.height + 'px' : \n                         deliverable.cover.dimensionsNotFocused.height + 'px',\n                       'background-size': deliverable.isFocused ? \n                         deliverable.cover.dimensionsFocused.width + 'px ' +  deliverable.cover.dimensionsFocused.height + 'px' : \n                         deliverable.cover.dimensionsNotFocused.width + 'px ' + deliverable.cover.dimensionsNotFocused.height + 'px',\n                        'margin-top': deliverable.isFocused ?\n                          deliverable.cover.dimensionsFocused.marginTop + 'px' : \n                          deliverable.cover.dimensionsNotFocused.marginTop + 'px',\n                     }\">\n      </div>\n      \n      <div ng-show=\"deliverable.badges.isCurrent\" \n           class=\"cover-flow-item-badge-current\"\n           ng-class=\"{ 'animate': animationsEnabled == true }\"\n           ng-style=\"{ \n             'margin-top': deliverable.isFocused ?\n               deliverable.cover.dimensionsFocused.marginTop + 'px' : \n               deliverable.cover.dimensionsNotFocused.marginTop + 'px',\n             'opacity': deliverable.isFocused ? 1 : 0\n           }\">\n        <svg class=\"icon\">\n          <use xlink:href=\"assets/common/icons.svg#icon-recently_read\"/>\n        </svg>\n      </div>\n      <div ng-show=\"!deliverable.badges.isOffline\"\n           class=\"cover-flow-item-badge-cloud\"\n           ng-class=\"{ 'animate': animationsEnabled == true }\"\n           ng-style=\"{ \n             'margin-top': deliverable.isFocused ?\n               deliverable.cover.dimensionsFocused.marginTop + 'px' : \n               deliverable.cover.dimensionsNotFocused.marginTop + 'px',\n             'opacity': deliverable.isFocused ? 1 : 0\n           }\">\n        <svg class=\"icon\">\n          <use ng-attr-xlink:href=\"assets/common/icons.svg#icon-cloud-outline-stroke\" xlink:href=\"\" />\n        </svg>\n      </div>\n      <div ng-show=\"deliverable.badges.isNew\"\n           class=\"cover-flow-item-badge-new\"\n           ng-class=\"{ 'animate': animationsEnabled == true }\"\n           ng-style=\"{ \n             'margin-top': deliverable.isFocused ?\n               deliverable.cover.dimensionsFocused.marginTop + 'px' : \n               deliverable.cover.dimensionsNotFocused.marginTop + 'px',\n             'opacity': deliverable.isFocused ? 1 : 0\n           }\">\n        <div class=\"cover-flow-item-badge-new-text\"\n             ng-bind=\"'COMMON_NEW' | translate\"></div>\n        <svg class=\"icon\">\n          <use ng-attr-xlink:href=\"assets/common/icons.svg#icon-banderole-fill\" xlink:href=\"\" />\n        </svg>\n      </div>\n      <div ng-show=\"deliverable.badges.isSample\"\n           class=\"cover-flow-item-badge-sample\"\n           ng-class=\"{ 'animate': animationsEnabled == true }\"\n           ng-style=\"{ \n             'margin-bottom': deliverable.isFocused ?\n               deliverable.cover.dimensionsFocused.marginBottom + 'px' : \n               deliverable.cover.dimensionsNotFocused.marginBottom + 'px',\n             'opacity': deliverable.isFocused ? 1 : 0\n           }\"\n           >\n        <div class=\"cover-flow-item-badge-sample-text\" \n             ng-bind=\"'COMMON_SAMPLE' | translate\"></div>\n        <svg class=\"icon\">\n          <use xlink:href=\"assets/common/icons.svg#icon-banderole-fill\" />\n        </svg>\n      </div>\n      \n    </div>\n    \n    <div class=\"cover-flow-item-info\"\n         ng-class=\"{ 'is-focused': deliverable.isFocused }\">\n      <div ng-if=\"deliverable.type != 'AUDIOBOOK'\" class=\"cover-flow-item-info-progress\">\n        <div class=\"max\" ng-class=\"{ 'finished': deliverable.isFinished == true }\"></div>\n        <div class=\"current\" ng-style=\"{ width: (deliverable.bookmark.progress * 100) + '%'}\"></div>\n        <svg ng-if=\"deliverable.isFinished == true\" class=\"finished-checkmark\">\n          <use xlink:href=\"assets/common/icons.svg#icon-checkmark\" />\n        </svg>\n      </div>\n      <div ng-if=\"deliverable.progress.currentPage && deliverable.progress.lastAvailablePage\" \n           class=\"cover-flow-item-info-page-count\">\n        {{ deliverable.progress.currentPage }}/{{ deliverable.progress.lastAvailablePage }}\n      </div>\n      <div class=\"cover-flow-item-info-context\"\n           ng-click=\"libModel.showContextMenu($event)\">\n        <svg class=\"icon\">\n          <use xlink:href=\"assets/common/icons.svg#icon-ellipsis-vertical\" />\n        </svg>\n      </div>\n    </div>\n  </div>\n  <div class=\"cover-flow-item-spacer\"\n       ng-style=\"{ 'width': scrollContainerSpacerWidth + 'px' }\"></div>\n</div>\n");
}]),angular.module("../directives/cover-info/cover-info.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/cover-info/cover-info.tpl.html",'<div class="cover">\n  <img ng-src="{{ coverUrl }}" class="cover-info-cover"></img>\n</div>\n\n<div class="cover-infos">\n  <div class="cover-info-title">{{ deliverable.title }}</div>\n  <div class="cover-info-author">{{ deliverable.author }}</div>\n  <div class="cover-info-progress" ng-show="!isNew">\n    <div class="max"></div>\n    <div class="current" ng-style="{width : (deliverable.bookmark.progress * 100) + \'%\'}"></div>\n    <div ng-if="deliverable.bookmark.currentPage" class="pages">{{deliverable.bookmark.currentPage}}/{{deliverable.bookmark.lastPage}}</div>\n  </div>\n  <div class="cover-info-status">\n    \n    <div ng-if="deliverable.subscriptionId" class="cover-info-action subscription">\n      <span translate>COMMON_SUBSCRIPTION</span>:&nbsp;<span>{{ deliverable.subscriptionNames }}</span>\n    </div>\n\n    <div class="cover-info-action" ng-if="deliverable.type == \'EDATA\'" ng-click="edit()">\n      <svg class="icon">\n          <use xlink:href="assets/common/icons.svg#icon-edit" />\n        </svg>\n      <span translate>TOOLTIP_COMPONENT_LIBRARY_CONTEXTEDIT</span>\n    </div>\n\n    <div ng-if="loggedIn">\n      <!--div class="cover-info-action" ng-if="deliverable.isOffline">\n        <svg class="icon">\n          <use xlink:href="assets/common/icons.svg#icon-checkmark-solid" />\n        </svg>\n        <span translate>COMMON_DOWNLOADED</span>\n      </div>\n\n      <div class="cover-info-action" ng-if="deliverable.isDownloading">\n        <svg class="icon">\n          <use xlink:href="assets/common/icons.svg#icon-cloud-download" />\n        </svg>\n        <span>{{ deliverable.isDownloading }}</span>\n      </div-->\n\n      <div ng-if="!deliverable.subscriptionId" class="cover-info-action" ng-click="download()">\n        <svg class="icon">\n          <use xlink:href="assets/common/icons.svg#icon-cloud-outline" />\n        </svg>\n        <span class="mimic-link" translate>COMMON_DOWNLOAD</span>\n      </div>\n    </div>\n\n    <div ng-if="deliverable.format != \'PDF\'">\n\n      <div class="cover-info-action" ng-if="deliverable.comments.length == 0">\n        <svg class="icon">\n          <use xlink:href="assets/common/icons.svg#icon-bookmark-page" />\n        </svg>\n        <span translate>COMMON_NOTES_NONE</span>\n      </div>\n\n      <div class="cover-info-action" ng-if="deliverable.comments.length > 0" ng-click="notes()">\n        <svg class="icon">\n          <use xlink:href="assets/common/icons.svg#icon-bookmark-page" />\n        </svg>\n        <span class="mimic-link">({{ deliverable.comments.length }}) <span translate>COMMON_NOTES</span></span>\n      </div>\n\n    </div>\n\n  </div>\n\n</div>\n')}]),angular.module("../directives/delete-dialog/delete-dialog.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/delete-dialog/delete-dialog.tpl.html",'<tw-dialog show="options.isVisible" options="::options" dialog-title="{{ \'DIALOG_CONFIRM_DELETION_TITLE\' | translate }}"\n  dialog-text="{{ \'DIALOG_CONFIRM_DELETION_TEXT\' | translate }}" dialog-icon-text="exclam-solid" role="dialog">\n  <button ng-click="close()" data-test="mybooks-delete-dialog-cancel" translate>COMMON_CANCEL</button>\n  <button ng-click="confirm()" data-test="mybooks-delete-dialog-ok" translate>COMMON_OK</button>\n</tw-dialog>')}]),angular.module("../directives/dialog/dialog.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/dialog/dialog.tpl.html",'<div class="tw-dialog" ng-show="show" ng-class="{ notDisplayed: !options.isModal }">\n  <div class="dialog-content" role="dialog" ng-style="dialogStyles">\n    <div class="dialog-content-container">\n      <div class="title-with-text">\n        <div translate-compile>{{ dialogTitle | translate }}</div>\n        <div translate-compile>{{ dialogText | translate }}</div>\n      </div>\n    </div>\n    <div class="dialog-buttons" ng-transclude></div>\n  </div>\n</div>\n')}]),angular.module("../directives/download-dialog/download-dialog.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/download-dialog/download-dialog.tpl.html",'<div class="download-modal" show-if="!!deliverable">\n  <div class="download-dialog centered" role="dialog">\n    <div class="download-title" translate>DOWNLOAD_PUBLICATION</div>\n    \n    <div class="download-pub-info">\n      <div class="download-block-left download-cover" ng-style="{\'background-image\': \'url(\' + coverURL + \')\'}">\n      </div>\n      <div class="download-title-author">\n        <div class="pub-title" ng-bind="pubTitle"></div>\n        <div class="pub-author" ng-bind="pubAuthor"></div>\n        <div class="download-prepare" ng-show="downloadInProgress" translate>DOWNLOAD_IS_BEING_PREPARED</div>\n      </div>\n    </div>\n    \n    <div class="download-footer">\n      <div class="download-progress" ng-class="{ \'fade-out\': !downloadInProgress }" role="progressbar"\n           aria-valuenow="{{progress.toFixed()}}" aria-valuemin="0" aria-valuemax="100">\n        <div ng-style="{ width: progress + \'%\' }"></div>\n      </div>\n      \n      <div class="buttons">\n        <button ng-click="closeDialog()" data-test="downloadDialog-btnCloseDialog" translate>COMMON_ABORT</button>\n        <button ng-show="!downloadInProgress && !downloadLink" class="download-btn-request" ng-click="requestDownloadLink()" translate>DOWNLOAD_REQUEST</button>\n        <a ng-show="downloadInProgress || downloadLink" target="_blank" data-test="downloadDialog-btnDownload" download>\n          <div class="button" ng-disabled="!downloadLink" ng-click="downloadLink && clickDownloadLink()" translate>COMMON_DOWNLOAD</div>\n        </a>\n      </div>\n      \n    </div>\n  </div>\n</div>\n')}]),angular.module("../directives/dropdown-list/dropdown-list.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/dropdown-list/dropdown-list.tpl.html",'<div class="dropdown-container">\n  <div class="dropdown-current-label" \n       ng-click="toggleListVisibility()" \n       ng-class="{ \'active\': isListVisible == true }"\n       data-icon="{{ icon }}">\n     <span>{{ selectedItemLabel }}</span>\n  </div>\n  <div class="dropdown-list" ng-if="isListVisible">\n    <div ng-repeat="item in listItems"\n         class="dropdown-listitem" \n         ng-class="{ selected: item == selectedItem }"\n         ng-click="selectItem(item)"\n         data-test="component-dropDownList-{{ item.id }}">\n      <span>{{ item.label || item.id }}</span>\n      <svg class="icon"><use xlink:href="assets/common/icons.svg#icon-checkmark" /></svg>\n    </div>\n  </div>\n</div>\n')}]),angular.module("../directives/empty-list/empty-list.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/empty-list/empty-list.tpl.html",'<div class="empty-list">\n  <div class="empty-list-info">\n    <svg class="icon">\n      <use ng-attr-xlink:href="{{ \'assets/common/icons.svg#icon-\' + iconName }}" xlink:href="" />\n    </svg>\n    <div ng-if="headline" class="empty-list-headline" ng-bind="headline"></div>\n    <div ng-if="text" class="empty-list-text" ng-bind="text"></div>\n    <button class="raised" ng-if="shopURL" ng-click="onButtonClick()" data-test="empty-list-btn-shop" ng-bind="\'TO_THE_SHOP\' | translate"></button>\n    <div class="transcluded-content" ng-transclude></div>\n  </div>\n</div>\n')}]),angular.module("../directives/error-dialog/error-dialog.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/error-dialog/error-dialog.tpl.html",'<tw-dialog show="options.isVisible" options="options" dialog-title="{{ headline }}"\n  dialog-text="{{ message }}" dialog-icon-text="exclam-solid" role="dialog">\n  <button ng-click="close()" data-test="error-dialog-close" translate>COMMON_OK</button>\n</tw-dialog>')}]),angular.module("../directives/finished-dialog/finished-dialog.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/finished-dialog/finished-dialog.tpl.html",'<tw-dialog show="options.isVisible"\n          class="dialog-mark-as-finished"\n          options="options"\n          width="360px"\n          dialog-title="{{ \'FINISHED_QUESTION\' | translate }}"\n          dialog-text="{{ \'HAVE_YOU_FINISHED_READING_THIS_TITLE\' | translate }}"\n          role="dialog">\n          \n  <div class="checkbox">\n    <input id="checkbox-mark-as-finished" type="checkbox"\n            ng-model="options.dontAskAgain"\n            ng-change="markAsFinishedCheckBoxChange()">\n    <label for="checkbox-mark-as-finished" translate>DONT_SHOW_THIS_MESSAGE_AGAIN</label>\n  </div>\n  \n  <button class="float-left"\n          ng-click="markAsFinishedClose()"\n          data-test="reader-mark-as-finished-btnClose"\n          translate>\n    COMMON_NO\n  </button>\n  <button class="float-right"\n          ng-click="markAsFinished()"\n          data-test="reader-mark-as-finished-btn"\n          translate>\n    COMMON_YES\n  </button>\n</tw-dialog>\n')}]),angular.module("../directives/font-select-list/font-select-list.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/font-select-list/font-select-list.tpl.html",'<div class="font-select-list">\n  <div class="font-select-header">\n    <div ng-click="closeList()"\n         class="close-list"\n         title="{{ \'COMMON_CLOSE\' | translate }}"\n         data-test="component-select-list-close">\n      <svg class="icon"><use xlink:href="assets/common/icons.svg#icon-arrow-left" /></svg>\n      <div class="title">{{ options.title | translate }}</div>\n    </div>\n  </div>\n  <div class="font-list-container scrollable">\n    <ul class="font-list-items">\n      <li ng-repeat="listItem in options.list"\n          ng-class="{ selected: $index === options.selectedIndex }"\n          ng-click="listItemClick($index)">\n        \n        <div ng-if="listItem.preview"  class="item-preview" ng-bind-html="listItem.preview"></div>\n        <div ng-if="!listItem.preview" class="item-name">{{ listItem.name | translate }}</div>\n        \n        <svg ng-if="!listItem.isPreInstalled" class="icon item-delete"\n             ng-click="listItemDelete($event, listItem)"\n             title="{{ \'COMMON_DELETE\' | translate }}">\n          <use xlink:href="assets/common/icons.svg#icon-delete" />\n        </svg>\n        \n      </li>\n    </ul>\n  </div>\n</div>\n')}]),angular.module("../directives/grid-view/grid-view.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/grid-view/grid-view.tpl.html",'<tw-publication-grid class="grid-view-deliverable"\n                     ng-repeat="deliverable in deliverables"\n                     cover-click="itemAction({id : deliverable.id})"\n                     deliverable="deliverable"\n                     deliverable-id="{{ deliverable.id }}">\n</tw-publication-grid>')}]),angular.module("../directives/item-select-list/item-select-list.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/item-select-list/item-select-list.tpl.html",'<div class="item-select-list">\n  <div class="item-select-list-header">\n    <div ng-click="closeList()"\n         class="item-select-list-close"\n         title="{{ \'COMMON_CLOSE\' | translate }}">\n      <svg class="icon"><use xlink:href="assets/common/icons.svg#icon-arrow-left" /></svg>\n      <div class="item-select-list-title">{{ options.title | translate }}</div>\n    </div>\n  </div>\n  <div class="item-select-list-container scrollable">\n    <ul class="item-select-list-items">\n      <li class="item-select-list-item"\n          ng-repeat="item in options.items"\n          ng-class="{ selected: $index === options.selectedIndex }"\n          ng-click="listItemClick($index)">\n        {{ item.label | translate }}\n    </ul>\n  </div>\n</div>\n')}]),angular.module("../directives/label-button/label-button.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/label-button/label-button.tpl.html",'<div class=\'{{ resellerLogoIdentifier }}\'>\n  {{ label }}\n</div>\n<div class="right-arrow">\n  <svg class="icon"><use xlink:href="assets/common/icons.svg#icon-arrow-right" /></svg>\n</div>')}]),angular.module("../directives/library-bar/actions/add-to-collection.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/library-bar/actions/add-to-collection.tpl.html",'<span class="icon-container header-bar-action-add-to-collection" ng-click="addToCollectionAction()"\n  title="{{ \'ADD_TO_COLLECTION\' | translate }}">\n  <svg class="icon">\n    <use xlink:href="assets/common/icons.svg#icon-plus-circled" />\n  </svg>\n</span>')}]),angular.module("../directives/library-bar/actions/back.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/library-bar/actions/back.tpl.html",'<span ng-click="backAction()" title="{{ sidebarMenuToggleTranslation | translate }}" class="icon-container">\n  <svg class="icon"><use xlink:href="assets/common/icons.svg#icon-back" /></svg>\n</span>')}]),angular.module("../directives/library-bar/actions/cancel.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/library-bar/actions/cancel.tpl.html",'<span ng-click="cancelAction()" title="{{ \'COMMON_CANCEL\' | translate }}" class="icon-container">\n  <svg class="icon"><use xlink:href="assets/common/icons.svg#icon-cancel" /></svg>\n</span>')}]),angular.module("../directives/library-bar/actions/context.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/library-bar/actions/context.tpl.html",'<span ng-click="contextAction($event)" title="{{ sidebarMenuToggleTranslation | translate }}" class="icon-container">\n  <svg class="icon"><use xlink:href="assets/common/icons.svg#icon-ellipsis-vertical" /></svg>\n</span>')}]),angular.module("../directives/library-bar/actions/delete-collections.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/library-bar/actions/delete-collections.tpl.html",'<span ng-class="{ \'demo\': !isLoggedIn }" class="icon-container header-bar-action-delete-coll" ng-click="deleteCollectionsAction()"\n  title="{{ \'DELETE_COLLECTIONS\' | translate }}">\n  <svg class="icon">\n    <use xlink:href="assets/common/icons.svg#icon-delete" />\n  </svg>\n</span>')}]),angular.module("../directives/library-bar/actions/delete.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/library-bar/actions/delete.tpl.html",'<span ng-class="{ \'demo\': !isLoggedIn }" class="icon-container header-bar-action-delete" ng-click="deleteAction()"\n  title="{{ \'COMMON_DELETE\' | translate }}">\n  <svg class="icon">\n    <use xlink:href="assets/common/icons.svg#icon-delete" />\n  </svg>\n</span>')}]),angular.module("../directives/library-bar/actions/display.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/library-bar/actions/display.tpl.html",'<span class="icon-container header-bar-action-sort">\n  <tw-select-list trigger-icon="eye" trigger-tooltip="COMMON_SORT">\n  \n    <div class="select-list-toggle" ng-class="{ disabled: stateActions.view === \'disable\' }" ng-click="viewAction()">\n      <span title="{{ \'COMMON_VIEW\' | translate }}" translate>COMMON_VIEW</span><span>:</span>\n      <svg class="icon" ng-class="{ selected: isGridView == false}">\n        <use xlink:href="assets/common/icons.svg#icon-view-list" />\n      </svg>\n      <svg class="icon" ng-class="{ selected: isGridView == true}">\n        <use xlink:href="assets/common/icons.svg#icon-view-grid" />\n      </svg>\n    </div>\n    \n    <div class="select-list-item" title="{{ \'COMMON_SORT\' | translate }}">\n      <span translate>COMMON_SORT</span><span>:</span>\n    </div>\n    \n    <div ng-repeat="criteria in stateActions.sortcriteria"\n      ng-click="sortAction($event, criteria.key)"\n      class="select-list-item"\n      ng-class="{ selected : sortCriteria == criteria.key}">\n      <span>{{ criteria.translate | translate }}</span>\n      <svg ng-if="!isSortDescending">\n        <use xlink:href="assets/common/icons.svg#icon-triangle-up" />\n      </svg>\n      <svg ng-if="isSortDescending">\n        <use xlink:href="assets/common/icons.svg#icon-triangle-down" />\n      </svg>\n    </div>\n    \n    <div class="finish-toggle">\n      <span class="title" translate>COMMON_SHOW_FINISHED_BOOKS</span>\n      <tw-toggle-switch toggle-state="showFinishedBooks.value" tabindex="0" role="button"></tw-toggle-switch>\n    </div>\n  \n  </tw-select-list>\n</span>  ')}]),angular.module("../directives/library-bar/actions/menu.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/library-bar/actions/menu.tpl.html",'<span ng-click="menuAction()" title="{{ \'TOOLTIP_COMPONENT_HEADERBAR_SHOWMENU\' | translate }}" class="icon-container header-bar-action-menu">\n  <svg class="icon"><use xlink:href="assets/common/icons.svg#icon-menu" /></svg>\n</span>')}]),angular.module("../directives/library-bar/actions/new-collection.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/library-bar/actions/new-collection.tpl.html",'<span class="icon-container header-bar-action-new-collection" ng-click="newCollectionAction()"\n  title="{{ \'CREATE_NEW_COLLECTION\' | translate }}">\n  <svg class="icon">\n    <use xlink:href="assets/common/icons.svg#icon-plus-circled" />\n  </svg>\n</span>')}]),angular.module("../directives/library-bar/actions/remove-from-collection.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/library-bar/actions/remove-from-collection.tpl.html",'<span class="icon-container header-bar-action-remove-from-collection" ng-click="removeFromCollectionAction()"\n  title="{{ \'REMOVE_FROM_COLLECTION\' | translate }}">\n  <svg class="icon">\n    <use xlink:href="assets/common/icons.svg#icon-minus-circled" />\n  </svg>\n</span>')}]),angular.module("../directives/library-bar/actions/search.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/library-bar/actions/search.tpl.html",'<span class="icon-container header-bar-action-search" title="{{ \'SEARCH_PLACEHOLDER\' | translate }}" ng-click="searchAction()">\n  <svg class="icon">\n    <use xlink:href="assets/common/icons.svg#icon-search" />\n  </svg>\n</span>\n')}]),angular.module("../directives/library-bar/actions/upload.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/library-bar/actions/upload.tpl.html",'<span class="icon-container header-bar-action-upload" ng-mouseup="uploadAction()"\n  tw-touchend="uploadAction()" title="{{ \'TOOLTIP_COMPONENT_HEADERBAR_UPLOAD\' | translate }}">\n  <svg class="icon">\n    <use xlink:href="assets/common/icons.svg#icon-upload" />\n  </svg>\n  <form id="form-upload-files">\n    <input type="file" id="upload-files" class="hidden-input" accept="application/pdf, .pdf, application/epub+zip, .epub" file-change="onUploadFileChange"\n      multiple />\n  </form>\n</span>')}]),angular.module("../directives/library-bar/library-bar.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/library-bar/library-bar.tpl.html","<div class=\"header-bar-left\">\n  <ng-include ng-if=\"stateActions.menu != 'hide'\" ng-class=\"{ 'disabled': stateActions.menu == 'disable' }\" src=\"'../directives/library-bar/actions/menu.tpl.html'\"></ng-include>\n  <ng-include ng-if=\"stateActions.back != 'hide'\" ng-class=\"{ 'disabled': stateActions.back == 'disable' }\" src=\"'../directives/library-bar/actions/back.tpl.html'\"></ng-include>\n  <div class=\"header-bar-title\">\n    <span>{{ headline | translate | ampersand }}</span>\n  </div>\n</div>\n\n<tw-search-input ng-if=\"stateActions.search !== 'hide'\"\n                 class=\"header-bar-search\"\n                 options=\"filterOptions\"\n                 ng-keyup=\"onSearchInputKey($event)\">\n</tw-search-input>\n\n<div ng-if=\"stateActions.actions != 'hide'\" class=\"header-bar-actions\">\n  <ng-include ng-if=\"stateActions.search != 'hide'\" ng-class=\"{ 'disabled': stateActions.search == 'disable' }\" src=\"'../directives/library-bar/actions/search.tpl.html'\"></ng-include>\n  <ng-include ng-if=\"stateActions.display != 'hide'\" ng-class=\"{ 'disabled': stateActions.display == 'disable' }\" src=\"'../directives/library-bar/actions/display.tpl.html'\"></ng-include>\n  <ng-include ng-if=\"stateActions.delete != 'hide'\" ng-class=\"{ 'disabled': stateActions.delete == 'disable' }\" src=\"'../directives/library-bar/actions/delete.tpl.html'\"></ng-include>\n  <ng-include ng-if=\"stateActions.upload != 'hide'\" ng-class=\"{ 'disabled': stateActions.upload == 'disable' }\" src=\"'../directives/library-bar/actions/upload.tpl.html'\"></ng-include>\n  <ng-include ng-if=\"stateActions.newCollection != 'hide'\" ng-class=\"{ 'disabled': stateActions.newCollection == 'disable' }\" src=\"'../directives/library-bar/actions/new-collection.tpl.html'\"></ng-include>\n  <ng-include ng-if=\"stateActions.deleteCollections != 'hide'\" ng-class=\"{ 'disabled': stateActions.deleteCollections == 'disable' }\" src=\"'../directives/library-bar/actions/delete-collections.tpl.html'\"></ng-include>\n  <ng-include ng-if=\"stateActions.addToCollection != 'hide'\" ng-class=\"{ 'disabled': stateActions.addToCollection == 'disable' }\" src=\"'../directives/library-bar/actions/add-to-collection.tpl.html'\"></ng-include>\n  <ng-include ng-if=\"stateActions.removeFromCollection != 'hide'\" ng-class=\"{ 'disabled': stateActions.removeFromCollection == 'disable' }\" src=\"'../directives/library-bar/actions/remove-from-collection.tpl.html'\"></ng-include>\n  <ng-include ng-if=\"stateActions.context != 'hide'\" ng-class=\"{ 'disabled': stateActions.context == 'disable' }\" src=\"'../directives/library-bar/actions/context.tpl.html'\"></ng-include>\n  <ng-include ng-if=\"stateActions.subMenu != 'hide'\" class=\"action-menu\" src=\"'../directives/library-bar/menu/menu.tpl.html'\"></ng-include>\n</div>\n<div ng-if=\"stateActions.selection != 'hide'\"\n     class=\"selection-bar-actions\"\n     ng-class=\"{'no-items-selected': amount === 0, 'no-actions': !hasActions }\">\n"+'  <span class="action" ng-click="cancelAction()" translate>COMMON_ABORT</span>\n  <span class="tw-spacer"></span>\n  <tw-delete ng-if="selectAction === \'delete\'">\n    <div class="action action-with-amount" ng-click="amount > 0 && deleteAction()">\n      <span translate>COMMON_DELETE</span>\n      <span ng-if="!selection.isRadioMode">({{amount}})</span>\n    </div>\n  </tw-delete>\n  <tw-add ng-if="selectAction === \'addToCollection\'">\n    <div class="action action-with-amount" ng-click="amount > 0 && addToCollectionAction()">\n      <span translate>ADD_TO_COLLECTION</span>\n      <span ng-if="!selection.isRadioMode">({{amount}})</span>\n    </div>\n  </tw-add>\n  <tw-delete ng-if="selectAction === \'removeFromCollection\'">\n    <div class="action action-with-amount" ng-click="amount > 0 && removeFromCollectionAction()">\n      <span translate>REMOVE_FROM_COLLECTION</span>\n      <span ng-if="!selection.isRadioMode">({{amount}})</span>\n    </div>\n  </tw-delete>\n</div>\n')}]),angular.module("../directives/library-bar/menu/menu.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/library-bar/menu/menu.tpl.html",'<span class="icon-container">\n  <tw-mini-menu>\n\n    <main-pane>\n      <div ng-if="stateActions.view != \'hide\'" ng-class="{ \'disabled\': stateActions.view == \'disable\' }" class="mini-entry navigation" data-navigation="sub">\n        <span title="{{ \'COMMON_VIEW\' | translate }}" translate>COMMON_VIEW</span>\n        <svg>\n          <use xlink:href="assets/common/icons.svg#icon-arrow-right" />\n        </svg>\n      </div>\n      <div ng-if="stateActions.delete != \'hide\'" ng-class="{ \'disabled\': stateActions.delete == \'disable\' }" class="mini-entry" title="{{ \'COMMON_DELETE\' | translate }}" ng-click="deleteAction()" translate>COMMON_DELETE</div>\n      <div ng-if="stateActions.upload != \'hide\'" ng-class="{ \'disabled\': stateActions.upload == \'disable\' }" class="mini-entry" title="{{ \'COMMON_UPLOAD\' | translate }}" ng-click="uploadAction()" translate>COMMON_UPLOAD</div>\n      <div ng-if="stateActions.addToCollection != \'hide\'" ng-class="{ \'disabled\': stateActions.addToCollection == \'disable\' }" class="mini-entry" title="{{ \'ADD_TO_COLLECTION\' | translate }}" ng-click="addToCollectionAction()" translate>ADD_TO_COLLECTION</div>\n      <div ng-if="stateActions.removeFromCollection != \'hide\'" ng-class="{ \'disabled\': stateActions.removeFromCollection == \'disable\' }" class="mini-entry" title="{{ \'REMOVE_FROM_COLLECTION\' | translate }}" ng-click="removeFromCollectionAction()" translate>REMOVE_FROM_COLLECTION</div>\n      <div ng-if="stateActions.newCollection != \'hide\'" ng-class="{ \'disabled\': stateActions.newCollection == \'disable\' }" class="mini-entry" title="{{ \'CREATE_NEW_COLLECTION\' | translate }}" ng-click="newCollectionAction()" translate>NEW_COLLECTION</div>\n      <div ng-if="stateActions.deleteCollections != \'hide\'" ng-class="{ \'disabled\': stateActions.deleteCollections == \'disable\' }" class="mini-entry" title="{{ \'DELETE_COLLECTIONS\' | translate }}" ng-click="deleteCollectionsAction()" translate>DELETE_COLLECTIONS</div>\n    </main-pane>\n\n    <sub-pane>\n\n      <div class="mini-entry navigation" data-navigation="main">\n        <svg class="sub">\n          <use xlink:href="assets/common/icons.svg#icon-arrow-left" />\n        </svg>\n      </div>\n\n      <div class="toggle" ng-click="viewAction()">\n        <span title="{{ \'COMMON_VIEW\' | translate }}" translate>COMMON_VIEW</span>\n        <svg class="icon" ng-class="{ selected : isGridView == false}">\n          <use xlink:href="assets/common/icons.svg#icon-view-list" />\n        </svg>\n        <svg class="icon" ng-class="{ selected : isGridView == true}">\n          <use xlink:href="assets/common/icons.svg#icon-view-grid" />\n        </svg>\n      </div>\n\n      <div class="mini-entry" title="{{ \'COMMON_SORT\' | translate }}">\n        <span translate>COMMON_SORT</span><span>:</span>\n      </div>\n\n    <div ng-repeat="criteria in stateActions.sortcriteria"\n      ng-click="sortAction($event, criteria.key)"\n      class="list-item"\n      ng-class="{ selected : sortCriteria == criteria.key}">\n      <span>{{ criteria.translate | translate }}</span>\n      <svg ng-if="!isSortDescending">\n        <use xlink:href="assets/common/icons.svg#icon-triangle-up" />\n      </svg>\n      <svg ng-if="isSortDescending">\n        <use xlink:href="assets/common/icons.svg#icon-triangle-down" />\n      </svg>\n    </div>\n\n    <div class="finish-toggle">\n      <span class="title" translate>COMMON_SHOW_FINISHED_BOOKS</span>\n      <tw-toggle-switch toggle-state="showFinishedBooks.value" tabindex="0" role="button"></tw-toggle-switch>\n    </div>\n\n    </sub-pane>\n\n  </tw-mini-menu>\n</span>')}]),angular.module("../directives/list-view/list-view.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/list-view/list-view.tpl.html",'<tw-publication-list class="list-view-deliverable"\n                     cover-click="itemAction({id : deliverable.id})"\n                     ng-repeat="deliverable in deliverables"\n                     deliverable="deliverable"\n                     deliverable-id="{{ deliverable.id }}">\n</tw-publication-list>')}]),angular.module("../directives/loader/loader.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/loader/loader.tpl.html",'<div class="tw-loader" show-if="status.deliverableID">\n  <div class="loader-dialog centered" role="dialog" ng-class="{ \'no-pub-info\': !status.publication }">\n  \n    <div class="loader-title" translate>LOADER_TITLE</div>\n  \n    <div ng-if="status.publication" class="loader-pub-info">\n      <div class="loader-cover" ng-style="{\'background-image\': \'url(\' + status.coverUrl + \')\'}"></div>\n  \n      <div class="loader-meta-data">\n        <div class="pub-title">{{status.deliverable.title}}</div>\n        <div class="pub-author">{{status.publication.author}}</div>\n  \n        <div class="pub-meta" ng-class="{ visible: status.deliverable.issued > 0 || status.deliverable.purchased > 0 }">\n          <span class="label"><span>{{lblAddedOrIssued}}</span>:</span>\n          <span>{{ (status.deliverable.issued || status.deliverable.purchased) | date:\'MM/yyyy\' }}</span>\n        </div>\n        <div class="pub-meta" ng-class="{ visible: status.deliverable.format }">\n          <span class="label"><span translate>COMMON_FORMAT</span>:</span>\n          <span>{{ status.deliverable.format }}</span>\n        </div>\n        <div class="pub-meta" ng-class="{ visible: status.publication.publisher }">\n          <span class="label"><span translate>COMMON_PUBLISHER</span>:</span>\n          <span>{{ status.publication.publisher }}</span>\n        </div>\n\n      </div>\n    </div>\n  \n    <div class="loader-progress" role="progressbar" \n         aria-valuenow="{{progress.toFixed()}}" aria-valuemin="0" aria-valuemax="100">\n      <div ng-style="{ width: progress + \'%\' }"></div>\n    </div>\n    <div class="loader-progress-caption">\n      <!-- <div ng-if="!loaded" translate>DOWNLOAD_IS_BEING_PREPARED</div> -->\n      <div ng-if="loaded">{{loaded}} <span translate>COMMON_ENUMERATION_OF</span> {{total}}</div>\n    </div>\n    \n    <button ng-click="abort()" data-test="loader-progress-abort" translate>COMMON_ABORT</button>\n  </div>\n</div>\n')}]),angular.module("../directives/menu-button/menu-button.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/menu-button/menu-button.tpl.html",'<div title="{{ sidebarMenuToggleTranslation | translate }}">\n  <svg class="icon"><use xlink:href="assets/common/icons.svg#icon-menu" /></svg>\n</div>')}]),angular.module("../directives/meta-data-dialog/meta-data-dialog.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/meta-data-dialog/meta-data-dialog.tpl.html",'<div class="meta-data-modal" show-if="isDialogVisible">\n  <div class="meta-data-dialog centered" \n       ng-class="{ \'title-author-only\': titleAuthorOnly }"\n       role="dialog">\n    <div class="meta-data-title" translate>METADATA_TITLE</div>\n    \n    <div class="meta-data-pub-info">\n      <div class="meta-data-block-left meta-data-cover" \n           ng-class="{ \'title-author-only\': titleAuthorOnly, \'fallback-cover\': isFallbackCover }"\n           ng-style="{\'background-image\': \'url(\' + coverURL + \')\'}">\n        \n        <input type="file" \n               file-change="uploadCover" \n               accept="image/jpeg, image/png"\n               class="hidden-input" />\n        <button class="btn-cover-upload"\n                ng-disabled="uploadInProgress"\n                ng-click="triggerFileUpload()"\n                data-test="component-metaDataDialog-btnCoverUpload">\n          {{ coverButtonText }}\n        </button>\n\n        <div class="meta-data-upload-indicator" ng-show="uploadInProgress">\n          <svg class="spinner"><use xlink:href="assets/common/icons.svg#icon-sync" /></svg>\n        </div>\n      </div>\n      \n      <div class="meta-data-title-author" ng-class="{ \'title-author-only\': titleAuthorOnly }">\n        <label class="pub-title"><span translate>COMMON_TITLE</span>\n          <input type="text" ng-model="pubTitle" ng-trim="true" />\n        </label>\n        <label class="pub-author"><span translate>COMMON_AUTHOR</span>\n          <input type="text" ng-model="pubAuthor" ng-trim="true" />\n        </label>\n        \n        <div class="meta-data-caption" translate>METADATA_COVER_IMAGE_UPLOAD_TEXT</div>\n        <div class="meta-data-caption hint" translate>METADATA_COVER_IMAGE_MAX_SIZE_TEXT</div>\n      </div>\n    </div>\n    \n    <div class="meta-data-footer">\n      <button ng-click="closeDialog()"\n              data-test="component-metaDataDialog-btnCancel"\n              translate>\n        COMMON_CANCEL\n      </button>\n      <button class="primary"\n              ng-disabled="uploadInProgress"\n              ng-click="saveDialog()"\n              data-test="component-metaDataDialog-btnSave"\n              translate>\n        COMMON_DONE\n      </button>\n    </div>\n    \n  </div>\n  \n  <tw-dialog show="coverUploadMessage.isVisible"\n             options="::coverUploadMessage"\n             width="360px"\n             dialog-title="{{ \'METADATA_CHANGE_COVER\' | translate }}"\n             dialog-icon-text="exclam-solid">\n    <button class="primary"\n            ng-click="closeCoverUploadMessage()"\n            data-test="library-coverUploadFailed-btnOK"\n            translate>\n      COMMON_OK\n    </button>\n  </tw-dialog>\n  \n</div>\n');
}]),angular.module("../directives/mini-menu/mini-menu.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/mini-menu/mini-menu.tpl.html",'<tw-action-menu>\n\n  <div class="pane-container">\n\n    <ng-transclude ng-transclude-slot="main"></ng-transclude>\n\n    <ng-transclude ng-transclude-slot="sub"></ng-transclude>\n\n  </div>\n\n\n</tw-action-menu>')}]),angular.module("../directives/overlay/overlay.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/overlay/overlay.tpl.html",'<div class="overlay-modal {{ options.className }}"\n     ng-show="show"\n     ng-class="{ \'overlay-hidden\': !options.isModal }"\n     ng-click="onModalClick()"\n     data-test="component-overlay-modalClick">\n  <div class="overlay-dialog {{ options.className }}">\n    <span class="overlay-title"\n          ng-show="!!overlayTitle"\n          ng-bind="overlayTitle"></span>\n    <div class="overlay-close"\n         ng-show="options.hasCloseX"\n         ng-click="hideOverlay()">\n      <span class="overlay-close-x"></span>\n    </div>\n    <div class="overlay-content" ng-transclude></div>\n  </div>\n</div>\n')}]),angular.module("../directives/pub-details/pub-details.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/pub-details/pub-details.tpl.html",'<div class="details-title" ng-bind="\'COMMON_META_DATA\' | translate"></div>\n<div class="details-container">\n  <div class="details">\n    <span>\n      <span ng-bind="\'COMMON_PUBLISHER\' | translate"></span>:\n    </span>\n    <span ng-bind="publication.publisher"></span>\n  </div>\n  <div class="details">\n    <span>\n      <span ng-bind="\'COMMON_ADDED_AT\' | translate"></span>:\n    </span>\n    <span ng-bind="purchased"></span>\n  </div>\n  <div class="details">\n    <span>\n      <span ng-bind="\'COMMON_RESELLER\' | translate"></span>:\n    </span>\n    <span ng-bind="publication.resellername"></span>\n  </div>\n  <div class="details" ng-if="deliverable.issued != 0">\n    <span>\n      <span ng-bind="\'COMMON_ISSUED\' | translate"></span>:\n    </span>\n    <span ng-bind="issued"></span>\n  </div>\n  <div class="details">\n    <span>\n      <span ng-bind="\'COMMON_FORMAT\' | translate"></span>:\n    </span>\n    <span ng-bind="deliverable.format"></span>\n  </div>\n</div>\n')}]),angular.module("../directives/publication-grid/publication-grid.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/publication-grid/publication-grid.tpl.html",'<div class="tw-publication-grid">\n  <div class="publication-cover-image"\n       ng-click="onClick($event)"\n       ng-style="coverStyles">\n    \n    <div ng-if="libSelection.isSelectionMode" \n         class="publication-selection" \n         ng-class="{ \'selected\': libSelection.isSelected(deliverable.id), \'disabled\': libSelection.isDisabled(deliverable.id) }" \n         role="option">\n      <div class="publication-selection-overlay"></div>\n      <div class="publication-selection-marker">\n        <svg class="icon centered">\n          <use xlink:href="assets/common/icons.svg#icon-checkmark" />\n        </svg>\n      </div>\n    </div>\n    \n    <div ng-show="isCurrent" class="publication-cover-badge-current">\n      <svg class="icon">\n        <use xlink:href="assets/common/icons.svg#icon-recently_read"/>\n      </svg>\n    </div>\n    \n    <div ng-show="isNew" class="publication-cover-badge-new">\n      <div class="publication-cover-badge-new-text" ng-bind="\'COMMON_NEW\' | translate"></div>\n      <svg class="icon">\n        <use ng-attr-xlink:href="assets/common/icons.svg#icon-banderole-fill" xlink:href="" style="filter:url(#dropshadow-badges)" />\n      </svg>\n    </div>\n    \n    <div ng-show="deliverable.isSample" class="publication-cover-badge-sample">\n      <div class="publication-cover-badge-sample-text" ng-bind="\'COMMON_SAMPLE\' | translate"></div>\n      <svg class="icon">\n        <use xlink:href="assets/common/icons.svg#icon-banderole-fill"\n             style="filter:url(#dropshadow-badges)" />\n      </svg>\n    </div>\n    \n    <div ng-show="!deliverable.isOffline" \n         class="publication-cover-badge-cloud">\n      <svg class="icon">\n        <use xlink:href="assets/common/icons.svg#icon-cloud-outline-stroke"\n             style="filter:url(#dropshadow-badges)" />\n      </svg>\n    </div>\n  </div>\n  \n  <div class="publication-details">\n    <span title="{{ \'TOOLTIP_COMPONENT_LIBRARY_PUBLICATION_ISCRYPT\' | translate }}">\n      <svg class="crypt icon" ng-if="deliverable.isCrypt">\n        <use xlink:href="assets/common/icons.svg#icon-lock" />\n      </svg>\n    </span>\n    \n    <svg ng-if="deliverable.isFinished" class="icon finished-indicator">\n      <use xlink:href="assets/common/icons.svg#icon-checkmark-solid" />\n    </svg>\n    \n    <span ng-if="!libSelection.isSelectionMode" title="{{ \'TOOLTIP_COMPONENT_ACTIONMENU_TRIGGER\' | translate }}">\n    <span class="context" ng-click="libModel.showContextMenu($event)">\n      <svg class="icon">\n        <use xlink:href="assets/common/icons.svg#icon-ellipsis-vertical" />\n      </svg>\n    </span>\n    </span>\n    <div class="publication-cover-title"\n         ng-class="{ \'is-crypt\': deliverable.isCrypt }"\n         ng-bind="deliverable.title">\n    </div>\n    <div class="publication-cover-author" ng-bind="deliverable.author"></div>\n    <div class="publication-progress" ng-show="!isNew">\n      <div class="max"></div>\n      <div class="current" ng-style="{width : (deliverable.bookmark.progress * 100) + \'%\'}"></div>\n    </div>\n  </div>\n\n</div>\n')}]),angular.module("../directives/publication-list/publication-list.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/publication-list/publication-list.tpl.html",'<div class="tw-publication-list-item">\n  <div class="library-selection"\n       ng-class="{ \'selected\': libSelection.isSelected(deliverable.id), \'disabled\': libSelection.isDisabled(deliverable.id), \'visible\': libSelection.isSelectionMode }" \n       ng-click="onSelectionClick($event)"\n       role="option">\n    <div class="library-selection-overlay"></div>\n    <div class="library-selection-marker">\n      <svg class="icon centered">\n        <use ng-attr-xlink:href="assets/common/icons.svg#icon-checkmark" xlink:href="" />\n      </svg>\n    </div>\n  </div>\n  \n  <div class="library-list-item-content" ng-click="onClick($event)" ng-class="{\'selection-mode\': libSelection.isSelectionMode }">\n    <div class="library-list-item-image" ng-style="coverStyles">\n        <div ng-show="isCurrent" class="library-list-item-badge-current">\n          <svg>\n            <use xlink:href="assets/common/icons.svg#icon-recently_read"/>\n          </svg>\n        </div>\n        <div ng-show="!deliverable.isOffline" class="library-list-item-badge-cloud">\n          <svg>\n            <use ng-attr-xlink:href="assets/common/icons.svg#icon-cloud-outline-stroke" xlink:href=""\n            style="filter:url(#dropshadow-badges)" />\n          </svg>\n        </div>\n    </div>\n    \n    <div class="library-list-item-meta">\n      <div class="library-list-item-meta-title-author">\n        <div class="library-list-item-meta-title" ng-bind="deliverable.title"></div>\n        <div class="library-list-item-meta-author" ng-bind="deliverable.author"></div>\n        \n        <div ng-if="isNew" class="library-list-item-meta-new" ng-bind="\'COMMON_NEW\' | translate"></div>\n        <div class="library-list-item-meta-progress" ng-style="{ width: (deliverable.bookmark.lastPage / 10) + \'%\' }" ng-show="!isNew">\n          <div class="max"></div>\n          <div class="current" ng-style="{width: (deliverable.bookmark.progress * 75) + \'%\'}"></div>\n          <div ng-if="deliverable.bookmark.currentPage" class="pages">{{deliverable.bookmark.currentPage}}/{{deliverable.bookmark.lastPage}}</div>\n        </div>\n      </div>\n      \n      <div ng-if="deliverable.hasUnsupportedFeat || deliverable.isCrypt" class="library-list-item-meta-crypt">\n        <svg ng-if="deliverable.isCrypt">\n          <use ng-attr-xlink:href="assets/common/icons.svg#icon-lock" xlink:href="" />\n        </svg>\n        <svg ng-if="deliverable.hasUnsupportedFeat && !deliverable.isCrypt">\n          <use ng-attr-xlink:href="assets/common/icons.svg#icon-hint-outline" xlink:href="" />\n        </svg>\n      </div>\n      \n      <div ng-if="deliverable.isSample" class="library-list-item-meta-sample" ng-bind="\'COMMON_SAMPLE\' | translate"></div>\n      <div ng-if="hasMultipleResellers" class="library-list-item-meta-reseller" ng-bind="deliverable.resellername"></div>\n      <div class="library-list-item-meta-format" ng-bind="deliverable.format"></div>\n      <div ng-if="!libSelection.isSelectionMode" class="library-list-item-meta-menu" ng-click="libModel.showContextMenu($event)" title="{{ \'TOOLTIP_COMPONENT_ACTIONMENU_TRIGGER\' | translate }}">\n        <svg class="icon">\n          <use xmlns:xlink="http://www.w3.org/1999/xlink" ng-attr-xlink:href="assets/common/icons.svg#icon-ellipsis-vertical" xlink:href=""></use>\n        </svg>\n      </div>\n    </div>\n  </div>\n</div>\n')}]),angular.module("../directives/recommendations/recommendations.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/recommendations/recommendations.tpl.html",'<div class="tw-recommendations" ng-show="visible">\n  <div class="recommendations-header">\n    <span ng-if="showresellername != false"\n          class="recommendations-title"\n          translate\n          translate-values="{{ translationData }}">\n      EDITORIAL_RECOMMENDATIONS\n    </span>\n    <button ng-if="showshoplink != false" \n       ng-click="goToRecoInResellerShop()" \n       href="#" \n       class="recommendations-shop"\n       translate>\n      COMMON_SHOP\n    </button>\n  </div>\n\n  <div class="recommendations-list">\n    <div class="recommendations-cover" ng-repeat="reco in recommendations track by $index"\n         ng-click="goToRecoInResellerShop()"\n         data-test="directive-recommendations-cover">\n        <div class="recommendations-fallback-cover"\n             ng-style="{ \'background-image\': \'url(\' + reco.fallbackCoverUrl + \')\' }">\n             <div class="recommendations-fallback-cover-title">{{ reco.title }}</div>\n        </div>\n        <div class="recommendations-cover-image"\n'+"             ng-style=\"{ 'background-image': 'url(' + reco.cover_url + ')' }\"></div>\n    </div>\n  </div>\n</div>\n")}]),angular.module("../directives/scroller/scroller.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/scroller/scroller.tpl.html",'<div class="scroll-content" ng-transclude></div>\n<div class="knob"></div>')}]),angular.module("../directives/search-input/search-input.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/search-input/search-input.tpl.html",'<div class="tw-search-input">\n  <div class="search-input-container">\n    <svg class="icon icon-search">\n      <use ng-attr-xlink:href="{{ \'assets/common/icons.svg#icon-\' + iconName }}" xlink:href="" />\n    </svg>\n    <input type="text" role="input" tabindex="0"\n           autocorrect="off"\n           autocapitalize="off"\n           autocomplete="off"\n           spellcheck="false"\n           ng-model="options.searchTerm"\n           ng-focus="onInputFocus()"\n           ng-blur="onInputBlur()"\n           ng-keypress="onInputKey($event)"\n           ng-change="onInputChange()">\n    </input>\n    <span class="search-placeholder" ng-show="!options.searchTerm" ng-bind="options.placeHolderText"></span>\n    <svg class="icon clear-search" ng-show="options.searchTerm" ng-click="clearSearchTerm()">\n      <use xlink:href="assets/common/icons.svg#icon-close-small"/>\n    </svg>\n  </div>\n  <div class="search-history" ng-show="showSearchHistory" ng-click="onSearchHistoryClick($event)">\n    <div ng-repeat="item in searchHistory">\n      <svg class="icon icon-history"><use xlink:href="assets/common/icons.svg#icon-clock"/></svg>\n      <span ng-bind="item"></span>\n      <svg class="icon icon-delete" ng-click="removeHistoryItem($event, item)"><use xlink:href="assets/common/icons.svg#icon-delete"/></svg>\n    </div>\n  </div>\n</div>')}]),angular.module("../directives/select-list/select-list.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/select-list/select-list.tpl.html",'<div class="select-list-trigger"\n     ng-click="showSelectList($event)"\n     title="{{ triggerIconTooltip | translate }}"\n     data-test="directive-selectList-trigger">\n  <svg class="icon">\n    <use ng-attr-xlink:href="{{ triggerIconUrl }}" xlink:href="" />\n  </svg>\n</div>\n<div class="select-list-modal"\n     ng-if="visible == true"\n     ng-click="hideSelectList()">\n</div>\n<div class="select-list-content"\n     ng-if="visible == true"\n     ng-class="{ \'invisible\': positionNeedsToBeCalculated }"\n     ng-transclude></div>')}]),angular.module("../directives/selection-checkbox/selection-checkbox.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/selection-checkbox/selection-checkbox.tpl.html",'<div class="selection-checkbox" ng-class="{ checked: options.isChecked }" ng-click="onCheckBoxClick($event)">\n  <svg class="icon centered" ng-show="options.isChecked">\n    <use xlink:href="assets/common/icons.svg#icon-checkmark"></use>\n  </svg>\n</div>\n<span class="label">{{ options.label | translate }}</span>\n')}]),angular.module("../directives/selection-header-bar/selection-header-bar.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/selection-header-bar/selection-header-bar.tpl.html",'<svg ng-click="cancelAction()"><use xlink:href="assets/common/icons.svg#icon-back" /></svg>\n<span class="title">{{ selectionTitle | translate }}</span>\n<span class="action" ng-click="confirmAction()"><span>{{ buttonLabel | translate }}</span> ({{amount}})</span>\n<span class="action" ng-click="cancelAction()" translate>COMMON_ABORT</span>')}]),angular.module("../directives/sidebar-menu/sidebar-menu.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/sidebar-menu/sidebar-menu.tpl.html",'<div class="sidebar-container-helper">\n  <div class="sidebar-menu-header" title="{{ \'TOOLTIP_COMPONENT_HEADERBAR_HIDEMENU\' | translate }}">\n    <div ng-click="requestSidebarMenuToHide()">\n      <svg class="icon">\n        <use xlink:href="assets/common/icons.svg#icon-back" />\n      </svg>\n    </div>\n    <div class="sidebar-menu-logo">\n      <img ng-src="assets/logos/logo-{{ resellerLogoName }}.png" \n           alt="Company Logo" />\n    </div>\n  </div>\n  <div class="sidebar-menu-login" ng-class="{ \'logged-in\': userIsLoggedIn }">\n    <button ng-if="!userIsLoggedIn" class="raised" translate ng-click="login()">COMMON_LOGIN</button>\n    <span ng-if="userIsLoggedIn" translate translate-values="{{ translationData }}">\n      ACCOUNT_YOU_ARE_LOGGED_IN_SHORT\n    </span>\n  </div>\n  <div ng-repeat="group in items track by $index"\n       class="sidebar-menu-group">\n    <div ng-repeat="item in group">\n      <div ng-if="item.children.length == 1">\n        <div ng-click="handleItemClick(child)"\n             ng-repeat="child in item.children"\n             class="sidebar-menu-group-item"\n             ng-class="{ \'active\': currentActiveSidebarMenuItem == child.state }">\n          <div ng-if="item.symbol" \n               class="sidebar-menu-group-item-symbol" \n               title="{{ item.tooltip | translate }}">\n            <svg class="icon">\n              <use ng-attr-xlink:href="{{ trustIconUrl(\'assets/common/icons.svg#icon-\' + item.symbol) }}" xlink:href="" />\n            </svg>\n          </div>\n          <div ng-class="{ \'without-symbol\': !item.symbol }" \n               class="sidebar-menu-group-item-text" translate="{{ child.title }}">\n          </div>\n        </div>\n      </div>\n      <div ng-if="item.children.length != 1"\n           ng-click="handleItemClick(item)"\n           class="sidebar-menu-group-item"\n           ng-class="{ \'active\': currentActiveSidebarMenuItem == item.state }">\n        <div ng-if="item.symbol" \n             class="sidebar-menu-group-item-symbol" \n             title="{{ item.tooltip | translate }}">\n          <svg class="icon">\n            <use ng-attr-xlink:href="{{ trustIconUrl(\'assets/common/icons.svg#icon-\' + item.symbol) }}" xlink:href="" />\n          </svg>\n        </div>\n        <div ng-class="{ \'without-symbol\': !item.symbol }"\n             title="{{ item.tooltip | translate }}"\n             class="sidebar-menu-group-item-text" translate="{{ item.title }}">\n        </div>\n        <div ng-if="item.children.length > 0"\n             class="sidebar-menu-group-item-collapse-trigger">\n          <svg class="icon">\n            <use ng-attr-xlink:href="{{ trustIconUrl(\'assets/common/icons.svg#icon-arrow-\' + (visibleChildGroups.indexOf(item.title) > -1  ? \'up\' : \'down\')) }}" xlink:href=""/>\n          </svg>\n        </div>\n      </div>\n      <div ng-if="item.children.length > 1 && visibleChildGroups.indexOf(item.title) > -1"> \n        <div ng-click="handleItemClick(child)"\n             ng-repeat="child in item.children"\n             class="sidebar-menu-group-item"\n             ng-class="{ \'active\': currentActiveSidebarMenuItem == child.state }">\n          <div class="sidebar-menu-group-item-text child-item" translate="{{ child.title }}">\n          </div>\n        </div>\n      </div>\n    </div>\n  </div>\n</div>\n<div class="sidebar-menu-version-info">{{ versionInfo }}</div>')}]),angular.module("../directives/slider/slider.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/slider/slider.tpl.html",'<div class="tw-slider-container">\n  <span data-name="fullBar"  class="bar"></span>\n  <span data-name="progress" class="bar progress"></span>\n  <span data-name="loaded"   class="bar progress loaded" ng-show="!!twSliderLoaded"></span>\n  <span data-name="handle"   class="pointer" ng-hide="twSliderHidePointer"></span>\n  <span data-name="lblValue" class="bubble"></span>\n</div>\n')}]),angular.module("../directives/tab-bar/tab-bar.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/tab-bar/tab-bar.tpl.html",'<div class="tab-bar-tabs">\n  <div class="tab-bar-tab" \n       ng-repeat="tab in tabsConfig"\n       ui-sref="{{ tab.id }}"\n       ui-sref-active="selected">\n    <span ng-bind="tab.cbTitle ? tab.cbTitle() : (tab.title | translate)"></span>\n  </div>\n</div>\n<div class="tab-bar-tab-content" ng-transclude></div>')}]),angular.module("../directives/text-note/text-note.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/text-note/text-note.tpl.html",'<div class="tw-text-note">\n  <div class="note-dialog">\n    <svg class="icon note-close" ng-click="cancel()">\n      <use xlink:href="assets/common/icons.svg#icon-close-small" />\n    </svg>\n\n    <div class="note-title">{{ titleText }}</div>\n    <textarea class="text-note" tabindex="1" rows="8" cols="60" \n              ng-attr-placeholder="{{ \'TEXT_NOTE_WRITE\' | translate }}" \n              spellcheck="false">\n    </textarea>\n\n    <div class="note-buttons">\n      <button ng-click="deleteNote()" translate>COMMON_DELETE</button>\n      <button ng-click="commitNote()" class="button-default" translate>COMMON_OK</button>\n    </div>\n\n  </div>\n</div>\n')}]),angular.module("../directives/toggle-button/toggle-button.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/toggle-button/toggle-button.tpl.html",'<div ng-switch on="layout">\n  <div ng-switch-default title="{{ iconTooltip }}">\n    <svg class="icon toggle-button"\n         ng-click="toggleState()">\n      <use ng-attr-xlink:href="{{ iconUrl }}" xlink:href="" />\n    </svg>\n  </div>\n  <div ng-switch-when="sideleft" class="toggle-button-left">\n    <span>{{ iconTooltip }}</span>\n    <svg class="icon toggle-button"\n         ng-click="toggleState()">\n      <use ng-attr-xlink:href="{{ iconUrl }}" xlink:href="" />\n    </svg>\n  </div>\n  <div ng-switch-when="sideright" class="toggle-button-right">\n    <svg class="icon toggle-button"\n         ng-click="toggleState()">\n      <use ng-attr-xlink:href="{{ iconUrl }}" xlink:href="" />\n    </svg>\n    <span>{{ iconTooltip }}</span>\n  </div>\n  <div ng-switch-when="noicon" class="toggle-button-noicon"\n       ng-click="toggleState()"\n       title="{{ iconTooltip }}">\n    <span>{{ iconTooltip }}</span>\n  </div>\n</div>')}]),angular.module("../directives/toggle-switch/toggle-switch.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/toggle-switch/toggle-switch.tpl.html",'<div class="toggle-switch"\n     ng-class="{ on: toggleState }"\n     ng-click="toggleSwitchClick()">\n  <div class="overflow-wrapper">\n    <div class="slider"></div>\n    <div class="knob"></div>\n  </div>\n</div>')}]),angular.module("../directives/tree-view/tree-node.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/tree-view/tree-node.tpl.html",'<div class="treenode" ng-show="node.isVisible" role="treeitem">\n  <div class="treenode-content">\n    <span class="btn-expand"\n          ng-click="toggleExpand(node)"\n          data-test="component-treeview-toggleExpand-{{node.label}}"></span>\n    <span class="node-icon">{{:: node.iconSymbol}}</span>\n    <span class="node-label"\n          ng-click="onNodeClick(node)"\n          data-test="component-treeview-node-{{node.label}}">{{node.label}}</span>\n  </div>\n</div>\n')}]),angular.module("../directives/upload-dialog/upload-dialog.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/upload-dialog/upload-dialog.tpl.html",'<tw-dialog show="uploadDialogOptions.isVisible"\n           options="::uploadDialogOptions"\n           dialog-title="{{ \'DIALOG_RESULT_UPLOAD_TITLE\' | translate }}"\n           role="dialog">\n  <button ng-if="uploadDialogOptions.hasFailed"\n          class="primary"\n          ng-click="uploadDialogOptions.isVisible = false"\n          data-test="upload-dialog-btnOK"\n          translate>\n    COMMON_OK\n  </button>\n</tw-dialog>\n')}]),angular.module("../directives/upload-indicator/upload-indicator.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/upload-indicator/upload-indicator.tpl.html",'<div class="tw-upload-indicator" ng-show="show">\n  <div class="upload-spinner">\n    <svg class="spinner"><use xlink:href="assets/common/icons.svg#icon-sync" /></svg>\n  </div>\n  <div class="upload-content">\n    <div class="upload-headline"\n         translate\n         translate-values="{{ translationData }}">\n      LOADINGINDICATOR_PROCESS_COUNTER\n    </div>\n    {{ "LOADINGINDICATOR_IS_BEING_UPLOADED" | translate }}\n    <div class="upload-cancel"\n         ng-click="cancelAction()"\n         data-test="component-loadingIndicator-btnCancel">\n      <svg class="icon"><use xlink:href="assets/common/icons.svg#icon-close-small" /></svg>\n    </div>\n  </div>\n</div>\n')}]),angular.module("../directives/welcome-doodle/welcome-doodle.tpl.html",[]).run(["$templateCache",function(a){a.put("../directives/welcome-doodle/welcome-doodle.tpl.html",'<svg class="icon">\n  <use xlink:href="assets/common/icons.svg#icon-tolino-face" />\n</svg>\n<div translate>WELCOME_TITLE</div>\n<div class="subheader" translate>WELCOME_TEXT</div>')}]),angular.module("templates-app",["../states/account/account-theme.tpl.html","../states/account/account.tpl.html","../states/audio/audio-header-bar.tpl.html","../states/audio/audio-player.tpl.html","../states/audio/audio-playlist.tpl.html","../states/audio/audio.tpl.html","../states/comic/comic.tpl.html","../states/comic/partials/comic-header.tpl.html","../states/comic/partials/comic-pager.tpl.html","../states/comic/partials/comic-toc.tpl.html","../states/comic/partials/comic.tpl.html","../states/country/country-button-list.tpl.html","../states/country/country.tpl.html","../states/download/download.tpl.html","../states/epub/epub.tpl.html","../states/epub/partials/annotations.tpl.html","../states/epub/partials/font.tpl.html","../states/epub/partials/reader.tpl.html","../states/epub/partials/searchbar.tpl.html","../states/epub/partials/sharing.tpl.html","../states/epub/partials/textToSpeech.tpl.html","../states/epub/partials/toc.tpl.html","../states/epub/partials/toolbar.tpl.html","../states/help/help.tpl.html","../states/home/home-cover-flow.tpl.html","../states/home/home.tpl.html","../states/mybooks/authors/authors-list-view.tpl.html","../states/mybooks/authors/authors.tpl.html","../states/mybooks/authors/titles/author-title-view.tpl.html","../states/mybooks/authors/titles/titles.tpl.html","../states/mybooks/collections/collection-view.tpl.html","../states/mybooks/collections/collections.tpl.html","../states/mybooks/collections/selection/collections-selection-view.tpl.html","../states/mybooks/collections/selection/collections-selection.tpl.html","../states/mybooks/collections/titles/collections-title-view.tpl.html","../states/mybooks/collections/titles/titles.tpl.html","../states/mybooks/default.tpl.html","../states/mybooks/details/details-arrows.tpl.html","../states/mybooks/details/details.tpl.html","../states/mybooks/mybooks-tab-bar.tpl.html","../states/mybooks/mybooks.tpl.html","../states/mybooks/selection/selection-view.tpl.html","../states/mybooks/selection/selection.tpl.html","../states/mybooks/titles/titles-view.tpl.html","../states/mybooks/titles/titles.tpl.html","../states/pdf/partials/annotations.tpl.html","../states/pdf/partials/dogear-list-item.tpl.html","../states/pdf/partials/dogear.tpl.html","../states/pdf/partials/footer.tpl.html","../states/pdf/partials/navigation.tpl.html","../states/pdf/partials/pager.tpl.html","../states/pdf/partials/reader.tpl.html","../states/pdf/partials/toolbar.tpl.html","../states/pdf/pdf.tpl.html","../states/read/read.tpl.html","../states/reseller/reseller-button-list.tpl.html","../states/reseller/reseller-header.tpl.html","../states/reseller/reseller.tpl.html","../states/search/audio/audio-view.tpl.html","../states/search/audio/audio.tpl.html","../states/search/books/books-view.tpl.html","../states/search/books/books.tpl.html","../states/search/search-header-bar.tpl.html","../states/search/search.tpl.html","../states/sorry/sorry.tpl.html"]),angular.module("../states/account/account-theme.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/account/account-theme.tpl.html",'<div class="account-theme-label" translate>COMMON_THEME</div>\n<div class="account-theme-container">\n  <tw-dropdown-list list-items="themes" selected-item="selectedTheme"></tw-dropdown-list>\n</div>\n<div class="account-theme-label" translate>COMMON_THEME_VARIANT</div>\n<div class="account-theme-container">\n  <tw-dropdown-list list-items="variants" selected-item="selectedThemeVariant"></tw-dropdown-list>\n</div>\n<div class="account-theme-label" translate>COMMON_UI_FONTS</div>\n<div class="account-theme-container">\n  <tw-dropdown-list list-items="uifonts" selected-item="selectedUIFont"></tw-dropdown-list>\n</div>\n')}]),angular.module("../states/account/account.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/account/account.tpl.html",'<div class="container-inner">\n  <tw-account-modal></tw-account-modal>\n  <tw-account-sidebar-menu></tw-account-sidebar-menu>\n  <tw-account-header-bar></tw-account-header-bar>\n  <div class="state-account">\n    <tw-scroller>\n      <tw-account-status-box></tw-account-status-box>\n      <tw-account-options></tw-account-options>\n      <tw-account-language></tw-account-language>\n    </tw-scroller>\n  </div>\n</div>\n')}]),angular.module("../states/audio/audio-header-bar.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/audio/audio-header-bar.tpl.html",'<svg class="icon" ng-click="back()">\n  <use xlink:href="assets/common/icons.svg#icon-back" />\n</svg>\n<div class="header-bar-title">{{ audiobook.title }}</div>')}]),angular.module("../states/audio/audio-player.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/audio/audio-player.tpl.html",'<div class="audio-player-blur-container"\n     ng-style="{ \'background-image\': \'url(\' + playlist.coverimage + \')\' }">\n</div>\n<div class="audio-player-cover-container">\n  <img class="audio-player-cover" ng-src="{{ playlist.coverimage }}" />\n  <button ng-if="!platformPreventsPlayback"\n          class="raised audio-player-button-control"\n          ng-disabled="!playlist.readyToPlay"\n          ng-hide="audio.playing"\n          ng-click="play()"\n          title="{{ \'TOOLTIP_COMPONENT_AUDIOPLAYER_PLAY\' | translate }}"\n          data-test="component-audioplayer-btnPlay">\n    <svg class="icon"><use xlink:href="assets/common/icons.svg#icon-play" /></svg>\n  </button>\n  <button ng-if="!platformPreventsPlayback"\n          class="raised audio-player-button-control"\n          ng-show="audio.playing"\n          ng-click="pause()"\n          title="{{ \'TOOLTIP_COMPONENT_AUDIOPLAYER_PAUSE\' | translate }}"\n          data-test="component-audioplayer-btnPause">\n    <svg class="icon"><use xlink:href="assets/common/icons.svg#icon-pause" /></svg>\n  </button>\n  <button ng-if="platformPreventsPlayback"\n          class="raised audio-player-button-control"\n          ng-click="openAudioNotSupportedDialog()"\n          data-test="component-audioplayer-btnCantPlay">\n    <svg class="icon">\n      <use xlink:href="assets/common/icons.svg#icon-exclam-solid" />\n    </svg>\n  </button>\n</div>\n<div class="audio-player-meta-container">\n  <div class="audio-player-meta-title">{{ playlist.deliverable.title }}</div>\n  <div class="audio-player-meta-author">{{ playlist.publication.author }}</div>\n  <div class="audio-player-meta-description"\n       ng-bind-html="description">\n  </div>\n  <div ng-show="playlist.deliverable.tracks"\n       class="audio-player-meta-tracks"\n       title="{{ \'TOOLTIP_COMPONENT_AUDIOPLAYER_TRACKCOUNT\' | translate }}">\n    {{ playlist.deliverable.tracks }} <span translate>AUDIOBOOK_TRACKCOUNT</span>\n  </div>\n  <div class="audio-player-meta-duration">\n    {{ (playlist.deliverable.duration * 1000) | utc | date :\'HH:mm:ss\' }}\n  </div>\n</div>')}]),angular.module("../states/audio/audio-playlist.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/audio/audio-playlist.tpl.html",'<tw-scroller ng-show="playlist.tracks" class="audio-playlist">\n  <div class="audio-playlist-item"\n       ng-repeat="track in playlist.tracks"\n       ng-click="platformPreventsPlayback ? openAudioNotSupportedDialog() : playlist.selectTrack($index)"\n       ng-style="{\'pointer-events\' : pointerEvents }"\n       ng-class="{\n         \'current-track\': !playlist.trackChange && $index === playlist.currentTrack.index,\n         \'selected-track\': playlist.trackChange && $index === playlist.selectedTrack.index\n       }">\n    <div class="audio-playlist-item-trackno">\n      {{ track.index + 1 }}.&nbsp;\n    </div>\n    <div class="audio-playlist-item-title">\n      <div class="trackprogress"\n           ng-style="{ \'width\': track.downloadPercent + \'%\' }">\n      </div>\n      <span ng-if="!track.title && !($index === playlist.selectedTrack.index && playlist.trackChange)">\n        <span translate>AUDIOBOOK_TRACKTITLE_DEFAULT</span>\n      </span>\n      <span ng-if="track.title && !($index === playlist.selectedTrack.index && playlist.trackChange)">\n        {{ track.title }}\n      </span>\n      <div ng-if="$index === playlist.selectedTrack.index && playlist.trackChange">\n        <span translate>AUDIOBOOK_TRACK_LOADING</span>\n        <tw-inline-loading-indicator/>\n      </div>\n    </div>\n    <div class="audio-playlist-item-time">\n      <span class="audio-playlist-item-badge-lastheard"\n            ng-show="$index === playlist.currentTrack.index && !playlist.trackChange"\n            title="{{ \'TOOLTIP_COMPONENT_AUDIOPLAYER_LASTHEARD\' | translate }}">\n        <svg class="icon">\n          <use xlink:href="assets/common/icons.svg#icon-bookmark-solid" />\n        </svg>\n      </span>\n      <span ng-if="audio.currentTimeMS"\n            ng-show="$index === playlist.currentTrack.index && !playlist.trackChange"\n            title="{{ \'TOOLTIP_COMPONENT_AUDIOPLAYER_TIMEPLAYED\' | translate }}">\n            {{ audio.currentTimeMS | utc | date : \'mm:ss\' }}\n      </span>\n      <span ng-show="$index === playlist.currentTrack.index && !playlist.trackChange && track.duration>0 && (track.duration<Infinity)">/</span>\n      <span ng-if="track.duration"\n            ng-show="track.duration > 0 && (track.duration < Infinity)"\n            title="{{ \'TOOLTIP_COMPONENT_AUDIOPLAYER_LENGTHOFTRACK\' | translate }}">\n            {{ track.duration | utc | date : \'mm:ss\' }}\n          </span>\n    </div>\n  </div>\n</tw-scroller>\n\n\n\n\n  <!--div class="playlist" ng-show="playlist.tracks">\n  <table>\n    <tbody>\n    <tr ng-class="{\n                    \'currenttrack\' : !playlist.trackChange && $index === playlist.currentTrack.index,\n                    \'selectedtrack\': playlist.trackChange && $index === playlist.selectedTrack.index\n                }"\n        ng-click="platformPreventsPlayback ? openAudioNotSupportedDialog() : playlist.selectTrack($index)"\n        ng-repeat="track in playlist.tracks">\n\n    <td class="column-trackno">{{track.index+1}}.</td>\n    <td class="column-title">\n        <div class="trackprogress"\n            ng-style="{\'width\':track.downloadPercent+\'%\'}"></div>\n        <span ng-if="!track.title && !($index===playlist.selectedTrack.index && playlist.trackChange)"><span\n        translate>AUDIOBOOK_TRACKTITLE_DEFAULT</span></span>\n        <span ng-if="track.title && !($index===playlist.selectedTrack.index && playlist.trackChange)">{{track.title}}</span>\n\n        <div ng-if="$index===playlist.selectedTrack.index && playlist.trackChange">\n        <span translate>AUDIOBOOK_TRACK_LOADING</span>\n        <tw-inline-loading-indicator/>\n        </div>\n\n    </td>\n    <td class="column-time">\n        <span ng-if="audio.currentTimeMS" ng-show="$index === playlist.currentTrack.index && !playlist.trackChange"\n            title="{{ \'TOOLTIP_COMPONENT_AUDIOPLAYER_TIMEPLAYED\' | translate }}">{{audio.currentTimeMS | utc | date : \'mm:ss\'}}</span>\n        <span ng-show="$index === playlist.currentTrack.index && !playlist.trackChange && track.duration>0 && (track.duration<Infinity)">/</span>\n        <span ng-if="track.duration" ng-show="track.duration>0 && (track.duration<Infinity)"\n            title="{{ \'TOOLTIP_COMPONENT_AUDIOPLAYER_LENGTHOFTRACK\' | translate }}">{{track.duration | utc | date : \'mm:ss\'}}</span>\n        <span ng-show="$index === playlist.currentTrack.index && !playlist.trackChange"\n            class="badge-lastheard"\n            title="{{ \'TOOLTIP_COMPONENT_AUDIOPLAYER_LASTHEARD\' | translate }}">\n        <svg class="icon"><use xlink:href="assets/common/icons.svg#icon-bookmark-solid" /></svg>\n        </span>\n    </td>\n    </tr>\n    </tbody>\n  </table>\n</div-->');
}]),angular.module("../states/audio/audio.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/audio/audio.tpl.html","<tw-audio-header-bar></tw-audio-header-bar>\n<tw-audio-player></tw-audio-player>\n<tw-audio-playlist></tw-audio-playlis>")}]),angular.module("../states/comic/comic.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/comic/comic.tpl.html","<tw-comic></tw-comic>")}]),angular.module("../states/comic/partials/comic-header.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/comic/partials/comic-header.tpl.html",'<div class="tw-header-bar" ng-class="{ \'visible\': isVisible == true }">\n  <div class="header-bar-left">\n    <span ng-click="close()" title="{{ sidebarMenuToggleTranslation | translate }}" class="icon-container">\n      <svg class="icon"><use xlink:href="assets/common/icons.svg#icon-back" /></svg>\n    </span>\n    <div class="header-bar-title">\n      <span translate>READER_CLOSE_TITLE</span>\n    </div>\n  </div>\n</div>\n')}]),angular.module("../states/comic/partials/comic-pager.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/comic/partials/comic-pager.tpl.html","")}]),angular.module("../states/comic/partials/comic-toc.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/comic/partials/comic-toc.tpl.html",'<div class="comic-toc-toggle">\n  <svg class="icon">\n    <use xlink:href="assets/common/icons.svg#icon-arrow-up" />\n  </svg>\n</div>\n<div class="comic-toc"></div>\n')}]),angular.module("../states/comic/partials/comic.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/comic/partials/comic.tpl.html","<tw-comic-header></tw-comic-header>\n<tw-comic-pager></tw-comic-pager>\n<tw-comic-toc></tw-comic-toc>\n")}]),angular.module("../states/country/country-button-list.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/country/country-button-list.tpl.html",'<div ng-click="setCountry(countryObject)"\n     ng-repeat="countryObject in service.getCountries()">\n  <tw-country-label-button label="{{ countryObject.country }}"></tw-country-label-button>\n</div>')}]),angular.module("../states/country/country.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/country/country.tpl.html",'<!-- CONTENT [start] -->\n<div class="country-container" tw-country-state-watcher>\n  <div class="country-header">\n    <img src="assets/logos/logo-tolinode.png" alt="tolino WebReader" />\n  </div>\n  <div class="country-content">\n    <div class="country-content-illustration">\n      <img src="assets/common/webreader-illustration-3.svg" alt="" />\n    </div>\n    <div class="country-content-list-container">\n      <div class="country-content-list">\n        <div translate>WELCOME_TEXT</div>\n        <tw-country-button-list></tw-country-button-list>\n      </div>\n    </div>\n  </div>\n  <tw-activity-indicator id="country"></tw-activity-indicator>\n</div>\n<!-- CONTENT [end] -->  ')}]),angular.module("../states/download/download.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/download/download.tpl.html",'<tw-activity-indicator id="download"></tw-activity-indicator>\n<tw-download-state-watcher></tw-download-state-watcher>\n')}]),angular.module("../states/epub/epub.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/epub/epub.tpl.html","<tw-epub></tw-epub>")}]),angular.module("../states/epub/partials/annotations.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/epub/partials/annotations.tpl.html",'<!-- ANNOTATIONS [start] -->\n<div ng-controller="ToolbarAnnotationsCtrl"\n     show-if="isToolbarVisible"\n     class="toolbar-panel toolbar-annotation scrollable">\n\n  <div class="toolbar-panel-bookmarks" ng-controller="BookmarkController">\n    <div class="toolbar-content">\n      <tw-annotation-list-item ng-repeat="item in annotations track by (item.id + item.transientId)" model="item"></tw-annotation-list-item>\n      <tw-empty-list ng-if="annotations && annotations.length === 0"\n        icon-name="empty-list-annotations" \n        headline="{{ \'NO_ANNOTATIONS_SET\' | translate }}" \n        text="{{ \'NO_ANNOTATIONS_SET_2\' | translate }}">\n      </tw-empty-list>\n    </div>\n  </div>\n</div>\n<!-- ANNOTATIONS [end] -->\n')}]),angular.module("../states/epub/partials/font.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/epub/partials/font.tpl.html",'<!-- FONT SETTINGS [start] -->\n<div class="toolbar-panel font-settings"\n     ng-controller="FontSettingsCtrl"\n     show-if="isToolbarVisible"\n     role="menu">\n  \n  <!-- FONT SETTINGS - FONT FAMILY -->\n  <div class="settings-item font-family">\n    <div class="title" translate>FONT_SETTINGS_FONT_FAMILY</div>\n    <div class="current-font-family"\n         data-test="component-epubreader-toolbar-font-current-font-family">\n         {{ fontFamilies.list[fontFamilies.selectedIndex].name | translate }}\n    </div>\n    <div ng-click="openFontList()"\n         class="btn-open-font-list"\n         title="{{ \'CHOOSE_FONT_FAMILY\' | translate }}"\n         tabindex="0"\n         role="button"\n         data-test="component-epubreader-toolbar-open-font-menu">\n      <svg class="icon"><use xlink:href="assets/common/icons.svg#icon-arrow-right" /></svg>\n    </div>\n  </div>\n  <font-select-list show-if="fontFamilies.isVisible" options="fontFamilies" delete-list-item="deleteFontFamily"></font-select-list>\n  \n  <!-- FONT SETTINGS - FONT SIZE -->\n  <div class="settings-item font-size">\n    <svg class="icon" ng-click="changeFontSize(-2)"\n         tabindex="0" role="button">\n      <use xlink:href="assets/common/icons.svg#icon-font-A" />\n    </svg>\n    <twslider id="slider-font-size"\n              tw-slider-model="fontSizeIndex"\n              tw-slider-floor="minFontSize"\n              tw-slider-ceil="maxFontSize"\n              tw-slider-precision="0"\n              tw-slider-orientation="horizontal"\n              role="slider"\n              aria-valuenow="{{fontSizeIndex}}"\n              aria-valuemin="{{minFontSize}}"\n              aria-valuemax="{{maxFontSize}}">\n    </twslider>\n    <svg class="icon" ng-click="changeFontSize(2)"\n         tabindex="0" role="button">\n      <use xlink:href="assets/common/icons.svg#icon-font-A" />\n    </svg>\n  </div>\n  \n  <!-- FONT SETTINGS - LINE HEIGHT -->\n  <div class="settings-item">\n    <div class="title" translate>FONT_SETTINGS_LINE_HEIGHT</div>\n    <div class="button-group">\n      <div ng-click="applyFontSettings(\'lineHeight\',\'narrow\')"\n           ng-class="{ selected: fontSettings.lineHeight == \'narrow\' }"\n           title="{{ \'TOOLTIP_COMPONENT_EPUB_LINEHEIGHT_NARROW\' | translate }}"\n           tabindex="0"\n           role="button"\n           data-test="component-epubreader-toolbar-font-btnSetLineHeight_narrow">\n        <svg class="icon"><use xlink:href="assets/common/icons.svg#icon-line-spacing-min" /></svg>\n      </div>\n      \n      <div ng-click="applyFontSettings(\'lineHeight\',\'normal\')"\n           ng-class="{ selected: fontSettings.lineHeight == \'normal\' }"\n           title="{{ \'TOOLTIP_COMPONENT_EPUB_LINEHEIGHT_NORMAL\' | translate }}"\n           tabindex="0"\n           role="button"\n           data-test="component-epubreader-toolbar-font-btnSetLineHeight_normal">\n        <svg class="icon"><use xlink:href="assets/common/icons.svg#icon-line-spacing-medium" /></svg>\n      </div>\n      \n      <div ng-click="applyFontSettings(\'lineHeight\',\'wide\')"\n           ng-class="{ selected: fontSettings.lineHeight == \'wide\' }"\n           title="{{ \'TOOLTIP_COMPONENT_EPUB_LINEHEIGHT_WIDE\' | translate }}"\n           tabindex="0"\n           role="button"\n           data-test="component-epubreader-toolbar-font-btnSetLineHeight_wide">\n        <svg class="icon"><use xlink:href="assets/common/icons.svg#icon-line-spacing-max" /></svg>\n      </div>\n    </div>\n  </div>\n  \n  <!-- FONT SETTINGS - TEXT ALIGNMENT -->\n  <div class="settings-item">\n    <div class="title" translate>FONT_SETTINGS_TEXT_ALIGN</div>\n    <div class="button-group">\n      <div ng-click="applyFontSettings(\'textAlign\',\'left\')"\n           ng-class="{ selected: fontSettings.textAlign == \'left\' }"\n           title="{{ \'TOOLTIP_COMPONENT_EPUB_TEXTALIGN_LEFT\' | translate }}"\n           tabindex="0"\n           role="button"\n           data-test="component-epubreader-toolbar-font-btnSetTextAlign_left">\n        <svg class="icon"><use xlink:href="assets/common/icons.svg#icon-align-left" /></svg>\n      </div>\n      \n      <div ng-click="applyFontSettings(\'textAlign\',\'justify\')"\n           ng-class="{ selected: fontSettings.textAlign == \'justify\' }"\n           title="{{ \'TOOLTIP_COMPONENT_EPUB_TEXTALIGN_JUSTIFY\' | translate }}"\n           tabindex="0"\n           role="button"\n           data-test="component-epubreader-toolbar-font-btnSetTextAlign_justify">\n        <svg class="icon"><use xlink:href="assets/common/icons.svg#icon-align-block" /></svg>\n      </div>\n      \n      <div ng-click="applyFontSettings(\'textAlign\',\'center\')"\n           ng-class="{ selected: fontSettings.textAlign == \'center\' }"\n           title="{{ \'TOOLTIP_COMPONENT_EPUB_TEXTALIGN_CENTER\' | translate }}"\n           tabindex="0"\n           role="button"\n           data-test="component-epubreader-toolbar-font-btnSetTextAlign_center">\n        <svg class="icon"><use xlink:href="assets/common/icons.svg#icon-align-center" /></svg>\n      </div>\n    </div>\n  </div>\n  \n  <!-- FONT SETTINGS - READING MODE -->\n  <div class="settings-item">\n    <div class="title" translate>FONT_SETTINGS_READING_MODE</div>\n    <div class="button-group flex-container">\n      <div ng-click="applyFontSettings(\'readingMode\',\'paged\')"\n           ng-class="{ selected: fontSettings.readingMode == \'paged\' }"\n           title="{{ \'TOOLTIP_COMPONENT_EPUB_READINGMODE_PAGED\' | translate }}"\n           tabindex="0"\n           role="button"\n           data-test="component-epubreader-toolbar-font-btnSetReadingMode_paged">\n        <svg class="icon"><use xlink:href="assets/common/icons.svg#icon-pageturn" /></svg>\n      </div>\n      \n      <div ng-click="applyFontSettings(\'readingMode\',\'scroll\')"\n           ng-class="{ selected: fontSettings.readingMode == \'scroll\' }"\n           title="{{ \'TOOLTIP_COMPONENT_EPUB_READINGMODE_SCROLL\' | translate }}"\n           tabindex="0"\n           role="button"\n           data-test="component-epubreader-toolbar-font-btnSetReadingMode_scroll">\n        <svg class="icon"><use xlink:href="assets/common/icons.svg#icon-scroll" /></svg>\n      </div>\n      \n      <div class="layout-dummy"></div>\n    </div>\n  </div>\n\n  <!-- FONT SETTINGS - BACKGROUND MODE -->\n  <div class="settings-item background-mode">\n    <div ng-click="applyFontSettings(\'backgroundMode\',\'bgwhite\')"\n         ng-class="{ selected: fontSettings.backgroundMode == \'bgwhite\' }"\n         class="bg-white"\n         title="{{ \'TOOLTIP_COMPONENT_EPUB_BGMODE_WHITE\' | translate }}"\n         tabindex="0"\n         role="button"\n         data-test="component-epubreader-toolbar-font-btnSetBackgroundMode_bgwhite">\n      <svg class="icon"><use xlink:href="assets/common/icons.svg#icon-font-A" /></svg>\n      <!-- <span translate>FONT_SETTINGS_BACKGROUND_MODE_WHITE</span> -->\n    </div>\n    \n    <div ng-click="applyFontSettings(\'backgroundMode\',\'bgsepia\')"\n         ng-class="{ selected: fontSettings.backgroundMode == \'bgsepia\' }"\n         class="bg-sepia"\n         title="{{ \'TOOLTIP_COMPONENT_EPUB_BGMODE_SEPIA\' | translate }}"\n         tabindex="0"\n         role="button"\n         data-test="component-epubreader-toolbar-font-btnSetBackgroundMode_bgsepia">\n      <svg class="icon"><use xlink:href="assets/common/icons.svg#icon-font-A" /></svg>\n      <!-- <span translate>FONT_SETTINGS_BACKGROUND_MODE_SEPIA</span> -->\n    </div>\n    \n    <div ng-click="applyFontSettings(\'backgroundMode\',\'bgblack\')"\n         ng-class="{ selected: fontSettings.backgroundMode == \'bgblack\' }"\n         class="bg-black"\n         title="{{ \'TOOLTIP_COMPONENT_EPUB_BGMODE_BLACK\' | translate }}"\n         tabindex="0"\n         role="button"\n         data-test="component-epubreader-toolbar-font-btnSetBackgroundMode_bgblack">\n      <svg class="icon"><use xlink:href="assets/common/icons.svg#icon-font-A" /></svg>\n      <!-- <span translate>FONT_SETTINGS_BACKGROUND_MODE_NIGHT</span> -->\n    </div>\n  </div>\n  \n  <!-- FONT SETTINGS - SET DEFAULT -->\n  <div class="settings-item">\n    <div class="title" translate>FONT_SETTINGS_SET_DEFAULT</div>\n    <tw-toggle-switch toggle-state="fontSettings.isDefault" tabindex="0" role="button"></tw-toggle-switch>\n  </div>\n</div>\n<!-- FONT SETTINGS [end] -->\n')}]),angular.module("../states/epub/partials/reader.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/epub/partials/reader.tpl.html",'<ng-include src="\'../states/epub/partials/toolbar.tpl.html\'"></ng-include>\n\n<div ng-if="::!isSampleReader"\n     class="simple-dogear"\n     ng-click="handleDogearAction()"\n     title="{{ \'TOOLTIP_COMPONENT_CONTEXTMENU_DOGEAR\' | translate }}"\n     tabindex="0"\n     role="button"\n     data-test="component-epubreader-btnDogear">\n  <svg class="icon">\n    <use xlink:href="assets/common/icons.svg#icon-bookmark2-solid"\n         style="pointer-events: none;" />\n  </svg>\n</div>\n\n<!-- CONTENT [start] -->\n<div class="row outer-content-container \n            {{ settings.backgroundMode }}\n            {{ settings.fontSizeID }}\n            {{ settings.viewport ? \'pre-paginated\' : \'reflowable\'}}"\n     ng-class="{ vertical: !isPagingEnabled }"\n     interaction-handler font-drop>\n  <!-- HEADER [start] -->\n  <div class="row reader-header">\n    <div class="title" ng-bind="publicationTitle"></div>\n  </div>\n  <!-- HEADER [end] -->\n\n  <!-- CONTROLS FOR MEDIA OVERLAYS -->\n  <!-- title="{{ \'TOOLTIP_COMPONENT_AUDIOPLAYER_PAUSE\' | translate }}" -->\n  <div ng-if="hasMediaOverlay" class="media-overlay-control" \n       ng-class="{ disabled: !isPlaybackEnabled }"\n       ng-click="toggleMediaOverlayPlayback($event)"\n       tabindex="0" role="button">\n       \n    <div ng-if="!isMediaPlaying" class="media-overlay-control-item" title="{{ \'READ_ALOUD_START\' | translate }}">\n      <svg class="icon centered"> <use xlink:href="assets/common/icons.svg#icon-play" /></svg>\n      <span class="label" translate>READ_ALOUD_START</span>\n    </div>\n    \n    <div ng-if="isMediaPlaying" class="media-overlay-control-item" title="{{ \'READ_ALOUD_PAUSE\' | translate }}">\n      <svg class="icon centered"> <use xlink:href="assets/common/icons.svg#icon-pause" /></svg>\n      <span class="label" translate>READ_ALOUD_PAUSE</span>\n    </div>\n  </div>\n  \n  <div class="tw-page-nav tw-page-nav-left"\n       ng-if="showPageNav && !isFirstPage"\n       ng-click="previousPage($event)">\n    <div class="icon-container centered">\n        <svg class="icon"> <use xlink:href="assets/common/icons.svg#icon-arrow-left" /></svg>\n    </div>\n  </div>\n  \n  <div id="tolino_webReader_container"\n       class="inner-content-container {{ settings.viewport ? \'pre-paginated\' : \'reflowable\'}}"\n       role="main" tabindex="0">\n    <epub-section ng-repeat="(id, data) in sectionData"\n                  section-id="{{ id }}"\n                  section-data="data"\n                  settings="settings">\n    </epub-section>\n  </div>\n  \n  <div class="tw-page-nav tw-page-nav-right"\n       ng-if="showPageNav && !isLastPage"\n       ng-click="nextPage($event)">\n    <div class="icon-container centered">\n      <svg class="icon"> <use xlink:href="assets/common/icons.svg#icon-arrow-right" /></svg>\n    </div>\n  </div>\n  \n  <!-- CHAPTER INFO + NAVIGATION [start] -->\n  <div show-if="isSliderVisible"\n       class="chapter-info \n             {{ settings.viewport ? \'pre-paginated\' : \'reflowable\'}}\n             {{ settings.isPagingEnabled ? \'multi-column\' : \'scroll\'}}">\n    <div ng-click="previousChapter()"\n         ng-disabled="isFirstChapter"\n         class="btn-prev-next"\n         title="{{ \'TOOLTIP_PREVIOUS_SECTION\' | translate }}"\n         tabindex="0"\n         role="button"\n         data-test="reader-btnPrevChapter">\n      <svg class="icon"><use xlink:href="assets/common/icons.svg#icon-prev" /></svg>\n    </div>\n    \n    <div class="section-label">\n      <span class="section-name" ng-bind="currentSectionLabel"></span>\n      <span class="page-numbers" ng-bind="pageNumberInfo"></span>\n    </div>\n    \n    <div ng-click="nextChapter()"\n         ng-disabled="isLastChapter"\n         class="btn-prev-next"\n         title="{{ \'TOOLTIP_NEXT_SECTION\' | translate }}"\n         tabindex="0"\n         role="button"\n         data-test="reader-btnNextChapter">\n      <svg class="icon"><use xlink:href="assets/common/icons.svg#icon-next" /></svg>\n    </div>\n  </div>\n  <!-- CHAPTER INFO + NAVIGATION [end] -->\n\n  <button ng-show="isSliderVisible && isPagingEnabled"\n       class="last-slider-position" \n       ng-click="toLastSliderPosition()"\n       ng-disabled="lastSliderPosition == null"\n       title="{{ \'TOOLTIP_COMPONENT_EPUB_LAST_SLIDER_POSITION\' | translate }}"\n       data-test="reader-btnLastSliderPosition">\n      <svg class="icon"><use xlink:href="assets/common/icons.svg#icon-arrow-left" /></svg>\n  </button>\n  \n  <twslider id="slider-page-nav"\n            show-if="isSliderVisible"\n            class="page-nav"\n            tw-slider-model="sliderProgress.value"\n            tw-slider-ceil="100"\n            tw-slider-orientation="{{ settings.isPagingEnabled ? \'horizontal\' : \'vertical\'}}"\n            title="{{ \'TOOLTIP_COMPONENT_EPUB_SLIDER\' | translate }}"\n            role="slider"\n            aria-valuenow="{{ sliderProgress.value.toFixed() }}"\n            aria-valuemin="0"\n            aria-valuemax="100">\n  </twslider>\n  \n  <tw-text-note show-if="textNote.isVisible" options="textNote" apply-note="applyNote"></tw-text-note>\n  \n  <tw-activity-indicator id="activity-reader"></tw-activity-indicator>\n  \n  <overlay show="overlayData.isVisible" overlay-id="overlayReader" options="overlayData">\n    <span ng-bind="overlayData.message"></span>\n  </overlay>\n\n  <tw-dialog show="searchInfoDialog.isVisible"\n           options="searchInfoDialog"\n           width="360px"\n           dialog-title="{{ \'DIALOG_INFO_TITLE\' | translate }}"\n           dialog-text="{{ \'DIALOG_SEARCH_LENGTH_INFO\' | translate }}"\n           role="dialog">\n    <button class="float-right"\n            ng-click="closeSearchInfoDialog()"\n            data-test="reader-searchInfoDialog-btnOK"\n            translate>\n      COMMON_OK\n    </button>\n  </tw-dialog>\n  \n  <tw-dialog show="externalLinks.isVisible"\n           class="dialog-external-link"\n           options="externalLinks"\n           width="360px"\n           dialog-title="{{ \'OPEN_EXTERNAL_LINK\' | translate }}"\n           dialog-text="{{ externalLinks.dialogText }}"\n           role="dialog">\n           \n    <div class="checkbox">\n      <input id="checkbox-ext-link" type="checkbox"\n             ng-model="externalLinks.grantedByUser"\n             ng-change="externalLinkCheckBoxChange()">\n      <label for="checkbox-ext-link" translate>DONT_SHOW_THIS_MESSAGE_AGAIN</label>\n    </div>\n    \n    <button class="float-left"\n            ng-click="externalLinkClose()"\n            data-test="reader-externalLinks-btnCancel"\n            translate>\n      COMMON_CANCEL\n    </button>\n    <button class="float-right"\n            ng-click="externalLinkOpen()"\n            data-test="reader-externalLinks-btnOpen"\n            translate>\n      OPEN_LINK\n    </button>\n  </tw-dialog>\n  \n  <tw-dialog show="cautionInfoDialog.isVisible"\n             options="::cautionInfoDialog"\n             width="360px"\n             dialog-title="{{ \'DIALOG_INFO_TITLE\' | translate }}"\n             dialog-text="{{ \'DIALOG_MULTIMEDIA_INFO\' | translate }}"\n             dialog-icon-text="exclam-solid"\n             role="dialog">\n    <button ng-click="closeCautionInfoDialog()"\n            data-test="reader-cautionInfoDialog-btnOK"\n            translate>\n      COMMON_OK\n    </button>\n  </tw-dialog>\n</div>\n<!-- CONTENT [end] -->\n')}]),angular.module("../states/epub/partials/searchbar.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/epub/partials/searchbar.tpl.html",'<!-- TOOLBAR - SEARCH [start] -->\n<div ng-controller="searchBarCtrl"\n     ng-keypress="onKeyPress($event)"\n     ng-show="isSearchBarVisible"\n     ng-class="{ \'height-extended\': noOfSearchResults >= 0 || searchInProgress }"\n     class="toolbar-search">\n  \n  <div class="icon-back"\n       ng-click="closeSearch()"\n       title="{{ \'TOOLTIP_COMPONENT_EPUB_FULLTEXTSEARCH_CLOSE\' | translate }}"\n       tabindex="0"\n       role="button">\n    <svg class="icon"><use xlink:href="assets/common/icons.svg#icon-back" /></svg>\n  </div>\n  \n  <div class="toolbar-content"\n       ng-class="{ \'search-active\': noOfSearchResults >= 0 || searchInProgress }">\n    \n    <div ng-if="isSearchNavigationVisible" class="search-navigation-container">\n      <div ng-if="noOfSearchResults > 0" class="search-results">\n        <div ng-click="previousResult()"\n             ng-disabled="currentSearchResultIndex === 0"\n             class="search-results-previous" \n             tabindex="0" \n             role="button"\n             data-test="component-epubreader-searchbar-btnPreviousSearchResult">\n          <svg class="icon"><use xlink:href="assets/common/icons.svg#icon-arrow-left" /></svg>\n        </div>\n        <div class="search-results-matches">\n          <span translate>FULLTEXT_SEARCH_MATCH</span>\n          &nbsp;\n          {{ currentSearchResultIndex + 1 }} / {{ noOfSearchResults }}\n        </div>\n        <div ng-click="nextResult()"\n             ng-disabled="currentSearchResultIndex === noOfSearchResults - 1"\n             class="search-results-next"\n             tabindex="0" \n             role="button"\n             data-test="component-epubreader-searchbar-btnNextSearchResult">\n          <svg class="icon"><use xlink:href="assets/common/icons.svg#icon-arrow-right" /></svg>\n        </div>\n      </div>\n      \n      <div ng-if="noOfSearchResults == 0" class="search-no-results" translate>\n        FULLTEXT_SEARCH_NO_MATCHES\n      </div>\n      \n      <div ng-if="searchInProgress" class="search-searching" translate>\n        FULLTEXT_SEARCH_SEARCHING\n      </div>\n    </div>\n    \n    <tw-search-input options="searchInput"></tw-search-input>\n  </div>\n\n</div>\n<!-- TOOLBAR - SEARCH [end] -->\n')}]),angular.module("../states/epub/partials/sharing.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/epub/partials/sharing.tpl.html",'<!DOCTYPE html>\n<div ng-controller="ToolbarSharingCtrl"\n     class="toolbar-sharing"\n     ng-show="isSharingToolbarVisible">\n  <div class="toolbar-sharing-button"\n       ng-click="sharePublication(\'facebook\')"\n       data-test="component-epubreader-toolbar-share-facebook">\n    <svg class="icon centered"><use xlink:href="assets/common/icons.svg#icon-facebook" /></svg>\n  </div>\n  <div class="toolbar-sharing-button"\n       ng-click="sharePublication(\'twitter\')"\n       data-test="component-epubreader-toolbar-share-twitter">\n    <svg class="icon centered"><use xlink:href="assets/common/icons.svg#icon-twitter" /></svg>\n  </div>\n  <div class="toolbar-sharing-button"\n       ng-click="sharePublication(\'email\')"\n       data-test="component-epubreader-toolbar-share-email">\n    <svg class="icon centered"><use xlink:href="assets/common/icons.svg#icon-mail" /></svg>\n  </div>\n</div>\n')}]),angular.module("../states/epub/partials/textToSpeech.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/epub/partials/textToSpeech.tpl.html",'<div ng-controller="ToolbarTextToSpeechCtrl">\n  <div class="toolbar-panel toolbar-text-to-speech"\n       ng-show="isTextToSpeechToolbarVisible"\n       role="menu">\n    <div class="settings-item" ng-class="{ \'disabled\': isSpeaking }">\n      <div class="title" translate>COMMON_LANGUAGE</div>\n      <div class="current-selection">\n           {{ languages.items[languages.selectedIndex].label | translate }}\n      </div>\n      <div class="btn-open-item-list"\n           ng-click="requestLanguageSelection()"\n           title="{{ \'CHOOSE_LANGUAGE\' | translate }}"\n           tabindex="0"\n           role="button">\n        <svg class="icon"><use xlink:href="assets/common/icons.svg#icon-arrow-right" /></svg>\n      </div>\n    </div>\n    <item-select-list show-if="languages.isVisible" options="languages"></item-select-list>\n    \n    <div class="settings-item" ng-class="{ \'disabled\': isSpeaking }">\n      <div class="title" translate>COMMON_VOICE</div>\n      <div class="current-selection">\n        {{ voices.items[voices.selectedIndex].label | translate }}\n      </div>\n      <div class="btn-open-item-list"\n           ng-click="requestVoiceSelection()"\n           title="{{ \'CHOOSE_VOICE\' | translate }}"\n           tabindex="0"\n           role="button">\n        <svg class="icon"><use xlink:href="assets/common/icons.svg#icon-arrow-right" /></svg>\n      </div>\n    </div>\n    <item-select-list show-if="voices.isVisible" options="voices"></item-select-list>\n    \n    <div class="settings-item" ng-class="{ \'disabled\': isSpeaking }">\n      <svg class="icon speech-rate-slow" title="{{ \'TEXTTOSPEECH_RATE_SLOW\' | translate }}">\n        <use xlink:href="assets/common/icons.svg#icon-slow" />\n      </svg>\n      <twslider id="slider-speech-rate"\n                tw-slider-model="speechRate.index"\n                tw-slider-floor="speechRate.min"\n                tw-slider-ceil="speechRate.max"\n                tw-slider-precision="0"\n                tw-slider-orientation="horizontal"\n                role="slider"\n                aria-valuenow="{{speechRate.index}}"\n                aria-valuemin="{{speechRate.min}}"\n                aria-valuemax="{{speechRate.max}}">\n      </twslider>\n      <svg class="icon speech-rate-fast" title="{{ \'TEXTTOSPEECH_RATE_FAST\' | translate }}">\n        <use xlink:href="assets/common/icons.svg#icon-fast" />\n      </svg>\n    </div>\n    \n    <div class="settings-item text-to-speech-play-control">\n      <button ng-if="!isSpeaking && !isPaused" \n              class="raised" \n              ng-click="requestPlay()"\n              title="{{ \'TEXTTOSPEECH_PLAY\' | translate }}">\n        <svg class="icon">\n          <use xlink:href="assets/common/icons.svg#icon-play" />\n        </svg>\n      </button>\n      <div class="text-to-speech-quit" ng-if="isSpeaking || isPaused" ng-click="requestStop()">\n        <a href="javascript:void(0);" translate>TEXTTOSPEECH_QUIT_PLAYBACK</a>\n      </div>\n    </div>\n  </div>\n\n  <div class="toolbar-text-to-speech-floating-control"\n       ng-show="isSpeaking || isPaused"\n       ng-class="{ \'with-toolbar-visible\': isToolbarVisible == true }">\n    <button ng-if="isPaused" class="raised" ng-click="requestPlay()" title="{{ \'TEXTTOSPEECH_PLAY\' | translate }}">\n      <svg class="icon">\n        <use xlink:href="assets/common/icons.svg#icon-play" />\n      </svg>\n    </button>\n    <button ng-if="isSpeaking && !isPaused" class="raised" ng-click="requestPause()" title="{{ \'TEXTTOSPEECH_PAUSE\' | translate }}">\n      <svg class="icon">\n        <use xlink:href="assets/common/icons.svg#icon-pause" />\n      </svg>\n    </button>\n  </div>\n</div>\n')}]),angular.module("../states/epub/partials/toc.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/epub/partials/toc.tpl.html",'<!-- TABLE OF CONTENTS [start] -->\n<div ng-controller="ToolbarToCCtrl"\n     show-if="isToolbarVisible"\n     class="toolbar-panel toolbar-toc scrollable">\n\n  <div class="toolbar-panel-toc" role="directory">\n    <div class="toolbar-content scrollable">\n      <treeview ng-controller="ToCController" ng-model="nodes" role="tree"></treeview>\n    </div>\n  </div>\n</div>\n<!-- TABLE OF CONTENTS [end] -->\n')}]),angular.module("../states/epub/partials/toolbar.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/epub/partials/toolbar.tpl.html",'<!-- PRIMARY TOOLBAR [start] -->\n<div ng-controller="ToolbarCtrl">\n\n  <div class="toolbar-primary toolbar-content"\n       show-if="isToolbarVisible"\n       ng-mouseover="deactivateAutomaticToolbarHide()"\n       ng-mouseleave="activateAutomaticToolbarHide()"\n       ng-click="hideCurrentlySelectedToolbar()"\n       role="toolbar">\n\n    <div ng-show="!!backRef || state == \'library\'"\n         class="close-reader"\n         ng-click="closeReader($event)"\n         title="{{ \'TOOLTIP_COMPONENT_EPUB_CLOSE\' | translate }}"\n         tabindex="0"\n         role="button"\n         data-test="component-epubreader-btnCloseReader">\n      <svg class="icon"><use xlink:href="assets/common/icons.svg#icon-back" /></svg>\n      <div class="text" translate>READER_CLOSE_TITLE</div>\n    </div>\n\n    <div class="title">\n      &nbsp;\n    </div>\n\n    <!-- PRIMARY TOOLBAR - ACTIONS [start] -->\n    <div class="actions">\n      \n      <div ng-if="textToSpeechEnabled == true"\n           ng-class="{ selected: selectedToolbar == \'texttospeech\' }"\n           ng-click="requestTextToSpeechToolbar($event)"\n           title="{{ \'TOOLTIP_COMPONENT_EPUB_PANEL_TEXTTOSPEECH\' | translate }}"\n           data-test="component-epubreader-btnRequestTextToSpeechToolbar">\n        <svg class="icon"><use xlink:href="assets/common/icons.svg#icon-text-to-speech" /></svg>\n      </div>\n\n      <div ng-class="{ selected: selectedToolbar == \'search\' }"\n           ng-click="requestSearchToolbar($event)"\n           title="{{ \'TOOLTIP_COMPONENT_EPUB_PANEL_SEARCH\' | translate }}"\n           tabindex="0"\n           role="button"\n           data-test="component-epubreader-btnRequestSearchToolbar">\n        <svg class="icon"><use xlink:href="assets/common/icons.svg#icon-search-text" /></svg>\n      </div>\n\n      <div ng-class="{ selected: selectedToolbar == \'fontSettings\', disabled: isFontMenuDisabled }"\n           ng-click="!isFontMenuDisabled && requestFontSettingsToolbar($event)"\n           title="{{ \'TOOLTIP_COMPONENT_EPUB_PANEL_FONTSETTINGS\' | translate }}"\n           tabindex="0"\n           role="button"\n           data-test="component-epubreader-btnRequestFontSettingsToolbar">\n        <svg class="icon"><use xlink:href="assets/common/icons.svg#icon-font-settings" /></svg>\n      </div>\n\n      <div ng-class="{ selected: selectedToolbar == \'toc\' }"\n           ng-click="requestToCToolbar($event)"\n           title="{{ \'COMMON_TABLE_OF_CONTENTS\' | translate }}"\n           tabindex="0"\n           role="button"\n           data-test="component-epubreader-btnRequestToCToolbar">\n        <svg class="icon"><use xlink:href="assets/common/icons.svg#icon-index" /></svg>\n      </div>\n\n      <div ng-class="{ selected: selectedToolbar == \'annotations\' }"\n           ng-click="requestAnnotationsToolbar($event)"\n           title="{{ \'COMMON_ANNOTATIONS\' | translate }}"\n           tabindex="0"\n           role="button"\n           data-test="component-epubreader-btnRequestAnnotationsToolbar">\n        <svg class="icon"><use xlink:href="assets/common/icons.svg#icon-bookmark-page" /></svg>\n      </div>\n<!--\n      <div ng-if="isLibrary" ng-class="{ selected: selectedToolbar == \'share\' }"\n           ng-click="toggleSharingToolbar($event)"\n           title="{{ \'SHARE_PUBLICATION\' | translate }}"\n           data-test="component-epubreader-btnShare">\n        <svg class="icon centered"><use xlink:href="assets/common/icons.svg#icon-share" /></svg>\n      </div>\n-->\n      <button ng-show="!!purchaseUrl"\n              ng-click="jumpToPurchase($event)"\n              tabindex="0"\n              data-test="component-epubreader-btnPurchase">\n        <span translate>READER_BUY_NOW</span>\n      </button>\n      <svg class="icon small-buy-button" \n           ng-show="!!purchaseUrl"\n           ng-click="jumpToPurchase($event)"\n           data-test="component-epubreader-btnPurchase-small">\n        <use xlink:href="assets/common/icons.svg#icon-shop" />\n      </svg>\n\n    </div>\n    <!-- PRIMARY TOOLBAR - ACTIONS [end] -->\n\n  </div>\n\n  <ng-include ng-if="isLibrary" src="\'../states/epub/partials/sharing.tpl.html\'"></ng-include>\n  <ng-include src="\'../states/epub/partials/font.tpl.html\'"></ng-include>\n  <ng-include src="\'../states/epub/partials/toc.tpl.html\'"></ng-include>\n  <ng-include src="\'../states/epub/partials/annotations.tpl.html\'"></ng-include>\n  <ng-include src="\'../states/epub/partials/searchbar.tpl.html\'"></ng-include>\n  <ng-include src="\'../states/epub/partials/textToSpeech.tpl.html\'"></ng-include>\n  \n</div>\n<!-- PRIMARY TOOLBAR [end] -->\n');
}]),angular.module("../states/help/help.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/help/help.tpl.html",'<div class="container-inner">\n  <tw-help-modal></tw-help-modal>\n  <tw-help-sidebar-menu></tw-help-sidebar-menu>\n  <tw-help-header-bar></tw-help-header-bar>\n  <div class="state-help">\n    <tw-scroller>\n      <tw-help-options></tw-help-options>\n    </tw-scroller>\n  </div>\n</div>')}]),angular.module("../states/home/home-cover-flow.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/home/home-cover-flow.tpl.html",'<tw-cover-flow ng-if="!isEmptyBookshelf" item-action="coverAction(id)" deliverables="deliverables"></tw-cover-flow>\n<tw-activity-indicator id="activity-cover-flow"></tw-activity-indicator>\n<tw-empty-list ng-if="isEmptyBookshelf"\n  icon-name="empty-list-books" \n  headline="{{ \'NOTHING_TO_READ_QUESTION\' | translate }}" \n  text="{{ \'BROWSE_OUR_SHOP_YOU_ARE_SURE_TO_FIND_SOMETHING_THERE\' | translate }}"\n  type="">\n</tw-empty-list>\n')}]),angular.module("../states/home/home.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/home/home.tpl.html",'<div tw-home-state-watcher class="container-inner" file-drop>\n  <tw-home-modal></tw-home-modal>\n  <tw-home-delete-dialog></tw-home-delete-dialog>\n  <tw-home-sidebar-menu></tw-home-sidebar-menu>\n  <div class="state-home">\n    <tw-home-header-bar></tw-home-header-bar>\n    <tw-home-cover-flow></tw-home-cover-flow>\n    <div class="button-my-books">\n      <button class="raised" ui-sref="mybooks.titles" translate>COMMON_MY_BOOKS</button>\n    </div>\n    <tw-home-recommendations></tw-home-recommendations>\n  </div>\n  <upload-indicator id="upload-home"></upload-indicator>\n  <upload-dialog id="upload-dialog-home"></upload-dialog>\n</div>\n')}]),angular.module("../states/mybooks/authors/authors-list-view.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/mybooks/authors/authors-list-view.tpl.html",'<tw-scroller ng-if="!isEmptyBookshelf">\n  <div ng-repeat="author in authors"\n        class="author-entry"\n        ui-sref="{{ stateName }}.authors.titles({name: author})">\n    <span>{{ author }}</span>&nbsp;&nbsp;<span>({{ authorMap[author].length }})</span>\n  </div>\n</tw-scroller>\n\n<tw-empty-list ng-if="isEmptyBookshelf && isMyAudiobooks"\n  icon-name="empty-list-audio" \n  headline="{{ \'NOTHING_TO_LISTEN_QUESTION\' | translate }}" \n  text="{{ \'BROWSE_OUR_SHOP_YOU_ARE_SURE_TO_FIND_SOMETHING_THERE\' | translate }}"\n  type="AUDIO">\n</tw-empty-list>\n\n<tw-empty-list ng-if="isEmptyBookshelf && !isMyAudiobooks"\n  icon-name="empty-list-authors" \n  headline="{{ \'NOTHING_TO_READ_QUESTION\' | translate }}" \n  text="{{ \'BROWSE_OUR_SHOP_YOU_ARE_SURE_TO_FIND_SOMETHING_THERE\' | translate }}"\n  type="EBOOK">\n</tw-empty-list>\n')}]),angular.module("../states/mybooks/authors/authors.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/mybooks/authors/authors.tpl.html","<tw-author-list-view></tw-author-list-view>")}]),angular.module("../states/mybooks/authors/titles/author-title-view.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/mybooks/authors/titles/author-title-view.tpl.html",'<tw-state ng-if="!isMyAudiobooks">\n  <tw-scroller>\n    <div class="cover-grid-fixer" ng-if=\'libModel.isGridView()\'>\n      <tw-publication-grid\n        class="grid-view-deliverable"\n        cover-click="coverAction(deliverable.id)"\n        ng-repeat="deliverable in deliverables"\n        deliverable="deliverable"\n        deliverable-id="{{ deliverable.id }}">\n      </tw-publication-grid>\n    </div>\n    <div ng-if=\'!libModel.isGridView()\'>\n      <tw-publication-list\n        class="list-view-deliverable"\n        cover-click="coverAction(deliverable.id)"\n        ng-repeat="deliverable in deliverables"\n        deliverable="deliverable"\n        deliverable-id="{{ deliverable.id }}">\n      </tw-publication-list>\n    </div>\n  </tw-scroller>\n</tw-state>\n<tw-state ng-if="isMyAudiobooks">\n  <tw-scroller>\n    <div ng-if=\'libModel.isGridView()\'>\n      <tw-audiobook-grid-item\n        class="grid-view-deliverable"\n        cover-click="coverAction(deliverable.id)"\n        ng-repeat="deliverable in deliverables"\n        deliverable="deliverable"\n        deliverable-id="{{ deliverable.id }}">\n      </tw-audiobook-grid-item>\n    </div>\n    <div ng-if=\'!libModel.isGridView()\'>\n      <tw-audiobook-list-item\n        class="list-view-deliverable"\n        cover-click="coverAction(deliverable.id)"\n        ng-repeat="deliverable in deliverables"\n        deliverable="deliverable"\n        deliverable-id="{{ deliverable.id }}">\n      </tw-audiobook-list-item>\n    </div>\n  </tw-scroller>\n</tw-state>\n')}]),angular.module("../states/mybooks/authors/titles/titles.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/mybooks/authors/titles/titles.tpl.html","<tw-titles-header-bar></tw-titles-header-bar>\n<tw-authors-title-view></tw-authors-title-view>")}]),angular.module("../states/mybooks/collections/collection-view.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/mybooks/collections/collection-view.tpl.html",'<tw-scroller ng-if="collections && collections.length > 0">\n  <tw-collection-grid-item ng-if=\'libModel.isGridView()\' ng-repeat="collection in collections" collection="collection">\n  </tw-collection-grid-item>\n\n  <tw-collection-list-item ng-if=\'!libModel.isGridView()\' ng-repeat="collection in collections" collection="collection">\n  </tw-collection-list-item>\n</tw-scroller>\n\n<tw-empty-list ng-if="collections && collections.length === 0"\n  icon-name="empty-list-collections"\n  text="{{ \'NO_COLLECTIONS_HAVE_BEEN_CREATED\' | translate }}">\n    <div ng-if="demoMode">\n      <div class="empty-list-text" translate>NO_COLLECTIONS_DEMO_TEASER</div>\n      <button class="raised" ng-click="onLoginClick()" data-test="empty-list-btn-login" ng-bind="\'COMMON_LOGIN\' | translate"></button>\n    </div>\n    <div ng-if="!demoMode">\n      <div class="empty-list-text" translate>NO_COLLECTIONS_TEASER</div>\n      <button class="raised" ng-click="onCreateClick()" data-test="empty-list-btn-login" ng-bind="\'CREATE_NEW_COLLECTION\' | translate"></button>\n    </div>\n</tw-empty-list>\n\n<tw-collection-edit-dialog></tw-collection-edit-dialog>\n<tw-collection-delete-dialog></tw-collection-delete-dialog>')}]),angular.module("../states/mybooks/collections/collections.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/mybooks/collections/collections.tpl.html","<tw-collection-view></tw-collection-view>")}]),angular.module("../states/mybooks/collections/selection/collections-selection-view.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/mybooks/collections/selection/collections-selection-view.tpl.html",'<tw-scroller>\n  <tw-collection-grid-item ng-if=\'libModel.isGridView()\' ng-repeat="collection in collections" collection="collection">\n  </tw-collection-grid-item>\n\n  <tw-collection-list-item ng-if=\'!libModel.isGridView()\' ng-repeat="collection in collections" collection="collection">\n  </tw-collection-list-item>\n  <tw-empty-list ng-if="collections && collections.length === 0"\n    icon-name="empty-list-collections"\n    text="{{ \'NO_COLLECTIONS_HAVE_BEEN_CREATED\' | translate }}">\n      <div ng-if="demoMode">\n        <div class="empty-list-text" translate>NO_COLLECTIONS_DEMO_TEASER</div>\n        <button class="raised" ng-click="onLoginClick()" data-test="empty-list-btn-login" ng-bind="\'COMMON_LOGIN\' | translate"></button>\n      </div>\n      <div ng-if="!demoMode">\n        <div class="empty-list-text" translate>NO_COLLECTIONS_TEASER</div>\n        <button class="raised" ng-click="onCreateClick()" data-test="empty-list-btn-login" ng-bind="\'CREATE_NEW_COLLECTION\' | translate"></button>\n      </div>\n  </tw-empty-list>\n</tw-scroller>\n\n')}]),angular.module("../states/mybooks/collections/selection/collections-selection.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/mybooks/collections/selection/collections-selection.tpl.html",'<tw-collections-selection-header-bar></tw-collections-selection-header-bar>\n<div class="state-mybooks-collections-selection">\n  <tw-collections-selection-checkbox></tw-collections-selection-checkbox>\n  <tw-collections-selection-view></tw-collections-selection-view>\n</div>\n<tw-collection-edit-dialog></tw-collection-edit-dialog>\n<tw-collection-delete-dialog></tw-collection-delete-dialog>')}]),angular.module("../states/mybooks/collections/titles/collections-title-view.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/mybooks/collections/titles/collections-title-view.tpl.html",'<tw-state ng-if="!isMyAudiobooks">\n  <tw-scroller ng-if="deliverables && deliverables.length > 0">\n    <div class="cover-grid-fixer" ng-if=\'libModel.isGridView()\'>\n      <tw-publication-grid\n        class="grid-view-deliverable"\n        cover-click="coverAction(deliverable.id)"\n        pub-repeat="deliverable in deliverables"\n        deliverable="deliverable"\n        deliverable-id="{{ deliverable.id }}">\n      </tw-publication-grid>\n    </div>\n    <div ng-if=\'!libModel.isGridView()\'>\n      <tw-publication-list\n        class="list-view-deliverable"\n        cover-click="coverAction(deliverable.id)"\n        pub-repeat="deliverable in deliverables"\n        deliverable="deliverable"\n        deliverable-id="{{ deliverable.id }}">\n      </tw-publication-list>\n    </div>\n  </tw-scroller>\n  \n  <tw-empty-list ng-if="deliverables && deliverables.length === 0"\n    icon-name="empty-list-books" \n    text="{{ \'COLLECTION_IS_EMPTY_WOULD_YOU_LIKE_TO_ADD_CONTENT_FROM_YOUR_LIBRARY_NOW\' | translate }}">\n    <button ng-if="isLoggedIn" class="raised" ng-click="addTitles()" data-test="collection-btn-add-title" ng-bind="\'ADD_TITLES_NOW\' | translate">ADD_TITLES_NOW</button>\n    <button ng-if="!isLoggedIn" class="raised" ng-click="onLoginClick()" data-test="collection-btn-login-title" ng-bind="\'COMMON_LOGIN\' | translate"></button>\n  </tw-empty-list>\n</tw-state>\n\n<tw-state ng-if="isMyAudiobooks">\n  <tw-scroller>\n    <div ng-if=\'libModel.isGridView()\'>\n      <tw-audiobook-grid-item\n        class="grid-view-deliverable"\n        cover-click="coverAction(deliverable.id)"\n        ng-repeat="deliverable in deliverables"\n        deliverable="deliverable"\n        deliverable-id="{{ deliverable.id }}">\n      </tw-audiobook-grid-item>\n    </div>\n    <div ng-if=\'!libModel.isGridView()\'>\n      <tw-audiobook-list-item\n        class="list-view-deliverable"\n        cover-click="coverAction(deliverable.id)"\n        ng-repeat="deliverable in deliverables"\n        deliverable="deliverable"\n        deliverable-id="{{ deliverable.id }}">\n      </tw-audiobook-list-item>\n    </div>\n  </tw-scroller>\n\n  <tw-empty-list ng-if="deliverables && deliverables.length === 0"\n    icon-name="empty-list-audio" \n    text="{{ \'COLLECTION_IS_EMPTY_WOULD_YOU_LIKE_TO_ADD_CONTENT_FROM_YOUR_LIBRARY_NOW\' | translate }}">\n    <button class="raised" ng-click="addTitles()" data-test="collection-btn-add-title" translate>ADD_TITLES_NOW</button>\n  </tw-empty-list>\n</tw-state>\n\n<collection-add-dialog></collection-add-dialog>\n')}]),angular.module("../states/mybooks/collections/titles/titles.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/mybooks/collections/titles/titles.tpl.html","<tw-collections-titles-header-bar></tw-collections-titles-header-bar>\n<tw-collections-title-view></tw-collections-title-view>\n")}]),angular.module("../states/mybooks/default.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/mybooks/default.tpl.html",'<tw-mybooks-header-bar></tw-mybooks-header-bar>\n<div class="state-mybooks">\n  <tw-mybooks-tab-bar></tw-mybooks-tab-bar>\n</div>\n')}]),angular.module("../states/mybooks/details/details-arrows.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/mybooks/details/details-arrows.tpl.html",'<div ng-show="navigationVisible" class="arrow" ng-click="changePublication(true)">\n  <svg>\n    <use xlink:href="assets/common/icons.svg#icon-arrow-left" />\n  </svg>\n</div>\n<ng-transclude></ng-transclude>\n<div ng-show="navigationVisible" class="arrow" ng-click="changePublication(false)">\n  <svg>\n    <use ng-attr-xlink:href="assets/common/icons.svg#icon-arrow-right" xlink:href="" />\n  </svg>\n</div>\n')}]),angular.module("../states/mybooks/details/details.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/mybooks/details/details.tpl.html",'<div tw-details-state-watcher class="container-inner">\n  <tw-details-delete-dialog></tw-details-delete-dialog>\n  <tw-details-modal></tw-details-modal>\n  <tw-details-sidebar-menu></tw-details-sidebar-menu>\n  <tw-details-header-bar></tw-details-header-bar>\n  <tw-details-arrows interaction-handler>\n    <div class="state-details">\n      <tw-scroller>\n        <tw-details-cover-info></tw-details-cover-info>\n        <tw-details-read-button></tw-details-read-button>\n        <tw-details-abstract></tw-details-abstract>\n        <tw-details-pub-details></tw-details-pub-details>\n        <tw-details-recommendations></tw-details-recommendations>\n      </tw-scroller>\n    </div>\n  </tw-details-arrows>\n  <tw-activity-indicator id="details"></tw-activity-indicator>\n</div>')}]),angular.module("../states/mybooks/mybooks-tab-bar.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/mybooks/mybooks-tab-bar.tpl.html","<tw-tab-bar tabs-config='tabsConfig'>\n  <div class='tab-ui-view' ui-view></div>\n</tw-tab-bar>\n")}]),angular.module("../states/mybooks/mybooks.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/mybooks/mybooks.tpl.html",'<div tw-mybooks-state-watcher class="container-inner" ng-controller="myBooksController" file-drop>\n  <tw-mybooks-modal></tw-mybooks-modal>\n  <tw-mybooks-delete-dialog></tw-mybooks-delete-dialog>\n  <tw-mybooks-sidebar-menu></tw-mybooks-sidebar-menu>\n  <div ui-view class="mybooks-ui-view"></div>\n\n  <upload-indicator id="upload-lib"></upload-indicator>\n  <upload-dialog id="upload-dialog-lib"></upload-dialog>\n</div>')}]),angular.module("../states/mybooks/selection/selection-view.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/mybooks/selection/selection-view.tpl.html",'<tw-state ng-if="!isMyAudiobooks">\n  <tw-scroller>\n    <div class="cover-grid-fixer" ng-if=\'libModel.isGridView()\'>\n      <tw-publication-grid\n        class="grid-view-deliverable"\n        pub-repeat="deliverable in deliverables track by deliverable.id"\n        deliverable="deliverable"\n        deliverable-id="{{ deliverable.id }}">\n      </tw-publication-grid>\n    </div>\n    <div ng-if=\'!libModel.isGridView()\'>\n      <tw-publication-list\n        class="list-view-deliverable"\n        pub-repeat="deliverable in deliverables track by deliverable.id"\n        deliverable="deliverable"\n        deliverable-id="{{ deliverable.id }}">\n      </tw-publication-list>\n    </div>\n  </tw-scroller>\n</tw-state>\n\n<tw-state ng-if="isMyAudiobooks">\n  <tw-scroller>\n    <div ng-if=\'libModel.isGridView()\'>\n      <tw-audiobook-grid-item\n        class="grid-view-deliverable"\n        ng-repeat="deliverable in deliverables"\n        deliverable="deliverable"\n        deliverable-id="{{ deliverable.id }}">\n      </tw-audiobook-grid-item>\n    </div>\n    <div ng-if=\'!libModel.isGridView()\'>\n      <tw-audiobook-list-item\n        class="list-view-deliverable"\n        ng-repeat="deliverable in deliverables"\n        deliverable="deliverable"\n        deliverable-id="{{ deliverable.id }}">\n      </tw-audiobook-list-item>\n    </div>\n  </tw-scroller>\n</tw-state>\n\n<tw-collection-remove-deliverable-dialog></tw-collection-remove-deliverable-dialog>')}]),angular.module("../states/mybooks/selection/selection.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/mybooks/selection/selection.tpl.html",'<tw-mybooks-selection-header-bar></tw-mybooks-selection-header-bar>\n<div class="state-mybooks-selection">\n  <tw-mybooks-selection-checkbox></tw-mybooks-selection-checkbox>\n  <tw-selection-view></tw-selection-view>\n</div>\n')}]),angular.module("../states/mybooks/titles/titles-view.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/mybooks/titles/titles-view.tpl.html",'<tw-state ng-if="!isMyAudiobooks">\n  <tw-scroller ng-if="!isEmptyBookshelf">\n    <div class="cover-grid-fixer" ng-if=\'libModel.isGridView()\'>\n      <tw-publication-grid\n        class="grid-view-deliverable"\n        pub-repeat="deliverable in deliverables track by deliverable.id"\n        cover-click="coverAction(deliverable.id)"\n        deliverable="deliverable"\n        deliverable-id="{{ deliverable.id }}">\n      </tw-publication-grid>\n    </div>\n\n    <div ng-if=\'!libModel.isGridView()\'>\n      <tw-publication-list\n        class="list-view-deliverable"\n        cover-click="coverAction(deliverable.id)"\n        pub-repeat="deliverable in deliverables track by deliverable.id"\n        deliverable="deliverable"\n        deliverable-id="{{ deliverable.id }}">\n      </tw-publication-list>\n    </div>\n  </tw-scroller>\n\n  <tw-empty-list ng-if="isEmptyBookshelf"\n    icon-name="empty-list-books" \n    headline="{{ \'NOTHING_TO_READ_QUESTION\' | translate }}"\n    text="{{ \'BROWSE_OUR_SHOP_YOU_ARE_SURE_TO_FIND_SOMETHING_THERE\' | translate }}"\n    type="EBOOK">\n  </tw-empty-list>\n</tw-state>\n\n<tw-state ng-if="isMyAudiobooks">\n  <tw-scroller ng-if="!isEmptyBookshelf">\n    <div class="cover-grid-fixer" ng-if=\'libModel.isGridView()\'>\n      <tw-audiobook-grid-item\n        cover-click=\'coverAction(deliverable.id)\'\n        ng-repeat=\'deliverable in deliverables\'\n        deliverable=\'deliverable\'\n        deliverable-id=\'{{ deliverable.id }}\'>\n      </tw-audiobook-grid-item>\n    </div>\n    <div ng-if=\'!libModel.isGridView()\'>\n      <tw-audiobook-list-item\n        cover-click=\'coverAction(deliverable.id)\'\n        ng-repeat=\'deliverable in deliverables\'\n        deliverable=\'deliverable\'\n        deliverable-id=\'{{ deliverable.id }}\'>\n      </tw-audiobook-list-item>\n    </div>\n  </tw-scroller>\n\n  <tw-empty-list ng-if="isEmptyBookshelf"\n    icon-name="empty-list-audio" \n    headline="{{ \'NOTHING_TO_LISTEN_QUESTION\' | translate }}" \n    text="{{ \'BROWSE_OUR_SHOP_YOU_ARE_SURE_TO_FIND_SOMETHING_THERE\' | translate }}"\n    type="AUDIO">\n  </tw-empty-list>\n</tw-state>\n')}]),angular.module("../states/mybooks/titles/titles.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/mybooks/titles/titles.tpl.html","<tw-titles-view></tw-titles-view>\n")}]),angular.module("../states/pdf/partials/annotations.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/pdf/partials/annotations.tpl.html",'<!-- ANNOTATIONS [start] -->\n<div class="annotations-panel"\n     ng-controller="PdfAnnotationsPanelCtrl"\n     ng-class="{\'annotations-hide\' : !isAnnotationsPanelVisible}"\n\n  <!-- TAB SELECTION [start] -->\n  <div class="pane-selection">\n    <div class="pane-selection-content">\n      <span ng-click="selectPane(\'toc\')" ng-class="{ selected: isToCPaneVisible }"\n            data-test="pdf-toolbar-annotation-panel-select-toc" translate>COMMON_TABLE_OF_CONTENTS\n      </span>\n      <span ng-click="selectPane(\'bookmarks\')" ng-class="{ selected: isBookmarksPaneVisible }"\n            data-test="pdf-toolbar-annotation-panel-select-bookmarks" translate>COMMON_BOOKMARKS\n      </span>\n    </div>\n  </div>\n  <!-- TAB SELECTION [end] -->\n\n  <!-- TABLE OF CONTENTS PANE [start] -->\n  <div class="toc-pane" ng-show="isToCPaneVisible">\n    <div class="pane-content scrollable">\n      <treeview ng-controller="PdfToCController" ng-model="nodes"></treeview>\n    </div>\n  </div>\n  <!-- TABLE OF CONTENTS PANE [end] -->\n  \n  <!-- BOOKMARKS PANE [start] -->\n  <div class="bookmarks-pane" ng-controller="PdfBookmarkController" ng-show="isBookmarksPaneVisible">\n    <div class="pane-content scrollable">\n      <tw-dogear-list-item ng-repeat="item in bookmarks track by $index" model="item"></tw-dogear-list-item>\n    </div>\n  </div>\n  <!-- BOOKMARKS PANE [end] -->\n\n</div>\n<!-- ANNOTATIONS [end] -->\n')}]),angular.module("../states/pdf/partials/dogear-list-item.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/pdf/partials/dogear-list-item.tpl.html",'<div class="bookmark-list-item" ng-click="goToBookmark()">\n  <svg class="bookmark-indicator icon"><use xlink:href="assets/common/icons.svg#icon-bookmark-solid" /></svg>\n  \n  <div class="bookmark-info">\n    <div class="bookmark-time" ng-if="model.modified > 0">{{ (model.modified) | date:"dd.MM.yyyy | HH:mm" }}</div>\n    <div class="bookmark-headline single-line">\n      <span translate>COMMON_PAGE</span>\n      <span>{{ model.displayName }}</span>\n    </div>\n  </div>\n  \n  <div class="bookmark-remove" ng-click="removeBookmark($event)"\n       title="{{ \'TOOLTIP_ANNOTATION_LIST_ITEM_REMOVE\' | translate }}"\n       data-test="component-bookmark-list-item-remove">\n    <svg class="icon"><use xlink:href="assets/common/icons.svg#icon-delete" /></svg>\n  </div>\n</div>\n')}]),angular.module("../states/pdf/partials/dogear.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/pdf/partials/dogear.tpl.html",'<div class="action btn-dogear" ng-if="isLibrary" ng-click="toggleDogear()" data-test="component-pdfreader-btnDogear">\n  <svg class="icon"><use style="pointer-events : none;" xlink:href="assets/common/icons.svg#icon-bookmark2-solid" /></svg>\n</div>')}]),angular.module("../states/pdf/partials/footer.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/pdf/partials/footer.tpl.html",'<!-- PDF READER - FOOTER BAR [start] -->\n<div class="footer" ng-class="{\'footer-hide\' : !isSliderVisible }">\n  \n  <div class="page-info" ng-click="pagerAction()" data-test="component-pdfreader-pager"></div>\n\n  <twslider tw-slider-model="sliderValue"\n            tw-slider-ceil="sliderCeiling"\n            tw-slider-floor="1"\n            tw-slider-orientation="horizontal"\n            data-test="component-pdfreader-slider"\n            title="{{ \'TOOLTIP_COMPONENT_PDF_NAV_SLIDER\' | translate }}"></twslider>\n\n  <div class="navigation">\n    <button ng-click="chapterAction(false)"\n            ng-disabled="isFirstSection"\n            class="chapter-previous"\n            title="{{ \'TOOLTIP_PREVIOUS_SECTION\' | translate }}"\n            data-test="component-pdfreader-btnChapterPrevious">\n      <svg class="icon"><use xlink:href="assets/common/icons.svg#icon-prev" /></svg>\n      <span translate>PREVIOUS_SECTION</span>\n    </button>\n    <div class="section-label">{{ sectionLabel }}</div>\n    <button ng-click="chapterAction(true)"\n            class="chapter-next"\n            ng-disabled="isLastSection"\n            title="{{ \'TOOLTIP_NEXT_SECTION\' | translate }}"\n            data-test="component-pdfreader-btnChapterNext">\n      <span translate>NEXT_SECTION</span>\n      <svg class="icon"><use xlink:href="assets/common/icons.svg#icon-next" /></svg>\n    </button>\n  </div>\n\n</div>\n<!-- PDF READER - FOOTER BAR [end] -->\n')}]),angular.module("../states/pdf/partials/navigation.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/pdf/partials/navigation.tpl.html",'<div class="left">\n  <div class="icon-container centered left-arrow" ng-click="pageAction(false)">\n    <svg class="icon"> <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="assets/common/icons.svg#icon-arrow-left"></use></svg>\n  </div>\n</div>\n<div class="right">\n  <div class="icon-container centered right-arrow" ng-click="pageAction(true)">\n    <svg class="icon"> <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="assets/common/icons.svg#icon-arrow-right"></use></svg>\n  </div>\n</div>\n')}]),angular.module("../states/pdf/partials/pager.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/pdf/partials/pager.tpl.html",'<div class="pager-container" ng-click="closeDialog">\n  <div class="pager" ng-show="visible">\n    <div class="pager-title" translate >PDF_PAGER_TITLE</div>\n    <div class="action-container">\n      <div class="search-input-container">\n        <div class="iconFont search-input-clear"\n             ng-click="resetSearch()"\n             data-test="component-pdfreader-pager-clear"\n             ng-show="clearVisible">X</div>\n        <input type="number"\n               tabindex="0"\n               ng-model="requestedPage"\n               ng-keyup="handleInputKeyEvent($event)"\n               data-test="component-pdfreader-pager-input"\n               min="1"\n               max="{{maxPages}}" />\n      </div>\n      <svg ng-click="jump()" data-test="component-pdfreader-pager-confirm"><use xlink:href="assets/common/icons.svg#icon-checkmark" /></svg>\n    </div>\n  </div>\n</div>')}]),angular.module("../states/pdf/partials/reader.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/pdf/partials/reader.tpl.html",'<tw-pdf-toolbar></tw-pdf-toolbar>\n<tw-activity-indicator id="pdf-indicator"></tw-activity-indicator>\n<tw-pdf-dogear title="{{ \'TOOLTIP_COMPONENT_PDF_ACTION_DOGEAR\' | translate }}"></tw-pdf-dogear>\n<tw-pdf-navigation></tw-pdf-navigation>\n<!-- PDF READER [start] -->\n<div class="pdfreader" id="pdfinterface" interaction-handler>\n\n    <div id="pagecontainer" class="page-container">\n      <div id="rotationcontainer" class="rotation-container">\n        <div class="page">\n          <canvas></canvas>\n        </div>\n        <div class="page">\n          <canvas></canvas>\n        </div>\n      </div>\n  </div>\n</div>\n<!-- PDF READER [end] -->\n<tw-pdf-pager></tw-pdf-pager>\n<tw-pdf-footer></tw-pdf-footer>\n')}]),angular.module("../states/pdf/partials/toolbar.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/pdf/partials/toolbar.tpl.html",'<!-- PDF READER - TOOLBAR [start] -->\n<div class="toolbar-primary" ng-class="{\'toolbar-hide\' : !isToolbarVisible }">\n\n  <!-- CLOSE READER [start] -->\n  <div class="close-reader"\n       ng-click="emitAction(\'exit\')"\n       title="{{ \'TOOLTIP_COMPONENT_PDF_CLOSE\' | translate }}"\n       tabindex="0"\n       role="button"\n       data-test="component-pdfreader-btnCloseReader">\n    <svg class="icon"><use xlink:href="assets/common/icons.svg#icon-back" /></svg>\n  </div>\n  <!-- CLOSE READER [start] -->\n\n  <!-- TITLE [start] -->\n  <div class="title" ng-click="emitAction(\'exit\')" translate>READER_CLOSE_TITLE</div>\n  <!-- TITLE [end] -->\n\n  <!-- ZOOM SLIDER [start] -->\n  <div class="slider-zoom">\n    <div class="slider-zoom-minus"\n         ng-click="zoomAction()"\n         data-test="component-pdfreader-btnZoomOut"\n         title="{{ \'TOOLTIP_COMPONENT_PDF_ZOOM_DECREASE\' | translate }}">\n      <svg class="icon"><use xlink:href="assets/common/icons.svg#icon-minus" /></svg>\n    </div>\n    <twslider tw-slider-model="sliderValue"\n              tw-slider-ceil="6"\n              tw-slider-floor="1"\n              tw-slider-orientation="horizontal"\n              tw-slider-precision="0.1"\n              title="{{ \'TOOLTIP_COMPONENT_PDF_ZOOM_SLIDER\' | translate }}"\n              role="slider"\n              aria-valuenow="{{sliderValue}}"\n              aria-valuemin="1"\n              aria-valuemax="6"\n              data-test="component-pdfreader-zoomSlider"></twslider>\n    <div class="slider-zoom-plus"\n         ng-click="zoomAction(true)"\n         data-test="component-pdfreader-btnZoomIn"\n         title="{{ \'TOOLTIP_COMPONENT_PDF_ZOOM_INCREASE\' | translate }}">\n      <svg class="icon"><use xlink:href="assets/common/icons.svg#icon-plus" /></svg>\n    </div>\n\n  </div>\n  <!-- ZOOM SLIDER [end] -->\n\n  <!-- ACTIONS [start] -->\n  <div class="actions">\n    <div class="actions-mutable">\n      <div class="action"\n           ng-click="emitAction(\'fit.height\')"\n           data-test="component-pdfreader-btnFitHeight"\n           title="{{ \'TOOLTIP_COMPONENT_PDF_ACTION_FITTOHEIGHT\' | translate }}">\n        <svg class="icon"><use xlink:href="assets/common/icons.svg#icon-fit-height" /></svg>\n      </div>\n      <div class="action"\n           ng-click="emitAction(\'fit.width\')"\n           tabindex="0"\n           role="button"\n           data-test="component-pdfreader-btnFitWidth"\n           title="{{ \'TOOLTIP_COMPONENT_PDF_ACTION_FITTOWIDTH\' | translate }}">\n        <svg class="icon"><use xlink:href="assets/common/icons.svg#icon-fit-width" /></svg>\n      </div>\n      <div class="action"\n           ng-click="emitAction(\'rotate\')"\n           tabindex="0"\n           role="button"\n           data-test="component-pdfreader-btnRotate"\n           title="{{ \'TOOLTIP_COMPONENT_PDF_ACTION_ROTATE\' | translate }}">\n        <svg class="icon"><use xlink:href="assets/common/icons.svg#icon-rotate-clockwise" /></svg>\n      </div>\n      <div class="action page-switcher"\n           data-test="component-pdfreader-btnPages"\n           ng-click="emitAction(\'pages\')"\n           tabindex="0"\n           role="button"\n           title="{{ pageLayoutTooltip | translate }}">\n        \n        <svg class="icon hide"><use xlink:href="assets/common/icons.svg#icon-switch-double-page" /></svg>\n\n        <svg class="icon show"><use xlink:href="assets/common/icons.svg#icon-switch-single-page" /></svg>\n\n      </div>\n      <div class="action btn-toc"\n           data-test="component-pdfreader-btnToc"\n           ng-click="emitAction(\'toc.toggle\')"\n           tabindex="0"\n           role="button"\n           title="{{ \'TOOLTIP_COMPONENT_PDF_ACTION_TABLE_OF_CONTENTS\' | translate }}">\n        <svg class="icon"><use xlink:href="assets/common/icons.svg#icon-index-annotations" /></svg>\n      </div>\n      <button ng-if="purchaseUrl"\n              ng-click="shopJump()"\n              tabindex="0"\n              data-test="component-pdfreader-btnPurchase">\n        <span translate>READER_BUY_NOW</span>\n      </button>\n    </div>\n  </div>\n  <!-- ACTIONS [end] -->\n\n</div>\n<!-- PDF READER - TOOLBAR [end] -->\n\n<ng-include src="\'../states/pdf/partials/annotations.tpl.html\'"></ng-include>\n')}]),angular.module("../states/pdf/pdf.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/pdf/pdf.tpl.html","<tw-pdf></tw-pdf>")}]),angular.module("../states/read/read.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/read/read.tpl.html",'<tw-activity-indicator id="read"></tw-activity-indicator>\n<tw-read-state-watcher></tw-read-state-watcher>')}]),angular.module("../states/reseller/reseller-button-list.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/reseller/reseller-button-list.tpl.html","<div ng-click='setReseller(resellerObject)'\n     ng-repeat='resellerObject in service.getResellers()'>\n  <tw-label-button \n    title='{{ resellerObject.resellerName }}'\n    reseller-logo-identifier='{{ resellerObject.logoName }}'>\n  </tw-label-button>\n</div>")}]),angular.module("../states/reseller/reseller-header.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/reseller/reseller-header.tpl.html",'<span ng-click="back()" class="icon-container">\n  <svg class="icon"><use xlink:href="assets/common/icons.svg#icon-back" /></svg>\n</span>\n<div><span translate>RESELLER_SELECTION_TITLE</span> {{ country }}</div>\n')}]),angular.module("../states/reseller/reseller.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/reseller/reseller.tpl.html",'<!-- CONTENT [start] -->\n<div class="reseller-container" tw-reseller-state-watcher>\n  <tw-reseller-header></tw-reseller-header>\n  <div class="reseller-content">\n    <div class="reseller-content-illustration">\n      <img src="assets/common/webreader-illustration-4.svg" alt="" />\n    </div>\n    <div class="reseller-content-list-container">\n      <div class="reseller-content-list">\n        <div translate>RESELLER_SELECTION_TEXT</div>\n        <tw-reseller-button-list></tw-reseller-button-list>\n      </div>\n    </div>\n  </div>\n  <tw-activity-indicator id="reseller"></tw-activity-indicator>\n</div>\n<!-- CONTENT [end] -->');
}]),angular.module("../states/search/audio/audio-view.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/search/audio/audio-view.tpl.html",'<tw-scroller ng-if=\'deliverables\'>\n  <div ng-if=\'libModel.isGridView()\'>\n    <tw-audiobook-grid-item\n      class="grid-view-deliverable"\n      cover-click="coverAction(deliverable.id)"\n      ng-repeat="deliverable in deliverables"\n      deliverable="deliverable"\n      deliverable-id="{{ deliverable.id }}">\n    </tw-audiobook-grid-item>\n  </div>\n  <div ng-if=\'!libModel.isGridView()\'>\n    <tw-audiobook-list-item\n      class="list-view-deliverable"\n      cover-click="coverAction(deliverable.id)"\n      ng-repeat="deliverable in deliverables"\n      deliverable="deliverable"\n      deliverable-id="{{ deliverable.id }}">\n    </tw-audiobook-list-item>\n  </div>\n</tw-scroller>\n\n<tw-empty-list ng-if="!deliverables"\n  icon-name="search-audio" \n  headline="{{ \'PLEASE_ENTER_SEARCH_TERM\' | translate }}"\n  text="{{ \'PLEASE_ENTER_AT_LEAST_THREE_CHARACTERS_TO_DISPLAY_RELEVANT_SEARCH_HITS\' | translate }}">\n</tw-empty-list>\n\n<tw-empty-list ng-if="deliverables && deliverables.length === 0"\n  icon-name="search-no-result" \n  headline="{{ \'NO_RESULTS_FOUND\' | translate }}"\n  text="{{ \'YOUR_SEARCH_RESULTED_IN_NO_HITS\' | translate }}">\n</tw-empty-list>\n')}]),angular.module("../states/search/audio/audio.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/search/audio/audio.tpl.html","<tw-audio-view></tw-audio-view>\n\n")}]),angular.module("../states/search/books/books-view.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/search/books/books-view.tpl.html",'<tw-scroller ng-if=\'deliverables\'>\n  <div class="cover-grid-fixer" ng-if=\'libModel.isGridView()\'>\n    <tw-publication-grid\n      class="grid-view-deliverable"\n      cover-click="coverAction(deliverable.id)"\n      ng-repeat="deliverable in deliverables"\n      deliverable="deliverable"\n      deliverable-id="{{ deliverable.id }}">\n    </tw-publication-grid>\n  </div>\n  <div ng-if=\'!libModel.isGridView()\'>\n    <tw-publication-list\n      class="list-view-deliverable"\n      cover-click="coverAction(deliverable.id)"\n      ng-repeat="deliverable in deliverables"\n      deliverable="deliverable"\n      deliverable-id="{{ deliverable.id }}">\n    </tw-publication-list>\n  </div>\n</tw-scroller>\n\n<tw-empty-list ng-if="!deliverables"\n  icon-name="search-books" \n  headline="{{ \'PLEASE_ENTER_SEARCH_TERM\' | translate }}"\n  text="{{ \'PLEASE_ENTER_AT_LEAST_THREE_CHARACTERS_TO_DISPLAY_RELEVANT_SEARCH_HITS\' | translate }}">\n</tw-empty-list>\n\n<tw-empty-list ng-if="deliverables && deliverables.length === 0"\n  icon-name="search-no-result" \n  headline="{{ \'NO_RESULTS_FOUND\' | translate }}"\n  text="{{ \'YOUR_SEARCH_RESULTED_IN_NO_HITS\' | translate }}">\n</tw-empty-list>\n')}]),angular.module("../states/search/books/books.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/search/books/books.tpl.html","<tw-books-view></tw-books-view>")}]),angular.module("../states/search/search-header-bar.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/search/search-header-bar.tpl.html",'<svg ng-click="back()"><use xlink:href="assets/common/icons.svg#icon-back" /></svg>\n<tw-search-input options="searchInput" ref-id="lib-filter"></tw-search-input>\n<div style="width: 3.3rem"></div> <!-- don\'t remove, dummy element to center the search input w/ flex layout -->\n')}]),angular.module("../states/search/search.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/search/search.tpl.html",'<div tw-search-state-watcher class="container-inner">\n  <tw-search-delete-dialog></tw-search-delete-dialog>\n  <tw-sidebar-menu></tw-sidebar-menu>\n  <tw-search-bar></tw-search-bar>\n  <tw-search-tab-bar></tw-search-tab-bar>\n</div>')}]),angular.module("../states/sorry/sorry.tpl.html",[]).run(["$templateCache",function(a){a.put("../states/sorry/sorry.tpl.html",'<!-- CONTENT [start] -->\n<div class="state-sorry">\n  <div class="state-sorry-container">\n    \n    <div class="error-headline">{{ errorInfo.headline | translate }}</div>\n    \n    <div ng-if="errorInfo.type != \'DEVICE_LIMIT\'">\n      <div class="error-message">{{ errorInfo.message | translate }}</div>\n    </div>\n    \n    <div ng-if="errorInfo.type == \'DEVICE_LIMIT\'">\n      <div class="error-message" translate>DEVICE_LIMIT_TEXT</div>\n      <div ng-click="jumpToDeviceMgmt()"\n           class="device-link-container"\n           data-test="library-sorry-btnJumpToDeviceManagement">\n        <div class="device-link-info"\n             translate\n             translate-values="{{ translationData }}">\n          ACCOUNT_DEVICE_MANAGEMENT_INFO\n        </div>\n        <div class="iconFont device-link-info-pointer">></div>\n        <div class="device-link-container-end"></div>\n      </div>\n    </div>\n    \n    <div ng-if="!!errorInfo.details" class="error-details">\n       <button class="btn-icon" ng-click="toggleShowErrorDetails()">\n          <svg class="icon">\n             <use ng-attr-xlink:href="{{ \'assets/common/icons.svg#icon-\' + iconBtnShowErrorDetails }}" xlink:href="" />\n          </svg>\n       </button>\n       <div ng-show="showErrorDetails" class="error-details-text">\n         {{ errorInfo.details | translate }}\n       </div>\n    </div>\n    \n  </div>\n</div>\n<!-- CONTENT [end] -->\n')}]),function(){"use strict";if("function"!=typeof Object.assign&&(Object.assign=function(a){if(null==a)throw new TypeError("Cannot convert undefined or null to object");a=Object(a);for(var b=1;b<arguments.length;b++){var c=arguments[b];if(null!=c)for(var d in c)Object.prototype.hasOwnProperty.call(c,d)&&(a[d]=c[d])}return a}),!Array.prototype.find){var a=function(a){if(null==this)throw new TypeError("Array.prototype.find called on null or undefined");if("function"!=typeof a)throw new TypeError("predicate must be a function");for(var b,c=Object(this),d=c.length>>>0,e=arguments[1],f=0;f<d;f++)if(b=c[f],a.call(e,b,f,c))return b};Object.defineProperty(Array.prototype,"find",{enumerable:!1,value:a})}if(!Array.prototype.findIndex){var b=function(a){if(null==this)throw new TypeError("Array.prototype.findIndex called on null or undefined");if("function"!=typeof a)throw new TypeError("predicate must be a function");for(var b,c=Object(this),d=c.length>>>0,e=arguments[1],f=0;f<d;f++)if(b=c[f],a.call(e,b,f,c))return f;return-1};Object.defineProperty(Array.prototype,"findIndex",{enumerable:!1,value:b})}window.HTMLSpanElement||(window.HTMLSpanElement=HTMLElement);try{Boolean(Window)}catch(a){window.Window={},window.Window.prototype={}}if(Array.isArray||(Array.isArray=function(a){return"[object Array]"===Object.prototype.toString.call(a)}),String.prototype.startsWith||(String.prototype.startsWith=function(a,b){return b=b||0,this.indexOf(a,b)===b}),String.prototype.endsWith||(String.prototype.endsWith=function(a,b){var c=this.toString();(void 0===b||b>c.length)&&(b=c.length),b-=a.length;var d=c.indexOf(a,b);return d!==-1&&d===b}),!String.prototype.codePointAt){var c=function(a){if(null==this)throw new TypeError("String.prototype.codePointAt called on null or undefined");var b=String(this),c=b.length,d=a?Number(a):0;if(isNaN(d)&&(d=0),!(d<0||d>=c)){var e,f=b.charCodeAt(d);return f>=55296&&f<=56319&&d+1<c&&(e=b.charCodeAt(d+1),e>=56320&&e<=57343)?1024*(f-55296)+e-56320+65536:f}};Object.defineProperty?Object.defineProperty(String.prototype,"codePointAt",{enumerable:!1,configurable:!0,writable:!0,value:c}):String.prototype.codePointAt=c}window.document.elementsFromPoint||(window.document.elementsFromPoint=function(a,b){for(var c,d,e,f=[],g=[];(c=document.elementFromPoint(a,b))&&f.indexOf(c)===-1&&null!=c;)f.push(c),g.push({value:c.style.getPropertyValue("pointer-events"),priority:c.style.getPropertyPriority("pointer-events")}),c.style.setProperty("pointer-events","none","important");for(d=g.length;e=g[--d];)f[d].style.setProperty("pointer-events",e.value?e.value:"",e.priority);return f}),Object.keys||(Object.keys=function(){var a=Object.prototype.hasOwnProperty,b=!{toString:null}.propertyIsEnumerable("toString"),c=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],d=c.length;return function(e){if("object"!=typeof e&&("function"!=typeof e||null===e))throw new TypeError("Object.keys called on non-object");var f,g,h=[];for(f in e)a.call(e,f)&&h.push(f);if(b)for(g=0;g<d;g++)a.call(e,c[g])&&h.push(c[g]);return h}}());try{Boolean(SVGElement)}catch(a){window.SVGElement={},window.SVGElement.prototype={}}if(SVGElement&&SVGElement.prototype&&!("classList"in SVGElement.prototype)&&Object.defineProperty){var d=function(a,b){return!b||/\s/.test(b)?(console.warn("ClassList syntax error - an invalid or illegal string was specified"),-1):Array.prototype.indexOf.call(a,"string"==typeof b?b:b.toString())},e=function(a){var b=String.prototype.trim.call(a.getAttribute("class")||"");b&&this.push.apply(this,b.split(/\s+/)),this._setClassAttribute=function(){a.setAttribute("class",this.toString())}};e.prototype=[],e.prototype.item=function(a){return this[a]||null},e.prototype.contains=function(a){return d(this,a)!==-1},e.prototype.add=function(){for(var a=!1,b=0,c=arguments.length;b<c;b++)d(this,arguments[b])===-1&&(this.push(arguments[b]),a=!0);a&&this._setClassAttribute()},e.prototype.remove=function(){for(var a,b,c=!1,e=0,f=arguments.length;e<f;e++)for(a=arguments[e];(b=d(this,a))!==-1;)this.splice(b,1),c=!0;c&&this._setClassAttribute()},e.prototype.toggle=function(a,b){var c=this.contains(a);return c?b!==!0&&this.remove(a):b!==!1&&this.add(a),"boolean"==typeof b?b:!c},e.prototype.toString=function(){return this.join(" ")},Object.defineProperty(SVGElement.prototype,"classList",{get:function(){return new e(this)},enumerable:!0,configurable:!0})}Array.prototype.some||(Array.prototype.some=function(a){if(null==this)throw new TypeError("Array.prototype.some called on null or undefined");if("function"!=typeof a)throw new TypeError;for(var b=Object(this),c=b.length>>>0,d=arguments.length>=2?arguments[1]:void 0,e=0;e<c;e++)if(e in b&&a.call(d,b[e],e,b))return!0;return!1}),Array.prototype.every||(Array.prototype.every=function(a,b){var c,d;if(null==this)throw new TypeError("this is null or not defined");var e=Object(this),f=e.length>>>0;if("function"!=typeof a)throw new TypeError;for(arguments.length>1&&(c=b),d=0;d<f;){var g;if(d in e){g=e[d];var h=a.call(c,g,d,e);if(!h)return!1}d++}return!0}),!function(){var a;!function(a){var b=function(){function a(a,b){this.index=0,this.map=null,this.done=!1,this.map=a,this.type=b}return a.prototype.next=function(){var a;return this.map.keyArray.length>this.index?("entries"===this.type?a=[this.map.keyArray[this.index],this.map.get(this.map.keyArray[this.index])]:"keys"===this.type?a=this.map.keyArray[this.index]:"values"===this.type&&(a=this.map.get(this.map.keyArray[this.index])),this.index++):this.done=!0,{value:a,done:this.done}},a}();a.MapIterator=b}(a||(a={}));var a;!function(a){var b=function(){function a(){}return Object.defineProperty(a,"MAP_KEY_IDENTIFIER",{get:function(){return"MAP_KEY_IDENTIFIER_OZAbzyeCu3_spF91dwX14"},enumerable:!0,configurable:!0}),Object.defineProperty(a,"MAP_SET_THROWABLE_MESSAGE",{get:function(){return"Invalid value used as map key"},enumerable:!0,configurable:!0}),a}();a.MapConstants=b}(a||(a={}));var a;!function(a){var b=function(){function a(){if(null!==a.instance)throw"Get the instance of the MapSequencer using the getInstance method.";this.identifier=0}return a.getInstance=function(){return null===a.instance&&(a.instance=new a),a.instance},a.prototype.next=function(){return"Map_CJPOYUrpwK_aHBtMHXsTM"+String(this.identifier++)},a.instance=null,a}();a.MapSequencer=b}(a||(a={}));var a;!function(a){var b=function(){function b(){}return b.defineProperty=function(c){var d;if(b.isValidObject(c)===!1)throw new TypeError(a.MapConstants.MAP_SET_THROWABLE_MESSAGE);if("undefined"==typeof c[a.MapConstants.MAP_KEY_IDENTIFIER]){d=a.MapSequencer.getInstance().next();try{Object.defineProperty(c,a.MapConstants.MAP_KEY_IDENTIFIER,{enumerable:!1,configurable:!1,get:function(){return d}})}catch(b){throw new TypeError(a.MapConstants.MAP_SET_THROWABLE_MESSAGE)}}else d=c[a.MapConstants.MAP_KEY_IDENTIFIER];return d},b.getProperty=function(c){return b.isValidObject(c)===!0?c[a.MapConstants.MAP_KEY_IDENTIFIER]:void 0},b.isValidObject=function(a){return a===Object(a)},b}();a.MapUtils=b}(a||(a={}));var a;!function(a){var b=function(){function b(a){void 0===a&&(a=[]),this.map={},this.keyArray=[];for(var b=0;b<a.length;b++){var c=a[b];c&&c.length>=2&&this.set(c[0],c[1])}}return b.prototype.get=function(b){if(this.has(b)===!0){var c=a.MapUtils.getProperty(b);return void 0===c&&(c=String(b)),this.map[c]}},b.prototype.has=function(b){var c=a.MapUtils.getProperty(b);return void 0===c&&(c=String(b)),void 0!==c&&"undefined"!=typeof this.map[c]},b.prototype.delete=function(b){if(this.has(b)===!0){var c=a.MapUtils.getProperty(b);return void 0===c&&(c=String(b)),this.keyArray.splice(this.keyArray.indexOf(b),1),delete this.map[c],!0}return!1},b.prototype.set=function(b,c){this.delete(b);var d;try{d=String(a.MapUtils.defineProperty(b))}catch(a){d=String(b)}this.keyArray.push(b),this.map[d]=c},b.prototype.entries=function(){return new a.MapIterator(this,"entries")},b.prototype.keys=function(){return new a.MapIterator(this,"keys")},b.prototype.values=function(){return new a.MapIterator(this,"values")},b.prototype.forEach=function(a,b){for(var c=0,d=this.keyArray;c<d.length;c++){var e=d[c];b?a.call(b,this.get(e),e,this):a(this.get(e),e,this)}},b.prototype.clear=function(){this.map={},this.keyArray=[]},b}();a.Map=b}(a||(a={}));var a;!function(a){window.Map||(window.Map=a.Map)}(a||(a={}))}()}(),angular.module("filter",[]),angular.module("services",[]),angular.module("directives",["templates-common"]),angular.module("statesDep",["services","directives","config","templates-app","pascalprecht.translate","filter"]),angular.module("mybooks",["statesDep"]),angular.module("myaudiobooks",["statesDep"]),angular.module("home",["statesDep"]),angular.module("country",["statesDep"]),angular.module("reseller",["statesDep"]),angular.module("search",["statesDep"]),angular.module("sorry",["statesDep"]),angular.module("help",["statesDep"]),angular.module("account",["statesDep"]),angular.module("epub",["statesDep"]),angular.module("pdf",["statesDep"]),angular.module("comic",["statesDep"]),angular.module("audio",["statesDep"]),angular.module("download",["statesDep"]),angular.module("read",["statesDep"]),angular.module("states",["country","reseller","home","mybooks","myaudiobooks","sorry","help","account","epub","pdf","comic","audio","search","read","download"]);var app=angular.module("app",["ui.router","states","config","pascalprecht.translate"]);angular.element(document).ready(function(){angular.bootstrap(document,["app"])}),app.config(["$provide","$qProvider","$locationProvider","$compileProvider","$stateProvider","$urlMatcherFactoryProvider","$urlRouterProvider","$translateProvider",function(a,b,c,d,e,f,g,h){"use strict";a.decorator("$q",["$delegate",function(a){var b=a;return b.allComplete=function(a){if(!angular.isArray(a))throw new Error("$q.allComplete only accepts an array.");var c=b.defer(),d=0,e=0,f=[],g=[];return angular.forEach(a,function(b){b.then(function(a){d++,f.push(a)}).catch(function(a){e++,g.push(a)}).finally(function(){d+e===a.length&&(e>0?c.reject({success:f,fail:g}):c.resolve({success:f,fail:g}))})}),c.promise},b}]),d.debugInfoEnabled(!1),h.useStaticFilesLoader({prefix:"locales/",suffix:".json"}),h.useSanitizeValueStrategy("escape"),c.hashPrefix(""),b.errorOnUnhandledRejections(!0),f.caseInsensitive(!0),f.strictMode(!1),window.localforage.config({name:"offline",version:1,storeName:"twBlob",description:"Blob Storage"}),window.infoforage=window.localforage.createInstance({driver:"localStorageWrapper",name:"infostore",version:1,storeName:"twMeta",description:"Metainfo Storage"}),window.fdp=window.fastdom.extend(window.fastdomPromised);for(var i=[{name:"home",url:"/home",templateUrl:"../states/home/home.tpl.html"},{name:"mybooks",url:"/mybooks",redirectTo:"mybooks.titles",templateUrl:"../states/mybooks/mybooks.tpl.html"},{name:"myaudiobooks",url:"/myaudiobooks",redirectTo:"myaudiobooks.titles",templateUrl:"../states/mybooks/mybooks.tpl.html"},{name:"mybooks.authors.titles",url:"/authors/titles?name&id",parent:"mybooks",templateUrl:"../states/mybooks/authors/titles/titles.tpl.html"},{name:"myaudiobooks.authors.titles",url:"/authors/titles?name&id",parent:"myaudiobooks",templateUrl:"../states/mybooks/authors/titles/titles.tpl.html"},{name:"mybooks.selection",parent:"mybooks",params:{action:void 0,deliverables:void 0,ref:void 0},templateUrl:"../states/mybooks/selection/selection.tpl.html"},{name:"myaudiobooks.selection",parent:"myaudiobooks",params:{action:void 0,deliverables:void 0,ref:void 0},templateUrl:"../states/mybooks/selection/selection.tpl.html"},{name:"mybooks.authors.selection",parent:"mybooks",params:{action:void 0,name:void 0,deliverables:void 0,ref:void 0},templateUrl:"../states/mybooks/selection/selection.tpl.html"},{name:"myaudiobooks.authors.selection",parent:"myaudiobooks",params:{action:void 0,name:void 0,deliverables:void 0,ref:void 0},templateUrl:"../states/mybooks/selection/selection.tpl.html"},{name:"mybooks.default",abstract:!0,parent:"mybooks",templateUrl:"../states/mybooks/default.tpl.html"},{name:"myaudiobooks.default",abstract:!0,parent:"myaudiobooks",templateUrl:"../states/mybooks/default.tpl.html"},{name:"mybooks.authors",parent:"mybooks.default",url:"/authors",templateUrl:"../states/mybooks/authors/authors.tpl.html"},{name:"myaudiobooks.authors",parent:"myaudiobooks.default",url:"/authors",templateUrl:"../states/mybooks/authors/authors.tpl.html"},{name:"mybooks.titles",url:"/titles",parent:"mybooks.default",templateUrl:"../states/mybooks/titles/titles.tpl.html"},{name:"myaudiobooks.titles",url:"/titles",parent:"myaudiobooks.default",templateUrl:"../states/mybooks/titles/titles.tpl.html"},{name:"mybooks.collections",url:"/collections",parent:"mybooks.default",params:{action:void 0},templateUrl:"../states/mybooks/collections/collections.tpl.html"},{name:"myaudiobooks.collections",url:"/collections",parent:"myaudiobooks.default",templateUrl:"../states/mybooks/collections/collections.tpl.html"},{name:"mybooks.collections.titles",url:"/collections/titles?name",parent:"mybooks",params:{action:void 0},templateUrl:"../states/mybooks/collections/titles/titles.tpl.html"},{name:"myaudiobooks.collections.titles",url:"/collections/titles?name",parent:"myaudiobooks",params:{action:void 0},templateUrl:"../states/mybooks/collections/titles/titles.tpl.html"},{name:"mybooks.collections.selection",parent:"mybooks",params:{action:void 0,singleSelect:void 0},templateUrl:"../states/mybooks/collections/selection/collections-selection.tpl.html"},{name:"myaudiobooks.collections.selection",parent:"myaudiobooks",params:{action:void 0,singleSelect:void 0},templateUrl:"../states/mybooks/collections/selection/collections-selection.tpl.html"},{name:"details",reloadOnSearch:!1,url:"/details?id&state&name",templateUrl:"../states/mybooks/details/details.tpl.html"},{name:"reseller",templateUrl:"../states/reseller/reseller.tpl.html"},{name:"country",templateUrl:"../states/country/country.tpl.html"},{name:"search",redirectTo:"search.books",params:{searchTerm:void 0},templateUrl:"../states/search/search.tpl.html"},{name:"search.books",parent:"search",templateUrl:"../states/search/books/books.tpl.html"},{name:"search.audio",parent:"search",templateUrl:"../states/search/audio/audio.tpl.html"},{name:"sorry",templateUrl:"../states/sorry/sorry.tpl.html",controller:"SorryCtrl",params:{type:void 0,headline:void 0,message:void 0,details:void 0}},{name:"help",url:"/help",templateUrl:"../states/help/help.tpl.html"},{name:"account",url:"/account",templateUrl:"../states/account/account.tpl.html"},{name:"read",url:"/read?id",templateUrl:"../states/read/read.tpl.html"},{name:"download",url:"/download?id",templateUrl:"../states/download/download.tpl.html"},{name:"epub",url:"/epub?id",templateUrl:"../states/epub/epub.tpl.html"},{name:"pdf",url:"/pdf?id",templateUrl:"../states/pdf/pdf.tpl.html"},{name:"audio",url:"/audio?id",templateUrl:"../states/audio/audio.tpl.html"},{name:"comic",url:"/comic?id",templateUrl:"../states/comic/comic.tpl.html"}],j=0;j<i.length;j++)e.state(i[j]);g.otherwise(function(a){var b=a.get("$state");b.go("home")})}]),app.run(["$window","$rootScope","$location","$translate","$state","stateHelper","appState","reseller","theme","CONFIG",function(a,b,c,d,e,f,g,h,i,j){"use strict";a.tw.setDebugInfo=function(b){try{return a.tw.debugInfo=b,console.info("debug info set!"),!0}catch(b){console.warn("debug info NOT set! "+b),delete a.tw.debugInfo}},a.tw.unsetDebugInfo=function(){delete a.tw.debugInfo};var k=function(a){return j.globals.LANGUAGES.filter(function(b){return b.id===a}).length>0},l=c.search(),m=a.Modernizr.sessionstorage&&a.sessionStorage.getItem("lang")||l&&l.lang;m&&a.sessionStorage.removeItem("lang");var n=m||g.fetch("lang");n&&k(n)||(console.warn('Requested language "'+n+'" currently not supported! Falling back to de_DE'),n="de_DE"),d.use("locale-"+n),a.Modernizr.sessionstorage&&g.save("lang",n);var o=h.getReseller()&&h.getReseller().resellerId,p=o&&h.convertFromId(o),q=i.isSetByUser(),r=i.getActiveThemeName(),s=i.getActiveVariantName(),t=i.getActiveUIFontName();if(q&&r&&s)i.setVariantByName(s,r);else{var u=i.getResellerThemeInfo(o);u?i.setVariantByName(u.variant,u.theme):i.setVariantByName("default","default")}t?i.setUIFontByName(t):i.setUIFontByName("fira"),p&&j.globals.ONEAPP_SPALTER.indexOf(p)>-1?h.fetchConfig().then(function(a){b.translatedAppName=a.STRING_BRAND_DISPLAY_NAME+" WebReader",b.faviconResellerId=p}):(b.translatedAppName="tolino WebReader",b.faviconResellerId="tolinode"),b.$on("$stateChangeStart",f.platformPrerequsitesValid),Modernizr.isfirefox&&angular.element(a).bind("pageshow",function(b){b.persisted===!0&&a.location.reload()}),"serviceWorker"in navigator&&navigator.serviceWorker.register("offline.worker.js?version="+encodeURIComponent(a.tw.githash)).catch(function(a){console.log("Registration failed with "+a)});var v=function(a,b){var c={id:b,state:e.current.name,name:e.params.name};return f.setAsKeyState(),f.goToState("details",c)};b.$on("tw.library.details",v),b.$on("$stateChangeStart",f.handleStateChangeStart),b.$on("$stateChangeSuccess",f.handleStateChangeSuccess),b.isSampleReader=!1,svg4everybody()}]),angular.module("filter").filter("trustUrl",["$sce",function(a){"use strict";return function(b){return a.trustAsResourceUrl(b)}}]),angular.module("filter").filter("ampersand",function(){return function(a){return a?a.replace(/&amp;/,"&"):""}}),gettext("COLLECTION_FINISHED_READINGS_NAME"),angular.module("services").service("AESDecrypt",function(){"use strict";if(!window.Int32Array||!window.Uint8Array)throw"Support for typed arrays required";var a,b,c=256,d=new Int32Array(new ArrayBuffer(4*c)),e=new Int32Array(new ArrayBuffer(4*c)),f=new Int32Array(new ArrayBuffer(4*c)),g=new Int32Array(new ArrayBuffer(4*c)),h=new Uint8Array(new ArrayBuffer(c)),i=new Uint8Array(new ArrayBuffer(c));!function(){for(var a,b,c,j,k,l,m,n=[],o=[],p=0;p<256;p++)o[(n[p]=p<<1^283*(p>>7))^p]=p;for(a=b=0;!h[a];a^=c||1,b=o[b]||1)l=b^b<<1^b<<2^b<<3^b<<4,l=l>>8^255&l^99,h[a]=l,i[l]=a,k=n[j=n[c=n[a]]],m=16843009*k^65537*j^257*c^16843008*a,d[l]=m=m<<24^m>>>8,e[l]=m=m<<24^m>>>8,f[l]=m=m<<24^m>>>8,g[l]=m=m<<24^m>>>8}();var j=function(a,b,c){a[b++]=c>>>24&255,a[b++]=c>>16&255,a[b++]=c>>8&255,a[b]=255&c};this.setDecryptionKey=function(c){var i=c.length;if(4!==i&&6!==i&&8!==i)throw"Invalid AES key size";var j=4*i+28,k=new Int32Array(new ArrayBuffer(4*j));a=new Int32Array(new ArrayBuffer(4*j)),b=i+5;var l,m,n,o,p=1;for(l=0;l<i;l++)k[l]=c[l];for(l=i;l<j;l++)n=k[l-1],(l%i===0||8===i&&l%i===4)&&(n=h[n>>>24]<<24^h[n>>16&255]<<16^h[n>>8&255]<<8^h[255&n],l%i===0&&(n=n<<8^n>>>24^p<<24,p=p<<1^283*(p>>7))),o=k[l-i]^n,k[l]=o;for(m=0;l;m++,l--)n=k[3&m?l:l-4],o=l<=4||m<4?n:d[h[n>>>24]]^e[h[n>>16&255]]^f[h[n>>8&255]]^g[h[255&n]],a[m]=o},this.decrypt=function(c,h,k){var l,m,n,o,p=a,q=k,r=(c[q++]<<24|c[q++]<<16|c[q++]<<8|c[q++])^p[0],s=(c[q++]<<24|c[q++]<<16|c[q++]<<8|c[q++])^p[3],t=(c[q++]<<24|c[q++]<<16|c[q++]<<8|c[q++])^p[2],u=(c[q++]<<24|c[q++]<<16|c[q++]<<8|c[q++])^p[1];for(q=0,o=4;q<b;q++)l=d[r>>>24&255]^e[u>>16&255]^f[t>>8&255]^g[255&s]^p[o++],m=d[u>>>24&255]^e[t>>16&255]^f[s>>8&255]^g[255&r]^p[o++],n=d[t>>>24&255]^e[s>>16&255]^f[r>>8&255]^g[255&u]^p[o++],s=d[s>>>24&255]^e[r>>16&255]^f[u>>8&255]^g[255&t]^p[o++],r=l,u=m,t=n;j(h,k+0,i[r>>>24]<<24^i[u>>16&255]<<16^i[t>>8&255]<<8^i[255&s]^p[o++]),j(h,k+12,i[u>>>24]<<24^i[t>>16&255]<<16^i[s>>8&255]<<8^i[255&r]^p[o++]),j(h,k+8,i[t>>>24]<<24^i[s>>16&255]<<16^i[r>>8&255]<<8^i[255&u]^p[o++]),j(h,k+4,i[s>>>24]<<24^i[r>>16&255]<<16^i[u>>8&255]<<8^i[255&t]^p[o])}}),angular.module("services").service("base64",function(){"use strict";var a=function(a){a=a.replace(/\r\n/g,"\n");for(var b="",c=0;c<a.length;c++){var d=a.charCodeAt(c);d<128?b+=String.fromCharCode(d):d>127&&d<2048?(b+=String.fromCharCode(d>>6|192),b+=String.fromCharCode(63&d|128)):(b+=String.fromCharCode(d>>12|224),b+=String.fromCharCode(d>>6&63|128),b+=String.fromCharCode(63&d|128))}return b};this.decodeString=function(a,b){if(a.length%4===2?a+="==":a.length%4===1&&(a+="="),a.length%4)throw new Error("Length of b64-encoded data must be zero mod four "+a);for(var c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",d="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",e=b?d:c,f={},g=0,h=e.length;g<h;g++)f[e.charAt(g)]=g;var i=[];for(g=0;g<a.length;){var j=f[a.charAt(g)],k=f[a.charAt(g+1)],l=f[a.charAt(g+2)],m=f[a.charAt(g+3)];if(void 0===j||void 0===k||void 0===l||void 0===m)throw new Error("String contains characters not in our alphabet: "+a+" maybe You should set WebSet flag");var n=j<<2|k>>4;if(i.push(n),64!==l){var o=k<<4&240|l>>2;if(i.push(o),64!==m){var p=l<<6&192|m;i.push(p)}}g+=4}return i},this.encodeString=function(b){if(window.btoa)return window.btoa(b);var c,d,e,f,g,h,i,j="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",k="",l=0;for(b=a(b);l<b.length;)c=b.charCodeAt(l++),d=b.charCodeAt(l++),e=b.charCodeAt(l++),f=c>>2,g=(3&c)<<4|d>>4,h=(15&d)<<2|e>>6,i=63&e,isNaN(d)?h=i=64:isNaN(e)&&(i=64),k=k+j.charAt(f)+j.charAt(g)+j.charAt(h)+j.charAt(i);return k}}),angular.module("services").service("BaseUtil",["$q","$rootScope","$window","$injector","$timeout","CONFIG",function(a,b,c,d,e,f){"use strict";var g=function(b){return a.resolve(b)},h=function(a){for(var b,d=c.document.getElementsByTagName("script"),e=0;e<d.length;e++){var g=d.item(e)&&d.item(e).src;if(g&&g.indexOf(f.globals.MISC.PATH_TO_WORKER)>-1){var h=new RegExp(f.globals.MISC.PATH_TO_WORKER+"(.*?)$","i");b=g.toString().replace(h,a),b+="?revision="+c.tw.githash}}return b||(b="src/worker/"+a+"?revision="+c.tw.githash),b},i=function(){var a=c.navigator.userAgent.match(/Webkit|Chrome|Gecko|Trident|Presto|Blink/i);return a&&a[0].toLowerCase()||"unknown"},j=function(a){return a&&/^-?[_a-zA-Z]+[_a-zA-Z0-9-]*$/.test(a)},k=function(a){return a.replace(/-([a-z])/g,function(a,b){return b.toUpperCase()})},l=function(a,b){var c=a.charAt(0).toUpperCase()+k(a.slice(1)),d=document.createElement("div").style,e={Webkit:"-webkit-",Moz:"-moz-",ms:"-ms-",O:"-o-",Khtml:"-khtml-"};for(var f in e)if(f+c in d)return b?e[f]+a:f+c;return a},m=function(a,b){return a=window.Modernizr.prefixed(a),a.startsWith("WebKit")&&"w"+a.substr(1)+b.substr(0,1).toUpperCase()+b.substr(1)||a.startsWith("ms")&&"MS"+a.substr(2)+b.substr(0,1).toUpperCase()+b.substr(1)||a+b},n=function(a){function b(a){if(a&&!a.disabled){var b=a.media&&a.media.mediaText;if(!b||window.matchMedia(b).matches)try{var c=a.cssRules;return Array.prototype.slice.call(c)}catch(a){return[]}}return[]}var c=[],d=a.ownerDocument,e=Element.prototype.matches||Element.prototype.webkitMatchesSelector||Element.prototype.mozMatchesSelector||Element.prototype.msMatchesSelector||function(a){return[].indexOf.call(d.querySelectorAll(a),this)>=0};return Array.prototype.forEach.call(d.styleSheets,function(d){for(var f,g=b(d);f=g.shift();)if(f.styleSheet)g=b(f.styleSheet).concat(g);else if(f.media)g=b(f).concat(g);else if(f.type!==CSSRule.PAGE_RULE&&f.selectorText)try{e.call(a,f.selectorText)&&c.push(f)}catch(a){console.warn(a)}}),c},o=function(a,b){for(var c=0;c<b.length;c++){var d=b[c].style[a];if(d)return d}return null},p=function(a){var b=document.createNodeIterator(a,NodeFilter.SHOW_TEXT,function(a){return a.length>0?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT},!1),c=b.nextNode();return b.detach(),c},q=function(a){var b,c,d=v(a)?a:p(a);if(d&&d.length>0){var e=B(d,0,Math.min(2,d.length));if(e){var f=e.getBoundingClientRect();b=f.height}}return b||(c=s(a,"font-size")||0,b=1.2*c),b},r=function(a){var b=window.location.protocol+"//"+window.location.host,c=window.location.pathname.split("/");return c.pop(),b+c.join("/")+"/"+(a||"")},s=function(a,b){var c,d,e="lineHeight"===b||"line-height"===b;if(!a)return 0;if(v(a))return e?q(a):0;a.nodeType!==Node.DOCUMENT_NODE&&a.nodeType!==Node.DOCUMENT_FRAGMENT_NODE||(a=a.body||document.body),window.getComputedStyle?(d=document.defaultView.getComputedStyle(a,null),c=d&&(d[b]||d.getPropertyValue(b))):a.currentStyle?c=a.currentStyle[b]:document.all&&(c=document.all.node.style[b]);var f=parseFloat(c,10);return e?"normal"===c?q(a):Math.max(f,0):isNaN(f)?c||0:f},t=function(a,b,c,d){var e,f=[];for(void 0===d&&(d=1);a&&d--;)a.style.display="none",f.push(a),a=e=document.elementFromPoint(b,c);for(;a=f.pop();)a.style.display="";return e},u=function(a,b,c){a&&b&&(c?a.classList.add(b):a.classList.remove(b))},v=function(a){return!!a&&a.nodeType===Node.TEXT_NODE},w=function(a){return a&&a.hasAttribute&&a.hasAttribute("data-meta")},x=function(a){return a&&a.getAttribute&&a.getAttribute("data-meta")},y=function(a){return w(a)&&(v(a.previousSibling)||v(a.nextSibling))},z=function(a){return v(a)&&w(a.previousSibling)},A=function(a){for(var b,c=a.parentNode;null!==(b=a.firstChild);)c.insertBefore(b,a);c.removeChild(a),c.normalize()},B=function(a,b,c){if(!a||!a.parentNode)return null;var d=document.createRange();return void 0!==b&&a.nodeType===Node.TEXT_NODE&&a.length>1?(c=c||a.length-1,b>=c&&(b=c-1),d.setStart(a,b),d.setEnd(a,c)):d.selectNode(a),d},C=function(a){var b=a&&a.getSelection&&a.getSelection()||document.getSelection(),c=b&&b.rangeCount>0&&b.getRangeAt(0);return c&&!c.collapsed?c:null},D=function(a,b,c){if(!a||a.nodeType!==Node.TEXT_NODE)return null;var d=B(a,b,c),e=null;if(d&&(e=d.getBoundingClientRect())){var f=d.getClientRects()[0];e.lineHeight=f?f.height:0}return e},E=window.Modernizr.hasvalidmulticolmetrics?function(a){return a&&a.getBoundingClientRect&&a.getBoundingClientRect()||v(a)&&D(a)||null}:function(a){if(a){if(a.nodeType===Node.TEXT_NODE)return D(a);if(a.nodeType===Node.ELEMENT_NODE){var b,c=a.getBoundingClientRect(),d=getComputedStyle(a);if("inline"!==d.display)return c;var e=c.top,f=c.left;do a=a.offsetParent,a&&a.nodeType===Node.ELEMENT_NODE&&(b=a.getBoundingClientRect(),d=getComputedStyle(a),e+=b.top-parseFloat(d.marginTop,10),f+=b.left-parseFloat(d.marginLeft,10));while(a&&"inline"===d.display);return{top:e,left:f,bottom:e+c.height,right:f+c.width,width:c.width,height:c.height}}}return null},F={},G=function(a,b){if(a){var c=a.name||a.toString(),d=this,f=arguments;F[c]&&e.cancel(F[c]),F[c]=e(function(){F[c]=null,a.apply(d,f)},b)}},H=function(a,b){var c;return function(){var d=this,f=arguments;return c&&e.cancel(c),c=e(function(){return c=null,a.apply(d,f)},b)}},I=function(a,b,c){var d,e,f,g=Date.now||Date.prototype.getTime.bind(new Date),h=null,i=0,j=!c||c.leading!==!1,k=!c||c.trailing!==!1,l=function(){i=j?g():0,h=null,f=a.apply(d,e),d=e=null};return function(){var c=g();
i||j||(i=c);var m=b-(c-i);return d=this,e=arguments,m<=0?(clearTimeout(h),h=null,i=c,f=a.apply(d,e),d=e=null):!h&&k&&(h=setTimeout(l,m)),f}},J=function(a){var b=a.style.cssText;a.style.cssText+=";-webkit-transform:rotateZ(0deg); transform:rotateZ(0deg);";var c=a.offsetHeight;return a.style.cssText=b,c},K=function(a,b){if(a&&(a.querySelectorAll("parsererror").length>0||0===a.childNodes.length)){var c=a.querySelector("parsererror > div"),d="Parser Error "+(b?'in file "'+b+'" -':"-");return console.warn(d,c&&c.textContent),console.trace(),{message:d+c&&c.textContent,reason:"PARSER_ERROR"}}return!1},L=function(a,b){if(b&&!("addEventListener"in document))return!1;var c="on"+a,d=c in document;if(!d){var e=document.createElement("div");e.setAttribute(c,"return;"),d="function"==typeof e[c]}var f=!1;return!d&&f&&"wheel"===a&&(d=document.implementation.hasFeature("Events.wheel","3.0")),d},M=function(a){return a&&null!==a&&"null"!==a&&a!==!1&&"false"!==a},N=function(a){var b=d.get("user");return!!b.isLoggedIn()&&(!a||!(a.bookmark&&a.bookmark.modified>0)&&(!(a.dogears&&a.dogears.length>0)&&(!(a.comments&&a.comments.length>0)&&(!(a.tags&&a.tags.length>0)||!a.tags.some(function(a){return a.name===f.globals.STORE.TAG_FINISHED_READINGS})))))},O=function(){var a=window.tw.version;return a?(a.startsWith("v")&&(a=a.substring(1,a.length)),a=a.split("_")[0]):null},P=function(b){var c=d.get("inventory");return c.deliverables[b]?a.resolve(c.deliverables[b]):c.fetchLocalPublications().then(function(){return c.deliverables[b]?c.deliverables[b]:c.fetchPublications().then(function(){return c.deliverables[b]?c.deliverables[b]:a.reject(f.globals.ERROR.APP_NO_DELIVERABLE)})})};return{isNew:N,isEventSupported:L,getResolvedPromise:g,getBrowserEngine:i,isValidClassToken:j,getVendorPropertyName:l,getPrefixedEventName:m,getMatchedCSSRules:n,getCascadedStyle:o,getLocationURL:r,getComputedStyle:s,getElementBelow:t,setClass:u,isTextNode:v,isMetaNode:w,getMetaAttribute:x,isNewMetaNode:y,isSplittedTextNode:z,unwrapNode:A,getRange:B,getSelectedRange:C,getTextBoundingBox:D,getBoundingBox:E,debounce:G,getDebouncedFunction:H,throttle:I,forceRepaint:J,checkParserError:K,getWorkerSource:h,isNotNullValueFromOneRC:M,getAppVersionNumber:O,fetchDeliverable:P}}]),angular.module("services").service("ByteArray",function(){"use strict";var a;try{String.fromCharCode.apply(null,new Uint8Array(new ArrayBuffer(1))),a=!0}catch(b){a=!1}var b=65536,c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",d=function(a){return a&&239===a[0]&&187===a[1]&&191===a[2]},e=function(a,c,d){var e,f,g="",h=a&&a.subarray||Array.prototype.slice;void 0===d&&(d=a&&a.length||0);for(var i=c||0;i<d;i+=b)e=Math.min(i+b,d),f=h.call(a,i,e),g+=String.fromCharCode.apply(null,f);return g};this.isArrayBuffer=function(a){return"[object ArrayBuffer]"===Object.prototype.toString.call(a)},this.hasUTF16ByteOrderMark=function(a){return a&&(255===a[0]&&254===a[1]||254===a[0]&&255===a[1])},this.asNumber=function(a){for(var b=0,c=a.length-1;c>=0;c--){var d=a[c];b=(b<<8)+(d<0?d+256:d)}return b},this.asString=function(b){var c=d(b)?3:0;if(a)return e(b,c);for(var f=b.length,g=new Array(f),h=c;h<f;h++)g[h]=b[h];return e(g,c)},this.asPackedString=function(b){var c=b.length,d=c+1>>1,f=a?new Uint16Array(new ArrayBuffer(2*d)):new Array(d);d=0;for(var g=0;g<c;)f[d++]=(255&b[g++])<<8|255&b[g++];return e(f)},this.unpackString=function(a){for(var b,c=a.length,d=new Uint8Array(new ArrayBuffer(2*c)),e=0,f=0;f<c;f++)b=a.charCodeAt(f),d[e++]=b>>>8,d[e++]=255&b;return d.buffer},this.unpackStringToBuffer=function(a,b,c){var d,e=a.length;void 0===c&&(c=0);for(var f=0;f<e;f++)d=a.charCodeAt(f),b[c++]=d>>>8,b[c++]=255&d;return c};var f="function"==typeof window.TextDecoder?new TextDecoder("utf-8"):null,g="function"==typeof window.TextDecoder?new TextDecoder("utf-16"):null;this.asUTF8String=f?function(a){return f.decode(a)}:function(b){for(var c,f,g=d(b)?3:0,h=b&&b.length||0,i=0,j=a?new Uint16Array(new ArrayBuffer(2*h)):new Array(h);g<h;g++)c=b[g],c<128?j[i++]=c:c>=194&&c<224?j[i++]=((31&c)<<6)+(63&b[++g]):c>=224&&c<240?j[i++]=((255&c)<<12)+((63&b[++g])<<6)+(63&b[++g]):c>=240&&c<245&&(f=((7&c)<<18)+((63&b[++g])<<12)+((63&b[++g])<<6)+(63&b[++g])-65536,j[i++]=(f>>10)+55296,j[i++]=(1023&f)+56320);return e(j,0,i)},this.asUTF16String=g?function(a){return g.decode(a)}:function(b){var c=0,d=1,f=0;254===b[0]&&255===b[1]?(c=2,d=0,f=1):255===b[0]&&254===b[1]&&(c=2);for(var g=0,h=b.length,i=a?new Uint16Array(new ArrayBuffer(h)):new Array(Math.ceil(h/2));c<h;c+=2)i[g++]=(b[c+d]<<8)+b[c+f];return e(i,0,g)},this.asBase64=function(a){if(window.btoa)return btoa(e(a));for(var b,f,g,h,i,j=d(a)?3:0,k=[],l=a?a.length:0,m=l%3,n=l-m;j<n;j+=3)i=a[j]<<16|a[j+1]<<8|a[j+2],b=(16515072&i)>>18,f=(258048&i)>>12,g=(4032&i)>>6,h=63&i,k.push(c[b],c[f],c[g],c[h]);return m>0&&(1===m?(i=a[n],b=(252&i)>>2,f=(3&i)<<4,g=64):(i=a[n]<<8|a[n+1],b=(16128&i)>>8,f=(1008&i)>>4,g=(15&i)<<2),k.push(c[b],c[f],c[g],c[64])),k.join("")}}),angular.module("services").service("Crypto",["ByteArray","StringUtil","AESDecrypt",function(a,b,c){"use strict";var d,e=[101,9,10,11,12,0,14,22,16,245,18,35,10,0,22,100],f=function(a){var b="";return a<16&&(b="0"),b+a.toString(16)},g=function(a){for(var b=new Array(4),c=0,d=0;c<16;c+=4)b[d++]=a[c]<<24|a[c+1]<<16|a[c+2]<<8|a[c+3];return b},h=function(a){var b=a.length;if(b%16!==0)throw"Invalid AES block length";for(var d=new Uint8Array(new ArrayBuffer(b)),e=c.decrypt,f=0;f<b;f+=16)e(a,d,f);return d},i=function(a,b){var d=b.length;if(d%16!==0)throw"Invalid AES block length";var e,f=new Uint8Array(new ArrayBuffer(d)),g=c.decrypt,h=0,i=0;for(g(b,f,h);h<16;)f[h++]^=a[i++];for(i=0;h<d;)for(g(b,f,h),e=h+16;h<e;)f[h++]^=b[i++];return j(f)},j=function(a){var b=a.length,c=a[b-1];return a.subarray(0,b-c)},k=function(a){return c.setDecryptionKey(g(d)),h(a)};this.setDeviceKey=function(a){a||console.warn("setDeviceKey: Device key required");var f=b.decodeString(a);c.setDecryptionKey(g(e)),d=h(f)},this.decryptContent=function(b,e,f){d||console.warn("decryptContent: Device key not set!");var h=k(b);c.setDecryptionKey(g(h));var j=i(e,f);return a.asUTF8String(j)},this.decryptPassword=function(a){d||console.warn("decryptContent: Device key not set!");for(var b=k(a),c=b.length,e="",g=0;g<c;g++)e+=f(b[g]);return e}}]),angular.module("services").service("dateTime",function(){"use strict";var a=function(a){var b,c=/^(\d{4})-?(\d{2})-?(\d{2})T(\d{2}):?(\d{2})(?::(\d{2})(?:\.(\d{3}))?)?(?:(Z)|([+\-])(\d{2})(?::(\d{2}))?)?/;if(null!==(b=c.exec(a))){var d=+b[1]||(new Date).getUTCFullYear(),e=+b[2]-1||0,f=+b[3]||1,g=+b[4]||0,h=0;"Z"!==b[8]&&void 0!==b[9]&&(h=60*(+b[10]||0)+(+b[11]||0));var i=(+b[5]||0)+("+"===b[9]?-h:h),j=+b[6]||0;return Date.UTC(d,e,f,g,i,j)||0}return parseInt(a,10)||0},b=function(a){var b=void 0!==a?new Date(parseInt(a,10)):new Date;return b.getTime()},c=function(a,b,c){var d=void 0!==a?new Date(parseInt(a,10)):new Date,e=function(a){return a<10?"0"+a:a};return isNaN(d.getUTCFullYear())&&(d=new Date),"boolean"!=typeof b&&(b=!0),"string"!=typeof c&&(c="-"),d.getUTCFullYear()+c+e(d.getUTCMonth()+1)+c+e(d.getUTCDate())+"T"+e(d.getUTCHours())+":"+e(d.getUTCMinutes())+":"+e(d.getUTCSeconds())+(b?"."+("00"+d.getUTCMilliseconds()).substr(-3):"")+"Z"};return{parseTimestamp:a,getUTCTimestamp:b,getTimestampAsUTCString:c}}),angular.module("services").service("FileUtil",function(){"use strict";var a={"%21":"!","%28":"(","%29":")",",":"%2C",":":"%3A",";":"%3B","=":"%3D","?":"%3F","@":"%40"},b=/%[0-9a-f]{2}/g,c=/[^0-9a-zA-Z]/gi,d=/%[0-9A-F]{2}|%u[0-9A-F]{4}/i,e=function(a){return a.replace(b,function(a){return a.toUpperCase()})};this.resolveRelativePath=function(a,b){if(!a)return"";"string"!=typeof b&&(b="");var c,d,f,g,h=b.indexOf("/")>=0||!b?"/":"\\",i=b.lastIndexOf(h);i>0?(c=b.substring(0,i),g=b.substring(i+1),d=c.split(h)):(d=[],g=""),a.startsWith("#")&&(a=g+a),f=a.split(h);for(var j=0,k=f.length;j<k;j++)switch(f[j]){case".":break;case"..":d.pop();break;case"~":break;default:d.push(f[j])}var l=d.join(h);return e(this.escapeFileName(l))},this.sanitizeFileName=function(a){return a?a.replace(c,"-"):""},this.escapeFileName=function(b){if(!d.test(b))try{b=encodeURI(b)}catch(a){console.warn(a,b)}for(var c in a)a.hasOwnProperty(c)&&(b=b.replace(new RegExp("\\"+c,"g"),a[c]));return b}}),angular.module("services").service("hardwareHelper",["$window",function(a){"use strict";var b="x",c="h",d="x",e="-",f="NOT_AVAILABLE",g={windows:1,macos:2,linux:3},h={windows:"Microsoft Windows",macos:"Apple Mac OS",linux:"Linux"},i={webkit:1,webkitgeckochrome:2,gecko:3,presto:4,trident:5,webkitgeckochromeedge:6},j={chrome:10,chromesafari:11,firefox:20,trident:30,chromesafariedge:31,safari:40,opera:50},k={chrome:"Google Chrome",chromesafari:"Google Chrome",chromesafariedge:"Microsoft Edge",firefox:"Mozilla Firefox",trident:"Microsoft Internet Explorer",safari:"Apple Safari",opera:"Opera"},l=function(){var b=/windows|Mac OS|linux/gi,c=a.navigator.userAgent.match(b);return c?c.toString().toLowerCase().replace(/[, ]+/g,"").trim():null},m=function(){var b=/Webkit|Chrome|Gecko|Trident|Presto|Blink|Edge/gi,c=a.navigator.userAgent.match(b);return c?c.toString().toLowerCase().replace(/[, ]+/g,"").trim():null},n=function(){var b=/Chrome|Safari|Firefox|Trident|Opera|Edge/gi,c=a.navigator.userAgent.match(b);return c?c.toString().toLowerCase().replace(/[, ]+/g,"").trim():null},o=function(){var b,c=n();if(c&&(["chrome","chromesafari"].indexOf(c)>-1?b=/(?:chrome)\/(\d+(\.\d+)?)/i:["firefox"].indexOf(c)>-1?b=/(?:firefox)[ \/](\d+(\.\d+)?)/i:["trident"].indexOf(c)>-1?b=/(?:msie )(\d+(\.\d+)?)/i:["safari"].indexOf(c)>-1?b=/version\/(\d+(\.\d+)?)/i:["opera"].indexOf(c)>-1?b=/(?:opera)[\s\/](\d+(\.\d+)?)/i:["chromesafariedge"].indexOf(c)>-1&&(b=/(?:edge)[\s\/](\d+(\.\d+)?)/i),b)){var d=a.navigator.userAgent.match(b);if(d)return RegExp.$1}return null},p=function(a){var b=a.charCodeAt(a.length-1);return b>=103&&b<=118?b%103+1:-1},q=function(){var b=a.document.createElement("canvas"),c=b.getContext("2d"),d="www.tolino.de";return c.textBaseline="top",c.font="14px 'Arial'",c.textBaseline="alphabetic",c.fillStyle="#E20074",c.fillRect(15,1,62,20),c.fillStyle="#069",c.fillText(d,2,15),c.fillStyle="rgba(226, 0, 116, 0.7)",c.fillText(d,4,17),b.toDataURL()},r=function(a){var c=16*Math.random()|0,d=a===b?c:3&c|8;return d.toString(16)},s=function(){var a=l(),b=m(),f=n(),h=parseInt(o(),10),k=g[a]||d,p=i[b]||d,q=j[f]||d+d,s=h<10?"0"+h:h,t=""+k+p+q+d+e+s+d+d+d+e+d+d+d+d+d+e+d+d+d+d+d+e+d+d+d+d+c;return t.replace(/[x]/g,r)},t=function(a){var b,c,d,e,l,m,n,o,q,r=p(a);if(1===r)switch(c=parseInt(a.charAt(3),10),l=parseInt(a.charAt(0),10),n=parseInt(a.charAt(1),10),q=parseInt(a.charAt(5)+a.charAt(6),10),3===c&&(c=2),2===l&&(l=1),n){case 1:case 2:case 7:n=10;break;case 3:n=20;break;case 4:n=30;break;case 5:case 6:n=40}else{if(2!==r)return{};c=parseInt(a.charAt(0),10),l=parseInt(a.charAt(1),10),n=parseInt(a.charAt(2)+a.charAt(3),10),q=parseInt(a.charAt(6)+a.charAt(7),10)}return b=Object.keys(g).filter(function(a){return g[a]===c})[0]||f,d=h[b]||f,e=Object.keys(i).filter(function(a){return i[a]===l})[0]||f,m=Object.keys(j).filter(function(a){return j[a]===n})[0]||f,o=k[m]||f,{os:b,osDisplayName:d,engine:e,browser:m,browserDisplayName:o,browserVersion:q}};return{getCanvasFingerprint:q,encodeHardwareId:s,decodeHardwareId:t}}]),angular.module("services").factory("imageUtil",["BaseUtil",function(a){"use strict";var b=function(b,c,d){if("svg"===b.nodeName)return void f(b,c,d);var e=b.style,g=b.getAttribute("data-width")||b.naturalWidth||1,h=b.getAttribute("data-height")||b.naturalHeight||1,i=Math.min(c/g,d/h);if(i<=1)e.setProperty("width",Math.round(i*g)+"px"),e.setProperty("height","auto");else{e.removeProperty("width");var j=a.getMatchedCSSRules(b);a.getCascadedStyle("height",j)?e.setProperty("height","auto"):e.removeProperty("height")}},c=window.SVGLength&&window.SVGLength.SVG_LENGTHTYPE_PX,d=function(a,b){return a.unitType===window.SVGLength.SVG_LENGTHTYPE_PERCENTAGE?Math.round(b*a.valueInSpecifiedUnits/100):a.value},e=function(a,b,c){var d=/([0-9.]+)(\S?)/i.exec(a);return d?"%"===d[2]?Math.round(c*b*d[1]/100):Math.min(b,parseFloat(d[1])):b},f=function(a,b,f){function g(a,b,c){if(b)return d(b,c);var f=k[a]||k["max-"+a];return e(f,c,1)}function h(b){!a.hasAttribute("data-"+b)&&a.hasAttribute(b)&&a.setAttribute("data-"+b,a.getAttribute(b))}function i(b,c){var d=a.getAttribute("data-"+b);return d?(a.setAttribute(b,d),e(d,c,p)):c}var j=a.querySelectorAll("image");if(1===j.length){var k=a.style,l=a.width&&a.width.baseVal,m=a.height&&a.height.baseVal,n=g("width",l,b),o=g("height",m,f),p=Math.min(b/n,f/o),q=j[0];h("width"),h("height"),n=Math.round(p*n),o=Math.round(p*o),p>=1&&(n=i("width",n),o=i("height",o)),q.width.baseVal.newValueSpecifiedUnits(c,n),q.height.baseVal.newValueSpecifiedUnits(c,o),l&&m&&(l.newValueSpecifiedUnits(c,n),m.newValueSpecifiedUnits(c,o)),k.setProperty("width",n+"px"),k.setProperty("height",o+"px"),k.setProperty("display","block"),a.hasAttribute("viewBox")&&(a.viewBox.baseVal.width=n,a.viewBox.baseVal.height=o)}};return{propagateImageSize:b,propagateSVGSize:f}}]),function(){"use strict";var a=["pointerdown","pointerup","pointermove","pointerover","pointerout","pointercancel","pointerenter","pointerleave"];angular.forEach(a,function(a){var b="tw"+a.charAt(0).toUpperCase()+a.slice(1);angular.module("services").directive(b,["$parse",function(c){return function(d,e,f){var g=c(f[b]);e.on(a,function(a){d.$apply(function(){g(d,{$event:a})})})}}])})}(),angular.module("services").factory("resellerMapping",function(){"use strict";var a={1:"telekom",3:"thaliade",4:"thaliaat",5:"thaliach",6:"buchde",7:"buchch",8:"orellfuesslich",10:"weltbildde",11:"weltbildat",12:"weltbildch",13:"hugendubelde",20:"bertelsmannde",21:"ottode",22:"donaulandat",23:"osianderde",24:"mayerschede",30:"buecherde",40:"bildde",60:"boekhandelbe",61:"clubbe",80:"libride",81:"ebookde",82:"librisnl",82001:"blznl",90:"ibsit",91:"libraccioit",92:"indiebookit"},b={BERTELSMANN:"bertelsmannde","BILD.DE":"bildde","BLZ.NL":"blznl","BOEKHANDEL.BE":"boekhandelbe","BUCH.CH":"buchch","BUCH.DE":"buchde","BUECHER.DE":"buecherde","CLUB.BE":"clubbe","DONAULAND.AT":"donaulandat","EBOOK.DE":"ebookde","HUGENDUBEL.DE":"hugendubelde","IBS.IT":"ibsit","INDIEBOOK.IT":"indiebookit","LIBRACCIO.IT":"libraccioit","LIBRI.DE":"libride","LIBRIS.NL":"librisnl","MAYERSCHE.DE":"mayerschede","ORELLFUESSLI.CH":"orellfuesslich","OSIANDER.DE":"osianderde",OTTOMEDIA:"ottode",RTL:"rtlde",TELEKOM:"telekom","THALIA.DE":"thaliade","THALIA.AT":"thaliaat","THALIA.CH":"thaliach","WELTBILD.DE":"weltbildde","WELTBILD.AT":"weltbildat","WELTBILD.CH":"weltbildch"},c={bertelsmannde:"BERTELSMANN",bildde:"BILD.DE",blznl:"BLZ.NL",boekhandelbe:"BOEKHANDEL.BE",buchch:"BUCH.CH",buchde:"BUCH.DE",buecherde:"BUECHER.DE",clubbe:"CLUB.BE",donaulandat:"DONAULAND.AT",ebookde:"EBOOK.DE",hugendubelde:"HUGENDUBEL.DE",ibsit:"IBS.IT",indiebookit:"INDIEBOOK.IT",libraccioit:"LIBRACCIO.IT",libride:"LIBRI.DE",librisnl:"LIBRIS.NL",mayerschede:"MAYERSCHE.DE",orellfuesslich:"ORELLFUESSLI.CH",osianderde:"OSIANDER.DE",ottode:"OTTOMEDIA",rtlde:"RTL",telekom:"TELEKOM",thaliade:"THALIA.DE",thaliaat:"THALIA.AT",thaliach:"THALIA.CH",weltbildde:"WELTBILD.DE",weltbildat:"WELTBILD.AT",weltbildch:"WELTBILD.CH"},d={bertelsmannde:"Der Club eBooks",bildde:"Bild.de",blznl:"Blz.",boekhandelbe:"Standaard Boekhandel",buchch:"Buch.ch",buchde:"Buch.de",buecherde:"Bücher.de",clubbe:"Club",donaulandat:"Donauland.at",ebookde:"eBook.de",hugendubelde:"Hugendubel",ibsit:"IBS",indiebookit:"INDIeBOOK.it",libraccioit:"Libraccio",libride:"meineBUCHhandlung",librisnl:"Libris",mayerschede:"Mayersche",orellfuesslich:"Orell Füssli",osianderde:"Osiander",ottode:"OTTOMedia",rtlde:"RTL",telekom:"PagePlace",thaliade:"Thalia.de",thaliaat:"Thalia.at",thaliach:"Thalia.ch",weltbildde:"Weltbild.de",weltbildat:"Weltbild.at",weltbildch:"Weltbild.ch"},e=function(b){return b?a[b]?a[b]:(console.warn("services.resellerHelper: No ID available for ",b),null):(console.warn("services.resellerHelper: No id to convert from"),null)},f=function(b){if(!b)return console.warn("services.resellerHelper: No reseller name to convert from"),null;for(var c in a)if(b===a[c])return c;return console.warn("services.resellerHelper: reseller "+b+" not found"),null},g=function(a){return a?b[a]?b[a]:(console.warn("services.resellerHelper: No client ID available for ",a),null):(console.warn("services.resellerHelper: No ID to convert from"),null)},h=function(a){return a?(a.constructor!==Number&&isNaN(parseInt(a,10))||(a=e(a)),c[a]?c[a]:(console.warn("services.resellerHelper: No BOSH ID available for ",a),null)):(console.warn("services.resellerHelper: No ID to convert from"),null)},i=function(a){return a?(a.constructor!==Number&&isNaN(parseInt(a,10))||(a=e(a)),d[a]?d[a]:(console.warn("services.resellerHelper: reseller "+a+" not found"),null)):(console.warn("services.resellerHelper: No ID to get human readable string for"),null)};return{convertFromId:e,convertToId:f,convertToBosh:h,convertFromBosh:g,getHumanReadable:i}}),angular.module("services").service("StringUtil",function(){"use strict";var a={quot:34,amp:38,apos:39,lt:60,gt:62,nbsp:160,iexcl:161,cent:162,pound:163,curren:164,yen:165,brvbar:166,sect:167,uml:168,copy:169,ordf:170,laquo:171,not:172,shy:173,reg:174,macr:175,deg:176,plusmn:177,sup2:178,sup3:179,acute:180,micro:181,para:182,middot:183,cedil:184,sup1:185,ordm:186,raquo:187,frac14:188,frac12:189,frac34:190,iquest:191,Agrave:192,Aacute:193,Acirc:194,Atilde:195,Auml:196,Aring:197,AElig:198,Ccedil:199,Egrave:200,Eacute:201,Ecirc:202,Euml:203,Igrave:204,Iacute:205,Icirc:206,Iuml:207,ETH:208,Ntilde:209,Ograve:210,Oacute:211,Ocirc:212,Otilde:213,Ouml:214,times:215,Oslash:216,Ugrave:217,Uacute:218,Ucirc:219,Uuml:220,Yacute:221,THORN:222,szlig:223,agrave:224,aacute:225,acirc:226,atilde:227,auml:228,aring:229,aelig:230,ccedil:231,egrave:232,eacute:233,ecirc:234,euml:235,igrave:236,iacute:237,icirc:238,iuml:239,eth:240,ntilde:241,ograve:242,oacute:243,ocirc:244,otilde:245,ouml:246,divide:247,oslash:248,ugrave:249,uacute:250,ucirc:251,uuml:252,yacute:253,thorn:254,yuml:255,OElig:338,oelig:339,Scaron:352,scaron:353,Yuml:376,fnof:402,circ:710,tilde:732,Alpha:913,Beta:914,Gamma:915,Delta:916,Epsilon:917,Zeta:918,Eta:919,Theta:920,Iota:921,Kappa:922,Lambda:923,Mu:924,Nu:925,Xi:926,Omicron:927,Pi:928,Rho:929,Sigma:931,Tau:932,Upsilon:933,Phi:934,Chi:935,Psi:936,Omega:937,alpha:945,beta:946,gamma:947,delta:948,epsilon:949,zeta:950,eta:951,theta:952,iota:953,kappa:954,lambda:955,mu:956,nu:957,xi:958,omicron:959,pi:960,rho:961,sigmaf:962,sigma:963,tau:964,upsilon:965,phi:966,chi:967,psi:968,omega:969,thetasym:977,upsih:978,piv:982,ensp:8194,emsp:8195,thinsp:8201,zwnj:8204,zwj:8205,lrm:8206,rlm:8207,ndash:8211,mdash:8212,lsquo:8216,rsquo:8217,sbquo:8218,ldquo:8220,rdquo:8221,bdquo:8222,dagger:8224,Dagger:8225,bull:8226,hellip:8230,permil:8240,prime:8242,Prime:8243,lsaquo:8249,rsaquo:8250,oline:8254,frasl:8260,euro:8364,image:8465,weierp:8472,real:8476,trade:8482,alefsym:8501,larr:8592,uarr:8593,rarr:8594,darr:8595,harr:8596,crarr:8629,lArr:8656,uArr:8657,rArr:8658,dArr:8659,hArr:8660,forall:8704,part:8706,exist:8707,empty:8709,nabla:8711,isin:8712,notin:8713,ni:8715,prod:8719,sum:8721,minus:8722,lowast:8727,radic:8730,prop:8733,infin:8734,ang:8736,and:8743,or:8744,cap:8745,cup:8746,int:8747,there4:8756,sim:8764,cong:8773,asymp:8776,ne:8800,equiv:8801,le:8804,ge:8805,sub:8834,sup:8835,nsub:8836,sube:8838,supe:8839,oplus:8853,otimes:8855,perp:8869,sdot:8901,lceil:8968,rceil:8969,lfloor:8970,rfloor:8971,lang:9001,rang:9002,loz:9674,spades:9824,clubs:9827,hearts:9829,diams:9830},b={quot:!0,amp:!0,apos:!0,lt:!0,gt:!0,"#x0022":!0,"#x0026":!0,"#x0027":!0,"#x003C":!0,"#x003E":!0,"#34":!0,"#38":!0,"#39":!0,"#60":!0,"#62":!0},c={"À":"A","Á":"A","Â":"A","Ã":"A","Ä":"A","Å":"A","Æ":"AE","Ç":"C","È":"E","É":"E","Ê":"E","Ë":"E","Ì":"I","Í":"I","Î":"I","Ï":"I","Ð":"D","Ñ":"N","Ò":"O","Ó":"O","Ô":"O","Õ":"O","Ö":"O","Ø":"O","Œ":"OE","Ù":"U","Ú":"U","Û":"U","Ü":"U","Ý":"Y","ß":"ss","à":"a","á":"a","â":"a","ã":"a","ä":"a","å":"a","æ":"ae","ç":"c","è":"e","é":"e","ê":"e","ë":"e","ì":"i","í":"i","î":"i","ï":"i","ð":"d","ñ":"n","ò":"o","ó":"o","ô":"o","õ":"o","ö":"o","ø":"o","œ":"oe","ù":"u","ú":"u","û":"u","ü":"u","ý":"y","ÿ":"y"},d={"̀":"","́":"","̂":"","̃":"","̄":"","̆":"","̇":"","̈":"e","̉":"","̊":"","̋":"","̌":""},e=" ".charCodeAt(0),f={A:0,B:1,C:2,D:3,E:4,F:5,G:6,H:7,I:8,J:9,K:10,L:11,M:12,N:13,O:14,P:15,Q:16,R:17,S:18,T:19,U:20,V:21,W:22,X:23,Y:24,Z:25,a:26,b:27,c:28,d:29,e:30,f:31,g:32,h:33,i:34,j:35,k:36,l:37,m:38,n:39,o:40,p:41,q:42,r:43,s:44,t:45,u:46,v:47,w:48,x:49,y:50,z:51,0:52,1:53,2:54,3:55,4:56,5:57,6:58,7:59,8:60,9:61,"+":62,"/":63,"=":64,"-":62,_:63},g="function"==typeof window.TextEncoder?new TextEncoder:null,h=g?function(a){return g.encode(a).length}:function(a){var b=encodeURIComponent(a).match(/%[89ABab]/g);return b?a.length+b.length:a.length},i=function(b){return"#"!==b[0]?a[b]||e:"x"===b[1]?parseInt(b.substr(2),16):parseInt(b.substr(1),10)},j=function(a,b){return"&#"+i(b)+";"},k=function(a,c){return b[c]?a:String.fromCharCode(i(c))},l=function(a){var b=d[a];return void 0!==b?b:a},m=function(a){return c[a]||a};this.unescapeEntities=function(a,b){var c=b?j:k;return a.replace(/&(.+?);/g,c)},this.replaceAccentedCharacters=function(a){return a.replace(/[^A-Za-z0-9 ]/g,l)},this.latinize=function(a){return a&&a.replace(/[^A-Za-z0-9]/g,m)||""},this.decodeString=function(a){var b=a.length,c=b%4;if(3===c)throw new Error("The length of Base64-encoded data has to be a multiple of four ("+b+")");c>0&&(a+=2===c?"==":"=",b+=c);for(var d=[],e=0;e<b;){var g=f[a.charAt(e++)],h=f[a.charAt(e++)],i=f[a.charAt(e++)],j=f[a.charAt(e++)];if(void 0===g||void 0===h||void 0===i||void 0===j){var k=e-4;throw new Error('Argument contains invalid symbols "...'+a.substr(k,4)+'..." at position '+k)}d.push(g<<2|h>>4),64!==i&&(d.push(h<<4&240|i>>2),64!==j&&d.push(i<<6&192|j))}return d},this.capitalizeFirstLetter=function(a){return a.charAt(0).toUpperCase()+a.slice(1)},this.compactString=function(a){return a.replace(/\s+/g," ").trim()},this.lengthInUTF8Bytes=h,this.getByteOffset=function(a,b){if(!a)return 0;var c=void 0===b?a.textContent:a.textContent.substr(0,b);return h(c)},this.getCharOffsetForUTF8Bytes=function(a,b){for(var c=0;b>0;c++){var d=a.codePointAt(c),e=d<128&&1||d<2048&&2||d<=65535&&3||4;b-=e}return c}}),angular.module("services").service("variousFn",[function(){"use strict";var a=angular.injector(["ng"]),b=a.get("$timeout"),c=function(a,c){c=angular.isUndefined(c)?0:c;var d=0;return function(){var e=this,f=arguments;d++;var g=function(b){return function(){if(b===d)return a.apply(e,f)}}(d);return b(g,c)}};return{debounce:c}}]),angular.module("services").factory("Archive",["ByteArray","ArchiveEntry","ArchiveWorkerManager","FileUtil",function(a,b,c,d){"use strict";var e=22,f={signature:[0,4],diskNumber:[4,2],diskNumWithCD:[6,2],diskEntries:[8,2],totalEntries:[10,2],centralDirectorySize:[12,4],centralDirectoryOffset:[16,4],commentLength:[20,2]},g={versionMadeBy:[0,2],versionNeedToExtract:[2,2],bitFlag:[4,2],compressionMethod:[6,2],lastModFileTime:[8,2],lastModFileDate:[10,2],crc32:[12,4],compressedSize:[16,4],uncompressedSize:[20,4],fileNameLength:[24,2],extraFieldLength:[26,2],fileCommentLength:[28,2],diskNumberStart:[30,2],internalFileAttributes:[32,2],externalFileAttributes:[34,4],localHeaderOffset:[38,4]},h={signature:[0,4],versionNeeded:[4,2],bitFlag:[6,2],compressionMethod:[8,2],lastModFileTime:[10,2],lastModFileDate:[12,2],crc32:[14,4],compressedSize:[18,4],uncompressedSize:[22,4],fileNameLength:[26,2],extraFieldLength:[28,2]},i=42,j=[80,75,5,6],k=[80,75,1,2],l=4,m=function(a,b){for(var c=l-1;c>=0;c--)if(a[c]!==b[c])return!1;return!0},n=function(l){var n=function(){for(var b,c,d,g,h=l.byteLength-e;h>=0;){if(b=new Uint8Array(l,h,4),c=m(b,j))return d=f.centralDirectoryOffset,g=new Uint8Array(l,h+d[0],d[1]),a.asNumber(g);h--}return-1},o=function(){for(var b=this.centralDirectoryStartPos,c=this.centralDirectory;;){var e=new Uint8Array(l,b,4),f=m(e,k);if(!f)return!0;var h={},j=0;b+=4;for(var n in g)if(g.hasOwnProperty(n)){var o=g[n],p=b+o[0],q=o[1],r=a.asNumber(new Uint8Array(l,p,q));h[n]=r,"fileNameLength"!==n&&"extraFieldLength"!==n&&"fileCommentLength"!==n||(j+=r)}b+=i;var s=new Uint8Array(l,b,h.fileNameLength),t=a.asUTF8String(s);h.fileName=d.escapeFileName(t),c.push(h),b+=j}return!0},p=function(){this.numOfFiles=this.centralDirectory.length,this.centralDirectory.forEach(function(a){this.files[a.fileName]=new b(a,this)},this)};if(this.getLocalHeader=function(b,c){var d=h[b],e=c+d[0],f=d[1],g=new Uint8Array(this.arrayBuffer,e,f);return a.asNumber(g)},this.centralDirectoryStartPos=n(),this.centralDirectoryStartPos<0){var q=l&&l.byteLength||0;return void console.error("No start position of ZIP's central directory found ("+q+" bytes)")}this.arrayBuffer=l,this.workerManager=new c,this.centralDirectory=[],this.files={},this.numOfFiles=0,o.call(this)&&p.call(this)};return n.prototype.getArrayBuffer=function(){return this.arrayBuffer},n.prototype.setArrayBuffer=function(a){this.arrayBuffer=a},n.prototype.getWorkerManager=function(){return this.workerManager},n.prototype.getFiles=function(){return this.files},n.prototype.getFile=function(a){return this.files&&this.files[a]},n.prototype.destroy=function(){for(var a in this.files)this.files.hasOwnProperty(a)&&this.files[a].destroy();this.files=null,this.arrayBuffer=null,this.centralDirectory=null,this.workerManager&&(this.workerManager.destroy(),this.workerManager=null)},n}]),angular.module("services").factory("ArchiveEntry",["ByteArray","StringUtil","$q","$window",function(a,b,c,d){"use strict";var e=30,f=function(b,c){var d=function(){var a=this.headers.localHeaderOffset,b=c.getLocalHeader("fileNameLength",a),d=c.getLocalHeader("extraFieldLength",a),f=e+b+d;return a+f},f=function(){var a=this.headers.bitFlag;this.headers.isUTF8=2048===(2048&a),this.headers.usesTrailingDescriptor=8===(8&a),this.headers.isEncrypted=1===(1&a)};this.getFileContentAsString=function(){var b=this.fileContent;if(!b)return"";var c=a.hasUTF16ByteOrderMark(b);return c?a.asUTF16String(b):a.asUTF8String(b)},this.getFileContentAsBase64=function(){return a.asBase64(this.fileContent)},this.headers=b,this.archive=c,this.workerManager=c.getWorkerManager(),this.fileContent=null,this.fileContentStart=d.call(this),this._extractionPromise=null,f.call(this)};return f.prototype.extract=function(a){if(this.isExtracted())return c.resolve(this.fileContent);if(this._extractionPromise)return this._extractionPromise;var b=this.archive.getArrayBuffer(),d=this.headers.compressionMethod,e=new Uint8Array(b,this.fileContentStart,this.headers.compressedSize);if(0===d)return this.fileContent=e,c.resolve(e);var f=this.headers.uncompressedSize;return this._extractionPromise=this.workerManager.addToQueue(e,a).then(function(a){return a.length!==f&&console.warn("Unzip: File size ("+a.length+" Bytes) not equal to the value given in header ("+f+" Bytes)"),this._extractionPromise=null,this.fileContent=a}.bind(this))},f.prototype.isExtracted=function(){return null!==this.fileContent},f.prototype.getFileContentAsDOM=function(a,c){var e=new DOMParser;if(c||(c=this.getFileContentAsString()),c=b.unescapeEntities(c,!0),d.Modernizr.isie||d.Modernizr.isfirefox){var f=c.indexOf('xml version="1.1"');f>-1&&(c=c.replace('xml version="1.1"','xml version="1.0"'))}try{return e.parseFromString(c,a||"text/xml")}catch(a){return console.log('Parser Error in "getFileContentAsDOM":',a.message),null}},f.prototype.getCompressedSize=function(){return this.headers.compressedSize},f.prototype.getUncompressedSize=function(){return this.headers.uncompressedSize},f.prototype.releaseContent=function(){this.fileContent=null},f.prototype.destroy=function(){this.fileContent=null,this.headers=null,this.archive=null,this.workerManager=null},f}]),angular.module("services").factory("ArchiveWorkerManager",["$q","$rootScope","$window","$timeout","SynchronousWorker","BaseUtil",function(a,b,c,d,e,f){"use strict";var g=4,h=function(){this.taskQueue=[],this.worker=[];var h=function(){var a=this.worker,f=this.taskQueue;if(a.length<=0||f.length<=0)return!1;var g=a.pop(),i=f.shift();if(c.Modernizr.webworkers){var j=function(b){var c=b.data,d=!0;for(g.removeEventListener("message",j),a.push(g);f.length>0&&d;)d=h.call(this);i.deferred.resolve(c),j=null}.bind(this);g.addEventListener("message",j,!1),g.postMessage(i.data)}else{var k=d(function(){return e.zip_inflate(i.data)},0);a.push(g),i.deferred.resolve(k),b.$$phase||b.$apply()}return!0},i=function(a){for(var b=this.taskQueue.length;b>0&&a>this.taskQueue[b-1].priority;)b--;return b};this.addToQueue=function(b,c){c=c||0;var d=a.defer(),e=i.call(this,c);return this.taskQueue.splice(e,0,{data:b,deferred:d,priority:c}),h.call(this),d.promise};for(var j=!!window.__karma__,k=j?"/base/src/worker/zip.worker.js":f.getWorkerSource("zip.worker.js"),l=0;l<g;l++){var m;c.Modernizr.webworkers?(m=this.worker[l]=new Worker(k),m.postMessage("")):m=this.worker[l]=""}};return h.prototype.destroy=function(){for(var a=this.worker?this.worker.length:0,b=0;b<a;b++)this.worker[b].terminate&&this.worker[b].terminate();this.worker.length=0,this.taskQueue.length=0},h}]).factory("SynchronousWorker",function(){"use strict";function a(){this.next=null,this.list=null}function b(){this.e=0,this.b=0,this.n=0,this.t=null}function c(c,d,e,f,g,h){this.BMAX=16,this.N_MAX=288,this.status=0,this.root=null,this.m=0;var i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z=new Array(this.BMAX+1),A=new Array(this.BMAX+1),B=new b,C=new Array(this.BMAX),D=new Array(this.N_MAX),E=new Array(this.BMAX+1);for(y=this.root=null,n=z.length;n>0;)z[--n]=0;for(n=A.length;n>0;)A[--n]=0;for(n=C.length;n>0;)C[--n]=null;for(n=D.length;n>0;)D[--n]=0;for(n=E.length;n>0;)E[--n]=0;j=d>256?c[256]:this.BMAX,q=c,r=0,n=d;do z[q[r++]]++;while(--n>0);if(z[0]===d)return this.root=null,this.m=0,void(this.status=0);for(o=1;o<=this.BMAX&&0===z[o];o++);for(p=o,h<o&&(h=o),n=this.BMAX;0!==n&&0===z[n];n--);for(l=n,h>n&&(h=n),v=1<<o;o<n;o++,v<<=1)if((v-=z[o])<0)return this.status=2,void(this.m=h);if((v-=z[n])<0)return this.status=2,void(this.m=h);for(z[n]+=v,E[1]=o=0,q=z,r=1,u=2;--n>0;)E[u++]=o+=q[r++];q=c,r=0,n=0;do 0!==(o=q[r++])&&(D[E[o]++]=n);while(++n<d);for(d=E[l],E[0]=n=0,q=D,r=0,m=-1,t=A[0]=0,s=null,w=0;p<=l;p++)for(i=z[p];i-- >0;){for(;p>t+A[1+m];){if(t+=A[1+m],m++,w=(w=l-t)>h?h:w,(k=1<<(o=p-t))>i+1)for(k-=i+1,u=p;++o<w&&!((k<<=1)<=z[++u]);)k-=z[u];for(t+o>j&&t<j&&(o=j-t),w=1<<o,A[1+m]=o,s=new Array(w),x=0;x<w;x++)s[x]=new b;if(y=null==y?this.root=new a:y.next=new a,y.next=null,y.list=s,C[m]=s,m>0){E[m]=n,B.b=A[m],B.e=16+o,B.t=s,o=(n&(1<<t)-1)>>t-A[m];var F=C[m-1][o];F.e=B.e,F.b=B.b,F.n=B.n,F.t=B.t}}for(B.b=p-t,r>=d?B.e=99:q[r]<e?(B.e=q[r]<256?16:15,B.n=q[r++]):(B.e=g[q[r]-e],B.n=f[q[r++]-e]),k=1<<p-t,o=n>>t;o<w;o+=k)s[o].e=B.e,s[o].b=B.b,s[o].n=B.n,s[o].t=B.t;for(o=1<<p-1;0!==(n&o);o>>=1)n^=o;for(n^=o;(n&(1<<t)-1)!==E[m];)t-=A[m],m--}this.m=A[1],this.status=0!==v&&1!==l?1:0}function d(a){for(;u<a;)t|=(F===E?-1:D[F++])<<u,u+=8}function e(a){return t&P[a]}function f(a){t>>=a,u-=a}function g(a,b,c){var g,h,i;if(0===c)return 0;for(i=0;;){for(d(B),h=z.list[e(B)],g=h.e;g>16;){if(99===g)return-1;f(h.b),g-=16,d(g),h=h.t[e(g)],g=h.e}if(f(h.b),16!==g){if(15===g)break;for(d(g),x=h.n+e(g),f(g),d(C),h=A.list[e(C)],g=h.e;g>16;){if(99===g)return-1;f(h.b),g-=16,d(g),h=h.t[e(g)],g=h.e}for(f(h.b),d(g),y=p-h.n-e(g),f(g);x>0&&i<c;)x--,y&=G,p&=G,a[b+i++]=o[p++]=o[y++];if(i===c)return c}else if(p&=G,a[b+i++]=o[p++]=h.n,i===c)return c}return v=H,i}function h(a,b,c){var g;if(g=7&u,f(g),d(16),g=e(16),f(16),d(16),g!==(65535&~t))return-1;for(f(16),x=g,g=0;x>0&&g<c;)x--,p&=G,d(8),a[b+g++]=o[p++]=e(8),f(8);return 0===x&&(v=H),g}function i(a,b,d){if(null==N){var e,f,h=new Array(288);for(e=0;e<144;e++)h[e]=8;for(;e<256;e++)h[e]=9;for(;e<280;e++)h[e]=7;for(;e<288;e++)h[e]=8;if(r=7,f=new c(h,288,257,Q,R,r),0!==f.status)return console.error("HufBuild error: "+f.status),
-1;for(N=f.root,r=f.m,e=0;e<30;e++)h[e]=5;if(s=5,f=new c(h,30,0,S,T,s),f.status>1)return N=null,console.error("HufBuild error: "+f.status),-1;q=f.root,s=f.m}return z=N,A=q,B=r,C=s,g(a,b,d)}function j(a,b,h){var i,j,k,l,m,n,o,p,q,r=new Array(316);for(i=0;i<r.length;i++)r[i]=0;if(d(5),o=257+e(5),f(5),d(5),p=1+e(5),f(5),d(4),n=4+e(4),f(4),o>286||p>30)return-1;for(j=0;j<n;j++)d(3),r[U[j]]=e(3),f(3);for(;j<19;j++)r[U[j]]=0;if(B=7,q=new c(r,19,19,null,null,B),0!==q.status)return-1;for(z=q.root,B=q.m,l=o+p,i=k=0;i<l;)if(d(B),m=z.list[e(B)],j=m.b,f(j),j=m.n,j<16)r[i++]=k=j;else if(16===j){if(d(2),j=3+e(2),f(2),i+j>l)return-1;for(;j-- >0;)r[i++]=k}else if(17===j){if(d(3),j=3+e(3),f(3),i+j>l)return-1;for(;j-- >0;)r[i++]=0;k=0}else{if(d(7),j=11+e(7),f(7),i+j>l)return-1;for(;j-- >0;)r[i++]=0;k=0}if(B=L,q=new c(r,o,257,Q,R,B),0===B&&(q.status=1),0!==q.status)return-1;for(z=q.root,B=q.m,i=0;i<p;i++)r[i]=r[i+o];return C=M,q=new c(r,p,0,S,T,C),A=q.root,C=q.m,0===C&&o>257?-1:0!==q.status?-1:g(a,b,h)}function k(){null==o&&(o=new Uint8Array(2*(G+1))),p=0,t=0,u=0,v=H,w=!1,x=y=0,z=null}function l(a,b,c){for(var k,l=0;l<c;){if(w&&v===H)return l;if(x>0){if(v!==I)for(;x>0&&l<c;)x--,y&=G,p&=G,a[b+l++]=o[p++]=o[y++];else{for(;x>0&&l<c;)x--,p&=G,d(8),a[b+l++]=o[p++]=e(8),f(8);0===x&&(v=H)}if(l===c)return l}if(v===H){if(w)break;d(1),0!==e(1)&&(w=!0),f(1),d(2),v=e(2),f(2),z=null,x=0}if(k=v===K?null!=z?g(a,b+l,c-l):j(a,b+l,c-l):v===I?h(a,b+l,c-l):v===J?null!=z?g(a,b+l,c-l):i(a,b+l,c-l):-1,k===-1)return w?0:-1;l+=k}return l}function m(a,b){var c=a.length,d=new Uint8Array(c+b.length);return d.set(a),d.set(b,c),d}function n(a){var b,c=new Uint8Array;for(k(),D=a,E=a.length,F=0;(b=l(O,0,O.length))>0;)c=m(c,O.subarray(0,b));return D=null,o=null,c}var o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G=32767,H=-1,I=0,J=1,K=2,L=9,M=6,N=null,O=new Uint8Array(16384),P=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535],Q=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],R=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,99,99],S=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],T=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],U=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];return{zip_inflate:n}}),angular.module("services").service("Uncompress",[function(){"use strict";var a=function(){this.table=new Uint16Array(16),this.trans=new Uint16Array(288)},b=function(b,c){this.source=b,this.sourceIndex=0,this.tag=0,this.bitCount=0,this.dest=c,this.destLen=0,this.lTree=new a,this.dTree=new a},c=0,d=-3,e=new a,f=new a,g=new Uint8Array(30),h=new Uint16Array(30),i=new Uint8Array(30),j=new Uint16Array(30),k=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),l=new a,m=new Uint8Array(320),n=new Uint16Array(16),o=function(a,b,c,d){var e,f;for(e=0;e<c;++e)a[e]=0;for(e=0;e<30-c;++e)a[e+c]=e/c|0;for(f=d,e=0;e<30;++e)b[e]=f,f+=1<<a[e]},p=function(a,b){var c;for(c=0;c<7;++c)a.table[c]=0;for(a.table[7]=24,a.table[8]=152,a.table[9]=112,c=0;c<24;++c)a.trans[c]=256+c;for(c=0;c<144;++c)a.trans[24+c]=c;for(c=0;c<8;++c)a.trans[168+c]=280+c;for(c=0;c<112;++c)a.trans[176+c]=144+c;for(c=0;c<5;++c)b.table[c]=0;for(b.table[5]=32,c=0;c<32;++c)b.trans[c]=c},q=function(a,b,c,d){var e,f;for(e=0;e<16;++e)a.table[e]=0;for(e=0;e<d;++e)a.table[b[c+e]]++;for(a.table[0]=0,f=0,e=0;e<16;++e)n[e]=f,f+=a.table[e];for(e=0;e<d;++e)b[c+e]&&(a.trans[n[b[c+e]]++]=e)},r=function(a){a.bitCount--||(a.tag=a.source[a.sourceIndex++],a.bitCount=7);var b=1&a.tag;return a.tag>>>=1,b},s=function(a,b,c){if(!b)return c;for(;a.bitCount<24;)a.tag|=a.source[a.sourceIndex++]<<a.bitCount,a.bitCount+=8;var d=a.tag&65535>>>16-b;return a.tag>>>=b,a.bitCount-=b,d+c},t=function(a,b){for(;a.bitCount<24;)a.tag|=a.source[a.sourceIndex++]<<a.bitCount,a.bitCount+=8;var c=0,d=0,e=0,f=a.tag;do d=2*d+(1&f),f>>>=1,++e,c+=b.table[e],d-=b.table[e];while(d>=0);return a.tag=f,a.bitCount-=e,b.trans[c+d]},u=function(a,b,c){var d,e,f,g,h,i;for(d=s(a,5,257),e=s(a,5,1),f=s(a,4,4),g=0;g<19;++g)m[g]=0;for(g=0;g<f;++g){var j=s(a,3,0);m[k[g]]=j}for(q(l,m,0,19),h=0;h<d+e;){var n=t(a,l);switch(n){case 16:var o=m[h-1];for(i=s(a,2,3);i;--i)m[h++]=o;break;case 17:for(i=s(a,3,3);i;--i)m[h++]=0;break;case 18:for(i=s(a,7,11);i;--i)m[h++]=0;break;default:m[h++]=n}}q(b,m,0,d),q(c,m,d,e)},v=function(a,b,d){for(;;){var e=t(a,b);if(256===e)return c;if(e<256)a.dest[a.destLen++]=e;else{var f,k,l,m;for(e-=257,f=s(a,g[e],h[e]),k=t(a,d),l=a.destLen-s(a,i[k],j[k]),m=l;m<l+f;++m)a.dest[a.destLen++]=a.dest[m]}}},w=function(a){for(var b,e,f;a.bitCount>8;)a.sourceIndex--,a.bitCount-=8;if(b=a.source[a.sourceIndex+1],b=256*b+a.source[a.sourceIndex],e=a.source[a.sourceIndex+3],e=256*e+a.source[a.sourceIndex+2],b!==(65535&~e))return d;for(a.sourceIndex+=4,f=b;f;--f)a.dest[a.destLen++]=a.source[a.sourceIndex++];return a.bitCount=0,c};p(e,f),o(g,h,4,3),o(i,j,2,1),g[28]=0,h[28]=258,this.inflate=function(a,g){var h,i,j,k=new b(a,g);do if(h=r(k),i=s(k,2,0),0===i?j=w(k):1===i?j=v(k,e,f):2===i?(u(k,k.lTree,k.dTree),j=v(k,k.lTree,k.dTree)):j=d,j!==c)throw new Error("Data error");while(!h);return k.destLen<k.dest.length?"function"==typeof k.dest.slice?k.dest.slice(0,k.destLen):k.dest.subarray(0,k.destLen):k.dest}}]),angular.module("services").factory("Annotations",["CONFIG","BaseUtil","PageLocation","StringUtil","time",function(a,b,c,d,e){"use strict";function f(a,b){a&&a.setAttribute("data-meta",b)}function g(a,b,c){b&&b!==a.style.backgroundColor,!c&&a.hasAttribute("title")?a.removeAttribute("title"):c&&c!==a.getAttribute("title")&&a.setAttribute("title",c)}function h(a,b){a=parseInt(a,10);for(var c=0,d=b.length;c<d;c++)if(i(b[c])===a)return c;return-1}function i(a){if(!a)return null;var b=j(a.rmsdkPosition);return a.endPosition&&(b+=j(a.endPosition)),k(b)}function j(a){var b=a&&a.match(/([^#]*)#point\(([^\)]*)\)/i);if(b){var c=b[1].split("/").pop();return c+b[2]}return a}function k(a){for(var b=0,c=a.length,d=0;d<c;d++)b=(b<<5)-b+a.charCodeAt(d)|0;return b}function l(a){return"string"!=typeof a?"...":(a=d.compactString(a),a.length<=p?a||"...":a.substr(0,p-3)+"...")}function m(a){var b;return a instanceof window.Range&&!a.collapsed&&(b=a.commonAncestorContainer,b.nodeType===Node.TEXT_NODE&&(b=b.parentNode)),b}function n(a){if("dogear"===b.getMetaAttribute(a)){var c=a.parentNode;0===a.childNodes.length?c.removeChild(a):c.replaceChild(a.firstChild,a),c.normalize()}else a&&(a.classList.remove(s),a.removeAttribute("data-ref"))}function o(a){return"comment"===b.getMetaAttribute(a)}var p=80,q=a.globals.ANNOTATION.COMMENT_COLORS,r=a.globals.ANNOTATION.SEARCHMARK_COLOR,s=a.globals.ANNOTATION.DOGEAR_CLASSNAME,t=function(a,j){function k(a){var b,c=a&&(o(a)?a:a.querySelector("[data-meta='comment']"));if(c){var d=c.getAttribute("data-ref"),e=y.querySelectorAll('[data-ref="'+d+'"]'),f=e[e.length-1];b=x.createRange(),b.setStart(e[0],0),b.setEnd(f,f.childNodes.length)}return b}function m(a){var b;a&&(b=x.getSelection())&&(b.rangeCount>0&&b.removeAllRanges(),b.addRange(a))}function p(a,b){if(!a)return void console.warn("highlightRange: undefined range object");var c=z.getOffsetNode(a.startContainer,a.startOffset),e=z.getOffsetNode(a.endContainer,a.endOffset);if(c===e)t(a,b);else{var f=u(a,NodeFilter.SHOW_TEXT),g=x.createRange();f.forEach(function(f){var h;g.selectNode(f),f===c?(h=d.getByteOffset(f,a.startOffset),z.setRangeBoundary(g,f,h,window.Range.prototype.setStart)):f===e&&(h=d.getByteOffset(f,a.endOffset),z.setRangeBoundary(g,f,h,window.Range.prototype.setEnd)),t(g,b)})}}function t(a,b){var c=x.createElement("x-mark");f(c,b.metaAttr),b.dataRef&&c.setAttribute("data-ref",b.dataRef),g(c,b.color,b.note),a.surroundContents(c)}function u(a,b){for(var c,d=[],e=x.createRange(),f=function(b){return e.selectNode(b),a.compareBoundaryPoints(window.Range.END_TO_START,e)===-1&&1===a.compareBoundaryPoints(window.Range.START_TO_END,e)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT},g=x.createNodeIterator(a.commonAncestorContainer,b||NodeFilter.SHOW_ALL,f,!1);c=g.nextNode();)d.push(c);return d}function v(a){var b=a.toString();if(!b){for(var c=a.startContainer;c&&c!==y&&""===(b=c.textContent.trim());)c=c.nextSibling||c.parentNode.nextSibling||c.parentNode;if(!b){var d=x.querySelector("meta[name='description']");b=d?d.getAttribute("content"):x.title}}return l(b)}function w(a){var b=z.node,c=x.createElement("x-mark");if(c.classList.add(s),c.setAttribute("data-ref",i(a)),f(c,"dogear"),b.nodeType===Node.TEXT_NODE){var d=x.createRange(),e=Math.min(z.offset+1,b.length);d.setStart(b,e),d.setEnd(b,e),d.surroundContents(c)}else b.parentNode.insertBefore(c,b);return!0}var x=a,y=a?a.documentElement:null,z=new c(y,j);this.setPageLocation=function(a,b){x=a,y=a?a.documentElement:null,z.setRootNode(y),z.setFileName(b)},this.getAnnotationNode=function(a){var b=i(a);return y.querySelector('[data-ref="'+b+'"]')},this.removeAnnotation=function(a,b){var c=this.getAnnotationNode(a);if(c)return"endPosition"in a?this.removeComment(c,b):this.removeDogEar(c,b);var d=b.indexOf(a);return d>=0&&(b[d].modified=e.getTime(),b[d].deleted=!0,!0)},this.selectWordAtPosition=function(a,c,d){var e={left:c,top:d},f=z.getFirstNodeAtClientRectangle(e,a,!0)||a,g=b.getBoundingBox(f);if(g){e.left=Math.max(0,g.left),e.height=g.lineHeight||0;var h=z.getRangeAtPosition(e,f,c);if(h)return m(h),h}return null},this.selectCommentRange=function(a){if(o(a)){var b=k(a);return m(b),b}return null},this.setSearchMark=function(a){var b=z.getRMSDKRange(a.rmsdkPosition,a.endPosition);b&&p(b,{metaAttr:"searchMark",color:r})},this.createComment=function(a,b){var c=a&&d.compactString(a.toString());if(!c)return null;var f={deliverableId:b,modified:e.getTime(),markedBookText:c,markerColor:1,deleted:!1};return z.setNode(a.startContainer),z.setCharOffset(a.startOffset),f.rmsdkPosition=z.getRMSDKPosition(),z.setNode(a.endContainer),z.setCharOffset(a.endOffset),f.endPosition=z.getRMSDKPosition(),this.setComment(f),f},this.setComment=function(a){if(a.deleted)return!1;var b=q[0],c=i(a),d=y.querySelectorAll('[data-ref="'+c+'"]');if(d.length>0)for(var e=0;e<d.length;e++)g(d[e],b,a.markerComment);else{var f=z.getRMSDKRange(a.rmsdkPosition,a.endPosition);p(f,{metaAttr:"comment",dataRef:c,color:b,note:a.markerComment})}return!0},this.getMarkedBookText=function(a){var b=k(a);return b?d.compactString(b.toString()):""},this.removeComment=function(a,c){if(!o(a))return!1;var d=a.getAttribute("data-ref");if(d){var f=h(d,c);if(f>=0){c[f].modified=e.getTime(),c[f].deleted=!0;var g=x.querySelectorAll('[data-ref="'+d+'"]');return Array.prototype.forEach.call(g,b.unwrapNode),!0}}return!1},this.updateComment=function(a,b,c){if(!o(a))return!1;var d=a.getAttribute("data-ref");if(d){var f=h(d,b);if(f>=0&&b[f].markerComment!==c){b[f].markerComment=c,b[f].modified=e.getTime();for(var i=x.querySelectorAll('[data-ref="'+d+'"]'),j=0;j<i.length;j++)g(i[j],null,c);return!0}}return!1},this.createDogEar=function(a,b){if(!a)return null;z.setByRange(a);var c={deliverableId:b,rmsdkPosition:z.getRMSDKPosition(),displayName:v(a),modified:e.getTime(),deleted:!1};return w(c)?c:null},this.setDogEar=function(a){if(a.deleted)return!1;var b=z.setRMSDKPosition(a.rmsdkPosition);return!!b&&w(a)},this.getDogEarIndex=function(a,b){if(!a)return-1;z.setNode(a.startContainer),z.setCharOffset(a.startOffset);var c=i({rmsdkPosition:z.getRMSDKPosition()});return h(c,b)},this.removeDogEar=function(a,b){var c=a.classList.contains(s)?a:this.getDogEarFromNode(a),d=c&&c.getAttribute("data-ref");if(d){var f=h(d,b);if(f>=0){b[f].modified=e.getTime(),b[f].deleted=!0;var g=x.querySelectorAll('[data-ref="'+d+'"]');return Array.prototype.forEach.call(g,n),!0}}return!1},this.restoreDogEar=function(a){a.modified=e.getTime(),a.deleted=!1,this.setDogEar(a)}};return t.prototype.hasComment=o,t.prototype.isRangeInComment=function(a){var b=m(a);return!!b&&o(b)},t.prototype.getNote=function(a){return"comment"===b.getMetaAttribute(a)&&a.getAttribute("title")||""},t.prototype.getDogEarFromNode=function(a,b){if(!a)return null;if(a.nodeType===a.ELEMENT_NODE){if(a.classList.contains(s))return a;var c=a.getElementsByClassName(s),d=c.length;if(d>0){if(void 0===b)return c[0];for(var e=0;e<d;e++){var f=c[e].getBoundingClientRect();if(f.top<=b&&b<=f.bottom||0===f.height&&Math.abs(b-f.top)<=10)return c[e]}}}do a=a.parentNode;while(a&&a.nodeType===a.ELEMENT_NODE&&/inline/.test(getComputedStyle(a).display));return a&&a.nodeType===a.ELEMENT_NODE&&a.querySelector("."+s)||null},t}]),angular.module("services").factory("appState",["browserStorage",function(a){"use strict";var b="angular-cache.caches.appstate.data.",c=function(c,d){if(c){var e={key:c,value:d};return a.setItem(b+c,e)}},d=function(){return a.clear()},e=function(c){if(c)return a.removeItem(b+c)},f=function(c){if(!c)return null;var d=a.getItem(b+c);if(d)try{var e=JSON.parse(d);if(void 0!==e.value)return e.value}catch(d){a.removeItem(b+c)}return null};return{purge:d,remove:e,save:c,fetch:f}}]),angular.module("services").factory("audioElement",["$document","$rootScope",function(a,b){"use strict";var c=function(){var a=this.duration;a>0&&(w.durationMS=Math.floor(1e3*this.duration),b.$evalAsync())},d=function(){var a=this.seekable,c=this.duration;a&&a.length&&c>0&&c<1/0?Modernizr.ischrome?(w.cantSeek=!0,w.bufferedPercent=0):(w.cantSeek=!1,w.bufferedPercent=100*a.end(a.length-1)/c):(w.cantSeek=!0,w.bufferedPercent=0),b.$evalAsync()},e=function(){var a=this.currentTime,c=this.duration;a>=0&&(w.currentTimeMS=Math.floor(1e3*a),c>0&&c<1/0&&(w.currentPercent=100*a/c),b.$evalAsync())},f=function(){w.paused=this.paused,w.playing=!this.paused,b.$evalAsync()},g=function(){w.canPlay=!0},h=function(){var b=a[0].createElement("audio");return b.autoplay=!1,b.controls=!1,b.preload="auto",b.type="audio/mpeg",b.crossOrigin="Anonymous",b.addEventListener("durationchange",c),b.addEventListener("loadedmetadata",d),b.addEventListener("progress",d),b.addEventListener("timeupdate",e),b.addEventListener("play",f),b.addEventListener("playing",f),b.addEventListener("pause",f),b.addEventListener("ended",f),b.addEventListener("canplay",g),b},i=h(),j=function(){w.playing=!1,w.paused=!0,w.currentPercent=0,w.currentTimeMS=0,w.durationMS=0,w.bufferedPercent=0,w.cantSeek=!1,w.canPlay=!1},k=function(a){w.playing&&w.pause(),j(),a===i.src&&(i.src=""),i.src=a,i.load()},l=function(){return i.src},m=function(){return i.play()},n=function(){return i.pause()},o=function(){w.pause(),w.seek(0)},p=function(a){if(angular.isDefined(a)&&!w.cantSeek){var b=Math.max(0,a),c=Math.floor(1e3*i.duration);return c>0&&c<1/0&&(b=Math.min(b,c)),i.currentTime=b/1e3,i.currentTime}},q=function(a){return p(i.currentTime+a)},r=function(a){var b=i.duration;return p(b>0&&b<1/0?i.duration*a:0)},s=function(a){return i.playbackRate=a,i.playbackRate},t=function(a,b){return angular.element(i).on(a,b)},u=function(a,b){return angular.element(i).off(a,b)},v=function(a,b){return angular.element(i).one(a,b)},w={setSource:k,getSource:l,play:m,pause:n,stop:o,seek:p,seekRelative:q,seekPercent:r,playbackRate:s,on:t,off:u,one:v,cantSeek:!0,bufferedPercent:0,currentTimeMS:0,currentPercent:0,durationMS:0,paused:!0,playing:!1},x=["abort","canplay","canplaythrough","durationchange","emptied","ended","error","loadeddata","loadedmetadata","loadstart","pause","play","playing","progress","ratechange","seeked","seeking","stalled","suspend","timeupdate","volumechange","waiting"],y=function(a){b.$broadcast("tw.audio."+a.type,a)};x.forEach(function(a){i.addEventListener(a,y)});var z=["play","pause","setSource","seek","seekRelative","seekPercent","playbackRate"],A="tw.audio.command.",B=function(a){var b=a.name.substring(A.length),c=w[b];"function"==typeof c&&c.apply(w,Array.prototype.slice.call(arguments,1))};return z.forEach(function(a){b.$on(A+a,B)}),j(),w}]),angular.module("services").factory("playlist",["$rootScope","$q","audioElement","BaseUtil","inventory","loader","URLManager","error","time","browserStorage","CONFIG","sync","image","cover",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){"use strict";var o=1e4,p=function(){M.autoplay&&M.next()};c.on("ended",p);var q,r,s=function(){q&&q===c.getSource()&&M.selectedTrack===r&&(M.currentTrack=r,M.currentTrack.duration=c.durationMS,M.trackChange=!1,a.$broadcast("tw-playlist.trackchange",M.currentTrack),M.autoplay&&!c.playing&&c.play())};c.on("canplay",s);var t=!1,u=function(){t||M.trackChange||c.durationMS>0&&c.durationMS-c.currentTimeMS<1e4&&(E(),t=!0);var b=M.currentTrack;b&&!M.trackChange&&(c.durationMS!==b.duration||c.currentTimeMS>b.duration)&&(b.duration=Math.max(c.durationMS,c.currentTimeMS),a.$apply()),L()};c.on("timeupdate",u);var v=function(){M.autoplay=!1,M.deliverable=null,M.publication=null,M.coverimage=m.getFallbackImage("audio"),M.bluredCover=null,M.tracks=[],M.currentTrack=null,M.selectedTrack=null,M.playedOnce=!1,M.readyToPlay=!1},w=function(d){var f=b.defer();return d?M.deliverable&&M.deliverable.id===d?f.resolve():(M.deliverable&&M.pause(),v(),e.fetchPublications().then(function(){var b=e.getPubForDeliverable(d);if(b)if("AUDIOBOOK"!==b.type)f.reject("publication of delivery"+d+" is of type "+b.type+", expected AUDIOBOOK");else{for(var g,h=0,i=b.deliverables.length;h<i&&(g=b.deliverables[h],g.id!==d);h++);g||f.reject("publication "+b.id+" does not contain delivarable object with id "+d),M.publication=b,M.deliverable=g;for(var j=[],k=g.tracks,l=0;l<k;l++)j.push({index:l,title:null,pubId:b.id,delId:g.id});M.tracks=j,g.cover&&n.requestCover(g.cover).then(function(a){M.coverimage=a.blobUri});var m=H(g);M.currentTrack=j[m.index],M.selectTrack(m.index);var o=M.tracks[m.index];D(o).then(function(){if(M.readyToPlay=!0,c.cantSeek&&0!==m.time)var b=function(){d(),c.seek(1e3*m.time),f.resolve()},d=a.$on("tw.audio.loadedmetadata",b);else c.seek(1e3*m.time),f.resolve()})}else f.reject("could not find publication with deliverable delId "+d)},function(a){f.reject(a)})):f.reject("missing required parameter delId"),f.promise},x=function(){M.repeat=!M.repeat},y=function(){M.selectedTrack?M.selectedTrack.index<M.tracks.length-1?M.selectTrack(M.selectedTrack.index+1):M.repeat?M.selectTrack(0):M.autoplay=!1:M.selectTrack(0)},z=function(){M.selectedTrack?M.selectedTrack.index>0?M.selectTrack(M.selectedTrack.index-1):M.repeat?M.selectTrack(M.tracks.length-1):M.autoplay=!1:M.selectTrack(M.tracks.length-1)},A=function(a){if(M.readyToPlay=!1,a<0||a>M.tracks.length-1)return null;t=!1,M.trackChange=!0;var b=!M.selectedTrack,d=M.selectedTrack=M.tracks[a];return D(d).then(function(a){if(M.selectedTrack===a){M.readyToPlay=!0;var d=a.url;a.url=a.urlFetchDate=null,q=d,r=a,c.setSource(d),b&&M.play()}},function(a){h.handleError(a)}),d},B=function(c,d){var e=b.defer(),f=c.delId+"/"+c.index,h=g.getURL(f);if(h)c.downloadPercent=100,e.resolve(h);else{var i=new XMLHttpRequest;i.open("GET",d,!0),i.responseType="blob",i.onload=function(){if(i.onload=i.onprogress=null,200===this.status){var a="audio/mpeg",b=g.createURL(c.delId+"/"+c.index,this.response,a);c.downloadPercent=100,e.resolve(b)}else e.reject("failed to download, status: "+this.statustext)},i.onprogress=function(b){if(b.lengthComputable){var d=b.loaded/b.total;c.downloadPercent=100*d,a.$apply()}},i.send()}return e.promise},C=function(a,b){var c=new Date;return c.setHours(c.getHours()+b),a<c},D=function(a){var c=b.defer();return a.url&&C(a.urlFetchDate,12)?(c.resolve(a),c.promise):(a.url&&(a.url=null,a.urlFetchDate=null),f.fetchInfo(a.pubId,a.delId,null,a.index+1).then(function(b){if(b.data&&b.data.DownloadInfo&&b.data.DownloadInfo.contentUrl){var d=b.data.DownloadInfo.contentUrl;a.urlFetchDate=new Date,M.prefetch?B(a,d).then(function(b){a.url=b,c.resolve(a)},function(a){c.reject("prefetch failed "+a)}):(a.url=d,c.resolve(a))}else c.reject("failed to get url fetchInfo info.data.DownloadInfo.contentUrl");j.setItem("lastHeard-"+a.delId,a.index)},function(a){c.reject(a)}),c.promise)},E=function(){var a=0;if(M.currentTrack){var b=M.currentTrack.index;b<M.tracks.length-1&&(a=b+1)}var c=M.tracks[a];return D(c)},F=function(){M.playedOnce=!0,M.autoplay=!0,M.selectedTrack?c.canPlay&&c.play():M.selectTrack(0)},G=function(){M.autoplay=!1,c.pause(),K()},H=function(a){var b,c,d,e=a.bookmark.rmsdkPosition;return e&&(b=e.match(/#medialoc\((\d*)\s*,\s*?(\d*)\)/i))?(c=parseInt(b[1],10)-1,d=parseInt(b[2],10)):(c=j.getItem("lastHeard-"+a.id)||0,c=parseInt(c,10),d=0),{index:c,time:d}},I=function(){var a=M.currentTrack,b=a?a.index+1:1,d=Math.floor(c.currentTimeMS/1e3);return"#medialoc("+b+","+d+")"},J=function(){var a=M.currentTrack,b=M.tracks.length||1,d=a?a.index:0,e=1;return M.currentTrack.duration>0&&(e=Math.min(c.currentTimeMS/M.currentTrack.duration,1)),(d+e)/b},K=function(){var a=M.deliverable;if(a)return a.bookmark.rmsdkPosition=I(),a.bookmark.modified=i.getTime(),a.bookmark.progress=J(),a.bookmark.currentPage=M.currentTrack.index+1,a.bookmark.lastPage=M.tracks.length,e.saveDeliverable(a.id),l.sync([a])},L=d.throttle(K,o,{leading:!0,trailing:!1}),M={openDeliverable:w,toggleRepeat:x,selectTrack:A,next:y,prev:z,play:F,pause:G,publication:null,deliverable:null,coverimage:null,bluredCover:null,tracks:[],currentTrack:null,selectedTrack:null,trackChange:!1,playedOnce:!1,readyToPlay:!1,autoplay:!1,repeat:!0,prefetch:!1};return v(),M}]),angular.module("services").factory("bosh",["$http","$q","$window","$timeout","$rootScope","token","reseller","hardwareHelper","CONFIG","appState","BaseUtil","user",function(a,b,c,d,e,f,g,h,i,j,k,l){"use strict";var m=!1,n=c.navigator.onLine,o=function(){return n},p=function(a){n=Boolean(a)};c.addEventListener("offline",function(){console.warn("%c bosh is offline","color: #ff0000"),n=!1}),c.addEventListener("online",function(){console.info("%c bosh is online","color: #4698cb"),n=!0});var q=null,r=null,s=null,t=function(c){return g.fetchConfig().then(function(d){if(null!==r)return r;a.defaults.headers.common["X-Requested-With"]&&delete a.defaults.headers.common["X-Requested-With"];var e={Accept:"application/json","Content-Type":"application/json"};return Modernizr.audio.mp3&&"no"!==Modernizr.audio.mp3&&(e["X-Audiobook-Enabled"]=1),e.reseller_id=d.reseller_id,r=f.fetchToken().then(function(a){return e.t_auth_token=a,c?u(e).then(function(a){return e.hardware_id=a.hwId,e},function(a){return b.reject(a)},null):e},function(a){return a?(e.t_auth_token=a,e.hardware_id="DEMO::HARWARE::ID",e):b.reject("no token")}).finally(function(){r=null})})},u=function(e){return g.fetchConfig().then(function(f){if(null!==q)return q;var g=b.defer();if(q=g.promise,!l.isLoggedIn())return b.resolve({user:"DEMO::USER",devKey:"DEMO::DEV::KEY",hwId:"DEMO::HARWARE::ID"});var h=j.fetch("userid"),k=j.fetch(h);if(h&&k)try{var n=JSON.parse(sjcl.decrypt(h,c.atob(k)));if(m)d(function(){g.resolve(n),q=null},0);else{var o=b.defer(),p=d(function(){o.resolve({type:i.globals.ERROR.NETWORK_TIMEOUT})},2e3),r=f.URL_BOOKSHELF;a({method:"GET",timeout:o.promise,url:r+"userid/"+c.encodeURIComponent(n.hwId),headers:e}).then(function(a){m=!0;var b=a&&a.data&&a.data.initAppResponse&&a.data.initAppResponse.userId;b&&b===h?(s=n,g.resolve(n)):g.reject(i.globals.ERROR.APP_INVALID_USER)}).catch(function(a){console.warn('Request "userid" failed: status '+a.status+" "+a.statusText),m=!1,s=n,g.resolve(n)}).finally(function(){q=null,d.cancel(p)})}}catch(a){j.remove("userid"),j.remove(h),v(g,e)}else v(g,e);return q}).catch(function(a){return b.reject(a||i.globals.ERROR.APP_NO_CONFIG)})},v=function(a,b){y(b).then(function(d){var e=d.initAppResponse.userId,f=d.initAppResponse.deviceKey,g={user:e,devKey:f,hwId:b.hardware_id};j.save("userid",e),j.save(e,c.btoa(sjcl.encrypt(e,JSON.stringify(g)))),s=g,a.resolve(g),q=null},function(b){a.reject(b),q=null})},w=function(){if(s)return s;if(!l.isLoggedIn())return{user:"DEMO::USER",devKey:"DEMO::DEV::KEY",hwId:"DEMO::HARWARE::ID"};var a=j.fetch("userid")||"nope",b=j.fetch(a)||"nope";try{var d=JSON.parse(sjcl.decrypt(a,c.atob(b)));s=d}catch(a){return!1}},x=function(){return Boolean(w())},y=function(e){return g.fetchConfig().then(function(f){var g=f.URL_BOOKSHELF,j=h.encodeHardwareId(),l=function(){var f=b.defer();if(!c.navigator.onLine)return b.reject(i.globals.ERROR.NETWORK_OFFLINE);var l=d(function(){f.resolve(i.globals.ERROR.NETWORK_TIMEOUT)},1e4);return e.hardware_id=j,e.client_type="TOLINO_WEBREADER",e.client_version=k.getAppVersionNumber(window.tw.version),e.hardware_type="HTML5",a({method:"POST",url:g+"v2/registerhw",timeout:f.promise,data:{hardware_name:h.decodeHardwareId(j).browser},headers:e}).finally(function(){d.cancel(l)})};return l().then(C,function(a){return a&&a.status&&406===a.status?b.reject(i.globals.ERROR.DEVICE_LIMIT):b.reject(a)})},function(){return b.reject(i.globals.ERROR.APP_NO_CONFIG)})},z=function(e,f,h){return o()?g.fetchConfig().then(function(g){return t(!0).then(function(j){var k=b.defer(),l=d(function(){k.resolve(i.globals.ERROR.NETWORK_TIMEOUT)},1e4),m="?count="+(f||15);/^(ebook|epaper|emagazine|audiobook)$/.test(h)&&(m+="&type="+h);var n=g.URL_BOOKSHELF;return j.client_type="TOLINO_WEBREADER",c.navigator.onLine?a({method:"GET",timeout:k.promise,url:n+"recommendation/"+e+m,headers:j}).then(C,function(a){return b.reject(a)}).finally(function(){d.cancel(l)}):b.reject(i.globals.ERROR.NETWORK_OFFLINE)},null)},function(){return b.reject(i.globals.ERROR.APP_NO_CONFIG)}):b.reject(i.globals.ERROR.NETWORK_OFFLINE)},A=function(e){return g.fetchConfig().then(function(f){return t(!0).then(function(g){var h=b.defer();if(!c.navigator.onLine)return b.reject(i.globals.ERROR.NETWORK_OFFLINE);var j=d(function(){h.resolve(i.globals.ERROR.NETWORK_TIMEOUT)},1e4),k=f.URL_BOOKSHELF;return a({method:"PUT",url:k+"meta/",timeout:h.promise,headers:g,data:e}).then(C,null).finally(function(){d.cancel(j)})},null)},function(){return b.reject(i.globals.ERROR.APP_NO_CONFIG)})},B=function(e){return g.fetchConfig().then(function(f){return t(!0).then(function(g){var h=b.defer();if(!c.navigator.onLine)return b.reject(i.globals.ERROR.NETWORK_OFFLINE);var j=d(function(){h.resolve(i.globals.ERROR.NETWORK_TIMEOUT)},1e4),k=f.URL_BOOKSHELF;return a({method:"GET",timeout:h.promise,url:k+"meta/?deliverableId="+e,headers:g}).then(C,null).finally(function(){d.cancel(j)})},null)},function(){return b.reject(i.globals.ERROR.APP_NO_CONFIG)})},C=function(a){return a.data},D=function(){var a=j.fetch("userid");j.remove("userid"),j.remove(a)},E=function(){return g.fetchConfig().then(function(e){return t(!0).then(function(f){var g=b.defer();if(!c.navigator.onLine)return b.reject(i.globals.ERROR.NETWORK_OFFLINE);var h=d(function(){g.resolve(i.globals.ERROR.NETWORK_TIMEOUT)},2e3),j=f.hardware_id;delete f.hardware_id;var k=e.URL_BOOKSHELF;return c.navigator.onLine?a({method:"POST",url:k+"handshake/devices/delete",timeout:g.promise,headers:f,data:{deleteDevicesRequest:{accounts:[{auth_token:f.t_auth_token,reseller_id:f.reseller_id}],devices:[{device_id:j,reseller_id:f.reseller_id}]}}}).then(function(){d.cancel(h),console.info("Hardware slot has been freed")}).catch(function(a){return d.cancel(h),b.reject(a)}):b.reject(i.globals.ERROR.NETWORK_OFFLINE)},null)},function(){return b.reject(i.globals.ERROR.APP_NO_CONFIG)})};return{fetchHeader:t,fetchRecommendations:z,hasHardware:x,fetchHardware:u,sendMetaData:A,fetchMetaData:B,deleteUser:D,deleteHardware:E,isBoshOnline:o,setBoshOnline:p}}]),angular.module("services").service("collectionContextMenu",["$rootScope","collections","CONFIG",function(a,b,c){"use strict";function d(a,b,d){if(a){if(g.isVisible&&a.id===g.param)return g.x=b,void(g.y=d);g.param=a.id,g.x=b,g.y=d;var e=a.category===c.globals.MISC.COLLECTION_CATEGORY;g.items.RENAME.isEnabled=e,g.items.DELETE.isEnabled=e,g.isVisible=!0}}function e(a){for(var c;a&&!c;)c=a.getAttribute&&a.getAttribute("collection-id"),a=a.parentNode;return c&&b.getByID(c)}function f(b,c){b.clientX>=0&&b.clientY>=0&&c&&(d(c,b.clientX,b.clientY),a.$emit("tw.contextMenu.visibility",g))}var g={menuId:"ctxMenuCollections",isVisible:!1,x:0,y:0,items:{OPEN:{icon:"collections",isVisible:!0,isEnabled:!0,eventName:"tw.collection.open",tooltip:gettext("COMMON_OPEN")},RENAME:{icon:"edit",isVisible:!0,isEnabled:!0,eventName:"tw.collection.dialog.rename",tooltip:gettext("COMMON_RENAME")},DELETE:{icon:"delete",isVisible:!0,isEnabled:!0,eventName:"tw.collection.dialog.delete",tooltip:gettext("TOOLTIP_COMPONENT_LIBRARY_CONTEXTDELETE")}}};return a.$on("tw.contextMenu.action",function(b,c){if(c.menuId===g.menuId){var d=c.menuItem&&c.menuItem.eventName;d&&a.$emit(d,c.param)}}),a.$on("tw.contextMenu.update",function(a,b,c,f,h){b===g.menuId&&d(e(c),f,h)}),{showContextMenu:f}}]),angular.module("services").factory("collections",["$rootScope","$translate","CONFIG","appState","inventory","Selection","time",function(a,b,c,d,e,f,g){"use strict";function h(a){return(""+a).trim()}function i(a){return a===c.globals.STORE.TAG_FINISHED_READINGS}function j(a,b){b.removeTag(a)&&e.saveDeliverable(b.id)}function k(a){var b=!1;for(var c in a){var d=a[c].id;0!==a[c].items.length||R[d]||(delete a[c],V.remove(d),b=!0)}return b}function l(a){return"object"==typeof a&&a.name}function m(a){return(a||void 0===a)&&d.save(O,V.stringify()),a}function n(){var a,b=d.fetch(O);if(b)try{a=JSON.parse(b)||[],a.forEach(V.add,V)}catch(a){console.warn("restoreCollectionTags:",a.name,a.message)}}function o(a){a="string"==typeof a?a.toLowerCase():"";for(var b in V.tags)if(a===v(V.tags[b]).toLowerCase())return!0;return!1}function p(a){return a&&"AUDIOBOOK"===a.type?"AUDIOBOOK":"EBOOK"}function q(a){return a=h(a),a&&a.length<=L}function r(a){return V.exists(a)||o(a)}function s(a){return e.getDeliverables().every(function(b){return b.getTagIndex(a)===-1})}function t(a){R[a]=!0}function u(a){var b=V.getTag(a);return b&&b.category}function v(a){return"string"==typeof a&&(a=V.getTag(a)||a),"object"==typeof a?a.category===N&&b.instant(a.name.toUpperCase())||a.displayName||a.name:b.instant(a.toUpperCase())||a}function w(a){return V.getIDs(a)}function x(a){function b(a){var b=a.name,d=V.getID(b);return c[d]||(c[d]={category:a.category,id:d,title:v(a),items:[],tagObject:V.getTag(b)}),d}var c=Object.create(null),d=e.getDeliverables(),f=!1;return V.get(a).forEach(b),d.forEach(function(d){d.tags.forEach(function(e){var g;a&&a!==p(d)?(g=V.getID(e.name),delete c[g]):e.deleted||(f=V.add(e,a)||f,g=b(e),c[g].items.push(d))})}),(k(c)||f)&&m(),c}function y(a){var b=x(a);return U(Object.keys(b).map(function(a){return b[a]}))}function z(a){var b=V.getID(a);return r(b)&&x()[b]}function A(a,b){return m(V.add(a,b))}function B(a){var b=V.remove(a);return b&&(m(),e.getDeliverables().forEach(function(b){b.removeTag(a)&&e.saveDeliverable(b.id)})),b}function C(a,b){if(!V.exists(a)||!q(b))return!1;a=V.getName(a),b=h(b);var c=V.getTag(a),d=c&&c.type;return!(!V.remove(a)||!V.add(b,d))&&(m(),e.getDeliverables().forEach(function(c){c.renameTag(a,b)&&e.saveDeliverable(c.id)}),!0)}function D(a){return a=h(a),e.getDeliverables().filter(function(b){return b.hasTag(a)})}function E(b,c){if(q(b)){var d=e.deliverables[c];if(b=h(b),i(b))return!d.isFinished&&(a.$emit("tw.library.mark.finished",c,!0),d.isFinished);if(d.addTag(b))return r(b)||A(b,p(d)),!0}return!1}function F(a,b){var c=0;for(var d in b)E(a,d)&&c++;return c}function G(b,c){var d=e.deliverables[c];return i(b)?!!d.isFinished&&(a.$emit("tw.library.mark.finished",c,!1),!d.isFinished):j(b,d)}function H(a,b){return Q.compare(a.id,b.id)}function I(a,b){return a.items.length-b.items.length}function J(a,b){return console.log(a),a.tagObject.maxModified-b.tagObject.maxModified}function K(a){P=a}var L=c.globals.MISC.COLLECTION_NAME_MAX_LENGTH,M=c.globals.MISC.COLLECTION_CATEGORY,N=c.globals.MISC.SYSTEM_CATEGORY,O="collection-tags",P={order:"title",isDescending:!1},Q=window.Intl&&"function"==typeof window.Intl.Collator?new Intl.Collator:{compare:function(a,b){return a.localeCompare(b)}},R=Object.create(null),S=function(a){this.name=a.name,this.type=a.type,this.category=a.category||M,this.displayName=a.displayName,this.minModified=a.minModified||g.getTime(),
this.maxModified=a.maxModified||g.getTime()},T=function(){this.tags=Object.create(null),this.tagIDs=Object.create(null)};T.prototype.getID=function(a){return h(a).toLowerCase()},T.prototype.getName=function(a){return this.tagIDs[this.getID(a)]},T.prototype.getTag=function(a){return a=this.getName(a),this.tags[a]},T.prototype.exists=function(a){return void 0!==this.getName(a)},T.prototype.add=function(a,b){if(!a||"object"==typeof a&&!l(a))return!1;"string"==typeof a&&(a={name:a}),b&&(a.type=b),a.modified||(a.modified=g.getTime()),void 0===a.minModified&&(a.minModified=a.modified),void 0===a.maxModified&&(a.maxModified=a.modified);var c=a.name;if(this.exists(c)){c=this.getName(c);var d=this.tags[c];return d.type=a.type||d.type,d.minModified=Math.min(d.minModified,a.minModified),d.maxModified=Math.max(d.maxModified,a.maxModified),!1}return this.tags[c]=new S(a),this.tagIDs[this.getID(c)]=c,!0},T.prototype.remove=function(a){if(a=h(a),!this.exists(a))return!1;var b=this.getID(a);return a=this.tagIDs[b],delete this.tags[a],delete this.tagIDs[b],!0},T.prototype.getIDs=function(a){var b=[];for(var c in this.tagIDs){var d=this.tagIDs[c],e=this.tags[d].type;e!==a&&void 0!==e||b.push(c)}return b},T.prototype.get=function(a){var b=[];for(var c in this.tags){var d=this.tags[c];a&&d.type!==a&&void 0!==d.type||b.push(d)}return b},T.prototype.stringify=function(){var a=[];for(var b in this.tags)a.push(this.tags[b]);return JSON.stringify(a)};var U=function(a){switch(P.order){case"title":return P.isDescending?a.sort(H).reverse():a.sort(H);case"count":return P.isDescending?a.sort(I).reverse():a.sort(I);case"recent":return P.isDescending?a.sort(J):a.sort(J).reverse();default:return a.sort(H)}},V=new T;return n(),{isValidName:q,exists:r,isEmpty:s,retainCollection:t,getCategory:u,getTitle:v,getByType:w,getWithDeliverables:y,getByID:z,add:A,remove:B,rename:C,getDeliverables:D,addDeliverable:E,addDeliverables:F,removeDeliverable:G,selection:new f,setSortCriteria:K}}]).filter("ByCollection",[function(){"use strict";return function(a,b){return b&&a&&"function"==typeof a.filter?(b=b.trim().toLowerCase(),a.filter(function(a){return a.tags.findIndex(function(a){return"string"==typeof a.name&&a.name.toLowerCase()===b&&!a.deleted})>=0})):a}}]),angular.module("services").service("chapterNavHelper",[function(){"use strict";var a=null,b=null,c=function(b){a=b},d=function(){a=null,b=null},e=function(){return a[b]},f=function(){return a.length};return{initWithToc:c,clearData:d,getCurrentChapter:e,getNoOfChapters:f}}]),angular.module("services").factory("contentProvider",["$rootScope","$q","$injector","sectionNavHelper","chapterNavHelper","Archive","EPubParser","ContentProcessor","FileUtil","Crypto","BaseUtil",function(a,b,c,d,e,f,g,h,i,j,k){"use strict";var l,m=null,n=null,o=null,p=null,q=null,r=Object.create(null),s=function(a,c){var d;return a&&(console.log(a),d=c?{message:a,reason:c}:a),b.reject(d)},t=function(a){return w(d.getSectionByIndex(a))},u=function(a){return x(d.getSectionByIndex(a))},v=function(a){return a!==d.getCurrentSection()&&d.isSectionInSpine(a)?(d.setSectionByName(a),x(a)):s("noSectionChange")},w=function(a){return X(a).then(function(){return{parsedContent:J(m.files[a],a),name:a}},null)},x=function(a){return d.isSectionInSpine(a)?X(a).then(function(){var b=J(m.files[a],a),c=k.checkParserError(b,a);if(c)return s(c.message,c.reason);var d=b.doctype&&b.doctype.name||"html";if(!/^x?html$/i.test(d))return s("No HTML in ePub found","PARSER_ERROR");var e={files:m.getFiles(),root:a,deliverableId:l,language:I(),hasFixedLayout:!!G(a)};return h.processContent(b,e)},function(){return s('Could not get content for section "'+a+'"',"PARSER_ERROR")}):s('section "'+a+'" not found in spine')},y=function(){var a=d.getCurrentSpineItem()["media-overlay"];if(a){var c=U().manifest,e=c.findIndex(function(b){return b.id===a}),f=e>0&&c[e].href,g=m.files[f];if(g)return g.extract().then(function(){return b.resolve(g.getFileContentAsDOM())})}return b.reject()},z=function(){return d.getSectionByRelativeReference("current")},A=function(a){return d.getSectionByIndex(a)},B=function(a){return d.getSectionByRelativeReference(a)},C=function(a,b){var c=o;if(b){var d=Math.round(a*(c.fileOrder.length-1));return c.fileOrder[d]}for(var e=c?Math.floor(c.totalSize*a):0,f=0,g=c.fileOrder.length;f<g;f++){var h=c.fileOrder[f],i=c.fileInfo[h];if(i.start<=e&&e<=i.start+i.size)return h}return null},D=function(a){var b=U().manifest||[],c=/\bscripted\b/,d=function(a){return a&&(a["media-type"].endsWith("javascript")||c.test(a.properties))};return a?d(b.find(function(b){return b.href===a})):b.some(d)},E=function(){return d.isFirstSection()},F=function(){return d.isLastSection()},G=function(a){if(a||(a=z()),a in r)return r[a];var b,c,d,e=J(m.files[a],a),f=e&&e.querySelector('head > meta[name="viewport"]');return f&&(b=f.getAttribute("content"),c=parseFloat(H(b,"width"),10),d=parseFloat(H(b,"height"),10)),r[a]=c>0&&d>0?{width:c,height:d}:null,r[a]},H=function(a,b){var c=new RegExp(b+"\\s*=\\s*([0-9.]+)","i"),d=a.match(c);return d&&d[1]||"0"},I=function(){var a=U().metadata;return a&&a["dc:language"]},J=function(a,b){var c;return q&&q.devKey&&(j.setDeviceKey(q.devKey),c=j.decryptContent(q.key,q.vector,a.fileContent)),a.getFileContentAsDOM(L(b),c)},K=function(a){q=a,navigator.epubReadingSystem&&"showCryptInfo"in navigator.epubReadingSystem&&console.log('devKey: "%s", key: "%s", vector: "%s"',a.devKey,a.key,a.vector)},L=function(a){a||(a=z());var b=U(),c=b.manifest.find(function(b){return b.href===a})||{};return c["media-type"]||(b.version>=3?"text/html":"text/xml")},M=function(a,b){if(m=new f(a),null===m.files)return s("No files in ePub archive found","PARSER_ERROR");if(l=b&&b.id,l&&"EDATA"===b.type&&!b.cover){var d=c.get("EPubCover");d.extract(a).then(function(a){d.upload(a,l)})}return n=new g(m),n.parseEPub().then(N.bind(null,b),function(a){return s(a,"PARSER_ERROR")})},N=function(c,f){var g=f&&f.toc||{};Q(),S(g.tocByPlayOrder),d.initWithSpine(f&&f.spine),e.initWithToc(g.tocByPlayOrder);var h={parsedEPubInfo:f,fileMap:o,deliverable:c};return a.$broadcast("tw.ePub.metaData",h),b.resolve(h)},O=function(){d.clearData(),e.clearData(),m&&(m.destroy(),m=null),n&&(n.destroy(),n=null),o=null,p=null,q=null,r=Object.create(null)},P=function(){return m.getFiles()},Q=function(){for(var a=/\.htm$|\.html$|\.xhtml$|\.xml$/i,b=m&&m.getFiles(),c=n&&n.info.spine,d=c?c.length:0,e={},f=[],g=0,h=0,i=0;i<d;i++){var j=c[i].href,k=b[j];if(k&&a.test(j)){var l=k.headers.isEncrypted?16:0,p=Math.ceil((k.getCompressedSize()-l)/1024),q=g>0?1:0,r=e[j]=Object.create(null);r.start=g+q,r.size=k.getUncompressedSize(),r.index=f.length,r.pageStart=h+1,r.pageCount=p,g+=r.size+q,h+=p,f.push(j)}}return o={fileInfo:e,fileOrder:f,pagesTotal:h,totalSize:g}},R=function(){return o||Q()},S=function(a){p=Object.create(null),a&&a.forEach(function(a){a.src&&a.label&&!p[a.src]&&(p[a.src]=a.label)})},T=function(a){return p[a]||""},U=function(){return n&&n.getEPubInfo()||{}},V=function(){return n?n.getPackageInfo():b.resolve(null)},W=function(){return d.getCurrentSpineItem()},X=function(a){if(!m)return s("Empty ePub archive!","PARSER_ERROR");var b=m.getFiles();return a&&b[a]?b[a].extract():s('File "'+a+"\" not present in publication's ZIP archive","PARSER_ERROR")},Y=function(a){var c=[],d=[],e=U().spine,f=function(c){var e=c.parsedContent,f=e&&e.documentElement;if(f){var g=f.querySelectorAll(a);Array.prototype.forEach.call(g,function(a){d.push({name:c.name,node:a.nodeName})})}return b.resolve()};return e.forEach(function(a,b){c.push(t(b).then(f))}),b.all(c).then(function(){return d})};return{getMimeType:L,initWithArrayBuffer:M,clearData:O,getRawSection:t,getSectionByIndex:u,getSectionByName:v,getNameOfCurrentSection:z,getSectionNameByIndex:A,getSectionNameByReference:B,getSectionNameByPercentage:C,getRawContent:w,getSectionContent:x,getMediaOverlay:y,isScripted:D,isFirstSection:E,isLastSection:F,getViewport:G,getContentFileMap:R,getSectionLabel:T,getEPubInfo:U,getEPubPackageInfo:V,getCurrentSpineItem:W,getFiles:P,scanHTMLTags:Y,setCryptInfos:K}}]),angular.module("services").factory("PageNavHelper",["PagePartitioner",function(a){"use strict";return function(){function b(a){return c&&c[a]?(d=a,c[a]):null}var c=[],d=0;this.initWithDOMNode=function(b,d,e,f){!b||d?c=[{offset:0,height:f}]:(c=e&&a.calcPagingColumns(b)||a.calcPagePartitions(b,f,0),c&&0!==c.length||console.warn("No page partitions generated",b))},this.identifyPage=function(a){a=Math.round(a);for(var b=c&&a>0?c.length-1:0,d=0;d<b;d++)if(c[d].offset<=a&&a<c[d+1].offset)return d;return d>0?b:0},this.getCurrentPageNo=function(){return c?d:null},this.getNumberOfPages=function(){return c?c.length:0},this.getFirstPage=function(){return b(0)},this.getNextPage=function(){return b(d+1)},this.getPreviousPage=function(){return b(d-1)},this.getPageByReference=function(a){switch(a){case"first":return b(0);case"last":return b(c.length-1);case"next":return b(d+1);case"prev":case"previous":return b(d-1);case"current":return b(d);default:return b(a||0)}},this.getPageByOffset=function(a){return b(this.identifyPage(a))},this.getMaxOffset=function(){var a=c&&c[c.length-1];return a&&a.offset||0},this.setCurrentPageByIndex=function(a){c&&a>=0&&a<c.length&&(d=a)},this.isFirstPage=function(){return c&&0===d},this.isLastPage=function(){return c&&d===c.length-1}}}]),angular.module("services").service("sectionNavHelper",["$log",function(a){"use strict";var b=null,c=null,d=null,e=function(a){for(b=a;void 0===b[0]&&b.length>0;)b.shift();d=b.length-1},f=function(){b=null,c=null,d=null},g=function(){return b&&b[c]},h=function(){if(!b)return null;var a=b[c];return a&&a.href},i=function(a,d){d&&(a+=c);var e=b[a];return e?e.href:null},j=function(a){var e;if(!b)return null;switch(a){case"first":e=0;break;case"last":e=d;break;case"next":e=Math.min(c+1,d);break;case"prev":case"previous":e=Math.max(c-1,0);break;case"current":e=c}var f=b[e];return f&&f.href},k=function(a){if(b)for(var c=0;c<=d;c++){var e=b[c];if(e&&e.href===a)return c}return-1},l=function(b){var d=k(b);return d===-1?(a.warn('Could not set section by name, because there is no section named "'+b),!1):(c=d,!0)},m=function(a){return k(a)>-1},n=function(){return 0===c},o=function(){return c===d},p=function(){return d};return{initWithSpine:e,clearData:f,getCurrentSpineItem:g,getCurrentSection:h,getSectionByIndex:i,getSectionByRelativeReference:j,setSectionByName:l,isSectionInSpine:m,isFirstSection:n,isLastSection:o,getNoOfSections:p}}]),angular.module("services").factory("tocNavHelper",["$q","contentProvider",function(a,b){"use strict";function c(a){var b=a.childSequence||"";return{fileName:a.src,childSequence:b.split("/"),offset:0}}function d(){var a=b.getEPubInfo().toc,c=a&&a.tocByPlayOrder||[],d=b.getNameOfCurrentSection();return c.filter(function(a){return a.src===d})}function e(a){if(a)for(var b=d(),e=a.getRMSDKPosition(!0),f=b.length-1;f>=0;f--)if(a.compareLocalPosition(e,c(b[f]))>0)return b[f];return null}function f(a){if(a)for(var b=d(),e=a.getRMSDKPosition(!0),f=0,g=b.length;f<g;f++)if(a.compareLocalPosition(e,c(b[f]))<0)return b[f];return null}function g(c,e,f){function g(){return e()===j&&b.getNameOfCurrentSection()===i&&!f()}function h(b){var d=b>k;return c(d).then(function(){return g()?h(b+1):a.resolve()})}var i=b.getNameOfCurrentSection(),j=e(),k=d().length;return h(0)}return{getToCItemsOfSection:d,getPreviousToCItemOfSection:e,getNextToCItemOfSection:f,goToToCItem:g}}]),angular.module("services").factory("CSSPropertyStore",[function(){"use strict";var a=function(){this.propertyStore=Object.create(null)};return a.prototype.discard=function(a,b){var c,d=window.CSSRule,e=a&&a.cssRules||[],f=this.propertyStore[b];f||(f=this.propertyStore[b]=[]),Array.prototype.forEach.call(e,function(a){a.type===d.STYLE_RULE&&(c=a.style[b])?(f.push({rule:a,name:b,value:c,prio:a.style.getPropertyPriority(b)}),a.style.setProperty(b,"","")):a.type===d.MEDIA_RULE&&this.discard(a,b)},this)},a.prototype.restore=function(a){var b=this.propertyStore[a];b&&0!==b.length&&(b.forEach(function(b){b.name===a&&b.rule&&b.rule.style.setProperty(a,b.value,b.prio)}),b.length=0)},a.prototype.clear=function(){for(var a in this.propertyStore)this.propertyStore[a].length=0},a}]),angular.module("services").factory("delete",["$q","$http","$timeout","inventory","bosh","reseller","error","CONFIG",function(a,b,c,d,e,f,g,h){"use strict";var i={},j=[],k=!1,l=function(){k=!0},m=function(b){if(!angular.isArray(b)||b.length<1)return a.reject("no array given or no delivery found");for(var c,d=[],e=0;e<b.length;e++)c=a.defer(),i[b[e]]=c,d.push(c.promise),j.push(b[e]);return n(j.shift()),a.allComplete(d)},n=function(l){var m=d.getPubForDeliverable(l);if(m){var o=a.defer(),p=c(function(){o.resolve("TIMEOUT")},1e4);return e.fetchHeader(!0).then(function(a){return f.fetchConfig().then(function(e){var f=e.URL_BOOKSHELF+"deletecontent?deliverableId="+encodeURIComponent(l);return m.transactionid&&(f+="&transaction_id="+encodeURIComponent(m.transactionid)),b({method:"GET",url:f,timeout:o.promise,headers:a}).then(function(){return d.deletePublications([m.id]).then(function(){i[l].resolve(l)})},function(a){var b=a&&a.status,c=a&&a.data,e=c&&c.ResponseInfo&&c.ResponseInfo.responseStatus;if(e&&parseInt(e,10)===-72||e&&parseInt(e,10)===-307)return d.deletePublications([m.id]).then(function(){i[l].resolve(l)}).catch(function(){console.log(arguments),i[l].resolve(l)});if(0===b)k=!0;else if(401===b)return g.handleError({type:h.globals.ERROR.APP_INVALID_TOKEN,httpStatusCode:b,details:{httpError:a}},!0).then(function(){n(l)});i[l].reject(a.toString()+l)}).finally(function(){if(c.cancel(p),j.length>0&&!k)n(j.shift());else{if(k)for(var a=0;a<j.length;a++)i[j[a]].reject("Abort "+j[a]);j.length=0,k=!1,i={}}})},function(){i[l].reject(h.globals.ERROR.NO_CONFIG)})},null)}return i[l].reject("no publication for deliverableId "+l+" found")};return{deleteDeliverables:m,abort:l}}]),angular.module("services").factory("download",["$window","$rootScope","$q","$http","inventory","bosh","reseller","URLManager","CONFIG","error",function(a,b,c,d,e,f,g,h,i,j){"use strict";var k=!1,l=function(){k=!1},m=function(j,l){k=!0;var m=e.deliverables[j],n=e.getPubForDeliverable(j);return m&&n?f.fetchHeader(!0).then(function(e){var f=l?"HTML5_1":"external-download";return g.fetchConfig().then(function(g){var p=g.URL_BOOKSHELF+"cloud/downloadinfo/"+a.btoa(n.id)+"/"+a.btoa(m.id)+"/type/"+f;return d({method:"GET",url:p,headers:e}).then(function(a){if(!k)return c.reject(i.globals.ERROR.ABORT);var d=a.data&&a.data.DownloadInfo;if(200===a.status&&d){if("bosh"!==d.location)return{format:d.format,url:d.contentUrl,key:null,location:d.location};var f=c.defer(),g=new XMLHttpRequest;return g.open("GET",d.contentUrl,!0),g.setRequestHeader("t_auth_token",e.t_auth_token),g.setRequestHeader("hardware_id",e.hardware_id),g.setRequestHeader("reseller_id",e.reseller_id),g.responseType="blob",g.overrideMimeType(d.format),g.onprogress=function(a){k||g.abort(),a.lengthComputable&&b.$broadcast("tw.download.progress",{id:j,loaded:a.loaded,total:a.total})},g.onload=function(){f.resolve(g.response),k=!1,g=null},g.onerror=g.onabort=function(){f.reject(i.globals.ERROR.ABORT),k=!1,g=null},g.send(null),f.promise.then(function(a){return{key:d.contentUrl,format:d.format,url:h.createURL(d.contentUrl,a,d.format),blob:a,location:d.location}},null)}return c.reject("no valid answer in downloadinfo GET")},o.bind(null,j,l))},function(){return c.reject(i.globals.ERROR.APP_NO_CONFIG)})},null):c.reject("no publication or deliverable for "+j)},n=0,o=function(a,b,c){return j.handleError({type:i.globals.ERROR.NETWORK_BOSH_FAIL,httpStatusCode:c.status,details:{httpError:c}},!1).then(function(){return n+=1,n>1?(l(),j.handleError(null,!0)):m(a,b)})};return{fetchDownloadLink:m,abort:l}}]),angular.module("services").factory("EPubCover",["$q","$injector","Archive","EPubParser","FileUtil",function(a,b,c,d,e){"use strict";function f(a){return/\.(jpg|jpeg|png)$/i.test(a)}function g(b,c){var d=b&&b.getFile(c);return d?d.extract().then(function(a){return{name:c,data:f(c)?a:d.getFileContentAsDOM()}}):a.resolve()}function h(b,c){function d(a){return"cover"===a.type||"cover-image"===a.properties||/other\.ms-coverimage/i.test(a.type)}var h=c.manifest||[],i=c.guide||[],j=c.metadata.cover,k=j&&h.filter(function(a){return a.id===j})[0]||h.filter(d)[0];if(k)return g(b,k.href);if(k=i.filter(d)[0]){var l=e.resolveRelativePath(k.href,c.rootFolder);return f(l)?g(b,l):g(b,l).then(function(c){if(!c)return a.resolve();var d=c.data.querySelector("img, image"),f=d&&(d.getAttribute("src")||d.getAttribute("xlink:href")),h=e.resolveRelativePath(f,l);return g(b,h)})}return a.resolve()}return{extract:function(b){function e(b){var e=new c(b);if(!e||!e.files)return a.reject("No files in ePub archive found");var g=new d(e);g.parseEPub().then(function(a){h(e,a).then(f.resolve)},function(b){return a.reject(b)})}var f=a.defer();if(b instanceof ArrayBuffer)e(b);else{if(!(b instanceof File&&window.FileReader))return a.reject("Invalid ePubData or no FileReader support");var g=new FileReader;g.addEventListener("load",function(){this.readyState===FileReader.DONE&&e(this.result)},!1),g.readAsArrayBuffer(b)}return f.promise},upload:function(c,d){if(c&&d){var e=b.get("image"),f=b.get("URLManager"),g=b.get("uploader"),h=e.getMimeType(c.name),i=f.createBlob(c.data,h);return g.uploadBlob(i,c.name,d).then(function(){var a=b.get("$rootScope");a.$emit("tw.upload.done")}).catch(angular.noop)}return a.reject("coverFile missing")}}}]),angular.module("services").factory("EPubParser",["FileUtil","$q",function(a,b){"use strict";var c="META-INF/container.xml",d={getAttribute:function(){return null}},e=function(a){if(!a)return null;var b=a.lastIndexOf("\\");b===-1&&(b=a.lastIndexOf("/"));var c=a.substring(0,b);return c&&(c+="/"),c},f=function(a){var b=a&&a.getFileContentAsDOM(),c=b&&b.querySelector('rootfile[media-type="application/oebps-package+xml"]');return c?c.getAttribute("full-path"):(console.error("Could not find root file reference in ePub container file"),null)},g=function(a,b,c){var d=b.querySelectorAll("nav"),e=Array.prototype.filter.call(d,function(a){return"toc"===a.getAttribute("epub:type")})[0];if(e){var f=e.querySelector("nav > ol"),g=e.querySelector("nav > h1, nav > h2, nav > h3");return h(a,f,g,c,0)}return null},h=function(a,b,c,d,e){if(!b)return null;var f=Object.create(null);return f.label=c&&c.textContent.trim(),f.depth=e,f.items=b.children.length>0?[]:null,q(c,f,a,d),Array.prototype.forEach.call(b.children,function(b){var c=b.querySelector("li > a, li > span"),g=b.querySelector("li > ol");if(g)f.items.push(h(a,g,c,d,e+1));else if(c){var i=Object.create(null);i.label=c&&c.textContent.trim(),i.depth=e+1,q(c,i,a,d),f.items.push(i)}}),f},i=function(a,b,c){var d=b.split("#");this.label=a,this.fileName=d[0],this.anchorID=d[1],this.pageNum=c},j=function(b,c){var d=0;return b.forEach(function(b){b.fileName=a.resolveRelativePath(b.fileName,c.rootFolder),b.fileIndex=c.spineIndex[b.fileName],d=Math.max(d,b.pageNum)}),c.toc.numPagesTotal=d,b},k=function(){for(var a=0;a<arguments.length;a++){var b=parseInt(arguments[a],10);if(!isNaN(b))return b}},l=function(a){var b=a.querySelectorAll("page"),c=0;return Array.prototype.map.call(b,function(a){var b=a.getAttribute("name"),d=a.getAttribute("href");return c=k(b,c+1),new i(b,d,c)})},m=function(a){var b=a.querySelectorAll("pageTarget"),c=0;return Array.prototype.map.call(b,function(a){var b=a.querySelector("text"),d=a.querySelector("content"),e=a.getAttribute("value"),f=b&&b.textContent.trim()||e;return c=k(f,e,c+1),new i(f,d&&d.getAttribute("src"),c)})},n=function(a){var b=a.querySelectorAll("nav");return Array.prototype.filter.call(b,function(a){return"page-list"===a.getAttribute("epub:type")})[0]},o=function(a){if(!a)return null;var b=0;return Array.prototype.map.call(a.querySelectorAll("li > a"),function(a){var c=a.textContent.trim();return b=k(c,b+1),new i(c,a.getAttribute("href"),b)})},p=function(a,b,c,d){if(!b)return null;var e=Object.create(null);e.depth=d;for(var f=0,g=b.attributes.length;f<g;f++){var h=b.attributes[f];e[h.name]=h.value}for(f=0,g=b.childNodes.length;f<g;f++){var i=b.childNodes[f],j=i.nodeName.replace(/^ncx:/i,"");switch(j){case"navPoint":e.items=e.items||[],e.items.push(p(a,i,c,d+1));break;case"navLabel":e.label=i.textContent.trim();break;case"content":q(i,e,a)}}var k=parseInt(e.playOrder,10);return!isNaN(k)&&k>=0&&(c[k]=e),e},q=function(b,c,d,e){var f=b&&(b.getAttribute("src")||b.getAttribute("href"));if(f){var g=f.split("#");c.src=d+a.escapeFileName(g[0]),c.srcAnchor=g[1],e&&e.push(c)}},r=function(h){this.ePub=h;var i=this.info=Object.create(null),k=function(){var a=h.getFile(c);if(!a){var d="There is no file '"+c+"' available";return console.warn(d),b.reject(d)}return a.extract()},q=function(){return k().then(function(){i.rootFile||(i.rootFile=f(h.getFile(c)));var a=i.rootFile,d=a&&h.getFile(a);return d?(i.rootFolder=e(a),d.extract().then(function(){return d.getFileContentAsDOM()})):b.reject("Root file '"+a+"' not found")})},r=function(a){return a?a.extract().then(function(){return s(a)}):b.reject("No ToC file '"+i.tocFile+"' available")},s=function(a){var c=a.getFileContentAsDOM();if(!c)return b.reject("Could not parse ToC file '"+i.tocFile+"'");i.toc=Object.create(null);var d=c.querySelector("docTitle");i.toc.docTitle=d&&d.textContent.trim()||i.metadata["dc:title"];var e=[],f=c.querySelector("navMap");return i.toc.toc=f?p(i.rootFolder,f,e,0):g(i.rootFolder,c,e),i.toc.tocByPlayOrder=e,t(c)},t=function(a){var c=n(a);if(c)return i.toc.pageList=j(o(c),i),b.resolve(i);if(c=a.querySelector("pageList"))return i.toc.pageList=j(m(c),i),b.resolve(i);var d=b.defer();return u().then(function(a){return i.toc.pageList=a&&j(l(a),i),d.resolve(i)}),d.promise},u=function(){var a=i.manifest.filter(function(a){return"application/oebps-page-map+xml"===a["media-type"]})[0],c=a&&a.href,d=h.getFile(c);return d?d.extract().then(function(){return d.getFileContentAsDOM()}):b.resolve(null)},v=function(c){var e=c.querySelector("package").getAttribute("version");i.version=e&&parseFloat(e,10)||2,i.metadata=Object.create(null);var f=c.querySelectorAll("package > metadata > *");Array.prototype.forEach.call(f,function(a){var b=a.nodeName;"meta"===b&&(b=a.getAttribute("property")||a.getAttribute("name")),i.metadata[b]=a.textContent||a.getAttribute("content")});var g=c.querySelectorAll("package > manifest > item");i.manifest=Array.prototype.map.call(g,function(a){var b=Object.create(null);return b.id=a.getAttribute("id"),b.href=i.rootFolder+a.getAttribute("href"),b["media-type"]=a.getAttribute("media-type"),b.properties=a.getAttribute("properties"),b}),i.spine=[],i.spineIndex=Object.create(null);var j=c.querySelectorAll("package > spine > itemref");i.spine=Array.prototype.map.call(j,function(b,e){var f=b.getAttribute("idref")||"",g=b.getAttribute("properties"),h=Object.create(null),j=c.querySelector("package > manifest > item[id='"+f.replace(/'/g,"\\'")+"']");j||(console.warn('No manifest item found for spine entry "'+f+'"'),j=d);var k=i.rootFolder+a.escapeFileName(j.getAttribute("href"));return h.idref=f,h.href=k,h.linear="no"!==b.getAttribute("linear"),h["media-overlay"]=j.getAttribute("media-overlay"),h.properties=g&&g.split(" "),i.spineIndex[k]=e,h});var k=c.querySelectorAll("package > guide > reference");k&&k.length>0&&(i.guide=Array.prototype.map.call(k,function(a){var b=Object.create(null);return b.type=a.getAttribute("type"),b.title=a.getAttribute("title"),b.href=a.getAttribute("href"),b})),j=c.querySelector("package > spine");var l=j&&j.getAttribute("toc"),m=l&&c.querySelector('package > manifest > item[id="'+l+'"]')||c.querySelector("package > manifest > item[properties=nav]");if(m){var n=i.rootFolder+m.getAttribute("href"),o=h.getFile(n);return i.tocFile=n,r(o)}return i.toc=Object.create(null),b.resolve(i)};this.parseEPub=function(){return q().then(v)},this.getPackageInfo=q};return r.prototype.getEPubInfo=function(){return this.info||{}},r.prototype.destroy=function(){this.ePub=null,this.info=null},r}]),angular.module("services").service("EPubReadingSystem",[function(){"use strict";var a={"dom-manipulation":!0,"layout-changes":!0,"touch-events":window.Modernizr.touchevents,"mouse-events":!0,"keyboard-events":!0,"spine-scripting":!0};navigator.epubReadingSystem||(navigator.epubReadingSystem={});var b=navigator.epubReadingSystem;b.name="tolino webReader",b.version=window.tw&&window.tw.version||"1.0",b.layoutStyle="paginated",b.hasFeature=function(b){return a[b]},this.setLayoutStyle=function(a){b.layoutStyle=a}}]),angular.module("services").factory("MediaOverlay",["$rootScope","BaseUtil","CONFIG","HTML",function(a,b,c,d){"use strict";function e(a){var b;return(b=a.match(k))?3600*(b[3]||0)+60*b[4]+1*b[5]+.001*(b[7]||0):(b=a.match(l))?b[1]*(m[b[3]]||1):parseFloat(a,10)}function f(a,b){var c=a.lastIndexOf("#");return c>=0&&c+1<a.length?a.substr(c+1):b||a}function g(a){return a&&"#text"!==a.nodeName}function h(a,b){if(a&&"par"===a.nodeName){var c=a.querySelector("text"),d=a.querySelector("audio"),i=Object.create(null);return i.textRef=b,c&&(i.textID=f(c.getAttribute("src"))),d&&(i.mediaSrc=d.getAttribute("src"),i.begin=e(d.getAttribute("clipBegin")),i.end=e(d.getAttribute("clipEnd"))),i}if(!a||!a.childNodes)return null;var j=a.getAttribute("epub:textref");return j&&(b=b.concat(f(j,"#"))),Array.prototype.filter.call(a.childNodes,g).map(function(a){return h(a,b)})}var i="epub-media-overlay-active",j="epub-media-overlay-paused",k=/(((\d+):)?)([0-5]\d):([0-5]\d)([.](\d+))?/,l=/(\d+([.]\d+)?)(h|min|s|ms)?/,m={h:3600,min:60,s:1,ms:.001},n=1.5;return function(e){function f(){return C&&C[E]}function g(){window.LauncherUI||(window.LauncherUI="tolino_webReader"),B=e.createElement("audio"),B.setAttribute("id","tolino_webReader_media_overlay"),B.setAttribute("preload","auto"),B.addEventListener("play",v,!1),B.addEventListener("pause",w,!1),B.addEventListener("ended",x,!1),B.addEventListener("timeupdate",y,!1),B.addEventListener("canplay",z,!1)}function k(a,b){var e=C[a];if(e){var f=e.mediaSrc,g=B.getAttribute("data-src");if(f===g)return void l(e.begin);var h=f&&f.split(".").pop().toLowerCase(),i=c.globals.MIME_TYPES[h];i&&!B.canPlayType(i)&&console.warn('Media Overlay: file type "'+f+'" is not supported'),G=!0,H=!1,u("load"),d.getMediaURL(f,F).then(function(a){G=!1,a&&(B.setAttribute("data-src",f),B.setAttribute("src",a),b&&l(e.begin))})}}function l(a){var b=I.calc(a-B.currentTime);B.paused||Math.abs(a-B.currentTime)>n?B.currentTime=a:Math.abs(b)>=.3&&(B.playbackRate=I.getRate(B.currentTime/a)),B.play()}function m(){[D,j].forEach(function(a){var b=e.getElementsByClassName(a);Array.prototype.forEach.call(b,function(b){b.classList.remove(a)})})}function o(a){var b=f(),c=b&&b.textID;if(m(),c){var d=e.getElementById(c)||e.querySelector(c);d&&d.classList.add(a)}}function p(a){if(!G){if(void 0===a){if(E>=0)return void B.play();a=0}E=a,k(a,!0),o(D)}}function q(){var a=E+1;a<C.length?p(a):(B.pause(),r())}function r(){E=-1,B.playbackRate=1}function s(a,b){return b.textID===a||b.textRef.indexOf(a)>=0}function t(a){for(;a&&a!==e;){if(a.id){var b=C.findIndex(s.bind(null,a.id));if(b>=0)return b}a=a.parentNode}return-1}function u(b){a.$emit("tw.mediaoverlay.statechange",b)}function v(){var a=B.currentTime,b=B.getAttribute("data-src"),c=C.findIndex(function(c){return c.begin<=a&&a<c.end&&c.mediaSrc===b});c>=0&&(E=c,o(D)),u("play")}function w(){o(j),u("pause")}function x(){q()}function y(){var a=f();if(a){var b=B.currentTime;b>=a.end&&!B.paused&&q(),J()}}function z(){H||u("canplay"),H=!0}function A(a){var b=t(a.target);b>=0&&(a.stopPropagation(),p(b))}e||(e=document);var B,C,D,E=-1,F=Object.create(null),G=!1,H=!1,I=new function(){var a=.12;this.samples=[],this.sumSamples=0,this.calc=function(a){return this.samples.push(a),this.sumSamples+=a,this.samples.length>3&&(this.sumSamples-=this.samples.shift()),this.sumSamples/this.samples.length},this.getRate=function(b){return Math.max(1-a,Math.min(b,1+a))}},J=b.throttle(function(){var b=f();if(b){var c=(B.currentTime-b.begin)/(b.end-b.begin);a.$emit("tw.mediaoverlay.progress",b.textID,c)}},1500,{leading:!0,trailing:!1});this.init=function(a,b,c,d,f){var g=a&&a.querySelector("body");e=d.contentDocument,F.files=c,F.root=b.rootFolder||"",F.deliverableId=f||"",C=[].concat.apply([],h(g,[])),D=b.metadata["media:active-class"]||i,e.addEventListener("click",A,!0),r();var j=C.findIndex(function(a){return!!a.mediaSrc});k(j),B.parentNode||e.documentElement.appendChild(B)},this.terminate=function(){C&&(B.pause(),e.removeEventListener("click",A,!0),C=null,F.files=null,B.setAttribute("data-src",""),B.setAttribute("src",""),B.parentNode&&B.parentNode.removeChild(B))},this.play=p,this.pause=function(){B.pause()},this.stop=function(){B.pause(),r()},this.togglePlayback=function(){B.paused?p():B.pause()},this.isPaused=function(){return B.paused},this.getCurrentId=function(){var a=f();return a&&a.textID},this.isOverlayFragment=function(a){return C&&t(a)>=0},g()}}]),angular.module("services").factory("PageLocation",["BaseUtil","StringUtil",function(a,b){"use strict";var c=window.Modernizr.hasvalidtextoffset,d=/([^#]*)#point\(([^:\)]*):?(\d*)\)/i,e=function(b){return!a.isNewMetaNode(b)&&!a.isSplittedTextNode(b)},f=function(a){for(var b=-1;a;)e(a)&&b++,a=a.previousSibling;return b},g=function(a,b){for(var c=a&&a.firstChild;c&&(b>0||!e(c));)e(c)&&b--,c=c.nextSibling;return c||a.lastChild||a},h="_charCount",i={img:1,head:0,meta:0,style:0,script:0},j=function(a){if(!a)return 0;if(h in a)return a[h];var b=a.nodeName;if("#text"===b||"#cdata-section"===b||a.nodeType===Node.ENTITY_REFERENCE_NODE)return a.length;if(b in i)return i[b];for(var c=a.firstChild,d=0;c;)d+=j(c),c=c.nextSibling;return a[h]=d},k=function(b,c){for(var d,e=[];b&&b!==c;)a.isMetaNode(b)&&(e.length=0,b.previousSibling&&(b=b.previousSibling)),d=Math.max(0,f(b))+1,e.unshift(d),b=b.parentNode;return e.unshift(1),e},l=function(a,b){for(var c=b,d=1,e=a.length;d<e&&c;d++){var f=a[d]-1;c=g(c,f)}return c},m=function(b){return a.isTextNode(b)&&!a.isMetaNode(b.previousSibling)&&!a.isMetaNode(b.parentNode)},n=function(a){return parseInt(a,10)},o=function(a,b){for(var c=0;!0;c++){if(void 0===a[c])return void 0===b[c]?0:-1;if(void 0===b[c])return 1;var d=a[c]-b[c];if(0!==d)return d}},p=function(b,c){var d;if(b.nodeType===Node.TEXT_NODE&&b.length>0&&(d=a.getTextBoundingBox(b))&&d.right>c.left&&d.bottom-d.lineHeight>=c.top){if(d.left>=0)return!0;var e=a.getRange(b).getClientRects(),f=e[e.length-1];return f.right>c.left&&f.bottom>=c.top||(f=e[e.length-2])&&f.bottom>=c.top}return!1},q=function(b,c){var d=a.getBoundingBox(b);return d&&d.height>0&&d.right>c.left&&d.left<c.right&&d.bottom>c.top&&d.top<c.bottom},r=function(d,e,f,g){var h=this;this.setRootNode(d),this.setFileName(e),this.setNode(f),this.setCharOffset(g);var i=function(){for(var a=h.rootNode&&h.rootNode.querySelector("body");a&&a.firstElementChild;)a=a.firstElementChild;return a},j=function(){var a=h.rootNode&&h.rootNode.querySelector("body")||i();return a&&a.getBoundingClientRect()||{top:0,left:0}},n=function(){var c=h.node||i(),d=h.offset,e=c.parentNode;if(e&&a.isMetaNode(e)){for(;c.previousSibling;)c=c.previousSibling,d+=b.getByteOffset(c);c=e}for(;a.isSplittedTextNode(c)||a.isMetaNode(c);)c=c.previousSibling,d+=b.getByteOffset(c),a.isMetaNode(c)&&(c=c.previousSibling,d+=b.getByteOffset(c));return d},o=function(a){if(a={top:Math.floor(a.top),left:Math.floor(a.left),bottom:"bottom"in a?Math.floor(a.bottom):null,right:"right"in a?Math.floor(a.right):null},!c){var b=j();for(var d in a)a[d]-=b[d]!==a[d]?b[d]:0}return a},r=function(b,c,d,e){function f(a,b,c){if(b<=c)for(var d=b+c>>1,e=0;b<=d&&d<=c;){if(a[d].nodeType===Node.ELEMENT_NODE)return d;e=e>0?-e-1:-e+1,d+=e}return-1}function g(c,d,e){var h=f(c.childNodes,d,e);if(h<0)return null;var j=c.childNodes[h],k=i(j);if(k)return h;var l=a.getBoundingBox(j);return l?l.right<=b.left||l.bottom<=b.top?g(c,h+1,e):g(c,d,h-1):null;
}function i(a){var c,d,f=a?a.childNodes.length:0;if(1===f)c=i(a.firstChild);else if(f){var h,l=e?f-1:0,m=e?-1:f;if(f>50&&null!==(h=g(a,0,f-1)))for(;d=a.childNodes[h];){if(d.nodeType===Node.ELEMENT_NODE){var n=i(d);if(!n||h===l)break;c=n}h-=j}for(h=l;!c&&h!==m;h+=j)c=i(a.childNodes[h])}return c||k(a,b)&&a||null}var j=e?-1:1,k=d?p:q;return b=o(b),i(c||h.rootNode)};this.asRMSDKPositionString=function(a,b,c){return a||(a=this.fileName),b||(b=this.childSequence||[]),void 0===c&&(c=this.offset),a+"#point(/"+b.join("/")+":"+(c||"0")+")"},this.getRMSDKPosition=function(a){var c=[],d=0,e=this.node||i();if(e){c=k(e,this.rootNode),d=n();var f=b.getByteOffset(e);d>f&&m(e)&&(d=f-1)}return a?{fileName:this.fileName,childSequence:c,offset:d}:this.asRMSDKPositionString(this.fileName,c,d)},this.setRMSDKPosition=function(a){if(!this.rootNode)return console.log('Undefined publication root node for "'+a+'"'),!1;var b=this.parseRMSDKPosition(a),c=b&&b.fileName;return c!==this.fileName?(console.warn('requested file "'+c+'" different to current file "'+this.fileName+'"'),console.trace(),!1):(b.childSequence.length>1?(this.setNode(l(b.childSequence,this.rootNode)),this.setByteOffset(b.offset)):(console.warn('invalid child sequence defined by RMSDK position "'+a+'"'),this.setNode(this.rootNode.querySelector("body")),this.setByteOffset(0)),!0)},this.getRMSDKRange=function(a,b){var c=this.parseRMSDKPosition(a),d=this.parseRMSDKPosition(b);if(!this.rootNode||!c.fileName||!d.fileName)return null;if(this.compareLocalPosition(c,d)>0){var e=c;c=d,d=e}var f=document.createRange(),g=l(c.childSequence,this.rootNode),h=l(d.childSequence,this.rootNode);return this.setRangeBoundary(f,g,c.offset,f.setStart),this.setRangeBoundary(f,h,d.offset,f.setEnd),f},this.getChildSequence=function(a){return a?this.childSequence:this.childSequence.join("/")},this.getChildSequenceForAnchorID=function(a,b){var c,d;return this.rootNode?(a&&null!==(c=this.rootNode.querySelector("[id='"+a+"']"))||(c=i()),d=k(c,this.rootNode),b?d:d.join("/")):""},this.getOffsetPosition=function(d){var e,f,g,h=this.node||i();if(!h)return null;d||(d="top");var k=j();if(a.isTextNode(h))for(f=this.offset;f>=(g=b.getByteOffset(h))&&h.nextSibling;)f-=g,h=h.nextSibling;return h.nodeType===Node.ELEMENT_NODE?(e=a.getBoundingBox(h),e[d]-k[d]):(e=a.getTextBoundingBox(h,f),e&&e[d]-(c?k[d]:0))},this.setByRange=function(a){switch(a.startContainer.nodeType){case Node.TEXT_NODE:case Node.COMMENT_NODE:case Node.CDATA_SECTION_NODE:this.setNode(a.startContainer),this.setCharOffset(a.startOffset);break;default:this.setNode(a.startContainer.childNodes[a.startOffset]),this.setByteOffset(0)}},this.setByClientRectangle=function(a,b){var c=this.rootNode;if(c){c=c.querySelector("body")||c;var d=r(a,c,!1,b)||i(),e=this.getRangeAtPosition(a,d,!0),f=e&&(b?e.endOffset:e.startOffset);this.setNode(d),this.setCharOffset(f||0)}},this.getFirstNodeAtClientRectangle=function(a,b,c){return r(a,b,c)},this.getLastNodeAtClientRectangle=function(a,b,c){return r(a,b,c,!0)},this.isNodeInViewport=function(b,c,d,e){function f(a){return d&&b.left<=a.left&&a.right<=b.right||!d&&b.top<a.bottom&&a.top<b.bottom}var g=a.getBoundingBox(c);if(0===g.width)return f(g);var h=a.getRange(c).getClientRects();if(e>=0){var i=h.length-1,j=Math.min(Math.floor(i*e),i);return f(h[j])}return Array.prototype.some.call(h,f)},this.getRangeAtPosition=function(b,d,e){var f,g=Math.floor(b.left),h=Math.floor(b.top);if(!c){var i=j();g-=i.left!==g?i.left:0,h-=i.top!==h?i.top:0}var k=function(a,b){f.setStart(d,a),f.setEnd(d,b);for(var c=f.getClientRects(),e=Math.max(1,Math.floor((b-a)/(c.length+1))),i=c[0];i&&(i.left<g||i.bottom<h)&&a<b;)a+=e,f.setStart(d,Math.min(a,b-1)),i=f.getClientRects()[0];f.setEnd(d,Math.min(a+1,b))},l=function(a,b){for(var c,e;a<b-1;)c=a+b>>1,f.setStart(d,c),e=f.getClientRects(),1===e.length?b=c:a=c;f.setStart(d,b)},m=function(a,b){for(var c,e;a<b-1;)c=a+b>>1,f.setEnd(d,c),e=f.getClientRects(),1===e.length?a=c:b=c;f.setEnd(d,a<b?a:b)},n=function(a){for(var b=f.startOffset,c=f.endOffset-1,e=f.getClientRects()[0],g=0;b<c&&e&&e.left<a;){if(g=f.toString().search(/\s/)+1,0===g)return;b+=g,f.setStart(d,b),e=f.getClientRects()[0]}f.setStart(d,b-g),g&&f.setEnd(d,b-1)};return d&&d.parentNode&&(!a.isTextNode(d)&&d.firstChild&&(d=d.firstChild),f=document.createRange(),f.selectNode(d),k(0,d.length),void 0!==e&&(l(0,f.startOffset),m(f.endOffset,d.length),"number"==typeof e&&n(e))),f}};return r.prototype.setRootNode=function(a){this.rootNode=a},r.prototype.setFileName=function(a){this.fileName=a},r.prototype.setNode=function(a){(null===a||a&&a.parentNode)&&(this.node=a,this.childSequence=k(a,this.rootNode))},r.prototype.setByteOffset=function(a){this.offset=a||0},r.prototype.setCharOffset=function(a){this.offset=this.node&&a>0?b.lengthInUTF8Bytes(this.node.textContent.substr(0,a)):a||0},r.prototype.parseRMSDKPosition=function(a){var b="",c=[],e=0,f=a&&a.match(d);return f&&(b=f[1],c=f[2].split("/").map(n),c.length>0&&isNaN(c[0])&&c.shift(),e=parseInt(f[3],10),isNaN(e)&&(e=0)),{fileName:b,childSequence:c,offset:e}},r.prototype.parseRMSDKFileName=function(a){return a?a.substr(0,a.indexOf("#")):""},r.prototype.setRangeBoundary=function(c,d,e,f){var g=function(){for(var a;d.nextSibling&&e>=(a=b.getByteOffset(d));)e-=a,d=d.nextSibling};for(g();e>0&&d.childNodes.length>0;)d=d.firstChild,g();e=a.isTextNode(d)?Math.max(0,Math.min(b.getCharOffsetForUTF8Bytes(d.textContent,e),d.length)):Math.max(0,Math.min(e,d.childNodes.length-1)),f.call(c,d,e)},r.prototype.getOffsetNode=function(b,c){return a.isTextNode(b)?b:g(b,c)},r.prototype.compareLocalPosition=function(a,b){return o(a.childSequence,b.childSequence)||a.offset-b.offset},r.prototype.isEqualTo=function(a){return!(!a||this.fileName!==a.fileName||this.offset!==a.offset)&&(this.childSequence.length===a.childSequence.length&&0===o(this.childSequence,a.childSequence))},r.prototype.getPageNumberByList=function(a){var b=a.toc&&a.toc.pageList;if(!b)return-1;for(var c=a.spineIndex[this.fileName]||0,d={pageNum:0},e=0,f=b.length;e<f;e++){var g=b[e];if(g.fileIndex>c)return d.pageNum;if(g.fileIndex===c&&o(this.getChildSequenceForAnchorID(g.anchorID,!0),this.childSequence)>=0)return d.fileIndex===c?d.pageNum:g.pageNum;d=g}return d.pageNum},r.prototype.getCharCountForNode=j,r.prototype.getCharCount=function(){var a=this.node;if(!a)return 0;for(var b=a.ownerDocument.querySelector("body"),c=a.nodeType===Node.TEXT_NODE&&this.offset||0;a&&a!==b;){for(var d=a.parentNode;null!==(a=a.previousSibling);)c+=j(a);a=d}return c},r.prototype.copyPosition=function(a){this.setRootNode(a.rootNode),this.setFileName(a.fileName),this.setNode(a.node),this.setByteOffset(a.offset)},r.prototype.clearPosition=function(){this.rootNode=null,this.fileName=null,this.node=null,this.childSequence=null,this.offset=0},r.prototype.destroy=function(){this.clearPosition()},r}]),angular.module("services").service("PagePartitioner",["CONFIG","BaseUtil",function(a,b){"use strict";var c={AUDIO:!0,CANVAS:!0,EMBED:!0,IFRAME:!0,IMG:!0,PICTURE:!0,MATH:!0,OBJECT:!0,SVG:!0,VIDEO:!0,H1:!0,H2:!0,H3:!0,H4:!0,H5:!0,H6:!0,HEADER:!0,HGROUP:!0},d=[0,1/3,.5,2/3,1],e=a.globals.READER.SPACER_CLASSNAME,f={pagePartitions:[],offsetChildren:[],orphans:1},g=function(a,b,d,e){if(b>f.viewportHeight||"IMG"===e||1===d||0===d)return!0;if(0===a.childNodes.length||null===d||c[e])return!1;for(var g=a.children.length-1;g>=0;g--){var h=a.children[g];if(e=h.nodeName.toUpperCase(),c[e]&&b<h.getBoundingClientRect().height+d)return!1}return!0},h=function(a,b){if(a<.25*f.viewportHeight)return 0;for(var c=a/b,e=d.length-1;e>=0;e--)if(c>=d[e]){c=d[e];break}return Math.floor(c*b)},i=function(a){if(!a||a.nodeType!==Node.TEXT_NODE)return 0;var b=document.createRange();b.selectNode(a);for(var c=b.getClientRects(),d=0,e=c.length;d<e&&c[d].bottom<=f.viewportBottom;)d++;return d>0?c[d-1].bottom-c[0].top:0},j=function(a,c){var d,e,j=b.getComputedStyle(a,"lineHeight"),k=a.nodeName.toUpperCase(),l=c.top-f.topOfCurrPartition,m=0,n=function(a){var c,d,g,h=0,j=a.childNodes?a.childNodes.length:0;if(0===j)return 0;for(var k=0;k<j;k++)if(d=a.childNodes[k],g=b.getBoundingBox(d),g&&0!==g.height){if(g.top>f.viewportBottom)return null;if(g.top>=e)return Math.round(Math.min(g.top-f.topOfCurrPartition,f.viewportBottom));if(g.bottom>=e&&g.bottom<=f.viewportBottom)return Math.round(g.bottom-f.topOfCurrPartition);if(g.bottom>f.viewportBottom){if(d.nodeType===Node.TEXT_NODE)return h=i(d),Math.round(g.top-f.topOfCurrPartition+h);if(d.nodeType===Node.ELEMENT_NODE&&(c=n(d)))return c}}return null};if(g(a,c.height,j,k)){if("IMG"===k||j<=1){l>=0?(m=b.getComputedStyle(a,"paddingTop")||0,m+=b.getComputedStyle(a,"borderTopWidth")||0,d=f.viewportBottom-c.top-m):(l=0,d=f.viewportHeight);var o=h(d,c.height);return Math.round(c.top-f.topOfCurrPartition+(o>0?o+m:0))}e=f.viewportBottom-f.orphans*j;var p=n(a);return null===p?f.viewportHeight:p}return Math.round(l>=0?l:f.viewportHeight)},k=function(a,b,c){var d;do c>0?(d=c,c=0):b.bottom>f.viewportBottom?d=j(a,b):b.bottom>f.topOfCurrPartition?d=Math.round(b.bottom-f.topOfCurrPartition):(console.log("addPartitions: splitnode %o (top: %dpx, h: %dpx) is outside viewport!",a,b.top,b.height),d=f.viewportHeight),(d<=0||d>f.viewportHeight)&&(console.log("Invalid PartitionHeight: %spx set to %spx at page %s",d,f.viewportHeight,f.pagePartitions.length),d=f.viewportHeight),f.pagePartitions.push({offset:f.topOfCurrPartition-f.readerTop,height:d}),f.topOfCurrPartition+=d,f.viewportBottom=f.topOfCurrPartition+f.viewportHeight;while(b.bottom>f.viewportBottom)},l=function(a){for(var c=a.children&&a.children.length||0,d=0;d<c;d++){var e=b.getComputedStyle(a.children[d],"display");if(0!==e.indexOf("inline"))return!1}return!0},m=function(){var a,b,c,d,e,g,h,i=f.offsetChildren.length-1,m=[],n=0,o=0;for(d=0;d<=i;d++)if(a=f.offsetChildren[d].node,b=f.offsetChildren[d].bbox,!(b.bottom<=f.viewportBottom&&(b.bottom>o&&(o=b.bottom,n=d),d<i)||b.top<=f.viewportBottom&&(l(a)&&m.push({index:d,bbox:b}),d<i))){if(0===m.length)g=null,d=n;else{for(g=f.viewportHeight,e=m.length-1;e>=0;e--)n=m[e].index,b=m[e].bbox,a=f.offsetChildren[n].node,h=j(a,b),h<g&&(g=h,d=n);m.length=0}c=f.offsetChildren[d],k(c.node,c.bbox,g)}},n=function(a){for(var b=a.children&&a.children.length||0,c=0;c<b;c++){var d=a.children[c];d.offsetParent&&(d.offsetHeight>0&&o(d),d.childElementCount>0&&n(d))}},o=function(a){var b=f.offsetChildren.length,c=Object.create(null);if(c.node=a,c.bbox=a.getBoundingClientRect(),0===b)return void(f.offsetChildren[0]=c);for(var d=c.bbox.top;b>0&&d<f.offsetChildren[b-1].bbox.top;)b--;f.offsetChildren.splice(b,0,c)},p=function(a){return a&&0!==a.offsetWidth?Math.max(0,a.parentNode.offsetWidth-a.offsetWidth):64},q=function(a){var b=a.getElementsByClassName(e)[0];if(!b)return console.warn("getSectionEndOffset: section end marker not found"),0;var c=b.getBoundingClientRect().left,d=b.parentNode.getBoundingClientRect().left;return c-d},r=function(a){var b=p(a),c=a.offsetWidth+b,d=q(a),e=Math.floor(d/c);return 0===c&&console.warn("Calculate paging parameter: column width is 0"),isNaN(e)&&(e=0),{columnCount:e+1,columnGap:b,columnWidth:c}};this.getPagingColumnGap=p,this.calculatePagingParams=r,this.calcPagingColumns=function(a){if(f.pagePartitions.length=0,a)for(var b=r(a),c=0;c<b.columnCount;c++)f.pagePartitions.push({offset:Math.round(c*b.columnWidth)});return f.pagePartitions},this.calcPagePartitions=function(a,b,c){if(f.pagePartitions.length=0,a&&b>0){if(f.contentRoot=a,f.readerTop=c||0,f.topOfCurrPartition=c||0,f.viewportHeight=b,f.viewportBottom=f.readerTop+b,n(a),f.offsetChildren.length>0){m();var d=f.pagePartitions[f.pagePartitions.length-1];d.height=b,f.offsetChildren.length=0}else console.warn("Content node doesn't contain any offsetchildren - page partitioning aborted");f.contentRoot=null}return f.pagePartitions}}]),angular.module("services").factory("ScriptSupport",["BaseUtil","HTML","URLManager",function(a,b,c){"use strict";function d(a){return a.toString().match(/(function|object)\s*([^\s\(\]]+)/)[2]}function e(b,c,d){b&&b.classList&&/^(click|mouseup|mousedown|touchend)$/.test(c)&&a.setClass(b,"is-interactive-elem",d)}function f(a){var b=a[j];for(var c in b)for(var d=b[c],e=d.length-1;e>=0;e--)a.removeEventListener(c,d[e])}var g=/^Cannot read property .* of undefined$|^undefined is not an object/,h=2e3,i=1,j="_eventListeners",k=[Node,HTMLAnchorElement,HTMLBodyElement,HTMLCanvasElement,HTMLDivElement,HTMLImageElement,HTMLLIElement,SVGSVGElement,SVGGElement,SVGRectElement,SVGPathElement];return function(a){function l(){return a.Audio===t}function m(){B.Audio=a.Audio,B.Image=a.Image,B.createElement=a.Document.prototype.createElement,B.load=a.HTMLMediaElement.prototype.load,B.play=a.HTMLMediaElement.prototype.play,B.addEventListener=Object.create(null),B.removeEventListener=Object.create(null),q(a).forEach(function(a){var b=d(a),c=a.prototype||a;B.addEventListener[b]=c.addEventListener,B.removeEventListener[b]=c.removeEventListener})}function n(){a&&l()&&(a.Audio=B.Audio,a.Image=B.Image,a.Document.prototype.createElement=B.createElement,a.HTMLMediaElement.prototype.load=B.load,a.HTMLMediaElement.prototype.play=B.play,q(a).forEach(function(a){var b=d(a),c=a.prototype||a;c.addEventListener=B.addEventListener[b],c.removeEventListener=B.removeEventListener[b]}))}function o(a){var d=this,e=b.getSupportedMediaSource(d),f=e&&e.getAttribute("src");d.onerror=null,d.removeEventListener("error",o,!1),d.removeEventListener("load",o,!1),"error"===a.type&&f&&(a.stopImmediatePropagation(),c.isStoredURL(f)||d.setAttribute("data-src",f),b.getMediaURL(f,D).then(function(a){a&&d.setAttribute("src",a)}))}function p(){var c=this,d=c.getAttribute("src");c.removeEventListener("error",p,!1),b.getScriptContent(d,D).then(function(b){if(b){var e=a.document.querySelector("head, body")||a.document;e.appendChild(c),c.removeAttribute("src"),c.appendChild(document.createTextNode(b)),v(b,d,i)}})}function q(a){var b=[a,a.document,a.HTMLElement||a.Element].concat(k);return a.HTMLSpanElement&&b.push(HTMLSpanElement),a.XMLDocument&&b.push(XMLDocument),b}function r(a){var b=B.createElement.call(this,a);return b&&/^script$/i.test(a)&&b.addEventListener("error",p,!1),b&&/^(audio|video)$/i.test(a)&&C.push(b),b}function s(){for(var a=new B.Image,b=["width","height"],c=0,d=Math.min(arguments.length,b.length);c<d;c++)a.setAttribute(b[c],arguments[c]);return a.addEventListener("error",o,!1),a.addEventListener("load",o,!1),a}function t(a){var c=new B.Audio;return c.addEventListener("error",o,!1),c.addEventListener("load",o,!1),a&&(c.setAttribute("data-src",a),b.getMediaURL(a,D).then(function(a){var b=c.paused;c.setAttribute("src",a),b||c.play()})),C.push(c),c}function u(){C.forEach(function(a){a.pause(),a.src="",a.load()}),C.length=0}function v(b,c,d){if(b=b&&b.textContent||b)try{a.eval(b)}catch(a){console.warn("Error evaluating script","string"==typeof c?c:"",a.message),d="number"==typeof d?d:0,g.test(a.message)&&d>0&&window.setTimeout(v.bind(null,b,c,--d),h)}}function w(a){var b=a&&a.target,c="error"===a.type&&E[b.nodeName];c&&c.call(b,a)}function x(){var a=this,d=b.getSupportedMediaSource(a),e=d&&d.getAttribute("src");e&&!c.isStoredURL(e)&&(d.setAttribute("data-src",e),b.getMediaURL(e,D).then(function(b){d.setAttribute("src",b),B.load.call(a)}))}function y(){var a=this,d=b.getSupportedMediaSource(a),e=d&&d.getAttribute("src");return c.isStoredURL(e)?B.play.call(a):e?(d.setAttribute("data-src",e),b.getMediaURL(e,D).then(function(b){return d.setAttribute("src",b),B.play.call(a)})):void 0}function z(a,b,c){var d=a[j]||(a[j]={});b in d||(d[b]=[]),d[b].indexOf(c)===-1&&(d[b].push(c),e(a,b,!0))}function A(a,b,c){var d=a[j],f=d&&d[b]||[],g=f.indexOf(c);g!==-1&&(f.splice(g,1),0===f.length&&(delete d[b],e(a,b,!1)))}var B=Object.create(null),C=[],D=Object.create(null),E={AUDIO:o,IMG:o,SCRIPT:p,VIDEO:o};this.setEPubData=function(a,b,c){D.files=a,D.root=b||"",D.deliverableId=c||""},this.patchPrototypeMethods=function(){a&&!l()&&(a.Audio=t,a.Image=s,a.Document.prototype.createElement=r,a.HTMLMediaElement.prototype.load=x,a.HTMLMediaElement.prototype.play=y,q(a).forEach(function(a){var b=d(a),c=a.prototype||a;c.addEventListener=function(a,c,d){var e=B.addEventListener[b];e.call(this,a,c,d),z(this,a,c)},c.removeEventListener=function(a,c,d){var e=B.removeEventListener[b];e.call(this,a,c,d),A(this,a,c)}}))},this.identifyClickableTargets=function(){var b=a.document;b&&["click","mouseup","touchend"].forEach(function(a){var c=b.querySelectorAll("[on"+a+"]");Array.prototype.forEach.call(c,function(b){e(b,a,!0)})})},this.evaluateScript=v,this.genericErrorHandler=w,this.removeEventListeners=function(a){a instanceof Array||a instanceof NodeList?Array.prototype.forEach.call(a,f):f(a)},this.getEventListeners=function(a,b){var c=a&&a[j]||Object.create(null);return b?c[b]||[]:c},this.hasEventListener=function(a,b){function c(a){return a in d&&d[a].length>0}var d=a&&a[j];return!!d&&(b?b instanceof Array?b.some(c):c(b):Object.keys(d).length>0)},this.setContext=function(b){b!==a&&"[object Window]"===Object.prototype.toString.call(b)&&(a=b)},this.reset=function(){u(),n()},a||(a=window),m()}}]),angular.module("services").factory("error",["$window","$q","$rootScope","$injector","CONFIG","$timeout",function(a,b,c,d,e,f){"use strict";var g=e.globals.ERROR,h="tw_retryStateUpdate",i=function(a){return a=a||{},a.type=a.type||g.APP_GENERAL_ERROR,a.httpStatusCode=a.httpStatusCode||null,a.statusCode=a.statusCode||null,a.details=a.details||null,a.ui=a.ui||{},a.ui.headline=a.ui.headline||gettext("SERVER_ERROR_TITLE"),a.ui.message=a.ui.message||gettext("SERVER_ERROR_TEXT"),a.ui.dialogId=a.ui.dialogId||null,a},j=function(a){try{var b,c=JSON.stringify(a);return c.indexOf("t_authToken")>-1&&(b=/t_auth_token['"]?:['"]?[^"']*["']?/,c=c.replace(b,"REMOVED_TOKEN")),c.indexOf("hardware_id")>-1&&(b=/hardware_id['"]?:['"]?[^"']*["']?/,c=c.replace(b,"REMOVED_HARDWARE")),JSON.parse(c)}catch(a){console.warn("tw.services.error: Was not able to sanitize paramters")}return a},k=function(){var c=a.sessionStorage.getItem(h);if("true"===c)return b.reject();a.sessionStorage.setItem(h,"true");var e=d.get("$state"),f=e.current;return e.go(f.name,f.params)},l=function(c){a.sessionStorage.removeItem(h);var e=d.get("$state");return e.go("sorry",c).then(b.reject,b.reject)},m=function(a){return c.$emit("tw.component.error",a),f(angular.noop),b.reject()},n=function(a,b){return b?m({headline:a.ui.headline,message:a.ui.message}):l({type:a.type,headline:a.ui.headline,message:a.ui.message,details:a.details})},o=function(c){var f=d.get("reseller"),g=d.get("bosh"),h=d.get("$http");return f.fetchConfig().then(function(d){var f={traceContent:{contents:[]}};return f.traceContent.contents.push(c),g.fetchHeader(!0).then(function(c){var g=d.URL_BOOKSHELF;return a.navigator.onLine?h({method:"POST",url:g+"trace/",headers:c,data:f}):b.reject(e.globals.ERROR.NETWORK_OFFLINE)})},function(){return b.reject(e.globals.ERROR.APP_NO_CONFIG)})},p=function(b,c){var e=d.get("bosh");if(e&&e.isBoshOnline()&&b.bosh){var f={anid:"x",appversion:a.tw.version+"("+a.tw.githash+")",deliverableid:b.details&&b.details.deliverableId||"",details:"",hardwareid:"x",hardwaretype:"HTML5",os:"HTML_5",message:b.ui.message,title:b.type,level:"ERROR",data:0,timestamp:Date.now(),code:"0"};o(f)}return n(b,c)},q=function(){console.trace("User error");var c=function(){var a=d.get("appState"),b=d.get("bosh"),c=d.get("inventory"),f=d.get("cover"),g=d.get("sync");return b.deleteUser(),g.purge(),a.remove(e.globals.SHELF_REVISION),f.purge(),c.purge()};return a.localforage.clear().then(c,c).then(function(){return console.warn("Removed old user"),b.resolve()})},r=function(){var a=d.get("token");return a.removeAccessToken(),a.fetchToken()},s=function(){var a=d.get("bosh");return a.deleteUser(),a.fetchHeader()},t=function(c,e){var f=c.httpStatusCode;if(!isNaN(f)&&f>0&&!a.navigator.onLine)return c.type=g.NETWORK_OFFLINE,n(c,e);switch(f){case-1:return c.details&&c.details.statusCode?u(c,e):b.resolve();case 0:if(a.Modernizr.isie)return r(c,e);var h=d.get("bosh");return a.Modernizr.isfirefox||!h.isBoshOnline()?(c.type=g.NETWORK_OFFLINE,h.setBoshOnline(!1),n(c,e)):k().then(null,function(){return n(c,e)});case 400:case 403:return u(c,e);case 401:return r(c,e);case 406:return q(c,e);default:case 200:}},u=function(a,c){var f,g=a.details.httpError.data&&a.details.httpError.data.ResponseInfo.responseStatus;switch(parseInt(g,10)){case-100:return s(a,c);case-104:return r(a,c);case-115:case-120:break;case-204:case-205:return f=d.get("appState"),f.remove(e.globals.SHELF_REVISION),b.reject();case-206:break;case-500:f=d.get("appState"),f.remove(e.globals.SHELF_REVISION);var h=d.get("sync");return h.purge(),b.reject();case-1:case-503:return console.error(parseInt(g,10)+"<- BOSH ERROR"),b.resolve();default:var i=d.get("token");return i.removeAccessToken(),i.revokeToken().then(q.bind(this,a,c))}},v=function(a,b){return console.log("handleError",a),a=i(a),a.details=j(a.details),a.type===g.APP_CONTENT_DELIVERABLE_FAIL||a.type===g.APP_CONTENT_PARSER_FAIL?p(a,b):a.type===g.APP_INVALID_USER?q(a,b):a.type===g.APP_INVALID_TOKEN?r(a,b):a.httpStatusCode?t(a,b):a.statusCode?u(a,b):n(a,b)};return{handleError:v}}]),angular.module("services").factory("finishedItems",["$rootScope","CONFIG","inventory","sync","time",function(a,b,c,d,e){"use strict";function f(a,b){return a.tags.findIndex(function(a){return"string"==typeof a.name&&a.category===j&&a.name===k&&(b||!a.deleted)})}function g(a){return f(a)>=0}function h(a){var b,g=f(a,!0);g>=0?(b=a.tags[g],b.deleted=!1):(b={name:k,category:j},a.tags.push(b)),b.modified=e.getTime(),l(a),c.saveDeliverable(a.id),d.sync([a])}function i(a){var b=f(a);if(b>=0){var g=a.tags[b];g.deleted=!0,g.modified=e.getTime(),c.saveDeliverable(a.id),d.sync([a])}}var j=b.globals.MISC.SYSTEM_CATEGORY,k=b.globals.STORE.TAG_FINISHED_READINGS,l=function(a){var b=a&&a.bookmark;b&&(b.currentPage=b.lastPage||0,b.progress=1)};return a.$on("tw.library.mark.finished",function(a,b,d){var e=c.deliverables[b];e&&(e.isFinished="boolean"==typeof d?d:!g(e),e.isFinished?h(e):i(e))}),{hasFinishedTag:g,addFinishedTag:h,removeFinishedTag:i}}]),angular.module("services").filter("notFinishedItems",[function(){"use strict";return function(a){return a&&"function"==typeof a.filter?a.filter(function(a){return!a.isFinished}):a}}]),angular.module("services").service("Encoding",[function(){"use strict";var a=[".notdef","space","exclam","quotedbl","numbersign","dollar","percent","ampersand","quoteright","parenleft","parenright","asterisk","plus","comma","hyphen","period","slash","zero","one","two","three","four","five","six","seven","eight","nine","colon","semicolon","less","equal","greater","question","at","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","bracketleft","backslash","bracketright","asciicircum","underscore","quoteleft","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","braceleft","bar","braceright","asciitilde","exclamdown","cent","sterling","fraction","yen","florin","section","currency","quotesingle","quotedblleft","guillemotleft","guilsinglleft","guilsinglright","fi","fl","endash","dagger","daggerdbl","periodcentered","paragraph","bullet","quotesinglbase","quotedblbase","quotedblright","guillemotright","ellipsis","perthousand","questiondown","grave","acute","circumflex","tilde","macron","breve","dotaccent","dieresis","ring","cedilla","hungarumlaut","ogonek","caron","emdash","AE","ordfeminine","Lslash","Oslash","OE","ordmasculine","ae","dotlessi","lslash","oslash","oe","germandbls","onesuperior","logicalnot","mu","trademark","Eth","onehalf","plusminus","Thorn","onequarter","divide","brokenbar","degree","thorn","threequarters","twosuperior","registered","minus","eth","multiply","threesuperior","copyright","Aacute","Acircumflex","Adieresis","Agrave","Aring","Atilde","Ccedilla","Eacute","Ecircumflex","Edieresis","Egrave","Iacute","Icircumflex","Idieresis","Igrave","Ntilde","Oacute","Ocircumflex","Odieresis","Ograve","Otilde","Scaron","Uacute","Ucircumflex","Udieresis","Ugrave","Yacute","Ydieresis","Zcaron","aacute","acircumflex","adieresis","agrave","aring","atilde","ccedilla","eacute","ecircumflex","edieresis","egrave","iacute","icircumflex","idieresis","igrave","ntilde","oacute","ocircumflex","odieresis","ograve","otilde","scaron","uacute","ucircumflex","udieresis","ugrave","yacute","ydieresis","zcaron","exclamsmall","Hungarumlautsmall","dollaroldstyle","dollarsuperior","ampersandsmall","Acutesmall","parenleftsuperior","parenrightsuperior","266 ff","onedotenleader","zerooldstyle","oneoldstyle","twooldstyle","threeoldstyle","fouroldstyle","fiveoldstyle","sixoldstyle","sevenoldstyle","eightoldstyle","nineoldstyle","commasuperior","threequartersemdash","periodsuperior","questionsmall","asuperior","bsuperior","centsuperior","dsuperior","esuperior","isuperior","lsuperior","msuperior","nsuperior","osuperior","rsuperior","ssuperior","tsuperior","ff","ffi","ffl","parenleftinferior","parenrightinferior","Circumflexsmall","hyphensuperior","Gravesmall","Asmall","Bsmall","Csmall","Dsmall","Esmall","Fsmall","Gsmall","Hsmall","Ismall","Jsmall","Ksmall","Lsmall","Msmall","Nsmall","Osmall","Psmall","Qsmall","Rsmall","Ssmall","Tsmall","Usmall","Vsmall","Wsmall","Xsmall","Ysmall","Zsmall","colonmonetary","onefitted","rupiah","Tildesmall","exclamdownsmall","centoldstyle","Lslashsmall","Scaronsmall","Zcaronsmall","Dieresissmall","Brevesmall","Caronsmall","Dotaccentsmall","Macronsmall","figuredash","hypheninferior","Ogoneksmall","Ringsmall","Cedillasmall","questiondownsmall","oneeighth","threeeighths","fiveeighths","seveneighths","onethird","twothirds","zerosuperior","foursuperior","fivesuperior","sixsuperior","sevensuperior","eightsuperior","ninesuperior","zeroinferior","oneinferior","twoinferior","threeinferior","fourinferior","fiveinferior","sixinferior","seveninferior","eightinferior","nineinferior","centinferior","dollarinferior","periodinferior","commainferior","Agravesmall","Aacutesmall","Acircumflexsmall","Atildesmall","Adieresissmall","Aringsmall","AEsmall","Ccedillasmall","Egravesmall","Eacutesmall","Ecircumflexsmall","Edieresissmall","Igravesmall","Iacutesmall","Icircumflexsmall","Idieresissmall","Ethsmall","Ntildesmall","Ogravesmall","Oacutesmall","Ocircumflexsmall","Otildesmall","Odieresissmall","OEsmall","Oslashsmall","Ugravesmall","Uacutesmall","Ucircumflexsmall","Udieresissmall","Yacutesmall","Thornsmall","Ydieresissmall","001.000","001.001","001.002","001.003","Black","Bold","Book","Light","Medium","Regular","Roman","Semibold"],b=["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","space","exclam","quotedbl","numbersign","dollar","percent","ampersand","quoteright","parenleft","parenright","asterisk","plus","comma","hyphen","period","slash","zero","one","two","three","four","five","six","seven","eight","nine","colon","semicolon","less","equal","greater","question","at","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","bracketleft","backslash","bracketright","asciicircum","underscore","quoteleft","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","braceleft","bar","braceright","asciitilde","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","exclamdown","cent","sterling","fraction","yen","florin","section","currency","quotesingle","quotedblleft","guillemotleft","guilsinglleft","guilsinglright","fi","fl","","endash","dagger","daggerdbl","periodcentered","","paragraph","bullet","quotesinglbase","quotedblbase","quotedblright","guillemotright","ellipsis","perthousand","","questiondown","","grave","acute","circumflex","tilde","macron","breve","dotaccent","dieresis","","ring","cedilla","","hungarumlaut","ogonek","caron","emdash","","","","","","","","","","","","","","","","","AE","","ordfeminine","","","","","Lslash","Oslash","OE","ordmasculine","","","","","","ae","","","","dotlessi","","","lslash","oslash","oe","germandbls"],c=["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","space","exclamsmall","Hungarumlautsmall","","dollaroldstyle","dollarsuperior","ampersandsmall","Acutesmall","parenleftsuperior","parenrightsuperior","twodotenleader","onedotenleader","comma","hyphen","period","fraction","zerooldstyle","oneoldstyle","twooldstyle","threeoldstyle","fouroldstyle","fiveoldstyle","sixoldstyle","sevenoldstyle","eightoldstyle","nineoldstyle","colon","semicolon","commasuperior","threequartersemdash","periodsuperior","questionsmall","","asuperior","bsuperior","centsuperior","dsuperior","esuperior","","","isuperior","","","lsuperior","msuperior","nsuperior","osuperior","","","rsuperior","ssuperior","tsuperior","","ff","fi","fl","ffi","ffl","parenleftinferior","","parenrightinferior","Circumflexsmall","hyphensuperior","Gravesmall","Asmall","Bsmall","Csmall","Dsmall","Esmall","Fsmall","Gsmall","Hsmall","Ismall","Jsmall","Ksmall","Lsmall","Msmall","Nsmall","Osmall","Psmall","Qsmall","Rsmall","Ssmall","Tsmall","Usmall","Vsmall","Wsmall","Xsmall","Ysmall","Zsmall","colonmonetary","onefitted","rupiah","Tildesmall","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","exclamdownsmall","centoldstyle","Lslashsmall","","","Scaronsmall","Zcaronsmall","Dieresissmall","Brevesmall","Caronsmall","","Dotaccentsmall","","","Macronsmall","","","figuredash","hypheninferior","","","Ogoneksmall","Ringsmall","Cedillasmall","","","","onequarter","onehalf","threequarters","questiondownsmall","oneeighth","threeeighths","fiveeighths","seveneighths","onethird","twothirds","","","zerosuperior","onesuperior","twosuperior","threesuperior","foursuperior","fivesuperior","sixsuperior","sevensuperior","eightsuperior","ninesuperior","zeroinferior","oneinferior","twoinferior","threeinferior","fourinferior","fiveinferior","sixinferior","seveninferior","eightinferior","nineinferior","centinferior","dollarinferior","periodinferior","commainferior","Agravesmall","Aacutesmall","Acircumflexsmall","Atildesmall","Adieresissmall","Aringsmall","AEsmall","Ccedillasmall","Egravesmall","Eacutesmall","Ecircumflexsmall","Edieresissmall","Igravesmall","Iacutesmall","Icircumflexsmall","Idieresissmall","Ethsmall","Ntildesmall","Ogravesmall","Oacutesmall","Ocircumflexsmall","Otildesmall","Odieresissmall","OEsmall","Oslashsmall","Ugravesmall","Uacutesmall","Ucircumflexsmall","Udieresissmall","Yacutesmall","Thornsmall","Ydieresissmall"],d=[".notdef",".null","nonmarkingreturn","space","exclam","quotedbl","numbersign","dollar","percent","ampersand","quotesingle","parenleft","parenright","asterisk","plus","comma","hyphen","period","slash","zero","one","two","three","four","five","six","seven","eight","nine","colon","semicolon","less","equal","greater","question","at","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","bracketleft","backslash","bracketright","asciicircum","underscore","grave","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","braceleft","bar","braceright","asciitilde","Adieresis","Aring","Ccedilla","Eacute","Ntilde","Odieresis","Udieresis","aacute","agrave","acircumflex","adieresis","atilde","aring","ccedilla","eacute","egrave","ecircumflex","edieresis","iacute","igrave","icircumflex","idieresis","ntilde","oacute","ograve","ocircumflex","odieresis","otilde","uacute","ugrave","ucircumflex","udieresis","dagger","degree","cent","sterling","section","bullet","paragraph","germandbls","registered","copyright","trademark","acute","dieresis","notequal","AE","Oslash","infinity","plusminus","lessequal","greaterequal","yen","mu","partialdiff","summation","product","pi","integral","ordfeminine","ordmasculine","Omega","ae","oslash","questiondown","exclamdown","logicalnot","radical","florin","approxequal","Delta","guillemotleft","guillemotright","ellipsis","nonbreakingspace","Agrave","Atilde","Otilde","OE","oe","endash","emdash","quotedblleft","quotedblright","quoteleft","quoteright","divide","lozenge","ydieresis","Ydieresis","fraction","currency","guilsinglleft","guilsinglright","fi","fl","daggerdbl","periodcentered","quotesinglbase","quotedblbase","perthousand","Acircumflex","Ecircumflex","Aacute","Edieresis","Egrave","Iacute","Icircumflex","Idieresis","Igrave","Oacute","Ocircumflex","apple","Ograve","Uacute","Ucircumflex","Ugrave","dotlessi","circumflex","tilde","macron","breve","dotaccent","ring","cedilla","hungarumlaut","ogonek","caron","Lslash","lslash","Scaron","scaron","Zcaron","zcaron","brokenbar","Eth","eth","Yacute","yacute","Thorn","thorn","minus","multiply","onesuperior","twosuperior","threesuperior","onehalf","onequarter","threequarters","franc","Gbreve","gbreve","Idotaccent","Scedilla","scedilla","Cacute","cacute","Ccaron","ccaron","dcroat"],e=function(a){
this.font=a};e.prototype.charToGlyphIndex=function(a){var b=a.charCodeAt(0),c=this.font.glyphs;if(!c)return null;for(var d=0;d<c.length;d++)for(var e=c.get(d),f=0;f<e.unicodes.length;f++)if(e.unicodes[f]===b)return d};var f=function(a){this.cmap=a};f.prototype.charToGlyphIndex=function(a){return this.cmap.glyphIndexMap[a.charCodeAt(0)]||0};var g=function(a,b){this.encoding=a,this.charset=b};g.prototype.charToGlyphIndex=function(a){var b=a.charCodeAt(0),c=this.encoding[b];return this.charset.indexOf(c)};var h=function(a){var b;switch(a.version){case 1:this.names=d.slice();break;case 2:for(this.names=new Array(a.numberOfGlyphs),b=0;b<a.numberOfGlyphs;b++)this.names[b]=a.glyphNameIndex[b]<d.length?d[a.glyphNameIndex[b]]:a.names[a.glyphNameIndex[b]-d.length];break;case 2.5:for(this.names=new Array(a.numberOfGlyphs),b=0;b<a.numberOfGlyphs;b++)this.names[b]=d[b+a.glyphNameIndex[b]];break;case 3:this.names=[]}};h.prototype.nameToGlyphIndex=function(a){return this.names.indexOf(a)},h.prototype.glyphIndexToName=function(a){return this.names[a]};var i=function(a){for(var b,c=a.tables.cmap.glyphIndexMap,d=Object.keys(c),e=0;e<d.length;e++){var f=d[e],g=c[f];b=a.glyphs.get(g),b.addUnicode(parseInt(f))}for(e=0;e<a.glyphs.length;e++)b=a.glyphs.get(e),b.name=a.cffEncoding?a.cffEncoding.charset[e]:a.glyphNames.glyphIndexToName(e)};return{CFF_STANDARD_STRINGS:a,CFF_STANDARD_ENCODING:b,CFF_EXPERT_ENCODING:c,STANDARD_NAMES:d,DefaultEncoding:e,CMapEncoding:f,CFFEncoding:g,GlyphNames:h,addGlyphNames:i}}]),angular.module("services").factory("Font",["Encoding","GlyphSet","Path","FontTable","Uncompress",function(a,b,c,d,e){"use strict";var f=String.fromCharCode(0,1,0,0),g=function(a,b){a||console.warn(b)},h=function(a,b){return String.fromCharCode(a.getInt8(b))+String.fromCharCode(a.getInt8(b+1))+String.fromCharCode(a.getInt8(b+2))+String.fromCharCode(a.getInt8(b+3))},i=function(a,b){for(var c=Object.create(null),d=0,e=12;d<b;d++,e+=16){var f=h(a,e);c[f]={tag:f,offset:a.getUint32(e+8,!1),compression:!1}}return c},j=function(a,b){for(var c=Object.create(null),d=0,e=44;d<b;d++,e+=20){var f=h(a,e),g=a.getUint32(e+8,!1),i=a.getUint32(e+12,!1);c[f]={tag:f,offset:a.getUint32(e+4,!1),compression:g<i&&"WOFF",compressedLength:g,originalLength:i}}return c},k=function(a,b){var c,d=h(a,0);if(d===f)return b.outlinesFormat="truetype",c=a.getUint16(4,!1),i(a,c);if("OTTO"===d)return b.outlinesFormat="cff",c=a.getUint16(4,!1),i(a,c);if("wOFF"===d){var e=a.getUint16(4,!1);return b.outlinesFormat=e===f&&"truetype"||"OTTO"===e&&"cff",b.outlinesFormat||console.warn("Unsupported OpenType flavor",d),c=a.getUint16(12,!1),j(a,c)}console.warn("Unsupported OpenType signature",d)},l=function(a,b){if(!b)return console.warn("uncompressTable: undefined table",a),{};if("WOFF"!==b.compression)return{data:a,offset:b.offset};var c=new Uint8Array(a.buffer,b.offset+2,b.compressedLength-2),d=new Uint8Array(b.originalLength);if(e.inflate(c,d),d.byteLength!==b.originalLength)throw new Error("Decompression error: "+b.tag+" decompressed length doesn't match recorded length");return{data:new DataView(d.buffer,0),offset:0}},m=function(c){if(c){g(c.familyName,"When creating a new Font object, familyName is required"),g(c.styleName,"When creating a new Font object, styleName is required"),g(c.unitsPerEm,"When creating a new Font object, unitsPerEm is required"),g(c.ascender,"When creating a new Font object, ascender is required"),g(c.descender,"When creating a new Font object, descender is required"),g(c.descender<0,"Descender should be negative (e.g. -512)");var d=function(a,b){var c=Object.create(null);return c.en=a||b||" ",c},e=Object.create(null);e.fontFamily=d(c.familyName),e.fontSubfamily=d(c.styleName),e.fullName=d(c.fullName,c.familyName+" "+c.styleName),e.postScriptName=d(c.postScriptName,c.familyName+c.styleName),e.designer=d(c.designer),e.designerURL=d(c.designerURL),e.manufacturer=d(c.manufacturer),e.manufacturerURL=d(c.manufacturerURL),e.license=d(c.license),e.licenseURL=d(c.licenseURL),e.version=d(c.version,"Version 0.1"),e.description=d(c.description),e.copyright=d(c.copyright),e.trademark=d(c.trademark),this.names=e,this.unitsPerEm=c.unitsPerEm||1e3,this.ascender=c.ascender,this.descender=c.descender}this.supported=!0,this.glyphs=new b(this,c&&c.glyphs||[]),this.encoding=new a.DefaultEncoding(this),this.tables=Object.create(null)};return m.prototype.hasChar=function(a){return null!==this.encoding.charToGlyphIndex(a)},m.prototype.charToGlyphIndex=function(a){return this.encoding.charToGlyphIndex(a)},m.prototype.charToGlyph=function(a){var b=this.charToGlyphIndex(a),c=this.glyphs.get(b);return c||this.glyphs.get(0)},m.prototype.stringToGlyphs=function(a){return Array.prototype.map.call(a,this.charToGlyph,this)},m.prototype.nameToGlyphIndex=function(a){return this.glyphNames.nameToGlyphIndex(a)},m.prototype.nameToGlyph=function(a){var b=this.nametoGlyphIndex(a),c=this.glyphs.get(b);return c||this.glyphs.get(0)},m.prototype.glyphIndexToName=function(a){var b=this.glyphNames.glyphIndexToName;return b?b(a):""},m.prototype.getKerningValue=function(a,b){return a=a.index||a,b=b.index||b,this.getGposKerningValue?this.getGposKerningValue(a,b):this.kerningPairs[a+","+b]||0},m.prototype.forEachGlyph=function(a,b,c,d,e,f){b=b||0,c=c||0,d=d||72,e=e||Object.create(null);for(var g=(!("kerning"in e)||e.kerning),h=1/this.unitsPerEm*d,i=this.stringToGlyphs(a),j=0;j<i.length;j++){var k=i[j];f(k,b,c,d,e),(k.advanceWidth||k.xMax)&&(b+=h*(k.advanceWidth||k.xMax)),g&&j<i.length-1&&(b+=h*this.getKerningValue(k,i[j+1]))}},m.prototype.getPath=function(a,b,d,e,f){var g=new c;return this.forEachGlyph(a,b,d,e,f,function(a,b,c,d){var e=a.getPath(b,c,d);g.extend(e)}),g},m.prototype.getPaths=function(a,b,c,d,e){var f=[];return this.forEachGlyph(a,b,c,d,e,function(a,b,c,d){var e=a.getPath(b,c,d);f.push(e)}),f},m.prototype.draw=function(a,b,c,d,e,f){this.getPath(b,c,d,e,f).draw(a)},m.prototype.drawPoints=function(a,b,c,d,e,f){this.forEachGlyph(b,c,d,e,f,function(b,c,d,e){b.drawPoints(a,c,d,e)})},m.prototype.drawMetrics=function(a,b,c,d,e,f){this.forEachGlyph(b,c,d,e,f,function(b,c,d,e){b.drawMetrics(a,c,d,e)})},m.prototype.getEnglishName=function(a){var b=this.names[a];return b&&b.en},m.prototype.validate=function(){var a=this,b=function(b){var c=a.getEnglishName(b);return c&&c.trim().length>0};g(b("fontFamily"),"Validate: No English fontFamily specified"),g(b("weightName"),"Validate: No English weightName specified"),g(b("manufacturer"),"Validate: No English manufacturer specified"),g(b("copyright"),"Validate: No English copyright specified"),g(b("version"),"Validate: No English version specified"),g(this.unitsPerEm>0,"No unitsPerEm specified")},m.prototype.parseBuffer=function(b){var c,e,f,g=new DataView(b,0),h=k(g,this);h.cmap&&(e=l(g,h.cmap),this.tables.cmap=d.parseCMapTable(e.data,e.offset),this.encoding=new a.CMapEncoding(this.tables.cmap)),h.head&&(e=l(g,h.head),this.tables.head=d.parseHeadTable(e.data,e.offset),this.unitsPerEm=this.tables.head.unitsPerEm,c=this.tables.head.indexToLocFormat),h.hhea&&(e=l(g,h.hhea),this.tables.hhea=d.parseHHeaTable(e.data,e.offset),this.ascender=this.tables.hhea.ascender,this.descender=this.tables.hhea.descender,this.numberOfHMetrics=this.tables.hhea.numberOfHMetrics),h.ltag&&(e=l(g,h.ltag),f=d.parseLTagTable(e.data,e.offset)),h.maxp&&(e=l(g,h.maxp),this.tables.maxp=d.parseMaxPTable(e.data,e.offset),this.numGlyphs=this.tables.maxp.numGlyphs),h["OS/2"]&&(e=l(g,h["OS/2"]),this.tables.os2=d.parseOS2Table(e.data,e.offset)),h.post&&(e=l(g,h.post),this.tables.post=d.parsePostTable(e.data,e.offset),this.glyphNames=new a.GlyphNames(this.tables.post));var i=l(g,h.name);if(this.tables.name=d.parseNameTable(i.data,i.offset,f),this.names=this.tables.name,h.glyf&&h.loca){var j=0===c,m=l(g,h.loca),n=d.parseLocaTable(m.data,m.offset,this.numGlyphs,j),o=l(g,h.glyf);this.glyphs=d.parseGlyfTable(o.data,o.offset,n,this)}else if(h["CFF "]){var p=l(g,h["CFF "]);d.parseCFFTable(p.data,p.offset,this)}else console.warn("Font.parseBuffer: Font doesn't contain TrueType or CFF outlines.");if(h.htmx){var q=l(g,h.htmx);d.parseHmtxTable(q.data,q.offset,this.numberOfHMetrics,this.numGlyphs,this.glyphs)}a.addGlyphNames(this);var r=h.kern&&l(g,h.kern);if(this.kerningPairs=r?d.parseKernTable(r.data,r.offset):{},h.GPOS){var s=l(g,h.GPOS);d.parseGPOSTable(s.data,s.offset,this)}if(h.fvar){var t=l(g,h.fvar);this.tables.fvar=d.parseFVarTable(t.data,t.offset,this.names)}},m}]),angular.module("services").factory("FontParser",[function(){"use strict";var a={byte:1,uShort:2,short:2,uLong:4,fixed:4,longDateTime:8,tag:4},b=function(a,b){this.data=a,this.offset=b||0,this.relativeOffset=0};return b.prototype.getByte=function(a,b){return a.getUint8(b)},b.prototype.getCard8=b.prototype.getByte,b.prototype.getUShort=function(a,b){return a.getUint16(b,!1)},b.prototype.getCard16=b.prototype.getUShort,b.prototype.getShort=function(a,b){return a.getInt16(b,!1)},b.prototype.getULong=function(a,b){return a.getUint32(b,!1)},b.prototype.getFixed=function(a,b){var c=a.getInt16(b,!1),d=a.getUint16(b+2,!1);return c+d/65535},b.prototype.getTag=function(a,b){for(var c="",d=b;d<b+4;d++)c+=String.fromCharCode(a.getInt8(d));return c},b.prototype.getOffset=function(a,b,c){var d=0,e=b+c;if(e<a.byteLength)for(var f=b;f<e;f++)d<<=8,d+=a.getUint8(f);return d},b.prototype.getBytes=function(a,b,c){for(var d=[],e=b;e<c;e++)d.push(a.getUint8(e));return d},b.prototype.bytesToString=function(a){return String.fromCharCode.apply(null,a)},b.prototype.parseByte=function(){var a=this.data.getUint8(this.offset+this.relativeOffset);return this.relativeOffset+=1,a},b.prototype.parseChar=function(){var a=this.data.getInt8(this.offset+this.relativeOffset);return this.relativeOffset+=1,a},b.prototype.parseCard8=b.prototype.parseByte,b.prototype.parseUShort=function(){var a=this.data.getUint16(this.offset+this.relativeOffset);return this.relativeOffset+=2,a},b.prototype.parseCard16=b.prototype.parseUShort,b.prototype.parseSID=b.prototype.parseUShort,b.prototype.parseOffset16=b.prototype.parseUShort,b.prototype.parseShort=function(){var a=this.data.getInt16(this.offset+this.relativeOffset);return this.relativeOffset+=2,a},b.prototype.parseF2Dot14=function(){var a=this.data.getInt16(this.offset+this.relativeOffset)/16384;return this.relativeOffset+=2,a},b.prototype.parseULong=function(){var a=this.data.getUint32(this.offset+this.relativeOffset,!1);return this.relativeOffset+=4,a},b.prototype.parseOffset16List=b.prototype.parseUShortList=function(a){for(var b=new Array(a),c=this.data,d=this.offset+this.relativeOffset,e=0;e<a;e++)b[e]=c.getUint16(d,!1),d+=2;return this.relativeOffset+=2*a,b},b.prototype.parseString=function(a){var b=this.data,c=this.offset+this.relativeOffset,d="";this.relativeOffset+=a;for(var e=0;e<a;e++)d+=String.fromCharCode(b.getUint8(c+e));return d},b.prototype.parseTag=function(){return this.parseString(4)},b.prototype.parseLongDateTime=function(){var a=this.data.getUint32(this.offset+this.relativeOffset+4,!1);return this.relativeOffset+=8,a},b.prototype.parseFixed=function(){var a=this.offset+this.relativeOffset,b=this.data.getInt16(a,!1);return b+=this.data.getUint16(a+2,!1)/65536,this.relativeOffset+=4,b},b.prototype.parseVersion=function(){var a=this.data.getUint16(this.offset+this.relativeOffset,!1),b=this.data.getUint16(this.offset+this.relativeOffset+2,!1);return this.relativeOffset+=4,a+b/4096/10},b.prototype.skip=function(b,c){void 0===c&&(c=1),this.relativeOffset+=a[b]*c},b}]),angular.module("services").factory("FontStore",["$window","$q","BaseUtil","CONFIG","FontStyle","URLManager",function(a,b,c,d,e,f){"use strict";function g(a){return!!a}function h(a){return a.fontName||e.getFontInfo(a.fileName).family}function i(a){return a&&a.startsWith("font:meta:")}function j(a,b){return a===b||Number(a)===Number(b)||!a&&("normal"===b||400===Number(b))||!b&&("normal"===a||400===Number(a))}function k(a,b,c,d){for(var e=new RegExp("^([\"']?)"+a+"\\1$"),f=d.length-1;f>=0;f--){var g=d[f].type===window.CSSRule.FONT_FACE_RULE&&d[f].style;if(g&&e.test(g["font-family"])&&j(b,g["font-weight"])&&j(c,g["font-style"]))return!0}return!1}var l=d.globals.READER,m="assets/common/fonts/",n=function(c,d){var e=[],f=a.infoforage;return f?(d.filter(i).forEach(function(d){e.push(f.getItem(d).then(function(d){return d=JSON.parse(d),h(d)===c?a.localforage.getItem("font:file:"+d.fileName).then(function(a){return b.resolve({metaData:d,file:a})}):b.resolve()}))}),b.all(e).then(function(a){return a.filter(g)})):b.resolve()},o=function(b){function g(a,c){if(!b)return null;var d=b.getElementById(a),e=b.querySelector("head");return d||!e||c||(d=b.createElement("style"),d.type="text/css",d.id=a,e.appendChild(d)),d}var i={styleTag:null,styleSheetRules:null},j=function(a){var b=g(l.CUSTOMFONT_ID);if(b&&a&&0!==a.length){var c=h(a[0].metaData),i=b.sheet.cssRules;a.forEach(function(a){var g=a.metaData.subFamily,h=a.metaData.fileName,j=h.split(".").pop().toLowerCase(),l=d.globals.MIME_TYPES[j],m=e.getFontWeightNum(g,h),n=e.getFontStyle(g,h);if(!k(c,m,n,i)){var o=f.createURL("font:"+h,a.file,l),p="@font-face { font-family: '"+c+"'; src: url("+o+");font-style: "+n+";font-weight: "+m+"; }";b.sheet.insertRule(p,i.length)}})}};this.setContentDocument=function(a){b=a},this.getFontIdentifier=h,this.storePublicationFonts=function(){var a=g(l.PUBLICATION_FONTS_ID,!0);if(a&&a.sheet){var b=a.sheet.cssRules||[];i.styleTag=a.cloneNode(!0),i.styleSheetRules=Array.prototype.slice.call(b),a.parentNode.removeChild(a)}},this.restorePublicationFonts=function(){var a=i.styleTag;a&&i.styleSheetRules&&(b.querySelector("head").appendChild(a),Array.prototype.forEach.call(i.styleSheetRules,function(b,c){a.sheet.insertRule(b.cssText,c)}),i.styleTag=null,i.styleSheetRules=null)},this.addCustomFont=function(b){var e=d.globals.FONT.CUSTOM[b];if(e){var f=g(l.CUSTOMFONT_ID).sheet,h=c.getLocationURL(m);e.variants.forEach(function(a){var b='@font-face {font-family: "'+e.id+'";src: url("'+h+a.src+'.eot");src: url("'+h+a.src+'.eot?#iefix") format("embedded-opentype"),url("'+h+a.src+'.woff") format("woff"),url("'+h+a.src+'.ttf") format("truetype"),url("'+h+a.src+'.otf") format("opentype");font-style: '+a.style+";font-weight: "+a.weight+";}";f.insertRule(b,f.cssRules.length)})}else a.infoforage&&a.infoforage.keys().then(n.bind(null,b)).then(j.bind(this))},this.removeAllCustomFonts=function(){var a=g(l.CUSTOMFONT_ID,!0);a&&a.parentNode.removeChild(a)}};return o.prototype.removeUserDefinedFont=function(b){var c=!a.infoforage;c&&c.keys().then(function(d){d.filter(i).forEach(function(d){c.getItem(d).then(function(e){e=JSON.parse(e),h(e)!==b&&b||(c.removeItem(d),a.localforage.removeItem("font:file:"+e.fileName))})})})},o}]),angular.module("services").service("FontTable",["Encoding","FontParser","Glyph","GlyphSet","Path",function(a,b,c,d,e){"use strict";var f="utf-16",g=["copyright","fontFamily","fontSubfamily","uniqueID","fullName","version","postScriptName","trademark","manufacturer","designer","description","manufacturerURL","designerURL","license","licenseURL","reserved","preferredFamily","preferredSubfamily","compatibleFullName","sampleText","postScriptFindFontName","wwsFamily","wwsSubfamily"],h={0:"en",1:"fr",2:"de",3:"it",4:"nl",5:"sv",6:"es",7:"da",8:"pt",9:"no",10:"he",11:"ja",12:"ar",13:"fi",14:"el",15:"is",16:"mt",17:"tr",18:"hr",19:"zh-Hant",20:"ur",21:"hi",22:"th",23:"ko",24:"lt",25:"pl",26:"hu",27:"es",28:"lv",29:"se",30:"fo",31:"fa",32:"ru",33:"zh",34:"nl-BE",35:"ga",36:"sq",37:"ro",38:"cz",39:"sk",40:"si",41:"yi",42:"sr",43:"mk",44:"bg",45:"uk",46:"be",47:"uz",48:"kk",49:"az-Cyrl",50:"az-Arab",51:"hy",52:"ka",53:"mo",54:"ky",55:"tg",56:"tk",57:"mn-CN",58:"mn",59:"ps",60:"ks",61:"ku",62:"sd",63:"bo",64:"ne",65:"sa",66:"mr",67:"bn",68:"as",69:"gu",70:"pa",71:"or",72:"ml",73:"kn",74:"ta",75:"te",76:"si",77:"my",78:"km",79:"lo",80:"vi",81:"id",82:"tl",83:"ms",84:"ms-Arab",85:"am",86:"ti",87:"om",88:"so",89:"sw",90:"rw",91:"rn",92:"ny",93:"mg",94:"eo",128:"cy",129:"eu",130:"ca",131:"la",132:"qu",133:"gn",134:"ay",135:"tt",136:"ug",137:"dz",138:"jv",139:"su",140:"gl",141:"af",142:"br",143:"iu",144:"gd",145:"gv",146:"ga",147:"to",148:"el-polyton",149:"kl",150:"az",151:"nn"},i={1078:"af",1052:"sq",1156:"gsw",1118:"am",5121:"ar-DZ",15361:"ar-BH",3073:"ar",2049:"ar-IQ",11265:"ar-JO",13313:"ar-KW",12289:"ar-LB",4097:"ar-LY",6145:"ary",8193:"ar-OM",16385:"ar-QA",1025:"ar-SA",10241:"ar-SY",7169:"aeb",14337:"ar-AE",9217:"ar-YE",1067:"hy",1101:"as",2092:"az-Cyrl",1068:"az",1133:"ba",1069:"eu",1059:"be",2117:"bn",1093:"bn-IN",8218:"bs-Cyrl",5146:"bs",1150:"br",1026:"bg",1027:"ca",3076:"zh-HK",5124:"zh-MO",2052:"zh",4100:"zh-SG",1028:"zh-TW",1155:"co",1050:"hr",4122:"hr-BA",1029:"cs",1030:"da",1164:"prs",1125:"dv",2067:"nl-BE",1043:"nl",3081:"en-AU",10249:"en-BZ",4105:"en-CA",9225:"en-029",16393:"en-IN",6153:"en-IE",8201:"en-JM",17417:"en-MY",5129:"en-NZ",13321:"en-PH",18441:"en-SG",7177:"en-ZA",11273:"en-TT",2057:"en-GB",1033:"en",12297:"en-ZW",1061:"et",1080:"fo",1124:"fil",1035:"fi",2060:"fr-BE",3084:"fr-CA",1036:"fr",5132:"fr-LU",6156:"fr-MC",4108:"fr-CH",1122:"fy",1110:"gl",1079:"ka",3079:"de-AT",1031:"de",5127:"de-LI",4103:"de-LU",2055:"de-CH",1032:"el",1135:"kl",1095:"gu",1128:"ha",1037:"he",1081:"hi",1038:"hu",1039:"is",1136:"ig",1057:"id",1117:"iu",2141:"iu-Latn",2108:"ga",1076:"xh",1077:"zu",1040:"it",2064:"it-CH",1041:"ja",1099:"kn",1087:"kk",1107:"km",1158:"quc",1159:"rw",1089:"sw",1111:"kok",1042:"ko",1088:"ky",1108:"lo",1062:"lv",1063:"lt",2094:"dsb",1134:"lb",1071:"mk",2110:"ms-BN",1086:"ms",1100:"ml",1082:"mt",1153:"mi",1146:"arn",1102:"mr",1148:"moh",1104:"mn",2128:"mn-CN",1121:"ne",1044:"nb",2068:"nn",1154:"oc",1096:"or",1123:"ps",1045:"pl",1046:"pt",2070:"pt-PT",1094:"pa",1131:"qu-BO",2155:"qu-EC",3179:"qu",1048:"ro",1047:"rm",1049:"ru",9275:"smn",4155:"smj-NO",5179:"smj",3131:"se-FI",1083:"se",2107:"se-SE",8251:"sms",6203:"sma-NO",7227:"sms",1103:"sa",7194:"sr-Cyrl-BA",3098:"sr",6170:"sr-Latn-BA",2074:"sr-Latn",1132:"nso",1074:"tn",1115:"si",1051:"sk",1060:"sl",11274:"es-AR",16394:"es-BO",13322:"es-CL",9226:"es-CO",5130:"es-CR",7178:"es-DO",12298:"es-EC",17418:"es-SV",4106:"es-GT",18442:"es-HN",2058:"es-MX",19466:"es-NI",6154:"es-PA",15370:"es-PY",10250:"es-PE",20490:"es-PR",3082:"es",1034:"es",21514:"es-US",14346:"es-UY",8202:"es-VE",2077:"sv-FI",1053:"sv",1114:"syr",1064:"tg",2143:"tzm",1097:"ta",1092:"tt",1098:"te",1054:"th",1105:"bo",1055:"tr",1090:"tk",1152:"ug",1058:"uk",1070:"hsb",1056:"ur",2115:"uz-Cyrl",1091:"uz",1066:"vi",1106:"cy",1160:"wo",1157:"sah",1144:"ii",1130:"yo"},j={0:"macintosh",1:"x-mac-japanese",2:"x-mac-chinesetrad",3:"x-mac-korean",6:"x-mac-greek",7:"x-mac-cyrillic",9:"x-mac-devanagai",10:"x-mac-gurmukhi",11:"x-mac-gujarati",12:"x-mac-oriya",13:"x-mac-bengali",14:"x-mac-tamil",15:"x-mac-telugu",16:"x-mac-kannada",17:"x-mac-malayalam",18:"x-mac-sinhalese",19:"x-mac-burmese",20:"x-mac-khmer",21:"x-mac-thai",22:"x-mac-lao",23:"x-mac-georgian",24:"x-mac-armenian",25:"x-mac-chinesesimp",26:"x-mac-tibetan",27:"x-mac-mongolian",28:"x-mac-ethiopic",29:"x-mac-ce",30:"x-mac-vietnamese",31:"x-mac-extarabic"},k={15:"x-mac-icelandic",17:"x-mac-turkish",18:"x-mac-croatian",24:"x-mac-ce",25:"x-mac-ce",26:"x-mac-ce",27:"x-mac-ce",28:"x-mac-ce",30:"x-mac-icelandic",37:"x-mac-romanian",38:"x-mac-ce",39:"x-mac-ce",40:"x-mac-ce",143:"x-mac-inuit",146:"x-mac-gaelic"},l={"x-mac-croatian":"ÄÅÇÉÑÖÜáàâäãåçéèêëíìîïñóòôöõúùûü†°¢£§•¶ß®Š™´¨≠ŽØ∞±≤≥∆µ∂∑∏š∫ªºΩžø¿¡¬√ƒ≈Ć«Č… ÀÃÕŒœĐ—“”‘’÷◊©⁄€‹›Æ»–·‚„‰ÂćÁčÈÍÎÏÌÓÔđÒÚÛÙıˆ˜¯πË˚¸Êæˇ","x-mac-cyrillic":"АБВГДЕЖЗИЙКЛМНОПРСТУФХЦЧШЩЪЫЬЭЮЯ†°Ґ£§•¶І®©™Ђђ≠Ѓѓ∞±≤≥іµґЈЄєЇїЉљЊњјЅ¬√ƒ≈∆«»… ЋћЌќѕ–—“”‘’÷„ЎўЏџ№Ёёяабвгдежзийклмнопрстуфхцчшщъыьэю","x-mac-gaelic":"ÄÅÇÉÑÖÜáàâäãåçéèêëíìîïñóòôöõúùûü†°¢£§•¶ß®©™´¨≠ÆØḂ±≤≥ḃĊċḊḋḞḟĠġṀæøṁṖṗɼƒſṠ«»… ÀÃÕŒœ–—“”‘’ṡẛÿŸṪ€‹›Ŷŷṫ·Ỳỳ⁊ÂÊÁËÈÍÎÏÌÓÔ♣ÒÚÛÙıÝýŴŵẄẅẀẁẂẃ","x-mac-greek":"Ä¹²É³ÖÜ΅àâä΄¨çéèêë£™îï•½‰ôö¦€ùûü†ΓΔΘΛΞΠß®©ΣΪ§≠°·Α±≤≥¥ΒΕΖΗΙΚΜΦΫΨΩάΝ¬ΟΡ≈Τ«»… ΥΧΆΈœ–―“”‘’÷ΉΊΌΎέήίόΏύαβψδεφγηιξκλμνοπώρστθωςχυζϊϋΐΰ­","x-mac-icelandic":"ÄÅÇÉÑÖÜáàâäãåçéèêëíìîïñóòôöõúùûüÝ°¢£§•¶ß®©™´¨≠ÆØ∞±≤≥¥µ∂∑∏π∫ªºΩæø¿¡¬√ƒ≈∆«»… ÀÃÕŒœ–—“”‘’÷◊ÿŸ⁄€ÐðÞþý·‚„‰ÂÊÁËÈÍÎÏÌÓÔÒÚÛÙıˆ˜¯˘˙˚¸˝˛ˇ","x-mac-inuit":"ᐃᐄᐅᐆᐊᐋᐱᐲᐳᐴᐸᐹᑉᑎᑏᑐᑑᑕᑖᑦᑭᑮᑯᑰᑲᑳᒃᒋᒌᒍᒎᒐᒑ°ᒡᒥᒦ•¶ᒧ®©™ᒨᒪᒫᒻᓂᓃᓄᓅᓇᓈᓐᓯᓰᓱᓲᓴᓵᔅᓕᓖᓗᓘᓚᓛᓪᔨᔩᔪᔫᔭ… ᔮᔾᕕᕖᕗ–—“”‘’ᕘᕙᕚᕝᕆᕇᕈᕉᕋᕌᕐᕿᖀᖁᖂᖃᖄᖅᖏᖐᖑᖒᖓᖔᖕᙱᙲᙳᙴᙵᙶᖖᖠᖡᖢᖣᖤᖥᖦᕼŁł","x-mac-ce":"ÄĀāÉĄÖÜáąČäčĆćéŹźĎíďĒēĖóėôöõúĚěü†°Ę£§•¶ß®©™ę¨≠ģĮįĪ≤≥īĶ∂∑łĻļĽľĹĺŅņŃ¬√ńŇ∆«»… ňŐÕőŌ–—“”‘’÷◊ōŔŕŘ‹›řŖŗŠ‚„šŚśÁŤťÍŽžŪÓÔūŮÚůŰűŲųÝýķŻŁżĢˇ",macintosh:"ÄÅÇÉÑÖÜáàâäãåçéèêëíìîïñóòôöõúùûü†°¢£§•¶ß®©™´¨≠ÆØ∞±≤≥¥µ∂∑∏π∫ªºΩæø¿¡¬√ƒ≈∆«»… ÀÃÕŒœ–—“”‘’÷◊ÿŸ⁄€‹›ﬁﬂ‡·‚„‰ÂÊÁËÈÍÎÏÌÓÔÒÚÛÙıˆ˜¯˘˙˚¸˝˛ˇ","x-mac-romanian":"ÄÅÇÉÑÖÜáàâäãåçéèêëíìîïñóòôöõúùûü†°¢£§•¶ß®©™´¨≠ĂȘ∞±≤≥¥µ∂∑∏π∫ªºΩăș¿¡¬√ƒ≈∆«»… ÀÃÕŒœ–—“”‘’÷◊ÿŸ⁄€‹›Țț‡·‚„‰ÂÊÁËÈÍÎÏÌÓÔÒÚÛÙıˆ˜¯˘˙˚¸˝˛ˇ","x-mac-turkish":"ÄÅÇÉÑÖÜáàâäãåçéèêëíìîïñóòôöõúùûü†°¢£§•¶ß®©™´¨≠ÆØ∞±≤≥¥µ∂∑∏π∫ªºΩæø¿¡¬√ƒ≈∆«»… ÀÃÕŒœ–—“”‘’÷◊ÿŸĞğİıŞş‡·‚„‰ÂÊÁËÈÍÎÏÌÓÔÒÚÛÙˆ˜¯˘˙˚¸˝˛ˇ"},m=[{name:"version",op:0,type:"SID"},{name:"notice",op:1,type:"SID"},{name:"copyright",op:1200,type:"SID"},{name:"fullName",op:2,type:"SID"},{name:"familyName",op:3,type:"SID"},{name:"weight",op:4,type:"SID"},{name:"isFixedPitch",op:1201,type:"number",value:0},{name:"italicAngle",op:1202,type:"number",value:0},{name:"underlinePosition",op:1203,type:"number",value:-100},{name:"underlineThickness",op:1204,type:"number",value:50},{name:"paintType",op:1205,type:"number",value:0},{name:"charstringType",op:1206,type:"number",value:2},{name:"fontMatrix",op:1207,type:["real","real","real","real","real","real"],value:[.001,0,0,.001,0,0]},{name:"uniqueId",op:13,type:"number"},{name:"fontBBox",op:5,type:["number","number","number","number"],value:[0,0,0,0]},{name:"strokeWidth",op:1208,type:"number",value:0},{name:"xuid",op:14,type:[],value:null},{name:"charset",op:15,type:"offset",value:0},{name:"encoding",op:16,type:"offset",value:0},{name:"charStrings",op:17,type:"offset",value:0},{name:"private",op:18,type:["number","offset"],value:[0,0]}],n=[{name:"subrs",op:19,type:"offset",value:0},{name:"defaultWidthX",op:20,type:"number",value:0},{name:"nominalWidthX",op:21,type:"number",value:0}],o=function(a,b){a||console.warn(b)},p=new b,q=function(a,b){return new c({index:b,font:a})},r=function(a,b,d,e,f,g){return function(){var h=new c({index:b,font:a});return h.path=function(){d(h,e,f);var b=g(a.glyphs,h);return b.unitsPerEm=a.unitsPerEm,b},h}},s=function(a,b,d,e){return function(){var f=new c({index:b,font:a});return f.path=function(){var b=d(a,f,e);return b.unitsPerEm=a.unitsPerEm,b},f}},t=function(a,b,c){return 0===a&&65535===b&&"und"||0===a&&c&&c[b]||1===a&&h[b]||3===a&&i[b]||null},u=function(a,b,c){return 0===a&&f||1===a&&(k[c]||j[b])||3===a&&(1===b||10===b)&&f||null},v=function(a,b,c){for(var d=[],e=c/2,f=0;f<e;f++,b+=2)d[f]=a.getUint16(b);return String.fromCharCode.apply(null,d)},w=function(a,b,c,d){var e=l[d];if(!e)return null;for(var f="",g=0;g<c;g++){var h=a.getUint8(b+g);f+=h<=127?String.fromCharCode(h):e[127&h]}return f},x=function(a,b){var c=Object.create(null);return c.formatMajor=p.getByte(a,b),c.formatMinor=p.getByte(a,b+1),c.size=p.getByte(a,b+2),c.offsetSize=p.getByte(a,b+3),c.startOffset=b,c.endOffset=b+4,c},y=function(a,b,c){var d,e,f,g=[],h=[],i=p.getUShort(a,b);if(0!==i){var j=p.getByte(a,b+2);e=b+(i+1)*j+2;var k=b+3;for(d=0;d<=i;d++)g.push(p.getOffset(a,k,j)),k+=j;f=e+g[i]}else f=b+2;for(d=0;d<g.length-1;d+=1){var l=p.getBytes(a,e+g[d],e+g[d+1]);h.push(c?c(l):l)}return{objects:h,startOffset:b,endOffset:f}},z=function(a){return a<1240?107:a<33900?1131:32768},A=function(b,c){return c<=390?a.CFF_STANDARD_STRINGS[c]:b[c-391]},B=function(a,b,c){for(var d=Object.create(null),e=0;e<b.length;e++){var f=b[e],g=a[f.op];void 0===g&&(g=void 0!==f.value?f.value:null),d[f.name]="SID"===f.type?A(c,g):g}return d},C=function(a){for(var b="",c=15,d=["0","1","2","3","4","5","6","7","8","9",".","E","E-",null,"-"];;){var e=a.parseByte(),f=e>>4,g=15&e;if(f===c)break;if(b+=d[f],g===c)break;b+=d[g]}return parseFloat(b)},D=function(a,b){var c,d,e,f;return 28===b?(c=a.parseByte(),d=a.parseByte(),c<<8|d):29===b?(c=a.parseByte(),d=a.parseByte(),e=a.parseByte(),f=a.parseByte(),c<<24|d<<16|e<<8|f):30===b?C(a):b>=32&&b<=246?b-139:b>=247&&b<=250?(c=a.parseByte(),256*(b-247)+c+108):b>=251&&b<=254?(c=a.parseByte(),256*-(b-251)-c-108):void console.warn("parseCFFOperand: Invalid CFF operand b0 "+b)},E=function(a,c,d){var e=new b(a,c||0),f=[],g=Object.create(null);for(d=void 0!==d?d:a.length;e.relativeOffset<d;){var h=e.parseByte();h<=21?(12===h&&(h=1200+e.parseByte()),g[h]=1===f.length?f[0]:f,f=[]):f.push(D(e,h))}return g},F=function(a,b){var c=E(a,0,a.byteLength);return B(c,m,b)},G=function(a,b,c,d){var e=E(a,b,c);return B(e,n,d)},H=function(a,c,d,e){var f,g,h,i=new b(a,c);d-=1;var j=[".notdef"],k=i.parseByte();if(0===k)for(f=0;f<d;f++)g=i.parseUShort(),j.push(A(e,g));else if(1===k)for(;j.length<=d;)for(g=i.parseUShort(),h=i.parseByte(),f=0;f<=h;f++)j.push(A(e,g)),g++;else if(2===k)for(;j.length<=d;)for(g=i.parseUShort(),h=i.parseUShort(),f=0;f<=h;f++)j.push(A(e,g)),g++;else console.warn("parseCFFCharset: Unknown charset format "+k);return j},I=function(c,d,e){var f,g,h=Object.create(null),i=new b(c,d),j=i.parseByte();if(0===j){var k=i.parseByte();for(f=0;f<k;f++)g=i.parseByte(),h[g]=f}else if(1===j){var l=i.parseByte();for(g=1,f=0;f<l;f+=1)for(var m=i.parseByte(),n=i.parseByte(),o=m;o<=m+n;o++)h[o]=g,g++}else console.warn("parseCFFEncoding: Unknown encoding format "+j);return new a.CFFEncoding(h,e)},J=function(a,b,c){var d,f,g,h,i=new e,j=[],k=0,l=!1,m=a.defaultWidthX,n=!1,o=0,p=0,q=function(a,b){n&&i.closePath(),i.moveTo(a,b),n=!0},r=function(){var b;b=j.length%2!==0,b&&!l&&(m=j.shift()+a.nominalWidthX),k+=j.length>>1,j.length=0,l=!0},s=function(c){for(var e,t,u,v,w,x,y,z,A,B,C,D,E=0;E<c.length;){var F=c[E];switch(E+=1,F){case 1:r();break;case 3:r();break;case 4:j.length>1&&!l&&(m=j.shift()+a.nominalWidthX,l=!0),p+=j.pop(),q(o,p);break;case 5:for(;j.length>0;)o+=j.shift(),p+=j.shift(),i.lineTo(o,p);break;case 6:for(;j.length>0&&(o+=j.shift(),i.lineTo(o,p),0!==j.length);)p+=j.shift(),i.lineTo(o,p);break;case 7:for(;j.length>0&&(p+=j.shift(),i.lineTo(o,p),0!==j.length);)o+=j.shift(),i.lineTo(o,p);break;case 8:for(;j.length>0;)d=o+j.shift(),f=p+j.shift(),g=d+j.shift(),h=f+j.shift(),o=g+j.shift(),p=h+j.shift(),i.curveTo(d,f,g,h,o,p);break;case 10:C=j.pop()+a.subrsBias,D=a.subrs[C],D&&s(D);break;case 11:return;case 12:switch(F=c[E],E+=1,F){case 35:d=o+j.shift(),f=p+j.shift(),g=d+j.shift(),h=f+j.shift(),w=g+j.shift(),x=h+j.shift(),y=w+j.shift(),z=x+j.shift(),A=y+j.shift(),B=z+j.shift(),o=A+j.shift(),p=B+j.shift(),j.shift(),i.curveTo(d,f,g,h,w,x),i.curveTo(y,z,A,B,o,p);break;case 34:d=o+j.shift(),f=p,g=d+j.shift(),h=f+j.shift(),w=g+j.shift(),x=h,y=w+j.shift(),z=h,A=y+j.shift(),B=p,o=A+j.shift(),i.curveTo(d,f,g,h,w,x),i.curveTo(y,z,A,B,o,p);break;case 36:d=o+j.shift(),f=p+j.shift(),g=d+j.shift(),h=f+j.shift(),w=g+j.shift(),x=h,y=w+j.shift(),z=h,A=y+j.shift(),B=z+j.shift(),o=A+j.shift(),i.curveTo(d,f,g,h,w,x),i.curveTo(y,z,A,B,o,p);break;case 37:d=o+j.shift(),f=p+j.shift(),g=d+j.shift(),h=f+j.shift(),w=g+j.shift(),x=h+j.shift(),y=w+j.shift(),z=x+j.shift(),A=y+j.shift(),B=z+j.shift(),Math.abs(A-o)>Math.abs(B-p)?o=A+j.shift():p=B+j.shift(),i.curveTo(d,f,g,h,w,x),i.curveTo(y,z,A,B,o,p);break;default:console.log("Glyph "+b.index+": unknown operator 1200"+F),j.length=0}break;case 14:j.length>0&&!l&&(m=j.shift()+a.nominalWidthX,l=!0),n&&(i.closePath(),n=!1);break;case 18:r();break;case 19:case 20:r(),E+=k+7>>3;break;case 21:j.length>2&&!l&&(m=j.shift()+a.nominalWidthX,l=!0),p+=j.pop(),o+=j.pop(),q(o,p);break;case 22:j.length>1&&!l&&(m=j.shift()+a.nominalWidthX,l=!0),o+=j.pop(),q(o,p);break;case 23:r();break;case 24:for(;j.length>2;)d=o+j.shift(),f=p+j.shift(),g=d+j.shift(),h=f+j.shift(),o=g+j.shift(),p=h+j.shift(),i.curveTo(d,f,g,h,o,p);o+=j.shift(),p+=j.shift(),i.lineTo(o,p);break;case 25:for(;j.length>6;)o+=j.shift(),p+=j.shift(),i.lineTo(o,p);d=o+j.shift(),f=p+j.shift(),g=d+j.shift(),h=f+j.shift(),o=g+j.shift(),p=h+j.shift(),i.curveTo(d,f,g,h,o,p);break;case 26:for(j.length%2&&(o+=j.shift());j.length>0;)d=o,f=p+j.shift(),g=d+j.shift(),h=f+j.shift(),o=g,p=h+j.shift(),i.curveTo(d,f,g,h,o,p);break;case 27:for(j.length%2&&(p+=j.shift());j.length>0;)d=o+j.shift(),f=p,g=d+j.shift(),h=f+j.shift(),o=g+j.shift(),p=h,i.curveTo(d,f,g,h,o,p);break;case 28:e=c[E],t=c[E+1],j.push((e<<24|t<<16)>>16),E+=2;break;case 29:C=j.pop()+a.gsubrsBias,D=a.gsubrs[C],D&&s(D);break;case 30:for(;j.length>0&&(d=o,f=p+j.shift(),g=d+j.shift(),h=f+j.shift(),o=g+j.shift(),p=h+(1===j.length?j.shift():0),i.curveTo(d,f,g,h,o,p),0!==j.length);)d=o+j.shift(),f=p,g=d+j.shift(),h=f+j.shift(),p=h+j.shift(),o=g+(1===j.length?j.shift():0),i.curveTo(d,f,g,h,o,p);break;case 31:for(;j.length>0&&(d=o+j.shift(),f=p,g=d+j.shift(),h=f+j.shift(),p=h+j.shift(),o=g+(1===j.length?j.shift():0),i.curveTo(d,f,g,h,o,p),0!==j.length);)d=o,f=p+j.shift(),g=d+j.shift(),h=f+j.shift(),o=g+j.shift(),p=h+(1===j.length?j.shift():0),i.curveTo(d,f,g,h,o,p);break;default:F<32?console.warn("Glyph",b.index,": unknown operator",F):F<247?j.push(F-139):F<251?(e=c[E],E+=1,j.push(256*(F-247)+e+108)):F<255?(e=c[E],E+=1,j.push(256*-(F-251)-e-108)):(e=c[E],t=c[E+1],u=c[E+2],v=c[E+3],E+=4,j.push((e<<24|t<<16|u<<8|v)/65536))}}};return s(c),b.advanceWidth=m,i},K=function(a,b,c,d,e){var f;return(b&d)>0?(f=a.parseByte(),0===(b&e)&&(f=-f)):f=(b&e)>0?0:a.parseShort(),f+c},L=function(a,c,d){var e,f,g,h=new b(c,d);if(a.numberOfContours=h.parseShort(),a.xMin=h.parseShort(),a.yMin=h.parseShort(),a.xMax=h.parseShort(),a.yMax=h.parseShort(),a.numberOfContours>0){var i=a.endPointIndices=[];for(g=0;g<a.numberOfContours;g++)i.push(h.parseUShort());for(a.instructionLength=h.parseUShort(),a.instructions=[],g=0;g<a.instructionLength;g++)a.instructions.push(h.parseByte());var j=i[i.length-1]+1;for(e=[],g=0;g<j;g++)if(f=h.parseByte(),e.push(f),(8&f)>0)for(var k=h.parseByte(),l=0;l<k;l++)e.push(f),g+=1;if(o(e.length===j,"parseGlyph: bad flags"),i.length>0){var m,n=[];if(j>0){for(g=0;g<j;g++)f=e[g],m=Object.create(null),m.onCurve=!!(1&f),m.lastPointOfContour=i.indexOf(g)>=0,n.push(m);var p=0;for(g=0;g<j;g++)f=e[g],m=n[g],m.x=K(h,f,p,2,16),p=m.x;var q=0;for(g=0;g<j;g++)f=e[g],m=n[g],m.y=K(h,f,q,4,32),q=m.y}a.points=n}else a.points=[]}else if(0===a.numberOfContours)a.points=[];else{a.isComposite=!0,a.points=[],a.components=[];for(var r=!0;r;){e=h.parseUShort();var s=Object.create(null);s.glyphIndex=h.parseUShort(),s.xScale=1,s.scale01=0,s.scale10=0,s.yScale=1,s.dx=0,s.dy=0,(1&e)>0?(s.dx=h.parseShort(),s.dy=h.parseShort()):(s.dx=h.parseChar(),s.dy=h.parseChar()),(8&e)>0?s.xScale=s.yScale=h.parseF2Dot14():(64&e)>0?(s.xScale=h.parseF2Dot14(),s.yScale=h.parseF2Dot14()):(128&e)>0&&(s.xScale=h.parseF2Dot14(),s.scale01=h.parseF2Dot14(),s.scale10=h.parseF2Dot14(),s.yScale=h.parseF2Dot14()),a.components.push(s),r=!!(32&e)}}},M=function(a,b){return a.map(function(a){return{x:b.xScale*a.x+b.scale01*a.y+b.dx,y:b.scale10*a.x+b.yScale*a.y+b.dy,onCurve:a.onCurve,lastPointOfContour:a.lastPointOfContour}})},N=function(a){for(var b=[],c=[],d=0;d<a.length;d++){var e=a[d];c.push(e),e.lastPointOfContour&&(b.push(c),c=[])}return o(0===c.length,"getContours: There are still points left in the current contour"),b},O=function(a){var b=new e;if(!a)return b;for(var c=N(a),d=0;d<c.length;d++){var f,g,h=c[d],i=h[0],j=h[h.length-1];i.onCurve?(f=null,g=!0):(i=j.onCurve?j:{x:(i.x+j.x)/2,y:(i.y+j.y)/2},f=i,g=!1),b.moveTo(i.x,i.y);for(var k=g?1:0;k<h.length;k++){var l=h[k],m=0===k?i:h[k-1];if(m.onCurve&&l.onCurve)b.lineTo(l.x,l.y);else if(m.onCurve&&!l.onCurve)f=l;else if(m.onCurve||l.onCurve)!m.onCurve&&l.onCurve?(b.quadraticCurveTo(f.x,f.y,l.x,l.y),f=null):console.warn("getPath: invalid state");else{var n={x:(m.x+l.x)/2,y:(m.y+l.y)/2};b.quadraticCurveTo(m.x,m.y,n.x,n.y),f=l}}i!==j&&(f?b.quadraticCurveTo(f.x,f.y,i.x,i.y):b.lineTo(i.x,i.y))}return b.closePath(),b},P=function(a,b){if(b.isComposite)for(var c=0;c<b.components.length;c++){var d=b.components[c],e=a.get(d.glyphIndex);if(e.getPath(),e.points){var f=M(e.points,d);b.points=b.points.concat(f);
}}return O(b.points)},Q=function(a,c){for(var d=new b(a,c),e=d.parseUShort(),f=[],g=0;g<e;g++)f[d.parseString(4)]={offset:d.parseUShort()};return f},R=function(a,c){var d=new b(a,c),e=d.parseUShort(),f=d.parseUShort();if(1===e)return d.parseUShortList(f);if(2===e){for(var g=[];f--;)for(var h=d.parseUShort(),i=d.parseUShort(),j=d.parseUShort(),k=h;k<=i;k++)g[j++]=k;return g}},S=function(a,c){var d=new b(a,c),e=d.parseUShort();if(1===e){var f=d.parseUShort(),g=d.parseUShort(),h=d.parseUShortList(g);return function(a){return h[a-f]||0}}if(2===e){for(var i=d.parseUShort(),j=[],k=[],l=[],m=0;m<i;m++)j[m]=d.parseUShort(),k[m]=d.parseUShort(),l[m]=d.parseUShort();return function(a){for(var b=0,c=j.length-1;b<c;){var d=b+c+1>>1;a<j[d]?c=d-1:b=d}return j[b]<=a&&a<=k[b]?l[b]||0:0}}},T=function(a,c){var d=new b(a,c),e=d.parseUShort(),f=d.parseUShort(),g=R(a,c+f),h=d.parseUShort(),i=d.parseUShort();if(4===h&&0===i){var j,k=Object.create(null);if(1===e){for(var l=d.parseUShort(),m=[],n=d.parseUShortList(l),o=0;o<l;o++){var p=n[o],q=k[p];if(!q){q={},d.relativeOffset=p;for(var r=d.parseUShort();r--;){var s=d.parseUShort();h&&(j=d.parseShort()),i&&d.parseShort(),q[s]=j}}m[g[o]]=q}return function(a,b){var c=m[a];return c&&c[b]}}if(2===e){for(var t=d.parseUShort(),u=d.parseUShort(),v=d.parseUShort(),w=d.parseUShort(),x=S(a,c+t),y=S(a,c+u),z=[],A=0;A<v;A++)for(var B=z[A]=[],C=0;C<w;C++)h&&(j=d.parseShort()),i&&d.parseShort(),B[C]=j;var D={};for(A=0;A<g.length;A++)D[g[A]]=1;return function(a,b){if(D[a]){var c=x(a),d=y(b),e=z[c];return e&&e[d]}}}}},U=function(a,c){var d=new b(a,c),e=d.parseUShort(),f=d.parseUShort(),g=16&f,h=d.parseUShort(),i=d.parseUShortList(h),j={lookupType:e,lookupFlag:f,markFilteringSet:g?d.parseUShort():-1};if(2===e){for(var k=[],l=0;l<h;l++)k.push(T(a,c+i[l]));j.getKerningValue=function(a,b){for(var c=k.length;c--;){var d=k[c](a,b);if(void 0!==d)return d}return 0}}return j},V=function(a,c,d){var e=Object.create(null),f=new b(a,c);return e.tag=f.parseTag(),e.minValue=f.parseFixed(),e.defaultValue=f.parseFixed(),e.maxValue=f.parseFixed(),f.skip("uShort",1),e.name=d[f.parseUShort()]||{},e},W=function(a,c,d,e){var f=Object.create(null),g=new b(a,c);f.name=e[g.parseUShort()]||{},g.skip("uShort",1),f.coordinates={};for(var h=0;h<d.length;++h)f.coordinates[d[h].tag]=g.parseFixed();return f};this.parseLTagTable=function(a,c){var d=new b(a,c),e=d.parseULong();o(1===e,"parseLTagTable: Unsupported GPOS table version "+e),d.skip("uLong",1);for(var f=d.parseULong(),g=[],h=0;h<f;h++){for(var i="",j=c+d.parseUShort(),k=d.parseUShort(),l=j;l<j+k;++l)i+=String.fromCharCode(a.getInt8(l));g.push(i)}return g},this.parseNameTable=function(a,c,d){for(var e=new b(a,c),h=Object.create(null),i=e.parseUShort(),j=e.parseUShort(),k=e.offset+e.parseUShort(),l=0;l<j;l++){var m=e.parseUShort(),n=e.parseUShort(),o=e.parseUShort(),p=e.parseUShort(),q=g[p]||p,r=e.parseUShort(),s=e.parseUShort(),x=t(m,o,d),y=u(m,n,o);if(y&&x){var z=y===f?v(a,k+s,r):w(a,k+s,r,y);if(z){var A=h[q];A||(A=h[q]={}),A[x]=z}}}return 1===i&&e.parseUShort(),h},this.parseLocaTable=function(a,c,d,e){for(var f=new b(a,c),g=e?f.parseUShort:f.parseULong,h=[],i=0;i<=d;i++){var j=g.call(f);e&&(j*=2),h.push(j)}return h},this.parseGlyfTable=function(a,b,c,e){var f,g=new d(e);for(f=0;f<c.length-1;f++){var h=c[f],i=c[f+1];g.push(f,h!==i?r(e,f,L,a,b+h,P):q(e,f))}return g},this.parseCFFTable=function(b,c,e){e.tables.cff=Object.create(null);var f=x(b,c),g=y(b,f.endOffset,p.bytesToString),h=y(b,g.endOffset),i=y(b,h.endOffset,p.bytesToString),j=y(b,i.endOffset);e.gsubrs=j.objects,e.gsubrsBias=z(e.gsubrs.length);var k=new DataView(new Uint8Array(h.objects[0]).buffer),l=F(k,i.objects);e.tables.cff.topDict=l;var m=c+l.private[1],n=G(b,m,l.private[0],i.objects);if(e.defaultWidthX=n.defaultWidthX,e.nominalWidthX=n.nominalWidthX,0!==n.subrs){var o=m+n.subrs,q=y(b,o);e.subrs=q.objects,e.subrsBias=z(e.subrs.length)}else e.subrs=[],e.subrsBias=0;var r=y(b,c+l.charStrings);e.nGlyphs=r.objects.length;var t=H(b,c+l.charset,e.nGlyphs,i.objects);0===l.encoding?e.cffEncoding=new a.CFFEncoding(a.CFF_STANDARD_ENCODING,t):1===l.encoding?e.cffEncoding=new a.CFFEncoding(a.CFF_EXPERT_ENCODING,t):e.cffEncoding=I(b,c+l.encoding,t),e.encoding=e.encoding||e.cffEncoding,e.glyphs=new d(e);for(var u=0;u<e.nGlyphs;u++){var v=r.objects[u];e.glyphs.push(u,s(e,u,J,v))}},this.parseCMapTable=function(a,c){var d,e,f=Object.create(null);f.version=p.getUShort(a,c),o(0===f.version,"parseCMapTable: cmap table version should be 0 "+f.version),f.numTables=p.getUShort(a,c+2);var g=-1;for(d=0;d<f.numTables;d++){var h=p.getUShort(a,c+4+8*d),i=p.getUShort(a,c+4+8*d+2);if(3===h&&(1===i||0===i)){g=p.getULong(a,c+4+8*d+4);break}}if(g===-1)return null;var j=new b(a,c+g);f.format=j.parseUShort(),o(4===f.format,"parseCMapTable: Only format 4 cmap tables are supported "+f.format),f.length=j.parseUShort(),f.language=j.parseUShort(),f.segCount=e=j.parseUShort()>>1,j.skip("uShort",3),f.glyphIndexMap=Object.create(null);var k=new b(a,c+g+14),l=new b(a,c+g+16+2*e),m=new b(a,c+g+16+4*e),n=new b(a,c+g+16+6*e),q=c+g+16+8*e;for(d=0;d<e-1;d++)for(var r,s=k.parseUShort(),t=l.parseUShort(),u=m.parseShort(),v=n.parseUShort(),w=t;w<=s;w++)0!==v?(q=n.offset+n.relativeOffset-2,q+=v+2*(w-t),r=p.getUShort(a,q),0!==r&&(r=r+u&65535)):r=w+u&65535,f.glyphIndexMap[w]=r;return f},this.parseHeadTable=function(a,c){var d=new b(a,c),e=Object.create(null);return e.version=d.parseVersion(),e.fontRevision=Math.round(1e3*d.parseFixed())/1e3,e.checkSumAdjustment=d.parseULong(),e.magicNumber=d.parseULong(),o(1594834165===e.magicNumber,"parseHeadTable: Font header has wrong magic number "+e.magicNumber),e.flags=d.parseUShort(),e.unitsPerEm=d.parseUShort(),e.created=d.parseLongDateTime(),e.modified=d.parseLongDateTime(),e.xMin=d.parseShort(),e.yMin=d.parseShort(),e.xMax=d.parseShort(),e.yMax=d.parseShort(),e.macStyle=d.parseUShort(),e.lowestRecPPEM=d.parseUShort(),e.fontDirectionHint=d.parseShort(),e.indexToLocFormat=d.parseShort(),e.glyphDataFormat=d.parseShort(),e},this.parseHHeaTable=function(a,c){var d=new b(a,c),e=Object.create(null);return e.version=d.parseVersion(),e.ascender=d.parseShort(),e.descender=d.parseShort(),e.lineGap=d.parseShort(),e.advanceWidthMax=d.parseUShort(),e.minLeftSideBearing=d.parseShort(),e.minRightSideBearing=d.parseShort(),e.xMaxExtent=d.parseShort(),e.caretSlopeRise=d.parseShort(),e.caretSlopeRun=d.parseShort(),e.caretOffset=d.parseShort(),d.relativeOffset+=8,e.metricDataFormat=d.parseShort(),e.numberOfHMetrics=d.parseUShort(),e},this.parseMaxPTable=function(a,c){var d=new b(a,c),e=Object.create(null);return e.version=d.parseVersion(),e.numGlyphs=d.parseUShort(),1===e.version&&(e.maxPoints=d.parseUShort(),e.maxContours=d.parseUShort(),e.maxCompositePoints=d.parseUShort(),e.maxCompositeContours=d.parseUShort(),e.maxZones=d.parseUShort(),e.maxTwilightPoints=d.parseUShort(),e.maxStorage=d.parseUShort(),e.maxFunctionDefs=d.parseUShort(),e.maxInstructionDefs=d.parseUShort(),e.maxStackElements=d.parseUShort(),e.maxSizeOfInstructions=d.parseUShort(),e.maxComponentElements=d.parseUShort(),e.maxComponentDepth=d.parseUShort()),e},this.parseOS2Table=function(a,c){var d=new b(a,c),e=Object.create(null);e.version=d.parseUShort(),e.xAvgCharWidth=d.parseShort(),e.usWeightClass=d.parseUShort(),e.usWidthClass=d.parseUShort(),e.fsType=d.parseUShort(),e.ySubscriptXSize=d.parseShort(),e.ySubscriptYSize=d.parseShort(),e.ySubscriptXOffset=d.parseShort(),e.ySubscriptYOffset=d.parseShort(),e.ySuperscriptXSize=d.parseShort(),e.ySuperscriptYSize=d.parseShort(),e.ySuperscriptXOffset=d.parseShort(),e.ySuperscriptYOffset=d.parseShort(),e.yStrikeoutSize=d.parseShort(),e.yStrikeoutPosition=d.parseShort(),e.sFamilyClass=d.parseShort(),e.panose=[];for(var f=0;f<10;f++)e.panose[f]=d.parseByte();return e.ulUnicodeRange1=d.parseULong(),e.ulUnicodeRange2=d.parseULong(),e.ulUnicodeRange3=d.parseULong(),e.ulUnicodeRange4=d.parseULong(),e.achVendID=String.fromCharCode(d.parseByte(),d.parseByte(),d.parseByte(),d.parseByte()),e.fsSelection=d.parseUShort(),e.usFirstCharIndex=d.parseUShort(),e.usLastCharIndex=d.parseUShort(),e.sTypoAscender=d.parseShort(),e.sTypoDescender=d.parseShort(),e.sTypoLineGap=d.parseShort(),e.usWinAscent=d.parseUShort(),e.usWinDescent=d.parseUShort(),e.version>=1&&(e.ulCodePageRange1=d.parseULong(),e.ulCodePageRange2=d.parseULong()),e.version>=2&&(e.sxHeight=d.parseShort(),e.sCapHeight=d.parseShort(),e.usDefaultChar=d.parseUShort(),e.usBreakChar=d.parseUShort(),e.usMaxContent=d.parseUShort()),e},this.parsePostTable=function(c,d){var e,f=new b(c,d),g=Object.create(null);switch(g.version=f.parseVersion(),g.italicAngle=f.parseFixed(),g.underlinePosition=f.parseShort(),g.underlineThickness=f.parseShort(),g.isFixedPitch=f.parseULong(),g.minMemType42=f.parseULong(),g.maxMemType42=f.parseULong(),g.minMemType1=f.parseULong(),g.maxMemType1=f.parseULong(),g.version){case 1:g.names=a.STANDARD_NAMES.slice();break;case 2:for(g.numberOfGlyphs=f.parseUShort(),g.glyphNameIndex=new Array(g.numberOfGlyphs),e=0;e<g.numberOfGlyphs;e++)g.glyphNameIndex[e]=f.parseUShort();for(g.names=[],e=0;e<g.numberOfGlyphs;e++)if(g.glyphNameIndex[e]>=a.STANDARD_NAMES.length){var h=f.parseChar();g.names.push(f.parseString(h))}break;case 2.5:for(g.numberOfGlyphs=f.parseUShort(),g.offset=new Array(g.numberOfGlyphs),e=0;e<g.numberOfGlyphs;e++)g.offset[e]=f.parseChar()}return g},this.parseGPOSTable=function(a,c,d){var e=new b(a,c),f=e.parseFixed();o(1===f,"parseGPOSTable: Unsupported GPOS table version "+f),Q(a,c+e.parseUShort()),Q(a,c+e.parseUShort());var g=e.parseUShort();e.relativeOffset=g;for(var h=e.parseUShort(),i=e.parseUShortList(h),j=c+g,k=0;k<h;k++){var l=U(a,j+i[k]);2!==l.lookupType||d.getGposKerningValue||(d.getGposKerningValue=l.getKerningValue)}},this.parseFVarTable=function(a,c,d){var e=new b(a,c),f=e.parseULong(),g=e.parseOffset16();o(65536===f,"parseFVarTable: Unsupported FVAR table version "+f),e.skip("uShort",1);for(var h=e.parseUShort(),i=e.parseUShort(),j=e.parseUShort(),k=e.parseUShort(),l=[],m=0;m<h;m++)l.push(V(a,c+g+m*i,d));for(var n=[],p=c+g+h*i,q=0;q<j;q++)n.push(W(a,p+q*k,l,d));return{axes:l,instances:n}},this.parseHmtxTable=function(a,c,d,e,f){for(var g,h,i=new b(a,c),j=0;j<e;j++){j<d&&(g=i.parseUShort(),h=i.parseShort());var k=f.get(j);k.advanceWidth=g,k.leftSideBearing=h}},this.parseKernTable=function(a,c){var d=new b(a,c),e=Object.create(null),f=d.parseUShort();o(0===f,"parseKernTable: Unsupported kern table version "+f),d.skip("uShort",1);var g=d.parseUShort();o(0===g,"parseKernTable: Unsupported kern sub-table version "+g),d.skip("uShort",2);var h=d.parseUShort();d.skip("uShort",3);for(var i=0;i<h;i++){var j=d.parseUShort(),k=d.parseUShort();e[j+","+k]=d.parseShort()}return e}}]),angular.module("services").factory("Glyph",["Path",function(a){"use strict";var b=function(a,b,c,d,e){a.beginPath(),a.moveTo(b,c),a.lineTo(d,e),a.stroke()},c=function(a,b){var c=b||{commands:[]};return{configurable:!0,get:function(){return"function"==typeof c&&(c=c()),c},set:function(a){c=a}}},d=function(a){this.bindConstructorValues(a)};return d.prototype.bindConstructorValues=function(a){this.index=a.index||0,this.name=a.name||null,this.unicode=a.unicode,this.unicodes=a.unicodes||(void 0!==a.unicode?[a.unicode]:[]),a.xMin&&(this.xMin=a.xMin),a.yMin&&(this.yMin=a.yMin),a.xMax&&(this.xMax=a.xMax),a.yMax&&(this.yMax=a.yMax),a.advanceWidth&&(this.advanceWidth=a.advanceWidth),Object.defineProperty(this,"path",c(this,a.path))},d.prototype.addUnicode=function(a){0===this.unicodes.length&&(this.unicode=a),this.unicodes.push(a)},d.prototype.getPath=function(b,c,d){b=b||0,c=c||0;for(var e=1/this.path.unitsPerEm*(d||72),f=new a,g=this.path.commands,h=0;h<g.length;h++){var i=g[h];"M"===i.type?f.moveTo(b+i.x*e,c+-i.y*e):"L"===i.type?f.lineTo(b+i.x*e,c+-i.y*e):"Q"===i.type?f.quadraticCurveTo(b+i.x1*e,c+-i.y1*e,b+i.x*e,c+-i.y*e):"C"===i.type?f.curveTo(b+i.x1*e,c+-i.y1*e,b+i.x2*e,c+-i.y2*e,b+i.x*e,c+-i.y*e):"Z"===i.type&&f.closePath()}return f},d.prototype.getContours=function(){if(void 0===this.points)return[];for(var a=[],b=[],c=0;c<this.points.length;c++){var d=this.points[c];b.push(d),d.lastPointOfContour&&(a.push(b),b=[])}return 0!==b.length&&console.warn("Glyph.prototype.getContours: There are still points left in the current contour."),a},d.prototype.getMetrics=function(){for(var a=this.path.commands,b=[],c=[],d=0;d<a.length;d++){var e=a[d];"Z"!==e.type&&(b.push(e.x),c.push(e.y)),"Q"!==e.type&&"C"!==e.type||(b.push(e.x1),c.push(e.y1)),"C"===e.type&&(b.push(e.x2),c.push(e.y2))}var f={xMin:Math.min.apply(null,b),yMin:Math.min.apply(null,c),xMax:Math.max.apply(null,b),yMax:Math.max.apply(null,c),leftSideBearing:0};return isFinite(f.xMin)||(f.xMin=0),isFinite(f.xMax)||(f.xMax=this.advanceWidth),isFinite(f.yMin)||(f.yMin=0),isFinite(f.yMax)||(f.yMax=0),f.rightSideBearing=this.advanceWidth-f.leftSideBearing-(f.xMax-f.xMin),f},d.prototype.draw=function(a,b,c,d){this.getPath(b,c,d).draw(a)},d.prototype.drawPoints=function(a,b,c,d){function e(b,c,d,e){var f=2*Math.PI;a.beginPath();for(var g=0;g<b.length;g+=1)a.moveTo(c+b[g].x*e,d+b[g].y*e),a.arc(c+b[g].x*e,d+b[g].y*e,2,0,f,!1);a.closePath(),a.fill()}b=b||0,c=c||0;for(var f=1/this.path.unitsPerEm*(d||24),g=[],h=[],i=this.path,j=0;j<i.commands.length;j++){var k=i.commands[j];void 0!==k.x&&g.push({x:k.x,y:-k.y}),void 0!==k.x1&&h.push({x:k.x1,y:-k.y1}),void 0!==k.x2&&h.push({x:k.x2,y:-k.y2})}a.fillStyle="blue",e(g,b,c,f),a.fillStyle="red",e(h,b,c,f)},d.prototype.drawMetrics=function(a,c,d,e){c=c||0,d=d||0;var f=1/this.path.unitsPerEm*(e||24);a.lineWidth=1,a.strokeStyle="black",b(a,c,-1e4,c,1e4),b(a,-1e4,d,1e4,d);var g=this.xMin||0,h=this.yMin||0,i=this.xMax||0,j=this.yMax||0,k=this.advanceWidth||0;a.strokeStyle="blue",b(a,c+g*f,-1e4,c+g*f,1e4),b(a,c+i*f,-1e4,c+i*f,1e4),b(a,-1e4,d+-h*f,1e4,d+-h*f),b(a,-1e4,d+-j*f,1e4,d+-j*f),a.strokeStyle="green",b(a,c+k*f,-1e4,c+k*f,1e4)},d}]),angular.module("services").factory("GlyphSet",[function(){"use strict";var a=function(a,b){if(this.font=a,this.glyphs={},Array.isArray(b))for(var c=0;c<b.length;c++)this.glyphs[c]=b[c];this.length=b&&b.length||0};return a.prototype.get=function(a){return"function"==typeof this.glyphs[a]&&(this.glyphs[a]=this.glyphs[a]()),this.glyphs[a]},a.prototype.push=function(a,b){this.glyphs[a]=b,this.length++},a}]),angular.module("services").factory("Path",[function(){"use strict";var a=function(){this.commands=[],this.fill="black",this.stroke=null,this.strokeWidth=1};return a.prototype.moveTo=function(a,b){this.commands.push({type:"M",x:a,y:b})},a.prototype.lineTo=function(a,b){this.commands.push({type:"L",x:a,y:b})},a.prototype.curveTo=a.prototype.bezierCurveTo=function(a,b,c,d,e,f){this.commands.push({type:"C",x1:a,y1:b,x2:c,y2:d,x:e,y:f})},a.prototype.quadTo=a.prototype.quadraticCurveTo=function(a,b,c,d){this.commands.push({type:"Q",x1:a,y1:b,x:c,y:d})},a.prototype.close=a.prototype.closePath=function(){this.commands.push({type:"Z"})},a.prototype.extend=function(a){a.commands&&(a=a.commands),Array.prototype.push.apply(this.commands,a)},a.prototype.draw=function(a){a.beginPath();for(var b=0;b<this.commands.length;b++){var c=this.commands[b];"M"===c.type?a.moveTo(c.x,c.y):"L"===c.type?a.lineTo(c.x,c.y):"C"===c.type?a.bezierCurveTo(c.x1,c.y1,c.x2,c.y2,c.x,c.y):"Q"===c.type?a.quadraticCurveTo(c.x1,c.y1,c.x,c.y):"Z"===c.type&&a.closePath()}this.fill&&(a.fillStyle=this.fill,a.fill()),this.stroke&&(a.strokeStyle=this.stroke,a.lineWidth=this.strokeWidth,a.stroke())},a.prototype.toPathData=function(a){for(var b=this,c=Math.pow(10,a||2),d=function(a,c){c?(b.xMin=void 0===b.xMin?a:Math.min(b.xMin,a),b.xMax=void 0===b.xMax?a:Math.max(b.xMax,a)):(b.yMin=void 0===b.yMin?a:Math.min(b.yMin,a),b.yMax=void 0===b.yMax?a:Math.max(b.yMax,a))},e=function(a){return Math.round(a*c)/c},f=function(){for(var a="",b=0;b<arguments.length;b++){var c=e(arguments[b]);c>=0&&b>0&&(a+=" "),a+=c,d(c,b%2===0)}return a},g="",h=0;h<this.commands.length;h++){var i=this.commands[h];"M"===i.type?g+="M"+f(i.x,i.y):"L"===i.type?g+="L"+f(i.x,i.y):"C"===i.type?g+="C"+f(i.x1,i.y1,i.x2,i.y2,i.x,i.y):"Q"===i.type?g+="Q"+f(i.x1,i.y1,i.x,i.y):"Z"===i.type&&(g+="Z")}return g},a.prototype.toSVG=function(a){var b='<path d="'+this.toPathData(a)+'"';return this.fill&&"black"!==this.fill&&(b+=' fill="'+this.fill+'"'),this.stroke&&(b+=' stroke="'+this.stroke+'" stroke-width="'+this.strokeWidth+'"'),b+="/>"},a}]),angular.module("services").service("FullTextSearch",["$window","$rootScope","$q","contentProvider","PageLocation","CONFIG","StringUtil",function(a,b,c,d,e,f,g){"use strict";function h(a){for(var b=0;a;b++)a=a.previousSibling;return b}function i(a,b){var c=a&&a.firstChild;if(!c)return":"+g.lengthInUTF8Bytes(a.textContent.substr(0,b));for(var d=1;c;d++){if(c.nodeType===Node.ELEMENT_NODE||c.nodeType===Node.TEXT_NODE){var e=c.textContent?c.textContent.length:0;if(e>b)break;b-=e}c=c.nextSibling}return"/"+d+i(c,b)}function j(a){return d.getEPubInfo().spineIndex[a]||0}function k(a,b,c){var d=a+"#point(/1/"+h(b);return d+i(b,c)+")"}function l(a,b){for(var d,e=b.parsedContent,f=e&&e.documentElement,g=f&&f.querySelector("body"),h=g&&g.textContent||"",i=j(b.name),k=[];null!==(d=a.exec(h));)k.push({startIndex:d.index,endIndex:a.lastIndex,spineIndex:i});return c.resolve(k)}var m=function(){var b=null,g=new e;this.searchResults=[],this.index=0,this.reset=function(){this.searchResults.length=0,this.index=0},this.search=function(e){if(!e||e.length<f.globals.MISC.SEARCH_TERM_MIN_LENGTH)return c.reject("minSearchTermLengthViolation");var g=this,h=[];e=e.replace(/[-*+?.()[\]{}\\^$|#]/g,"\\$&"),a.Modernizr.isfirefox&&(e=("￿"+e).replace(/^\uffff/,""));var i=d.getEPubInfo().spine||[],j=l.bind(null,new RegExp(e,"gi"));return i.forEach(function(a,b){h.push(d.getRawSection(b).then(j))}),b=e,c.all(h).then(function(a){return g.searchResults=Array.prototype.concat.apply([],a)})},this.getIndexByPosition=function(a,b){function c(a){return parseInt(a,10)}for(var d=j(a.fileName),e=this.searchResults.length,f=b.querySelector("body"),k=[1,h(f)],l=0;l<e;l++){var m=this.searchResults[l];if(m.spineIndex>d)return l;if(m.spineIndex===d){var n=i(f,m.startIndex).split(":"),o={childSequence:k.concat(n[0].substr(1).split("/").map(c)),offset:c(n[1])};if(g.compareLocalPosition(o,a)>=0)return l}}return 0},this.getByIndex=function(a){var c=this.searchResults[a]||{};return this.index=a,{fileName:d.getEPubInfo().spine[c.spineIndex].href,startIndex:c.startIndex,endIndex:c.endIndex,markedBookText:b}},this.setRMSDKPosition=function(a,b){var c=b.querySelector("body"),d=a.fileName;a.rmsdkPosition=k(d,c,a.startIndex),a.endPosition=k(d,c,a.endIndex)}};return m}]),angular.module("services").factory("cover",["$window","$timeout","$q","CONFIG","BaseUtil",function(a,b,c,d,e){"use strict";var f=d.globals.MEDIA,g=null,h={},i=null,j=!0,k=function(a){return c.resolve(a?f.IMAGE_DEFAULT_AUDIO:f.IMAGE_DEFAULT_PUB)},l=function(){if(a.Modernizr.webworkers||(g={}),!g){var b=e.getWorkerSource("image.worker.js");g=new Worker(b),g.addEventListener("message",m),g.postMessage({operation:"init",dbConfig:d.globals.INDEXED_CONFIG.covers})}},m=function(c){var d=c&&c.data;if(d)return d.init?void(j=d.isDBSupported):d.error?k(d.isAudio).then(function(a){var c={width:f.FALLBACK_COVER_WIDTH,height:f.FALLBACK_COVER_HEIGHT};return d.isAudio&&(c.width=f.FALLBACK_AUDIO_COVER_WIDTH,c.height=f.FALLBACK_AUDIO_COVER_HEIGHT),h[d.coverUri].reject({blobUri:a,dimensions:c}),b(function(){delete h[d.coverUri]})}):(j||(i[d.coverUri]=!0),d.isStored||j||a.localforage.setItem(d.coverUri,d),h[d.coverUri].resolve(d),b(function(){delete h[d.coverUri]}))},n=function(b,e,l){if(!b)return k(l).then(function(a){return c.reject({blobUri:a,dimensions:{width:f.FALLBACK_COVER_WIDTH,height:f.FALLBACK_COVER_HEIGHT}})});if(!a.Modernizr.webworkers)return c.resolve({blobUri:b,dimensions:{width:f.FALLBACK_COVER_WIDTH,height:f.FALLBACK_COVER_HEIGHT}});if(h[b])return h[b].promise;var m=c.defer();return h[b]=m,j?g.postMessage({operation:"get",coverUri:b,dbConfig:d.globals.INDEXED_CONFIG.covers,isForced:e,isAudio:l}):(i||(i={}),i[b]&&!e?g.postMessage({operation:"get",coverUri:b,dbConfig:d.globals.INDEXED_CONFIG.covers,isAudio:l}):(i[b]=!1,a.localforage.getItem(b).then(function(a){g.postMessage(a||{operation:"get",dbConfig:d.globals.INDEXED_CONFIG.covers,coverUri:b})},function(a){console.log(a),g.postMessage({operation:"get",dbConfig:d.globals.INDEXED_CONFIG.covers,coverUri:b})}))),m.promise},o=function(){if(g)return g.postMessage({operation:"purge",dbConfig:d.globals.INDEXED_CONFIG.covers}),c.resolve()};return l(),{requestCover:n,purge:o}}]),angular.module("services").service("image",["$window","CONFIG",function(a,b){"use strict";var c=b.globals.MIME_TYPES,d=function(a){if(!a)return null;var b=a.split("?")[0],d=b.split(".").pop().toLowerCase();return c[d]||c.png},e=function(c){var d=/(^audio|video_unsupported|video)/i.exec(c),e=d?d[1].toUpperCase():"PUB",f="IMAGE_DEFAULT_"+e,g=b.globals.MEDIA[f];return(a.Modernizr.isie||a.Modernizr.isedge)&&(g+="#"+Date.now()),g},f=function(){return b.globals.MEDIA.IMAGE_NULL};return{getNullImage:f,getMimeType:d,getFallbackImage:e}}]),angular.module("services").factory("inventory",["$window","$rootScope","$q","$filter","bosh","appState","time","user","$injector","$http","StringUtil","CONFIG","error",function(a,b,c,d,e,f,g,h,i,j,k,l,m){"use strict";function n(a){x=a}function o(){return x}var p=null,q={},r=null,s=null,t=null,u={},v=null,w={},x=!1,y=[],z=null,A=null,B={},C=function(){if(!A){var a=i.get("BaseUtil").getWorkerSource("bookshelf.worker.js");A=new Worker(a),A.addEventListener("message",D)}var b=f.fetch("index");if(b)try{b=JSON.parse(b),f.remove("index"),b.map(function(a){f.remove(a)})}catch(a){angular.noop()}},D=function(a){var b=a.data;if(b)switch(b.request){case"full-inventory":return i.get("sync").purge(),H(a);case"delta-inventory":return H(a);case"local-inventory":return F(a);case"add-publication":return Q(a);case"remove-publication":return V(a);case"purge":return X(a);case"save-publication":return O(a);default:return c.resolve(a)}},E=function(){if(!r){r=c.defer(),r.promise.finally(function(){r=null});var a=f.fetch("userid");try{A.postMessage({request:"local-inventory",dbConfig:l.globals.INDEXED_CONFIG.inventory,globals:l.globals,isLoggedIn:h.isLoggedIn()||!e.isBoshOnline(),userid:a,publications:p})}catch(a){console.warn(a)}}return r.promise},F=function(a){if(a.data){var b=a.data;if(b.error)return r.reject(b.log);p||(p=b.publications),p&&I(b),r.resolve(p)}else r.reject(p)},G=function(){return null===s&&(s=c.defer(),s.promise.catch(function(a){return console.info("Could not fetch remote content",a),angular.noop()}),s.promise.finally(function(){s=null}),e.fetchHeader(!0).then(function(a){var b=f.fetch("last-modified");b&&!isNaN(b)&&h.isLoggedIn()&&(b=parseInt(b,10),a["If-Modified-Since"]=new Date(b).toUTCString());var c=i.get("reseller");return c.fetchConfig().then(function(b){var c;c=p&&Object.keys(p).length>0?"delta-inventory":"full-inventory";var d=f.fetch("userid");try{A.postMessage({request:c,dbConfig:l.globals.INDEXED_CONFIG.inventory,globals:l.globals,isLoggedIn:h.isLoggedIn(),userid:d,header:a,config:b,publications:p})}catch(a){console.warn(a)}},function(){s.reject(l.globals.ERROR.APP_NO_CONFIG)})},ja)),s.promise},H=function(b){if(b.data){var c=b.data;if(c.error)return s.reject(c.log);if(c.time&&h.isLoggedIn()&&f.save("last-modified",c.time),p||(p=c.publications),c.deleted&&fa(c.deleted),p&&I(c),h.isLoggedIn()){var d=f.fetch("revision");d!==a.tw.githash&&(console.info("Update sync data due to new revision"),i.get("sync").purge()),f.save("revision",a.tw.githash)}s.resolve(p)}else s.reject(l.globals.ERROR.NETWORK_BOSH_FAIL)},I=function(a){var b=f.fetch("resellercount");p&&(Object.keys(p).forEach(function(b){if(Object.assign(p[b],a.publications[b]),p[b].isPeriodical&&p[b].deliverables.sort(ea),p[b].subscriptionId){var c=i.get("subscription");c.fetchSubscriptionInfo(p[b].subscriptionId).then($.bind(null,p[b]),_.bind(null,p[b].subscriptionId))}p[b].deliverables=J(p[b].deliverables),y.indexOf(p[b].resellerid)===-1&&p[b].resellerid&&(y[y.length]=p[b].resellerid)}),Object.keys(a.publications).forEach(function(b){p[b]||(p[b]=a.publications[b],p[b].deliverables=J(p[b].deliverables),y.indexOf(p[b].resellerid)===-1&&p[b].resellerid&&(y[y.length]=p[b].resellerid))})),y.length>0&&(b&&b!==y.length&&(console.info("handshake change detected, purging sync data"),i.get("sync").purge()),f.save("resellercount",y.length))},J=function(a){return a.map(function(a){return K.isPrototypeOf(a)?B[a.id]?Object.assign(B[a.id],a):B[a.id]=a:(a=M(a),B[a.id]=a),a})},K=function(a){angular.copy(a,this)},L=function(a,b,c,d){d?angular.copy(d,this):(this.category=b||l.globals.MISC.COLLECTION_CATEGORY,this.name=a,this.displayName=c,this.modified=g.getTime())};K.prototype.getTagIndex=function(a){return a=a.toLowerCase(),this.tags.findIndex(function(b){return"string"==typeof b.name&&b.name.toLowerCase()===a&&!b.deleted})},K.prototype.hasTag=function(a){return this.getTagIndex(a)>=0},K.prototype.getTag=function(a){return this.tags[this.getTagIndex(a)]},K.prototype.addTag=function(a,b,c){return!this.hasTag(a)&&(this.tags.push(new L(a,b,c)),!0)},K.prototype.removeTag=function(a){var b=this.getTagIndex(a);if(b>=0){var c=this.tags[b];return c.deleted=!0,c.modified=g.getTime(),!0}return!1},K.prototype.renameTag=function(a,b){var c=this.getTagIndex(a);if(c>=0){var d=this.tags[c];return d.name=b,d.modified=g.getTime(),!0}return!1},Object.defineProperties(K.prototype,{addTag:{enumerable:!1},getTagIndex:{enumerable:!1},hasTag:{enumerable:!1},getTag:{enumerable:!1},removeTag:{enumerable:!1},renameTag:{enumerable:!1}});var M=function(a){var b=new K(a);return b.tags||(b.tags=[]),b.tags=b.tags.map(function(a){return new L(null,null,null,a)}),b},N=function(a){var b=da(a);if(!b)return c.resolve(b);if(w[b.id])return c.resolve(b);if(w[b.id]=c.defer(),h.isLoggedIn()){var d=f.fetch("userid");if(b){b.desc&&(b.desc=b.desc.toString()),b.descAbstract&&(b.descAbstract=b.descAbstract.toString());try{A.postMessage({request:"save-publication",dbConfig:l.globals.INDEXED_CONFIG.inventory,globals:l.globals,isLoggedIn:h.isLoggedIn(),userid:d,publication:b})}catch(a){console.warn(a)}}return w[b.id].promise}},O=function(a){if(a.data&&a.data.publication){var b=a&&a.data&&a.data.publication;b&&w[b.id]&&(w[b.id].resolve(b),w[b.id]=null,delete w[b.id])}},P=function(a){if(null===v){v=c.defer(),v.promise.finally(function(){v=null});var b=f.fetch("userid");try{A.postMessage({request:"add-publication",metadata:a,dbConfig:l.globals.INDEXED_CONFIG.inventory,globals:l.globals,isLoggedIn:h.isLoggedIn(),userid:b})}catch(a){console.warn(a)}}return v.promise},Q=function(a){if(!a.data||!a.data.request||"add-publication"===a.data.request){if(a.data&&a.data.publication){var c=a.data,d=c.publication;return p||(p={}),p[d.id]?Object.assign(p[d.id],d):(p[d.id]=c.publication,p[d.id].deliverables=p[d.id].deliverables.map(function(a){return K.isPrototypeOf(a)||(a=M(a)),b.$broadcast("tw.metadata.update",a.id),B[a.id]=a,a}),p[d.id].deliverables[0].purchased=g.getTime()),v.resolve(d)}v.reject()}},R=[],S=!1,T=function(a){return u[a]?c.resolve(a):(u[a]=c.defer(),R.push(a),S||(S=!0,U(R.shift())),u[a].promise)},U=function(a){try{var b=f.fetch("userid");A.postMessage({request:"remove-publication",dbConfig:l.globals.INDEXED_CONFIG.inventory,globals:l.globals,isLoggedIn:h.isLoggedIn(),userid:b,publication:{id:a}})}catch(a){console.warn(a)}},V=function(a){if(a.data&&a.data.publication){var b=a.data,c=b.publication;b.error===!0?u[c.id].reject(c.id):u[c.id].resolve(c.id),u[c.id]=null,delete u[c.id]}if(R.length>0){var d=R.shift();U(d)}else S=!1},W=function(){if(null===t){t=c.defer(),t.promise.finally(function(){t=null});var a=f.fetch("userid");try{A.postMessage({request:"purge",dbConfig:l.globals.INDEXED_CONFIG.inventory,globals:l.globals,isLoggedIn:h.isLoggedIn(),userid:a})}catch(a){console.warn(a)}}return t.promise},X=function(a){console.info("IndexedDB deleted"),p=null,q={},f.remove("last-modified"),f.remove(l.globals.SHELF_REVISION),t.resolve(a.data)};C();var Y=function(a,c){if(!a||"string"==typeof a){var e=/^(.+)(ASC|DESC)$/i.exec(a);a={order:e&&e[1]||"recent",isDescending:!!e&&"DESC"===e[2]}}switch(a.order){case"title":z=d("orderBy")(c,aa,a.isDescending);break;case"author":z=d("orderBy")(c,ba,a.isDescending);break;case"recent":default:z=d("orderByRecent")(c,a.isDescending)}return b.$broadcast("tw.deliverables.sortOrderChange"),z},Z=function(){return z||Y("recentASC",ca()),z},$=function(a,b){var c=i.get("subscription"),d=b&&c.getTagName(b.id);if(d){var e=b.subscriptionModel&&b.subscriptionModel.name;a.deliverables.forEach(function(a){var b=a.getTag(d);b?b.displayName!==e&&(b.displayName=e):a.addTag(d,l.globals.MISC.SUBSCRIPTION_CATEGORY,e)})}},_=function(a,b){console.warn("Fetching subscription info for ID",a,"failed:",b)},aa=function(a){return k.latinize(a.title).toLowerCase()},ba=function(a){return k.latinize(a.author).toLowerCase()},ca=function(a){a||(a=p);var c=[],d=b.modified&&ia(b.modified)||{bookmark:{modified:null}};for(var e in a){var f=a[e];y.indexOf(f.resellerid)===-1&&f.resellerid&&(y[y.length]=f.resellerid);var g=f.deliverables;g&&g.length>0&&(f.resellerid&&(g[0].resellername=i.get("resellerMapping").getHumanReadable(f.resellerid)),f.isPeriodical&&(g.sort(ea),g[0].items=g.length),g[0].bookmark.modified>d.bookmark.modified&&(d=g[0]),c.push(g[0]))}return b.modified=d.id,n(y.length>1),c},da=function(a){var b;if(a in q)return q[a];for(var c in p){b=p[c].deliverables||[];for(var d=0,e=b.length;d<e;d++)if(b[d].id===a)return q[a]=p[c],p[c]}return null},ea=function(a,b){var c=a&&a.issued||0,d=b&&b.issued||0;return d-c},fa=function(a){var b=[];return a.length>0&&a.forEach(function(a){p[a]?p[a].deliverables.length>1?(console.warn("Multiple deliverables on one publication"),b.push(c.reject("Multiple deliverables on one publication"))):b.push(ga(a)):T(a)}),c.allComplete(b)},ga=function(a){return T(a).then(function(){return p[a]=null,delete p[a],B[a]&&(B[a]=null,delete B[a]),i.get("$timeout")(angular.noop)})},ha=function(a,b){var d=p&&p[a];return b?d?c.resolve(d):E().then(function(){return p[a]}):d},ia=function(a){for(var b in p)for(var c=p[b].deliverables||[],d=0;d<c.length;d++)if(c[d].id===a)return c[d]},ja=function(a){if(a)return a.status?m.handleError({type:l.globals.ERROR.NETWORK_BOSH_FAIL,httpStatusCode:a.status,details:{httpError:a}},!1).then(function(){return p}).catch(function(){return p}):a.name?m.handleError({type:a.name,details:a.message}).then(function(){return p}).catch(function(){return p}):m.handleError(a,!1).then(function(){return p}).catch(function(){return p})};return{deliverables:B,getCurrentlySortedDeliverables:Z,sortDeliverables:Y,addPublication:P,fetchLocalPublications:E,fetchPublications:G,saveDeliverable:N,getDeliverables:ca,getPubForDeliverable:da,getPublication:ha,deletePublications:fa,purge:W,getResellerNames:o}}]).filter("orderByTagAdded",["StringUtil",function(a){"use strict";return function(b,c,d){function e(a){return"string"==typeof a.name&&a.name.toLowerCase()===c}function f(a){return a.tags.findIndex(e)>=0}function g(b,c){function d(b,c){var d=a.latinize(b.title).toLowerCase(),e=a.latinize(c.title).toLowerCase();return d>e?1:d===e?0:-1}var e=b.purchased>b.bookmark.modified?b.purchased:b.bookmark.modified,f=c.purchased>c.bookmark.modified?c.purchased:c.bookmark.modified;return f-e||d(b,c)}function h(a,b){var c=a.tags.findIndex(e),d=b.tags.findIndex(e);return b.tags[d].modified-a.tags[c].modified||g(a,b)}function i(a,b){return h(b,a)}return angular.isArray(b)?(c=c.trim().toLowerCase(),b.filter(f).sort(d?i:h)):b}}]).filter("orderByRecent",["StringUtil",function(a){"use strict";return function(b,c){if(!angular.isArray(b))return b;var d=function(b,c){var d=a.latinize(b.title).toLowerCase(),e=a.latinize(c.title).toLowerCase();return d>e?1:d===e?0:-1},e=function(a,b){var c=a.purchased>a.bookmark.modified?a.purchased:a.bookmark.modified,e=b.purchased>b.bookmark.modified?b.purchased:b.bookmark.modified;
return e-c||d(a,b)},f=function(a,b){return e(b,a)},g=c?f:e;return b.slice().sort(g)}}]),angular.module("services").factory("libraryModel",["$window","$injector","$rootScope","CONFIG","inventory","user","appState","$state","Selection","bosh",function(a,b,c,d,e,f,g,h,i,j){"use strict";var k,l,m,n="tw.library.viewMode",o="tw.library.sortOrder",p="tw.library.sortOrderCollection",q="tw.library.showFinishedItems",r={order:"recent",isDescending:!1},s={order:"title",isDescending:!1},t=d.globals.STORE.TAG_FINISHED_READINGS,u=/^subscription \d+\/\S/,v=function(){if(void 0===k)try{var a=JSON.parse(g.fetch(n));k=!(a&&"grid"in a)||a.grid}catch(a){k=!0}return k},w=function(a){k=a;try{g.save(n,JSON.stringify({grid:a}))}catch(b){console.warn('tw.services.libraryModel: Was not able to setGridView value to "'+a+'"')}return a},x=["recent","author","title"],y=function(){if(!l)try{l=JSON.parse(g.fetch(o))||r}catch(a){console.warn("LOCALSTORAGE_FAIL"),l=r}return l},z=function(a,b){if(x.indexOf(a)>=0){l||(l={}),l.order=a,l.isDescending=!!b;try{g.save(o,JSON.stringify(l))}catch(a){return console.warn("LOCALSTORAGE_FAIL"),!1}return!0}return!1},A=function(){if(!m)try{m=JSON.parse(g.fetch(p))||s}catch(a){console.warn("LOCALSTORAGE_FAIL"),m=s}return m},B=function(a){m=a;try{g.save(p,JSON.stringify(a))}catch(a){return console.warn("LOCALSTORAGE_FAIL"),!1}return!0},C=function(a){var b=a&&e.deliverables[a];if(b){var d=b.isCrypt?"tw.library.download":"tw.library.open";c.$emit(d,a)}},D=!1;try{D=JSON.parse(g.fetch(q))}catch(a){console.warn("tw.services.libraryModel: Was not able to parse finished items")}var E,F=function(a){D=a,c.$emit("tw.library.mark.finished");try{g.save(q,a)}catch(a){console.warn("tw.services.libraryModel: Was not able to finish setting to enable/disable showing finished items")}},G=function(){return D},H={menuId:"ctxMenuLib",isVisible:!1,x:0,y:0,items:{OPEN:{icon:"book",isVisible:!0,isEnabled:!0,tooltip:gettext("TOOLTIP_COMPONENT_LIBRARY_CONTEXTOPEN")},DETAILS:{icon:"info-solid",isVisible:!0,isEnabled:!0,tooltip:gettext("TOOLTIP_COMPONENT_LIBRARY_CONTEXTDETAILS")},EDIT:{icon:"edit",isVisible:!0,isEnabled:!0,tooltip:gettext("TOOLTIP_COMPONENT_LIBRARY_CONTEXTEDIT")},DOWNLOAD:{icon:"cloud-download",isVisible:!0,isEnabled:!0,tooltip:gettext("TOOLTIP_COMPONENT_LIBRARY_CONTEXTDOWNLOAD")},ADD_TO_COLLECTION:{icon:"plus-circled",isVisible:!0,isEnabled:!0,tooltip:gettext("ADD_TO_COLLECTION")},REMOVE_FROM_COLLECTION:{icon:"minus-circled",isVisible:!0,isEnabled:!0,tooltip:gettext("REMOVE_FROM_COLLECTION")},MARK_AS_FINISHED:{icon:"checkmark",isVisible:!0,isEnabled:!0,tooltip:gettext("MARK_AS_FINISHED")},DELETE:{icon:"delete",isVisible:!0,isEnabled:!0,tooltip:gettext("TOOLTIP_COMPONENT_LIBRARY_CONTEXTDELETE")}}},I={EDIT:"tw.library.metadata",DELETE:"tw.library.delete",DOWNLOAD:"tw.library.download",OPEN:"tw.library.open",ADD_TO_COLLECTION:"tw.collection.add",REMOVE_FROM_COLLECTION:"tw.collection.remove",MARK_AS_FINISHED:"tw.library.mark.finished",DETAILS:"tw.library.details"},J=function(a){var b=M(a.target);b&&E&&(N(b,a.clientX,a.clientY),c.$emit("tw.contextMenu.visibility",H)),a.preventDefault&&a.preventDefault(),a.stopPropagation&&a.stopPropagation()},K=function(a,b){if(b.menuId===H.menuId){var d=b.action,e=I[d];e&&c.$emit(e,b.param),c.$broadcast("tw.library.focusContextItem",null)}},L=function(a,b,c,d,e){b===H.menuId&&N(M(c),d,e)},M=function(a){for(var b=null;a&&!b;)b=a.getAttribute&&a.getAttribute("deliverable-id"),a=a.parentNode;return b},N=function(b,d,g){if(H.isVisible&&b===H.param)return H.x=d,void(H.y=g);var i=b&&e.deliverables[b];if(i){var k=H.items,l=j.isBoshOnline(),m=l&&f.isLoggedIn(),n=void 0!==i.subscriptionId,o=h.current.name,p=h.includes("details.**"),q=o.endsWith(".collections.titles")&&h.params.name!==t,r=u.test(h.params.name),s="AUDIOBOOK"===i.type;k.OPEN.icon=s?"headphone":"book",k.DETAILS.isVisible=!p&&!s,k.EDIT.isVisible=!s;var v=a.Modernizr.issafari&&"EDATA"===i.type;k.OPEN.isEnabled=(l||i.isOffline)&&!i.isCrypt,k.EDIT.isEnabled=m&&"EDATA"===i.type,k.DELETE.isEnabled=m,k.DOWNLOAD.isEnabled=m&&!n&&!v,k.ADD_TO_COLLECTION.isEnabled=m,k.ADD_TO_COLLECTION.isVisible=o.endsWith(".titles"),k.REMOVE_FROM_COLLECTION.isEnabled=m&&(!n||!r),k.REMOVE_FROM_COLLECTION.isVisible=q&&(!n||!r),k.DETAILS.isEnabled=!s&&!p,k.MARK_AS_FINISHED.isEnabled=m&&!s,k.MARK_AS_FINISHED.tooltip=i.isFinished?gettext("MARK_AS_NOT_FINISHED"):gettext("MARK_AS_FINISHED"),k.OPEN.tooltip=s?gettext("TOOLTIP_COMPONENT_LIBRARY_CONTEXTOPENAUDIO"):gettext("TOOLTIP_COMPONENT_LIBRARY_CONTEXTOPEN"),H.param=b,H.x=d,H.y=g}H.isVisible=!!i,c.$broadcast("tw.library.focusContextItem",b)},O=[];document.addEventListener("contextmenu",J,!1);var P=function(a){var b;if(a!==E)if(E=a,a)O.push(c.$on("tw.longpress",function(a,b){J(b)})),O.push(c.$on("tw.contextMenu.action",K)),O.push(c.$on("tw.contextMenu.update",L));else for(;b=O.pop();)b()};return b.get("finishedItems"),{isGridView:v,setGridView:w,selection:new i,getSortOrder:y,setSortOrder:z,getCollectionsSortOrder:A,setCollectionsSortOrder:B,openDeliverable:C,setShowFinishedItems:F,showFinishedItems:G,hasMultipleResellers:!1,setContextMenuActive:P,showContextMenu:J}}]),angular.module("services").factory("loader",["$window","$rootScope","$q","$http","$timeout","$injector","base64","CONFIG",function(a,b,c,d,e,f,g,h){"use strict";var i,j,k,l,m,n=h.globals.STORE,o=Object.create(null),p=null,q=function(a){return c.reject(a)},r=function(b,g,j,l){if(!b||!g)return c.reject("no deliverableId or publicationId given");i=f.get("reseller"),k=f.get("bosh");var m=function(j){return i.fetchConfig().then(function(i){var m=i.URL_BOOKSHELF+"cloud/downloadinfo/"+btoa(b)+"/"+btoa(g)+"/type/HTML5";if(angular.isDefined(l)&&(m+="?trackNo="+l),!k.isBoshOnline())return c.reject(h.globals.ERROR.NETWORK_OFFLINE);var n=c.defer(),o=e(function(){n.resolve("TIMEOUT")},2e4),p=function(a){return e.cancel(o),a};return d({method:"GET",timeout:n.promise,url:m,headers:j}).then(p,function(b){var c=f.get("error");return b&&b.status&&401===b.status?c.handleError({type:h.globals.ERROR.APP_INVALID_TOKEN,httpStatusCode:b.status,details:{httpError:b}}).then(function(){return d({method:"GET",timeout:n.promise,url:m,headers:j}).then(p)}).catch(y):c.handleError({type:h.globals.ERROR.APP_CONTENT_DELIVERABLE_FAIL,details:{deliverableId:g},ui:{message:a.gettext("CONTENT_ERROR_MESSAGE"),headline:a.gettext("SERVER_ERROR_TITLE")},bosh:!0},!0).catch(y)})},q.bind(null,h.globals.ERROR.APP_NO_CONFIG))};return j?m(j):k.fetchHeader(!0).then(m,null)},s=function(b){if(!(!m.isLoggedIn()||Modernizr.ios&&b.buffer.byteLength>n.MAX_SIZE_SAVE_IOS||Modernizr.android&&b.buffer.byteLength>n.MAX_SIZE_SAVE_ANDROID)){var c=a.infoforage;return c.setItem(b.id,b.info),a.localforage.setItem(b.id,b.buffer).then(function(){var a=j.deliverables[b.id];return a.isOffline=!0,j.saveDeliverable(b.id),e(angular.noop,0,!0)},q)}},t=function(a,b,c){a&&b&&(c.publication=b,c.deliverable=a,a.cover?l.requestCover(a.cover).then(function(a){c.coverUrl=a.blobUri},function(){c.coverUrl=h.globals.MEDIA.IMAGE_DEFAULT_PUB}):c.coverUrl=h.globals.MEDIA.IMAGE_DEFAULT_PUB)},u=function(d,g){if(k=f.get("bosh"),j=f.get("inventory"),l=f.get("cover"),m=f.get("user"),!d||!g)return c.reject("no deliverableId or scope status object");var i=j.deliverables[d],u=j.getPubForDeliverable(d);if(t(i,u,g),p&&p.id===d){if(p.buffer)return e(function(){return p},0);p=null}var w;if(o.id)return o.id===d?o.promise:c.reject("A download is already in progress");o.id=d;var A=function(){return j.fetchPublications().then(function(){return i&&u||(i=j.deliverables[d],u=j.getPubForDeliverable(d),t(i,u,g)),i&&u?k.fetchHeader(!0).then(function(e){return o.abort?c.reject(h.globals.ERROR.ABORT):r(u.id,i.id,e).then(function(j){var l;if(o.abort)return c.reject(h.globals.ERROR.ABORT);if(200===j.status){l=a.tw.debugInfo&&a.tw.debugInfo.downloadInfo?a.tw.debugInfo.downloadInfo:j.data&&j.data.DownloadInfo;var q=l&&l.contentUrl,r=l.location?"BOSH"===l.location||"bosh"===l.location:"EDATA"===u.type;return(Modernizr.ios&&!Modernizr.ios9&&l.fileSize>n.MAX_SIZE_SAVE_IOS||Modernizr.ios9&&l.fileSize>2*n.MAX_SIZE_SAVE_IOS)&&b.$emit("tw.library.open",i.id,"ios"),l.format===h.globals.MIME_TYPES.acsm?c.reject(h.globals.ERROR.UNSUPPORTED_MEDIA):a.tw.debug?k.fetchHardware().then(function(b){return console.log(JSON.stringify({downloadInfo:l,header:e,hwinfos:b})),delete a.tw.debug,c.resolve("DEBUG")},null):v(d,q,g,r,e).then(function(b){var c={buffer:b,id:i.id,info:l};p=c;var d=z(l);return null!==d?k.fetchHardware().then(function(b){return d.devKey=b.devKey,a.tw.debugInfo&&a.tw.debugInfo.hwinfos&&(d=a.tw.debugInfo.hwinfos.devKey),c.crypto=d,m.isLoggedIn()&&s(c),c},null):(m.isLoggedIn()&&s(c),a.tw.debugInfo&&a.tw.unsetDebugInfo(),c)},function(b){if(b!==h.globals.ERROR.ABORT){var c=f.get("error");return c.handleError({type:h.globals.ERROR.APP_CONTENT_DELIVERABLE_FAIL,details:{deliverableId:d,deliverable:i},ui:{message:a.gettext("CONTENT_ERROR_MESSAGE"),headline:a.gettext("SERVER_ERROR_TITLE")},bosh:"EDATA"===u.type},!0).catch(y)}})}return c.reject(j.status)},null)},null):c.reject("no deliverable or publication found for id ->",d)},q)},B=function(){return a.localforage.removeItem(d),C.removeItem(d),A()},C=a.infoforage;return w=o.promise=C.getItem(d).then(function(b){var c={};return c.id=d,b?(c.info=b,a.localforage.getItem(d).then(function(a){if(!a)return B();c.buffer=a;var f=j.deliverables[d];f&&(f.isOffline=!0),j.saveDeliverable(d),e(angular.noop,0,!0),p=c;var g=z(b);return null!==g?k.fetchHardware().then(function(a){return g.devKey=a.devKey,c.crypto=g,c},null):c},B)):B()},B).then(x,function(a){return x(),c.reject(a)})},v=function(a,d,e,f,g){var i=c.defer(),j=new XMLHttpRequest;return o.xhr=j,j.open("GET",d,!0),f&&(j.setRequestHeader("t_auth_token",g.t_auth_token),j.setRequestHeader("hardware_id",g.hardware_id),j.setRequestHeader("reseller_id",g.reseller_id)),j.responseType="arraybuffer",j.onprogress=function(c){c.lengthComputable&&o.xhr&&b.$broadcast("tw.download.progress",{id:a,loaded:c.loaded,total:c.total})},j.onload=function(){j.status&&j.status<400?i.resolve(j.response):i.reject(j),j=o.xhr=null},j.onerror=j.onabort=function(){j=o.xhr=null,i.reject(h.globals.ERROR.ABORT)},j.send(),i.promise},w=function(a){return a?(o.id="sample",v("sample",a,!1,null).then(function(a){var b={buffer:a,id:"sample"};return p=b,b},q.bind(null,"error download sample")).then(x,function(a){return x(),c.reject(a)})):c.reject("no url specified")},x=function(a){return o.id=null,o.promise=null,o.xhr=null,o.abort=!1,a},y=function(){o.id&&(o.xhr&&o.xhr.abort(),o.abort=!0,b.$emit("tw.loader.abort"))},z=function(a){if(a){var b=a.cf1,c=a.cf2;return b||c?(console.info("Publication is encrypted"),{key:b&&g.decodeString(b,!0),vector:c&&g.decodeString(c,!0)}):null}},A=function(a){return o.id===a},B=function(a){var b=Math.round(a/1e3);return isNaN(b)?"":b<1e4?b+" kB":Math.round(b/1e3)+" MB"},C=function(){return p},D=function(a){a&&(p=a)},E=function(){p=null};return{clearBuffer:E,getBuffer:C,setBuffer:D,isLoading:A,abortDownload:y,fetchInfo:r,fetchDeliverable:u,fetchSample:w,getHumanReadableText:B}}]),angular.module("services").factory("parser",["$translate","CONFIG","time",function(a,b,c){"use strict";var d={EBOOK:"?size=BS-B03",EPAPER:"?size=BS-P11",EMAGAZINE:"?size=BS-M11",AUDIOBOOK:"?size=WS-B04"},e=["ebook","emagazine","edata","epaper","audiobook"],f={},g=function(a){return a.id||a.identifier||a.deliverableId},h=function(a,b,c){var d=a.protectionType,e=parseInt(a.acsEncrypted,10);return"ACS4"===d&&1===e||("ACS4"!==d||0!==e)&&(!(b||!e)||("ePub"!==c||!b)&&"ACSM"===c)},i=function(a,c){this.id=g(a),this.format=s(a.format||a.contentFormat),this.isCrypt=void 0!==a.isCrypt?a.isCrypt:h(c,a.contentEncrypted,this.format),"ePub"===this.format&&(this.epubVersion=a.epubVersion||c.epubVersion),this.purchased=a.purchased,this.issued=a.issued,this.title=a.title,this.subtitle=a.subtitle,this.isHidden=a.isHidden||a.hidden,c&&(this.author=t(c.author),this.type=c.type),this.subscriptionId=a.subscriptionId||c&&(c.subscriptionId||c.ext_data&&c.ext_data.subscriptionId),"AUDIOBOOK"===this.type&&(this.tracks=a.tracks,this.speaker=t(a.speaker),this.reader=t(a.reader),this.duration=a.duration),this.revision||(this.revision=a.revision||null),this.comments||(this.comments=a.comments||[]),this.dogears||(this.dogears=a.dogears||[]),this.bookmark||(this.bookmark=a.bookmark||{}),void 0===this.bookmark.modified&&(this.bookmark.modified=0),this.tags||(this.tags=a.tags||[]),this.isFinished=this.tags.some(function(a){return"string"==typeof a.name&&"system"===a.category&&a.name===b.globals.STORE.TAG_FINISHED_READINGS&&!a.deleted}),a.cover?this.cover=a.cover:this.setCover(a,c),this.isOffline="isOffline"in a&&a.isOffline,this.isSample="isSample"in a&&a.isSample,"hasUnsupportedFeat"in this||(this.hasUnsupportedFeat="hasUnsupportedFeat"in a?a.hasUnsupportedFeat:null)};i.prototype.setCover=function(a,b){var c=b&&b.ext_data&&"default"===b.ext_data.cover;c||(this.cover=q(b.type,b.fileResource,a.fileResource))},i.prototype.update=function(a,b){this.isOffline&&(a.isOffline=!0),this.constructor(a,b)};var j=function(a,d,e){this.category=d||b.globals.MISC.COLLECTION_CATEGORY,this.name=a,this.displayName=e,this.modified=c.getTime()};i.prototype.getTagIndex=function(a){return a=a.toLowerCase(),this.tags.findIndex(function(b){return"string"==typeof b.name&&b.name.toLowerCase()===a&&!b.deleted})},i.prototype.hasTag=function(a){return this.getTagIndex(a)>=0},i.prototype.getTag=function(a){return this.tags[this.getTagIndex(a)]},i.prototype.addTag=function(a,b,c){return!this.hasTag(a)&&(this.tags.push(new j(a,b,c)),!0)},i.prototype.removeTag=function(a){var b=this.getTagIndex(a);if(b>=0){var d=this.tags[b];return d.deleted=!0,d.modified=c.getTime(),!0}return!1},i.prototype.renameTag=function(a,b){var d=this.getTagIndex(a);if(d>=0){var e=this.tags[d];return e.name=b,e.modified=c.getTime(),!0}return!1},Object.defineProperties(i.prototype,{addTag:{enumerable:!1},getTagIndex:{enumerable:!1},hasTag:{enumerable:!1},getTag:{enumerable:!1},removeTag:{enumerable:!1},renameTag:{enumerable:!1},setCover:{enumerable:!1},update:{enumerable:!1}});var k=Object.create(null),l=function(a){var b=g(a);return!(!b||k[b])&&(k[b]=!0)},m=function(a){function b(b){return new i(b,a)}var c=a.deliverables||a.deliverable;return c&&0!==c.length?c.filter(l).map(b):null},n=function(a,b){var c=a.ext_data||f;this.id=a.id||a.identifier||a.deliverableId,this.transactionid=a.transactionid||c.transaction_id,this.subscriptionId=a.subscriptionId||c.subscriptionId,this.acsEncrypted=a.acsEncrypted||c.acs_encrypted,this.protectionType=a.protectionType,this.title=a.title,this.subtitle=a.subtitle,this.author=t(a.author),this.resellername=a.resellername,this.resellerid=a.resellerid,this.publisher=a.publisher,this.type=a.type,this.descAbstract=a.descAbstract||a.abstract,b||(this.deliverables=m(a)),this.isPeriodical=this.deliverables&&this.deliverables.length>1};n.prototype.update=function(a){this.isPeriodical?this.updateDeliverables(a):(this.constructor(a,!0),this.updateDeliverables(a))},n.prototype.updateDeliverables=function(a){var b,c=a.deliverables||a.deliverable,d={};for(this.deliverables||(this.deliverables=[]),b=0;b<this.deliverables.length;b++)d[this.deliverables[b].id]=b;for(b=0;b<c.length;b++){var e=c[b],f=e.id||e.identifier||e.deliverableId,g=d[f];void 0!==g?this.deliverables[g].update(e,a):this.deliverables.push(e)}},Object.defineProperties(n.prototype,{update:{enumerable:!1},updateDeliverables:{enumerable:!1}});var o=function(a,b){k=Object.create(null);var c=a&&a.PublicationInventory;return c?(e.forEach(function(a){var d=c[a]||[];d.forEach(function(a){if(a){var c=a.epubMetaData;c.resellername=a.resellerName,c.resellerid=a.resellerId;var d=c.identifier;d in b?b[d].update(c):d&&(b[d]=new n(c))}})}),k=Object.create(null),b):b},p=function(a){return o(a,{})},q=function(a,b,c){switch(a){case"EBOOK":case"AUDIOBOOK":return r(b,c,d[a]);case"EPAPER":case"EMAGAZINE":return r(c,b,d[a]);case"EDATA":return r(b,c)}return""},r=function(a,b,c){var d,e=a?a.length:0,f=b?b.length:0;for(d=0;d<e;d++)if("SCALEDCOVER"===a[d].type)return a[d].resource+c;for(d=0;d<f;d++)if("SCALEDCOVER"===b[d].type)return b[d].resource+c;for(d=0;d<e;d++)if("FRONTCOVERIMAGE"===a[d].type)return a[d].resource},s=function(a){if(a){if(a.indexOf("epub")>-1)return"ePub";if(a.indexOf("pdf")>-1)return"PDF";if(a.indexOf("vnd")>-1)return"ACSM"}return a},t=function(b){if("[object String]"===Object.prototype.toString.call(b))return b;if("[object Array]"===Object.prototype.toString.call(b))for(var c,d,e=0;e<b.length;e++)if(c=b[e]){if(c.name)d=c.name.trim();else{var f=(c.firstName||"").trim(),g=(c.lastName||"").trim();d=""!==f?f+" "+g:g}return d||a.instant(gettext("COMMON_UNKNOWN_TITLE"))}},u=function(a){var b=new n(a);return l(a)&&(b.deliverables=[new i(a,a)]),b};return{PublicationModel:n,parseToPublications:o,parsePublications:p,parsePublication:u}}]),angular.module("services").service("ContentProcessor",["$window","CONFIG","$q","$timeout","BaseUtil","FileUtil","HTML","CSS","CSSParser","FontStyle",function(a,b,c,d,e,f,g,h,i,j){"use strict";function k(a){this.queue=[],this.options=a||{}}function l(a){return a&&(a.nodeType===Node.DOCUMENT_FRAGMENT_NODE||a.nodeType===Node.DOCUMENT_NODE?/XML|X?HTML/i.test(a.documentElement.nodeName):a.ownerDocument&&l(a.ownerDocument))}function m(a){return a&&"image/svg+xml"===a.contentType}function n(a){var c=document.createElement("div");return c.setAttribute("id","vspace_"+f.sanitizeFileName(a)),c.setAttribute("class",b.globals.READER.SPACER_CLASSNAME),c.style.margin="0 !important;",c.style.height="16px",c}function o(a,b){if(l(a)){Array.prototype.forEach.call(a.querySelectorAll("img"),function(a){a.setAttribute("data-src",a.getAttribute("src")),a.removeAttribute("src")});var d=a.body||a.querySelector("body")||a;d.appendChild(n(b.root))}else if("string"==typeof a){var e=s.parse(a);e.cssRules&&(a=e)}return c.resolve(a)}function p(a,b,c,d){var e=new k(c),f=c.root;return c.root=d,e.addTask("EMBED_CSS_IMPORT_RULES"),e.addTask("REMOVE_ROOT_SPACING"),e.addTask("SPLIT_CSS_FONT_SHORTHAND"),c.hasFixedLayout||e.addTask("PATCH_CSS_FONT_SIZES"),e.addTask("EMBED_CSS_FONTS"),e.addTask("REMOVE_CSS_FONTS"),e.addTask("EMBED_CSS_IMAGES"),e.startProcessing(a).then(function(a){c.root=f,b.innerHTML=a})}function q(a,b){if(/^LINK$/i.test(a.nodeName)){var d=a.getAttribute("href"),e=f.resolveRelativePath(d,b.root),g=b.files[e];if(!g)return console.warn('ContentProcessor.processCSS: Referenced source file "'+e+'" not found'),a.parentNode.removeChild(a),c.resolve();var h=document.createElement("style");return h.setAttribute("type","text/css"),a.parentNode.replaceChild(h,a),g.extract().then(function(){return p(g.getFileContentAsString(),h,b,e)})}return p(a.innerHTML,a,b,b.root)}function r(a,b){var d=[],f=a.querySelectorAll('style[type="text/css"], link[rel="stylesheet"]')||[],g=a.querySelector("head")||a;j.removePublicationFonts(b.files),Array.prototype.forEach.call(f,function(a){d.push(q(a,b))});var h=document.createElement("link");return h.type="text/css",h.rel="stylesheet",h.href=e.getLocationURL("assets/themes/default/epubreader.css"),g.appendChild(h),c.all(d).then(function(){return a})}var s=new i;k.prototype.PROCESSOR_TASK={REMOVE_ROOT_SPACING:h.removeSpaceFromRoot,SPLIT_CSS_FONT_SHORTHAND:h.processFontStyles,PATCH_CSS_FONT_SIZES:h.patchCSSFontSizes,REMOVE_CSS_FONTS:h.removeCSSFonts,EMBED_CSS_IMAGES:h.embedImages,EMBED_CSS_IMPORT_RULES:h.embedImportRules,REMOVE_CSS_TEXT_ALIGN:h.removeTextAlign,REMOVE_CSS_LINE_HEIGHT:h.removeLineHeight,REMOVE_CSS_COLOR:h.removeColor,EMBED_CSS_FONTS:j.embedCSSFonts,SET_LANG_ATTRIBUTE:g.setLangAttribute,PREPROCESS_LINKS:g.preprocessLinks,CONVERT_SVG_IMAGES:g.convertSVGImages,EMBED_HTML_IMAGES:g.embedImages,EMBED_SCRIPTS:g.embedScripts,PREPROCESS_IMAGES:g.preprocessImages,PREPROCESS_AUDIO_VIDEO:g.preprocessAudioVideo,SPLIT_FONT_SHORTHAND:g.processFontStyles,REMOVE_FONT_FAMILIES:g.removeFontFamilyStyles,REMOVE_TEXT_ALIGN:g.removeTextAlignStyles,REMOVE_LINE_HEIGHT:g.removeLineHeightStyles,REMOVE_COLOR:g.removeColorStyles,PROCESS_STYLES:r},k.prototype.addTask=function(a){var b=this.PROCESSOR_TASK[a];this.queue.push(function(a){return b.call(null,a,this.options)}.bind(this))},k.prototype.startProcessing=function(a){var b=c.defer(),d=o(a,this.options);return this.queue.push(function(a){"function"==typeof a.cssText&&(a=a.cssText()),b.resolve(a),this.queue.length=0,this.options=null}.bind(this)),this.queue.reduce(function(a,b){return a.then(b)},d),b.promise},this.processContent=function(a,b){var d;return l(a)?(d=new k(b),d.addTask("SET_LANG_ATTRIBUTE"),d.addTask("PREPROCESS_LINKS"),d.addTask("CONVERT_SVG_IMAGES"),d.addTask("EMBED_HTML_IMAGES"),d.addTask("PREPROCESS_AUDIO_VIDEO"),d.addTask("SPLIT_FONT_SHORTHAND"),d.addTask("EMBED_SCRIPTS"),d.addTask("PROCESS_STYLES"),d.startProcessing(a)):m(a)?(d=new k(b),d.addTask("CONVERT_SVG_IMAGES"),d.addTask("EMBED_HTML_IMAGES"),d.startProcessing(a)):c.reject("Invalid content type")}}]),angular.module("services").service("CSS",["CONFIG","CSSParser","CSSTree","$q","$rootScope","URLManager","FileUtil",function(a,b,c,d,e,f,g){"use strict";var h=this,i=/([^a-z0-9_\-.#]|^)body(?![a-z0-9_\-])/i,j=/url\(["']?(.+\.(png|jpg|jpeg|gif|svg)[\1]?)/i,k=/px$|pt$|cm$|mm$|in$|pc$/i,l={font:16,"font-size":16,"line-height":18},m={normal:"100%","xx-small":"56.25%","x-small":"62.5%",small:"81.25%",medium:"100%",large:"112.5%","x-large":"150%","xx-large":"200%",smaller:"83.33%",larger:"120%"},n={"font-style":/^(normal|italic|oblique)$/i,"font-variant":/^(normal|small-caps)$/i,"font-weight":/^(normal|bold|bolder|lighter|\d00)$/i,"font-stretch":/^(normal|condensed|expanded|ultra-condensed|extra-condensed|semi-condensed|semi-expanded|extra-expanded|ultra-expanded)$/i},o={pt:16/12,cm:37.8,mm:3.78,in:96,pc:16},p=/^(margin(-left|-right|-top|-bottom)?|padding(-left|-right)?|(min|max)(-width|-height))$/,q=function(a){return a[0]&&Object.getPrototypeOf(a[0])},r=function(a,b,c){var d=o[c.toLowerCase()]||1;return a*d/b*100},s=function(a,b,d){var e,f,g,h=(new c).Declaration,i=a.length-1,j=function(a,c){var e=new h(a,c instanceof Array?c:[c]);d.splice(b++,0,e)};for(f=i;f>=0&&(e=a[f],isNaN(parseFloat(e))&&!m[e.toLowerCase()]);f--);g=f<i?a.slice(f+1):["inherit"],d.splice(b++,1,new h("font-family",g)),f>1&&"/"===a[f-1]?(j("font-size",a[f-2]),j("line-height",a[f]),f-=3):(j("font-size",a[f]||"100%"),f--);for(var k,l=Object.keys(n),o=0;o<=f;o++)for(e=a[o];k=l.shift();)if(n[k].test(e)){j(k,e);break}},t=function(a,b){var c=a.cssRules||[],e=q(c);return c.forEach(function(a){if(a.type===e.STYLE_RULE)for(var c=a.declarations||[],d=c.length-1;d>=0;d--)c[d].property===b&&c.splice(d,1)}),d.resolve(a)};this.patchCSSFontSizes=function(a){var b=a.cssRules||[],c=q(b);return b.forEach(function(a){if(a.type!==c.STYLE_RULE)return void(a.type===c.MEDIA_RULE&&h.patchCSSFontSizes(a));var b=a.declarations||[];b.forEach(function(a){var b=l[a.property];if(b){var c,d=a.values||[];d.forEach(function(a,e){var f;null!==(f=a.match(k))?d[e]=r(parseFloat(a,10),b,f[0])+"%":(c=m[a.toLowerCase()])&&(d[e]=c)})}})}),d.resolve(a)},this.removeCSSFonts=function(a){for(var b=a.cssRules||[],c=q(b),e=b.length-1;e>=0;e--){var f=b[e];f&&f.type===c.FONT_FACE_RULE&&b.splice(e,1)}return d.resolve(a)},this.removeTextAlign=function(a){return t(a,"text-align")},this.removeColor=function(a){return t(a,"color")},this.removeLineHeight=function(a){return t(a,"line-height")},this.removeSpaceFromRoot=function(a){var b=a.cssRules||[],c=q(b);return b.forEach(function(a){if(a.type!==c.STYLE_RULE)return void(a.type===c.MEDIA_RULE&&h.removeSpaceFromRoot(a));if(i.test(a.selectorText()))for(var b=a.declarations||[],d=b.length-1;d>=0;d--)p.test(b[d].property)&&b.splice(d,1)}),d.resolve(a)},this.embedImages=function(b,c){var e=c&&c.files||{},h=c&&c.root||"",i=c&&c.deliverableId||"",k=b.cssRules||[],l=a.globals.MIME_TYPES,m=[];return k.forEach(function(b){var c=b.declarations||[];c.forEach(function(b){var c=b.values||[];c.forEach(function(b,d){var k=b.match(j);if(k){var n=k[1],o=k[2],p=l[o.toLowerCase()];n=g.resolveRelativePath(n,h);var q=e[n];return q?void m.push(q.extract().then(function(a){c[d]="url("+f.createURL(i+n,a,p)+")"})):(console.warn('CSS.embedImages: File "'+n+'" not found'),void(c[d]="url("+a.globals.MEDIA.IMAGE_PLACEHOLDER+")"))}})})}),d.all(m).then(function(){return b})},this.embedImportRules=function(a,c){var e,f=c&&c.files||{},h=c&&c.root||"",i=a.cssRules||[],j=q(i),k=[];return i.forEach(function(a,c){if(a.type===j.IMPORT_RULE){var d=a.selectorText().match(/(url\()?['"]?([^'"\)]+)/),i=d&&g.resolveRelativePath(d[2],h),l=f[i];if(!l)return void console.warn('CSS.embedImportRules: File "'+i+'" not found');e||(e=new b),k.push(l.extract().then(function(){return{position:c,cssRules:e.parse(l.getFileContentAsString()).cssRules||[]}}))}}),d.all(k).then(function(b){for(var c;c=b.pop();)Array.prototype.splice.apply(a.cssRules,[c.position,1].concat(c.cssRules));return a})},this.processFontStyles=function(a){var b=a.cssRules||[];return b.forEach(function(a){for(var b=a.declarations||[],c=b.length-1;c>=0;c--)"font"===b[c].property&&s(b[c].values,c,b)}),d.resolve(a)}}]),angular.module("services").service("CSSLexer",["$window",function(a){"use strict";var b="\\uFEFF",c="[\\t\\n\\f ]",d=c+"*",e="[\\n\\f]",f="[\\ud800-\\udbff][\\udc00-\\udfff]",g="[\\u0080-\\ud7ff\\ue000-\\ufffd]|"+f,h="[0-9a-fA-F]{1,6}"+c+"?",i="U[+][0-9A-F?]{1,6}(?:-[0-9A-F]{1,6})?",j="(?:"+h+"|[\\u0020-\\u007e\\u0080-\\ud7ff\\ue000\\ufffd]|"+f+")",k="\\\\"+j,l="(?:[\\t\\x21\\x23-\\x26\\x28-\\x5b\\x5d-\\x7e]|"+g+"|"+k+")",m="[^'\"\\n\\f\\\\]|\\\\[\\s\\S]",n="\"(?:'|"+m+')*"|\'(?:"|'+m+")*'",o="[-+]?(?:[0-9]+(?:[.][0-9]+)?|[.][0-9]+)",p="(?:[a-zA-Z_]|"+g+"|"+k+")",q="(?:[a-zA-Z0-9_-]|"+g+"|"+k+")",r="-?"+p+q+"*",s="(?:@?-?"+p+"|#)"+q+"*",t=o+"(?:%|"+r+")?",u="url[(]"+d+"(?:"+n+"|"+l+"*)"+d+"[)]",v="<!--",w="-->",x=c+"+",y="/(?:[*][^*]*[*]+(?:[^/][^*]*[*]+)*/|/[^\\n\\f]*)",z="(?!url[(])"+r+"[(]",A="[~|^$*]=",B="[^\"'\\\\/]|/(?![/*])",C=[b,i,u,z,s,n,t,v,w,x,y,A,B],D=new RegExp(C.join("|"),"gi"),E="'".charCodeAt(0),F='"'.charCodeAt(0),G="/".charCodeAt(0),H=" ".charCodeAt(0),I=new RegExp("^url\\("+d+"[\"']?|[\"']?"+d+"\\)$","gi"),J=/[\u0000-\u001f\\"<>]/g,K={"\\":"\\\\"},L={"\\":"%5c"},M=function(a){var b=parseInt(a.substring(1),16);return b>65535?(b-=65536,String.fromCharCode(55296+(b>>10),56320+(1023&b))):isNaN(b)?a[1]<" "?"":a[1]:String.fromCharCode(b)},N=function(a,b){return'"'+a.replace(J,b)+'"'},O=function(a){return K[a]||(K[a]="\\\\"+a.charCodeAt(0).toString(16)+" ")},P=function(a){return L[a]||(L[a]=(a<""?"%0":"%")+a.charCodeAt(0).toString(16))},Q=function(a){return a.replace(new RegExp("\\\\(?:"+j+"|"+e+")","g"),M)},R=function(a){return a===F||a===E},S=function(a,b){return a===G&&b>1},T=function(a,b){return a<=H||"\\"===b||b===w||b===v||"\ufeff"===b},U=function(a){for(var b=0,c=" ",d=0,e=a.length;d<e;d++){var f=Q(a[d]),g=f.length,h=f.charCodeAt(0);T(h,f)||S(h,g)?f=" ":R(h)?f=N(f.substring(1,g-1),O):/url\(/i.test(f)&&(f="url("+N(f.replace(I,""),P)+")"),f===c&&" "===f||(a[b++]=c=f)}return a.length=b,a};this.tokenize=function(b){return a.Modernizr.isfirefox&&(b=("￿"+b).replace(/^\uffff/,"")),b=b&&b.replace(/\r\n?/g,"\n")||"",b=b.match(D)||[],U(b)}}]),angular.module("services").factory("CSSParser",["CSSLexer","CSSTree",function(a,b){"use strict";var c=/^-?[a-z]/i,d={"{":!0,"}":!0,";":!0,"@":!0},e=function(a,b){return"["===a&&"]"===b||"("===a&&")"===b};return function(){var f=new b,g=function(b){var c=a.tokenize(b);f.startStylesheet();for(var d=0,e=c.length;d<e;)d=" "===c[d]?d+1:h(c,d,e);f.endStylesheet()},h=function(a,b,c){return b<c?"@"===a[b].charAt(0)?i(a,b,c,!0):k(a,b,c):b},i=function(a,b,c,d){for(var e=b++;b<c&&"{"!==a[b]&&";"!==a[b];)b++;if(b<c&&(d||";"===a[b])){var g=e+1,h=b;g<c&&" "===a[g]&&g++,h>g&&" "===a[h-1]&&h--;var i=a[e].toLowerCase();f.startAtRule(i,a.slice(g,h)),b="@page"===i||"@font-face"===i?k(a,b,c):"{"===a[b]?j(a,b,c):b+1,f.endAtRule()}return b},j=function(a,b,c){for(b++,f.startBlock();b<c;){var d=a[b].charAt(0);if("}"===d){b++;break}" "===d||";"===d?b++:b="@"===d?i(a,b,c,!1):"{"===d?j(a,b,c):k(a,b,c)}return f.endBlock(),b},k=function(a,b,c){var d=b,e=l(a,b,c,!0);if(e<0)return e=~e,b===e?e+1:e;b=e,e>d&&" "===a[e-1]&&e--;var g=a[b];if(b++,"{"!==g)return b;for(f.startRuleSet(a.slice(d,e));b<c&&"}"!==(g=a[b]);)b=" "===g?b+1:m(a,b,c);return f.endRuleSet(),b<c?b+1:b},l=function(a,b,c,f){for(var g,h=[],i=-1;b<c;b++)if(g=a[b].charAt(0),"["===g||"("===g)h[++i]=g;else if(e(h[i],g))i--;else if(d[g]||":"===g&&!f)break;return i>=0&&(b=~(b+1)),b},m=function(a,b,d){var e,g=a[b++];if(!c.test(g))return b+1;if(b<d&&" "===a[b]&&b++,b===d||":"!==a[b]){for(;b<d&&";"!==(e=a[b])&&"}"!==e;)b++;return b}b++,b<d&&" "===a[b]&&b++;var h=b,i=l(a,b,d);if(i<0)i=~i;else{for(var j=[],k=0,m=h;m<i;m++)e=a[m]," "!==e&&(j[k++]=e);if(i<d){do{if(e=a[i],";"===e||"}"===e)break;k=0}while(++i<d);";"===e&&i++}k>0&&f.declaration(g.toLowerCase(),j)}return i},n=function(b,c){c&&f.reset(),f.startRuleSet([]);for(var d=a.tokenize(b),e=0,g=d.length;e<g;)e=" "!==d[e]?m(d,e,g):e+1;return f.getRule()};this.parse=function(a){return g(a),f.getParseTree()},this.parseDeclarations=n}}]),angular.module("services").factory("CSSTree",[function(){"use strict";var a={UNKNOWN_RULE:0,STYLE_RULE:1,CHARSET_RULE:2,IMPORT_RULE:3,MEDIA_RULE:4,FONT_FACE_RULE:5,PAGE_RULE:6,KEYFRAMES_RULE:7,KEYFRAME_RULE:8,MOZ_KEYFRAMES_RULE:7,MOZ_KEYFRAME_RULE:8,WEBKIT_KEYFRAMES_RULE:7,WEBKIT_KEYFRAME_RULE:8,NAMESPACE_RULE:10},b={"@charset":a.CHARSET_RULE,"@import":a.IMPORT_RULE,"@media":a.MEDIA_RULE,"@font-face":a.FONT_FACE_RULE,"@page":a.PAGE_RULE,"@keyframes":a.KEYFRAMES_RULE,"@keyframe":a.KEYFRAME_RULE,"@-moz-keyframes":a.MOZ_KEYFRAMES_RULE,"@-moz-keyframe":a.MOZ_KEYFRAME_RULE,"@-webkit-keyframes":a.WEBKIT_KEYFRAMES_RULE,"@-webkit-keyframe":a.WEBKIT_KEYFRAME_RULE,"@namespace":a.NAMESPACE_RULE},c=window.CSSRule.MOZ_KEYFRAMES_RULE&&"-moz-"||window.CSSRule.WEBKIT_KEYFRAMES_RULE&&"-webkit-"||"",d={};d[a.UNKNOWN_RULE]="",d[a.STYLE_RULE]="",d[a.CHARSET_RULE]="@charset",d[a.IMPORT_RULE]="@import",d[a.MEDIA_RULE]="@media",d[a.FONT_FACE_RULE]="@font-face",d[a.PAGE_RULE]="@page",d[a.KEYFRAMES_RULE]="@"+c+"keyframes",d[a.KEYFRAME_RULE]="@"+c+"keyframe",d[a.NAMESPACE_RULE]="@namespace";var e={};e[a.STYLE_RULE]=!0,e[a.FONT_FACE_RULE]=!0,e[a.PAGE_RULE]=!0,e[a.KEYFRAMES_RULE]=!0,e[a.KEYFRAME_RULE]=!0;var f={};f[a.STYLE_RULE]=!0,f[a.MEDIA_RULE]=!0,f[a.FONT_FACE_RULE]=!0,f[a.PAGE_RULE]=!0,f[a.KEYFRAMES_RULE]=!0,f[a.KEYFRAME_RULE]=!0;var g={",":!0,"=":!0,"!":!0,"/":!0,"(":!0," ":!0},h={",":!0,"=":!0,"/":!0,"(":!0,")":!0," ":!0},i=function(a,b){var c=a.slice(-1),d=b.charAt(0);return g[c]||h[d]?a+b:a+" "+b},j=function(a){return a&&a.parsedCssText},k=function(a){return a&&a.cssText()},l=function(){};l.prototype.cssText=function(){return this.descriptors?this.descriptors.map(k).join("\n"):""};var m=function(b,c,d){this.type=b||a.UNKNOWN_RULE,this.mSelectorText=c||"",this.parsedCssText=d||"",e[b]&&(this.descriptors=this.declarations=[])};m.prototype.STYLE_RULE=a.STYLE_RULE,m.prototype.IMPORT_RULE=a.IMPORT_RULE,m.prototype.MEDIA_RULE=a.MEDIA_RULE,m.prototype.FONT_FACE_RULE=a.FONT_FACE_RULE,m.prototype.selectorText=function(){return this.mSelectorText},m.prototype.setSelector=function(a){this.mSelectorText=a},m.prototype.cssText=function(){return d[this.type]+(this.mSelectorText?" "+this.mSelectorText:"")+(f[this.type]?" { "+(this.descriptors?this.descriptors.map(k).join("; "):"")+" }":";")},m.prototype.replace=function(a){var b=a.cssRules?a.cssRules[0]:a;for(var c in b)n[c]&&(this[c]=b[c])};var n={cssRules:!0,declarations:!0,descriptors:!0,mSelectorText:!0,parsedCssText:!0,type:!0},o=function(a,b){var c=b&&b.reduce(i)||"";this.property=a,this.values=b,this.valueText=c,this.parsedCssText=a+": "+c};return o.prototype.cssText=function(){return this.property&&this.values?this.property+": "+this.values.reduce(i):""},function(){var c,d,e,f=[],g=function(){d||(d=new l),d.cssRules||(d.descriptors=d.cssRules=[]),
d.cssRules.push(e),e=null};this.Declaration=o,this.startStylesheet=function(){d=new l},this.endStylesheet=function(){c=d,d=null},this.startRuleSet=function(b){e||(e=new m(a.STYLE_RULE,b.join("")))},this.endRuleSet=function(){var a=e.declarations.map(j).join("; ");e.parsedCssText+=e.mSelectorText+" { "+a+" }",g()},this.startAtRule=function(a,c){var d=c.join("");e=new m(b[a],d,a+" ")},this.endAtRule=function(){if(e){e.parsedCssText+=e.mSelectorText;var a=e.cssRules&&e.cssRules.map(j).join("\n");a&&(e.parsedCssText+=" { "+a+" }"),g()}},this.startBlock=function(){f.push(d),d=e,e=null},this.endBlock=function(){e=d,d=f.pop()},this.declaration=function(a,b){e.declarations||(e.descriptors=e.declarations=[]),e.declarations.push(new o(a,b))},this.getParseTree=function(){return c},this.getRule=function(){return e},this.reset=function(){c=null,d=null,e=null}}}]),angular.module("services").service("FontStyle",["CONFIG","$log","$q","$rootScope","URLManager","FileUtil",function(a,b,c,d,e,f){"use strict";var g={"font-family":[],"font-style":["normal","italic","oblique"],"font-weight":["normal","bold","100","200","300","400","500","600","700","800","900"],"font-stretch":["normal","ultra-condensed","extra-condensed","condensed","semi-condensed","semi-expanded","expanded","extra-expanded","ultra-expanded"]},h={Regular:"normal",Reg:"normal",Rg:"normal",Book:"normal",Roman:"normal",Light:"light",Lt:"light",Thin:"thin",Hairline:"thin",Medium:"medium",Med:"medium",Semibold:"semibold",Smbd:"semibold",Demibold:"semibold",Bold:"bold",Bld:"bold",Bd:"bold",Black:"black",Blk:"black",Heavy:"black",Extralight:"extralight",Ultralight:"extralight",Extrabold:"extrabold",Ultrabold:"extrabold",Ultra:"extrabold"},i={Italic:"italic",Ital:"italic",It:"italic",Cursive:"italic",Oblique:"oblique",Obl:"oblique"},j={thin:100,extralight:200,light:300,normal:400,medium:500,semibold:600,bold:700,extrabold:800,black:900},k=/Regular|Book|Roman|Light|Thin|Hairline|Medium|Semibold|Demibold|Bold|Black|Heavy|Extralight|Ultralight|Extrabold|Ultrabold/i,l=/Italic|Oblique|Cursive/i,m=Object.keys(h).join("|"),n=Object.keys(i).join("|"),o=new RegExp("^(.+?)[-_ ]?("+m+")?[-_ ]?("+n+")?$"),p=new RegExp("^(.+)[-_ ]("+m+")?[-_ ]?("+n+")?$","i"),q=/^['"]|['"]$/g,r=/url\(["']?(\S*[^"'])["']?\)/i,s=a.globals.MIME_TYPES,t=function(b){var c=a.globals.READER.PUBLICATION_FONTS_ID,d=document.getElementById(c),e=document.querySelector("head");return d||!e||b||(d=document.createElement("style"),d.type="text/css",d.id=c,e.appendChild(d)),d},u=function(a){return a.type===Object.getPrototypeOf(a).FONT_FACE_RULE},v=function(a,c){if(!c)return!1;try{var d=a.cssText(),e=c.sheet.cssRules?c.sheet.cssRules.length:0;return c.sheet.insertRule(d,e),!0}catch(a){return b.warn("Error adding publication font: "+a.message),!1}},w=function(a,b){var c=r.exec(a);if(c){var d=e.getKeyForURL(c[1]),f=b[d];f&&f.releaseContent()}},x=function(a,b){for(var c,d=b&&b.sheet.cssRules||[],e=a.descriptors,f=e.length,h=function(a){return!g[a.property]||a.valueText===c.getPropertyValue(a.property)},i=0,j=d.length;i<j;i++)if(c=d[i].style,c.length===f&&e.every(h))return!0;return!1},y=function(a){var c=a.descriptors||[];c.forEach(function(c){var d,e=c.property,f=g[e],h=c.values;if(f){var i=h.length;if(i>1){for(var j=0;j<i&&(d=h[j].toLowerCase(),!(f.indexOf(d)>=0));j++);h[0]=d,h.length=1}if(f.length>0&&(/[A-Z]/.test(h[0])&&(h[0]=h[0].toLowerCase()),f.indexOf(h[0])<0&&b.warn("Invalid property value '"+c.parsedCssText+"' in rule '"+a.parsedCssText+"'")),"font-family"===e){var k=c.valueText;if(q.test(k)){var l=k.indexOf(" ")<0?"":"'";h[0]=k.replace(q,l)}}}})},z=function(a,b){if(!a||"src"!==a.property)return null;for(var c=a.values||[],d=0,e=c.length;d<e;d++){var g=r.exec(c[d]);if(g){var h=g[1].split(".").pop().toLowerCase();if(s[h])return f.resolveRelativePath(g[1],b)}}return null},A=function(a){return"src"===a.property},B=function(a){var b=a.split(".").pop().toLowerCase(),c=a.slice(0,-b.length-1),d=o.exec(c);d||(d=p.exec(c)||[]);var e=h[d[2]]||d[2]||"normal",f=i[d[3]]||d[3]||"normal";return{family:d[1]||c,weight:e,weightNum:j[e],style:f}};this.removePublicationFonts=function(a){for(var b=t(!0),c=b&&b.sheet.cssRules||[],d=c.length-1;d>=0;d--){var e=c[d].style;window.Modernizr.ios&&w(e.src,a),b.sheet.deleteRule(d)}},this.embedCSSFonts=function(b,d){var f=d&&d.files||{},g=d&&d.root||"",h=b.cssRules||[],i=[],j=a.globals.FONT.MAX_FILESIZE,k=0,l=h.filter(u);if(l.forEach(y,this),l.length>0){var m=t();l.forEach(function(a){var b=a.declarations||[];if(x(a,m)){var d=b.filter(A)[0],h=z(d,g),l=h&&f[h];return void(l&&(k+=l.getUncompressedSize()))}b.forEach(function(b){var d=z(b,g),h=d&&f[d];if(h){var l=h.getUncompressedSize();if(l>j||window.Modernizr.isandroidbrowser||window.Modernizr.ios&&k+l>j)return void console.warn('Embedding font "%s": size %s exceeds allowed maximum',d,l);var n=d.split(".").pop().toLowerCase(),o=s[n],p=c.defer();h.extract().then(function(c){b.values[0]="url("+e.createURL(d,c,o)+")",v(a,m)&&(k+=l),p.resolve()}),i.push(p.promise)}})})}return c.all(i).then(function(){return b})},this.getFontInfo=B,this.isRegularStyle=function(a,b){if(a){var c=k.exec(a),d=l.exec(a);if(c||d)return c&&"normal"===h[c[0]]&&!d}var e=B(b);return"normal"===e.weight&&"normal"===e.style},this.getFontWeight=function(a,b){var c=k.exec(a);return c&&h[c[0]]||B(b).weight},this.getFontWeightNum=function(a,b){var c=k.exec(a),d=c&&h[c[0]];return j[d]||B(b).weightNum},this.getFontStyle=function(a,b){var c=l.exec(a);return c&&i[c[0]]||B(b).style}}]),angular.module("services").service("HTML",["$window","CONFIG","$http","$q","$rootScope","$translate","URLManager","CSSParser","FileUtil","BaseUtil","image",function(a,b,c,d,e,f,g,h,i,j,k){"use strict";var l=/https?:\/\/|mailto:/i,m=/data:([^;,]*?)(;charset\=[^;,]+)?(;base64)?,(.*)$/,n=/^blob:http/,o=/^\s*$/,p=/(font\s*:[^;$]+;?)/gi,q=/\b(window.location(.href|\b)|location.href)\s*=\s*([^;$]*)/g,r=/\$\(location\).attr\(\s*["']href["']\s*,\s*([^)]*)\)/g,s=b.globals.MIME_TYPES,t="_discardedStyle",u="_originalNode",v=function(a){return"svg"!==a.nodeName.toLowerCase()&&a.parentNode?v(a.parentNode):a},w=function(a,b,c){a.getAttribute("xlink:href")&&(v(a).removeAttribute("viewBox"),a.setAttribute("width",b+"px"),a.setAttribute("height",c+"px")),a.style.width=b+"px !important",a.style.height=c+"px !important"},x=function(a,b,c){for(var d,e=b&&c-b<10;a&&a.nodeType===Node.ELEMENT_NODE;)e&&(y(a,"padding-top",0,"important"),y(a,"padding-bottom",0,"important"),y(a,"margin-top",0,"important"),y(a,"margin-bottom",0,"important")),d=a.textContent||a.innerText||"",o.test(d)&&y(a,"line-height","0px","important"),a=a.parentNode},y=function(a,b,c,d){var e=b+":"+c+(d?" !"+d+"; ":"; "),f=a.style.cssText,g=f.trim().substr(-1);f.length>0&&";"!==g&&(e="; "+e),a.style.cssText+=e},z=function(a){a.setAttribute("data-width",a.naturalWidth),a.setAttribute("data-height",a.naturalHeight);var c=a.style;c.backgroundImage="url("+a.src+")",c.backgroundRepeat="no-repeat",c.backgroundSize="contain",c.backgroundPosition="50% 50%",a.setAttribute("src",b.globals.MEDIA.IMAGE_NULL)},A=function(a,b,c){var d=i.resolveRelativePath(a,c);if(!d||!b)return null;if(d in b)return d;for(var e in b)if(e.endsWith(d))return e;return null},B=function(a,b,c){if(/^data:/.test(a))return d.resolve(a);var e=A(a,b.files,b.root),f=b&&b.deliverableId||"",h=e&&e.split(".").pop().toLowerCase(),i=s[h],j=b.files[e];return j?j.extract().then(function(a){return g.fetchURL(f+e,a,i).then(function(a){return a||(console.warn('fetchURL failed: loading "'+e+'" as data URL'),a="data:"+i+";base64,"+j.getFileContentAsBase64()),j.releaseContent(),a})}):(console.warn('HTML.getMediaURL: File "'+e+'" not found for src "'+a+'"'),c&&w(c,150,100),d.resolve(null))},C=function(a,b,c){return a=a.replace(/\bconst\b/g,"var"),a=a.replace(q,"angular.element(document).injector().get('HTML').jumpToHRef($3,\""+b+'")'),a=a.replace(r,"angular.element(document).injector().get('HTML').jumpToHRef($1,\""+b+'")'),"scripts/tigerbooks.model.js"===c?(a=a.replace(/\$sceneRootDiv = getSceneRootDiv\(\);/,"$sceneRootDiv = $(document.querySelector('body > div'));"),a=a.replace(/if \(typeof animation.sound \!\=\= \'undefined\' \&\& animation\.sound \!\=\= \'\'\) \{(.|\n)+?var soundId \= animation\.sound\;/,"if (animation.sound) {\nvar soundId = typeof animation.sound === 'object' ? animation.sound.id : animation.sound;")):"scripts/engine.js"===c&&(a=a.replace(/(function urlForSoundWithID\(id\) \{)/,"$1\nif (typeof id === 'object') { id = id.id; }")),console.groupCollapsed&&console.groupEnd&&!Modernizr.isfirefox&&(console.groupCollapsed(c),console.log("%c%s","color: #69f",a),console.groupEnd(c)),a},D=function(a,b){var e,f,g=d.defer(),h=A(a,b.files,b.root),i=b.files[h];return/soundmanager[^\/]*\.js$/i.test(a)?(h=j.getLocationURL("assets/common/js/soundmanager.js"),c.get(h,{responseType:"text"}).then(function(a){g.resolve(a.data)})):i?i.extract().then(function(){f=i.getFileContentAsString(),g.resolve(C(f,b.root,a))}):(e=a.match(m))&&/\/(x-)?javascript$/.test(e[1])?(f=e[3]?window.atob(e[4]):decodeURIComponent(e[4]),g.resolve(C(f,b.root,"script"))):(console.warn('HTML.getScriptContent: File "'+h+'" not found'),g.resolve("")),g.promise},E=function(a){for(var b,c,d=(new h).parseDeclarations(a),e=d&&d.declarations[0].values,f=function(a,b,d){a.test(d)&&(c+=" "+b+": "+d+";")},g=e.length-1;g>=0&&(b=e[g],isNaN(parseFloat(b))&&!/^(xx-small|x-small|small|medium|large|x-large|xx-large|smaller|larger)$/i.test(b));g--);for(c="font-family: "+e.slice(g+1).join(", ")+";",g>1&&"/"===e[g-1]?(c+=" font-size: "+e[g-2]+"; line-height: "+e[g]+";",g-=3):(c+=" font-size: "+(e[g]||"100%")+";",g--);g>=0;g--)b=e[g],f(/^(bold|bolder|lighter|\d00)$/i,"font-weight",b),f(/^(normal|small-caps)$/i,"font-variant",b),f(/^(italic|oblique)$/i,"font-style",b),f(/(condensed|expanded)$/i,"font-stretch",b);return c},F={},G=function(a,b){if(a&&b){if(b in F)return F[b];var c=document.createElement(a.nodeName);if("function"==typeof c.canPlayType)return F[b]=c.canPlayType(b)}return!1},H=function(a,b){for(var c,d,e,f=Array.prototype.slice.call(a.querySelectorAll("source")),g=function(c,d){return G(a,d)&&(b||!l.test(c))},h=0,i=f.length;h<i;h++)if(c=f[h],d=c.getAttribute("src"),e=c.getAttribute("type"),g(d,e))return f.splice(h,1),I(f),c;if(I(f),d=a.getAttribute("data-src")||a.getAttribute("src")){var j=d.split(".").pop().toLowerCase();return"IMG"===a.nodeName&&/^image/.test(s[j])||g(d,s[j])?a:null}},I=function(a){Array.prototype.forEach.call(a,function(a){a.removeAttribute("src")})},J=function(a,b){var c,d,e;"VIDEO"===this.nodeName&&(a||(b?(a=k.getFallbackImage("video"),c=f.instant(gettext("VIDEO_START")),d="vc"+Math.round(1e6*Math.random()),this.setAttribute("data-caption-id",d)):(a=k.getFallbackImage("video_unsupported"),c=f.instant(gettext("VIDEO_UNSUPPORTED"))),e=K(c,d,"media-caption"),this.parentNode.insertBefore(e,this.nextSibling)),this.setAttribute("poster",a))},K=function(a,b,c){var d=document.createElement("div");return d.appendChild(document.createTextNode(a)),d.setAttribute("class",c),b&&d.setAttribute("id",b),d},L=function(a){var b=this.getAttribute("data-caption-id"),c=b&&document.getElementById(b);c&&j.setClass(c,"hidden","play"===a.type)},M=function(a){var b=a.querySelector("audio[autoplay]");if(b){var c=a.querySelector("head")||a,d=document.createElement("script");d.setAttribute("type","text/javascript"),d.appendChild(document.createTextNode('window.addEventListener("DOMContentLoaded", function() { [].forEach.call(document.querySelectorAll("audio[autoplay]"), function(a) { setTimeout(function() { a.play(); }, 1000); }); }, false);')),c.appendChild(d)}},N=function(){O(this.getAttribute("data-href"))},O=function(a,b){var c=P(a);if("external"===c)e.$emit("tw.reader.openURL",a);else if("internal"===c){b&&(a=i.resolveRelativePath(a,b));var d=a.split("#");e.$broadcast("tw.toc.navigateToPosition",{src:d[0],srcAnchor:d[1]})}},P=function(a){return l.test(a)?"external":a?"internal":null},Q=function(a,b,c){var d=new RegExp("(^|;|\\s)"+b+"\\s*:[^;$]+[;$]","ig"),e=a&&a.querySelectorAll("[style]")||[];Array.prototype.forEach.call(e,function(a){var e="IMG"!==a.nodeName?a.getAttribute("style"):null;if(d.test(e)){if(c){var f=e.match(d);c(a,b,f&&f[0])}e=e.replace(d,"$1"),e?a.setAttribute("style",e):a.removeAttribute("style")}})},R=function(a,b,c){if(a&&c){var d=a[t];d||(d=a[t]=[]);var e=d.findIndex(function(a){return a.startsWith(b)});e>=0?d[e]=c:(d.push(c),a.setAttribute(t,""))}};this.getSupportedMediaSource=H,this.getMediaURL=B,this.getScriptContent=D,this.jumpToHRef=O,this.setLangAttribute=function(a,b){var c=a.documentElement;return c&&b.language&&(c.hasAttribute("lang")||c.setAttribute("lang",b.language),c.hasAttribute("xmlns")&&!c.hasAttribute("xml:lang")&&c.setAttribute("xml:lang",b.language)),d.resolve(a)},this.preprocessLinks=function(a,b){var c=b&&b.root||"",e=a.querySelectorAll("a");return Array.prototype.forEach.call(e,function(a){var b=a.getAttribute("href");if(b){var d=P(b);"internal"===d?b=i.resolveRelativePath(b,c):"external"===d&&a.setAttribute("title",b),a.setAttribute("class","tw-link-"+d),a.setAttribute("data-href",b),a.removeAttribute("href"),a.addEventListener("click",N)}}),d.resolve(a)},this.convertSVGImages=function(a){if(!document.createElementNS||!document.createElementNS("http://www.w3.org/2000/svg","svg").createSVGRect||window.Modernizr.androidbelowv44){var b=a.querySelectorAll("svg");Array.prototype.forEach.call(b,function(a){var b=a.querySelector("image");if(b){var c=document.createElement("img");c.setAttribute("src",b.getAttribute("xlink:href")),a.parentNode.replaceChild(c,a)}})}return d.resolve(a)},this.embedImages=function(a,c){var e=[],f=a.querySelectorAll("img, image");return Array.prototype.forEach.call(f,function(a){var d=a.getAttribute("xlink:href"),f=a.getAttribute("data-src"),g=d||f||a.getAttribute("src");f||a.setAttribute("data-src",g),a.removeAttribute("height"),a.removeAttribute("width"),e.push(B(g,c,a).then(function(c){var e=d?"xlink:href":"src";a.setAttribute(e,c||b.globals.MEDIA.IMAGE_PLACEHOLDER)}))}),d.all(e).then(function(){return a})},this.preprocessImages=function(a,b){var c=b&&b.maxHeight||300,e=d.defer(),f=1,g=function(b){var d=this;if(!b||"error"!==b.type){var g=parseFloat(d.style.height,10)||d.naturalHeight;x(d,g,c),z(d)}d.onload=d.onerror=null;var h=d[u];h&&(h.parentNode.replaceChild(d,h),d[u]=null),--f<=0&&e.resolve(a)},h=a.querySelectorAll("svg");Array.prototype.forEach.call(h,function(a){var b=a.style.height||a.getAttribute("height")||a.style["max-height"];b=void 0===b||b.indexOf("100%")>=0?c:parseInt(b,10),x(a,b,c)});var i=a.querySelectorAll("img");return Array.prototype.forEach.call(i,function(a){if("[object SVGImageElement]"!==a.toString())if(f++,a.naturalHeight)g.call(a);else if(n.test(a.getAttribute("src"))){var b=new Image;b[u]=a,b.onload=b.onerror=g,Array.prototype.forEach.call(a.attributes,function(a){b.setAttribute(a.name,a.value)})}else a.onload=a.onerror=g}),--f<=0?d.resolve(a):e.promise},this.preprocessAudioVideo=function(a,b){var c=[],e=a.querySelectorAll("audio, video");return Array.prototype.forEach.call(e,function(a){if(window.Modernizr.androidchromebelowv5)return console.warn("No support for playback from object URL - removing node",a),void a.parentNode.removeChild(a);var d=H(a),e=d&&d.getAttribute("src");if(e){var f=function(c){a.removeEventListener("error",f,!1),a.removeEventListener("load",f,!1),c&&("error"===c.type||/error/i.test(c.name))&&B(e,b).then(function(b){a.setAttribute("src",b),a[c.type?"load":"play"].call(a)})},g=function(a){if(this.paused){var b=this.play();b&&"function"==typeof b.then&&b.then(f,f)}else this.pause();a.preventDefault()};a.setAttribute("data-src",e),a.addEventListener("error",f,!1),a.addEventListener("load",f,!1);var h=a.getAttribute("poster");h?c.push(B(h,b).then(J.bind(a))):J.call(a,null,!0),a.addEventListener("click",g,!1),a.addEventListener("play",L,!1),a.addEventListener("pause",L,!1),"ibooks:soundtrack"===a.getAttribute("epub:type")&&(a.setAttribute("autoplay",""),a.setAttribute("loop","")),a.innerHTML=""}else J.call(a,null,!1),a.removeAttribute("controls");var i=a.getAttribute("width"),j=a.getAttribute("height");i&&j&&(a.style?(a.style.width=i+"px",a.style.height=j+"px"):a.setAttribute("style","width: "+i+"px; height: "+j+"px;"))}),d.all(c).then(function(){return M(a),a})},this.processFontStyles=function(a){var b=a.querySelectorAll("[style]");return Array.prototype.forEach.call(b,function(a){var b=a.getAttribute("style");b.match(p)&&(b=b.replace(p,E),a.setAttribute("style",b))}),d.resolve(a)},this.removeFontFamilyStyles=function(a){return Q(a,"font-family"),d.resolve(a)},this.removeTextAlignStyles=function(a){return Q(a,"text-align"),d.resolve(a)},this.removeColorStyles=function(a){return Q(a,"color"),d.resolve(a)},this.removeLineHeightStyles=function(a){return Q(a,"line-height"),d.resolve(a)},this.discardStyleProperty=function(a,b){Q(a,b,R)},this.restoreStyleProperty=function(a){var c=new RegExp(a+"\\s*:\\s*([^;$!]+)[;$!](important)?"),d=document.querySelectorAll("#"+b.globals.READER.CONTAINER_ID+" ["+t+"]");Array.prototype.forEach.call(d,function(b){for(var d,e=b[t]||[],f=e.length-1;f>=0;f--)(d=c.exec(e[f]))&&(b.style.setProperty(a,d[1],d[2]),e.splice(f,1));0===e.length&&b.removeAttribute(t)})},this.embedScripts=function(a,b){var c=[],e=a.querySelectorAll("script[src]");return Array.prototype.forEach.call(e,function(a){var d=a.getAttribute("src");d&&c.push(D(d,b).then(function(b){b&&(a.removeAttribute("src"),a.appendChild(document.createTextNode(b)))}))}),d.all(c).then(function(){return a})}}]),angular.module("services").factory("mockConfig",[function(){"use strict";var a={555:{BOOKSHELF_URL:"https://bosh.prodref.pageplace.de/bosh/rest/",URL_BOOKSHELF:"https://bosh.prodref.pageplace.de/bosh/rest/",URL_DEVICE_MANAGEMENT:"https://mein.prodref.pageplace.de/telekom/handshake/index.html",URL_HANDSHAKE:"https://mein.prodref.pageplace.de/telekom/handshake/index.html"},3:{STRING_BRAND_NAME:"Thalia.de WebReader -- PRODREF",UICOLOR_NORMAL_STATE:"#00a02f",DEFAULT_LANGUAGE:"de_DE",URL_CONTACT:"https://integration.buch.de/de.buch.shop/shop/2/home/kontakt/",URL_DATA_PRIVACY:"https://integration.buch.de/de.buch.shop/shop/2/hilfe-datenschutz/show/",URL_HELP:"https://integration.buch.de/de.buch.shop/shop/2/hilfe/show/",URL_IMPRINT_DOCUMENT:"https://integration.buch.de/de.buch.shop/shop/2/hilfe-impressum/show/",URL_TERMS_AND_CONDITIONS:"https://integration.buch.de/de.buch.shop/shop/2/hilfe-agb/show/",URL_SHOP_RECOMMENDATIONS_BASE:"https://www.thalia.de/",OAUTH_CLIENT_ID:"webshop01",OAUTH_SCOPE:"SCOPE_BOSH SCOPE_BUCHDE",OAUTH_TOKEN_DEMO_USER:"RSzBnemI5ZG9oc1RSOWtlVVhicGlrRG9wSlpoSDZWWjl0eUNXdTJwUUswZ3piOWRvaHNUUjlrZVVYYnBpa0RvcEpaaEg2Vlo5dH",OAUTH_X_SKIN_KEY:"x_buchde.skin_id",OAUTH_X_SKIN_VALUE:"17",OAUTH_X_MANDANT_KEY:"x_buchde.mandant_id",OAUTH_X_MANDANT_VALUE:"2",URL_OAUTH_SESSIONKILLER:"https://integration.buch.de/auth/oauth2/logout",URL_OAUTH_ACCESSTOKEN:"https://integration.buch.de/auth/oauth2/token",URL_OAUTH_AUTHORIZATION:"https://integration.buch.de/auth/oauth2/authorize",URL_OAUTH_REDIRECT:"https://thaliade.prodref.pageplace.de/library/index.html",URL_OAUTH_REVOKETOKEN:"https://integration.buch.de/auth/oauth2/revoke",URL_SHOP_BASE:"https://integration.buch.de/de.buch.shop/shop/2/home/show/",URL_SHOP_BASE_SEARCH:"https://integration.buch.de/de.buch.shop/shop/2/ebooks/suche/?sq=",URL_SHOP_EBOOK_START_PAGE:"https://integration.buch.de/de.buch.shop/shop/2/ebooks/show/",URL_SHOP_EBOOK_SEARCH:"https://integration.buch.de/de.buch.shop/shop/2/ebooks/suche/?sswg=EBOOK&sq=",URL_SHOP_AUDIO_START_PAGE:"https://integration.buch.de/de.buch.shop/shop/2/hoerbuecher/show/",URL_SHOP_AUDIO_SEARCH:"https://integration.buch.de/de.buch.shop/shop/2/home/suche/?sswg=HOERBUCH&sq="},4:{STRING_BRAND_NAME:"Thalia.at WebReader -- PRODREF",UICOLOR_NORMAL_STATE:"#00a02f",DEFAULT_LANGUAGE:"de_AT",URL_CONTACT:"https://integration.buch.de/de.buch.shop/shop/4/home/kontakt/",URL_DATA_PRIVACY:"https://integration.buch.de/de.buch.shop/shop/4/hilfe-datenschutz/show/",URL_HELP:"https://integration.buch.de/de.buch.shop/shop/4/hilfe/show/",URL_IMPRINT_DOCUMENT:"https://integration.buch.de/de.buch.shop/shop/4/hilfe-impressum/show/",URL_TERMS_AND_CONDITIONS:"https://integration.buch.de/de.buch.shop/shop/4/hilfe-agb/show/",URL_SHOP_RECOMMENDATIONS_BASE:"https://www.thalia.at/",OAUTH_CLIENT_ID:"webshop01",OAUTH_SCOPE:"SCOPE_BOSH SCOPE_BUCHDE",OAUTH_TOKEN_DEMO_USER:"lDV3UycFFLMGd6Yjlkb2hzVFI5a2VVWGJwaWtEb3BKWmhINlZaOXR5Q1d1MnBRSzBnemI5ZG9oc1RSOWtlVVhicGlrRG9wSlpoS",OAUTH_X_SKIN_KEY:"x_buchde.skin_id",OAUTH_X_SKIN_VALUE:"17",OAUTH_X_MANDANT_KEY:"x_buchde.mandant_id",OAUTH_X_MANDANT_VALUE:"4",URL_OAUTH_SESSIONKILLER:"https://integration.buch.de/auth/oauth2/logout",URL_OAUTH_ACCESSTOKEN:"https://integration.buch.de/auth/oauth2/token",URL_OAUTH_AUTHORIZATION:"https://integration.buch.de/auth/oauth2/authorize",URL_OAUTH_REDIRECT:"https://thaliaat.prodref.pageplace.de/library/index.html",URL_OAUTH_REVOKETOKEN:"https://integration.buch.de/auth/oauth2/revoke",URL_SHOP_BASE:"https://integration.buch.de/de.buch.shop/shop/4/home/show/",URL_SHOP_BASE_SEARCH:"https://integration.buch.de/de.buch.shop/shop/4/ebooks/suche/?sq=",URL_SHOP_EBOOK_START_PAGE:"https://integration.buch.de/de.buch.shop/shop/4/ebooks/show/",URL_SHOP_EBOOK_SEARCH:"https://integration.buch.de/de.buch.shop/shop/4/ebooks/suche/?sswg=EBOOK&sq=",URL_SHOP_AUDIO_START_PAGE:"https://integration.buch.de/de.buch.shop/shop/4/hoerbuecher/show/",URL_SHOP_AUDIO_SEARCH:"https://integration.buch.de/de.buch.shop/shop/4/home/suche/?sswg=HOERBUCH&sq="},5:{STRING_BRAND_NAME:"Thalia.ch WebReader -- PRODREF",UICOLOR_NORMAL_STATE:"#00a02f",DEFAULT_LANGUAGE:"de_CH",URL_CONTACT:"https://integration.buch.de/de.buch.shop/shop/23/home/kontakt/",URL_DATA_PRIVACY:"https://integration.buch.de/de.buch.shop/shop/23/hilfe-datenschutz/show/",URL_HELP:"https://integration.buch.de/de.buch.shop/shop/23/hilfe/show/",URL_IMPRINT_DOCUMENT:"https://integration.buch.de/de.buch.shop/shop/23/hilfe-impressum/show/",URL_TERMS_AND_CONDITIONS:"https://integration.buch.de/de.buch.shop/shop/23/hilfe-agb/show/",URL_SHOP_RECOMMENDATIONS_BASE:"https://www.thalia.ch/",OAUTH_CLIENT_ID:"webshop01",OAUTH_SCOPE:"SCOPE_BOSH SCOPE_BUCHDE",OAUTH_TOKEN_DEMO_USER:"DZWWjl0eUNXdTJwUUswZ3piOWRvaHNUUjlrZVVYYnBpa0RvcEpaaEg2Vlo5dHlDV3UycFFLMGd6Yjlkb2hzVFI5a2VVWGJwaWtE",OAUTH_X_SKIN_KEY:"x_buchde.skin_id",OAUTH_X_SKIN_VALUE:"17",OAUTH_X_MANDANT_KEY:"x_buchde.mandant_id",OAUTH_X_MANDANT_VALUE:"23",URL_OAUTH_SESSIONKILLER:"https://integration.buch.de/auth/oauth2/logout",URL_OAUTH_ACCESSTOKEN:"https://integration.buch.de/auth/oauth2/token",URL_OAUTH_AUTHORIZATION:"https://integration.buch.de/auth/oauth2/authorize",URL_OAUTH_REDIRECT:"https://thaliach.prodref.pageplace.de/library/index.html",URL_OAUTH_REVOKETOKEN:"https://integration.buch.de/auth/oauth2/revoke",URL_SHOP_BASE:"https://integration.buch.de/de.buch.shop/shop/23/home/show/",URL_SHOP_BASE_SEARCH:"https://integration.buch.de/de.buch.shop/shop/23/ebooks/suche/?sq=",URL_SHOP_EBOOK_START_PAGE:"https://integration.buch.de/de.buch.shop/shop/23/ebooks/show/",URL_SHOP_EBOOK_SEARCH:"https://integration.buch.de/de.buch.shop/shop/23/ebooks/suche/?sswg=EBOOK&sq=",URL_SHOP_AUDIO_START_PAGE:"https://integration.buch.de/de.buch.shop/shop/23/hoerbuecher/show/",URL_SHOP_AUDIO_SEARCH:"https://integration.buch.de/de.buch.shop/shop/23/home/suche/?sswg=HOERBUCH&sq="},6:{STRING_BRAND_NAME:"buch.de WebReader -- PRODREF",UICOLOR_NORMAL_STATE:"#ff6600",DEFAULT_LANGUAGE:"de_DE",URL_CONTACT:"https://integration.buch.de/de.buch.shop/shop/1/home/kontakt/",URL_DATA_PRIVACY:"https://integration.buch.de/de.buch.shop/shop/1/hilfe-datenschutz/show/",URL_HELP:"https://integration.buch.de/de.buch.shop/shop/1/hilfe/show/",URL_IMPRINT_DOCUMENT:"https://integration.buch.de/de.buch.shop/shop/1/hilfe-impressum/show/",URL_TERMS_AND_CONDITIONS:"https://integration.buch.de/de.buch.shop/shop/1/hilfe-agb/show/",URL_SHOP_RECOMMENDATIONS_BASE:"https://www.buch.de/",OAUTH_CLIENT_ID:"webshop01",OAUTH_SCOPE:"SCOPE_BOSH SCOPE_BUCHDE",OAUTH_TOKEN_DEMO_USER:"eyJzaXRlIjoiIiwicHJmIjoiZGVtbyIsImF1ZCI6InRyZWFkZXJhcHAwMSIsImlzcyI6ImJ1Y2guZGUiLCJwcm4iOiJEZW1vX2J1Y2hkZSJ9",OAUTH_X_SKIN_KEY:"x_buchde.skin_id",OAUTH_X_SKIN_VALUE:"17",OAUTH_X_MANDANT_KEY:"x_buchde.mandant_id",OAUTH_X_MANDANT_VALUE:"1",URL_OAUTH_SESSIONKILLER:"https://integration.buch.de/auth/oauth2/logout",URL_OAUTH_ACCESSTOKEN:"https://integration.buch.de/auth/oauth2/token",URL_OAUTH_AUTHORIZATION:"https://integration.buch.de/auth/oauth2/authorize",URL_OAUTH_REDIRECT:"https://buchde.prodref.pageplace.de/library/index.html",URL_OAUTH_REVOKETOKEN:"https://integration.buch.de/auth/oauth2/revoke",URL_SHOP_BASE:"https://integration.buch.de/de.buch.shop/shop/1/home/show/",URL_SHOP_BASE_SEARCH:"https://integration.buch.de/de.buch.shop/shop/1/ebooks/suche/?sq=",URL_SHOP_EBOOK_START_PAGE:"https://integration.buch.de/de.buch.shop/shop/1/ebooks/show/",URL_SHOP_EBOOK_SEARCH:"https://integration.buch.de/de.buch.shop/shop/1/ebooks/suche/?sswg=EBOOK&sq=",URL_SHOP_AUDIO_START_PAGE:"https://integration.buch.de/de.buch.shop/shop/1/hoerbuecher/show/",URL_SHOP_AUDIO_SEARCH:"https://integration.buch.de/de.buch.shop/shop/1/home/suche/?sswg=HOERBUCH&sq="},7:{STRING_BRAND_NAME:"buch.ch WebReader",UICOLOR_NORMAL_STATE:"#ff6600",DEFAULT_LANGUAGE:"de_CH",URL_CONTACT:"https://www.buch.ch/shop/bch_start_startseite/kontakt/",URL_DATA_PRIVACY:"https://www.buch.ch/shop/datenschutz/show/",URL_HELP:"https://www.buch.ch/de.buch.shop/shop/21/bch_hilfe_center/show/",URL_IMPRINT_DOCUMENT:"https://www.buch.ch/de.buch.shop/shop/21/bch_hilfe_center_impressum/show/",URL_TERMS_AND_CONDITIONS:"https://www.buch.ch/de.buch.shop/shop/21/bch_hilfe_center_agb/show/",URL_SHOP_RECOMMENDATIONS_BASE:"https://www.buch.ch/",OAUTH_CLIENT_ID:"webshop01",OAUTH_SCOPE:"SCOPE_BOSH SCOPE_BUCHDE",OAUTH_TOKEN_DEMO_USER:"eyJzaXRlIjoiIiwicHJmIjoiZGVtbyIsImF1ZCI6InRyZWFkZXJhcHAwMSIsImlzcyI6ImJ1Y2guY2giLCJwcm4iOiJEZW1vX2J1Y2hjaCJ9",OAUTH_X_SKIN_KEY:"x_buchde.skin_id",OAUTH_X_SKIN_VALUE:"17",OAUTH_X_MANDANT_KEY:"x_buchde.mandant_id",OAUTH_X_MANDANT_VALUE:"21",URL_OAUTH_SESSIONKILLER:"https://ssl.buch.de/de.buch.appservices/api/21003/oauth2/logout",URL_OAUTH_ACCESSTOKEN:"https://ssl.buch.de/de.buch.appservices/api/21003/oauth2/token",URL_OAUTH_AUTHORIZATION:"https://auth.buch.de/auth/oauth2/authorize",URL_OAUTH_REDIRECT:"https://html5reader.buch.ch/library/index.html",URL_OAUTH_REVOKETOKEN:"https://ssl.buch.de/de.buch.appservices/api/21003/oauth2/revoke",URL_SHOP_BASE:"https://www.we-love-ebooks.com/ebooks/shop/start.jsp?oid=3&lb_m=21003",URL_SHOP_AUDIO_START_PAGE:"https://www.buch.ch/shop/hoerbuch-downloads/show/"},8:{STRING_BRAND_NAME:"books.ch WebReader -- PRODREF",UICOLOR_NORMAL_STATE:"#a62c2f",DEFAULT_LANGUAGE:"de_CH",URL_CONTACT:"https://integration.buch.de/de.buch.shop/shop/37/home/kontakt/",URL_DATA_PRIVACY:"https://integration.buch.de/de.buch.shop/shop/37/hilfe-datenschutz/show/",URL_HELP:"https://integration.buch.de/de.buch.shop/shop/37/hilfe/show/",URL_IMPRINT_DOCUMENT:"https://integration.buch.de/de.buch.shop/shop/37/hilfe-impressum/show/",URL_TERMS_AND_CONDITIONS:"https://integration.buch.de/de.buch.shop/shop/37/hilfe-agb/show/",URL_SHOP_RECOMMENDATIONS_BASE:"https://www.books.ch/",OAUTH_CLIENT_ID:"webshop01",OAUTH_SCOPE:"SCOPE_BOSH SCOPE_BUCHDE",OAUTH_TOKEN_DEMO_USER:"SmhZeEw0Uk10cUpoWXhMNFJNdHFKaFl4TDRSTXRxSmhZeEw0UnNmSmhZeEw0Uk10cUpoWXhMNFJNdHFKaFl4TDRSTXRxSmhZeEw0UnNm",OAUTH_X_SKIN_KEY:"x_buchde.skin_id",OAUTH_X_SKIN_VALUE:"17",OAUTH_X_MANDANT_KEY:"x_buchde.mandant_id",OAUTH_X_MANDANT_VALUE:"37",URL_OAUTH_SESSIONKILLER:"https://integration.buch.de/auth/oauth2/logout",URL_OAUTH_ACCESSTOKEN:"https://integration.buch.de/auth/oauth2/token",URL_OAUTH_AUTHORIZATION:"https://integration.buch.de/auth/oauth2/authorize",URL_OAUTH_REDIRECT:"https://orellfuesslich.prodref.pageplace.de/library/index.html",URL_OAUTH_REVOKETOKEN:"https://integration.buch.de/auth/oauth2/revoke",URL_SHOP_BASE:"https://integration.buch.de/de.buch.shop/shop/37/home/show/",URL_SHOP_BASE_SEARCH:"https://integration.buch.de/de.buch.shop/shop/37/ebooks/suche/?sq=",URL_SHOP_EBOOK_START_PAGE:"https://integration.buch.de/de.buch.shop/shop/37/ebooks/show/",URL_SHOP_EBOOK_SEARCH:"https://integration.buch.de/de.buch.shop/shop/37/ebooks/suche/?sswg=EBOOK&sq=",URL_SHOP_AUDIO_START_PAGE:"https://integration.buch.de/de.buch.shop/shop/37/hoerbuecher/show/",URL_SHOP_AUDIO_SEARCH:"https://integration.buch.de/de.buch.shop/shop/37/home/suche/?sswg=HOERBUCH&sq="},10:{STRING_BRAND_NAME:"Weltbild.de WebReader -- PRODREF",UICOLOR_NORMAL_STATE:"#db1115",DEFAULT_LANGUAGE:"de_DE",URL_CONTACT:"http://www.weltbild.de/1/sh.kontaktoverview/kontakt-overview.html",URL_DATA_PRIVACY:"http://www.weltbild.de/1/sh.datenschutz/datenschutz.html",URL_HELP:"http://www.weltbild.de/1/ebook-hilfe/ebook-hilfe.html",URL_IMPRINT_DOCUMENT:"http://www.weltbild.de/1/sh.impressum/page.html",URL_TERMS_AND_CONDITIONS:"http://www.weltbild.de/1/sh.agb/agb-lieferbedingungen.html#agb",URL_SHOP_RECOMMENDATIONS_BASE:"https://pit.weltbild.de/",OAUTH_CLIENT_ID:"4c20de744aa8b83b79b692524c7ec6ae",OAUTH_SCOPE:"ebook_library",OAUTH_TOKEN_DEMO_USER:"eyJzaXRlIjoiIiwicHJmIjoiZGVtbyIsImF1ZCI6IjJmNzBmNjI2MzA2MjQyOTc5ZGQ3N2I4ZWQyMjNmMzIzIiwiaXNzIjoid2VsdGJpbGQuZGUiLCJwcm4iOiJEZW1vX1dCREUifQ",URL_OAUTH_ACCESSTOKEN:"https://api-pit.weltbild.de/rest/oauth2/token",URL_OAUTH_AUTHORIZATION:"https://pit.weltbild.de/oauth2/authorize",URL_OAUTH_REDIRECT:"https://www.prodref.pageplace.de/media/client/partner/weltbildde/library/index.html",URL_OAUTH_REVOKETOKEN:"https://api-pit.weltbild.de/rest/oauth2/revoke",URL_SHOP_BASE:"http://www.weltbild.de",URL_SHOP_EBOOK_START_PAGE:"http://www.weltbild.de/ebooks",URL_SHOP_AUDIO_START_PAGE:"https://qa.weltbild.de/buecher/hoerbuecher-hoerspiele/Hoerbuch-Download"}},b={reseller_id:1,client_type:"TOLINO_WEBREADER",lastModified:1452094064e3,config:{}},c=function(c){return c&&a[c]?(b.reseller_id=c,angular.extend(b.config,a[555]),angular.extend(b.config,a[c]),b):(b.reseller_id=3,angular.extend(b.config,a[555]),angular.extend(b.config,a[3]),b)};return{getMockConfig:c}}]),angular.module("services").factory("reseller",["$window","$injector","$http","$q","CONFIG","appState","$timeout","error",function(a,b,c,d,e,f,g,h){"use strict";var i=1e4,j=null,k=null,l=null,m=null,n=null,o=null,p=a.sessionStorage.getItem("country"),q=a.sessionStorage.getItem("reseller"),r=e.globals.LANGUAGES_BOSH_MAP,s=function(a){var b=a.match("[A-Z]{2}");return 1===b.length?r[b[0]]||b[0]:null},t=function(){var b,f=a.sessionStorage.getItem("env");b=f&&"prod"===f?e.globals.NET.BOSH_LIVE:e.globals.NET.BOSH_TEST,b+="/reseller/countries?resellerGroup="+e.globals.NET.RESELLER_GROUP;var j=d.defer(),k=g(function(){j.resolve({type:e.globals.ERROR.NETWORK_TIMEOUT})},i);return c({method:"GET",timeout:j,url:b,headers:{Accept:"application/json","Content-Type":"application/json"}}).then(function(a){return v(u(a.data))}).catch(function(a){if(a)return a.status?h.handleError({type:e.globals.ERROR.NETWORK_BOSH_FAIL,httpStatusCode:a.status,details:{httpError:a}},!1):h.handleError(a,!1)}).finally(function(){g.cancel(k)})},u=function(a){var b=a&&a.resellerCountryResponse&&a.resellerCountryResponse.resellerCountryGroups,c={};if(b)for(var d in b)c[b[d].languageCode]=b[d].resellerCountries;return c},v=function(a){var b=f.fetch("lang"),c="";if(b&&(c=s(b)),c&&a[c]){k=[];for(var d=a[c],e=0;e<d.length;e++)d[e].countryCode===c?k.unshift(d[e]):d[e]&&k.push(a[c][e]);if(p)for(var g=p.toUpperCase(),h=0;h<k.length;h++)if(k[h].countryCode===g){x(k[h]);break}return k}return null},w=function(){return k},x=function(a){f.save("country",JSON.stringify(a)),j=a},y=function(){if(!j)try{j=JSON.parse(f.fetch("country"))}catch(a){return!1}return j},z=function(){f.remove("country"),p=null,j=null},A=function(){return!!Boolean(F())||Boolean(y())},B=function(){if(!j)return d.reject(e.globals.ERROR.APP_NO_COUNTRY);var b,f=a.sessionStorage.getItem("env");
b=f&&"prod"===f?e.globals.NET.BOSH_LIVE:e.globals.NET.BOSH_TEST;var k=j.countryCode;b+="/reseller/selection?countryCode="+k+"&resellerGroup="+e.globals.NET.RESELLER_GROUP+"&client_type="+e.globals.NET.CLIENT_TYPE;var l=d.defer(),m=g(function(){l.resolve({type:e.globals.ERROR.NETWORK_TIMEOUT})},i);return c({method:"GET",url:b,timeout:l,headers:{Accept:"application/json","Content-Type":"application/json"}}).then(function(a){C(a.data)}).catch(function(a){if(a)return a.status?h.handleError({type:e.globals.ERROR.NETWORK_BOSH_FAIL,httpStatusCode:a.status,details:{httpError:a}},!1):a.name?h.handleError({type:a.name,details:a.message}):h.handleError(a,!1)}).finally(function(){g.cancel(m)})},C=function(a){l=a&&a.resellerSelectionResponse&&a.resellerSelectionResponse.resellerSelection;for(var b=0;b<l.length;b++)l[b].logoName=N(l[b].resellerId);if(q)for(var c=parseInt(q,10),d=0;d<l.length;d++)if(l[d].resellerId===c){E(l[d]);break}return l},D=function(){return l},E=function(a){f.save("reseller",JSON.stringify(a)),m=a},F=function(){if(!m)if(q){var b=parseInt(q,10);b&&!a.isNaN(b)&&(m={resellerId:b},E(m))}else try{m=JSON.parse(f.fetch("reseller"))}catch(a){return!1}return m},G=function(){return Boolean(F())},H=function(){f.remove("reseller"),q=null,m=null},I=function(){if(o)return o;if(n)return d.resolve(n);if(!a.navigator.onLine)return J();var b;G()?b=F().resellerId:d.reject(e.globals.ERROR.APP_NO_RESELLER);var j,k=a.sessionStorage.getItem("env");j=k&&"prod"===k?e.globals.NET.BOSH_LIVE:e.globals.NET.BOSH_TEST;var l={Accept:"application/json","Content-Type":"application/json",reseller_id:b,client_type:"TOLINO_WEBREADER",client_version:e.globals.NET.CONFIG_VERSION},m=d.defer(),p=g(function(){m.resolve("TIMEOUT")},i);return o=c({method:"GET",url:j+"/v2/resellerconfig",cache:!1,timeout:m.promise,headers:l}).then(function(b){var c=b&&b.data&&b.data.config;if(c){for(var g in c)"null"===c[g]?c[g]=null:"false"===c[g]&&(c[g]=!1);if(c.RESELLER_ID=c.reseller_id=b&&b.data&&b.data.reseller_id?String(b.data.reseller_id):null,c.NEW_RESELLER&&String(c.NEW_RESELLER)!==c.RESELLER_ID)return a.sessionStorage.setItem("reseller",c.NEW_RESELLER),d.resolve(a.location.reload());c.org_reseller_id=c.reseller_id;var h=a.sessionStorage.getItem("kickstarter"),i=a.sessionStorage.getItem("env");h&&i&&("staging"===i||"develop"===i||"applause"===i||"redesign"===i)&&(c.URL_OAUTH_REDIRECT=h,c.URL_OAUTH_AUTHORIZATION="https://simulator.prodref.pageplace.de/oauth-simulator/",c.URL_OAUTH_ACCESSTOKEN="https://simulator.prodref.pageplace.de/oauth-simulator/oauth/token",c.URL_OAUTH_REVOKETOKEN="https://simulator.prodref.pageplace.de/oauth-simulator/oauth/revoke",c.OAUTH_TOKEN_DEMO_USER="RGFzIGlzdCBlaW4gRGVtby1Ub2tlbg==",c.reseller_id="1");var j=a.sessionStorage.getItem("channelid");if(!c.CHANNEL_ID&&j&&(c.CHANNEL_ID=j),q)return J().then(null,function(){return d.resolve()}).finally(function(){n=c;try{f.save("config",JSON.stringify(n))}catch(a){console.warn(e.globals.ERROR.LOCALSTORAGE_FAIL)}return n});n=c;try{f.save("config",JSON.stringify(n))}catch(a){console.warn(e.globals.ERROR.LOCALSTORAGE_FAIL)}return n}return J()},function(){return console.warn(e.globals.ERROR.APP_NO_CONFIG),J().catch(function(a){if(z(),H(),a)return a.status?h.handleError({type:e.globals.ERROR.APP_NO_CONFIG,httpStatusCode:a.status,details:{httpError:a}},!1):a.name?h.handleError({type:a.name,details:a.message}):h.handleError({type:e.globals.ERROR.APP_NO_CONFIG,details:a},!1)})}).finally(function(){o=null,g.cancel(p)})},J=function(){var b=f.fetch("config");if(b)try{if(n=JSON.parse(b),q&&n){var c=parseInt(q,10);if(c&&!a.isNaN(c))if("1"===n.reseller_id){if(n.org_reseller_id!==String(c))return f.remove(a.btoa(n.reseller_id)),d.reject(e.globals.ERROR.INVALID_CONFIG)}else if(n.reseller_id!==String(c))return f.remove(a.btoa(n.reseller_id)),d.reject(e.globals.ERROR.INVALID_CONFIG)}return d.resolve(n)}catch(a){if(console.warn(e.globals.ERROR.INVALID_CONFIG),!navigator.onLine)return d.reject(e.globals.ERROR.INVALID_CONFIG)}return d.reject(e.globals.ERROR.APP_NO_CONFIG)},K=function(){return n},L=function(){return Boolean(K())},M={1:"telekom",3:"thaliade",4:"thaliaat",5:"thaliach",6:"buchde",7:"buchch",8:"orellfuesslich",10:"weltbildde",11:"weltbildat",12:"weltbildch",13:"hugendubelde",20:"bertelsmannde",21:"ottode",22:"donaulandat",23:"osianderde",24:"mayerschede",30:"buecherde",40:"bildde",60:"boekhandelbe",61:"clubbe",80:"libride",81:"ebookde",82:"librisnl",82001:"blznl",90:"ibsit",91:"libraccioit",92:"indiebookit"},N=function(a){return a?M[a]?M[a]:(console.warn("services.resellerHelper: No ID available for ",a),null):(console.warn("services.resellerHelper: No id to convert from"),null)};return{fetchCountries:t,getCountries:w,setCountry:x,getCountry:y,unsetCountry:z,hasCountry:A,fetchResellers:B,getResellers:D,setReseller:E,getReseller:F,hasReseller:G,fetchConfig:I,getConfig:K,hasConfig:L,convertFromId:N}}]),angular.module("services").provider("runtimeconfig",function(){"use strict";var a={hasMinimumRequiredFeatures:!(!Modernizr.localstorage||!Modernizr.sessionstorage),isMissingRecommendedFeature:!(Modernizr.webworkers&&(Modernizr.flexbox||Modernizr.flexboxlegacy)),storageType:Modernizr.indexeddb?"indexeddb":Modernizr.websqldatabase?"websql":Modernizr.filesystem?"file":"none",platformPreventsPlayback:Modernizr.ios6||Modernizr.ios6||Modernizr.android};return{set:function(b){a=angular.extend(a,b)},$get:function(){return a}}}),angular.module("services").factory("Selection",[function(){"use strict";var a=function(){this.isSelectionMode=!1,this.isRadioMode=!1,this.selectedItems=Object.create(null),this.disabledItems=Object.create(null),this.numSelectedItems=0};return a.prototype.clearSelection=function(){for(var a in this.selectedItems)delete this.selectedItems[a];this.numSelectedItems=0},a.prototype.isSelected=function(a){return this.selectedItems[a]},a.prototype.setSelected=function(a,b){this.disabledItems[a]||b===!!this.selectedItems[a]||(b?(this.isRadioMode&&this.clearSelection(),this.selectedItems[a]=!0,this.numSelectedItems++):(delete this.selectedItems[a],this.numSelectedItems--))},a.prototype.toggle=function(a){this.setSelected(a,!this.selectedItems[a])},a.prototype.updateNumSelectedItems=function(){var a=0;for(var b in this.selectedItems)this.selectedItems[b]&&!this.disabledItems[b]&&a++;this.numSelectedItems=a},a.prototype.clearDisabledItems=function(){for(var a in this.disabledItems)delete this.disabledItems[a]},a.prototype.isDisabled=function(a){return this.disabledItems[a]},a.prototype.setDisabled=function(a,b){this.selectedItems[a]&&b!==!!this.disabledItems[a]&&(this.numSelectedItems+=b?-1:1),b?this.disabledItems[a]=!0:delete this.disabledItems[a]},a.prototype.reset=function(){this.clearDisabledItems(),this.clearSelection(),this.isSelectionMode=!1,this.isRadioMode=!1},a}]),angular.module("services").service("sharing",["$translate","reseller","CONFIG",function(a,b,c){"use strict";var d=1e3,e="http://mytolino.de/tolino-webreader/",f={facebook:{baseUrl:"https://www.facebook.com/sharer/sharer.php",popup:!0,params:{title:"p[title]",text:"p[summary]",url:"p[url]",image:"p[images][0]"}},twitter:{baseUrl:"https://twitter.com/intent/tweet",popup:!0,textMaxLength:130,params:{text:"text",ref:"hashtags"}},email:{baseUrl:"mailto:",popup:!1,params:{title:"subject",text:"body"}}},g=function(a,b){if(!a||a.length<=b)return a;var c=a.substring(0,b-1).lastIndexOf(" ");return a.substring(0,c)+"…"},h=function(a){if(!a)return"";var b=a.indexOf(",");if(b<0)return a;var c=a.substr(0,b).trim(),d=a.substr(b+1).trim();return d+" "+c},i=function(a,b){var c=[];for(var d in b){var e=a[d],f=b[d];e&&f&&c.push(e+"="+encodeURIComponent(f))}return c.join("&")},j=function(a){return a.title?a.author?a.reseller?gettext("SHARING_TEXT"):gettext("SHARING_TEXT_TITLE_AUTHOR"):gettext("SHARING_TEXT_TITLE"):a.author?gettext("SHARING_TEXT_AUTHOR"):gettext("SHARING_TEXT_NO_DATA")},k=function(k,l,m){var n=b.getRemoteConfig();if(!n)return c.globals.ERROR.APP_NO_CONFIG;var o=n.URL_SHOP_START_PAGE,p=f[k];if(!p)return null;var q={title:l.title,author:h(l.author),reseller:"EDATA"!==l.type&&l.resellername};if(!m){var r=j(q);m=a.instant(r,q)}return m=g(m,p.textMaxLength||d),p.baseUrl+"?"+i(p.params,{title:a.instant(gettext("SHARING_TITLE"),q),text:m,url:o||e,ref:"tolino",image:"EDATA"!==l.type&&l.cover})},l=function(a,b){var c="_blank",d=Math.min(window.outerWidth,640),e=Math.min(window.outerHeight,560);b?window.open(a,c,"width="+d+",height="+e):window.location=a};return{sharePublication:function(a,b,c){var d=k(a,b,c),e=f[a];l(d,e&&e.popup)},getSharingURL:k}}]),angular.module("services").factory("stateHelper",["$window","$state","$q","token","bosh","reseller","inventory","user","cover","error","CONFIG",function(a,b,c,d,e,f,g,h,i,j,k){"use strict";var l="tw_stateHelper_targetState",m=[],n=function(){return{state:b.current,params:b.params}},o=function(a){if("string"==typeof a&&(a=g.deliverables[a]),!a)return null;var b=a.format,c={deliverable:a,params:{id:a.id}};switch(b){case"ePub":c.name="epub";break;case"PDF":case"pdf":c.name="pdf";break;case"audio/mpeg":c.name="audio";break;case"application/x-cbr":case"application/x-cbt":case"application/x-cbz":c.name="comic";break;default:c.name="unknown"}return c},p=function(b){if(!b)return null;if(a.sessionStorage.removeitem("kickhash"),["reader:","audio:"].indexOf(b)>-1){var c,d=b.split(":");try{c=atob(a.decodeURIComponent(d[d.length-1]))}catch(a){console.warn("tw.services.stateHelper: Was not able to decode URI component")}if(c){var e=o(c);if(e)return e}return{name:"home",params:null}}return b.indexOf("audiolibrary")>-1?{name:"myaudiobooks",param:null}:b.indexOf("library")>-1?{name:"mybooks",param:null}:b.indexOf("account")>-1?{name:"account",param:null}:null},q=function a(d,e){return"string"==typeof d&&(d=b.get(d)),"object"!=typeof d||null===d?c.reject():d.abstract?void 0:d.redirectTo?a(d.redirectTo,e):b.go(d,e)},r=function(a,d){return"string"==typeof a&&(a=b.get(a)),"object"!=typeof a||null===a?c.reject():b.is(a)?d?q(a,d):b.reload():q(a,d)},s=function(a,b){var c=m[m.length-1];c&&angular.equals(c.state.name,a.name)&&angular.equals(c.params,b)||m.push({state:a,params:b,keyState:!1})},t=function(a){return a||(a=1),m[m.length-a]},u=function(a,b){if(m.length>0&&(a=a||1,a>m.length&&(a=m.length),m.splice(m.length-a),m.length>0)){var c=m.pop();return"reseller"===c.state.name||"country"===c.state.name?q("home"):q(c.state,c.params||null)}return q(b?b:"home")},v=function(){m[m.length-1].keyState=!0},w=function(){for(var a=null,b=m.length-1,c=0;b>=c;b--)if(a=m[b],a.keyState===!0)return m.splice(b),q(a.state,a.params||null);return u()},x=function(b,c){var d={state:b,params:c};a.sessionStorage.setItem(l,JSON.stringify(d))},y=function(){return Boolean(a.sessionStorage.getItem(l)||Boolean(a.sessionStorage.getItem("kickhash")))},z=function(b){var c=a.sessionStorage.getItem(l);if(c){a.sessionStorage.removeItem(l);try{return c=JSON.parse(c),q(c.state,c.params)}catch(a){console.warn("tw.services.stateHelper: Was not able to parse targetState object: ",c)}}var d=a.sessionStorage.getItem("kickhash");if(d){if(a.sessionStorage.removeItem("kickhash"),d=d.replace(/(?:#\/|#)/,"").replace(/\//gi,"."),d.indexOf("?")>=0){var e=A(d);return q(e.name,e.params).catch(function(){return q("home")})}return q(d).catch(function(){return q("home")})}return q(b?b:"home")},A=function(a){var b,c={},d=a.split("?");return d[0]&&(b=d[0]),d[1]&&(d=d[1].split("&"),d.map(function(a){var b=a.split("=");c[b[0]]=b[1]})),{name:b,params:c}},B=function(a,b){if("sorry"!==b.name)return Modernizr.issafari&&Modernizr.isprivatemode?(a.preventDefault(),q("sorry",{type:k.globals.ERROR.BROWSER_PRIVATE_MODE,message:gettext("ERROR_PRIVATE_MODE")})):void 0},C=function(){return f.hasReseller()&&f.hasCountry()&&f.hasConfig()&&d.hasToken()&&e.hasHardware()},D=function(){return f.fetchConfig().catch(function(){j.handleError({type:k.globals.ERROR.APP_NO_CONFIG})})},E=function(){return d.fetchToken().then(function(){h.setLoggedIn(!0)},function(){var b=a.sessionStorage.getItem("autologin");return b?(a.sessionStorage.removeItem("autologin"),d.fetchAuthorizeUrl(b).then(function(b){return navigator.serviceWorker&&navigator.serviceWorker.controller.postMessage("bosh-purge"),a.location=b,c.reject(k.globals.ERROR.NETWORK_AUTOLOGIN_PROGRESS)})):(h.setLoggedIn(!1),c.resolve())})},F=function(){return e.fetchHeader(!0).then(null,function(a){if(a)return a.status?j.handleError({type:k.globals.ERROR.NETWORK_BOSH_FAIL,httpStatusCode:a.status,details:{httpError:a}},!1):a.name?j.handleError({type:a.name,details:a.message}):a===k.globals.ERROR.APP_INVALID_USER?j.handleError({type:k.globals.ERROR.APP_INVALID_USER,httpStatusCode:a.status,details:{httpError:a}}):j.handleError({type:a})})},G=function(a,b,c,g,h){var i=["country","reseller","sorry"];if(!(i.indexOf(b.name)>-1))return C()!==!0&&(console.warn("[status] state change pre-requisites invalid"),a.preventDefault(),"home"!==b.name&&x(b.name,c)),f.hasReseller()?f.hasConfig()&&d.hasToken()&&e.hasHardware()?(b&&b.name?s(b,c||null):s(g,h||null),b.redirectTo?(a.preventDefault(),q(b.redirectTo,b.params)):void 0):D().then(E).then(F).then(function(){return g&&g.name?s(g,h||null):s(b,c||null),y()?z():r(b,c)},function(a){if(a!==k.globals.ERROR.NETWORK_AUTOLOGIN_PROGRESS)return q("sorry")}):f.hasCountry()?f.fetchResellers().then(q.bind(this,"reseller"),q.bind(this,"sorry")):f.fetchCountries().then(function(){return f.hasCountry()?f.fetchResellers().then(q.bind(this,"reseller"),q.bind(this,"sorry")):q("country")},q.bind(this,"sorry"))},H=angular.noop;return{getCurrentState:n,getViewStateForDeliverable:o,determineLegacyStartState:p,goToState:q,updateState:r,storeLastVisitedState:s,getLastVisitedState:t,goToLastVisitedState:u,setAsKeyState:v,goToLastKeyState:w,storeTargetState:x,hasTargetState:y,goToTargetState:z,handleStateChangeStart:G,handleStateChangeSuccess:H,platformPrerequsitesValid:B}}]),angular.module("services").factory("browserStorage",["$window",function(a){"use strict";var b=a.localStorage,c=function(a){var c=b.getItem(a);return c},d=function(a,c){"object"==typeof c&&(c=JSON.stringify(c));try{b.setItem(a,c.toString())}catch(a){console.warn(a)}return c},e=function(){b.clear()},f=function(a){a in b&&b.removeItem(a)},g=function(a){return a in b},h=function(a){var c=a>=0&&a<b.length;return b.key(c?a:0)},i=function(){return b.length};return{getItem:c,setItem:d,clear:e,removeItem:f,hasKey:g,key:h,length:i}}]),angular.module("services").factory("storage",["runtimeconfig","$log","$q","$timeout","$injector",function(a,b,c,d,e){"use strict";var f,g=a.storageType;switch(g){case"indexeddb":f="storageIndexedDb";break;case"websql":f="storageWebSql";break;case"none":f="storageNone";break;default:f=!1}if(!f)return b.error('No storageEngine for runtimeconfig.storageType "'+g+'"'),e.get("storageNone");var h=e.get(f);if(!h)return b.error('No implementation for storageEngineName "'+f+'"'),e.get("storageNone");if("none"===g)return h;var i={},j=function(){for(var a in i)h[a]=i[a]},k=h.init,l=null,m=function(a){if(l||(l=k().then(j,function(a){var c="initialization of storageEngine "+f+" failed";return a.target&&a.target.error&&a.target.error.message&&(c+=": "+a.target.error.message),b.error(c),b.log(a),j()})),a){var c=function(b){return a.apply(h,b)}.bind(this,Array.prototype.slice.call(arguments,1));return l.then(c)}return l};for(var n in h){var o=h[n];"function"==typeof o&&(i[n]=o,h[n]=m.bind(h,"init"!==n&&o))}return h.type=g,h[g]=!0,h}]),angular.module("services").factory("storageIndexedDb",["$q","$timeout","$rootScope","ByteArray",function(a,b,c,d){"use strict";var e,f="readonly",g="readwrite",h=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB,i=1,j="tolinoweb",k="tolinoweb",l=null,m=function(){var b=a.defer();try{var c=l.createObjectStore(k,{keyPath:"key",autoIncrement:!1});c.createIndex("key","key",{unique:!0}),c.createIndex("data","data",{unique:!1}),c.transaction.oncomplete=function(){c.transaction.oncomplete=c.transaction.onerror=null,b.resolve()},c.transaction.onerror=function(a){c.transaction.oncomplete=c.transaction.onerror=null,b.reject(a)}}catch(a){b.reject(a)}return b.promise},n=!1,o=function(){if(n)return a.when(null);if(e)return e;var b=a.defer();try{var c=h.open(j,i);c.onsuccess=function(){l=this.result,v(b)},c.onerror=angular.bind(this,w,b),c.onupgradeneeded=function(a){var c=a.newVersion;l=a.currentTarget.result;try{a.oldVersion&&l.deleteObjectStore(k),c===i&&m().then(angular.bind(this,v,b),angular.bind(this,w,b))}catch(a){w(b,a)}}}catch(a){w(b,a)}return e=b.promise},p=function(b,d){if(c.isDemoMode)return a.reject("no storage in demo mode");if(!n)return a.reject("storage not initialized");var e=a.defer();try{var f=l.transaction([k],g);f.oncomplete=angular.bind(this,x,e),f.onerror=angular.bind(this,y,e);var h=f.objectStore(k);h.put({key:b,data:d})}catch(a){y(e,a)}return e.promise},q=function(b,e){if(c.isDemoMode)return a.reject("no storage in demo mode");if(!n)return a.reject("storage not initialized");var g=a.defer();try{var h=l.transaction([k],f),i=h.objectStore(k),j=function(){if(!m.result||!m.result.data)return void A(g);var a=m.result.data;e&&(a=d.unpackString(a)),z(g,a)},m=i.get(b);h.oncomplete=j,h.onerror=angular.bind(this,A,g)}catch(a){A(g,a)}return g.promise},r=function(b){if(c.isDemoMode)return a.reject("no storage in demo mode");if(!n)return a.reject("storage not initialized");var d=a.defer();try{var e=l.transaction([k],g),f=e.objectStore(k);f.delete(b),e.oncomplete=angular.bind(this,B,d),e.onerror=angular.bind(this,C,d)}catch(a){C(d,a)}return d.promise},s=function(){if(c.isDemoMode)return a.reject("no storage in demo mode");if(!n)return a.reject("storage not initialized");var b=a.defer();try{var d=l.transaction([k],g),e=d.objectStore(k);e.clear(),d.oncomplete=angular.bind(this,D,b),d.onerror=angular.bind(this,E,b)}catch(a){E(b,a)}return b.promise},t=function(b){if(c.isDemoMode)return a.reject("no storage in demo mode");if(!n)return a.reject("storage not initialized");var d=a.defer();try{var e=l.transaction([k],f),g=e.objectStore(k),h=function(){F(d,!!i.result)},i=g.get(b);e.oncomplete=h,e.onerror=angular.bind(this,G,d)}catch(a){G(d,a)}return d.promise},u=function(){if(c.isDemoMode)return a.reject("no storage in demo mode");if(!n)return a.reject("storage not initialized");var b=a.defer();try{var d=l.transaction([k],f),e=d.objectStore(k),g=[],h=e.openCursor();h.onsuccess=function(a){var c=a.target.result;c?(g.push(c.key),c.continue()):H(b,g)},h.onerror=angular.bind(this,I,b)}catch(a){I(b,a)}return b.promise},v=function(a){n=!0,e=null,a.resolve()},w=function(a,b){n=!1,e=null,a.reject(b)},x=function(a){a.resolve()},y=function(a,b){a.reject(b)},z=function(a,b){a.resolve(b)},A=function(a,b){a.reject(b)},B=function(a){a.resolve()},C=function(a,b){a.reject(b)},D=function(a){var b=i+1,c=h.open(j,b);c.onupgradeneeded=function(a){a.newVersion===b&&l.deleteObjectStore(k)},a.resolve()},E=function(a,b){h.open(j,i+1),a.reject(b)},F=function(a,b){a.resolve(b)},G=function(a,b){a.reject(b)},H=function(a,b){a.resolve(b)},I=function(a,b){a.reject(b)};return{init:o,save:p,fetch:q,erase:r,purge:s,exists:t,keys:u}}]),angular.module("services").factory("storageNone",["$q",function(a){"use strict";var b=function(){return a.reject("no storage available")};return{init:b,save:b,fetch:b,erase:b,purge:b,exists:b,keys:b}}]),angular.module("services").factory("storageWebSql",["$q","$timeout","$rootScope","ByteArray","dateTime",function(a,b,c,d,e){"use strict";var f,g=256,h="tolinoweb",i=null,j=null,k=null,l=function(){var b=a.defer(),c="CREATE TABLE IF NOT EXISTS "+j+" (id NVARCHAR(256), data TEXT, part INT, timestamp REAL)";return k.transaction(function(a){a.executeSql(c,[],angular.bind(this,J,b),angular.bind(this,K,b))}),b.promise},m=function(b,c,d){var f=a.defer(),g="INSERT INTO "+j+" (data, part, timestamp, id) VALUES (?, ?, ?, ?)",h=function(){k.transaction(function(a){var h=e.getUTCTimestamp(),i=[JSON.stringify(c),d,h,b];a.executeSql(g,i,function(){f.resolve()},function(){console.log(arguments),f.reject()})})};return d<=0?t(b).then(function(){r(b).then(function(){h()})}):h(),f.promise},n=!1,o=function(b){if(n)return a.when(null);if(f)return f;var c=a.defer();b=b||{},b.dbName=i=b.dbName||h,b.tableName=j=b.tableName||h,b.size=b.size||5;var d=1024*b.size*1024;return k=window.openDatabase(i,"1.0.0",i,d),k?l().then(angular.bind(this,v,c),angular.bind(this,w,c)):w(c),f=c.promise},p=function(b,e){if(c.isDemoMode)return a.reject("no storage in demo mode");if(!n)return a.reject("storage not initialized");if(!b)return a.reject("cannot save without key");if(!angular.isDefined(e))return a.reject("cannot save nothing");var f=Object.prototype.toString.call(e),h="[object ArrayBuffer]"===f,i="[object Uint8Array]"===f;if("[object String]"!==f&&!h&&!i)return a.reject("unsupported data type: "+f);var j=a.defer(),k=h?e.byteLength:e.length,l=1024*g;if(k<=l)h?e=d.asPackedString(new Uint8Array(e)):i&&(e=d.asPackedString(e)),m(b,e,-1).then(angular.bind(this,x,j),angular.bind(this,y,j));else{var o=0,p=0,q=function(){var a;o+l<=k?(a=h?d.asPackedString(new Uint8Array(e,o,l)):e.substr(o,l),m(b,a,p).then(q,null)):(a=h?d.asPackedString(new Uint8Array(e,o,k-o)):e.substr(o),m(b,a,p).then(angular.bind(this,x,j),angular.bind(this,y,j))),p++,o+=l};q()}return j.promise},q=function(b,e){if(c.isDemoMode)return a.reject("no storage in demo mode");if(!n)return a.reject("storage not initialized");var f=a.defer(),h="SELECT id, data FROM "+j+" WHERE id = ? ORDER BY part ASC";e=e||!1;var i=function(a,b){var c=b.rows.length;if(0===c)return void A(f);var h;if(e){var i=c*g*1024,j=0;h=new Uint8Array(new ArrayBuffer(i));for(var k=0,l=c;k<l;k++)j=d.unpackStringToBuffer(JSON.parse(b.rows.item(k).data),h,j);h=h.buffer.slice?h.buffer.slice(0,j):h.buffer}else{h="";for(var m=0,n=c;m<n;m++)h+=JSON.parse(b.rows.item(m).data)}z(f,h)};return k.transaction(function(a){a.executeSql(h,[b],i,angular.bind(this,A,f))}),f.promise},r=function(b){if(c.isDemoMode)return a.reject("no storage in demo mode");if(!n)return a.reject("storage not initialized");var d=a.defer(),e="DELETE FROM "+j+" WHERE id = ?";return k.transaction(function(a){a.executeSql(e,[b],angular.bind(this,B,d),angular.bind(this,C,d))}),d.promise},s=function(){if(c.isDemoMode)return a.reject("no storage in demo mode");if(!n)return a.reject("storage not initialized");var b=a.defer(),d="DELETE FROM "+j;return k.transaction(function(a){a.executeSql(d,[],angular.bind(this,D,b),angular.bind(this,E,b))}),b.promise},t=function(b){if(c.isDemoMode)return a.reject("no storage in demo mode");if(!n)return a.reject("storage not initialized");var d=a.defer(),e="SELECT * FROM "+j+" WHERE id = ?";return k.transaction(function(a){a.executeSql(e,[b],angular.bind(this,F,d),angular.bind(this,G,d))}),d.promise},u=function(){if(c.isDemoMode)return a.reject("no storage in demo mode");if(!n)return a.reject("storage not initialized");var b=a.defer(),d="SELECT id FROM "+j,e=function(a,c){for(var d=c.rows,e=d.length,f=[],g=0,h=e;g<h;g++)f[g]=d.item(g).id;H(b,f)};return k.transaction(function(a){a.executeSql(d,[],e,angular.bind(this,I,b))}),b.promise},v=function(a){n=!0,f=null,a.resolve()},w=function(a){a.reject()},x=function(a){a.resolve()},y=function(a){a.reject()},z=function(a,b){a.resolve(b)},A=function(a){a.reject()},B=function(a){a.resolve()},C=function(a){a.reject()},D=function(a){a.resolve()},E=function(a){a.reject()},F=function(a,b,c){a.resolve(!!c.rows.length)},G=function(a){a.reject()},H=function(a,b){a.resolve(b)},I=function(a){a.reject()},J=function(a){a.resolve()},K=function(a){console.log("CREATE FAIL SQL"),a.reject()};return{init:o,save:p,fetch:q,erase:r,purge:s,exists:t,keys:u}}]),angular.module("services").service("URLManager",["$http","$q",function(a,b){"use strict";var c=window.Modernizr.objecturl&&window.Modernizr.blobconstructor&&!window.Modernizr.ios6,d=window.URL||window.webkitURL,e=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder,f={},g={};this.createBlob=function(a,b){if("[object Blob]"===Object.prototype.toString.call(a))return a;try{return new Blob([a],{type:b})}catch(d){if("InvalidStateError"===d.name)return new Blob([a.buffer],{type:b});if("TypeError"===d.name&&e){var c=new e;return c.append([a.buffer]),c.getBlob(b)}return null}},this.exists=function(a){return a in f},this.getURL=function(a){return f[a]},this.getKeyForURL=function(a){for(var b in f)if(f[b]===a)return b;return null},this.isStoredURL=function(a){return a&&null!==this.getKeyForURL(a)},this.createURL=function(a,b,e){if(!c)return f[a]=a,f[a];if(!(a in f)){var g=this.createBlob(b,e);if(!g)return console.warn("Can't create Blob from data "+a),null;f[a]=d.createObjectURL(g)}return f[a]},this.fetchURL=function(e,h,i){if(!c)return b.resolve(null);if(e in f)return b.resolve(f[e]);var j=this.createBlob(h,i);if(!j)return console.warn("Can't create Blob from data "+e),b.resolve(null);var k=d.createObjectURL(j);return window.Modernizr.androidchrome&&/^audio\/|^video\//.test(i)&&"[object Blob]"!==Object.prototype.toString.call(h)?g[e]?g[e]:g[e]=a.get(k,{responseType:"blob"}).then(function(a){return delete g[e],f[e]=d.createObjectURL(a.data)}):(f[e]=k,b.resolve(k))},this.revokeURL=function(a){c&&a in f&&(d.revokeObjectURL(f[a]),delete f[a])},this.revokeAllURLs=function(){if(Modernizr.objecturl){for(var a in f)f.hasOwnProperty(a)&&d.revokeObjectURL(f[a]);f={}}}}]),angular.module("services").factory("subscription",["$http","$q","$timeout","bosh","reseller","appState","time","CONFIG",function(a,b,c,d,e,f,g,h){"use strict";function i(){y={},z={},A={},x={},k()}function j(a){return A[a]&&a in x&&g.getTime()<=A[a]+C}function k(){var a=f.fetch(B);if(a)try{x=JSON.parse(a)}catch(a){console.warn("restoreSubscriptionInfo:",a.name,a.message),x={}}}function l(){f.save(B,JSON.stringify(x))}function m(a,c){return e.fetchConfig().then(function(d){return z[a]=b.defer(),{method:"GET",url:d.URL_BOOKSHELF+"subscriptions/"+a,headers:c,timeout:z[a].promise}},n)}function n(){return b.reject(h.globals.ERROR.APP_NO_CONFIG)}function o(){return b.reject("HTTP error: Fetch header failed")}function p(a){z[a]&&z[a].resolve()}function q(a){delete y[a],delete z[a]}function r(a,b){if(q(a),b&&404===b.status)x[a]=null;else{var c=b&&b.data&&b.data.SubscriptionInfo;if(!c)return console.warn("Missing subscription info for ID",a),null;x[a]=c}return A[a]=g.getTime(),l(),x[a]}function s(a,b){q(a),console.warn("fetch SubscriptionInfo failed for ID",a+":",b)}function t(e,f){return!f&&j(e)?b.resolve(x[e]):y[e]?y[e]:y[e]=d.fetchHeader(!0).then(function(b){return c(p.bind(null,e),D),m(e,b).then(a).then(r.bind(null,e),s.bind(null,e))},o)}function u(){x={},l(),i()}function v(){return x}function w(a){var b=x[a];return b?"subscription "+b.reseller_id+"/"+b.id:""}var x,y,z,A,B="subscriptions",C=36e5,D=1e4;return i(),{fetchSubscriptionInfo:t,purgeSubscriptionInfo:u,getSubscriptions:v,getTagName:w}}]),angular.module("services").factory("sync",["$window","$timeout","$q","$injector","$rootScope","CONFIG","appState",function(a,b,c,d,e,f,g){"use strict";var h=f.globals,i=g.fetch(f.globals.SHELF_SYNC_TIME)||0,j=!1,k=[h.SYNC_PATH.DOGEAR,h.SYNC_PATH.COMMENT,h.SYNC_PATH.TAG,h.SYNC_PATH.BOOKMARK],l=null,m={};k.forEach(function(a){m[a]=Object.keys(h.SYNC_VALUES[a])});var n=function(){var a=d.get("time");i=a.getTime(),g.save(f.globals.SHELF_SYNC_TIME,i)},o=function(){return l?l:l=g.fetch(f.globals.SHELF_REVISION)},p=function(a){return a?(l=a,void g.save(f.globals.SHELF_REVISION,a)):null},q=function(){j=null,l=null,i=0,g.remove(f.globals.SHELF_REVISION)},r=function(a,b){var c={};return!!a&&(c[h.SYNC_PATH.DOGEAR]=a.dogears,c[h.SYNC_PATH.COMMENT]=a.comments,c[h.SYNC_PATH.TAG]=a.tags,k.forEach(function(d){d!==h.SYNC_PATH.BOOKMARK?s(b,a.id,a.type,c[d],d):u(b,a)}),b)},s=function(a,b,c,d,e){return d&&d.forEach(function(f){if(f.id)a.locals[b][f.id]=f,f.deleted?a.patches.push(t(f,b,c,e,h.SYNC_OP.REMOVE)):f.modified>i&&a.patches.push(t(f,b,c,e,h.SYNC_OP.REPLACE));else{if(f.deleted)d.splice(d.indexOf(f),1);else{var g=t(f,b,c,e,h.SYNC_OP.ADD);g&&(a.patches.push(g),a.transients[b][f.transientId]=f)}a&&a.touched.indexOf(b)===-1&&a.touched.push(b)}}),a},t=function(b,c,d,e,g){if(e===h.SYNC_PATH.TAG&&b.category===f.globals.MISC.SUBSCRIPTION_CATEGORY)return null;var i="AUDIOBOOK"===d?"audiobooks":"publications",j={op:g,value:{}};if(m[e].forEach(function(a){j.value[a]=b[h.SYNC_VALUES[e][a]]||null}),g===h.SYNC_OP.ADD){var k=null;switch(e){case h.SYNC_PATH.COMMENT:k=a.btoa(a.encodeURIComponent(b.rmsdkPosition+b.endPosition));break;case h.SYNC_PATH.TAG:k=a.btoa(a.encodeURIComponent(b.name));break;case h.SYNC_PATH.DOGEAR:k=a.btoa(a.encodeURIComponent(b.rmsdkPosition))}j.value.transientId=k,b.transientId=k,j.path="/"+i+"/"+c+e}else j.path="/"+i+"/"+c+e+"/"+b.id;return j},u=function(a,b){var c=b.bookmark;c&&Object.keys(c).length>0&&(!c.id&&c.rmsdkPosition&&c.modified&&a.patches.push(v(c,b.id,b.type,h.SYNC_OP.ADD)),c.id&&c.modified>i&&a.patches.push(v(c,b.id,b.type,h.SYNC_OP.REPLACE)))},v=function(a,b,c,d){var e=h.SYNC_PATH.BOOKMARK,f={op:d,value:{}},g="AUDIOBOOK"===c?"audiobooks":"publications";return m[e].forEach(function(b){var c=b in h.SYNC_DEFAULTS[e]?h.SYNC_DEFAULTS[e][b]:null;f.value[b]=a[h.SYNC_VALUES[e][b]]||c}),d===h.SYNC_OP.ADD?f.path="/"+g+"/"+b+e:f.path="/"+g+"/"+b+e+"/"+a.id,f},w=function(a){var b=d.get("user");if(!b.isLoggedIn())return c.resolve("demo mode");if(j)return j;var e={revision:o(),patches:[],touched:[],transients:{},locals:{}};return a.forEach(function(a){e.transients[a.id]={},e.locals[a.id]={},r(a,e)}),j=L(e).then(function(a){return A(a),J(a),n(),x(a)}).catch(y).finally(function(){j=null,e=null})},x=function(a){if(a&&a.touched.length>0){var b=d.get("inventory"),e=[];return a.touched.forEach(function(a){var c=b.saveDeliverable(a);e.push(c)}),c.allComplete(e)}},y=function(a){console.warn(a),g.remove(f.globals.SHELF_REVISION),g.remove(f.globals.SHELF_SYNC_TIME)},z=function(a){var b=function(a){return""!==a},c=a.split("/").filter(b);return{type:c[0],pubId:c[1],path:c[2],unitId:c[3]}},A=function(a){if(a&&a.boshData){a.patchData={},p(a.boshData.revision);var b=a.boshData.patches;b&&b.length&&b.length>0&&(a.boshPatches={},b.forEach(function(b){var c=z(b.path);c.pubId&&(a.boshPatches[c.pubId]||(a.boshPatches[c.pubId]=[]),a.boshPatches[c.pubId].push({id:c.unitId,path:"/"+c.path,patch:b}),a.touched.indexOf(c.pubId)<0&&a.touched.push(c.pubId))}),B(a))}return a},B=function(a){var b=d.get("inventory"),c=b.getDeliverables();return c.forEach(function(b){var c=a.boshPatches[b.id];c&&c.forEach(function(c){return c.patch.value.transientId&&a.transients[b.id][c.patch.value.transientId]?(C(c.patch.value,a.transients[b.id][c.patch.value.transientId],c.path,c.id),a.transients[b.id][c.patch.value.transientId]=null,void delete a.transients[b.id][c.patch.value.transientId]):void(c.id?(a.locals[b.id]||(a.locals[b.id]={},b.dogears.forEach(function(c){c.id&&(a.locals[b.id][c.id]=c)}),b.comments.forEach(function(c){c.id&&(a.locals[b.id][c.id]=c)}),b.tags.forEach(function(c){c.id&&(a.locals[b.id][c.id]=c)}),b.bookmark.id&&(a.locals[b.id][b.bookmark.id]=b.bookmark)),a.locals[b.id][c.id]?(c.patch.op===h.SYNC_OP.ADD&&C(c.patch.value,a.locals[b.id][c.id],c.path,c.id),c.patch.op===h.SYNC_OP.REMOVE&&E(c.id,b,c.path),c.patch.op===h.SYNC_OP.REPLACE&&C(c.patch.value,a.locals[b.id][c.id],c.path,c.id)):c.patch.op!==h.SYNC_OP.REMOVE&&D(c.patch.value,b,c.path,c.id),b.isFinished=b.tags.some(function(a){return"string"==typeof a.name&&a.category===f.globals.MISC.SYSTEM_CATEGORY&&a.name===f.globals.STORE.TAG_FINISHED_READINGS&&!a.deleted})):console.warn("found patch without id in bosh answer"))})}),a},C=function(a,b,c,d){delete b.transientId,m[c].forEach(function(d){b[h.SYNC_VALUES[c][d]]=a[d]}),b.id=d},D=function(a,b,c,d){var e,f={};if(c!==h.SYNC_PATH.BOOKMARK){switch(c){case h.SYNC_PATH.COMMENT:e=b.comments;break;case h.SYNC_PATH.TAG:e=b.tags;break;case h.SYNC_PATH.DOGEAR:e=b.dogears}m[c].forEach(function(b){f[h.SYNC_VALUES[c][b]]=a[b];
}),f.id=d,e.push(f)}else m[c].forEach(function(d){b.bookmark[h.SYNC_VALUES[c][d]]=a[d]}),b.bookmark.id=d;return f},E=function(a,b,c){var d=function(b){b.forEach(function(c){c.id===a&&b.splice(b.indexOf(c),1)})};switch(c){case h.SYNC_PATH.COMMENT:d(b.comments);break;case h.SYNC_PATH.TAG:d(b.tags);break;case h.SYNC_PATH.DOGEAR:d(b.dogears)}},F=function(a){var b=a.clientState,c=a.serverState,d=a.clientInfo,f=a.serverInfo;if(b.op===h.SYNC_OP.REMOVE)return c;if(c.op===h.SYNC_OP.REMOVE)return b;switch(d.pathObject.path){case h.SYNC_PATH.COMMENT:return G(b,c);case h.SYNC_PATH.TAG:return H(b,c);case h.SYNC_PATH.DOGEAR:return I(b,c);case h.SYNC_PATH.BOOKMARK:return f.pathObject.pubId===e.currentDeliverable&&e.$emit("tw.component.conflict",a),null}},G=function(a,b){return a.value.startPosition!==b.value.startPosition||a.value.endPosition!==b.value.endPosition?a.value.modified>b.value.modified?a:b:(a.value.note=a.value.note+b.value.note,a)},H=function(a,b){return a.value.modified>b.value.modified?a:b},I=function(a,b){return a.value.modified>b.value.modified?a:b},J=function(a){var b=[],c=a&&a.boshData&&a.boshData.conflicts;return c&&(c.forEach(function(a){var c=a.clientState,d=a.serverState;a.clientInfo.pathObject=z(c.path),a.serverInfo.pathObject=z(d.path);var e=F(a);e&&b.push(e)}),b.length>0&&(a.patches=b,L(a).catch(angular.noop))),a},K=function(a){var b=d.get("user");if(!b.isLoggedIn())return c.reject("demo mode");if(!a)return c.reject("no state choosen");var e={revision:o(),patches:[]};return e.patches.push(a),L(e).catch(angular.noop)},L=function(a){var e=d.get("reseller"),g=d.get("bosh");return g.isBoshOnline()?e.fetchConfig().then(function(e){return g.fetchHeader(!0).then(function(g){g.client_type="TOLINO_WEB";var h=c.defer(),i=b(function(){h.resolve(f.globals.ERROR.TIMEOUT)},1e4),j={method:"PATCH",url:e.URL_BOOKSHELF+"sync-data?paths=publications,audiobooks",timeout:h.promise,headers:g};j.data={revision:a.revision,patches:a.patches};var k=d.get("$http");return k(j).then(function(b){return a.boshData=b.data,a}).catch(function(b){M(a);var c=d.get("error");if(b)return b.status?401===b.status?c.handleError({type:f.globals.ERROR.APP_INVALID_TOKEN,httpStatusCode:b.status,details:{httpError:b}}).then(function(){return L(a)}).catch(angular.noop):c.handleError({type:f.globals.ERROR.APP_SYNC_ERROR,httpStatusCode:b.status,details:{httpError:b}},!1).catch(angular.noop):b.name?c.handleError({type:b.name,details:b.message}).catch(angular.noop):c.handleError({type:f.globals.ERROR.APP_SYNC_ERROR,details:{syncObject:a,httpError:b}},!1).catch(angular.noop)}).finally(function(){b.cancel(i)})})}):c.resolve(a)},M=function(a){var b=d.get("inventory");a.patches.forEach(function(a){var c=z(a.path);c.path="/"+c.path;var d=b.deliverables[c.pubId],e=c.unitId||a.value.transientId;switch(c.path){case h.SYNC_PATH.BOOKMARK:d.bookmark.progress=N(a.value.progress),d.bookmark.modified=O(a.value.modified),d.bookmark.rmsdkPosition=P(a.value.position);break;case h.SYNC_PATH.DOGEAR:d.dogears.forEach(function(b){b.id!==e&&b.transientId!==e||(b.modified=O(a.value.modified),b.position=P(a.value.position),b.displayName=P(a.value.name))});break;case h.SYNC_PATH.COMMENT:d.comments.forEach(function(b){b.id!==e&&b.transientId!==e||(b.modified=O(a.value.modified),b.position=P(a.value.position),b.endPosition=P(a.value.endPosition))});break;case h.SYNC_PATH.TAG:d.tags.forEach(function(b){b.id!==e&&b.transientId!==e||(b.modified=O(a.value.modified),b.name=P(a.value.name),b.category=P(a.value.category))})}})},N=function(a){return isNaN(parseFloat(a))?0:a},O=function(a){return isNaN(parseInt(a,10))?0:a},P=function(a){return a||String(a)};return{purge:q,handleConflict:K,sync:w}}]),angular.module("services").factory("textToSpeech",["$rootScope","$window","$q",function(a,b,c){"use strict";var d=!1,e=!1,f=!1,g=1,h=0,i=3,j=null,k=null,l=null,m=function(){return!1},n=function(){return e},o=function(){return f},p=function(a){return j?j.filter(function(b){return b.lang===a&&b.name.search(/Google/gi)===-1}):void console.warn('tw.services.textToSpeech: Could not get voices for language "'+a+'". No voices have been initialized. Call tw.services:textToSpeech#init first!')},q=function(a){k=j.filter(function(b){return b.voiceURI===a})[0]},r=function(){return g},s=function(b){return b.constructor!==Number||b<h||b>i?void console.warn("tw.services.textToSpeech: Can not set voice rate. Rate has to be a floating point number between "+h+" and "+i):(b===h&&(b=.5),g=b,void a.$emit("tw.textToSpeech.voiceRateChange",b))},t=function(a){return d?(l&&(l=null),l=y(),l.text=a,k&&(l.voice=k),g&&(l.rate=g),e=!0,f=!1,void b.speechSynthesis.speak(l)):void console.warn("tw.services.textToSpeech: Speech service has not beeninitialized! Call tw.services:textToSpeech#init first!")},u=function(){e=!0,f=!0,b.speechSynthesis.pause()},v=function(){e=!0,f=!1,b.speechSynthesis.resume()},w=function(){e=!1,f=!1,b.speechSynthesis.cancel(),l&&(l=null)},x=function(){var a=c.defer();return d&&j&&j.length>0?(a.resolve(j),a.promise):(void 0!==b.speechSynthesis.onvoiceschanged?(b.speechSynthesis.onvoiceschanged=function(){return d=!0,j=b.speechSynthesis.getVoices(),a.resolve(j)},j=b.speechSynthesis.getVoices(),Modernizr.isfirefox&&a.resolve(j)):(d=!0,j=b.speechSynthesis.getVoices(),a.resolve(j)),a.promise)},y=function(){var c=new b.SpeechSynthesisUtterance;return c.onstart=function(b){e=!0,f=!1,a.$emit("tw.textToSpeech.start",b)},c.onboundary=function(b){a.$emit("tw.textToSpeech.boundary",b)},c.onpause=function(b){e=!0,f=!0,a.$emit("tw.textToSpeech.pause",b)},c.onresume=function(b){e=!0,f=!1,a.$emit("tw.textToSpeech.resume",b)},c.onend=function(b){e=!1,f=!1,a.$emit("tw.textToSpeech.end",b)},c};return{isSpeaking:n,isPaused:o,isWebSpeechAPISupported:m,init:x,getVoicesForLanguage:p,setVoice:q,getVoiceRate:r,setVoiceRate:s,speak:t,pause:u,resume:v,stop:w}}]),angular.module("services").factory("theme",["$window","$http","$timeout","appState","CONFIG",function(a,b,c,d,e){"use strict";var f=e.globals.THEMES.themes,g="default",h=e.globals.THEMES.resellerMapping,i=e.globals.THEMES.uifonts,j="fira",k="tw-styles",l="tw-fonts",m="assets/themes/",n="assets/",o="theme",p="applied",q=100,r=d.fetch(o+".themeName")||g,s=d.fetch(o+".variantName")||g,t=d.fetch(o+".uiFontName")||j,u=function(){return a.sessionStorage.getItem("app")||window.tw.app},v=function(a){var b=document.getElementById(a);return b||console.warn("Could not find style node -> Not able to set theme"),b},w=function(a,b){return a.filter(function(a){return a.id===b})},x=function(a){return b.get(a,null,{responseType:"text/css"}).then(function(){return a},function(){console.warn('tw.services.theme: Was not able to load theme "'+a+'".')})},y=function(){var a=document.getElementsByTagName("body")[0];a.classList.remove(p)},z=function(a){var b=document.getElementsByTagName("body")[0];angular.element(b).attr("style",""),c(function(){b.classList.add(p)},a?0:q)},A=function(){return f},B=function(a){var b=A(),c=w(b,a);return!!(c&&c.length>0)||(console.warn('tw.services.theme: Theme "'+a+'" does not exist.'),!1)},C=function(a){if(B(a)===!0){var b=A();return w(b,a)[0]}return null},D=function(a){var b=C(a);b||(console.warn('tw.services.theme: Was not able to set new theme "'+a+'". Falling back to "'+g+'" theme.'),a=g),r=a,H("default",a)},E=function(a){var b=[],c=C(a);return c?b=c.variants:console.warn('tw.services.theme: Cannot get theme variants for theme "'+a+'", because the theme does not exist.'),b},F=function(a,b){b=b||r;var c=C(b);if(c){var d=c.variants,e=w(d,a);if(e&&e.length>0)return!0}else console.warn('tw.services.theme: Cannot validate theme variant for theme "'+b+'", because the theme does not exist.');return!1},G=function(a,b){if(b=b||r,F(a,b)===!0){var c=C(b);return w(c.variants,a)[0]}return null},H=function(a,b){var c=G(a,b);c||(console.warn('tw.services.theme: Theme variant "'+a+'" for theme "'+r+'" does not exist. Falling back to "'+g+'" theme'),a=g,c=G(a,b)),y();var e=v(k);if(c.blobURL)e.href=c.blobURL,s=a,d.save(o+".themeName",r),d.save(o+".variantName",a),z(!0);else{var f=u();x(m+r+"/"+f+"_"+a+".css").then(function(b){e.href=b,s=a,d.save(o+".themeName",r),d.save(o+".variantName",a),c.blobURL=b,z()})}},I=function(){return i},J=function(a){var b=I(),c=w(b,a);return!!(c&&c.length>0)},K=function(a){if(J(a)===!0){var b=I();return w(b,a)[0]}return null},L=function(a){var b=K(a);b||console.warn('tw.services.theme: Was not able to set new UI font "'+a+'". Falling back to "'+j+'" font');var c=v(l);c.href=n+"fonts_"+a+".css",t=a,d.save(o+".uiFontName",a)},M=function(){return r},N=function(){return s},O=function(){return t},P=function(a){var b=h;return b.hasOwnProperty(a)?b[a]:null},Q=function(){return d.fetch(o+".setByUser")||!1},R=function(){d.save(o+".setByUser",!0)};return{getThemes:A,getThemeByName:C,setThemeByName:D,getVariantsForTheme:E,getVariantByName:G,setVariantByName:H,getUIFonts:I,getUIFontByName:K,setUIFontByName:L,getActiveThemeName:M,getActiveVariantName:N,getActiveUIFontName:O,getResellerThemeInfo:P,isSetByUser:Q,setIsSetByUser:R}}]),angular.module("services").factory("time",["$window","appState","reseller","$timeout","$http","$q","CONFIG",function(a,b,c,d,e,f,g){"use strict";var h,i=function(){return c.fetchConfig().then(function(b){var c=f.defer();if(!a.navigator.onLine)return f.reject(g.globals.ERROR.NETWORK_OFFLINE);var h=d(function(){c.resolve(g.globals.ERROR.NETWORK_TIMEOUT)},2e3),i=b.URL_BOOKSHELF;return e({method:"Get",url:i+"time",timeout:c.promise,headers:{}}).finally(function(){d.cancel(h)})},null)},j=function(){var c=Date.now();return h||(h=a.parseInt(b.fetch("deltaSec"),10)),!h||isNaN(h)?c:c-h},k=function(){return i().then(function(a){var c,d=a.headers(),e=d&&d.timestamp;c=e?new Date(parseInt(e,10)).getTime():new Date(d.date).getTime();var f=Date.now();h=f-c,b.save("deltaSec",h)}).catch(function(a){console.error("Could not receive timstamp from server ->",a)})};return{setTime:k,getTime:j}}]),angular.module("services").factory("TreeNode",["$rootScope",function(a){"use strict";var b=function(a,b,c,d){this.label=a,this.data=b,this.iconSymbol=c||"",this.nodes=[],this.isExpanded=!1,this.isVisible=!0,this.isEnabled=!0,this.isActive=!1,d&&(this.needsTranslation=!0)},c=function(b,c){c&&a.$emit("tw.treeNodeStateChange",b)};return b.prototype.addChild=function(a){return a&&(this.nodes.push(a),c(this,1===this.nodes.length)),this},b.prototype.removeAtPosition=function(a){var b=this.nodes.length;return a<0||a>=b?null:(c(this,1===b),this.nodes.splice(a,1)[0])},b.prototype.removeAllChildNodes=function(){for(var a,b=this.nodes.length;a=this.nodes.pop();)a.destroy();c(this,b>0)},b.prototype.isLeafNode=function(){return 0===this.nodes.length},b.prototype.toggleExpand=function(a){this.isExpanded="boolean"==typeof a?a:!this.isExpanded,this.setVisibility(this.isExpanded),c(this,!0)},b.prototype.setActive=function(a){var b=this.isActive!==a;this.isActive=a,c(this,b)},b.prototype.setVisibility=function(a){angular.forEach(this.nodes,function(b){b.isVisible=a,b.isExpanded&&b.setVisibility(a)})},b.prototype.destroy=function(){this.removeAllChildNodes(),this.data=null},b}]),angular.module("services").factory("uploader",["$rootScope","$timeout","$q","$http","StringUtil","bosh","reseller","CONFIG",function(a,b,c,d,e,f,g,h){"use strict";var i=h.globals.MIME_TYPES,j=4096,k={pub:250,cover:1},l={pub:{"application/epub+zip":!0,"application/pdf":!0},cover:{"image/jpeg":!0,"image/png":!0},folder:{}},m={pub:{epub:!0,pdf:!0},cover:{jpeg:!0,jpg:!0,png:!0},folder:{}},n=[],o=[],p=[],q=0,r=null,s=null,t=null,u=!1,v=null,w=function(){return null!==s},x=function(a){if(a){if(a.type)return a.type;if(a.name&&a.size>j){var b=a.name.split(".").pop().toLowerCase();return i[b]}}},y=function(a){return 2e4+Math.round(40*a/1024)},z=function(){if(u=!0,t)return b.cancel(v),t.resolve()},A=function(){t.resolve()},B=function(){b.cancel(v),v=null,t=null},C=function(){return{name:r&&r.name||"",number:q-n.length,total:q}},D=function(b){a.$emit("tw.upload.progress."+b,C())},E=function(b){if(b instanceof File)b=[b];else if(!b||!(b instanceof FileList||b instanceof Array))return s?s.promise:c.reject("no fileList given");w()||(p.length=0);var d=0;if(Array.prototype.forEach.call(b,function(a){var b=P(a);b?p.push(b):(n.push(a),d++)}),q+=d,u=!1,w())D("start");else{if(0===d){var e={success:[],fail:p.slice()};return a.$emit("tw.upload.done",e),c.resolve(e)}s=c.defer(),M()}return s.promise},F=function(b,c){var d;Q(b)||(c.data.metadata.type="EDATA",d=c.data.metadata.title),a.$emit("tw.upload.success",b,c),o.push(d||b.name)},G=function(b,c){c&&0===c.status&&(u=!0),c.fileName=b.name,a.$emit("tw.upload.failed",b,c),p.push(c)},H=function(){if(B(),n.length>0&&!u)return void M();if(u)n.length=0,u=!1,a.$emit("tw.upload.done",!1),s.reject("Upload aborted");else{var b={success:o.slice(),fail:p.slice()};a.$emit("tw.upload.done",b),s.resolve(b)}q=0,o.length=0,p.length=0,s=null,r=null,D("stop")},I=function(a,b,c){var d=new FormData;return d.append("file",a,e.replaceAccentedCharacters(b)),c&&d.append("deliverableId",c),d},J=function(){return c.reject(h.globals.ERROR.APP_NO_CONFIG)},K=function(){return c.reject("HTTP error: Fetch header failed")},L=function(a,b,d,e,f){return g.fetchConfig().then(function(g){var h=d?"cover":"upload",i={method:"POST",url:g.URL_BOOKSHELF+h,data:I(a,b,d),transformRequest:angular.identity,headers:e};return e["Content-Type"]=void 0,f&&(t=c.defer(),i.timeout=t.promise),i},J)},M=function(){var a=n.shift();return a?(r=a,void f.fetchHeader(!0).then(function(c){return Q(a)||D("start"),v=b(A,y(a.size)),L(a,a.name,a.deliverableId,c,!0).then(d).then(F.bind(this,a),G.bind(this,a)).finally(H)},K)):void H()},N=function(a){var b=a?P(a):"no file provided";return b?c.reject(b):f.fetchHeader(!0).then(function(b){return L(a,a.name,a.deliverableId,b).then(d)})},O=function(a,b,c){return f.fetchHeader(!0).then(function(e){return L(a,b,c,e).then(d).catch(function(a){a&&console.warn(a.statusText||a)})})},P=function(a){var b=x(a),c=b?Q(a)?"cover":"pub":"folder",d=a.name,e=d.substr(d.lastIndexOf(".")+1),f=k[c];return l[c][b]||m[c][e.toLowerCase()]?a.size>1024*f*1024?'Unsupported - max. file size exceeded: "'+d+'"':null:'Unsupported - invalid file type: "'+d+'"'},Q=function(a){return!!a.deliverableId};return{coverMaxFileSize:1024*k.cover*1024,addToQueue:E,uploadFile:N,uploadBlob:O,abort:z}}]),angular.module("services").factory("token",["$http","$window","$q","$location","$timeout","$rootScope","hardwareHelper","appState","reseller","CONFIG",function(a,b,c,d,e,f,g,h,i,j){"use strict";var k=null,l=null,m=null,n=function(a){m=a},o=function(){return!b.navigator.onLine||Boolean(m)},p=function(a,b){for(var c=Object.keys(a),d=new RegExp("OAUTH_X_(.*)_KEY"),e=0;e<c.length;e++)c[e].match(d)&&b.push(a["OAUTH_X_"+RegExp.$1+"_KEY"]+"="+a["OAUTH_X_"+RegExp.$1+"_VALUE"]);return b},q=function(){return b.navigator.onLine?i.fetchConfig().then(function(a){var d=b.sessionStorage.getItem("code"),e=b.sessionStorage.getItem("tat");if(k)return k;var g=!1;if(l&&(g=(new Date).getTime()-l>12e4,g&&console.warn("token has expired")),!g&&m&&m!==a.OAUTH_TOKEN_DEMO_USER)return c.resolve(m);if(e)try{var i=b.atob(b.decodeURIComponent(e));return m=i,f.$emit("token"),c.resolve(i)}catch(a){return console.log("TAT parameter is wrong ->"+a),b.sessionStorage.removeItem("tat"),r()}if(d)return b.sessionStorage.removeItem("code"),k=t(d);var j=b.btoa(a.reseller_id),n=h.fetch(j);return n?k=s(n):r()}):(f.$emit("token"),c.reject(j.globals.ERROR.NETWORK_OFFLINE))},r=function(){return h.remove(j.globals.SHELF_REVISION),h.remove(j.globals.SHELF_SYNC_TIME),i.fetchConfig().then(function(a){return a.OAUTH_TOKEN_DEMO_USER?(m=a.OAUTH_TOKEN_DEMO_USER,c.reject(m)):c.reject(!1)},function(){return c.reject(j.globals.ERROR.APP_NO_CONFIG)})},s=function(d){return i.fetchConfig().then(function(f){var i,k=g.getCanvasFingerprint();try{i=b.sjcl.decrypt(k,b.atob(d))}catch(a){return h.remove(b.btoa(f.reseller_id)),c.reject(j.globals.ERROR.APP_INVALID_CRYPTO)}var l=["client_id="+encodeURIComponent(f.OAUTH_CLIENT_ID),"grant_type=refresh_token","refresh_token="+encodeURIComponent(i),"scope="+encodeURIComponent(f.OAUTH_SCOPE)].join("&"),m={"Content-Type":"application/x-www-form-urlencoded"},n=c.defer(),o=e(function(){n.resolve(j.globals.ERROR.NETWORK_TIMEOUT)},1e4);return a({method:"POST",url:f.URL_OAUTH_ACCESSTOKEN,cache:!1,timeout:n.promise,data:l,headers:m}).then(w,x).finally(function(){e.cancel(o)})},function(){return c.reject(j.globals.ERROR.APP_NO_CONFIG)})},t=function(b){return i.fetchConfig().then(function(d){var f=["client_id="+encodeURIComponent(d.OAUTH_CLIENT_ID),"grant_type=authorization_code","code="+encodeURIComponent(b),"scope="+encodeURIComponent(d.OAUTH_SCOPE),"redirect_uri="+encodeURIComponent(d.URL_OAUTH_REDIRECT)];f=p(d,f),f=f.join("&");var g={"Content-Type":"application/x-www-form-urlencoded"},h=d.URL_OAUTH_ACCESSTOKEN,i=c.defer(),k=e(function(){i.resolve(j.globals.ERROR.NETWORK_TIMEOUT)},1e4);return a({method:"POST",url:h,timeout:i.promise,cache:!1,data:f,headers:g}).then(w,x).finally(function(){e.cancel(k)})},function(){return c.reject(j.globals.ERROR.APP_NO_CONFIG)})},u=function(a){return navigator.onLine?i.fetchConfig().then(function(c){var d=["client_id="+c.OAUTH_CLIENT_ID,"response_type=code","scope="+b.encodeURIComponent(c.OAUTH_SCOPE),"redirect_uri="+b.encodeURIComponent(c.URL_OAUTH_REDIRECT)];d=p(c,d);var e=c.CHANNEL_ID;e&&d.push("channelid="+e);var f;return a&&c.URL_OAUTH_AUTOLOGIN?(console.info("Using autoLogin url for authorization"),f=c.URL_OAUTH_AUTOLOGIN+"?"+d.join("&")):f=c.URL_OAUTH_AUTHORIZATION+"?"+d.join("&"),f},function(){return c.reject(j.globals.ERROR.APP_NO_CONFIG)}):c.reject(j.globals.ERROR.NETWORK_OFFLINE)},v=function(){return i.fetchConfig().then(function(d){b.sessionStorage.removeItem("tat");var f,i=g.getCanvasFingerprint(),j=h.fetch(b.btoa(d.reseller_id));if(!j)return A(),c.reject("no refresh token");try{f=sjcl.decrypt(i,b.atob(j))}catch(a){return A(),c.reject("can not decrypt refreshToken")}var k=["client_id="+encodeURIComponent(d.reseller_id),"token_type=refresh_token","token="+encodeURIComponent(f)].join("&"),l={"Content-Type":"application/x-www-form-urlencoded"},m=d.URL_OAUTH_REVOKETOKEN,n=c.defer(),o=e(function(){n.resolve("TIMEOUT")},2e3);return a({method:"POST",url:m,timeout:n.promise,cache:!1,data:k,headers:l}).then(y,z).finally(function(){e.cancel(o)})},function(){return c.reject(j.globals.ERROR.APP_NO_CONFIG)})},w=function(a){return i.fetchConfig().then(function(d){var e=a&&a.data&&a.data.access_token,i=a&&a.data&&a.data.refresh_token,n=a&&a.data&&a.data.expires_in;if(n&&(l=(new Date).getTime()+1e3*n,console.info("Token will expire "+n/60+" minutes")),k=null,e&&i){var o=g.getCanvasFingerprint(),p=b.btoa(sjcl.encrypt(o,i));return h.save(b.btoa(d.reseller_id),p),m=e,f.$emit("token"),e}return c.reject(j.globals.ERROR.APP_INVALID_TOKEN)},function(){return k=null,c.reject(j.globals.ERROR.APP_NO_CONFIG)})},x=function(){return i.fetchConfig().then(function(a){return h.remove(b.btoa(a.reseller_id)),r()},function(){return c.reject(j.globals.ERROR.APP_NO_CONFIG)})},y=function(a){return A(),a.status},z=function(a){return A(),c.reject(a.status)},A=function(){return i.fetchConfig().then(function(a){console.info("Token has been cleared"),m=null,h.remove(b.btoa(a.reseller_id))},function(){return c.reject(j.globals.ERROR.APP_NO_CONFIG)})},B=function(){b.sessionStorage.removeItem("tat"),m=null};return{hasToken:o,setToken:n,fetchToken:q,revokeToken:v,fetchAuthorizeUrl:u,removeAccessToken:B}}]),angular.module("services").factory("user",["$window","$injector","$rootScope","$q","$timeout","$http","token","reseller","cover","CONFIG","browserStorage",function(a,b,c,d,e,f,g,h,i,j,k){"use strict";var l=!1,m=function(a){l=a},n=function(){return l},o=function(){return h.fetchConfig().then(function(){return a.navigator.onLine?g.fetchToken().then(function(){l=!0,c.$emit("login"),c.$emit("tw.activity.indicator.stop","root-indicator")},function(){return c.$emit("loginFailed"),g.fetchAuthorizeUrl().then(function(a){return p(a)})}):(l=!0,e(angular.noop).then(function(){c.$emit("login")}))},function(){return d.reject(j.globals.ERROR.APP_NO_CONFIG)})},p=function(b){return navigator.serviceWorker&&navigator.serviceWorker.controller&&navigator.serviceWorker.controller.postMessage("bosh-purge"),e(function(){c.$emit("tw.activity.indicator.start","root-indicator"),a.location=b},1e3)},q=function(){c.$emit("tw.activity.indicator.start","root-indicator"),navigator.serviceWorker&&navigator.serviceWorker.controller&&navigator.serviceWorker.controller.postMessage("bosh-purge");var d=b.get("bosh"),e=b.get("inventory"),f=b.get("sync"),h=function(){return a.infoforage.clear(),a.localforage.clear()};return f.purge(),d.deleteHardware().then(e.purge,e.purge).then(h,h).then(i.purge,i.purge).then(g.revokeToken,g.revokeToken).then(r,r)},r=function(){var f=b.get("bosh");return f.deleteUser(),h.fetchConfig().then(function(b){l=!1;var d=b.URL_OAUTH_SESSIONKILLER,f=b.URL_SHOP_START_PAGE;if(b.CHANNEL_ID){var g=f.indexOf("?")>-1?"&":"?";f+=g+"channelid="+b.CHANNEL_ID}return d&&(d+="?redirect_uri="+encodeURIComponent(f)),e(angular.noop,100,!0).then(function(){k.clear(),c.$emit("tw.activity.indicator.start","root-indicator"),d?a.location=d:"90"===b.reseller_id?a.location=b.URL_SHOP_EBOOK_START_PAGE:a.location=f})},function(){return d.reject(j.globals.ERROR.APP_NO_CONFIG)})};return{login:o,logout:q,finalLogout:r,isLoggedIn:n,setLoggedIn:m}}]),angular.module("directives").directive("twAbstract",[function(){"use strict";return{restrict:"E",scope:{abstract:"="},templateUrl:"../directives/abstract/abstract.tpl.html",link:function(a){a.fullAbstract=!0,a.toggleAbstract=function(){a.fullAbstract=!a.fullAbstract}}}}]),angular.module("directives").directive("twActionMenu",["$window","$timeout","$rootScope",function(a,b,c){"use strict";return{restrict:"E",templateUrl:"../directives/action-menu/action-menu.tpl.html",transclude:!0,link:function(d,e){var f=angular.element(a),g=null,h=function(b){if(b){var c=8,d=b.srcElement||b.target,f=d.getBoundingClientRect(),h={x:f.left,y:f.top,height:f.height,width:f.width};g=angular.element(e[0].querySelector(".action-menu-content"));var i=g[0].getBoundingClientRect(),j=h.y-c<c?c:h.y-c,k=h.x-c<c?c:h.x-c;k=k-i.width+h.width,k<0&&(k=k-k+c),k+i.width>a.innerWidth&&(k=k+i.width-a.innerWidth-c),g.css({top:j+"px",left:k+"px",visibility:"visible"})}};d.visible=!1,d.positionNeedsToBeCalculated=!0;var i=c.$on("tw.directive.action.menu.hide",function(){d.hideActionMenu()}),j=null;d.showActionMenu=function(a){d.visible=!0,j=h.bind(this,a),b(function(){f.bind("resize",j),h(a),d.positionNeedsToBeCalculated=!1},0)},d.hideActionMenu=function(){d.positionNeedsToBeCalculated=!0,f.unbind("resize",j),j=null,d.visible=!1},d.$on("$destroy",function(){i()})}}}]),angular.module("directives").directive("twActivityIndicator",["$rootScope","activityState",function(a,b){"use strict";return{replace:!0,restrict:"E",scope:{},templateUrl:"../directives/activity-indicator/activity-indicator.tpl.html",link:function(c,d,e){var f=d[0].classList;b.isActive(e.id)&&f.remove("hidden");var g=a.$on("tw.activity.indicator.start",function(a,b){b===e.id&&f.remove("hidden")}),h=a.$on("tw.activity.indicator.stop",function(a,b){b===e.id&&f.add("hidden")});c.$on("$destroy",function(){g(),h()})}}}]),angular.module("directives").factory("activityState",["$rootScope",function(a){"use strict";var b=Object.create(null),c=function(a){return a||"null"};return a.$on("tw.activity.indicator.start",function(a,d){b[c(d)]=!0}),a.$on("tw.activity.indicator.stop",function(a,d){b[c(d)]=!1}),{isActive:function(a){return b[c(a)]}}}]),angular.module("directives").directive("twAnnotationListItem",["$timeout",function(a){"use strict";return{restrict:"E",replace:!0,scope:{model:"="},templateUrl:"../directives/annotation-list-item/annotation-list-item.tpl.html",link:function(b,c){var d=c[0];b.isDogEar=!("endPosition"in b.model),b.isNoteExpanded=!1,b.isNoteMultiLine=null;var e=function(){var a=d.querySelector(".annotation-note");b.isNoteMultiLine=b.model.markerComment&&a&&(a.scrollWidth>a.offsetWidth||a.scrollHeight>a.offsetHeight)};b.removeItem=function(a){a.stopPropagation(),b.$emit("tw.annotation.remove",b.model)},b.editNote=function(a){a.stopPropagation(),b.$emit("tw.annotation.editNote",b.model)},b.toggleExpand=function(a){a.stopPropagation(),d.querySelector(".annotation-note").classList.toggle("expanded"),b.isNoteExpanded=!b.isNoteExpanded},b.goToAnnotation=function(){var a={rmsdkPosition:b.model.rmsdkPosition};b.$emit("tw.bookmark.navigateToBookmark",a)},b.$watch("model.markerComment",function(c,d){c===d&&null!==b.isNoteMultiLine||a(e)})}}}]),angular.module("directives").directive("twAudioMiniPlayer",["$window","$rootScope","audioElement","playlist",function(a,b,c,d){"use strict";return{restrict:"E",scope:{},templateUrl:"../directives/audio-mini-player/audio-mini-player.tpl.html",link:function(e){var f=3e4;e.options={visible:!1},e.playlist=d,e.audio=c;var g=null;e.$on("tw-toggle-button-change",function(a,b){a.stopPropagation(),"pause-play"===b.name&&(c.playing?d.pause():d.play())}),e.skip=function(a){a?d.next():d.prev()},e.seek=function(a){var b=a?f:f*-1;c.seek(c.currentTimeMS+b)};var h=function(b,d){g||(g=angular.element(a.document.getElementsByTagName("body")[0])),e.options.visible=d.show,d&&d.show?g.addClass("mini-player-active"):(g.removeClass("mini-player-active"),c.stop())},i=function(){return c.playing};e.$watch(i,function(a){if(a){if(e.options.visible)return;h(null,{show:!0})}});var j=b.$on("tw.audio.mini.player",h);e.$on("$destroy",function(){e.options=null,e.playlist=null,e.audio=null,j()})}}}]),angular.module("directives").directive("twAudiobookGridItem",["$rootScope","cover","libraryModel","BaseUtil",function(a,b,c,d){"use strict";return{restrict:"E",scope:{deliverable:"=",coverClick:"&"},templateUrl:"../directives/audiobook-grid-item/audiobook-grid-item.tpl.html",link:function(e){e.libModel=c,e.libSelection=c.selection;var f=function(a,b){var c=b?b.blobUri:a.getAttribute("src");e.coverStyles={"background-image":"url("+c+")"}},g=function(){e.coverStyles=null},h=function(){b.requestCover(e.deliverable.cover,!1,!0).then(function(a){if(a.dimensions)return f(null,a);var b=new Image;b.onload=f.bind(null,b,null),b.onerror=g,b.src=a.blobUri},function(a){if(a.dimensions)return f(null,a);var b=new Image;b.onload=f.bind(null,b,null),b.onerror=g,b.src=a.blobUri})};e.onClick=function(){c.selection.isSelectionMode?(c.selection.toggle(e.deliverable.id),event.stopPropagation()):e.coverClick&&e.coverClick()},e.coverStyles=null,e.isCurrent=a.modified===e.deliverable.id,e.isNew=d.isNew(e.deliverable),h()}}}]),angular.module("directives").directive("twAudiobookListItem",["$rootScope","cover","libraryModel","BaseUtil",function(a,b,c,d){"use strict";return{restrict:"E",replace:!0,scope:{deliverable:"=",coverClick:"&"},templateUrl:"../directives/audiobook-list-item/audiobook-list-item.tpl.html",link:function(e){e.libModel=c,e.libSelection=c.selection;var f=function(a,b){var c=b?b.blobUri:a.getAttribute("src");e.coverStyles={"background-image":"url("+c+")"}};e.onSelectionClick=function(a){c.selection.toggle(e.deliverable.id),a.stopPropagation()},e.onClick=function(a){c.selection.isSelectionMode?e.onSelectionClick(a):"audiobook-list-item-meta-menu"!==a.target.className&&e.coverClick&&e.coverClick()};var g=function(){e.coverStyles=null},h=function(){b.requestCover(e.deliverable.cover,!1,!0).then(function(a){if(a.dimensions)return f(null,a);var b=new Image;b.onload=f.bind(null,b,null),b.onerror=g,b.src=a.blobUri},function(a){if(a.dimensions)return f(null,a);var b=new Image;b.onload=f.bind(null,b,null),b.onerror=g,b.src=a.blobUri})},i=function(){if(e.formattedDuration="",e.deliverable.duration){var a=Math.floor(e.deliverable.duration/3600),b=Math.floor(e.deliverable.duration%3600/60);a>0&&(e.formattedDuration+=a+"h "),b>0&&(e.formattedDuration+=b+"min")}};e.coverStyles=null,e.isCurrent=a.modified===e.deliverable.id,e.isNew=d.isNew(e.deliverable),h(),i()}}}]),angular.module("directives").directive("twBasicSlider",["$window","$timeout","BaseUtil",function(a,b,c){"use strict";return{restrict:"E",transclude:!0,scope:{},templateUrl:"../directives/basic-slider/basic-slider.tpl.html",link:function(b,d){b.active=!1;var e=angular.element(a),f=d[0].getElementsByTagName("ng-transclude")[0],g=null,h=0,i=0,j=0,k=0,l=angular.element(d[0].querySelector(".knob")),m=angular.element(d[0].querySelector(".track")),n=m[0].getBoundingClientRect().top,o=m[0].getBoundingClientRect().top,p=function(){j=i/(h/i),j<10&&(j=10),l[0].style.height=j+"px"},q=function(a){var b=l[0].getBoundingClientRect().top-n,c=b+a;return c<0?l[0].style.top="0px":c>i-j?l[0].style.top=i-j+"px":l[0].style.top=c+"px",a},r=function(a){var b=h/i,c=k+b*a;return c<0?c=0:c>h-i&&(c=h-i),g=f.firstElementChild,g&&(g.scrollTop=c),k=c,a},s=function(){if(l.unbind("mousedown",y),m.unbind("click",v),e.unbind(t(),u),g=f.firstElementChild)if(i=g.clientHeight,h=g.scrollHeight,h>i){p(),b.active=!0;var a=l[0].getBoundingClientRect().top-n;a>i?(o=m[0].getBoundingClientRect().top,w({clientY:i-j})):(o=m[0].getBoundingClientRect().top,l[0].style.top="0px",k=0,g.scrollTop=k),l.bind("mousedown",y),m.bind("click",v),e.bind(t(),u)}else b.active=!1;else b.active=!1},t=function(){return c.isEventSupported("wheel")?"wheel":"mousewheel"},u=function(a){var b=10,c=40,d=800,e=0,f=0,g=0,h=0;"detail"in a&&(f=a.detail),"wheelDelta"in a&&(f=-a.wheelDelta/120),"wheelDeltaY"in a&&(f=-a.wheelDeltaY/120),"wheelDeltaX"in a&&(e=-a.wheelDeltaX/120),"axis"in a&&a.axis===a.HORIZONTAL_AXIS&&(e=f,f=0),g=e*b,h=f*b,"deltaY"in a&&(h=a.deltaY),"deltaX"in a&&(g=a.deltaX),(g||h)&&a.deltaMode&&(1===a.deltaMode?(g*=c,h*=c):(g*=d,h*=d)),g&&!e&&(e=g<1?-1:1),h&&!f&&(f=h<1?-1:1),r(q(h))},v=function(a){"knob"!==a.target.className&&w(a)},w=function(a){var b=a.clientY,c=b-o;o=b,r(q(c))},x=function(){e.unbind("mousemove",w),e.unbind("mouseup",x)},y=function(a){o=a.clientY,e.bind("mousemove",w),e.bind("mouseup",x)},z=window.MutationObserver||window.WebKitMutationObserver,A=new z(s);A.observe(f,{childList:!0,subtree:!0});var B=c.getDebouncedFunction(s,200);e.bind("resize",B),b.$on("$destroy",function(){e.unbind("resize",B),A.disconnect(),A=null})}}}]),angular.module("directives").directive("collectionAddDialog",["$rootScope","$translate","CONFIG","stateHelper",function(a,b,c,d){"use strict";return{restrict:"E",scope:{},templateUrl:"../directives/collection-add-dialog/collection-add-dialog.tpl.html",link:function(b){b.dialogOptions={isModal:!0,isVisible:!1};var e=a.$on("tw.collection.items.added",function(a,e,f){var g=b.dialogOptions;g.dialogText=f>1?gettext("TITLES_WERE_SUCCESSFULLY_ADDED_TO_COLLECTION"):gettext("TITLE_WAS_SUCCESSFULLY_ADDED_TO_COLLECTION"),g.translationData={collectionName:e,numItems:f},g.dialogTimeoutInterval=c.globals.MISC.DIALOG_FADEOUT_TIME,g.dialogTimeoutCallback=function(){d.goToLastKeyState()},g.isVisible=!0});b.$on("$destroy",e)}}}]),angular.module("directives").directive("twCollectionDeleteDialog",["$rootScope","$timeout","CONFIG","appState","collections",function(a,b,c,d,e){"use strict";return{restrict:"E",scope:{},templateUrl:"../directives/collection-delete-dialog/collection-delete-dialog.tpl.html",link:function(b){b.options={isModal:!0,isVisible:!1,collectionNames:[],dontShowDialogAgain:!!d.fetch(c.globals.STORE.COLLECTION_DELETE_DIALOG)},b.onChangeDontShowDialogAgain=function(){d.save(c.globals.STORE.COLLECTION_DELETE_DIALOG,b.options.dontShowDialogAgain)},b.cancelDialog=function(){b.options.isVisible=!1},b.deleteCollections=function(){b.options.collectionNames.forEach(function(a){e.remove(a)}),b.cancelDialog(),a.$emit("tw.collection.update")};var f=a.$on("tw.collection.dialog.delete",function(a,c){b.options.collectionNames=c instanceof Array?c:[c],b.options.dontShowDialogAgain?b.deleteCollections():(b.dialogTitle=b.options.collectionNames.length>1?gettext("DELETE_COLLECTIONS"):gettext("DELETE_COLLECTION"),
b.options.isVisible=!0)});b.$on("$destroy",f)}}}]),angular.module("directives").directive("twCollectionEditDialog",["$rootScope","$translate","$timeout","stateHelper","mybooks","collections",function(a,b,c,d,e,f){"use strict";return{restrict:"E",scope:{},templateUrl:"../directives/collection-edit-dialog/collection-edit-dialog.tpl.html",link:function(g,h){function i(a){g.options.collectionName=a,g.currentCollectionName=a,g.options.isVisible=!0,c(function(){h.find("input")[0].focus()})}var j=d.getCurrentState().state.name,k=d.getCurrentState().params;g.options={isModal:!0,isVisible:!1,collectionName:""},g.isValidCollectionName=!1,g.currentCollectionName="",g.collectionNameHint="",g.onInputChange=function(){var a=g.options.collectionName,c=a&&f.isValidName(a);c?(g.isValidCollectionName=a!==g.currentCollectionName&&a.toLowerCase()===g.currentCollectionName.toLowerCase()||!f.exists(a),g.collectionNameHint=g.isValidCollectionName?"":b.instant(gettext("COLLECTION_NAME_EXISTS"),{name:a})):(g.isValidCollectionName=!1,g.collectionNameHint=a?b.instant(gettext("COLLECTION_NAME_INVALID")):"")},g.onKeyUp=function(a){13===a.keyCode&&g.isValidCollectionName?(a.stopPropagation(),g.editCollection()):27===a.keyCode&&g.cancelDialog()},g.cancelDialog=function(){g.options.collectionName="",g.collectionNameHint="",g.options.isVisible=!1,h.find("input")[0].blur()},g.editCollection=function(){if(g.options.isVisible=!1,h.find("input")[0].blur(),g.currentCollectionName)f.rename(g.currentCollectionName,g.options.collectionName)&&a.$emit("tw.collection.rename",g.currentCollectionName,g.options.collectionName);else{var b=/audiobook/i.test(j)?"AUDIOBOOK":"EBOOK";f.add(g.options.collectionName,b),"addToCollection"===k.action?(f.selection.isSelectionMode=!1,d.goToState(e.getStateName("collections.titles"),{name:g.options.collectionName,action:k.action})):(d.setAsKeyState(),d.goToState(e.getStateName("selection"),{action:"addToCollection",ref:g.options.collectionName}))}};var l=[];l.push(a.$on("tw.collection.dialog.create",function(){g.dialogTitle=b.instant(gettext("CREATE_NEW_COLLECTION")),g.buttonLabel=b.instant(gettext("COMMON_CREATE")),i("")})),l.push(a.$on("tw.collection.dialog.rename",function(a,c){g.dialogTitle=b.instant(gettext("RENAME_COLLECTION")),g.buttonLabel=b.instant(gettext("COMMON_RENAME")),i(f.getTitle(c)||"")})),g.$on("$destroy",function(){h[0].blur();for(var a;a=l.pop();)a()})}}}]),angular.module("directives").directive("twCollectionGridItem",["$rootScope","$q","$timeout","BaseUtil","cover","collections","inventory","libraryModel","collectionContextMenu","stateHelper","CONFIG",function(a,b,c,d,e,f,g,h,i,j,k){"use strict";return{restrict:"E",replace:!0,scope:{collection:"="},templateUrl:"../directives/collection-grid-item/collection-grid-item.tpl.html",link:function(a,l){var m=.8,n=14/9,o=2,p=[{pWidth:.8/n,pRight:.8/n},{pWidth:.46,pRight:.7},{pWidth:.41,pRight:.87},{pWidth:.37,pRight:1}],q=p.length,r=l[0];a.numItems=a.collection.items.length;var s=a.collSelect=f.selection,t=!0,u=function(b){var c=h.getSortOrder(),d=g.sortDeliverables(c,a.collection.items);return d.slice(0,b)},v=function(){var a=r.querySelector("canvas.collection-preview"),f=d.getComputedStyle(r,"width"),g=u(q),h=[];a.width=f,a.height=f*m,g.forEach(function(a){h.push(e.requestCover(a.cover).then(w,w))}),b.all(h).then(function(b){for(var d=q-1;d>=0;d--)x(b[d],a,d);t?c(y.bind(null,b)):y(b)})},w=function(a){var c=b.defer();if(t=!1,a&&a.dimensions){var d=a.image=new Image;return d.onload=d.onerror=function(b){"error"===b.type&&(a.image=null),d.onload=d.onerror=null,c.resolve(a)},d.src=a.blobUri,c.promise}return a},x=function(a,b,c){var d=z(a,b,c),e=b.getContext("2d");if(a&&a.image){if(e.drawImage(a.image,0,0,a.dimensions.width,a.dimensions.height,d.x,d.y,d.width,d.height),0===c)e.fillStyle="rgba(0, 0, 0, 0.06)";else{var f=e.createLinearGradient(d.x,0,d.x+d.width,0);f.addColorStop(0,"rgba(0, 0, 0, 0.55)"),f.addColorStop(1,"rgba(0, 0, 0, 0.05)"),e.fillStyle=f}e.fillRect(d.x,d.y,d.width,d.height)}else e.fillStyle="#ffffff",e.fillRect(d.x+1,d.y+1,d.width,d.height),e.lineWidth=2,e.strokeStyle="rgb(224, 224, 224)",e.strokeRect(d.x,d.y,d.width,d.height)},y=function(a){var b=r.querySelector("canvas.collection-mask");if(b){var c=b.getContext("2d"),e=d.getComputedStyle(r,"width");b.width=e,b.height=e*m,c.fillStyle="white",c.fillRect(0,0,b.width,b.height),c.beginPath();for(var f=q-1;f>=0;f--){var g=z(a[f],b,f);c.rect(g.x-1,g.y-1,g.width+2,g.height+2)}c.closePath(),c.clip(),c.clearRect(0,0,b.width,b.height)}},z=function(a,b,c){var d,e,f,g=p[c].pWidth*b.width,h=Math.min(b.height-o,g*n),i=Math.max(o,p[c].pRight*b.width-g),j=Math.max(o,b.height-h);return a?(d=a.dimensions.height/a.dimensions.width,d<=1?(h=g*d,j=b.height-h):d>16/9&&(e=g,g=h/d,f=e-g,i+=0===c?f:f/2)):(i-=1,j-=1),{x:i,y:j,width:g,height:h}},A=function(b){b.stopPropagation(),b.preventDefault(),i.showContextMenu(b,a.collection)};a.isContextMenuEnabled=!/collections.selection$/i.test(j.getCurrentState().state.name),a.isContextMenuEnabled&&(l.on("contextmenu",A),a.showContextMenu=A),a.onCollectionClick=function(){s.isSelectionMode?s.toggle(a.collection.id):a.$emit("open",a.collection.id)},a.$on("$destroy",function(){l.off("contextmenu",A)}),v(),a.collection.category!==k.globals.MISC.COLLECTION_CATEGORY&&s.setDisabled(a.collection.id,!0)}}}]),angular.module("directives").directive("twCollectionListItem",["$rootScope","collections","collectionContextMenu","stateHelper","CONFIG",function(a,b,c,d,e){"use strict";return{restrict:"E",replace:!0,scope:{collection:"="},templateUrl:"../directives/collection-list-item/collection-list-item.tpl.html",link:function(a,f){a.numItems=a.collection.items.length;var g=a.collSelect=b.selection,h=function(b){b.stopPropagation(),b.preventDefault(),c.showContextMenu(b,a.collection)};a.isContextMenuEnabled=!/collections.selection$/i.test(d.getCurrentState().state.name),a.isContextMenuEnabled&&(f.on("contextmenu",h),a.showContextMenu=h),a.onCollectionClick=function(){g.isSelectionMode?g.toggle(a.collection.id):a.$emit("open",a.collection.id)},a.onSelectClick=function(b){g.toggle(a.collection.id),b.stopPropagation()},a.$on("$destroy",function(){f.off("contextmenu",h)}),a.collection.category!==e.globals.MISC.COLLECTION_CATEGORY&&g.setDisabled(a.collection.id,!0)}}}]),angular.module("directives").directive("twCollectionRemoveDeliverableDialog",["$rootScope","$timeout","CONFIG","appState","collections","libraryModel","stateHelper",function(a,b,c,d,e,f,g){"use strict";return{restrict:"E",scope:{},templateUrl:"../directives/collection-remove-deliverable-dialog/collection-remove-deliverable-dialog.tpl.html",link:function(b){b.options={isModal:!0,isVisible:!1,collectionName:"",dontShowDialogAgain:!!d.fetch(c.globals.STORE.COLLECTION_DELETE_DIALOG)},b.onChangeDontShowDialogAgain=function(){d.save(c.globals.STORE.COLLECTION_DELETE_DIALOG,b.options.dontShowDialogAgain)},b.cancelDialog=function(){b.options.isVisible=!1,f.selection.reset(),g.goToLastVisitedState()},b.removeDeliverables=function(){var a=b.options.collectionName;for(var c in f.selection.selectedItems)e.removeDeliverable(a,c);e.isEmpty(a)&&e.retainCollection(a),b.cancelDialog()};var h=a.$on("selection-header-bar",function(a,c,d){"REMOVEFROMCOLLECTION"===c&&(b.options.collectionName=d,b.options.dontShowDialogAgain?b.removeDeliverables():b.options.isVisible=!0)});b.$on("$destroy",function(){h()})}}}]),angular.module("directives").directive("twConflictDialog",["$rootScope","sync","$timeout",function(a,b,c){"use strict";return{restrict:"E",scope:{},templateUrl:"../directives/conflict-dialog/conflict-dialog.tpl.html",link:function(d){var e=[],f=function(a,b){if(b&&b.clientState&&b.serverState){d.clientState=b.clientState,d.serverState=b.serverState;var e=b.clientState.path;e.indexOf("audiobook")>=0?(d.options.dialogTitle=gettext("ERROR_SYNC_INCONSISTENT_BOOKMARKS_AUDIO_TITLE"),d.options.dialogText=gettext("ERROR_SYNC_INCONSISTENT_BOOKMARKS_AUDIO_TEXT"),d.continue=gettext("COMMON_CONTINUE")):(d.continue=gettext("COMMON_SWITCH"),d.options.dialogTitle=gettext("ERROR_SYNC_INCONSISTENT_BOOKMARKS_TITLE"),d.options.dialogText=gettext("ERROR_SYNC_INCONSISTENT_BOOKMARKS_TEXT"),d.options.translationData={currentPage:b.clientState.value.currentPosition,newPage:b.serverState.value.currentPosition}),d.options.isVisible=!0}return c(angular.noop)};d.options={isModal:!0,isVisible:!1,translationData:null},d.selectOption=function(a){b.handleConflict(a),d.options.translationData=null,d.options.isVisible=!1},e.push(a.$on("tw.component.conflict",f)),e.push(d.$on("$destroy",function(){for(var a=e&&e.length||0,b=0,c=a;b<c;b++)e[b]&&e[b]();d.options=null}))}}}]),angular.module("directives").directive("twContextMenu",[function(){"use strict";return{restrict:"E",replace:!0,scope:{},templateUrl:"../directives/context-menu/context-menu.tpl.html",controller:"twContextMenuCtrl",link:function(a,b,c,d){d.init(b)}}}]).controller("twContextMenuCtrl",["$rootScope","$scope","$window","$timeout","BaseUtil",function(a,b,c,d,e){"use strict";var f,g,h,i=function(c){var f=e.getElementBelow(c.target,c.clientX,c.clientY,2);a.$emit("tw.contextMenu.update",b.options.menuId,f,c.clientX,c.clientY,!0),b.options.isVisible&&d(k,0)},j=function(a){return Object.keys(a).filter(function(b){return a[b].isVisible}).length},k=function(){var a=b.options,d=a.bbox||{left:0,top:0,right:c.innerWidth,bottom:c.innerHeight},e=f.querySelector(".context-menu").getBoundingClientRect(),g=e.width||192,h=e.height||36*j(a.items),i=Math.min(d.right,c.innerWidth),k=Math.min(d.bottom,c.innerHeight),l=a.x+d.left,m=a.y+d.top;l+g>i&&(l=Math.max(0,l-g)),m+h>k&&(m=Math.max(0,m-h)),b.contextMenuPosition.left=l+"px",b.contextMenuPosition.top=m+"px"},l=function(){f.removeEventListener("click",o,!1),f.removeEventListener("mousedown",p,!1),f.removeEventListener("touchstart",p,!1),angular.element(window).off("resize",m),b.options.isVisible=!1,b.options.param=null,b.$evalAsync()},m=function(b){l(),document.getSelection().removeAllRanges(),a.$emit("tw.reader.interactions",!0),b&&b.stopPropagation()},n=function(a){var c=b.options;!c.isVisible||a.clientX===c.x&&a.clientY===c.y||i(a),a.preventDefault(),a.stopImmediatePropagation()},o=function(){h&&m(),h=!1},p=function(){h=!0};b.contextMenuPosition={},b.execContextMenu=function(c,d,e){if(d.isEnabled){var f=b.options;a.$emit("tw.contextMenu.action",{action:c,menuId:f.menuId,param:f.param,x:f.x,y:f.y,menuItem:d,selectedRange:g}),g=null,e.stopPropagation(),e.stopImmediatePropagation(),l()}};var q=a.$on("tw.contextMenu.visibility",function(a,h){if(h.isVisible){if(b.options=h,c.Modernizr.isie||c.Modernizr.isedge){var i=h.param&&h.param.ownerDocument;g=e.getSelectedRange(i)}f.addEventListener("click",o,!1),f.addEventListener("mousedown",p,!1),f.addEventListener("touchstart",p,!1),angular.element(window).on("resize",m),d(k,0)}});b.$on("tw.longpress",function(a,b){var c=f.querySelector(".context-menu-modal");b.target===c&&i(b),h=!1}),b.$on("$destroy",function(){q()}),this.init=function(a){f=a[0],a.bind("contextmenu",n),c.Modernizr.isie&&a.bind("mousewheel",function(a){a.preventDefault()})}}]),angular.module("directives").directive("twCoverFlow",["$window","$rootScope","$timeout","$q","BaseUtil","cover","libraryModel","CONFIG",function(a,b,c,d,e,f,g,h){"use strict";return{replace:!1,restrict:"E",templateUrl:"../directives/cover-flow/cover-flow.tpl.html",scope:{deliverables:"=",itemAction:"&"},link:function(i,j){var k=h.globals.MISC.TAP_TRESHOLD,l=.55,m=.75,n=56,o="cover-flow-item-cover",p=200,q=768,r=j[0],s=r.querySelector(".scroll-container"),t=null,u=null,v=null,w=function(a){a=a.constructor!==Boolean||a,a===!0?r.classList.add("visible"):r.classList.remove("visible")},x=function(a){if(a&&a.dataset&&a.dataset.index)return parseInt(a.dataset.index)},y=function(a){for(var b=s.children,c=0,d=b.length;c<d;c++){var e=x(b[c]);if(a===e)return b[c]}},z=function(b,c,d){a.fastdom.mutate(function(){s.style.transform="translate3d("+-b+"px,"+-c+"px,0) scale("+d+")"})},A=function(){return a.fdp.measure(function(){return{rootBBox:r.getBoundingClientRect(),scrollerBBox:s.getBoundingClientRect(),scrollerLeftMargin:parseInt(e.getComputedStyle(s,"margin-left"),10)}}).then(function(a){V.setDimensions(a.rootBBox.width,a.rootBBox.height,a.scrollerBBox.width+a.scrollerLeftMargin,a.scrollerBBox.height)})},B=function(a,b){if("touches"in a){var c=a.changedTouches[0]||a.touches[0]||{};return c[b]}return a[b]},C=function(a){a.preventDefault(),V.doTouchEnd(a.timeStamp),G(!1)},D=function(b){a.fastdom.mutate(function(){s.style.pointerEvents="none !important"}),V.doTouchMove([{pageX:B(b,"pageX"),pageY:0}],b.timeStamp)},E=function(b){if(!(b.button>0)){C(b);var d=B(b,"pageX"),e=B(b,"pageY");if(!(Math.abs(t-d)>k||Math.abs(u-e)>k)){var f=a.document.elementsFromPoint(d,e);f.some(function(a){return a.classList.contains(o)?(L(a.parentElement),c(function(){N(a.parentElement),P()},p),!0):a.classList&&a.classList.contains("context-menu-container")})}}},F=function(a){a.button>0||(t=B(a,"pageX"),u=B(a,"pageY"),G(!0),V.doTouchStart([{pageX:t,pageY:0}],a.timeStamp))},G=function(a){var b=a?j.bind:j.unbind;b.call(j,"mousemove",D),b.call(j,"mouseup",E),b.call(j,"mouseleave",C),b.call(j,"touchmove",D),b.call(j,"touchend",E),b.call(j,"touchleave",C)},H=function(a,b){a.cover.url=b.blobUri},I=function(){for(var a,b=r.getBoundingClientRect(),c=s.getBoundingClientRect().height-n,d=b.width/2,e=i.coverFlowItems,f=0,g=e.length;f<g;f++)a="AUDIOBOOK"===e[f].type?1:9/13,c*a>=d&&(c=d*(1/a)),e[f].cover.dimensionsNotFocused={height:c*l,width:c*l*a,marginTop:(c-c*l)/2,marginBottom:0},e[f].cover.dimensionsFocused={height:c*m,width:c*m*a,marginTop:(c-c*m)/2,marginBottom:0}},J=function(){return a.fdp.measure(function(){return{rootBBox:r.getBoundingClientRect(),scrollerBBox:s.getBoundingClientRect(),scrollerLeftMargin:parseInt(e.getComputedStyle(s,"margin-left"),10),lastNodeBBox:s.lastElementChild.previousElementSibling.getBoundingClientRect(),lastNodeRightMargin:parseInt(e.getComputedStyle(s.lastElementChild.previousElementSibling,"margin-right"),10)}}).then(function(a){var b;if(a.rootBBox.width<q)b=a.rootBBox.width/2-a.lastNodeBBox.width/2-a.lastNodeRightMargin;else{var c=a.rootBBox.left+a.scrollerLeftMargin,d=a.rootBBox.right-c;b=d-a.lastNodeBBox.width}i.scrollContainerSpacerWidth=b,i.$apply()})},K=function(a,b){var c=i.coverFlowItems[a];if(c&&c.isFocused)return void(i.itemAction&&i.itemAction({id:c.id}));for(var d=0,e=i.coverFlowItems.length;d<e;d++)i.coverFlowItems[d].isFocused=!1;c.isFocused=!0,v=a,b!==!0&&i.$apply()},L=function(a){var b=x(a);b>-1&&K(b)},M=function(a){var b=y(a);b&&N(b)},N=function(b){a.fdp.measure(function(){return{windowBBox:document.body.getBoundingClientRect(),rootBBox:r.getBoundingClientRect(),scrollerBBox:s.getBoundingClientRect(),nodeBBox:b.getBoundingClientRect()}}).then(function(a){var b,c=a.windowBBox.width>q?"left":"center",d=a.nodeBBox.left-a.scrollerBBox.left;if("left"===c)s.style.marginLeft=null,b=d;else{var e=(d+a.nodeBBox.width)/2,f=a.rootBBox.width/2;e<f&&(s.style.marginLeft=f-d+"px");var g=a.nodeBBox.width/2;b=d+g}V.scrollTo(b,0,!0)})},O=function(a){if(a){var c={id:a.id,type:a.type,title:a.title,author:a.author,bookmark:a.bookmark,badges:{isCurrent:b.modified===a.id,isNew:e.isNew(a),isSample:a.isSample,isOffline:a.isOffline},progress:{currentPage:a.bookmark.currentPage||null,lastAvailablePage:a.bookmark.lastPage||null,progress:a.bookmark.progress||null,isFinished:a.isFinished},cover:{url:"//:0",urlFallback:"//:0",dimensionsNotFocused:{width:0,height:0,marginTop:0,marginBottom:0},dimensionsFocused:{width:0,height:0,marginTop:0,marginBottom:0}},isFocused:!1};return a.type&&"AUDIOBOOK"===a.type?c.cover.urlFallback=h.globals.MEDIA.IMAGE_DEFAULT_AUDIO:c.cover.urlFallback=h.globals.MEDIA.IMAGE_DEFAULT_PUB,i.coverFlowItems.push(c),c}},P=function(a){return c(function(){J().then(function(){A().then(function(){a===!0&&w(!0)})})},p)},Q=function(){c(function(){i.animationsEnabled=!0},2*p)},R=function(a){if(a&&a.length>0){i.coverFlowItems=[];for(var c,e=[],g=0,h=a.length;g<h;g++){c=O(a[g]);var j=a[g].type&&"AUDIOBOOK"===a[g].type;e.push(f.requestCover(a[g].cover,!1,j).then(H.bind(this,c),function(a){console.warn("Could not load cover for the following deliverable. Using fallback cover.",a)}.bind(this,c)))}return b.$applyAsync(function(){I(),K(0,!0),M(0),P(!0)}),d.allComplete(e).finally(Q)}i.coverFlowItems=null},S=function(){I(),c(function(){A().then(function(){var a=y(v);N(a)})},1.5*p)},T=function(){angular.element(a).unbind("resize",S),v=null},U=function(){j.bind(a.normalizeWheel.getEventType(),function(b){b.stopPropagation(),b.preventDefault();var c=a.normalizeWheel.normalize(b);c&&c.pixelY&&V.scrollBy(c.pixelY,0)}),j.bind("mousedown",F),j.bind("touchstart",F)};i.coverFlowItems=[],i.scrollContainerSpacerWidth=0,i.animationsEnabled=!1,i.libModel=g,i.$watch("deliverables",R),angular.element(a).bind("resize",S),i.$on("$destroy",T),U();var V=new a.Scroller(z,{scrollingY:!1})}}}]),angular.module("directives").directive("twCoverInfo",["cover","CONFIG","user","BaseUtil",function(a,b,c,d){"use strict";return{restrict:"E",scope:{deliverable:"="},templateUrl:"../directives/cover-info/cover-info.tpl.html",link:function(e){e.coverUrl=b.globals.MEDIA.IMAGE_DEFAULT_PUB,e.deliverable=null,e.loggedIn=c.isLoggedIn(),e.$watch("deliverable",function(b){return e.deliverable=b,e.isNew=d.isNew(b),b&&b.cover?a.requestCover(b.cover).then(function(a){e.coverUrl=a.blobUri},f):void f()});var f=function(){e.coverUrl=b.globals.MEDIA.IMAGE_DEFAULT_PUB};e.edit=function(){e.$emit("cover.info.edit")},e.download=function(){e.$emit("cover.info.download")},e.notes=function(){e.$emit("cover.info.note")}}}}]),angular.module("directives").directive("twDeleteDialog",["$window","$rootScope","libraryModel","bosh","$translate",function(a,b,c,d,e){"use strict";return{restrict:"E",scope:{},templateUrl:"../directives/delete-dialog/delete-dialog.tpl.html",link:function(f){var g=null,h=b.$on("tw.contextMenu.action",function(a,b){"ctxMenuLib"===b.menuId&&"DELETE"===b.action&&(f.options.isVisible=!0,g=b.param)}),i=b.$on("selection-header-bar",function(c,h){if("DELETE"===h){if(!d.isBoshOnline())return e(a.gettext("ERROR_OFFLINE")).then(function(a){b.$emit("tw.component.error",{message:a})}).catch(function(a){console.warn("Missing translation ->"+a)});c.stopPropagation(),g=null,f.options.isVisible=!0}});f.options={isModal:!0,isVisible:!1},f.confirm=function(){f.$emit("delete-dialog-confirm",{selectedPub:g}),f.options.isVisible=!1},f.close=function(){c.selection.clearSelection(),f.options.isVisible=!1,b.$emit("tw.headerBar.cancelDeleteMode")},f.$on("$destroy",function(){h(),i()})}}}]),angular.module("directives").directive("twDialog",["$window","$timeout","$translate","$rootScope",function(a,b,c,d){"use strict";return{replace:!0,restrict:"E",templateUrl:"../directives/dialog/dialog.tpl.html",transclude:!0,scope:{show:"=",options:"=",dialogTitle:"@",dialogText:"@",dialogAction:"&",translationData:"@"},link:function(a,e,f){var g=null,h=function(){i();var c=a.options.dialogTimeoutCallback||a.closeDialog;g=b(c,a.options.dialogTimeoutInterval)},i=function(){null!==g&&(b.cancel(g),g=null)},j=function(b){b&&(d.$emit("tw.directive.action.menu.hide"),a.options.dialogTimeoutInterval>0?h():i())},k=function(b,d){if(d){var e=a.options.translationData||a.translationData;c(d,e).then(function(c){a[b]=c}).catch(function(a){console.warn("Missing translation ->"+a)})}};a.dialogStyles={width:f.width||"400px",height:f.height||"auto"},a.closeDialog=function(){a.show=!1,"isVisible"in a.options&&(a.options.isVisible=!1)},a.$watch("options.dialogTitle",k.bind(this,"dialogTitle")),a.$watch("options.dialogText",k.bind(this,"dialogText")),a.$watch("options.translationData",function(){a.options&&k("dialogText",a.options.dialogText)},!0),a.$watch("options.isVisible",j),a.$watch("show",j)}}}]),angular.module("directives").directive("twDownloadDialog",[function(){"use strict";return{restrict:"E",replace:!1,scope:{},templateUrl:"../directives/download-dialog/download-dialog.tpl.html",controller:"twDownloadDialogCtrl",link:function(a,b,c,d){d.init(b)}}}]).controller("twDownloadDialogCtrl",["$window","$translate","$rootScope","$scope","$timeout","cover","image","inventory","download","URLManager","CONFIG",function(a,b,c,d,e,f,g,h,i,j,k){"use strict";function l(){d.coverURL=g.getFallbackImage(),d.pubTitle="",d.pubAuthor="",d.progress=0,d.downloadLink=null,d.downloadInProgress=!1,d.deliverable=null,t=null,s.removeAttribute("href")}function m(){d.downloadInProgress=!1}function n(a){d.coverURL=a.blobUri}function o(){d.coverURL=g.getFallbackImage(d.deliverable.format)}function p(){d.deliverable=null,e(l,0)}function q(b){if(b.url&&(d.downloadLink=b.url,t=b.key,s.setAttribute("href",b.url),"bosh"===b.location)){var c=b.format.indexOf("epub")>-1?"epub":"pdf",e=d.deliverable.title.replace(/[^a-z0-9\.\-]+/gi,"_")+"."+c;s.download=e,(a.Modernizr.isie||a.Modernizr.isedge)&&(s.onclick=function(c){c.preventDefault(),a.navigator.msSaveOrOpenBlob(b.blob,e),s.onclick=null})}m()}function r(a){a!==k.globals.ERROR.ABORT&&c.$emit("directives.error",a),m()}var s,t=null;d.deliverable=null,d.coverURL=null,d.pubTitle="",d.pubAuthor="",d.progress=0,d.downloadInProgress=!1,d.downloadLink=null,c.$on("tw.library.download",function(e,g){var j=d.deliverable=h.deliverables[g];if(j&&(j.cover?f.requestCover(j.cover).then(n,o):o(),d.pubTitle=j.title,d.pubAuthor=j.author,"EDATA"===j.type)){if(!a.Modernizr.issafari)return d.downloadInProgress=!0,i.fetchDownloadLink(g).then(q,r);l();var k=b.instant(gettext("COMMON_FEATURE_UNSUPPORTED"));c.$emit("tw.component.error",{message:k})}}),d.$on("tw.download.progress",function(a,b){b&&d.deliverable&&b.id===d.deliverable.id&&(d.progress=b.total>0?Math.round(100*b.loaded/b.total):0,e(angular.noop,0))}),d.$on("$destroy",function(){s=null,l()}),d.requestDownloadLink=function(){return d.downloadInProgress=!0,i.fetchDownloadLink(d.deliverable.id).then(q,r)},d.clickDownloadLink=function(){return e(function(){d.closeDialog(),c.$emit("tw.library.download.close")},1500,!0)},d.closeDialog=function(){i.abort(),t&&j.revokeURL(t),p()},this.init=function(a){s=a.find("a")[0],l()}}]),angular.module("directives").directive("twDropdownList",[function(){"use strict";return{restrict:"E",replace:!0,scope:{listItems:"=",selectedItem:"="},templateUrl:"../directives/dropdown-list/dropdown-list.tpl.html",controller:"twDropdownCtrl",link:function(a,b,c,d){d.init(b)}}}]).controller("twDropdownCtrl",["$scope","$document",function(a,b){"use strict";var c=null,d=function(b){a.selectedItem=b,a.selectedItemLabel=b.label||b.id||""},e=function(){a.isListVisible=!0,a.icon="▲",b.bind("click",g)},f=function(){a.isListVisible=!1,a.icon="▼",b.unbind("click",g)},g=function(b){var d=b&&b.target;c===d||c.contains(d)||a.$apply(f)};a.toggleListVisibility=function(){a.isListVisible?f():e()},a.selectItem=function(a){d(a),f()},a.$watch("listItems",function(){a.selectedItem||a.selectItem(a.listItems[0])}),this.init=function(b){c=b[0],a.isListVisible=!1,a.icon="▼",a.selectedItem||(a.selectedItem=a.listItems[0]);for(var e=0;e<a.listItems.length;e++){var f=a.listItems[e];if(f.id===a.selectedItem.id)return void d(f)}}}]),angular.module("directives").directive("twEmptyList",["$window","reseller",function(a,b){"use strict";return{restrict:"E",replace:!0,transclude:!0,scope:{iconName:"@",headline:"@",text:"@",type:"@"},templateUrl:"../directives/empty-list/empty-list.tpl.html",link:function(c){c.shopURL=null,void 0!==c.type&&b.fetchConfig().then(function(a){if(c.shopURL="EBOOK"===c.type&&a.URL_SHOP_EBOOK_START_PAGE||"AUDIO"===c.type&&a.URL_SHOP_AUDIO_START_PAGE||a.URL_SHOP_START_PAGE,a.CHANNEL_ID){var b=c.shopURL.indexOf("?")>-1?"&":"?";c.shopURL+=b+"channelid="+a.CHANNEL_ID}}),c.onButtonClick=function(){a.location=c.shopURL}}}}]),angular.module("directives").directive("epubSection",["$compile","$document","$q","$rootScope","$timeout","$window","Annotations","appState","BaseUtil","CONFIG","contentProvider","CSSPropertyStore","FontStore","HTML","imageUtil","PageLocation","PagePartitioner","PageNavHelper","ScriptSupport",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s){"use strict";return{restrict:"E",replace:!0,scope:{sectionId:"@",sectionData:"=",settings:"="},template:'<iframe class="tolino-web-reader" src="about:blank" scrolling="no"></iframe>',link:function(t,u){function v(a){if(!a)return void x();var b=ra.fileName,c=k.getEPubInfo().rootFolder,d=k.getFiles();return Ka.setEPubData(d,c,ra.deliverable.id),Fa.clear(),y(a).then(function(){return za=ya.querySelector("body"),Ia.setFileName(b),Ia.setRootNode(ya.documentElement),Ga.setContentDocument(ya),J(),F(),M(),Ha.setPageLocation(ya,b),da(),w(),k.getMediaOverlay().then(oa,oa),B(),za.addEventListener(i.getPrefixedEventName("transition","end"),Na,!1),t.$emit("tw.reader.fontSettings.apply"),z().then(function(){na(!1),ka(),fa(b),ga(b),t.$emit("tw.reader.content.ready",t.sectionId)})})}function w(){var b=ya.documentElement,c=pa.documentElement.classList;b.setAttribute("interaction-handler",""),b.setAttribute("handle-keys",""),b.setAttribute("font-drop",""),b.setAttribute("section-id",t.sectionId),i.setClass(b,"isie",c.contains("isie")),i.setClass(b,"isedge",c.contains("isedge")),za&&za.setAttribute("ng-non-bindable",""),a(b)(t)}function x(a){var b=qa.contentDocument&&qa.contentDocument.querySelector("body");if(!b||!b.firstChild)return c.resolve();var d=c.defer(),e=qa.parentNode;return qa.onload=function(){qa.onload=null,d.resolve()},e.removeChild(qa),qa.setAttribute("src",a||"about:blank"),qa.removeAttribute("data-section-name"),e.appendChild(qa),d.promise}function y(a){var b=i.checkParserError(a);if(b)return t.$emit("tw.reader.error",t.sectionId,b),c.reject();T(a.querySelector("head"));var d=getComputedStyle(qa.contentDocument.documentElement),e=d[wa],f=d[xa],g="application/xhtml+xml"===k.getMimeType()?"assets/common/blank.xhtml":null;return x(g).then(function(){ya=qa.contentDocument;for(var b;b=ya.lastChild;)ya.removeChild(b);for(;b=a.firstChild;)window.Modernizr.isoldwebkit&&b.nodeType===Node.DOCUMENT_TYPE_NODE?a.removeChild(b):ya.appendChild(b);return e&&"none"!==e&&(ya.documentElement.style[wa]=e,ya.documentElement.style[xa]=f),A(),C()})}function z(a,b){function d(){F(),M(),Ba=ya.documentElement.getBoundingClientRect(),K(),D()}return la()&&ra.content?(G(i.getComputedStyle(qa.parentNode,"height")),na(!1),a&&d(),i.debounce(function(){a||d();var c=sa.viewport&&sa.viewport.height||Aa;f.requestAnimationFrame(function(){Ja.initWithDOMNode(za,!!sa.viewport,sa.isPagingEnabled,c),Ma().then(function(c){Oa(),(c||a||b)&&R(P(),!0)},angular.noop),Ca&&(Ca.resolve(),Ca=null)})},Da),Ca||(Ca=c.defer()),Ca.promise):c.resolve()}function A(){var a=k.getSectionLabel(ra.fileName),b=ya.querySelector("meta[name='description']");if(!b){b=pa.createElement("meta"),b.setAttribute("name","description");var c=ya.querySelector("head");c&&c.appendChild(b)}b.setAttribute("content",a)}function B(){function a(a){var c=ya.createEvent("Event");c.initEvent(a,!1,!1),b.dispatchEvent(c)}var b=qa.contentWindow;b.document.querySelector("script")&&(Ka.evaluateScript(za.getAttribute("onload")),a("load"),a("DOMContentLoaded"),Ka.identifyClickableTargets())}function C(){var a=ya.querySelectorAll("script"),b=20,d=[];return a.length>0&&(Ka.setContext(qa.contentWindow),Ka.patchPrototypeMethods(),ya.documentElement.addEventListener("error",Ka.genericErrorHandler,!0),Array.prototype.forEach.call(a,function(a,c){d.push(e(Ka.evaluateScript.bind(null,a),c*b))})),c.all(d)}function D(){var a=E();if(!sa.viewport){var b=Aa-ta.IMG_HEIGHT_PADDING,c=ya.querySelectorAll("img, svg");Array.prototype.forEach.call(c,function(c){var d=c.parentNode;if(d.nodeType===Node.ELEMENT_NODE&&!d.textContent.trim()&&"inline"!==getComputedStyle(d).display){var e=i.getMatchedCSSRules(d),f=i.getCascadedStyle("width",e),g=i.getCascadedStyle("height",e),h=d.getBoundingClientRect(),j=Math.min(a,f?h.width:1/0),k=Math.min(b,g?h.height:1/0);o.propagateImageSize(c,j,k)}})}}function E(){return za?(za.offsetWidth||window.innerWidth)-i.getComputedStyle(za,"paddingLeft")-i.getComputedStyle(za,"paddingRight"):0}function F(){var a=ua.parentNode,b=i.getComputedStyle(a,"paddingTop")+i.getComputedStyle(a,"paddingBottom");return Aa=Math.max(a.offsetHeight-b,ta.MIN_HEIGHT)}function G(a){if(!sa.viewport){var b=qa.style;a?(a+="px",b.height!==a&&b.setProperty("height",a)):b.removeProperty("height")}}function H(a,b){var c=za&&za.style;c&&(c[a]=b)}function I(a,b){if(za){var c=za.classList;i.isValidClassToken(b)&&c.contains(b)&&c.remove(b),i.isValidClassToken(a)&&!c.contains(a)&&c.add(a)}}function J(){sa.viewport=k.getViewport(),ca(),sa.viewport?(I("pre-paginated","reflowable"),sa.isPagingEnabled=!0,I("multi-column","scroll"),H("width",sa.viewport.width+"px"),H("height",sa.viewport.height+"px"),ba("pre-paginated","fs_20")):(I("reflowable","pre-paginated"),H("width",""),H("height",""))}function K(){if(sa.isPagingEnabled&&za){if(!sa.viewport){var a=f.Modernizr.prefixed("columnWidth"),b=f.Modernizr.prefixed("columnGap"),c=q.getPagingColumnGap(za),d=L(c),e=(za.offsetWidth-c*(d-1))/d;H(a,e+"px"),c>0&&H(b,c+"px")}var g=za.getElementsByClassName(ta.SPACER_CLASSNAME)[0];g&&0!==g.offsetHeight&&(g.style.height="0px")}}function L(a){var b=qa.offsetWidth;if(!ya||6*a>b)return 1;var c=ya.body,d=25*(i.getComputedStyle(c,"fontSize")||20),e=Math.floor(b/d);return Math.min(e,3)}function M(){if(sa.viewport){var a=ya.documentElement,b=i.getComputedStyle(a,"marginLeft")+i.getComputedStyle(a,"marginRight"),c=(a.parentNode.offsetWidth||window.innerWidth)-b,d=Aa,e=sa.viewport.width||c,f=sa.viewport.height||d,g=Math.min(c/e,d/f,1).toFixed(3),h=Math.max(0,window.innerWidth-e*g>>1);a.style[xa]="0 0",a.style[wa]="translateX("+h+"px) scale("+g+")",a.setAttribute("data-scale",g)}}function N(a){if(sa.scrollOffset=a,!sa.viewport||0!==a){var b=sa.isPagingEnabled?"X":"Y";H(wa,"translate"+b+"("+-a+"px)")}}function O(a){var b=Math.max(0,Math.min(sa.scrollOffset+a,Ja.getMaxOffset()));G(),R({offset:b},null,!0)}function P(){var a=sa.isPagingEnabled?"left":"top",b=Ia.getOffsetPosition(a);return Ja.getPageByOffset(b)}function Q(a){var b=0;if(!sa.viewport){var c=k.getContentFileMap(),d=a*c.totalSize,e=c.fileInfo[k.getNameOfCurrentSection()],f=(d-e.start)/(e.size-1);b=f*Ja.getMaxOffset(),b+=sa.isPagingEnabled?qa.offsetWidth/2:qa.offsetHeight/2}return Ja.getPageByOffset(b)}function R(a,b,c){na(!b);var d=a&&a.offset||0,e=d-sa.scrollOffset;N(d),S(),Oa(),sa.isPagingEnabled?(t.$emit("tw.reader.scroll",t.sectionId),t.$evalAsync()):c?(b||e<0)&&G(a&&a.height):Na(),ma(),Qa()}function S(){var a=Ja.isFirstPage(),b=Ja.isLastPage(),c=a!==sa.isFirstPage[t.sectionId]||b!==sa.isLastPage[t.sectionId];sa.isFirstPage[t.sectionId]=a,sa.isLastPage[t.sectionId]=b,c&&t.$emit("tw.reader.section.page.update",t.sectionId)}function T(a){var b=ta.PUBLICATION_FONTS_ID,c=pa.getElementById(b);if(c&&0!==c.sheet.cssRules.length){var d=Array.prototype.reduce.call(c.sheet.cssRules,function(a,b){return a+b.cssText+"\n"},""),e=a.querySelector("#"+b);e||(e=pa.createElement("style"),e.type="text/css",e.id=b,a.appendChild(e)),e.innerHTML=d}}function U(a,b,c,d){if(la()){var e=Ea[b];e&&e(c,d),"textAlign"!==b&&"backgroundMode"!==b&&ma()}}function V(a,b){sa.viewport||a===b||(sa.fontSizeID=a,I(a,b),ba(a,a),Pa(),z(null,!0))}function W(a,b){if(b=b||"default",!sa.viewport&&a!==b&&ra.content){"default"===b&&(Ga.storePublicationFonts(),_("font-family")),Ga.removeAllCustomFonts(),"default"===a?(Ga.restorePublicationFonts(),aa("font-family")):Ga.addCustomFont(a);var c="default"===a||a in j.globals.FONT.CUSTOM;I(c?a:"",b),H("font-family",c?"":a),ca(a),Pa(),z(null,!0)}}function X(a,b){b=b||"default",sa.viewport||a===b||("default"===b&&_("text-align"),"default"===a&&aa("text-align"),I(a,b))}function Y(a,b){b=b||"default",sa.viewport||a===b||("default"===b&&_("line-height"),"default"===a&&aa("line-height"),I(a,b),z(null,!0))}function Z(a,b){b=b||"bgwhite",a!==b&&("bgwhite"===b&&_("color"),"bgwhite"===a&&aa("color"),
sa.backgroundMode=a,I(a,b),e(function(){i.forceRepaint(ua),z(null,!0)}))}function $(a,b){if(a!==b){if("paged"===a)G(),sa.isPagingEnabled=!0,I("multi-column","scroll");else{var c=f.Modernizr.prefixed("columnWidth"),d=f.Modernizr.prefixed("columnGap");H(c,""),H(d,""),sa.isPagingEnabled=!1,I("scroll","multi-column")}b&&z(null,!0)}}function _(a){var b=ya.querySelectorAll("style:not(#"+ta.PUBLICATION_FONTS_ID+")");Array.prototype.forEach.call(b,function(b){Fa.discard(b.sheet,a)}),n.discardStyleProperty(za,a)}function aa(a){Fa.restore(a),n.restoreStyleProperty(a)}function ba(a,b){function c(a){var b=/fs_(\d+)/.exec(a);return b&&parseInt(b[1],10)||6}d.$broadcast("tw.reader.fontsize",{identifier:a,index:c(b)})}function ca(a){if(!sa.viewport&&!a){var b=h.fetch(j.globals.STORE.FONTSETTINGS);a=b&&b.fontFamily||"default"}i.setClass(ya.documentElement,"is-default-font",sa.viewport&&"default"===a)}function da(){function a(a){return a.fileName===n}function b(a){return a.nodeType===Node.ELEMENT_NODE&&"block"===getComputedStyle(a).display&&a.offsetHeight>0}function c(a,c){for(;a!==za&&!b(a);)a=a.previousElementSibling||a.parentNode;for(a===za&&(a=za.firstElementChild||za);a&&a.hasAttribute("data-page-number");)a=a.nextElementSibling;a&&a.setAttribute("data-page-number",c)}function d(a){for(var b,e=a.firstChild;e;){if(e.firstChild)d(e);else for(b=Ia.getCharCountForNode(e),j-=b;j<=0;)f++,c(e,f),j+=i;e=e.nextSibling}}if(!sa.viewport&&za){var e,f,g,h,i,j,l=k.getEPubInfo(),m=l.toc.pageList,n=k.getNameOfCurrentSection();m?m.filter(a).forEach(function(a){var b=a.anchorID&&ya.getElementById(a.anchorID)||za.firstElementChild||za;c(b,a.pageNum)}):(e=k.getContentFileMap().fileInfo[n])&&(h=e.pageCount,g=Ia.getCharCountForNode(za)+1,i=Math.ceil(g/h),f=e.pageStart-1,j=0,d(za))}}function ea(a){var b=k.getEPubInfo(),c=Ia.getPageNumberByList(b);if(c>=0)return c;var d=k.getNameOfCurrentSection(),e=k.getContentFileMap(),f=e.fileInfo[d];if(!f)return null;if(sa.viewport&&(c=f.index+1,!isNaN(c)))return c;var g=Ia.getCharCountForNode(za)+1,h=Ia.getCharCount(),i=Math.ceil(g/f.pageCount),j=a?Math.floor:Math.round;return c=f.pageStart+Math.min(j(h/i),f.pageCount-1)}function fa(a){ha("comments",a).forEach(Ha.setComment)}function ga(a){ha("dogears",a).forEach(Ha.setDogEar)}function ha(a,b){var c=ra.deliverable[a]||[];return c.filter(function(a){return!a.deleted&&Ia.parseRMSDKFileName(a.rmsdkPosition)===b})}function ia(){var a=ra.deliverable,b=2*i.getComputedStyle(za,"line-height")||64;Ba.y+=b;var c=Ia.getFirstNodeAtClientRectangle(Ba,za);Ba.y-=b;var d,e=Ia.getRangeAtPosition(Ba,c,!0),f=Ha.getDogEarIndex(e,a.dogears);f>=0?(d=a.dogears[f],Ha.restoreDogEar(d)):(d=Ha.createDogEar(e,a.id))&&a.dogears.push(d)}function ja(){var a=Ja.getNumberOfPages(),b=ya.getElementsByClassName(j.globals.ANNOTATION.DOGEAR_CLASSNAME);Array.prototype.forEach.call(b,function(b){(a<=1||Ia.isNodeInViewport(Ba,b,sa.isPagingEnabled))&&Ha.removeDogEar(b,ra.deliverable.dogears)})}function ka(){function a(b){if(b.src&&b.src===d){if("childSequence"in b)return!0;var c=Ia.getChildSequenceForAnchorID(b.srcAnchor);b.childSequence=c;var f=b.playOrder;e[f]&&(e[f].childSequence=c)}for(var g=b.items?b.items.length:0,h=0;h<g;h++)if(a(b.items[h]))return!0;return!1}var b=k.getEPubInfo(),c=b.toc||{};if(c.toc){var d=ra.fileName,e=c.tocByPlayOrder||[];a(c.toc)}}function la(){return qa.hasAttribute("current-section")}function ma(){t.$emit("tw.bookmark.sync",Ia)}function na(a){i.setClass(ya.documentElement,"no-animation",!a)}function oa(a){t.$emit("tw.mediaoverlay.set",a)}var pa=b[0],qa=u[0],ra=t.sectionData,sa=t.settings,ta=j.globals.READER,ua=qa.parentNode,va=f.Modernizr.isfirefox||f.Modernizr.android?300:200,wa=f.Modernizr.prefixed("transform"),xa=f.Modernizr.prefixed("transformOrigin"),ya=qa.contentDocument,za=null,Aa=null,Ba={},Ca=null,Da=h.fetch(j.globals.STORE.RECALC_PP_INTERVAL)||50,Ea={fontSize:V,fontFamily:W,textAlign:X,lineHeight:Y,backgroundMode:Z,readingMode:$},Fa=new l,Ga=new m,Ha=ra.annotations=new g,Ia=ra.pageLocation=new p,Ja=ra.pageNav=new r,Ka=ra.scriptSupport=new s,La=[],Ma=i.getDebouncedFunction(function(){if(sa.isPagingEnabled&&!sa.viewport&&za){var a=Ja.getNumberOfPages(),b=i.getComputedStyle(za,f.Modernizr.prefixed("columnGap")),c=q.calculatePagingParams(za);if(c.columnCount!==a||c.columnGap!==b){Da=Math.min(Da+10,va),h.save(j.globals.STORE.RECALC_PP_INTERVAL,Da),console.warn("Incorrect paging layout: "+a+"p|"+b+"px|, target: "+c.columnCount+"p|"+c.columnGap+"px|"),console.info("Recalculate page partitions after "+Da+"ms"),K(),Oa();var d=sa.viewport&&sa.viewport.height||Aa;return Ja.initWithDOMNode(za,!!sa.viewport,sa.isPagingEnabled,d),!0}}return!1},1e3),Na=i.getDebouncedFunction(function(){var a=Ja.identifyPage(sa.scrollOffset);if(a!==Ja.getCurrentPageNo()&&Ja.setCurrentPageByIndex(a),!sa.isPagingEnabled){var b=Ja.getPageByReference(a),c=b&&b.offset===sa.scrollOffset;G(c&&b.height)}ma(),t.$emit("tw.reader.scroll",t.sectionId)},ta.SLIDER_UPDATE_INTERVAL),Oa=i.getDebouncedFunction(function(){var a="";Ia.setByClientRectangle(Ba,!0);var b=ea();Ia.setByClientRectangle(Ba);var c=ea(!0);null!==c&&(a+=c,c!==b&&(a+=" – "+b)),t.$emit("tw.reader.pagenumber.update",c,a)},1e3),Pa=i.getDebouncedFunction(function(){function a(a){for(var b=getComputedStyle(a),c=0;;){if(c+=parseFloat(b.marginLeft,10)+parseFloat(b.paddingLeft,10),a=a.parentNode,!a||a===za)return c;b=getComputedStyle(a)}}var b="tw-page-num-offset-",c=ya?ya.querySelectorAll("[data-page-number]"):[];Array.prototype.forEach.call(c,function(c){for(var d=0;d<c.classList.length;d++){var e=c.classList.item(d);e.startsWith(b)&&c.classList.remove(e)}var f=a(c);if(f>0){var g=Math.round(Math.sqrt(5*f));c.classList.add(b+g)}})},200),Qa=i.getDebouncedFunction(function(){if(ya){var a=Ja.getNumberOfPages(),b=ya.getElementsByClassName(j.globals.ANNOTATION.DOGEAR_CLASSNAME),c=Array.prototype.some.call(b,function(b){return a<=1||Ia.isNodeInViewport(Ba,b,sa.isPagingEnabled)});t.$emit("tw.section.dogears.apply",t.sectionId,c)}},ta.TIMEOUT_PAGE_LAYOUT);window.addEventListener("resize",z,!1),t.$watch("sectionData.content",v),t.$on("tw.section.navigate",function(a,b,c,d,e){c===t.sectionId&&("pageRef"===b?R(Ja.getPageByReference(d),e):"RMSDK"===b?(Ia.setRMSDKPosition(d),R(P(),e)):"anchorID"===b?(Ia.setNode(ya.getElementById(d)),Ia.setByteOffset(0),R(P(),e)):"percent"===b?R(Q(d),e):"vertical"===b&&0!==d&&O(d))}),t.$on("tw.section.dogears.set",function(a,b,c){b===t.sectionId&&(c?ia():ja(),Qa())}),t.$on("tw.section.dogears.check",function(a,b){b===t.sectionId&&Qa()}),La.push(d.$on("tw.fontSettings.change",U)),La.push(d.$on("tw.fontSettings.apply",U)),t.$on("$destroy",function(){for(var a;a=La.pop();)a()})}}}]),angular.module("directives").directive("twErrorDialog",["$window","$rootScope",function(a,b){"use strict";return{restrict:"E",scope:{},templateUrl:"../directives/error-dialog/error-dialog.tpl.html",link:function(c){var d=[],e=function(b,d){c.options.isVisible=!0,c.headline=d.headline||a.gettext("DIALOG_INFO_TITLE"),c.message=d.message||a.gettext("SERVER_ERROR_TEXT")};c.options={isModal:!0,isVisible:!1},c.close=function(){c.options.isVisible=!1},d.push(b.$on("tw.component.error",e)),d.push(c.$on("$destroy",function(){for(var a=d&&d.length||0,b=0,e=a;b<e;b++)d[b]&&d[b]();c.options=null}))}}}]),angular.module("directives").directive("fileChange",function(){"use strict";return{restrict:"A",link:function(a,b,c){var d=a.$eval(c.fileChange);b.bind("change",function(b){d||(d=a.$eval(c.fileChange)),d(b)})}}}),angular.module("directives").directive("fileDrop",["$timeout","$rootScope","CONFIG","collections","EPubCover","inventory","uploader","URLManager","stateHelper","user",function(a,b,c,d,e,f,g,h,i,j){"use strict";var k=/\.cbr$|\.cbz$/i,l=window.DataTransferItem&&(window.DataTransferItem.prototype.webkitGetAsEntry||window.DataTransferItem.prototype.getAsEntry);return{restrict:"A",link:function(m,n){function o(a){var b=u.findIndex(function(b){return b.file===a});return b>=0?u.splice(b,1)[0]:null}function p(a,b){return a instanceof File&&(a=[a]),Array.prototype.forEach.call(a,function(a){u.push({file:a,directory:b})}),g.addToQueue(a)}function q(a,b){a.isFile?a.file(function(a){p(a,b)}):a.isDirectory&&(b=b||a.name,a.createReader().readEntries(function(a){a.forEach(function(a){q(a,b)})}))}function r(a){a.stopPropagation(),a.preventDefault()}function s(a){var c=a.dataTransfer.files||[];if(r(a),1===c.length&&k.test(c[0].name)){var d=new FileReader;d.onload=function(a){if(a.target.readyState===FileReader.DONE){var d=c[0].name;return b.comicBuffer={buffer:a.target.result,name:d},i.goToState("comic",{id:window.btoa(d)})}},d.readAsArrayBuffer(c[0])}else c.length>0&&(l?Array.prototype.forEach.call(a.dataTransfer.items,function(a){q(l.call(a))}):p(c))}function t(a,b){if(a&&b){var d=a.name,e=d&&d.split(".").pop().toLowerCase(),i=c.globals.MIME_TYPES[e];if(i&&a.data.byteLength<=g.coverMaxFileSize){var j=f.deliverables[b];j.cover=h.createURL(b+"cover",a.data,i)}}}var u=[],v=[];v.push(b.$on("tw.upload.success",function(a,c,d){var g=o(c),h=d&&d.data&&d.data.metadata,i=h&&h.deliverableId;if(i)return f.addPublication(h).then(function(a){return g?w(g,a).then(function(){if("application/epub+zip"===h.format)return e.extract(c).then(function(c){return t(c,a.id),e.upload(c,a.id).finally(function(){return w(g,a).then(function(){b.$broadcast("tw.metadata.update",i)})})})}):void console.log("file",c.name,"not found in list of pending upload files")})}));var w=function(b,c){var e=i.getCurrentState(),g="mybooks.collections.titles"===e.state.name&&e.params.name||b&&b.directory;return g?a(function(){return d.addDeliverable(g,c.id),f.saveDeliverable(c.id)},250):f.saveDeliverable(c.id)};v.push(b.$on("tw.upload.failed",function(a,b){o(b)})),v.push(b.$on("tw.library.upload.files",function(a,c){c&&1===c.length&&(c instanceof File&&(c=[c]),Array.prototype.forEach.call(c,function(a){if(k.test(a.name)){var c=new FileReader;c.onload=function(c){if(c.target.readyState===FileReader.DONE)return b.comicBuffer={buffer:c.target.result,name:a.name},i.goToState("comic",{id:window.btoa(a.name)})},c.readAsArrayBuffer(a)}})),p(c)})),v.push(b.$on("tw.library.upload.cancel",function(){g.abort()})),m.$on("$destroy",function(){for(var a;a=v.pop();)a();n.unbind()}),j.isLoggedIn()===!0&&window.Modernizr.draganddrop&&(n.bind("dragover",r),n.bind("drop",s))}}}]),angular.module("directives").directive("twFinishedDialog",["$window","$rootScope","appState","CONFIG",function(a,b,c,d){"use strict";return{restrict:"E",scope:{},templateUrl:"../directives/finished-dialog/finished-dialog.tpl.html",link:function(a){var e=c.fetch(d.globals.STORE.FINISHED_DONT_ASK_AGAIN)||{},f=a.options={isModal:!0,isVisible:!1,id:null,deferred:null};a.close=function(){a.options.isVisible=!1},a.markAsFinishedCheckBoxChange=function(){f.id&&(e[f.id]=Boolean(f.dontAskAgain),c.save(d.globals.STORE.FINISHED_DONT_ASK_AGAIN,e))},a.markAsFinished=function(){b.$emit("tw.library.mark.finished",f.id,!0),a.markAsFinishedClose()},a.markAsFinishedClose=function(){f.isVisible=!1,f.id=null,f.deferred&&(f.deferred.resolve(),f.deferred=null)};var g=[];g.push(b.$on("tw.reader.finished",function(a,b){e[b.id]||(f.deferred=b.deferred,f.id=b.id,f.dontAskAgain=!1,f.isVisible=!0)})),g.push(b.$on("tw.reader.close",function(){f.deferred=null,a.markAsFinishedClose()})),a.$on("$destroy",function(){for(var a;a=g.pop();)a()})}}}]),angular.module("directives").directive("fontDrop",["$q","CONFIG","Font","user",function(a,b,c,d){"use strict";return{restrict:"A",link:function(e,f){function g(a){return/application\/(x-)?font-/.test(a)}function h(b){var c=b.dataTransfer.files||[],d=[];b.preventDefault(),b.stopPropagation();for(var e=0;e<c.length;e++)d.push(i(c[e]));return a.all(d).then(function(a){a&&a.length>0&&console.log("Fonts loaded",a)})}function i(c){var d=c.name,e=d.split(".").pop().toLowerCase(),f=c.type||b.globals.MIME_TYPES[e];if(!g(f))return a.resolve({fileName:d,error:"invalid file type"});var h=new FileReader,i=a.defer();return h.addEventListener("load",function(){this.readyState===FileReader.DONE&&j(d,this.result).then(function(a){i.resolve(a)})},!1),h.readAsArrayBuffer(c),i.promise}function j(b,c){var d=window.localforage&&window.infoforage;if(d){var f=k(b,c);return d.setItem("font:meta:"+b,JSON.stringify(f)),window.localforage.setItem("font:file:"+b,c).then(function(){return e.$emit("tw.font.loaded",f),f},function(a){var c=a.message||a;return console.warn('Saving font file "'+b+'" failed',c),{fileName:b,error:c}})}return a.resolve({fileName:b,error:"no storage available"})}function k(a,b){var d=new c,e=Object.create(null);d.parseBuffer(b),e.fileName=a,e.fontName=d.getEnglishName("preferredFamily")||d.getEnglishName("fontFamily"),e.subFamily=d.getEnglishName("preferredSubfamily")||d.getEnglishName("fontSubfamily")||"Regular",e.fullName=d.getEnglishName("fullName"),e.preview=Object.create(null);var f=d.getPath(e.fontName,0,0,16),g=e.preview;return g.svg=f.toSVG(),g.xMin=f.xMin.toFixed(2),g.xMax=f.xMax.toFixed(2),g.yMin=f.yMin.toFixed(2),g.yMax=f.yMax.toFixed(2),e}e.$on("$destroy",function(){f.unbind()}),d.isLoggedIn()&&window.Modernizr.draganddrop&&(f.bind("drop",h),f.bind("dragover",function(a){a.stopPropagation(),a.preventDefault()}))}}}]),angular.module("directives").directive("fontSelectList",[function(){"use strict";return{restrict:"E",replace:!0,scope:{options:"=",deleteListItem:"&"},templateUrl:"../directives/font-select-list/font-select-list.tpl.html",link:function(a){var b=a.deleteListItem()||angular.noop;a.listItemDelete=function(a,c){b(c),a.stopPropagation()},a.listItemClick=function(b){a.options.selectedIndex=b},a.closeList=function(){a.options.isVisible=!1}}}}]),angular.module("directives").directive("twGridView",[function(){"use strict";return{restrict:"E",scope:{deliverables:"=",itemAction:"&"},templateUrl:"../directives/grid-view/grid-view.tpl.html",link:angular.noop}}]),angular.module("directives").directive("handleKeys",function(){"use strict";var a={8:{id:"left",preventDefault:!0},9:{id:"tab",preventDefault:!1},32:{id:"space",preventDefault:!0},33:{id:"left",preventDefault:!0},34:{id:"right",preventDefault:!0},37:{id:"left",preventDefault:!0},38:{id:"left",preventDefault:!0},39:{id:"right",preventDefault:!0},40:{id:"right",preventDefault:!0},65:{id:"left",preventDefault:!0},68:{id:"right",preventDefault:!0},73:{id:"info",preventDefault:!1},83:{id:"right",preventDefault:!0},87:{id:"left",preventDefault:!0}},b=function(a){var b=a&&a.nodeName||"";return"INPUT"===b||"TEXTAREA"===b};return{restrict:"A",scope:"isolate",link:function(c,d){d.bind("keydown",function(d){var e=d.keyCode||d.which,f=a[e];f&&!b(d.target)&&(c.$broadcast("interaction.key."+f.id,{keyCode:e}),f.preventDefault&&d.preventDefault())})}}}),angular.module("directives").directive("interactionHandler",[function(){"use strict";return{restrict:"A",controller:"interactionController",link:function(a,b,c,d){d.init(b)}}}]).controller("interactionController",["$window","$rootScope","$scope","BaseUtil","StringUtil","CONFIG",function(a,b,c,d,e,f){"use strict";var g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v=48,w=48,x=36,y=f.globals.READER.TAP_AREA_PAGING,z=f.globals.MISC.TAP_TRESHOLD,A=f.globals.MISC.SWIPE_TRESHOLD,B=f.globals.MISC.LONGPRESS_MIN_DURATION,C=f.globals.MISC.DOUBLE_TAP_MAX_DELAY,D={left:0,top:0},E=y,F={},G=function(a){var b;"touches"in a?(b=a.changedTouches[0]||a.touches[0]||{},a.clientX=b.clientX,a.clientY=b.clientY,a.screenX=b.screenX,a.screenY=b.screenY):(b={clientX:a.clientX,clientY:a.clientY,screenX:a.screenX,screenY:a.screenY,target:a.target},a.touches=[],/mouse(down|move|enter)/.test(a.type)&&a.touches.push(b),a.changedTouches=[],/mouse(down|up)/.test(a.type)&&a.changedTouches.push(b))},H=function(a){return a.clientX+D.left},I=function(a){return a.clientY+D.top},J=function(a){var b=I(a);if(b<v)return"top";if(window.innerHeight-b<k)return"bottom";var c=H(a)/window.innerWidth;return c<E?"left":c>1-E?"right":"center"},K=function(a){var b=a/window.innerWidth;return b<y?-1:b>1-y?1:0},L=function(a,c,d,e){h&&(c=c||a.type,d=d||{},d.clientX=H(a),d.clientY=I(a),d.area=e||J(a),d.horAreaID=K(d.clientX),d.$sourceEvent=a,b.$broadcast("interaction."+c,d))},M=function(a){return Math.abs(a.screenX-l)>z||Math.abs(a.screenY-m)>z},N=function(a,b){var c=a-l,d=b-m;return Math.sqrt(c*c+d*d)/(Date.now()-r)},O=function(a){if(!a||a.length<2)return null;F.centerX=(a[0].clientX+a[1].clientX)/2,F.centerY=(a[0].clientY+a[1].clientY)/2;var b=a[0].clientX-a[1].clientX,c=a[0].clientY-a[1].clientY;return Math.sqrt(b*b+c*c)},P=function(a){var b=O(a.changedTouches);return a.scale||b/F.initDistance},Q=function(){s&&(clearTimeout(s),s=null)},R=function(){l=m=n=o=p=q=null,F.initDistance=null,Q()},S=function(a){var b=a.screenX-l,c=a.screenY-m,d=Math.abs(b),e=Math.abs(c);if(d>A||e>A){var f=d>e?b<0?"left":"right":c<0?"up":"down";return L(a,"swipe",{dX:b,dY:c,velocity:N(a.screenX,a.screenY),direction:f}),!0}return!1},T=b.$on("tw.reader.readingMode",function(a,b){k="paged"===b?w+x:w});c.$on("tw.reader.fontsize",function(){W()});var U=b.$on("tw.reader.interactions",function(a,b){h=b}),V=b.$on("tw.reader.selection",function(a,b){i=b});c.$on("$destroy",function(){T(),U(),V(),window.removeEventListener("resize",W,!1)});var W=d.getDebouncedFunction(function(){var a=g.getAttribute("section-id"),b=null!==a&&g.ownerDocument.defaultView&&g.ownerDocument.defaultView.parent.document.querySelector("iframe[section-id='"+a+"']");if(b&&!/pos-\d/.test(b.className)){var c=d.getComputedStyle(g,"width");D.top=b.getBoundingClientRect().top,D.left=(window.innerWidth-c)/2,E=D.left>0&&c>0?D.left/c:y}},400),X=function(a){L(a),a.preventDefault()},Y=function(a){L(a,"mousewheel")},Z=function(a){var b=J(a);b!==j&&(L(a,"pointerleave",null,j),L(a,"pointerenter",null,b),j=b)},$=function(a){n=a.screenX,o=a.screenY,r=Date.now(),Z(a)},_=function(a){G(a),a.touches&&a.touches.length>0||(u||(u=a.type),F.initDistance||(M(a)?(l=l||n,m=m||o,L(a,"dragend",{dX:a.screenX-l,dY:a.screenY-m}),S(a)):t&&a.type===u?(clearTimeout(t),t=null,u=null,L(a,"doubletap")):h&&a.type===u&&(t=setTimeout(function(){t=null,u=null,L(a,"click")},C))),R())},aa=function(a){G(a),a.touches&&a.touches.length>1?(F.initDistance=O(a.touches),F.scale=1,Q()):s=h?setTimeout(L.bind(this,a,"contextmenu"),B):null,l=p=a.screenX,m=q=a.screenY,r=Date.now(),j=J(a)},ba=function(a){if(i===!1)return a.preventDefault(),!1;if(G(a),l||m){if(M(a)&&h){if(F.initDistance){var b=P(a);return Math.abs(b-F.scale)>.001&&(F.scale=b,L(a,"pinch",F)),void Q()}var c=a.screenX-p,d=a.screenY-q;p=a.screenX,q=a.screenY,L(a,"drag",{dX:c,dY:d,velocity:N(p,q)}),Q()}}else Z(a),L(a,"pointermove",null,j)};this.init=function(b){g=b[0],h=!0,k=w,b.bind("touchstart",aa),b.bind("touchend",_),b.bind("touchmove",ba),b.bind("touchcancel",R),b.bind("mousedown",aa),b.bind("mouseup",_),b.bind("mousemove",ba),b.bind("mouseenter",$),b.bind("mouseleave",R),b.bind("contextmenu",X),b.bind(a.normalizeWheel.getEventType(),Y),W(),a.addEventListener("resize",W,!1)}}]),angular.module("directives").directive("itemSelectList",[function(){"use strict";return{restrict:"E",replace:!0,scope:{options:"="},templateUrl:"../directives/item-select-list/item-select-list.tpl.html",link:function(a){a.listItemClick=function(b){a.options.selectedIndex=b},a.closeList=function(){a.options.isVisible=!1}}}}]),angular.module("directives").directive("twLabelButton",[function(){"use strict";return{restrict:"E",scope:{label:"@",resellerLogoIdentifier:"@"},templateUrl:"../directives/label-button/label-button.tpl.html",link:angular.noop}}]),angular.module("directives").directive("twLibraryBar",["$window","$timeout","$rootScope","$translate","BaseUtil","CONFIG","stateHelper","libraryModel","mybooks","collections","user",function(a,b,c,d,e,f,g,h,i,j,k){"use strict";return{restrict:"E",scope:{twTitle:"@"},templateUrl:"../directives/library-bar/library-bar.tpl.html",link:function(d){function l(a){/collections$/.test(n)?c.$emit("tw.collection.update",a):i.getFilteredDeliverables(a)}d.stateActions={};var m,n,o,p,q={default:{title:a.gettext("COMMON_MY_BOOKS"),menu:"show",back:"hide",search:"show",display:"show",sort:"show",view:"show",delete:"show",upload:"show",newCollection:"hide",deleteCollections:"hide",addToCollection:"show",removeFromCollection:"hide",subMenu:"show",context:"hide",selection:"hide",actions:"show",sortcriteria:[{translate:a.gettext("COMMON_RELEVANCE"),key:"recent"},{translate:a.gettext("COMMON_TITLE"),key:"title"},{translate:a.gettext("COMMON_AUTHOR"),key:"author"}]},home:{title:a.gettext("COMMON_LAST_ACTIVITIES"),menu:"show",back:"hide",search:"hide",display:"hide",delete:"hide",upload:"hide",newCollection:"hide",addToCollection:"hide",subMenu:"hide"},account:{title:a.gettext("COMMON_MY_ACCOUNT"),menu:"show",back:"hide",search:"hide",display:"hide",delete:"hide",upload:"hide",newCollection:"hide",addToCollection:"hide",subMenu:"hide"},details:{title:a.gettext("PRODUCT_DETAILS_TITLE"),menu:"hide",back:"show",search:"hide",display:"hide",delete:"hide",upload:"hide",context:"show",newCollection:"hide",addToCollection:"hide",subMenu:"hide"},help:{title:a.gettext("COMMON_HELP"),menu:"show",back:"hide",search:"hide",display:"hide",view:"hide",delete:"hide",upload:"hide",newCollection:"hide",addToCollection:"hide",subMenu:"hide"},"mybooks.authors":{view:"disable",delete:"disable"},"myaudiobooks.authors":{title:a.gettext("COMMON_MY_AUDIOBOOKS"),upload:"hide",view:"disable",delete:"disable"},"mybooks.authors.titles":{menu:"hide",back:"show",upload:"disable"},"myaudiobooks.authors.titles":{menu:"hide",back:"show",upload:"hide"},"mybooks.collections":{newCollection:"show",deleteCollections:"show",addToCollection:"hide",delete:"hide",sortcriteria:[{key:"recent",translate:a.gettext("COMMON_RELEVANCE")},{key:"title",translate:a.gettext("COMMON_TITLE")},{key:"count",translate:a.gettext("COMMON_COUNT_BOOKS")}]},"myaudiobooks.collections":{title:a.gettext("COMMON_MY_AUDIOBOOKS"),newCollection:"show",deleteCollections:"show",addToCollection:"hide",upload:"hide",delete:"hide",sortcriteria:[{key:"recent",translate:a.gettext("COMMON_RELEVANCE")},{key:"title",translate:a.gettext("COMMON_TITLE")},{key:"count",translate:a.gettext("COMMON_COUNT_AUDIOBOOKS")}]},"mybooks.collections.titles":{menu:"hide",back:"show",newCollection:"hide",addToCollection:"show",removeFromCollection:"show"},"myaudiobooks.collections.titles":{menu:"hide",back:"show",newCollection:"hide",addToCollection:"show",removeFromCollection:"show"},"mybooks.collections.selection":{title:a.gettext("COMMON_DELETE"),menu:"hide",back:"show",actions:"hide",search:"hide",upload:"hide",selection:"show"},"myaudiobooks.collections.selection":{title:a.gettext("COMMON_DELETE"),menu:"hide",back:"show",actions:"hide",search:"hide",upload:"hide",selection:"show"},"myaudiobooks.titles":{title:a.gettext("COMMON_MY_AUDIOBOOKS"),upload:"hide"},"mybooks.selection":{title:a.gettext("COMMON_DELETE"),menu:"hide",back:"show",selection:"show",actions:"hide"},"myaudiobooks.selection":{title:a.gettext("COMMON_DELETE"),menu:"hide",back:"show",selection:"show",actions:"hide"},"mybooks.authors.selection":{title:a.gettext("COMMON_DELETE"),menu:"hide",back:"show",selection:"show",actions:"hide"},"myaudiobooks.authors.selection":{title:a.gettext("COMMON_DELETE"),menu:"hide",back:"show",selection:"show",actions:"hide"}},r=/books.selection$|authors.selection$/,s=f.globals.MISC.SUBSCRIPTION_CATEGORY,t=f.globals.MISC.SYSTEM_CATEGORY,u=a.Modernizr.ios||a.Modernizr.android;d.sortCriteria=h.getSortOrder().order,d.isSortDescending=h.getSortOrder().isDescending,d.isGridView=h.isGridView(),d.menuAction=function(){d.$emit("menuAction")},d.backAction=function(){d.$emit("backAction")},d.contextAction=function(a){d.$emit("contextAction",a)},d.filterOptions={searchTerm:"",hasLiveUpdate:!0,cbSearch:l,cbClear:l.bind(null,"")},d.searchAction=function(){g.setAsKeyState(),d.$emit("searchAction",d.filterOptions.searchTerm)},d.onSearchInputKey=function(a){13===a.keyCode&&d.searchAction()};var v=c.$on("tw.search.clear",l.bind(null,""));d.sortAction=function(a,b){b===d.sortCriteria?d.isSortDescending=!d.isSortDescending:d.sortCriteria=b,d.$emit("sortAction",b,d.isSortDescending)},d.viewAction=function(){d.isGridView=!d.isGridView,h.setGridView(d.isGridView),d.$emit("viewAction",d.isGridView)},d.deleteAction=function(){d.$emit("deleteAction")},d.cancelAction=function(){d.$emit("cancelAction")},d.uploadAction=function(){b(function(){var a=document.getElementById("upload-files");a.click()})},d.newCollectionAction=function(){d.$emit("newCollectionAction")},d.deleteCollectionsAction=function(){d.$emit("deleteCollectionsAction")},d.addToCollectionAction=function(){d.$emit("addToCollectionAction")},d.removeFromCollectionAction=function(){d.$emit("removeFromCollectionAction")},d.showFinishedBooks={value:h.showFinishedItems()},d.$watch("showFinishedBooks.value",function(a){void 0!==a&&null!==a&&h.setShowFinishedItems(a)}),d.onUploadFileChange=function(a){c.$emit("tw.library.upload.files",a.target.files),document.getElementById("form-upload-files").reset()};var w=function(){return h.isGridView()};d.$watch(w,function(a){d.isGridView=a,b()}),d.$watch(h.getSortOrder,function(a){o||(d.isSortDescending=a.isDescending,d.sortCriteria=a.order),b()}),d.$watch(h.getCollectionSortOrder,function(a){o&&a&&(d.isSortDescending=a.isDescending,d.sortCriteria=a.order),b()});var x=function(){return d.selection.numSelectedItems};d.$watch(x,function(a){d.amount=a}),d.$on("tw-toggle-button-change",function(a,b){a.stopPropagation(),"changeLibraryView"===b.name&&d.viewAction()}),d.$on("$destroy",function(){D(),v()});var y=e.getDebouncedFunction(function(){if(!(window.innerWidth<768)){var a=document.querySelector(".header-bar-left"),b=document.querySelector(".header-bar-actions")||document.querySelector(".selection-bar-actions");if(a&&b){var c=a.offsetWidth+(window.innerWidth<1200?11:24),d=b.offsetWidth;c<d?(b.style.marginLeft=null,a.style.marginRight=d-c+"px"):c>d&&(b.style.marginLeft=c-d+"px",a.style.marginRight=null)}}},66),z=function(){function a(a,c){a&&"hide"!==b[c]&&(b[c]="disable")}var b=d.stateActions,c=q[n]||{},e=g.getCurrentState().params;for(var f in q.default)b[f]=c[f]||q.default[f];if(d.selectAction=e&&e.action,u&&"hide"!==b.upload&&(b.upload="disable"),/collections.selection/.test(n)&&"addToCollection"===e.action){for(f in b)"show"===b[f]&&(b[f]="hide");["back","actions","newCollection","selection"].forEach(function(a){b[a]="show"})}m&&["upload","delete","newCollection","addToCollection"].forEach(a.bind(null,!0));var i,k=0===A(),l=/collections.titles/.test(n)&&j.getCategory(e.name)===s,p=/collections.titles/.test(n)&&j.getCategory(e.name)===t;if(o?(i=h.getCollectionsSortOrder(),a(k,"deleteCollections")):(i=h.getSortOrder(),a(k,"delete"),a(k||l,"addToCollection"),a(k||l,"removeFromCollection"),a(k||l||p,"upload")),d.hasActions=!1,"hide"!==b.actions)for(f in b)if("actions"!==f&&"hide"!==b[f]){d.hasActions=!0;break}d.isSortDescending=i.isDescending,d.sortCriteria=i.order,d.headline=d.twTitle||b.title,y()},A=function(){if(o)return j.getByType(p).length;var a=i.getFilteredDeliverables();return a&&a.length};d.$watch(A,z);var B=null,C=function(a,b,c,e){if((!a||!B||B.parent===b.parent)&&(!a||B||b.parent===e.parent)){B||(B=b);var f=g.getCurrentState().state.name,q=g.getLastVisitedState(2,!0),s=n||q&&q.state.name;r.test(s)||r.test(f)?d.filterOptions.searchTerm=i.getCurrentSearchTerm():(d.filterOptions.searchTerm="",l(""));var t=f.substr(0,f.indexOf("."))||f;s&&!s.startsWith(t)&&j.selection.reset(),m=!k.isLoggedIn(),n=f,o=/\.collections$/.test(n),p=o&&/audiobook/i.test(n)?"AUDIOBOOK":"EBOOK",d.selection=/collections\.selection/.test(n)?j.selection:h.selection,z()}},D=c.$on("$stateChangeSuccess",C);C()}}}]),angular.module("directives").directive("twListView",[function(){"use strict";return{restrict:"E",scope:{deliverables:"=",itemAction:"&"},templateUrl:"../directives/list-view/list-view.tpl.html"}}]),angular.module("directives").directive("twLoader",function(){"use strict";return{replace:!0,restrict:"E",scope:{},controller:"loaderCtrl",templateUrl:"../directives/loader/loader.tpl.html"}}).controller("loaderCtrl",["$window","$rootScope","$scope","$timeout","$injector","$translate","$location","loader","image","stateHelper","error","CONFIG",function(a,b,c,d,e,f,g,h,i,j,k,l){"use strict";var m=1500,n=0,o={};c.progress=0;var p=c.status={deliverableID:"",titleText:"",publication:o,deliverable:o,coverUrl:""},q=function(){p.deliverableID="",p.publication=o,p.deliverable=o,p.coverUrl=i.getNullImage(),c.progress=0,c.loaded="",c.total=""},r=function(a){d(q,Math.max(0,m-Date.now()+n));var b=a&&j.getViewStateForDeliverable(a.id);if(b&&b.name)return j.goToState(b.name,b.params)},s=function(c){return c&&401===c.status?void k.handleError({type:l.globals.ERROR.APP_INVALID_TOKEN,httpStatusCode:c.status,details:{httpError:c}}).then(t):(q(),d(function(){if(c!==l.globals.ERROR.ABORT){if(c===l.globals.ERROR.UNSUPPORTED_MEDIA)return f(a.gettext("CONTENT_ERROR_MESSAGE")).then(function(a){b.$emit("tw.component.error",{message:a})}).catch(function(a){console.warn("Missing translation ->"+a)});if(c===l.globals.ERROR.NETWORK_OFFLINE)return f(a.gettext("ERROR_OFFLINE")).then(function(a){b.$emit("tw.component.error",{message:a})}).catch(function(a){console.warn("Missing translation ->"+a)});b.$emit("tw.component.error",c)}}))},t=function(){return h.fetchDeliverable(p.deliverableID,p).then(r)},u=b.$on("tw.library.open",function(a,b){if(b&&!h.isLoading(b)){var d=j.getViewStateForDeliverable(b);if(d&&("audio"===d.name||"comic"===d.name))return j.goToState(d.name,d.params);n=Date.now(),p.deliverableID=b;var g=e.get("inventory").deliverables[b];if(!g)return console.warn("Deliverable was not found in this inventory"),q(),j.goToState("home");var i="EDATA"===g.type?gettext("COMMON_ADDED_AT"):gettext("COMMON_ISSUED");c.lblAddedOrIssued=f.instant(i),h.fetchDeliverable(b,p).then(r,s)}});c.$on("tw.download.progress",function(a,b){b&&b.id===p.deliverableID&&(c.progress=b.total>0?Math.round(100*b.loaded/b.total):0,c.loaded=h.getHumanReadableText(b.loaded),c.total=h.getHumanReadableText(b.total),d(angular.noop,0))}),c.$on("$destroy",function(){u()}),c.abort=function(){p.deliverableID&&(q(),h.abortDownload(p.deliverableID))}}]),angular.module("directives").directive("twLongPress",["$timeout","$rootScope","CONFIG",function(a,b,c){"use strict";return{restrict:"A",link:function(a,d,e){function f(a){function c(a,b){if("touches"in a){var c=a.changedTouches[0]||a.touches[0]||{};return c[b]}return a[b]}function e(){o&&(clearTimeout(o),o=null)}function f(a){var b=c(a,"clientX"),d=c(a,"clientY");(Math.abs(b-m)>h||Math.abs(d-n)>h)&&(e(),l=a.target,m=b,n=d,o=setTimeout(k,i))}function j(a){e(),d.unbind("touchmove",f),a&&(d.unbind("touchend",j),d.unbind("touchcancel",j),p&&a.preventDefault()),g&&(d.unbind("mousemove",f),p||(d.unbind("mouseup",j),d.unbind("mouseleave",j)))}function k(){p=!0,j(),b.$emit("tw.longpress",{target:l,clientX:m,clientY:n})}var l,m,n,o,p=!1;l=a.target,m=c(a,"clientX"),n=c(a,"clientY"),o=setTimeout(k,i),d.bind("touchmove",f),d.bind("touchend",j),d.bind("touchcancel",j),g&&(d.bind("mousemove",f),d.bind("mouseup",j),d.bind("mouseleave",j))}var g=!!e.twLongPress,h=c.globals.MISC.TAP_TRESHOLD,i=c.globals.MISC.LONGPRESS_MIN_DURATION;d.bind("touchstart",f),g&&d.bind("mousedown",f),a.$on("$destroy",function(){d.unbind("touchstart",f),g&&d.unbind("mousedown",f)})}}}]),angular.module("directives").directive("twMenuButton",[function(){"use strict";return{restrict:"E",templateUrl:"../directives/menu-button/menu-button.tpl.html",link:angular.noop}}]),angular.module("directives").directive("twMetaDataDialog",[function(){"use strict";return{restrict:"E",replace:!1,scope:{},templateUrl:"../directives/meta-data-dialog/meta-data-dialog.tpl.html",controller:"twMetaDataDialogCtrl",link:function(a,b,c,d){return d.init(b)}}}]).controller("twMetaDataDialogCtrl",["$window","$rootScope","$scope","$timeout","$translate","BaseUtil","cover","bosh","inventory","uploader","CONFIG","sync",function(a,b,c,d,e,f,g,h,i,j,k,l){
"use strict";var m=angular.element(a),n=function(a){a.stopPropagation(),a.stopImmediatePropagation()};m.bind("keyup",n);var o,p,q=!0,r=k.globals.MEDIA.FALLBACK_COVER_HEIGHT,s=k.globals.MEDIA.FALLBACK_COVER_WIDTH,t=function(a){this.author=a.author,this.deliverableId=a.id,this.edition=null,this.epubVersion=null,this.format=a.format,this.isbn=null,this.issued=a.issued,this.language=null,this.pages=null,this.publisher=null,this.subtitle=a.subtitle,this.title=a.title},u=function(){var a=k.globals.MEDIA;c.coverURL=a.IMAGE_DEFAULT_PUB,r=a.FALLBACK_COVER_HEIGHT,s=a.FALLBACK_COVER_WIDTH,c.isFallbackCover=!0,c.coverButtonText=e.instant(gettext("METADATA_ADD_COVER")),c.pubTitle="",c.pubAuthor="",c.uploadInProgress=!1,c.titleAuthorOnly=!1,c.deliverableId=null,c.deliverable=null},v=function(a){c.coverURL=a.blobUri,c.isFallbackCover=!1,c.coverButtonText=e.instant(gettext("METADATA_CHANGE_COVER")),r=a.dimensions&&a.dimensions.height,s=a.dimensions&&a.dimensions.width,x()},w=function(a){var b=k.globals.MEDIA;c.coverURL=a&&a.blobUri||b.IMAGE_DEFAULT_PUB,c.isFallbackCover=!0,c.coverButtonText=e.instant(gettext("METADATA_ADD_COVER")),r=b.FALLBACK_COVER_HEIGHT,s=b.FALLBACK_COVER_WIDTH,x()},x=f.getDebouncedFunction(function(){if(c.isDialogVisible){var a=o.querySelector(".meta-data-cover").getBoundingClientRect(),b=a.height/a.width/((r||1)/(s||1)),d=100*Math.min(1,b),e=100*Math.max(0,1-1/b);p.style.width=d+"%",p.style.bottom=e+"%"}},30),y=function(){return E().then(function(){if(c.deliverable){var a=i.deliverables[c.deliverableId].cover;if(a){c.deliverable.cover=a;var d="AUDIOBOOK"===c.deliverable.type;g.requestCover(c.deliverable.cover,q,d).then(v,w),b.$emit("tw.upload.done")}else w();b.$broadcast("tw.metadata.update",c.deliverableId)}c.uploadInProgress=!1})},z=function(a){console.warn("cover upload failed:",a),c.uploadInProgress=!1;var b=/Unsupported .+"(.*)"$/.exec(a);c.coverUploadMessage.dialogText=gettext("DIALOG_RESULT_UPLOAD_TEXT_FAIL_1_TITLE"),c.coverUploadMessage.translationData.title=b&&b[1]||"",e.refresh(),c.coverUploadMessage.isVisible=!0},A=function(){return c.deliverable&&(c.deliverable.title!==c.pubTitle||c.deliverable.author!==c.pubAuthor&&c.deliverable.author!==B(c.pubAuthor))},B=function(a){if(!a)return"";var b=a.indexOf(",");if(b<0)return a;var c=a.substr(0,b).trim(),d=a.substr(b+1).trim();return d+" "+c},C=function(){return c.deliverable.title=c.pubTitle,c.deliverable.author=B(c.pubAuthor),h.fetchMetaData(c.deliverableId).then(D,D)},D=function(a){var b=a&&a.metadata||new t(c.deliverable);return b.title=c.deliverable.title,b.author=c.deliverable.author,b=JSON.stringify({uploadMetaData:b}),h.sendMetaData(b).then(E)},E=function(){return i.fetchPublications(!0).finally(function(){l.sync(i.getDeliverables())})},F=function(){return c.isDialogVisible=!1,m.unbind("keyup",n),b.$emit("tw.library.metadata.finish",c.deliverable),d(u,0)},G=function(a){a.stopPropagation(),a.preventDefault()},H=function(a){var b=a.dataTransfer.files,c=b&&b[0],d=/\.(jpg|jpeg|png)$/i;G(a),c&&d.test(c.name)&&I(c)},I=function(a){a&&(c.uploadInProgress=!0,a.deliverableId=c.deliverableId,j.uploadFile(a).then(y,z))};c.isDialogVisible=!1,c.coverURL=null,c.pubTitle="",c.pubAuthor="",c.uploadInProgress=!1,c.deliverable=null,c.coverUploadMessage={isVisible:!1,isModal:!0,dialogText:null,translationData:{}},c.closeCoverUploadMessage=function(){c.coverUploadMessage.isVisible=!1},c.uploadCover=function(a){var b=a.target.files;I(b&&b[0])},c.triggerFileUpload=function(){return o.querySelector("input[type='file']").click(),d(angular.noop)},c.closeDialog=function(){return F()},c.saveDialog=function(){return A()?(C().then(F,F),void(c.isDialogVisible=!1)):F()};var J=b.$on("tw.library.metadata",function(a,b,d){var e=c.deliverable=i.deliverables[b];if(c.deliverableId=b,c.titleAuthorOnly=d,e){if(e.cover){var f="AUDIOBOOK"===e.type;g.requestCover(e.cover,!1,f).then(v,w)}else w();c.pubTitle=e.title,c.pubAuthor=e.author}c.isDialogVisible=!0});c.$on("$destroy",function(){J(),m.unbind("keyup",n),window.Modernizr.draganddrop&&(o.removeEventListener("dragover",G,!1),o.removeEventListener("drop",H,!1)),window.removeEventListener("resize",x,!1),c.deliverable=null,o=null,p=null}),this.init=function(a){o=a[0],p=o.querySelector(".btn-cover-upload"),u(),window.addEventListener("resize",x,!1),window.Modernizr.draganddrop&&(o.addEventListener("dragover",G,!1),o.addEventListener("drop",H,!1))}}]),angular.module("directives").directive("twMiniMenu",["$window","$rootScope",function(a,b){"use strict";return{restrict:"E",scope:!0,transclude:{main:"mainPane",sub:"?subPane"},templateUrl:"../directives/mini-menu/mini-menu.tpl.html",link:function(c,d){var e=null,f=!1,g=function(){var a=d[0].querySelector("main-pane"),b=d[0].querySelector(".pane-container");if(a){for(var c=0,e=0;e<a.children.length;e++)a.children[e].getBoundingClientRect().height>0&&(c+=4.8);b.style.height=c+"rem"}},h=function(){b.$emit("tw.directive.action.menu.hide")},i=function(a){var b=d[0].querySelector("main-pane"),c=d[0].querySelector("sub-pane"),e=d[0].querySelector(".pane-container");b&&c&&e&&("sub"===a?(c.classList.add("active"),b.classList.add("inactive"),e.style.height=4.8*c.childElementCount+"rem",f=!0):(b.classList.remove("inactive"),c.classList.remove("active"),g(),f=!1))},j=function(b){b.preventDefault(),b.stopPropagation();for(var c=a.document.elementsFromPoint(b.clientX,b.clientY),d=null,e=0;e<c.length;e++)if(d=c[e],d.dataset&&d.dataset.navigation){i(d.dataset.navigation);break}},k=function(){e=angular.element(d[0].querySelector(".action-menu-content")),e&&(e.unbind(),e.bind("click",j)),i(f?"sub":"main")},l=a.MutationObserver||a.WebKitMutationObserver,m=new l(k);m.observe(d[0],{childList:!0,subtree:!0}),c.$on("$destroy",function(){d.unbind(),e.unbind(),angular.element(a).unbind("resize",h),f=!1,m.disconnect()}),angular.element(a).bind("resize",h)}}}]),angular.module("directives").directive("overlay",["$timeout",function(a){"use strict";return{restrict:"E",scope:{show:"=",options:"=",overlayTitle:"@",overlayId:"@"},replace:!0,transclude:!0,templateUrl:"../directives/overlay/overlay.tpl.html",link:function(b){b.options||(b.options={});var c=b.options;c.hasCloseX=c.hasCloseX||!1,c.isVisible=c.isVisible||!1,c.isModal="boolean"!=typeof c.isModal||c.isModal,c.hideOnClick=c.hideOnClick||!1,c.className=c.className||"",c.autoHide=parseInt(c.autoHide||0,10);var d=null;b.onModalClick=function(){b.options.hideOnClick&&b.hideOverlay()},b.hideOverlay=function(){b.show=!1,d&&(a.cancel(d),d=null)},b.$watch("show",function(c,e){c!==e&&(c&&b.options.autoHide>0&&(d=a(b.hideOverlay,b.options.autoHide)),b.$emit("overlay.visibility",c,b.overlayId||b.overlayTitle))})}}}]),angular.module("directives").directive("twPointerUp",["$parse",function(a){"use strict";return{restrict:"A",compile:function(b,c){var d=a(c.twPointerUp);return function(a,b){b.on("mouseup touchend",function(b){a.$apply(function(){d(a,{$event:b})})})}}}}]).directive("twPointerDown",["$parse",function(a){"use strict";return{restrict:"A",compile:function(b,c){var d=a(c.twPointerDown);return function(a,b){b.on("mousedown touchstart",function(b){a.$apply(function(){d(a,{$event:b})})})}}}}]),angular.module("directives").directive("twPubDetails",["$filter",function(a){"use strict";return{restrict:"E",scope:{publication:"=",deliverable:"="},templateUrl:"../directives/pub-details/pub-details.tpl.html",link:function(b){b.$watch("deliverable",function(c){c&&(b.issued=a("date")(new Date(parseInt(c.issued)),"dd.MM.yyyy"),b.purchased=a("date")(new Date(parseInt(c.purchased)),"dd.MM.yyyy"))})}}}]),angular.module("directives").directive("pubRepeat",["$timeout","$animate",function(a,b){"use strict";var c=[{lowerBound:0,height:281.64,width:148},{lowerBound:320,height:281.64,width:148},{lowerBound:480,height:287.5,width:152},{lowerBound:768,height:283,width:148.8},{lowerBound:1024,height:302,width:161.2},{lowerBound:1600,height:399.63,width:225.14},{lowerBound:1/0}],d={audio:48,books:92},e=1.5,f=function(a){for(;a&&a.nodeType===Node.ELEMENT_NODE;){if("visible"!==getComputedStyle(a)["overflow-y"])return"TW-SCROLLER"===a.tagName?a.firstElementChild:a;a=a.parentNode}return null};return{restrict:"A",transclude:"element",multiElement:!0,priority:1e3,terminal:!0,compile:function(g,h){var i=h.pubRepeat,j=i.match(/^\s*([\s\S]+?)\s+in\s+([\s\S]+?)(?:\s+as\s+([\s\S]+?))?(?:\s+track\s+by\s+([\s\S]+?))?\s*$/);if(!j)throw Error('Expected expression in form of "item in collection [ track by id ]" but got "'+i+'"');var k=j[1],l=j[2];if(j=k.match(/^(?:(\s*[\$\w]+)|\(\s*([\$\w]+)\s*,\s*([\$\w]+)\s*\))$/),!j)throw Error('"item" in "item in collection" should be identifier or (key, value) but got "'+k+'".');var m=j[3]||j[1],n=function(){var a=document.createElement("div");return a.setAttribute("class","pub-repeat-spacer"),a.setAttribute("style","width: 100%;"),a},o=function(a){return"NG-TRANSCLUDE"===a.tagName||a.hasAttribute("ng-transclude")};return function(g,h,i,j,k){var p,q,r,s,t,u=Object.create(null),v=h[0].parentNode,w=f(v)||document.querySelector("tw-scroller > [ng-transclude]"),x=o(w)?w.parentNode:w,y=!0,z=0,A=0,B=0,C=n(),D=n();v.appendChild(C),v.appendChild(D);var E=function(a){a&&a.scope&&(u[a.id]=a)},F=window.Modernizr.isie||window.Modernizr.isedge,G=F?function(a){b.leave(angular.element(a))}:function(a){a.parentNode.removeChild(a)},H=F?function(a,c){b.enter(angular.element(a),null,angular.element(c))}:function(a,b){v&&v.insertBefore(a,b.nextSibling)},I=F?function(a,c){b.move(angular.element(a),null,angular.element(c))}:function(a,b){v&&v.insertBefore(a,b.nextSibling)},J=function(){if(g.list||g.isAudio)r=1,q=d[g.isAudio?"audio":"books"];else for(var a=window.innerWidth,b=v&&v.offsetWidth||a,e=0;e<c.length;e++){var f=c[e];if(f.lowerBound<=a&&a<c[e+1].lowerBound)return r=Math.floor(b/f.width),void(q=f.height)}},K=function(){var a=C.nextElementSibling;if(a&&a!==D){var b=getComputedStyle(a),c=a.getBoundingClientRect(),d=c.width+parseFloat(b.marginLeft,10)+parseFloat(b.marginRight,10);q=c.height+parseFloat(b.marginTop,10)+parseFloat(b.marginBottom,10),r=d>0?Math.floor(v.offsetWidth/d):null,y=!1}else J(),y=!0},L=function(){var a=w&&getComputedStyle(w);if(a){var b=a.transform||a.webkitTransform||a.mozTransform,c=b.match(/^matrix(3d)?\((.+)\)$/);if(c){var d=c[2].split(",");return Math.abs(Number(c[1]?d[13]:d[5]))}}return w&&w.scrollTop||0},M=function(){return x?x.offsetHeight:window.innerHeight},N=function(a){if(0===a)return 0;var b=Math.ceil((a-M()*e)/q);return b>0?Math.min(r*b,s):0},O=function(a){var b=Math.ceil(M()/q),c=Math.ceil(b*e),d=Math.min(c,Math.ceil(a/q));return r*(d+b+c)},P=function(){if(r>0){var a=Math.round(z/r),b=Math.ceil((s-A-1)/r);C.style.height=Math.round(a*q)+"px",D.style.height=Math.round(b*q)+"px"}},Q=function(){y&&K();var a=L(),b=O(a);if(!isNaN(b)){z=N(a),A=Math.min(s,z+b)-1,b=A-z+1;var c,d,e,f,g,h=C,i=Object.create(null),j=new Array(b);for(P(),c=z;c<=A;c++)if(d=p[c],e=d.id,u[e])f=u[e],delete u[e],i[e]=f,j[c-z]=f;else{if(i[e])throw j.forEach(E),Error("Duplicate identifier found: "+e+", publication: "+d);j[c-z]={id:e,scope:void 0,element:void 0},i[e]=!0}for(var l in u)(f=u[l])&&((g=f.element)&&g.parentNode&&G(g),f.scope.$destroy());for(c=z;c<=A;c++)d=p[c],f=j[c-z],g=f.element,g?g!==h&&g.parentNode===v&&(I(g,h),h=g,f.scope[m]=d,f.scope.$index=c):k(function(a,b){H(a[0],h),f.element=h=a[0],i[f.id]=f,b[m]=d,b.$index=c,f.scope=b});u=i,B=a}},R=function(b){window.requestIdleCallback?window.requestIdleCallback(Q):b?a(Q,0,!0):Q()},S=function(a){a.preventDefault&&a.preventDefault();var b=M()*e*.5,c=Math.abs(L()-B);c>=b&&R(!0)},T=function(){s>0&&(y=!0,R(!0))};g.$watchCollection(l,function(a){p=a,s=a&&a.length,R(window.Modernizr.isfirefox||Modernizr.issafari)}),window.addEventListener("resize",T,!1),g.$on("scroll",S),g.$on("$destroy",function(){window.removeEventListener("resize",T,!1),t&&(t.disconnect(),t=null),x&&(x.removeEventListener("scroll",S,!1),x=null),w=null,v=null})}}}}]),angular.module("directives").controller("publicationController",["$scope","$controller",function(a,b){"use strict";b("myBooksController",{$scope:a})}]),angular.module("directives").directive("twPublicationGrid",["$window","$rootScope","cover","libraryModel","BaseUtil","inventory",function(a,b,c,d,e,f){"use strict";return{restrict:"E",replace:!0,scope:{deliverable:"=",coverClick:"&"},templateUrl:"../directives/publication-grid/publication-grid.tpl.html",link:function(g,h){var i=g.deliverable.id;h=h[0];var j=function(a){var b=Object.create(null);if(a.coverUri){b.backgroundImage="url("+a.blobUri+")",b.height="initial";var c=26/17,d=a.dimensions.height/a.dimensions.width,e=c/d,f=.8,i=1/f;if(e<f||e>i)b.backgroundSize="cover",b.paddingTop=100*c+"%";else if(e<1){var j=100*(1-e)/2;b.marginLeft=j.toFixed(2)+"%",b.width=(100-2*j).toFixed(2)+"%",b.paddingTop=100*c+"%"}else e>1&&(b.paddingTop=100*d+"%");e>1&&h.querySelector(".publication-cover-image").classList.add("cover-landscape")}g.coverStyles=b};g.isCurrent=b.modified===i,g.isNew=e.isNew(f.deliverables[i]),g.onClick=function(b){d.selection.isSelectionMode?(d.selection.toggle(i),b.stopPropagation()):(b.getModifierState&&b.getModifierState("Alt")&&(a.tw.debug=!0),g.coverClick())},g.$on("tw.metadata.update",function(a,d){if(d===i){var h=f.deliverables[i].cover;return g.isCurrent=b.modified===i,g.isNew=e.isNew(f.deliverables[i]),c.requestCover(h).then(j,j)}}),f.deliverables[i]&&c.requestCover(f.deliverables[i].cover).then(j,j),g.libModel=d,g.libSelection=d.selection}}}]),angular.module("directives").directive("twPublicationList",["$rootScope","cover","libraryModel","mybooks","BaseUtil",function(a,b,c,d,e){"use strict";return{restrict:"E",replace:!0,scope:{deliverable:"=",coverClick:"&"},templateUrl:"../directives/publication-list/publication-list.tpl.html",link:function(f){var g=function(a,b){var c,d,e={};b?(c=b.dimensions.height/b.dimensions.width,d="url("+b.blobUri+")"):(c=a.naturalHeight/a.naturalWidth,d="url("+a.getAttribute("src")+")"),e["background-image"]=d,f.coverStyles=e,f.coverHeightStyle={"padding-top":100*c+"%"},f.coverLoaded=!0},h=function(){f.coverStyles=null,f.coverHeightStyle=null,f.coverLaded=!1},i=function(a){if(a.dimensions)return g(null,a);var b=new Image;b.onLoad=g.bind(null,b),b.onerror=h,b.src=a.blobUri},j=function(){var a=f.deliverable&&f.deliverable.cover;b.requestCover(a).then(i,i)};f.isCurrent=a.modified===f.deliverable.id,f.isNew=e.isNew(f.deliverable),f.hasMultipleResellers=d.hasMultipleResellers(),f.onSelectionClick=function(a){a.stopPropagation(),a.preventDefault(),a.stopImmediatePropagation(),c.selection.toggle(f.deliverable.id)},f.onClick=function(a){c.selection.isSelectionMode?f.onSelectionClick(a):"publication-list-meta-menu"!==a.target.className&&f.coverClick()},f.$on("tw.metadata.update",function(a,b){b===f.deliverable.id&&j()}),j(),f.libModel=c,f.libSelection=c.selection}}}]),angular.module("directives").directive("twRecommendations",["$window","BaseUtil","bosh","reseller","cover","CONFIG",function(a,b,c,d,e,f){"use strict";return{restrict:"E",scope:{deliverable:"=",visible:"=",amount:"=",showshoplink:"=",showresellername:"="},templateUrl:"../directives/recommendations/recommendations.tpl.html",link:function(b){var e,g,h="?size=BS-B01",i=[],j=/^(https?:\/\/cdp\.)/i,k=function(a){"boolean"!=typeof a&&(a=!b.visible),b.visible=a},l=function(a){var c=a.recommendationResponse&&a.recommendationResponse.recommendations;if(c&&c.length>0){b.recommendations=[],angular.forEach(c,function(a){a.fallbackCoverUrl=f.globals.MEDIA.IMAGE_DEFAULT_PUB,a.cover_url&&(a.cover_url+=j.test(a.cover_url)?h:""),b.amount&&b.amount<=b.recommendations.length||b.recommendations.push(a)});var d=b.recommendations.length>0&&b.visible===!0;k(d)}},m=function(a){var b=a&&a.id||"none",d=/ebook|epaper|emagazine|audiobook/i.exec(a&&a.type);return c.fetchRecommendations(b,null,d&&d[0].toLowerCase()).then(l,null)},n=function(a){return d.fetchConfig().then(function(c){return b.translationData={reseller:c.STRING_BRAND_DISPLAY_NAME||""},e=c.URL_SHOP_RECOMMENDATIONS_BASE,g=c.URL_SHOP_START_PAGE,c.CHANNEL_ID&&(g+=g.indexOf("?")>-1?"&channelid="+c.CHANNEL_ID:"?channelid="+c.CHANNEL_ID),!e||e.endsWith("/")||e.endsWith("=")||e.endsWith("&")||e.endsWith("?")||(e+="/"),m(a).catch(function(a){console.warn("no recommendations - > ",a)})},function(){return f.globals.ERROR.APP_NO_CONFIG})};i.push(b.$watch("deliverable",n)),b.recommendations=[],b.translationData=null,b.goToResellerShop=function(){a.open(g,"_blank")},b.goToRecoInResellerShop=function(){var b=this;return d.fetchConfig().then(function(c){var d=b.reco?b.reco.shop_url:null;if(e&&d){"/"===d.charAt(0)&&(d=d.substr(1));var f=e+d;c.CHANNEL_ID&&(f+=f.indexOf("?")>-1?"&channelid="+c.CHANNEL_ID:"?channelid="+c.CHANNEL_ID),a.open(f,"_blank")}else a.open(g,"_blank")})},i.push(b.$on("$destroy",function(){for(var a=i&&i.length||0,c=0,d=a;c<d;c++)i[c]&&i[c]();b.deliverable=null,b.visible=null,b.recommendations=null,b.translationData=null,b.showShopLink=null,b.showResellerName=null}))}}}]),angular.module("directives").directive("twScroller",["$window","BaseUtil",function(a,b){"use strict";return{restrict:"E",transclude:!0,scope:{},templateUrl:"../directives/scroller/scroller.tpl.html",link:function(c,d){var e=200,f=angular.element(a),g=angular.element(a.document),h=d[0],i=h.querySelector("[ng-transclude]"),j=angular.element(d[0].querySelector(".knob")),k=!1,l=0,m=function(b,c){if(c<=b)return void a.fastdom.mutate(function(){j.removeClass("active")});a.fastdom.mutate(function(){j.addClass("active")});var d=Math.max(10,b/(c/b));j[0].style.height=d+"px"},n=function(b,c,d){var e=h.clientHeight/i.offsetHeight,f=c*e;a.fastdom.mutate(function(){j[0].style.transform="translate3d("+-b+"px,"+f+"px,0) scale("+d+")"})},o=function(b,c,d){n(b,c,d),a.fastdom.mutate(function(){i.style.transform="translate3d("+-b+"px,"+-c+"px,0) scale("+d+")"}),p()},p=b.throttle(function(){c.$broadcast("scroll")},e,{trailing:!0}),q={scrollingX:!1},r=new a.Scroller(o,q),s=!1,t=function(b){b.stopPropagation(),b.preventDefault();var c=a.normalizeWheel.normalize(b);c&&c.pixelY&&r.scrollBy(0,c.pixelY)},u=function(b){s=!0,a.document.addEventListener("mouseup",w,!1),a.document.addEventListener("mousemove",v,!1),a.document.addEventListener("touchmove",v,!1),a.document.addEventListener("touchend",w,!1),a.document.addEventListener("touchcancel",w,!1);var c,d;a.fdp.measure(function(){return c=b.pageY||b.touches&&b.touches[0]&&b.touches[0].pageY,d=b.pageX||b.touches&&b.touches[0]&&b.touches[0].pageX,document.elementFromPoint(d,c).classList.contains("knob")}).then(function(a){a?(k=!0,l=c):r.doTouchStart([{pageX:d,pageY:c}],b.timeStamp)})},v=function(b){b.stopPropagation(),b.preventDefault();var c;s&&a.fdp.measure(function(){c=b.pageY||b.touches&&b.touches[0]&&b.touches[0].pageY}).then(function(){a.fastdom.mutate(function(){i.style.pointerEvents="none"}),k?a.fdp.measure(function(){return i.offsetHeight/h.clientHeight}).then(function(a){var b=(c-l)*a;l=c,r.scrollBy(0,b)}):r.doTouchMove([{pageX:0,pageY:c}],b.timeStamp)})},w=function(b){b.stopPropagation(),s&&(a.document.removeEventListener("mousemove",v),a.document.removeEventListener("touchmove",v),a.document.removeEventListener("touchend",w),a.document.removeEventListener("touchcancel",w),k?(l=0,k=!1):r.doTouchEnd(b.timeStamp),s=!1,a.fastdom.mutate(function(){i.style.pointerEvents="all"}))},x=function(){a.setTimeout(function(){h.clientHeight&&i.clientHeight||console.info("tolino scroller has no height"),m(h.clientHeight,i.offsetHeight),r.setDimensions(h.clientWidth,h.clientHeight,i.clientWidth,i.clientHeight)},e)},y=window.MutationObserver||window.WebKitMutationObserver,z=new y(x);z.observe(i,{childList:!0,subtree:!0,attributes:!1});var A=b.getDebouncedFunction(x,e);f.bind("resize",A),d.bind(a.normalizeWheel.getEventType(),t),d.bind("mousedown",u),d.bind("touchstart",u),c.$on("$destroy",function(){f.unbind("resize",A),g.unbind("mousemove",v),g.unbind("touchmove",v),g.unbind("mouseup",w),g.unbind("touchend",w),d.unbind(),z.disconnect(),z=null})}}}]),angular.module("directives").directive("twSearchInput",["$timeout","$translate","appState","CONFIG",function(a,b,c,d){"use strict";return{restrict:"E",replace:!0,scope:{options:"=?"},templateUrl:"../directives/search-input/search-input.tpl.html",link:function(e,f,g){function h(a){a!==r&&(r=a?"search-history-"+a:null,j())}function i(){r&&v.length>0&&c.save(r,JSON.stringify(v))}function j(){if(v.length=0,r){var a=c.fetch(r);if(a)try{v=e.searchHistory=JSON.parse(a)||[]}catch(b){console.warn("tw.directives.searchInput: Was not able to parse search history:",a)}}}function k(a){return a=a.toLowerCase(),v.findIndex(function(b){return b.toLowerCase()===a})}function l(a){if(a="string"==typeof a?a.trim():"",a&&!(a.length<d.globals.MISC.SEARCH_TERM_MIN_LENGTH)){var b=k(a);0!==b&&(b>0&&v.splice(b,1),v.unshift(a),v.length>t&&v.pop(),i())}}function m(a){var b=k(a);b>=0&&(v.splice(b,1),i())}function n(){(u.searchTerm||u.hasLiveUpdate)&&(u.cbSearch?u.cbSearch(u.searchTerm):e.$emit("tw.search.exec",u.refId,u.searchTerm))}function o(){u.cbClear?u.cbClear():e.$emit("tw.search.clear",u.refId)}function p(){a(function(){s.focus()})}function q(a){e.showSearchHistory=a&&v.length>0}e.options||(e.options={});var r,s,t=5,u=e.options,v=e.searchHistory=[],w=!1;e.iconName=u.iconName||"search",e.searchHistory=v,e.showSearchHistory=!1,e.$watch("options.refId",h),e.clearSearchTerm=function(){u.searchTerm="",o(),q(!0),p()},e.removeHistoryItem=function(a,b){a.stopPropagation(),w=!0,m(b),q(!0)},e.onInputFocus=function(){q(!w),w=!1},e.onInputBlur=function(){a(function(){w||document.activeElement.isSameNode(s)||(q(!1),l(u.searchTerm)),document.activeElement.blur()},200,!0)},e.onInputKey=function(a){13===a.keyCode?(n(),q(!0)):27===a.keyCode&&q(!1)},e.onInputChange=function(){u.searchTerm?u.hasLiveUpdate&&n():o(),q(!0)},e.onSearchHistoryClick=function(a){var b=a&&a.target&&a.target.innerText;b&&(a.stopPropagation(),w=!0,u.searchTerm=b,l(b),q(!1),p(),n())},u.searchTerm=u&&u.searchTerm||"",u.placeHolderText=u&&u.placeHolderText||b.instant(gettext("SEARCH_PLACEHOLDER")),g.refId&&(u.refId=g.refId),s=f.find("input")[0],u.hasAutoFocus&&p(),h(u.refId),q(!0)}}}]),angular.module("directives").directive("twSelectList",["$window","$timeout","$translate",function(a,b,c){"use strict";return{restrict:"E",scope:{triggerIcon:"@",triggerTooltip:"@"},templateUrl:"../directives/select-list/select-list.tpl.html",transclude:!0,link:function(d,e){var f="assets/common/icons.svg#icon-";d.triggerIconUrl=f+d.triggerIcon,b(function(){d.triggerIconTooltip=c.instant(d.triggerTooltip)},100);var g=angular.element(a),h=null,i=function(a){if(a){var b=8,c=a.srcElement||a.target,d=c.getBoundingClientRect(),f={x:d.left,y:d.top,height:d.height,width:d.width},g=e[0].querySelector("div [class~=select-list-content]");h=angular.element(g);var i=g.getBoundingClientRect(),j=f.y+f.height+b,k=f.x-i.width/2+f.width/2;h.css("top",j+"px"),h.css("left",k+"px"),i=g.getBoundingClientRect();var l=g.offsetParent,m=l.getBoundingClientRect(),n=0;i.right>m.right&&(n=i.right-m.right+b,k-=n,h.css("left",k+"px")),i.bottom>m.bottom&&(n=i.bottom-m.bottom+b,j-=n,h.css("top",j+"px"))}};d.visible=!1,d.positionNeedsToBeCalculated=!0;var j;d.showSelectList=function(a){d.visible=!0,j=i.bind(this,a),b(function(){g.bind("resize",j),i(a),d.positionNeedsToBeCalculated=!1},0)},d.hideSelectList=function(){d.visible=!1,d.positionNeedsToBeCalculated=!0,g.unbind("resize",j)}}}}]),angular.module("directives").directive("twSelectionCheckbox",[function(){"use strict";return{restrict:"E",scope:{options:"="},templateUrl:"../directives/selection-checkbox/selection-checkbox.tpl.html",link:function(a){a.onCheckBoxClick=function(b){a.options.isChecked=!a.options.isChecked,a.$emit("selection-checkbox",a.options.isChecked),b.stopPropagation()}}}}]),angular.module("directives").directive("twSelectionHeaderBar",[function(){"use strict";return{restrict:"E",scope:{selectionTitle:"=",buttonLabel:"=",amount:"="},templateUrl:"../directives/selection-header-bar/selection-header-bar.tpl.html",link:function(a){a.cancelAction=function(){a.$emit("selection-header-bar-cancel")},a.confirmAction=function(){a.$emit("selection-header-bar-confirm")}}}}]),angular.module("directives").directive("showIf",[function(){"use strict";function a(a,b){return a.startsWith("WebKit")&&"w"+a.substr(1)+b.substr(0,1).toUpperCase()+b.substr(1)||a.startsWith("ms")&&"MS"+a.substr(2)+b.substr(0,1).toUpperCase()+b.substr(1)||a+b}function b(a){var b,c={ms:1,s:1e3},d=a.match(/([.\d]+)(ms|s)/);return d&&!isNaN(b=parseFloat(d[1]))?b*c[d[2]]:0}function c(a){var c=getComputedStyle(a);return Math.max(b(c[g+"Duration"]),b(c[h+"Duration"]))}var d="tw-hide-anim",e="tw-show-anim",f="tw-hidden",g=Modernizr.prefixed("transition"),h=Modernizr.prefixed("animation"),i=a(g,"end"),j=a(h,"end");return{restrict:"A",multiElement:!0,link:function(a,b,g){function h(){o&&(window.clearTimeout(o),o=null),m.removeEventListener(i,k,!1),m.removeEventListener(j,k,!1),m.removeEventListener(i,l,!1),m.removeEventListener(j,l,!1)}function k(){h(),n.remove(e)}function l(){h(),n.add(f),n.remove(d)}var m=b[0],n=m.classList,o=null;a.$watch(g.showIf,function(a,b){var g=a?k:l;return h(),a||b?(m.addEventListener(i,g,!1),m.addEventListener(j,g,!1),a?(n.add(e),n.remove(f)):n.add(d),void(o=window.setTimeout(g,c(m)))):void n.add(f)})}}}]),angular.module("directives").directive("twSidebarMenu",["$window","$rootScope","$sce","user","stateHelper","reseller","BaseUtil","CONFIG",function(a,b,c,d,e,f,g,h){"use strict";return{restrict:"E",scope:{closeMenu:"&"},templateUrl:"../directives/sidebar-menu/sidebar-menu.tpl.html",link:function(b){var i=f.getConfig(),j=function(a){b.visibleChildGroups.indexOf(a)>-1?b.visibleChildGroups.splice(b.visibleChildGroups.indexOf(a),1):b.visibleChildGroups.push(a)};b.visibleChildGroups=[],b.versionInfo=a.tw.version+" ("+a.tw.githash+")",b.resellerLogoName=null,b.translationData={},b.currentActiveSidebarMenuItem=e.getCurrentState().state.name.split(".")[0],b.items=[[{symbol:"home",state:"home",title:gettext("COMMON_LAST_ACTIVITIES"),tooltip:gettext("TOOLTIP_LIBRARY_SIDEBARMENU_LASTACTIVITIES")},{symbol:"book",state:"mybooks",title:gettext("COMMON_MY_BOOKS"),tooltip:gettext("TOOLTIP_LIBRARY_SIDEBARMENU_MYBOOKS")},{symbol:"headphone",state:"myaudiobooks",title:gettext("COMMON_MY_AUDIOBOOKS"),tooltip:gettext("TOOLTIP_LIBRARY_SIDEBARMENU_MYAUDIOBOOKS")}],[{state:"account",title:gettext("COMMON_MY_ACCOUNT"),tooltip:gettext("TOOLTIP_LIBRARY_SIDEBARMENU_MYACCOUNT")},{state:"help",title:gettext("COMMON_HELP"),tooltip:gettext("TOOLTIP_LIBRARY_SIDEBARMENU_HELP")}]];var k=[];i&&i.URL_SHOP_EBOOK_START_PAGE&&g.isNotNullValueFromOneRC(i.URL_SHOP_EBOOK_START_PAGE)&&k.push({state:null,symbol:"shop",title:gettext("COMMON_SHOPPING_EBOOKS"),tooltip:gettext("TOOLTIP_LIBRARY_SIDEBARMENU_EBOOKSHOP"),external:i.URL_SHOP_EBOOK_START_PAGE}),i&&i.URL_SHOP_AUDIO_START_PAGE&&g.isNotNullValueFromOneRC(i.URL_SHOP_AUDIO_START_PAGE)&&k.push({state:null,symbol:"shop",title:gettext("COMMON_SHOPPING_AUDIOBOOKS"),tooltip:gettext("TOOLTIP_LIBRARY_SIDEBARMENU_AUDIOBOOKSHOP"),external:i.URL_SHOP_AUDIO_START_PAGE}),k.length>0&&b.items.splice(1,0,k),b.trustIconUrl=function(a){return c.trustAsResourceUrl(a)},b.requestSidebarMenuToHide=function(){b.closeMenu&&b.closeMenu({value:!1})},b.login=function(){return d.login()},b.handleItemClick=function(c){return c.external?void(i.CHANNEL_ID?a.open(c.external+"?channelid="+i.CHANNEL_ID,"_blank"):a.open(c.external,"_blank")):c.state?e.goToState(c.state).finally(function(){b.requestSidebarMenuToHide()}):void(c.children&&c.children.length>0&&j(c.title))},b.$watch(function(){return d.isLoggedIn()},function(a){b.userIsLoggedIn=a});var l=h.globals.ONEAPP_SPALTER,m=f.getReseller();if(m){var n=f.convertFromId(m.resellerId);l.indexOf(n)>-1?b.resellerLogoName=n:b.resellerLogoName="tolinode",b.translationData.resellerName=m.resellerName||f.getConfig().STRING_BRAND_DISPLAY_NAME}else b.resellerLogoName="tolinode",b.translationData.resellerName="WebReader"}}}]),angular.module("directives").directive("twslider",["$rootScope","$timeout","$document",function(a,b,c){"use strict";return{restrict:"EA",scope:{twSliderFloor:"=?",twSliderCeil:"=?",twSliderShowLabel:"@",twSliderOrientation:"@",twSliderPrecision:"@",twSliderModel:"=?",twSliderLoaded:"=?",twSliderTranslate:"&",twSliderHidePointer:"=?"},templateUrl:"../directives/slider/slider.tpl.html",link:function(a,d){var e=d.attr("id"),f=0,g=0,h=0,i=!1,j=0,k=0,l=0,m=!1,n=!0,o={},p=null,q=function(a){var b=100*(a-j)/l;return b.toFixed(2)},r=function(a){var b=k>0?a/g*l+j:0;return+b.toFixed(h)},s=function(a,b){var c=a[0].getBoundingClientRect();return a.size=b?c[b]:n?c.width:c.height,a.size},t=function(a,b){var c=n?"width":"height";return a.css(c,b+"%"),a.size=b,b},u=function(a,b){var c=n?"left":"top";return a.css(c,b+"%"),a.offset=b,b},v=function(a,b){return a.css({"margin-left":n?b+"px":"","margin-top":n?"":b+"px"}),b},w=function(a,b,c){c=p&&("boolean"!=typeof c||c);var d=c?p(a):a?a.toString():"0";d!==b.value&&(b.text(d),b.value=d,s(b,"width"))},x=function(){a.twSliderOrientation&&(n="h"===a.twSliderOrientation.substr(0,1)),d.removeClass(n?"vertical":"horizontal"),d.addClass(n?"horizontal":"vertical")},y=function(){var b=a.twSliderCeil||a.twSliderModel;b>0&&(j=a.twSliderFloor||0,k=b,l=k-j)},z=function(a,b){u(o.loaded,a),b||(b=0),t(o.loaded,Math.max(b-a,0))},A=function(b){u(o.handle,b),t(o.progress,b),z(b,q(a.twSliderLoaded)),a.twSliderShowLabel&&(w(a.twSliderModel,o.lblValue),v(o.lblValue,-o.lblValue.size/2),u(o.lblValue,b))},B=function(){var b=q(a.twSliderModel);A(b)},C=function(){var a=s(o.handle);f=a/2,g=s(o.fullBar);var b=d[0].getBoundingClientRect();d.size=n?b.width:b.height,d.offset=n?b.left:b.top,m&&B()},D=function(){y(),C()},E=function(){var b=d[0].querySelectorAll("[data-name]");Array.prototype.forEach.call(b,function(b){var c=b.getAttribute("data-name");o[c]=angular.element(b),o[c].offset=0,!a.twSliderShowLabel&&c.startsWith("lbl")&&(b.style.display="none")})},F=function(a){var b=a.touches?a.touches[0]:a,c=n?b.clientX:b.clientY,d=o.fullBar[0].getBoundingClientRect(),e=n?d.left:d.top,f=c-e;return g=o.fullBar.size=n?d.width:d.height,Math.max(0,Math.min(g,f))},G=function(b){var c=F(b),d=c-o.handle.offset/100*g;if(Math.abs(d)>f){var h=r(c);a.$emit("tw.slider.step",{delta:h-a.twSliderModel,value:h},e)}},H=function(b){a.$emit("tw.slider.hover",b,e)},I=function(b){var c=F(b),d=r(c);b.preventDefault(),d!==a.twSliderModel&&(a.twSliderModel=d,A(c),a.$emit("tw.slider.update",d,e),a.$apply())},J=function(a){var b=a?c.on:c.off;b.call(c,"touchmove",I),b.call(c,"touchend",K),b.call(c,"touchleave",K),b.call(c,"mousemove",I),b.call(c,"mouseup",K),b.call(c,"mouseleave",L)},K=function(){o.handle.removeClass("active"),J(!1),a.$emit("tw.slider.stopMoving",e),i=!1},L=function(b){a.twSliderModel=b.clientX>0?k:j,K(b)},M=function(b){i||(C(),i=!0,a.$emit("tw.slider.startMoving",e),o.handle.addClass("active"),b.preventDefault(),J(!0))};a.$watch("twSliderModel",function(a,b){a!==b&&(y(),A(q(a)))}),a.$watch("twSliderLoaded",function(b,c){b!==c&&z(q(a.twSliderModel),q(b))}),a.$watch("twSliderFloor",function(a,b){a!==b&&D()}),a.$watch("twSliderCeil",function(a,b){a!==b&&D()}),a.$watch("twSliderOrientation",function(a,b){a!==b&&x()}),a.twSliderTranslate&&(p=a.twSliderTranslate()),E(),x(),C(),y(),h=void 0===a.twSliderPrecision?1:+a.twSliderPrecision,b(function(){B(),o.handle.on("touchstart",M),o.handle.on("mousedown",M),d.on("click",G),d.on("mousemove",H),d.on("contextmenu",function(a){return a.preventDefault(),!1})}),a.$on("reCalcViewDimensions",C),angular.element(window).on("resize",C),A(0),m=!0}}}]),angular.module("directives").directive("twTabBar",[function(){"use strict";return{restrict:"E",scope:{tabsConfig:"="},templateUrl:"../directives/tab-bar/tab-bar.tpl.html",transclude:!0,link:angular.noop}}]),angular.module("directives").directive("twTextNote",["$rootScope","$timeout","$translate",function(a,b,c){"use strict";return{restrict:"E",
replace:!0,scope:{options:"=",applyNote:"&"},templateUrl:"../directives/text-note/text-note.tpl.html",link:function(d,e){function f(){j.value="",d.options.isVisible=!1,a.$emit("tw.reader.interactions",!0)}function g(a,b){if(a){if(b===a.hasAttribute("disabled"))return;b?a.setAttribute("disabled",""):a.removeAttribute("disabled")}}function h(){g(l,i&&!j.value),g(k,!j.value)}var i,j=e[0].querySelector(".text-note"),k=e[0].querySelector(".note-buttons > .secondary"),l=e[0].querySelector(".note-buttons > .button-default"),m=d.applyNote();j.addEventListener("input",h,!1),d.$watch("options.isVisible",function(a,e){if(a!==e&&a){var f=d.options.note||"",g=f?gettext("TEXT_NOTE_EDIT"):gettext("TEXT_NOTE_TITLE");i=""===f,d.titleText=c.instant(g),j.value=f,h(),b(function(){j.focus()})}}),d.cancel=function(){d.options.isCreated&&m(d.options.target,null),f()},d.deleteNote=function(){m(d.options.target,null),f()},d.commitNote=function(){m(d.options.target,j.value.trim()),f()},d.$on("$destroy",function(){j.removeEventListener("input",h,!1)})}}}]),angular.module("directives").directive("twToggleButton",["$window","$translate","$timeout",function(a,b,c){"use strict";return{restrict:"E",scope:{name:"@",layout:"@",primaryIcon:"@",primaryTooltip:"@",secondaryIcon:"@",secondaryTooltip:"@",activeState:"@"},templateUrl:"../directives/toggle-button/toggle-button.tpl.html",link:function(d,e){var f="assets/common/icons.svg#icon-",g=[{id:"primary",iconUrl:f+d.secondaryIcon,toolTip:""},{id:"secondary",iconUrl:f+d.primaryIcon,toolTip:""}],h="primary"===d.activeState?0:1;d.iconUrl=g[h].iconUrl;var i=function(a){console.warn("Missing translation -> "+a)};d.primaryTooltip&&b(d.primaryTooltip).then(function(a){g[1].toolTip=a,b(d.secondaryTooltip).then(function(a){g[0].toolTip=a,d.iconTooltip=g[h].toolTip}).catch(i)}).catch(i);var j=function(b){if(!(b<0||b>=g.length)){if(h=b,d.iconUrl=g[h].iconUrl,d.iconTooltip=g[h].toolTip,a.Modernizr.isie){var f=e[0].getElementsByTagName("svg");if(f.length>0){var i=f[0],j=a.document.createElement("use");for(j.setAttribute("xlink:href",g[h].iconUrl);i.hasChildNodes();)i.removeChild(i.lastChild);i.appendChild(j)}}return c(angular.noop,1e3,!0).then(function(){Modernizr.isie&&svg4everybody()})}};d.$on("tw-toggle-button-set",function(a,b){if(b.name===d.name){var c=g.findIndex(function(a){return a.id===b.state});j(c)}}),d.$watch("activeState",function(a){var b="primary"===a?0:1;j(b)}),d.toggleState=function(){j(1-h),d.$emit("tw-toggle-button-change",{name:d.name,newState:g[h].id,oldState:g[1-h].id})}}}}]),angular.module("directives").directive("twToggleSwitch",[function(){"use strict";return{restrict:"E",replace:!0,scope:{toggleState:"="},templateUrl:"../directives/toggle-switch/toggle-switch.tpl.html",controller:"twToggleSwitchCtrl",link:function(a,b,c,d){d.init(b)}}}]).controller("twToggleSwitchCtrl",["$scope",function(a){"use strict";var b;a.toggleSwitchClick=function(){b.hasAttribute("disabled")||(a.toggleState=!a.toggleState)},this.init=function(a){b=a[0]}}]),angular.module("directives").directive("twTouchend",[function(){"use strict";return{restrict:"A",multiElement:!0,link:function(a,b){b.bind("touchend",function(c){var d=b.attr("tw-touchend");a.$event=c,a.$apply(d)})}}}]),angular.module("directives").directive("treeview",function(){"use strict";return{restrict:"E",template:'<div><div ng-repeat="node in nodes"><treenode></treenode></div>',replace:!0}}),angular.module("directives").directive("treenode",["$rootScope","$compile","$translate",function(a,b,c){"use strict";return{restrict:"E",replace:!0,templateUrl:"../directives/tree-view/tree-node.tpl.html",link:function(d,e){var f=function(a){var b=a.isEnabled?a.isActive?"active":"":"disabled",c=e[0].classList;b&&c.contains(b)||(c.remove("active"),c.remove("disabled"),b&&c.add(b))},g=function(a){var b=a.isLeafNode()?"leaf":a.isExpanded?"expanded":"collapsed",c=e[0].querySelector(".btn-expand").classList;c.contains(b)||(c.remove("leaf"),c.remove("expanded"),c.remove("collapsed"),c.add(b))};if(d.node.data&&e[0].querySelector(".node-label").classList.add("with-data"),f(d.node),g(d.node),d.node.needsTranslation){var h=e[0].querySelector("[class~=node-label]");if(h){h.setAttribute("data-translate",d.node.label);var i=function(){c(h.getAttribute("data-translate")).then(function(a){d.node.label=a}).catch(angular.noop)},j=a.$on("$translateChangeSuccess",i);i()}}if(d.toggleExpand=function(a){a.isExpanded||d.$emit("tw.expandTreeNode",a),a.toggleExpand()},d.onNodeClick=function(a){a&&a.isEnabled&&d.$emit("tw.treeNodeAction",a)},d.node.nodes.length>0){var k=b('<div ng-repeat="node in node.nodes"><treenode></treenode></div>');e.append(k(d))}var l=a.$on("tw.treeNodeStateChange",function(a,b){b===d.node&&(f(b),g(b))});d.$on("$destroy",function(){l(),j&&j()})}}}]),angular.module("directives").directive("uploadDialog",["$rootScope","$translate","CONFIG",function(a,b,c){"use strict";return{restrict:"E",scope:{},templateUrl:"../directives/upload-dialog/upload-dialog.tpl.html",link:function(d){function e(b,e){void 0!==e&&(e&&"string"!=typeof e||(e={state:"uploadFailure"}),f(e),d.uploadDialogOptions.dialogTimeoutInterval=d.uploadDialogOptions.hasFailed?0:c.globals.MISC.DIALOG_FADEOUT_TIME,d.uploadDialogOptions.isVisible=!0,a.$emit("tw.upload.progress.stop"))}function f(a){var c,e,f,g,h=d.uploadDialogOptions;if(angular.isArray(a.success)&&angular.isArray(a.fail)){if(e=a.success.length,f=a.fail.length,g=h.translationData,0===f)1===e?(g.title=a.success[0],c=gettext("DIALOG_RESULT_UPLOAD_TEXT_SUCCESS_1_TITLE")):(g.noOfUploadedFiles=e,c=gettext("DIALOG_RESULT_UPLOAD_TEXT_SUCCESS_MULTIPLE_TITLES"));else if(1===f){var i=a.fail[0]||{};i.indexOf&&i.search(/unsupported/i)>-1?c=gettext("DIALOG_RESULT_UPLOAD_TEXT_UNSUPPORTED_TITLE"):null===i.data&&0===i.status?c=gettext("DIALOG_RESULT_UPLOAD_WAS_CANCELED"):b(gettext("COMMON_UNKNOWN_TITLE")).then(function(a){g.title=i.fileName||a,h.dialogText=gettext("DIALOG_RESULT_UPLOAD_TEXT_FAIL_1_TITLE")}).catch(function(a){console.warn("Missing translation ->"+a)})}else f>1&&(g.noOfFails=f,g.totalNoOfUploadedFiles=e+f,c=gettext("DIALOG_RESULT_UPLOAD_TEXT_FAIL_MULTIPLE_TITLES"));b.refresh()}else c=gettext("DIALOG_RESULT_UPLOAD_WAS_CANCELED");h.dialogText=c,h.hasFailed=f>0||/Canceled|Fail/.test(a.state),h.dialogTitle=h.hasFailed?gettext("COMMON_ERROR"):gettext("DIALOG_RESULT_UPLOAD_SUCCESS")}d.uploadDialogOptions={isModal:!0,isVisible:!1,translationData:{}};var g=a.$on("tw.upload.done",e);d.$on("$destroy",function(){g()})}}}]),angular.module("directives").directive("uploadIndicator",["$rootScope","$timeout",function(a,b){"use strict";return{restrict:"E",scope:{},templateUrl:"../directives/upload-indicator/upload-indicator.tpl.html",link:function(c,d,e){var f=function(){c.show=!0},g=function(){c.show=!1},h=function(){return"startActive"in e&&"false"!==e.startActive&&"0"!==e.startActive};c.translationData={processStart:0,processEnd:0},h()&&f(),c.cancelAction=function(){g(),a.$emit("tw.library.upload.cancel",e.id)};var i=a.$on("tw.upload.progress.start",function(a,d){d&&(c.translationData.processStart=d.number,c.translationData.processEnd=d.total),b(f)}),j=a.$on("tw.upload.progress.stop",g);c.$on("$destroy",function(){i(),j()})}}}]),angular.module("directives").directive("twWelcomeDoodle",[function(){"use strict";return{restrict:"E",scope:{label:"@"},templateUrl:"../directives/welcome-doodle/welcome-doodle.tpl.html",link:angular.noop}}]),angular.module("account").directive("twAccountHeaderBar",["account",function(a){"use strict";return{restrict:"E",scope:{},template:"<tw-library-bar></tw-library-bar>",link:function(b){b.$on("menuAction",function(b){b.stopPropagation(),a.isMenuVisible()||a.setMenuVisible(!0)})}}}]),angular.module("account").directive("twAccountLanguage",["$translate","appState","CONFIG",function(a,b,c){"use strict";return{restrict:"E",scope:{},template:'<div class="account-language-label" translate>COMMON_LANGUAGE</div><div class="account-language-container"><tw-dropdown-list list-items="languages" selected-item="selectedLanguage"></tw-dropdown-list></div>',link:function(d){var e=[],f=function(){var a=b.fetch("lang"),c=d.languages;return c.filter(function(b){return b.id===a})[0]},g=function(c,d){c!==d&&(a.use("locale-"+c.id),b.save("lang",c.id))},h=function(){if(e&&e.length>0)for(var a=0;a<e.length;a++)e[a]&&e[a]()};d.languages=c.globals.LANGUAGES,d.selectedLanguage=f(),e.push(d.$watch("selectedLanguage",g)),e.push(d.$on("$destroy",h))}}}]),angular.module("account").directive("twAccountModal",["account",function(a){"use strict";return{restrict:"E",scope:{},template:'<div ng-click="hideMenu()" ng-class="{\'visible\' : menuVisible}" class="container-inner-modal"> </div>',link:function(b){b.menuVisible=!1,b.hideMenu=function(){a.isMenuVisible()&&a.setMenuVisible(!1)};var c=function(){return a.isMenuVisible()};b.$watch(c,function(a){b.menuVisible=a})}}}]),angular.module("account").directive("twAccountOptions",["account","reseller",function(a,b){"use strict";return{restrict:"E",scope:{},template:'<div ng-repeat="option in service.getOptions()"><div class="account-option-label" translate translate-values="translationData">{{ option.label }}</div><div class="account-option-container"><div translate translate-values="translationData">{{ option.sublabel }}</div><button ng-if="option.buttonlabel" ng-click="service.handleTarget(option.target)" class="secondary" translate>{{ option.buttonlabel }}</button></div></div>',link:function(c){c.service=a;var d=b.getReseller().resellerName||b.getConfig().STRING_BRAND_DISPLAY_NAME;c.translationData={},c.translationData.resellerName=d}}}]),angular.module("account").directive("twAccountSidebarMenu",["account",function(a){"use strict";return{restrict:"E",scope:{},template:'<tw-sidebar-menu ng-class="{\'visible\' : menuVisible}" close-menu="service.setMenuVisible(value)"></tw-sidebar-menu>',link:function(b){b.service=a,b.menuVisible=!1;var c=function(){return a.isMenuVisible()};b.$watch(c,function(a){b.menuVisible=a})}}}]),angular.module("account").directive("twAccountStatusBox",["$translate","$rootScope","user","reseller",function(a,b,c,d){"use strict";return{restrict:"E",scope:{},template:'<div class="account-box-status" translate translate-values="{{ translationData }}">{{ status }}</div><div class="account-box-container"><button ng-click="actionJackson()" class="raised" translate>{{ buttonLabel }}</button></div>',link:function(a){var b=function(){a.translationData.resellerName=d.getConfig().STRING_BRAND_DISPLAY_NAME,a.status=gettext("ACCOUNT_YOU_ARE_LOGGED_IN"),a.buttonLabel=gettext("COMMON_LOGOUT")},e=function(){a.status=gettext("ACCOUNT_YOU_ARE_NOT_LOGGED_IN"),a.buttonLabel=gettext("COMMON_LOGIN")};a.translationData={},a.actionJackson=function(){return c.isLoggedIn()?(e(),c.logout()):c.login()},c.isLoggedIn()?b():e()}}}]),angular.module("account").directive("twAccountTheme",["theme","reseller","resellerMapping","$timeout","CONFIG",function(a,b,c,d,e){"use strict";return{restrict:"E",scope:{},templateUrl:"../states/account/account-theme.tpl.html",link:function(d){var f=[],g=a.getThemeByName(a.getActiveThemeName()),h=a.getVariantByName(a.getActiveVariantName(),g.id),i=a.getUIFontByName(a.getActiveUIFontName()),j=function(d){for(var f=a.getVariantsForTheme(d),g=b.getReseller(),h=c.convertFromId(g.resellerId),i=e.globals.ONEAPP_SPALTER.indexOf(h)>-1,j=[],k=0,l=f.length;k<l;k++)"default"===f[k].id&&i||(f[k].id===h?j.unshift({id:f[k].id,label:f[k].primary}):j.push({id:f[k].id,label:f[k].secondary}));return j},k=function(b,c){b&&b!==c&&(a.setThemeByName(b.id),a.setIsSetByUser(),d.selectedThemeVariant=null,d.variants=j(b.id))},l=function(b,c){b&&b!==c&&(a.setVariantByName(b.id),a.setIsSetByUser())},m=function(b,c){b&&b!==c&&a.setUIFontByName(b.id)},n=function(){if(f&&f.length>0)for(var a=0;a<f.length;a++)f[a]&&f[a]()};f.push(d.$watch("selectedTheme",k)),f.push(d.$watch("selectedThemeVariant",l)),f.push(d.$watch("selectedUIFont",m)),f.push(d.$on("$destroy",n)),d.themes=a.getThemes(),d.variants=j(g.id||"default"),d.uifonts=a.getUIFonts(),d.selectedTheme=g,d.selectedThemeVariant=h,d.selectedUIFont=i}}}]),angular.module("account").factory("account",["$window","$rootScope","browserStorage","reseller","user","appState","BaseUtil",function(a,b,c,d,e,f,g){"use strict";var h=[{label:gettext("COMMON_HANDSHAKE"),sublabel:gettext("ACCOUNT_HANDSHAKE_INFO"),buttonlabel:gettext("ACCOUNT_HANDSHAKE_BUTTON_TEXT"),target:"HANDSHAKE",needsLogin:!0},{label:gettext("COMMON_DEVICE_MANAGEMENT"),sublabel:gettext("ACCOUNT_DEVICE_MANAGEMENT_INFO"),buttonlabel:gettext("ACCOUNT_DEVICE_MANAGEMENT_BUTTON_TEXT"),target:"DEVICES",needsLogin:!0}],i=!1,j=function(){return e.isLoggedIn()?h:h.filter(function(a){return a.needsLogin!==!0})},k=function(){return i},l=function(a){i=a},m=function(c){var e=d.getConfig(),h=f.fetch("lang"),i=g.getAppVersionNumber();switch("en_US"===h&&(h="en_GB"),c){case"HANDSHAKE":var j=e.URL_HANDSHAKE;b.$emit("tw.activity.indicator.start","root-indicator"),a.location=j+"?reseller="+e.org_reseller_id+"&lang="+h+"&invokingClientVersion="+i+"#handshake";break;case"DEVICES":var k=e.URL_DEVICE_MANAGEMENT;b.$emit("tw.activity.indicator.start","root-indicator"),a.location=k+"?reseller="+e.org_reseller_id+"&lang="+h+"&invokingClientVersion="+i+"#devices";break;case"LANGUAGES":}};return{getOptions:j,handleTarget:m,isMenuVisible:k,setMenuVisible:l}}]),angular.module("audio").directive("twAudioHeaderBar",["stateHelper","audio",function(a,b){"use strict";return{restrict:"E",scope:{},templateUrl:"../states/audio/audio-header-bar.tpl.html",link:function(c){var d=a.getCurrentState().params,e=d&&d.id,f=function(){return b.getCurrentAudiobook()};c.audiobook=null,c.back=function(){return a.goToLastVisitedState(1,"myaudiobooks")},c.$watch(f,function(a){c.audiobook=a}),b.isInit()||b.init(e)}}}]),angular.module("audio").directive("twAudioPlayer",["$sce","audio","audioElement","playlist",function(a,b,c,d){"use strict";return{restrict:"E",scope:{},templateUrl:"../states/audio/audio-player.tpl.html",link:function(b){b.audio=c,b.playlist=d,b.$watch("playlist.publication",function(c){c&&(b.description=a.trustAsHtml(d.publication.descAbstract))}),b.pause=function(){d.pause()},b.play=function(){d.play()}}}}]),angular.module("audio").directive("twAudioPlaylist",["audio","audioElement","playlist","stateHelper","$timeout",function(a,b,c,d,e){"use strict";return{restrict:"E",scope:{},templateUrl:"../states/audio/audio-playlist.tpl.html",link:function(f){f.audio=b,f.playlist=c,f.pointerEvents="none";var g=d.getCurrentState().params,h=g&&g.id;a.isInit()||(a.init(h),e(function(){f.pointerEvents="all"},500)),c.openDeliverable(h).then(null,function(a){console.log(a)})}}}]),angular.module("audio").filter("utc",[function(){"use strict";return function(a){return angular.isNumber(a)?a=new Date(a):a||(a=new Date(0)),new Date(a.getUTCFullYear(),a.getUTCMonth(),a.getUTCDate(),a.getUTCHours(),a.getUTCMinutes(),a.getUTCSeconds())}}]),angular.module("audio").factory("audio",["$rootScope","$q","$timeout","runtimeconfig","inventory",function(a,b,c,d,e){"use strict";var f,g=function(){return f},h=!1,i=function(a){if(a)return e.fetchPublications().then(function(){var b=e.getPubForDeliverable(a);f=b})},j=function(){return h};return{getCurrentAudiobook:g,isInit:j,init:i}}]),angular.module("comic").directive("twComicHeader",["stateHelper",function(a){"use strict";return{restrict:"E",scope:{},templateUrl:"../states/comic/partials/comic-header.tpl.html",link:function(b){b.isVisible=!1,b.close=function(){return a.goToLastVisitedState()},b.$on("header-request",function(a,c){b.isVisible=c,b.$apply()})}}}]),angular.module("comic").directive("twComicPager",["$window","$timeout","comic","BaseUtil","CONFIG",function(a,b,c,d,e){"use strict";return{restrict:"E",scope:{},templateUrl:"../states/comic/partials/comic-pager.tpl.html",link:function(f,g){var h=angular.element(a),i=500,j=!1,k=null,l=g[0],m=1,n=NaN,o=1,p=!0,q=function(a,b){if(b&&b.fileName){var c;if(c=p?k[b.page]:b.page%2===0&&0!==b.page?k[b.page-1]:k[b.page]){var d=c.node,e=d.offsetLeft;B.scrollTo(e,0,!0)}}},r=f.$on("page-request",q),s=e.globals.MISC.TAP_TRESHOLD,t=e.globals.MISC.DOUBLE_TAP_MAX_DELAY,u=null,v=null,w=null,x=!1,y=function(a){var b=a.changedTouches&&a.changedTouches.length>0?a.changedTouches:a.touches,c=a.screenX||b&&b[0]&&b[0].screenX,d=a.screenY||b&&b[0]&&b[0].screenY;return Math.abs(c-u)>s||Math.abs(d-v)>s},z=function(b,c,d){var e=a.Modernizr.prefixed("transform");l.style[e]="translate3d("+-b+"px,"+-c+"px,0) scale("+d+")",d<=1?B.options.scrollingY=!1:B.options.scrollingY=!0,d>=1?l.style.transformOrigin="left top":l.style.transformOrigin="center center",M()},A=function(){var a=l.getBoundingClientRect();B.setPosition(a.left+l.clientLeft,a.top+l.clientTop),B.setDimensions(l.clientWidth,l.clientHeight,l.scrollWidth,l.scrollHeight)},B=new a.Scroller(z,{zooming:!0,locking:!1,speedMultiplier:3}),C=function(){console.info("enabled comic interaction"),"ontouchstart"in a?(l.addEventListener("touchstart",E,!1),l.addEventListener("touchmove",F,!1),l.addEventListener("touchend",G,!1),l.addEventListener("touchcancel",G,!1)):(l.addEventListener(a.normalizeWheel.getEventType(),I,!1),l.addEventListener("mousedown",E,!1),l.addEventListener("mouseup",G,!1),l.addEventListener("mousemove",F,!1),l.addEventListener("mouseleave",G,!1))},D=function(){console.info("disabled comic interaction"),"ontouchstart"in a?(l.removeEventListener("touchstart",E),l.removeEventListener("touchmove",F),l.removeEventListener("touchend",G),l.removeEventListener("touchcancel",G)):(l.removeEventListener(a.normalizeWheel.getEventType(),I),l.removeEventListener("mousedown",E),l.removeEventListener("mouseup",G),l.removeEventListener("mousemove",F),l.removeEventListener("mouseleave",G))},E=function(a){a.stopPropagation(),a.preventDefault(),x=!0;var b=a.changedTouches&&a.changedTouches.length>0?a.changedTouches:a.touches,c=a.pageX||b&&b[0]&&b[0].pageX,d=a.pageY||b&&b[0]&&b[0].pageY;u=a.screenX||b&&b[0]&&b[0].screenX,v=a.screenY||b&&b[0]&&b[0].screenY,B.doTouchStart([{pageX:c,pageY:d}],a.timeStamp)},F=function(a){if(a.stopPropagation(),a.preventDefault(),x){var b=a.changedTouches&&a.changedTouches.length>0?a.changedTouches:a.touches,c=a.pageX||b&&b[0]&&b[0].pageX,d=a.pageY||b&&b[0]&&b[0].pageY;B.doTouchMove([{pageX:c,pageY:d}],a.timeStamp)}},G=function(b){b.stopPropagation(),b.preventDefault();var c=b.changedTouches&&b.changedTouches.length>0?b.changedTouches:b.touches,d=b.pageX||c&&c[0]&&c[0].pageX,e=b.pageY||c&&c[0]&&c[0].pageY;if(x){B.doTouchEnd(b.timeStamp),x=!1;var g=B.getValues().zoom;y(b)||(w?(clearTimeout(w),w=null,g>1?B.zoomTo(1,!0,d,e):B.zoomTo(2,!0,d,e)):w=setTimeout(function(){if(!(g>1)){var b=a.document.elementsFromPoint(d,e);b.some(function(a){if(a.dataset.page){var b=k[a.dataset.page];return q(null,b),b.node.classList.contains("is-current")&&f.$emit("page-selection"),!0}}),w=null}},t))}},H=0,I=function(a){a.stopPropagation(),a.preventDefault(),J(a)},J=d.throttle(function(b){var c=a.normalizeWheel.normalize(b);H+=c.pixelY,H>4?(B.scrollBy(m,0,!0),H=0):H<-4&&(B.scrollBy(m*-1,0,!0),H=0)},100,{trailing:!1}),K=function(){if(k){var a=l.getBoundingClientRect(),b=parseInt(Math.abs(a.left)/m,10);if(L(),b===n)return void(j=!1);n=b;var d=k.slice(b,b+o);c.fetchPages(d),j=!1}},L=function(){k.forEach(function(a){a.node.classList.remove("is-current")});var b=parseInt(a.innerWidth/2,10);k.some(function(a){var c=a.node.getBoundingClientRect(),d=c.left,e=c.width;if(!p){if(a.page%2===0&&0!==a.page)return!1;0!==a.page&&(e*=2)}return d<b&&d+e>=b&&(a.node.classList.add("is-current"),p||0===a.page||a.node.nextSibling.classList.add("is-current"),!0)})},M=d.throttle(function(){j||a.requestAnimationFrame(K),j=!0},300,{trailing:!0}),N=function(){if(k){var b=l.getBoundingClientRect().height-40,c=k[0].node,d=c.width||1,e=c.height||1,f=b/e;m=d=Math.round(f*d),o=Math.ceil(a.innerWidth/d)+1,O(d),k.forEach(function(a){a.node.style.width=d+"px",a.node.style.height=b+"px"}),A(),B.zoomTo(1,!0)}},O=function(b){var c=0;a.innerWidth/b<=2.3?(c=l.clientWidth/2-b/2,p=!0,B.setSnapSize(b,1)):(c=l.clientWidth/2-b,p=!1,B.setSnapSize(2*b,1)),l.style.left=c+"px"},P=d.getDebouncedFunction(N,i);h.bind("resize",P);var Q=function(){return c.getInfos()},R=f.$watch(Q,function(a){if(a)return R(),C(),k=[],S(a),c.registerNodes(k),c.fetchPages([k[0]]).then(function(){return k[0].node.classList.add("is-current"),b(N,250)})}),S=function(a){for(var b=0;b<a.pages.length;b++){var c={id:a.id+a.pages[b],page:b,fileName:a.pages[b],node:null},d=document.createElement("canvas");d.setAttribute("class","page"),d.setAttribute("data-page",b),c.node=d,k.push(c),l.appendChild(d)}};f.$on("$destroy",function(){D(),R(),r(),h.unbind("resize",P),M=null,P=null,s=null,t=null,u=null,v=null,w=null,x=!1,H=null,B=null,h=null,j=null,k=null,l=null,m=null,n=null,o=null,p=null})}}}]),angular.module("comic").directive("twComicToc",["$window","$timeout","comic","BaseUtil","CONFIG",function(a,b,c,d,e){"use strict";return{restrict:"E",scope:{},templateUrl:"../states/comic/partials/comic-toc.tpl.html",link:function(f,g){var h=250,i=e.globals.MEDIA.GRID_COVER_WIDTH,j=g[0],k=j.querySelector(".comic-toc"),l=j.querySelector(".comic-toc-toggle"),m=angular.element(a),n=!1,o=null,p=parseInt(a.innerWidth/i)+3,q=e.globals.MISC.TAP_TRESHOLD,r=e.globals.MISC.DOUBLE_TAP_MAX_DELAY,s=null,t=null,u=null,v=!1,w=function(b,c,d){var e=a.Modernizr.prefixed("transform");k.style[e]="translate3d("+-b+"px,"+-c+"px,0) scale("+d+")",I()},x=function(){var a=k.getBoundingClientRect();y.setPosition(a.left+k.clientLeft,a.top+k.clientTop),y.setDimensions(j.clientWidth,k.clientHeight,k.scrollWidth,k.clientHeight)},y=new a.Scroller(w,{scrollingY:!1}),z=function(){console.info("enabled toc interaction"),"ontouchstart"in a?(k.addEventListener("touchstart",C,!1),k.addEventListener("touchmove",D,!1),k.addEventListener("touchend",E,!1),k.addEventListener("touchcancel",E,!1)):(k.addEventListener(a.normalizeWheel.getEventType(),F,!1),k.addEventListener("mousedown",C,!1),k.addEventListener("mouseup",E,!1),k.addEventListener("mousemove",D,!1),k.addEventListener("mouseleave",E,!1))},A=function(){console.info("disabled toc interaction"),"ontouchstart"in a?(k.removeEventListener("touchstart",C),k.removeEventListener("touchmove",D),k.removeEventListener("touchend",E),k.removeEventListener("touchcancel",E)):(k.removeEventListener(a.normalizeWheel.getEventType(),F),k.removeEventListener("mousedown",C),k.removeEventListener("mouseup",E),k.removeEventListener("mousemove",D),k.removeEventListener("mouseleave",E))},B=function(a){var b=a.changedTouches&&a.changedTouches.length>0?a.changedTouches:a.touches,c=a.screenX||b&&b[0]&&b[0].screenX,d=a.screenY||b&&b[0]&&b[0].screenY;return Math.abs(c-s)>q||Math.abs(d-t)>q},C=function(a){a.stopPropagation(),a.preventDefault(),v=!0;var b=a.changedTouches&&a.changedTouches.length>0?a.changedTouches:a.touches,c=a.pageX||b&&b[0]&&b[0].pageX,d=a.pageY||b&&b[0]&&b[0].pageY;s=a.screenX||b&&b[0]&&b[0].screenX,t=a.screenY||b&&b[0]&&b[0].screenY,y.doTouchStart([{pageX:c,pageY:d}],a.timeStamp)},D=function(a){if(a.stopPropagation(),a.preventDefault(),v){var b=a.changedTouches&&a.changedTouches.length>0?a.changedTouches:a.touches,c=a.pageX||b&&b[0]&&b[0].pageX,d=a.pageY||b&&b[0]&&b[0].pageY;y.doTouchMove([{pageX:c,pageY:d}],a.timeStamp)}},E=function(b){b.stopPropagation(),b.preventDefault();var c=b.changedTouches&&b.changedTouches.length>0?b.changedTouches:b.touches,d=b.pageX||c&&c[0]&&c[0].pageX,e=b.pageY||c&&c[0]&&c[0].pageY;v&&(B(b)||(u?(clearTimeout(u),u=null):u=setTimeout(function(){var b=a.document.elementsFromPoint(d,e);b.some(function(a){if(a.dataset.page){var b=G[a.dataset.page];return f.$emit("toc-selection",b),!0}}),u=null},r)),y.doTouchEnd(b.timeStamp),v=!1)},F=function(b){b.stopPropagation(),b.preventDefault();var c=a.normalizeWheel.normalize(b);y.scrollBy(10*c.spinY)},G=null,H=function(){if(G){var a=k.getBoundingClientRect(),b=parseInt(Math.abs(a.left)/i,10);if(b===o)return void(n=!1);o=b;var d=G.slice(b,b+p);c.fetchPages(d,!0),n=!1}},I=d.throttle(function(){n||a.requestAnimationFrame(H),n=!0},300,{trailing:!0}),J=function(){p=parseInt(a.innerWidth/i,10)+3,x()},K=d.getDebouncedFunction(J,h);m.bind("resize",K);var L=function(){return c.getInfos()},M=f.$watch(L,function(d){if(d){var e=d.numOfFiles;if(e){M(),z(),G=[];for(var f=0;f<e;f++){var g=a.document.createElement("canvas");g.style.width=i+"px",g.style.height="300px",g.setAttribute("data-page",f),k.appendChild(g);var h={id:d.id+d.pages[f],isThumbnail:!0,page:f,fileName:d.pages[f],node:g};G.push(h)}return c.registerNodes(G),b(J,250)}}}),N=function(a,b){var c=j&&j.classList&&j.classList.contains("is-active");a&&a.currentScope&&(c=!b),c?j.classList.remove("is-active"):j.classList.add("is-active")},O=f.$on("header-request",N),P=function(){j.classList.remove("is-active")};l.addEventListener("click",N,!1),f.$on("$destroy",function(){M(),l.removeEventListener("click",N,!1),j.removeEventListener("mouseleave",P,!1),A(),O(),m.unbind("resize",K),K=null,G=null,j=null,n=null,o=null,p=null,h=null,i=null,k=null,l=null,q=null,r=null,s=null,t=null,u=null,v=!1})}}}]),angular.module("comic").directive("twComic",["$rootScope","stateHelper","comic",function(a,b,c){"use strict";return{restrict:"E",scope:{},templateUrl:"../states/comic/partials/comic.tpl.html",link:function(d){var e=!1;d.close=function(){return b.goToLastVisitedState()},d.$on("toc-selection",function(a,b){a.stopPropagation(),d.$broadcast("page-request",b)}),d.$on("page-selection",function(a){a.stopPropagation(),e=!e,d.$broadcast("header-request",e)});var f=b.getCurrentState().params;return f.id?(a.$emit("tw.audio.mini.player",{show:!1}),d.state="library",a.currentDeliverable=d.deliverableid=f&&f.id,d.$on("$destroy",function(){a.currentDeliverable=null,c.reset()}),void c.openComic(f)):d.close()}}}]),angular.module("comic").factory("comic",["$window","$rootScope","$q","$injector","CONFIG","user","$timeout",function(a,b,c,d,e,f,g){"use strict";var h=null,i=null,j=null,k={},l={},m={},n={},o=function(){if(!h){var a=d.get("BaseUtil").getWorkerSource("comic.worker.js");h=new Worker(a),h.addEventListener("message",p)}},p=function(a){var b=a.data;switch(b.request){case"save-page":case"save-comic":if(n[b.id]){var c=m[b.id],d=l[b.id];c.isDrawn=!0,d.isDrawn=!0,n[b.id]=!1,delete n[b.id]}break;case"load-page":b.error?k[b.id].reject(b):k[b.id].resolve(b),delete k[b.id];break;case"load-comic":return b.infos&&(i=b.infos),g(angular.noop,100)}},q=function(c){h||o();var k,l=b.comicBuffer;if(l){delete b.comicBuffer;var m=d.get("Archive");j=new m(l.buffer);var n=[];j.centralDirectory.forEach(function(a){n.push(a.fileName)});var p=r(l.name);i={id:p.deliverableId,meta:p,numOfFiles:j.numOfFiles,pages:n},k={request:"save-comic",id:p.deliverableId,infos:i,dbConfig:e.globals.INDEXED_CONFIG.comic,globals:e.globals,isLoggedIn:f.isLoggedIn(),revision:a.tw.githash},h.postMessage(k),g(angular.noop,0)}else{var q=c.id;if(q){var s=d.get("inventory");return s.fetchLocalPublications().then(function(){var b=s.deliverables[q];b&&(k={request:"load-comic",id:c.id,dbConfig:e.globals.INDEXED_CONFIG.comic,globals:e.globals,isLoggedIn:f.isLoggedIn(),revision:a.tw.githash},h.postMessage(k))})}}},r=function(b){return{deliverableId:a.btoa(b),title:b,type:"comic",subtitle:null,author:null,publisher:null,isbn:null,edition:null,pages:0,issued:0,language:"en",local:!0,format:s(b)}},s=function(a){var b=a.toLowerCase();return b.endsWith("cbr")?"application/x-cbr":b.endsWith("cbt")?"application/x-cbt":"application/x-cbz"},t=function(a){var b=[];return a.forEach(function(a){if(!n[a.id]){var c=m[a.id],d=l[a.id];c.isDrawn&&d.isDrawn||(n[a.id]=!0,b.push(a.id))}}),b.length>0?u(b).then(function(a){if(j&&a&&a.length>0)return v(a)}):c.resolve()},u=function(b){var d=[];b.forEach(function(b){if(!k[b]){k[b]=c.defer();var g={request:"load-page",id:b,dbConfig:e.globals.INDEXED_CONFIG.comic,globals:e.globals,isLoggedIn:f.isLoggedIn(),revision:a.tw.githash};d.push(k[b].promise),h.postMessage(g)}});var g=function(a){a.success.forEach(function(a){var b=m[a.id],c=l[a.id],d=URL.createObjectURL(a.file),e=b.node.getContext("2d"),f=c.node.getContext("2d"),g=new Image;g.onload=function(){b.node.width=g.naturalWidth,b.node.height=g.naturalHeight,e.drawImage(g,0,0);var h=200,i=h/g.width;c.node.width=g.width*i,c.node.height=g.height*i,f.drawImage(g,0,0,c.node.width,c.node.height),URL.revokeObjectURL(d),g=null,b.isDrawn=!0,c.isDrawn=!0,n[a.id]=!1,delete n[a.id]},g.src=d});var b=[];return a.fail.forEach(function(a){var c=m[a.id],d=l[a.id];b.push(a.id),c.isDrawn=!1,d.isDrawn=!1}),b};return c.allComplete(d).then(g,g)},v=function(a){var b=[],d=c.defer(),e=function(c){return c?void w(c).then(function(){b.push(c),a.length>0?e(a.shift()):d.resolve(b)},null):d.resolve(b)};return e(a.shift()),d.promise},w=function(b){var d=m[b],g=l[b],i=j.files[d.fileName];return i.extract().then(function(j){i.releaseContent();var k=c.defer(),l=URL.createObjectURL(new Blob([j],{type:"image/jpeg"})),m=d.node.getContext("2d"),n=g.node.getContext("2d"),o=new Image;return o.onload=function(){d.node.width=o.naturalWidth,d.node.height=o.naturalHeight,m.drawImage(o,0,0);var c=200,i=c/o.width;g.node.width=o.width*i,g.node.height=o.height*i,n.drawImage(o,0,0,g.node.width,g.node.height),URL.revokeObjectURL(l),o=null,d.isDrawn=!0,g.isDrawn=!0;try{d.node.toBlob(function(c){var d={request:"save-page",file:c,id:b,dbConfig:e.globals.INDEXED_CONFIG.comic,globals:e.globals,isLoggedIn:f.isLoggedIn(),revision:a.tw.githash};h.postMessage(d),k.resolve(b)},"image/jpeg",.8)}catch(a){angular.noop()}},o.onerror=k.reject,o.src=l,k.promise})},x=function(){return i},y=function(a){a.forEach(function(a){a.isThumbnail?l[a.id]=a:m[a.id]=a})},z=function(){j&&(j.destroy(),j=null),h&&(h.removeEventListener("message",p),h.terminate(),h=null),i=null,n={},m={},l={},k={}};return{openComic:q,registerNodes:y,fetchPages:t,getInfos:x,reset:z}}]),angular.module("country").directive("twCountryButtonList",["$rootScope","reseller","stateHelper",function(a,b,c){"use strict";return{restrict:"E",replace:!1,scope:{},templateUrl:"../states/country/country-button-list.tpl.html",link:function(d){d.setCountry=function(d){if(d)return a.$emit("tw.activity.indicator.start","country"),b.setCountry(d),c.goToLastVisitedState()},d.service=b}}}]),angular.module("country").directive("twCountryLabelButton",[function(){"use strict";return{restrict:"E",replace:!1,scope:{label:"@"},template:"<tw-label-button label='{{label}}'></tw-label-button>",link:angular.noop}}]),angular.module("country").directive("twCountryStateWatcher",["$rootScope",function(a){"use strict";return{restrict:"A",link:function(){var b=a.$on("$viewContentLoaded",function(){a.$emit("tw.activity.indicator.stop","country"),b()})}}}]),angular.module("download").directive("twDownloadStateWatcher",["inventory","$rootScope","$state","stateHelper",function(a,b,c,d){"use strict";return{restrict:"E",link:function(){var e=b.$on("$viewContentLoaded",function(){if(c.includes("download.**")){var f=d.getCurrentState().params;return f&&f.id?(b.$emit("tw.activity.indicator.start","download"),a.fetchPublications().then(function(){var a=b.$on("tw.library.download.close",function(){return a(),d.goToState("home")});b.$emit("tw.library.download",f.id),b.$emit("tw.activity.indicator.stop","download")},function(){return b.$emit("tw.activity.indicator.stop","download"),d.goToState("home")})):d.goToState("home")}e()})}}}]),angular.module("epub").controller("ToolbarAnnotationsCtrl",["$scope","$timeout",function(a,b){"use strict";var c=function(b){a.isToolbarVisible=!!b};a.isToolbarVisible=!1,a.$on("requestAnnotationsToolbar",function(){c(!0)}),a.$on("requestAnnotationsToolbarToHide",function(){a.noAnimation=!1,b(c,0)})}]),angular.module("epub").controller("BookmarkController",["$window","$scope","contentProvider",function(a,b,c){"use strict";var d,e,f=function(a){a!==e&&(e=a)},g=function(a,b){if(a.fileIndex!==b.fileIndex)return a.fileIndex-b.fileIndex;for(var c=Math.max(a.childSequence.length,b.childSequence.length),d=0,e=c;d<e;d++){
if(void 0===a.childSequence[d])return-1;if(void 0===b.childSequence[d])return 1;var f=a.childSequence[d]-b.childSequence[d];if(0!==f)return f}return a.offset-b.offset},h=function(a){return parseInt(a,10)},i=function(a){var b,c,e="",f=a&&a.match(/([^#]*)#point\(([^:\)]*):?(\d*)\)/i);return f&&(e=f[1],b=f[2].split("/").map(h),b.length>0&&isNaN(b[0])&&b.shift(),c=parseInt(f[3],10),isNaN(c)&&(c=0)),{fileName:e,fileIndex:d&&d[e]||0,childSequence:b||[],offset:c||0}},j=function(a){var b=function(a,b){return g(a.RMSDKInfo,b.RMSDKInfo)};a.forEach(function(a){a.RMSDKInfo||(a.RMSDKInfo=i(a.rmsdkPosition))}),a.sort(b)},k=function(a){return!a.deleted},l=function(){if(b.isToolbarVisible&&(b.annotations.length=0,e)){var c=Array.prototype.filter.call(e.dogears||[],k),d=Array.prototype.filter.call(e.comments||[],k);c.forEach(function(b){b.id||b.transientId||(b.transientId=a.btoa(a.encodeURIComponent(b.rmsdkPosition)))}),d.forEach(function(b){b.id||b.transientId||(b.transientId=a.btoa(a.encodeURIComponent(b.rmsdkPosition+b.endPosition)))}),Array.prototype.push.apply(b.annotations,d),Array.prototype.push.apply(b.annotations,c),j(b.annotations)}};b.annotations=[],b.$on("tw.ePub.metaData",function(a,b){d=c.getEPubInfo().spineIndex,f(b.deliverable),l()}),b.$on("tw.ePub.metaData.changed",function(a,b){f(b),l()}),b.$on("requestAnnotationsToolbar",function(){l()})}]),angular.module("epub").controller("FontSettingsCtrl",["$window","$rootScope","$scope","$sce","$timeout","CONFIG","appState","FontStore","FontStyle",function(a,b,c,d,e,f,g,h,i){"use strict";var j=new h,k=function(a){var b=/fs_(\d+)/.exec(a);return b&&parseInt(b[1],10)||m},l=function(a){return Math.max(c.minFontSize,Math.min(a,c.maxFontSize))},m=k(f.globals.FONT.DEFAULTS.fontSize),n={fontFamily:f.globals.FONT.DEFAULTS.fontFamily,textAlign:f.globals.FONT.DEFAULTS.textAlign,lineHeight:f.globals.FONT.DEFAULTS.lineHeight},o="tolino_prevFontSettings",p=!0,q=function(){for(var a in n)if(n[a]!==c.fontSettings[a])return!1;return!0},r=function(a){c.isToolbarVisible=!!a,c.isToolbarVisible||(c.fontFamilies.isVisible=!1)},s=function(a){var d="fs_"+a,e=c.fontSettings.fontSize;d!==e&&(c.fontSettings.fontSize=d,b.$emit("tw.fontSettings.change","fontSize",d,e))},t=function(a){var b=l(c.fontSizeIndex+a);b!==c.fontSizeIndex&&(c.fontSizeIndex=b,s(b))},u=function(a,b){return b.id===a},v=function(a){return a?d.trustAsHtml('<svg viewBox="0 -20 240 30" preserveAspectRatio="xMinYMid">'+a+"</svg>"):""},w=function(a){"string"==typeof a&&(a=JSON.parse(a));var b=j.getFontIdentifier(a),d=a.preview&&a.preview.svg,e=c.fontFamilies.list,f=e.findIndex(u.bind(null,b));if(f>=0){var g=e[f];return void(!g.isPreviewRegular&&i.isRegularStyle(a.subFamily,a.fileName)&&(g.preview=v(d),g.isPreviewRegular=!0))}var h=a.fontName.toLowerCase();for(f=e.length-1;f>1&&h.localeCompare(e[f].name.toLowerCase())<=0;)f--;e.splice(f,0,{id:b,name:a.fontName,preview:v(d),isPreviewRegular:i.isRegularStyle(a.subFamily,a.fileName)})},x=function(){for(var b in f.globals.FONT.CUSTOM){var d=f.globals.FONT.CUSTOM[b];c.fontFamilies.list.push({id:d.id,name:d.name,preview:v(d.preview),isPreInstalled:!0,isPreviewRegular:!0})}var e=a.infoforage;e&&e.keys().then(function(a){for(var b=0,c=a.length;b<c;b++)a[b].match(/^font:meta:(.*)$/)&&e.getItem(a[b]).then(w)})},y=function(){var a=Object.create(null);for(var b in n)a[b]=c.fontSettings[b];g.save(o,JSON.stringify(a))},z=function(){var a=JSON.parse(g.fetch(o)||"{}");for(var b in a)A(b,a[b])},A=function(a,d,e,f){var g=c.fontSettings[a];if(d!==g){if(c.fontSettings[a]=d,"fontFamily"===a){var h=c.fontFamilies.list.findIndex(u.bind(null,d));h===-1&&(h=0,d=c.fontFamilies.list[h].id,c.fontSettings.fontFamily=d),c.fontFamilies.selectedIndex=h}else"fontSize"===a&&(c.fontSizeIndex=k(d));c.fontSettings.isDefault||y(),e||b.$emit("tw.fontSettings.change",a,d,g),c.fontSettings.isDefault=f||q()}};c.isToolbarVisible=!1,c.noAnimation=!1,c.fontFamilies={title:gettext("FONT_SETTINGS_FONT_FAMILY"),list:[{id:"default",name:gettext("FONT_SETTINGS_FONT_FAMILY_DEFAULT"),isPreInstalled:!0}],isVisible:!1,selectedIndex:0},c.openFontList=function(){c.fontFamilies.isVisible=!0},c.deleteFontFamily=function(a){var b=c.fontFamilies,d=b.list.findIndex(u.bind(null,a.id));d>=0&&!a.isPreInstalled&&(d===b.selectedIndex&&(b.selectedIndex=0),b.list.splice(d,1),j.removeUserDefinedFont(a.id))},c.fontSizeIndex=m,c.minFontSize=1,c.maxFontSize=20,c.fontSettings={fontSize:"fs_"+m,fontFamily:"default",textAlign:"default",lineHeight:"default",backgroundMode:"bgwhite",readingMode:"paged",isDefault:!0},c.applyFontSettings=function(a,b){var d=c.fontSettings[a];a in n&&c.fontSettings.isDefault&&b!==d&&(p=!1),A(a,b)},c.changeFontSize=t,c.$on("requestFontSettingsToolbar",function(){r(!0)}),c.$on("requestFontSettingsToolbarToHide",function(){c.noAnimation=!1,e(r,0)}),c.$on("tw.slider.update",function(a,b,d){"slider-font-size"===d&&c.isToolbarVisible&&!isNaN(b)&&s(l(b))}),c.$on("tw.slider.step",function(a,b,c){"slider-font-size"===c&&t(b.delta>0?1:-1)}),c.$watch("fontSettings.isDefault",function(a,b){if(a){p=!0,b!==a&&y();for(var c in n)A(c,n[c],null,a)}else p?z():y()}),c.$watch("fontFamilies.selectedIndex",function(a){var b=c.fontFamilies.list[a];c.fontSettings.isDefault&&a>0&&(p=!1),A("fontFamily",b&&b.id)});var B=[];B.push(b.$on("tw.font.loaded",function(a,b){w(b);var d=b.fontName||i.getFontInfo(b.fileName).family,e=c.fontSettings.fontFamily;d===e&&j.addCustomFont(d),p=!1,A("fontFamily",d)})),B.push(b.$on("tw.fontSettings.apply",function(a,b,c){A(b,c,!0)})),c.$on("$destroy",function(){for(var a;a=B.pop();)a()}),x()}]),angular.module("epub").controller("ReaderCtrl",["$rootScope","$scope","$window","$injector","$log","$timeout","$q","$location","$translate","stateHelper","BaseUtil","StringUtil","contentProvider","ContentProcessor","HTML","PageNavHelper","tocNavHelper","appState","CONFIG","loader","PageLocation","PagePartitioner","FullTextSearch","Annotations","ScriptSupport","EPubReadingSystem","textToSpeech",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A){"use strict";function B(d){var f=j.getCurrentState().state.name;if(b.isSliderVisible=!1,"epub"!==f){var h="publication loaded but current state is '"+f+"'. Expected epub. aborting";return e.warn(h),ib(!1),g.reject(h)}if(a.isSampleReader&&b.$broadcast("enableToolbarPanel",{id:"bookmarks",isEnabled:!1}),d&&d.crypto&&m.setCryptInfos(d.crypto),d&&d.buffer){var i=angular.element(c);return i.bind("beforeunload",$b),i.bind("popstate",$b),a.$broadcast("tw.reader.deliverable.changed",Ib),E(d.buffer).then(function(){a.$broadcast("tw.setPageLocation",P().pageLocation),G(b.initaction)},C)}var k={message:"Invalid or empty response from server",id:Ib.id,details:JSON.stringify(Ib),reason:"CONTENT_ERROR"};return e.error(k.message),ib(!1),g.reject(k)}function C(a){if(ib(!1),console.warn("onLoadPublicationFailed:",a),hb(!0),"object"!=typeof a)return b.$emit("tw.requestExitReader"),g.resolve();var e=d.get("error"),f={type:s.globals.ERROR.APP_CONTENT_PARSER_FAIL,details:{deliverableId:Ib.id,deliverable:JSON.stringify(Ib)},ui:{message:c.gettext("CONTENT_ERROR_MESSAGE"),headline:c.gettext("SERVER_ERROR_TITLE")},bosh:Ib&&"EDATA"!==Ib.type};return e.handleError(f,!0).catch(function(){b.$emit("tw.requestExitReader")}).finally(function(){"library"===b.state&&D()})}function D(){var a=b.deliverableid;if("library"===b.state&&a){var d=c.infoforage,e=ob("inventory").deliverables[a];c.localforage.removeItem(a),d.removeItem(a),e&&(e.isOffline=!1),ma(),b.deliverableid=null,m.clearData()}}function E(a){var b=N();return b.setAttribute("current-section",""),zb=b.getAttribute("section-id"),m.initWithArrayBuffer(a,Ib).then(F,null).then(V,null).then(ib,null).then(jb.bind(null,!0,!0))}function F(){var a=m.getEPubInfo(),c=a.toc||{};return b.publicationTitle=Ib&&Ib.title||a.metadata&&a.metadata["dc:title"]||c.docTitle||"","library"===b.state&&Ib&&(m.isScripted()&&null===Ib.hasUnsupportedFeat&&H(new Array("EDATA"===Ib.type?1:0)),window.Modernizr.androidchromebelow39&&null===Ib.hasUnsupportedFeat&&m.scanHTMLTags("audio, video").then(H),b.textToSpeechEnabled=A.isWebSpeechAPISupported()&&Ib.hasUnsupportedFeat!==!0),g.resolve()}function G(a){"showBookmarks"===a&&b.$broadcast("showBookmarks")}function H(a){var c=!!a&&a.length>0;Ib.hasUnsupportedFeat=c,ma(),c&&(b.cautionInfoDialog.isVisible=!0)}function I(a,c){var d=document.querySelector("iframe[section-id='"+c+"']")||N(),c=d.getAttribute("section-id"),e=b.sectionData[c]||{},f=m.getNameOfCurrentSection();e.fileName=f,e.deliverable=Ib,e.content=a,b.currentSectionLabel=m.getSectionLabel(f),qb.viewport=m.getViewport(),Zb();var i=h.search();return(i.purchaseurl||i.backref)&&b.$broadcast("initToolbarButtons",{purchase:i.purchaseurl,back:i.backref}),Cb[c]||(Cb[c]=g.defer()),Cb[c].promise}function J(a,b){Yb(),Cb[b]&&(Cb[b].resolve(),delete Cb[b])}function K(a,b,c){D(),Ib&&(c.id=Ib.id,c.details=JSON.stringify(Ib)),Cb[b]&&(Cb[b].reject(c),delete Cb[b])}function L(a){Hb=!0,a<0&&qb.scrollOffset<=0?Z("last"):a>0&&qb.isLastPage[zb]?Y():b.$broadcast("tw.section.navigate","vertical",zb,a)}function M(){Hb?Aa():Hb=!0,!Vb||Vb.isPaused()||gb()||Vb.stop()}function N(){return xb&&xb.querySelector("iframe[current-section]")||document.querySelector("iframe.tolino-web-reader:last-child")}function O(){return N().contentDocument}function P(){var a=N().getAttribute("section-id");return b.sectionData[a]}function Q(){return Nb.sectionName=null,Nb.promise=null,g.resolve()}function R(a,b,c){var d=m.getNameOfCurrentSection();if(!(Nb.sectionName||d!==a&&a))return b();if(Vb&&Vb.stop(),Nb.cbAfterSectionFetched=b,Nb.sectionName===a)return Nb.promise;Nb.sectionName=a;var e=S(a,d);return hb(!1),Nb.promise=m.getSectionByName(a).then(T.bind(null,e),null).then(I,null).then(ab.bind(this,c),null).then(Q,null).then(Nb.cbAfterSectionFetched,null).then(U.bind(null,e),null).then(hb,null)}function S(a,b){var c=m.getContentFileMap().fileInfo;if(tb&&c[b]){var d=qb.isPagingEnabled?1:2;return c[a].index>c[b].index&&(d=5-d),{next:"pos-"+d,curr:"pos-"+(5-d)}}}function T(a,b){if(tb){var c=N(),d=xb.querySelector("iframe:not([current-section])"),e=d.classList;e.add("no-animation"),["pos-1","pos-2","pos-3","pos-4"].forEach(function(a){e.remove(a)}),a&&e.add(a.next),c&&(c.removeAttribute("current-section",""),c.setAttribute("last-section","")),d.setAttribute("current-section",""),zb=d.getAttribute("section-id")}return g.resolve(b)}function U(a){if(tb){var b=N(),c=xb.querySelector("iframe[last-section]")||xb.querySelector("iframe:not([current-section])");c.classList.add("no-pointer-events"),b.classList.remove("no-pointer-events"),b.classList.remove("no-animation"),a&&(c.classList.add(a.curr),b.classList.remove(a.next))}return g.resolve()}function V(){var a=Ib&&Ib.bookmark&&Ib.bookmark.rmsdkPosition;return wb.test(a)?W(a).then(k.getResolvedPromise,X):X()}function W(a){var b=wb.exec(a),c=b&&b[1];return R(c,ea.bind(this,a))}function X(a){a=!m.isFirstSection()||a;var b=m.getSectionNameByReference("first"),c=ca.bind(this,"first",a);return R(b,c)}function Y(){if(m.isLastSection())return g.resolve(!0);var a=m.getSectionNameByReference("next"),b=ca.bind(this,"first",!0);return R(a,b,!0)}function Z(a){if(m.isFirstSection())return g.reject("no previous section");var b=m.getSectionNameByReference("prev"),c=ca.bind(this,a,!0);return R(b,c,!0)}function $(a){a>0?_():aa()}function _(a){return qb.isLastPage[zb]?Y():ca("next",a)}function aa(a){return qb.isFirstPage[zb]?Z("last"):ca("prev",a)}function ba(a,b,c){var d=c&&c.$sourceEvent;Kb&&Db&&!nb(d)&&(qb.isPagingEnabled||c&&c.keyCode?(Hb=!0,a()):b&&"interaction.click"===b.name&&"right"===c.area&&!qb.isPagingEnabled?Ea(!0):jb(Db))}function ca(a,c){return b.$broadcast("tw.section.navigate","pageRef",zb,a,c),f()}function da(a,c){return b.$broadcast("tw.section.navigate","anchorID",zb,a,c),f()}function ea(a){return b.$broadcast("tw.section.navigate","RMSDK",zb,a),f()}function fa(a){return b.$broadcast("tw.section.navigate","percent",zb,a),f()}function ga(a,b){var c=da.bind(this,b);return R(a,c)}function ha(){var a=q.getToCItemsOfSection().pop();return a?da(a.srcAnchor):ca("first")}function ia(a){var b=q.getPreviousToCItemOfSection(P().pageLocation);return b&&!a?da(b.srcAnchor):Z().then(ha,null)}function ja(a){var b=q.getNextToCItemOfSection(P().pageLocation);return b&&!a?da(b.srcAnchor):Y()}function ka(){yb=r.fetch(s.globals.STORE.FONTSETTINGS)||{},sb.forEach(function(b){var c=yb[b]||s.globals.FONT.DEFAULTS[b];a.$broadcast("tw.fontSettings.apply",b,c)})}function la(b,c,d,e){yb[c]=d,r.save(s.globals.STORE.FONTSETTINGS,yb),"readingMode"===c&&d!==e&&(z.setLayoutStyle("paged"===d?"paginated":"scrolling"),Zb(),a.$emit("tw.reader.readingMode",d))}function ma(){if(Ib&&Ib.id)return ob("inventory").saveDeliverable(Ib.id),ob("sync").sync([Ib])}function na(a){Bb.fileName=a.fileName,Bb.childSequence=a.childSequence,Bb.offset=a.offset}function oa(a,c){var d=N(),e=d&&d.contentDocument;if(e&&a&&a.fileName){var f=e.documentElement.getBoundingClientRect();if(a.setByClientRectangle(f),(!a.isEqualTo(Bb)||c)&&(na(a),Ib.id)){var g=Ib.bookmark;g.rmsdkPosition=a.asRMSDKPositionString(),g.modified=ob("time").getTime(),g.progress=Math.max(0,Math.min(1,.01*b.sliderProgress.value)),g.currentPage=Ab,g.lastPage=pa(),ma()}}}function pa(){var a=m.getEPubInfo(),b=a.toc.pageList;return b?a.toc.numPagesTotal||b[b.length-1].pageNum:qb.viewport?a.spine.length:m.getContentFileMap().pagesTotal}function qa(a){var b=Gb.querySelector(".simple-dogear > svg");return"boolean"==typeof a?k.setClass(b,"active",a):b.classList.toggle("active"),b.classList.contains("active")}function ra(a){var c;return a&&Ib&&Ib.id&&(c=P().annotations.createComment(a,Ib.id),c&&(O().getSelection().removeAllRanges(),Ib.comments.push(c),ma(),b.$broadcast("tw.ePub.metaData.changed",Ib))),c}function sa(a,c){if(Ib.id){var d=P().annotations;if("endPosition"in a){var e=d.getAnnotationNode(a);d.updateComment(e,Ib.comments,c||""),ma(),b.$broadcast("tw.ePub.metaData.changed",Ib)}else(null===c&&d.removeComment(a,Ib.comments)||d.updateComment(a,Ib.comments,c))&&ma()}}function ta(a){var c=O(),d=k.getSelectedRange(c),e=P().annotations,f=e.hasComment(a)||e.isRangeInComment(d);if(f){var g=d&&d.commonAncestorContainer.parentNode;(e.removeComment(a,Ib.comments)||e.removeComment(g,Ib.comments))&&(c.getSelection().removeAllRanges(),ma(),b.$broadcast("tw.ePub.metaData.changed",Ib))}else if(null!==d)return ra(d)}function ua(a,b){var d=b.$sourceEvent;if(!(c.Modernizr.touchevents&&!c.Modernizr.isedge||"interaction.doubletap"===a.name&&"center"===b.area&&nb(d))){var e=P().annotations,f=e.selectCommentRange(d.target)||e.selectWordAtPosition(d.target,d.clientX,d.clientY);f&&!f.collapsed&&va(d)}}function va(b){!Pb.isVisible&&ya(b.target)&&(za(b.target,b.clientX,b.clientY),a.$emit("tw.contextMenu.visibility",Pb))}function wa(c,d){if(d.menuId===Pb.menuId){var e=d.param,f=d.action;if(d.selectedRange){var g=O().getSelection();g.removeAllRanges(),g.addRange(d.selectedRange)}switch(f){case"MARK":ta(e);break;case"NOTE":var h=P().annotations,i=!h.hasComment(e);if(i){var j=ta(e);e=h.getAnnotationNode(j)||e}xa(e,i);break;case"TEXTTOSPEECH":Va()}a.$emit("tw.reader.interactions","NOTE"!==f),b.$evalAsync()}}function xa(c,d){b.textNote.target=c,b.textNote.isCreated=d,b.textNote.note="markerComment"in c?c.markerComment:P().annotations.getNote(c),b.textNote.isVisible=!0,b.$evalAsync(),a.$emit("tw.reader.interactions",!1)}function ya(b){return!a.isSampleReader&&!window.Modernizr.ios&&O().body.contains(b)&&!A.isSpeaking()&&!A.isPaused()}function za(c,d,e){var f=Pb;if(f.isVisible=ya(c),f.isVisible){var g=k.getSelectedRange(O()),h=g&&g.toString().length>0,i=P().annotations,j=i.hasComment(c)||h&&i.isRangeInComment(g),l=!!i.getNote(c),m=j||h,n=f.items;n.MARK.isEnabled=m,n.MARK.withX=j,n.MARK.tooltip=j?gettext("TEXT_MARK_REMOVE"):gettext("TOOLTIP_COMPONENT_CONTEXTMENU_MARK"),n.NOTE.isEnabled=m,n.NOTE.tooltip=l?gettext("TEXT_NOTE_EDIT"):gettext("TOOLTIP_COMPONENT_CONTEXTMENU_NOTE"),n.TEXTTOSPEECH.isEnabled=b.textToSpeechEnabled,f.bbox=xb.getBoundingClientRect(),f.param=c,f.x=d,f.y=e}a.$emit("tw.reader.interactions",!f.isVisible)}function Aa(){function a(){var a=d.fileOrder.length-1;return a>0?e.index/a:0}if(Db){var c=m.getNameOfCurrentSection(),d=m.getContentFileMap(),e=d.fileInfo[c];if(e)if(qb.viewport)b.sliderProgress.value=Math.max(0,Math.min(100,100*a()));else{var f=P().pageNav.getMaxOffset(),g=f>0?qb.scrollOffset/f:a(),h=e.start+(e.size-1)*g;b.sliderProgress.value=Math.max(0,Math.min(100,h/d.totalSize*100))}}else var i=b.$on("tw.reader.contentReady",function(){Aa(),i()})}function Ba(){}function Ca(){Fb&&(f.cancel(Fb),Fb=null)}function Da(){Ca(),Fb=f(Ba,rb.UI_FADEOUT_TIME)}function Ea(a){qb.isPagingEnabled||(a?Qb(!0):Da())}function Fa(a,b,c){if(!c||"slider-page-nav"===c){jb(qb.isPagingEnabled,!0),Hb=!1;var d=b/100,e=m.getSectionNameByPercentage(d,!!qb.viewport),f=fa.bind(this,d);return R(e,f,!0)}}function Ga(a,b,c){"slider-page-nav"===c&&($(b.delta),Ha())}function Ha(){b.lastSliderPosition=null,Eb=null}function Ia(a,c){"slider-page-nav"===c&&(b.lastSliderPosition=b.sliderProgress.value)}function Ja(a,c){db(),Wb=!0,Jb.reset(),Jb.search(c).then(function(a){var c,d;a.length>0&&(c=P().pageLocation.getRMSDKPosition(!0),d=Jb.getIndexByPosition(c,O()),La(null,d)),b.$broadcast("searchFinished",a,d)},Ma)}function Ka(a){P().annotations.setSearchMark(a)}function La(a,b){function c(){return Jb.setRMSDKPosition(d,O()),ea(d.rmsdkPosition)}var d=Jb.getByIndex(b);Na(),R(d.fileName,c).then(Ka.bind(this,d))}function Ma(c){b.$broadcast("searchAborted"),Na(),"minSearchTermLengthViolation"===c&&(b.searchInfoDialog.isVisible=!0,a.$emit("tw.reader.interactions",!1))}function Na(){var a=O().querySelectorAll('[data-meta="searchMark"]');Array.prototype.forEach.call(a,k.unwrapNode)}function Oa(a){for(var b,c=document.createNodeIterator(O().body,NodeFilter.SHOW_TEXT,{acceptNode:function(a){if(a.textContent&&l.compactString(a.textContent).length>0)return NodeFilter.FILTER_ACCEPT}});b=c.nextNode();)if(b===a)return c.nextNode();return null}function Pa(a){var b=O().createRange();b.selectNode(a);var c=b.getBoundingClientRect();return c.left<0?Pa(Oa(a)):a}function Qa(a,b){var c=a.textContent,d=0;a===b.startContainer&&(d=b.startOffset);var e=c.length;return a===b.endContainer&&(e=b.endOffset),c.substring(d,e)}function Ra(a,b){var d=O().createRange();return d.selectNode(a),b.compareBoundaryPoints(c.Range.END_TO_START,d)===-1&&1===b.compareBoundaryPoints(c.Range.START_TO_END,d)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT}function Sa(a,b,c){var d=O(),e=d.getSelection();if(e.empty(),a){var f=d.createRange();f.setStart(a,b),f.setEnd(a,c),e.addRange(f);var g=f.getBoundingClientRect(),h=d.documentElement.getBoundingClientRect();qb.isPagingEnabled===!1?g.top>h.height&&_():g.left>h.width&&_()}}function Ta(b){A.init().then(function(){a.$emit("tw.reader.selection",!1),A.speak(b)})}function Ua(){O().getSelection().empty(),A.stop(),Sb=null,Rb=null,Tb=!1,a.$emit("tw.reader.selection",!0)}function Va(){if(Rb=k.getSelectedRange(O())){Sb=Rb.startContainer;var a=Rb.startOffset,b=Sb.textContent.substring(a).split(Ub)[0].length;Sa(Sb,a,a+b);var c=Qa(Sb,Rb);Ta(c)}}function Wa(){if(A.isSpeaking()&&A.isPaused())return void A.resume();Ua(),Tb=!0;var a=O(),b=P().pageLocation,c=a.documentElement.getBoundingClientRect(),d=b.getFirstNodeAtClientRectangle(c,a,!0);d=Sb=Pa(d);var e=b.getLastNodeAtClientRectangle(c,a,!0);Rb=a.createRange(),Rb.setStart(d,0),Rb.setEnd(e,e.length);var f=Rb.startOffset,g=Sb.textContent.substring(f).split(Ub)[0].length;Sa(Sb,f,f+g);var h=Qa(Sb,Rb);Ta(h),jb(!0,!1)}function Xa(){A.pause()}function Ya(){Ua()}function Za(a,b){var c=b.utterance||b.currentTarget||b.srcElement,d=b.charIndex,e=c.text.substring(d).split(Ub)[0].length,f=Sb.textContent.search(c.text);f&&(d+=f),Sa(Sb,d,d+e)}function $a(){var a=Oa(Sb);if(a&&Ra(a,Rb)===NodeFilter.FILTER_ACCEPT){Sb=a;var b=Qa(Sb,Rb);Ta(b)}else Tb===!0?(Ua(),Y().then(function(){f(function(){Wa()},250)})):Ua()}function _a(a,b){A.setVoiceRate(b)}function ab(a){return b.currentSectionLabel&&(b.overlayData.message=b.currentSectionLabel,b.overlayData.isVisible=a),g.resolve()}function bb(){var a;return m.isLastSection()&&(a=P().pageNav)&&a.getNumberOfPages()-a.getCurrentPageNo()<=4}function cb(){if("library"===b.state&&ob("user").isLoggedIn()&&Ib&&!Ib.isFinished&&bb()){var c=g.defer();return a.$emit("tw.reader.finished",{id:Ib.id,deferred:c}),a.$emit("tw.reader.interactions",!1),c.promise}return g.resolve()}function db(){Xb.push(Wb)}function eb(){Wb=Xb.pop()}function fb(a,c){f(function(){b.isMediaPlaying=a,b.isPlaybackEnabled=c})}function gb(a,b){a=a||Vb.getCurrentId();var c=O(),d=c.getElementById(a);if(d){var e=P().pageLocation,f=c.documentElement.getBoundingClientRect();return e.isNodeInViewport(f,d,qb.isPagingEnabled,b)}}function hb(a){return Db="boolean"!=typeof a||a,Db&&b.$emit("tw.reader.contentReady"),g.resolve()}function ib(b){var c=b?"tw.activity.indicator.start":"tw.activity.indicator.stop";return a.$emit(c,"activity-reader"),g.resolve()}function jb(a,c){a&&(b.$broadcast("requestMainToolbar",c),b.$evalAsync())}function kb(){var a=window.matchMedia&&window.matchMedia("screen and (min-width: 0px) and (max-width: 768px)").matches;a&&b.$broadcast("requestMainToolbar",!1)}function lb(a,c){if(!b.showPageNav){var d=document.querySelector(".outer-content-container"),e=O().documentElement;k.setClass(d,"cursor-prev",!1),k.setClass(d,"cursor-next",!1),k.setClass(e,"cursor-prev",!1),k.setClass(e,"cursor-next",!1),a&&qb.isPagingEnabled&&(c="boolean"!=typeof c||c,k.setClass(d,a,c),k.setClass(e,a,c))}}function mb(a){return window.innerHeight-a.clientY<48||b.isSliderVisible}function nb(a){for(var b=a&&a.target,c=O().documentElement;b&&b!==c;){if(/^(VIDEO|AUDIO|A|BUTTON|INPUT)$/.test(b.nodeName)||b.onclick||P().scriptSupport.hasEventListener(b,["click","mouseup","mousedown","touchend"])||Vb&&Vb.isOverlayFragment(b))return!0;b=b.parentNode}return!1}function ob(a){return vb[a]||(vb[a]=d.get(a))}function pb(){var a=j.getCurrentState().state.name;if("epub"!==a){var b="got deliverable but current state is '"+a+"'. Expected epub. aborting";return e.warn(b),g.reject(b)}return Ib?t.fetchDeliverable(Ib.id,{}).then(B,C):C(s.globals.ERROR.MISSING_ID)}var qb=b.settings={backgroundMode:null,fontSizeID:null,scrollOffset:0,isFirstPage:Object.create(null),isLastPage:Object.create(null),isPagingEnabled:!0,viewport:null},rb=s.globals.READER,sb=["fontSize","fontFamily","textAlign","lineHeight","backgroundMode","readingMode"],tb=!c.Modernizr.ios&&!c.Modernizr.android,ub={epuburl:'parameter "epuburl" not available: Unable to show publication sample',purchaseurl:'parameter "purchaseUrl" not available: Unable to purchase the publication',backref:'parameter "backref" not available: Unable to jump back'},vb={},wb=/([^#]*)#point\(([^:\)]*):?(\d*)\)/i,xb=null,yb=null,zb=null,Ab=1,Bb={},Cb={},Db=!1,Eb=null,Fb=null,Gb=null,Hb=!0,Ib={},Jb=new w,Kb=!0,Lb=[],Mb=k.throttle(function(a,b){var d=b.$sourceEvent;if(Db&&d&&!d.ctrlKey){var e=c.normalizeWheel.normalize(d).pixelY;qb.isPagingEnabled?$(e):L(e)}},100,{leading:!0,trailing:!1});b.sectionData={1:{},2:{}};var Nb={},Ob=k.getDebouncedFunction(oa,rb.SYNC_BOOKMARK_DELAY);b.handleDogearAction=function(){var a=qa();b.$broadcast("tw.section.dogears.set",zb,a),b.$broadcast("tw.ePub.metaData.changed",Ib)},b.$on("tw.section.dogears.apply",function(a,b,c){b===zb&&qa(c)});var Pb={menuId:"ctxMenuReader",isVisible:!1,x:0,y:0,items:{MARK:{icon:"mark-left",isEnabled:!0,withX:!1,tooltip:gettext("TOOLTIP_COMPONENT_CONTEXTMENU_MARK")},NOTE:{icon:"edit",isEnabled:!0,withX:!1,tooltip:gettext("TOOLTIP_COMPONENT_CONTEXTMENU_NOTE")},TEXTTOSPEECH:{icon:"play",isVisible:!1,withX:!1,tooltip:gettext("TOOLTIP_COMPONENT_CONTEXTMENU_TEXTTOSPEECH")}}};Lb.push(a.$on("tw.contextMenu.update",function(a,b,c,d,e){b===Pb.menuId&&za(c,d,e)}));var Qb=k.throttle(function(a){b.isSliderVisible=a,Ca(),a?Eb&&(f.cancel(Eb),Eb=null):Eb=f(Ha,3e3)},300,{leading:!0,trailing:!1}),Rb=null,Sb=null,Tb=!1,Ub=/\s+/gi;b.$on("tw.slider.update",function(){jb(qb.isPagingEnabled,!0)}),b.$on("interaction.key.space",jb.bind(this,!0,null)),b.$on("interaction.key.tab",jb.bind(this,!0,!0)),b.$on("interaction.key.left",ba.bind(this,aa)),b.$on("interaction.key.right",ba.bind(this,_)),b.$on("interaction.mousewheel",Mb),b.$on("interaction.click",function(a,c){var d=c.area;if("top"===d){var e=c.$sourceEvent&&c.$sourceEvent.target;return void(e&&e.classList.contains("title")&&jb(Db,!0))}return"bottom"===d?void jb(Db,!0):"left"===d||"right"===d?void(b.showPageNav||ba("left"===d?aa:_,a,c)):void(nb(c.$sourceEvent)||(b.showPageNav||!qb.isPagingEnabled||0===c.horAreaID?jb(Db):$(c.horAreaID)))}),b.$on("interaction.pointermove",function(a,c){var d=c.area;"top"===d&&(jb(Db&&!b.hasMediaOverlay,!0),lb(null)),"bottom"===d?(jb(Db&&mb(c.$sourceEvent),!0),lb(null)):lb(c.horAreaID<0&&!b.isFirstPage?"cursor-prev":c.horAreaID>0&&!b.isLastPage?"cursor-next":null)}),b.$on("interaction.pointerenter",function(a,c){var d=c.area;"top"===d?jb(Db&&!b.hasMediaOverlay,!0):"bottom"===d&&jb(Db&&mb(c.$sourceEvent),!0)}),b.$on("interaction.pointerleave",function(a,b){var c=b.area;"top"!==c&&"bottom"!==c&&("right"===c&&Ea(!1),lb())}),b.$on("interaction.drag",function(){k.getSelectedRange(O())&&lb("cursor-auto")}),b.$on("interaction.dragend",function(a,b){lb("cursor-auto",!1),k.getSelectedRange(O())&&va(b.$sourceEvent)}),b.$on("interaction.doubletap",ua),b.$on("interaction.contextmenu",ua),b.$on("interaction.pinch",function(a,b){if(Db&&qb.viewport){var d=xb.getAttribute("data-scale")||1,e=b.scale*d,f=xb.style;f[c.Modernizr.prefixed("transformOrigin")]=b.centerX+"px "+b.centerY+"px",f[c.Modernizr.prefixed("transform")]="scale("+e+")"}}),b.$on("interaction.swipe",function(a,b){Db&&c.Modernizr.touchevents&&(qb.isPagingEnabled?"left"===b.direction?_():"right"===b.direction&&aa():L(-2*b.velocity*b.dY))}),b.$on("tw.toolbar.textToSpeech.play",Wa),b.$on("tw.toolbar.textToSpeech.pause",Xa),b.$on("tw.toolbar.textToSpeech.stop",Ya),b.$on("tw.toolbar.textToSpeech.voiceRateChange",_a),Lb.push(a.$on("tw.textToSpeech.boundary",Za)),Lb.push(a.$on("tw.textToSpeech.end",$a)),a.showVersion=!1,b.isReaderApp=!0,b.sliderProgress={last:0,value:0},b.currentSectionLabel="",b.isSliderVisible=null,b.textNote={isVisible:!1,target:null},b.publicationTitle="",b.searchInfoDialog={isModal:!0,isVisible:!1},b.lastSliderPosition=null,b.setUnloadListener=function(a){var b=angular.element(c);a?f(function(){b.bind("beforeunload",$b)}):b.unbind("beforeunload",$b)},b.closeSearchInfoDialog=function(){b.searchInfoDialog.isVisible=!1,a.$emit("tw.reader.interactions",!0)},b.previousPage=function(a){a.stopPropagation(),ba(aa)},b.nextPage=function(a){a.stopPropagation(),ba(_)},b.previousChapter=function(){if(b.$broadcast("requestMainToolbar",!0),!b.isFirstChapter){var a=P().pageNav.getCurrentPageNo;Ha(),q.goToToCItem(ia,a,m.isFirstSection)}},b.nextChapter=function(){if(b.$broadcast("requestMainToolbar",!0),!b.isLastChapter){var a=P().pageNav.getCurrentPageNo;Ha(),q.goToToCItem(ja,a,m.isLastSection)}},b.toLastSliderPosition=function(){Fa(null,b.lastSliderPosition),Ha()},b.applySelection=ra,b.applyNote=sa,b.updateContextMenu=za,b.overlayData={isModal:!1,message:"",autoHide:1300,hideOnClick:!0,className:"reader-overlay"},b.cautionInfoDialog={isModal:!0,isVisible:!1},b.closeCautionInfoDialog=function(){b.cautionInfoDialog.isVisible=!1},b.externalLinks={isModal:!0,isVisible:!1,grantedByUser:!!r.fetch(s.globals.STORE.EXTERNAL_LINKS)},Lb.push(a.$on("tw.reader.openURL",function(c,d){b.externalLinks.grantedByUser?window.open(d):(a.$emit("tw.reader.interactions",!1),b.externalLinks.dialogText=i.instant(gettext("OPEN_EXTERNAL_LINK_WITH_URL"),{url:d}),b.externalLinks.isVisible=!0,b.externalLinks.URL=d,b.$apply())})),b.externalLinkCheckBoxChange=function(){r.save(s.globals.STORE.EXTERNAL_LINKS,b.externalLinks.grantedByUser)},b.externalLinkClose=function(){b.externalLinks.isVisible=!1,a.$emit("tw.reader.interactions",!0)},b.externalLinkOpen=function(){b.externalLinkClose(),window.open(b.externalLinks.URL)},b.hasMediaOverlay=!1,b.isMediaPlaying=!1,b.isPlaybackEnabled=!0;var Vb=null,Wb=!1,Xb=[];b.$on("tw.mediaoverlay.set",function(a,c){if("object"==typeof c&&c.documentElement){if(!Vb){var e=d.get("MediaOverlay");Vb=new e}var g=m.getEPubInfo(),h=m.getFiles();Vb.init(c,g,h,N(),b.deliverableid),b.hasMediaOverlay=!0,b.isPlaybackEnabled=!0,fb(!Vb.isPaused(),!0),f(function(){Wb||(Vb.play(),fb(!Vb.isPaused(),!0))},1200)}else Vb&&(Vb.terminate(),Vb=null,b.hasMediaOverlay=!1)}),Lb.push(a.$on("tw.mediaoverlay.progress",function(a,b,c){gb(b,c)||da(b)})),Lb.push(a.$on("tw.mediaoverlay.statechange",function(a,b){fb("play"===b,"load"!==b)})),b.toggleMediaOverlayPlayback=function(a){b.isPlaybackEnabled&&(Vb.togglePlayback(),Wb=Vb.isPaused(),fb(!Wb,!0)),a.stopPropagation()},b.$on("tw.reader.content.ready",J),b.$on("tw.reader.error",K),b.$on("tw.reader.fontSettings.apply",ka),b.$on("tw.reader.scroll",M),b.$on("tw.bookmark.sync",function(a,c){"library"===b.state&&Ob(c)}),b.$on("tw.toolbar.visibilityChanged",function(a,b){Qb(b)}),b.$on("tw.slider.update",k.getDebouncedFunction(Fa,rb.SLIDER_UPDATE_INTERVAL)),b.$on("tw.slider.step",Ga),b.$on("tw.slider.startMoving",Ia),b.$on("tw.slider.hover",function(a,c,d){"slider-page-nav"===d&&jb(Db&&qb.isPagingEnabled&&!b.isSliderVisible,!0)}),b.$on("tw.toc.navigateToPosition",function(a,b){Ia(null,"slider-page-nav"),ga(b.src,b.srcAnchor).then(kb)}),b.$on("requestSearch",Ja),b.$on("highlightSearchResultByIndex",La),b.$on("removeSearchMarkup",Na),b.$on("tw.toolbar.search.visibilityChanged",function(a,b){b||(Na(),eb())}),b.$on("tw.bookmark.navigateToBookmark",function(a,b){b&&b.rmsdkPosition?W(b.rmsdkPosition).then(kb):kb()}),b.$on("tw.annotation.editNote",function(a,b){xa(b)}),b.$on("tw.annotation.remove",function(a,c){var d="endPosition"in c,e=d?Ib.comments:Ib.dogears;P().annotations.removeAnnotation(c,e),d||b.$broadcast("tw.section.dogears.check",zb),ma(),b.$broadcast("tw.ePub.metaData.changed",Ib)}),b.$on("tw.reader.pagenumber.update",function(a,c,d){null!==c?(Ab=c,b.pageNumberInfo=d+" "+i.instant(gettext("COMMON_ENUMERATION_OF"))+" "+pa()):b.pageNumberInfo=""}),b.$on("tw.requestExitReader",function(a,d){cb().then(function(){$b(),"library"===b.state&&ma(),d?c.location=d:b.close?b.close():c.history.back()})}),Lb.push(a.$on("tw.fontSettings.change",la)),Lb.push(a.$on("tw.contextMenu.action",wa)),Lb.push(a.$on("tw.reader.interactions",function(a,b){Kb=b}));var Yb=k.getDebouncedFunction(function(){var a=m.isFirstSection(),c=m.isLastSection();b.isFirstPage=a&&qb.isFirstPage[zb],b.isLastPage=c&&qb.isLastPage[zb],b.isFirstChapter=a&&!q.getPreviousToCItemOfSection(P().pageLocation),b.isLastChapter=c&&!q.getNextToCItemOfSection(P().pageLocation)},20);b.$on("tw.reader.section.page.update",Yb);var Zb=k.getDebouncedFunction(function(){b.showPageNav=qb.isPagingEnabled&&!qb.viewport&&!c.Modernizr.touchevents},0);this.init=function(c){if(Gb=c[0],xb=document.querySelector("#"+rb.CONTAINER_ID),xb.focus(),Kb=!0,m.clearData(),ib(!0),b.isSampleReader=a.isSampleReader,b.showPageNav=!0,"reader"===b.state){var d=j.getCurrentState().params,f={epuburl:d&&d.epuburl,purchaseurl:d&&d.purchaseurl,backref:d&&d.backref};for(var h in ub)f[h]||e.warn(ub[h]);return t.fetchSample(f.epuburl).then(B).catch(C)}if("library"===b.state){var i=b.deliverableid;return i?k.fetchDeliverable(i).then(function(a){var b=j.getCurrentState().state.name;if("epub"!==b){var c="got deliverable but current state is '"+b+"'. Expected epub. aborting";return e.warn(c),g.reject(c)}return Ib=a,ob("sync").sync([Ib]).then(pb,pb)}).catch(function(a){console.warn(a),b.$emit("tw.requestExitReader",b.backRef)}):(ib(!1),g.reject("deliverable identifier missing: Unable to retrieve publication"))}};var $b=function(){if("library"===b.state){var d=angular.element(c);a.$emit("tw.reader.close"),a.showVersion=!1,Pb.isVisible=!1,d.unbind("beforeunload",$b),d.unbind("popstate",$b),oa(P().pageLocation,!0),
Vb&&(Vb.terminate(),Vb=null),(A.isSpeaking()||A.isPaused())&&Ua();for(var e in b.sectionData){var f=b.sectionData[e];f.pageLocation.clearPosition(),f.annotations.setPageLocation(),f.scriptSupport.reset(),f.scriptSupport.setEPubData(null),f.content=null}Jb.reset(),m.clearData(),Ib={};for(var g in vb)delete vb[g];qb=null,xb=null}};b.$on("$destroy",function(){for(var a;a=Lb.pop();)a()})}]),angular.module("epub").controller("searchBarCtrl",["$scope","$element","$timeout","$translate",function(a,b,c,d){"use strict";function e(){a.isSearchNavigationVisible=!0,a.searchInProgress=!0,a.currentSearchResultIndex=-1,a.noOfSearchResults=-1,a.$emit("requestSearch",a.searchInput.searchTerm)}function f(b){h=null,a.searchInProgress=!1,a.isSearchNavigationVisible=!1,a.currentSearchResultIndex=-1,a.noOfSearchResults=-1,b&&(a.searchTerm=""),a.$emit("removeSearchMarkup")}var g,h=null,i=function(b){"boolean"!=typeof b&&(b=!a.isSearchBarVisible),a.isSearchBarVisible=b},j=function(){f(!0),i(!1),a.$emit("tw.toolbar.search.visibilityChanged",!1)},k=function(a){return window.event?a.keyCode:a.which},l=function(a){var b=g[a];b&&b()};a.searchInput={searchTerm:"",refId:null,hasAutoFocus:!0,iconName:"search-text",placeHolderText:d.instant(gettext("FULLTEXTSEARCH_PLACEHOLDER")),cbSearch:e,cbClear:f},a.isSearchBarVisible=!1,a.isSearchNavigationVisible=!1,a.searchInProgress=!1,a.noOfSearchResults=-1,a.currentSearchResultIndex=-1,a.previousResult=function(){a.currentSearchResultIndex--,a.currentSearchResultIndex<0&&(a.currentSearchResultIndex=a.noOfSearchResults-1),a.$emit("highlightSearchResultByIndex",a.currentSearchResultIndex)},a.nextResult=function(){a.currentSearchResultIndex++,a.currentSearchResultIndex>a.noOfSearchResults-1&&(a.currentSearchResultIndex=0),a.$emit("highlightSearchResultByIndex",a.currentSearchResultIndex)},a.closeSearch=j,a.$on("requestSearchToolbar",function(){i(!0),h&&a.$emit("highlightSearchResultByIndex",a.currentSearchResultIndex),c(function(){b.find("input")[0].focus()},100)}),a.$on("requestSearchToolbarToHide",j),a.$on("searchFinished",function(b,c,d){h=c,a.noOfSearchResults=c.length,a.currentSearchResultIndex=d||0,a.isSearchNavigationVisible=!0,a.searchInProgress=!1}),a.$on("searchAborted",function(){f()}),a.$on("tw.reader.deliverable.changed",function(b,c){c&&c.id&&(f(),a.searchInput.refId=c.id)}),a.onKeyPress=function(a){var b=k(a);l(b),13===b&&c(function(){a.target.blur()})},g={13:e,27:a.closeSearch,37:a.previousResult,39:a.nextResult}}]),angular.module("epub").controller("ToolbarSharingCtrl",["$rootScope","$scope","$injector","sharing",function(a,b,c,d){"use strict";b.isSharingToolbarVisible=!1,b.sharePublication=function(e){if(!a.isSampleReader){var f=c.get("inventory"),g=f.deliverables[b.deliverableid];b.setUnloadListener(!1),d.sharePublication(e,g),b.setUnloadListener(!0)}},b.$on("requestSharingToolbar",function(){b.isSharingToolbarVisible=!0}),b.$on("requestSharingToolbarToHide",function(){b.isSharingToolbarVisible=!1})}]),angular.module("epub").controller("ToolbarTextToSpeechCtrl",["$timeout","$scope","textToSpeech","CONFIG",function(a,b,c,d){"use strict";var e=0,f=3,g=function(a){"boolean"!=typeof a&&(a=!b.isTextToSpeechToolbarVisible),b.isTextToSpeechToolbarVisible=a},h=function(a){b.voices.items=[];for(var c=0,d=a.length;c<d;c++)b.voices.items.push({id:a[c].voiceURI,label:a[c].name})},i=function(a){return a=parseFloat(a),a<=e&&(a=e),a>f&&(a=f),a},j=function(){c.init().then(function(){null===b.languages.selectedIndex&&(b.languages.selectedIndex=0),g(!0)})},k=function(){g(!1)},l=function(){b.languages.isVisible=!0},m=function(){b.voices.isVisible=!0},n=function(a,d){if(a!==d){var e=b.languages.items[a].id.replace("_","-"),f=c.getVoicesForLanguage(e);h(f),o(0,b.voices.selectedIndex),b.voices.selectedIndex=0}},o=function(a){if(b.voices.items&&b.voices.items.length>0){var d=b.voices.items[a];c.setVoice(d.id)}},p=function(a,c,d){"slider-speech-rate"!==d||isNaN(c)||b.$emit("tw.toolbar.textToSpeech.voiceRateChange",i(c))},q=function(a,c,d){"slider-speech-rate"===d&&(b.speechRate.index=i(c.value),b.$apply(),b.$emit("tw.toolbar.textToSpeech.voiceRateChange",i(c.value)))},r=function(){b.$emit("tw.toolbar.textToSpeech.play")},s=function(){b.$emit("tw.toolbar.textToSpeech.pause")},t=function(){b.$emit("tw.toolbar.textToSpeech.stop")},u=function(a){b.isSpeaking=a},v=function(a){b.isPaused=a};b.isTextToSpeechToolbarVisible=!1,b.languages={title:gettext("COMMON_LANGUAGE"),items:d.globals.LANGUAGES,selectedIndex:null,isVisible:!1},b.voices={title:gettext("COMMON_VOICE"),items:null,selectedIndex:null,isVisible:!1},b.speechRate={index:1,min:e,max:f},b.isSpeaking=c.isSpeaking(),b.isPaused=c.isPaused(),b.requestLanguageSelection=l,b.requestVoiceSelection=m,b.requestPlay=r,b.requestPause=s,b.requestStop=t,b.$on("requestTextToSpeechToolbar",j),b.$on("requestTextToSpeechToolbarToHide",k),b.$on("tw.slider.update",p),b.$on("tw.slider.step",q),b.$watch("languages.selectedIndex",n),b.$watch("voices.selectedIndex",o),b.$watch(c.isSpeaking,u),b.$watch(c.isPaused,v)}]),angular.module("epub").controller("ToCController",["$scope","$element","$timeout","TreeNode",function(a,b,c,d){"use strict";var e,f,g,h=function(a){g&&g.setActive(!1),a&&(g=a,g.setActive(!0))},i=function(a){if(!e||e.docTitle!==a.docTitle||e.tocByPlayOrder.length!==a.tocByPlayOrder.length)return!1;for(var b in e.tocByPlayOrder)if(e.tocByPlayOrder[b].src!==a.tocByPlayOrder[b].src)return!1;return!0},j=function(a,b,c){if(!a||!a.label)return null;var e=new d(a.label,{src:a.src,srcAnchor:a.srcAnchor,tocPath:b});if(f[a.src]||(e.isEnabled=!1),!c&&a.items&&a.items.length>0){var g=j(a.items[0],b+"/0",!0);g.isVisible=!1,e.addChild(g)}return e},k=function(a,b){var c=e&&e.toc;if(c){a&&a.stopPropagation();var d=b.data.tocPath,f=b.nodes.length;if(void 0!==d&&f<=1)for(var g="number"==typeof d?c.items[d]:l(c,d.split("/")),h=g.items?g.items.length:0,i=f;i<h;i++)b.addChild(j(g.items[i],d+"/"+i))}},l=function(a,b){var c=b.shift(),d=a.items[c];return 0===b.length?d:l(d,b)},m=function(a){var b=e&&e.tocByPlayOrder,c=a&&a.fileName,d=!0,f=a&&a.getChildSequence(d);if(!b||!f)return null;for(var g,h,i,j,k=function(a){for(var b=0;b<l;b++){if(void 0===a[b])return-1;var c=f[b]-parseInt(a[b],10);if(0!==c)return c}return 0},l=f.length,m=0,n=b.length;m<n;m++)if(h=b[m],void 0!==h&&h.src===c){if(h.childSequence&&(g=h.childSequence.split("/"),j=k(g),j<=0))return i&&j<0?i:h;i=h}return i},n=function(b,c){var g,h=!0;if(!i(b)){for(;g=a.nodes.pop();)g.destroy();e=b,f=c;var k=b&&b.toc&&b.toc.items;if(k){var l,m=k[0]&&k[0].src;m&&(l={src:m}),h=!b.docTitle,g=new d(b.docTitle||gettext("COMMON_TABLE_OF_CONTENTS"),l,null,h),k.forEach(function(a,b){g.addChild(j(a,b))}),g.toggleExpand(!0)}else g=new d(gettext("COMMON_TABLE_OF_CONTENTS_NOT_AVAILABLE"),null,null,h);a.nodes=[g]}},o=function(a,b){var c=b.parsedEPubInfo.toc,d=b.fileMap.fileInfo;n(c,d)},p=function(b,c){b.stopPropagation(),a.$emit("tw.toc.navigateToPosition",c.data),h(c)},q=function(){if(g){var a=function(a){return a&&"DIV"===a.nodeName&&a.hasAttribute("ng-repeat")},c=function(b,d){var e=b.length>0?b.shift():0,f=Array.prototype.filter.call(d.children,a)[e];return f=f&&f.children&&f.children[0],0!==b.length&&f?c(b,f):f},d=String.prototype.split.call(g.data.tocPath,"/"),e=b[0].querySelector(".treenode"),f=c(d,e);if(f){var h=b[0].parentNode,i=h.getBoundingClientRect().bottom,j=f.getBoundingClientRect().bottom;j>=i&&(h.scrollTop=j-i)}}},r=function(b,d){var f=m(d);if(!f)return null;var g=function(a){for(var b,c,d=a.items||[],e=0,h=d.length;e<h;e++){if(c=d[e],c.src===f.src&&c.srcAnchor===f.srcAnchor)return[e];if(null!==(b=g(c)))return b.unshift(e),b}return null},i=function(a,b){var c=a.length>0?a.shift():0;b.toggleExpand(!0),k(null,b);var d=b.nodes[c];if(d)return 0===a.length?d:i(a,d)},j=g(e.toc),l=j&&i(j,a.nodes[0]);return h(l),c(q),l};a.nodes=[],a.$on("tw.ePub.metaData",o),a.$on("tw.toc.expandToPageLocation",r),a.$on("tw.expandTreeNode",k),a.$on("tw.treeNodeAction",p)}]),angular.module("epub").controller("ToolbarCtrl",["$scope","$window","$timeout","CONFIG",function(a,b,c,d){"use strict";var e,f={ANNOTATIONS:"annotations",FONTSETTINGS:"fontSettings",SEARCH:"search",SHARE:"share",TOC:"toc",TEXTTOSPEECH:"texttospeech"},g={annotations:"requestAnnotationsToolbarToHide",fontSettings:"requestFontSettingsToolbarToHide",search:"requestSearchToolbarToHide",share:"requestSharingToolbarToHide",toc:"requestToCToolbarToHide",texttospeech:"requestTextToSpeechToolbarToHide"},h=null,i=b.Modernizr.touchevents?d.globals.READER.UI_FADEOUT_TIME_TOUCH:d.globals.READER.UI_FADEOUT_TIME,j=function(){k(),e=c(l,i)},k=function(){e&&(c.cancel(e),e=null)},l=function(){e=null,a.selectedToolbar||(a.isToolbarVisible=!1,a.$emit("tw.toolbar.visibilityChanged",!1))},m=function(){var b=g[a.selectedToolbar];b&&(a.$broadcast(b),a.selectedToolbar=null)},n=function(b,c){if(a.selectedToolbar===f.SEARCH){if(c)return;c=!1}"boolean"!=typeof c&&(c=!a.isToolbarVisible),a.isToolbarVisible=c,a.$emit("tw.toolbar.visibilityChanged",c),c?a.activateAutomaticToolbarHide():(a.deactivateAutomaticToolbarHide(),m())};a.isLibrary="library"===a.state,a.isToolbarVisible=!1,a.purchaseUrl=null,a.backRef=null,a.isSearchVisible=!0,a.tolino_webReader_fontSize=null,a.hideCurrentlySelectedToolbar=m,a.closeReader=function(b){a.$emit("tw.requestExitReader",a.backRef),b.stopPropagation()},a.requestFontSettingsToolbar=function(b){var c=a.selectedToolbar;m(),c!==f.FONTSETTINGS&&(a.selectedToolbar=f.FONTSETTINGS,a.$broadcast("requestFontSettingsToolbar")),b.stopPropagation()},a.requestToCToolbar=function(b){var c=a.selectedToolbar;m(),c!==f.TOC&&(a.selectedToolbar=f.TOC,a.$broadcast("requestToCToolbar"),a.$broadcast("tw.toc.expandToPageLocation",h)),b.stopPropagation()},a.requestAnnotationsToolbar=function(b){var c=a.selectedToolbar;m(),c!==f.ANNOTATIONS&&(a.selectedToolbar=f.ANNOTATIONS,a.$broadcast("requestAnnotationsToolbar")),b.stopPropagation()},a.requestSearchToolbar=function(b){a.selectedToolbar!==f.SEARCH&&m(),a.selectedToolbar=f.SEARCH,a.isToolbarVisible=!1,a.$broadcast("requestSearchToolbar"),a.$emit("tw.toolbar.visibilityChanged",!1),b.stopPropagation()},a.requestTextToSpeechToolbar=function(b){var c=a.selectedToolbar;m(),c!==f.TEXTTOSPEECH&&(a.selectedToolbar=f.TEXTTOSPEECH,a.$broadcast("requestTextToSpeechToolbar")),b.stopPropagation()},a.toggleSharingToolbar=function(b){var c=a.selectedToolbar;m(),c!==f.SHARE&&(a.selectedToolbar=f.SHARE,a.$broadcast("requestSharingToolbar")),b.stopPropagation()},a.jumpToPurchase=function(c){a.purchaseUrl&&(b.location=a.purchaseUrl),c.stopPropagation()},a.activateAutomaticToolbarHide=function(){j()},a.deactivateAutomaticToolbarHide=function(){k()},a.$on("requestMainToolbar",n),a.$on("showBookmarks",function(){n(),a.requestAnnotationsToolbar()}),a.$on("tw.toolbar.search.visibilityChanged",function(b,c){c===!1&&(a.selectedToolbar=null)}),a.$on("tw.setPageLocation",function(a,b){h=b}),a.$on("tw.reader.fontsize",function(b,c){a.tolino_webReader_fontSize=c.identifier,a.isFontMenuDisabled="pre-paginated"===c.identifier}),a.$on("initToolbarButtons",function(b,c){a.purchaseUrl=c.purchase,a.backRef=c.back})}]),angular.module("epub").controller("ToolbarToCCtrl",["$rootScope","$scope","$timeout",function(a,b,c){"use strict";var d=function(c){b.isToolbarVisible=!!c,a.showVersion=b.isToolbarVisible};b.isToolbarVisible=!1,b.$on("requestToCToolbar",function(){d(!0)}),b.$on("requestToCToolbarToHide",function(){b.noAnimation=!1,c(d,0)})}]),angular.module("epub").directive("twEpub",["$rootScope","stateHelper",function(a,b){"use strict";return{restrict:"E",controller:"ReaderCtrl",scope:{},templateUrl:"../states/epub/partials/reader.tpl.html",link:function(c,d,e,f){a.$emit("tw.audio.mini.player",{show:!1});var g=b.getCurrentState().params;return c.state=window.tw.app,a.currentDeliverable=c.deliverableid=g&&g.id,c.$on("$destroy",function(){a.currentDeliverable=null}),f.init(d)}}}]),angular.module("help").directive("twHelpHeaderBar",["help",function(a){"use strict";return{restrict:"E",scope:{},template:"<tw-library-bar></tw-library-bar>",link:function(b){b.$on("menuAction",function(b){b.stopPropagation(),a.isMenuVisible()||a.setMenuVisible(!0)})}}}]),angular.module("help").directive("twHelpModal",["help",function(a){"use strict";return{restrict:"E",scope:{},template:'<div ng-click="hideMenu()" ng-class="{\'visible\' : menuVisible}" class="container-inner-modal"> </div>',link:function(b){b.menuVisible=!1,b.hideMenu=function(){a.isMenuVisible()&&a.setMenuVisible(!1)};var c=function(){return a.isMenuVisible()};b.$watch(c,function(a){b.menuVisible=a})}}}]),angular.module("help").directive("twHelpOptions",["help",function(a){"use strict";return{restrict:"E",scope:{},template:'<div ng-repeat="option in service.getOptions()"><div class="help-option-label" translate>{{ option.label }}</div><div class="help-option-container"><div translate>{{ option.sublabel }}</div><button ng-if="option.buttonlabel" ng-click="service.handleTarget(option.target)" class="secondary" translate>{{ option.buttonlabel }}</button></div></div>',link:function(b){b.service=a}}}]),angular.module("help").directive("twHelpSidebarMenu",["help",function(a){"use strict";return{restrict:"E",scope:{},template:'<tw-sidebar-menu ng-class="{\'visible\' : menuVisible}" close-menu="service.setMenuVisible(value)"></tw-sidebar-menu>',link:function(b){b.service=a,b.menuVisible=!1;var c=function(){return a.isMenuVisible()};b.$watch(c,function(a){b.menuVisible=a})}}}]),angular.module("help").factory("help",["$window","$rootScope","reseller",function(a,b,c){"use strict";var d=[{label:gettext("HELP_IMPRINT_BTN"),sublabel:gettext("HELP_IMPRINT_TEXT"),buttonlabel:gettext("COMMON_MORE"),target:"IMPRINT"},{label:gettext("HELP_TERMS_BTN"),sublabel:gettext("HELP_TERMS_TEXT"),buttonlabel:gettext("COMMON_MORE"),target:"GTC"},{label:gettext("HELP_PRIVACY_BTN"),sublabel:gettext("HELP_PRIVACY_TEXT"),buttonlabel:gettext("COMMON_MORE"),target:"PRIVACY"},{label:gettext("COMMON_CUSTOMER_SERVICE"),sublabel:gettext("HELP_TEXT"),buttonlabel:gettext("COMMON_MORE"),target:"HELP"}],e=!1,f=function(){return d},g=function(){return e},h=function(a){e=a},i=function(a,b){return b&&a&&(a+=a.indexOf("?")>-1?"&channelid="+b:"?channelid="+b),a},j=function(d){c.fetchConfig().then(function(c){switch(d){case"HELP":b.$emit("tw.activity.indicator.start","root-indicator"),a.location=i(c.URL_HELP,c.CHANNEL_ID);break;case"IMPRINT":b.$emit("tw.activity.indicator.start","root-indicator"),a.location=i(c.URL_IMPRINT_DOCUMENT,c.CHANNEL_ID);break;case"GTC":b.$emit("tw.activity.indicator.start","root-indicator"),a.location=i(c.URL_TERMS_AND_CONDITIONS,c.CHANNEL_ID);break;case"PRIVACY":b.$emit("tw.activity.indicator.start","root-indicator"),a.location=i(c.URL_DATA_PRIVACY,c.CHANNEL_ID)}})};return{handleTarget:j,getOptions:f,isMenuVisible:g,setMenuVisible:h}}]),angular.module("home").directive("twHomeCoverFlow",["$rootScope","$timeout","home","libraryModel",function(a,b,c,d){"use strict";return{templateUrl:"../states/home/home-cover-flow.tpl.html",link:function(a){c.isInit()||c.init(),a.deliverables=null,a.isEmptyBookshelf=!1,a.$watch(c.isEmptyBookshelf,function(b){a.isEmptyBookshelf=b}),a.coverAction=d.openDeliverable,a.$watch(c.getCoverflowItems,function(b){a.deliverables=b})}}}]),angular.module("home").directive("twHomeDeleteDialog",["home",function(a){"use strict";return{restrict:"E",scope:{},template:"<tw-delete-dialog></tw-delete-dialog>",link:function(b){b.$on("delete-dialog-confirm",function(b,c){b.stopPropagation();var d=c&&c.selectedPub;if(d)return a.deletePub(d).finally(function(){d=null})})}}}]);angular.module("home").directive("twHomeHeaderBar",["home","stateHelper",function(a,b){"use strict";return{restrict:"E",scope:{},template:"<tw-library-bar></tw-library-bar>",link:function(c){c.$on("searchAction",function(a,c){a.stopPropagation(),b.goToState("search",{searchTerm:c})}),c.$on("menuAction",function(b){b.stopPropagation(),a.isMenuVisible()||a.setMenuVisible(!0)})}}}]);angular.module("home").directive("twHomeModal",["home",function(a){"use strict";return{restrict:"E",scope:{},template:'<div ng-click="hideMenu()" ng-class="{\'visible\' : menuVisible}" class="container-inner-modal"> </div>',link:function(b){b.menuVisible=!1,b.hideMenu=function(){a.isMenuVisible()&&a.setMenuVisible(!1)};var c=function(){return a.isMenuVisible()};b.$watch(c,function(a){b.menuVisible=a})}}}]),angular.module("home").directive("twHomeRecommendations",function(){"use strict";return{template:'<tw-recommendations deliverable="currentlyFocusedDeliverable" visible="visible"></tw-recommendations>',link:function(a){a.visible=!0}}}),angular.module("home").directive("twHomeSidebarMenu",["home",function(a){"use strict";return{restrict:"E",scope:{},template:'<tw-sidebar-menu ng-class="{\'visible\' : menuVisible}" close-menu="service.setMenuVisible(value)"></tw-sidebar-menu>',link:function(b){b.service=a,b.menuVisible=!1;var c=function(){return a.isMenuVisible()};b.$watch(c,function(a){b.menuVisible=a})}}}]),angular.module("home").directive("twHomeStateWatcher",["home","$rootScope","$state","libraryModel",function(a,b,c,d){"use strict";return{restrict:"A",link:function(){var e=b.$on("$viewContentLoaded",function(){c.includes("home.**")?d.setContextMenuActive(!0):(d.setContextMenuActive(!1),e())}),f=b.$on("$stateChangeSuccess",function(){c.includes("home.**")||(a.reset(),f())})}}}]),angular.module("home").factory("home",["$rootScope","inventory","error","BaseUtil","CONFIG","delete","$filter","$timeout","sync","time","bosh","libraryModel",function(a,b,c,d,e,f,g,h,i,j,k,l){"use strict";var m=null,n=[],o=!1,p=function(){return b.deliverables},q=function(){return m},r=function(){return o},s=function(a){return!a.isHidden},t=function(b){var c="tw.activity.indicator."+(b?"start":"stop");a.$emit(c,"activity-cover-flow")},u=function(){m&&(m.length=0),m=g("limitTo")(g("orderByRecent")(b.getDeliverables().filter(s),!1),15,0),l.showFinishedItems()||(m=g("notFinishedItems")(m)),o=!m||m&&0===m.length},v=d.getDebouncedFunction(function(a,b){var c=void 0===b;return x(c)}),w=!1,x=function(){return w=!0,0===n.length&&(n.push(a.$on("tw.library.metadata.finish",u)),n.push(a.$on("tw.upload.done",v)),n.push(a.$watchCollection(p,u))),b.fetchLocalPublications().then(function(){return k.isBoshOnline()?(j.setTime(),h(angular.noop).then(function(){return t(!0),b.fetchPublications().catch(y)}).finally(function(){return t(!1),b.deliverables&&Object.keys(b.deliverables).forEach(function(b){a.$broadcast("tw.metadata.update",b)}),z()})):void t(!1)}).catch(function(c){return console.warn(c),b.fetchPublications().finally(function(){return t(!1),b.deliverables&&Object.keys(b.deliverables).forEach(function(b){a.$broadcast("tw.metadata.update",b)}),z()})})},y=function(a){return t(!1),c.handleError(a)},z=function(){return i.sync(b.getDeliverables())},A=function(){return w},B=function(){w=!1,m=null;for(var a;a=n.pop();)a()},C=function(a){return t(!0),f.deleteDeliverables([a]).finally(x)},D=!1,E=function(){return D},F=function(a){D=a};return{isEmptyBookshelf:r,deletePub:C,isInit:A,init:x,reset:B,getCoverflowItems:q,isMenuVisible:E,setMenuVisible:F}}]),angular.module("mybooks").directive("twAuthorListView",["mybooks",function(a){"use strict";return{restrict:"E",scope:{},templateUrl:"../states/mybooks/authors/authors-list-view.tpl.html",link:function(b){b.isEmptyBookshelf=!1,b.isMyAudiobooks=a.isMyAudiobooks(),b.authors=null,b.authorMap=null,b.stateName=a.getStateName(),a.isInit()||a.init(),b.$watch(a.isEmptyBookshelf,function(a){b.isEmptyBookshelf=a}),b.$watch(a.getFilteredDeliverables,function(c){var d=b.authorMap=a.createAuthorMap(c);b.authors=Object.keys(d)})}}}]),angular.module("mybooks").filter("author",[function(){"use strict";return function(a,b){if(!b||""===b)return a;b=b.replace(/[-*+?.()[\]{}\\^$|#]/g,"\\$&");var c=new RegExp(b,"gi"),d=function(a){if(a){var b="";if(a.author&&(b+=a.author+" "),b.match(c))return a}};return a.filter(d)}}]),angular.module("mybooks").directive("twAuthorsTitleView",["$rootScope","inventory","mybooks","stateHelper","libraryModel",function(a,b,c,d,e){"use strict";return{restrict:"E",scope:{},templateUrl:"../states/mybooks/authors/titles/author-title-view.tpl.html",link:function(a){c.isInit()||c.init(),a.isMyAudiobooks=!1,a.libModel=e,a.deliverables=null,a.name=d.getCurrentState().params.name,a.$watch(c.isMyAudiobooks,function(b){a.isMyAudiobooks=b}),a.$watch(c.getFilteredDeliverables,function(b){a.deliverables=b}),a.coverAction=e.openDeliverable}}}]),angular.module("mybooks").directive("twTitlesHeaderBar",["stateHelper","mybooks",function(a,b){"use strict";return{restrict:"E",scope:{},template:'<tw-library-bar tw-title="{{::title}}"></tw-library-bar>',link:function(c){var d=a.getCurrentState().params.name;c.$on("searchAction",function(b,c){b.stopPropagation(),a.goToState("search",{searchTerm:c})}),c.$on("sortAction",function(a,c,d){a.stopPropagation(),b.sort(c,d)}),c.$on("deleteAction",function(c){c.stopPropagation(),a.setAsKeyState(),a.goToState(b.getStateName("authors.selection"),{action:"delete",deliverables:b.getDeliverablesByAuthor(d)})}),c.$on("addToCollectionAction",function(c){c.stopPropagation(),a.setAsKeyState(),a.goToState(b.getStateName("authors.selection"),{action:"addToCollection",deliverables:b.getDeliverablesByAuthor(d)})}),c.$on("backAction",function(c){c.stopPropagation(),a.goToState(b.getStateName("authors"))}),c.title=d}}}]),angular.module("mybooks").directive("twCollectionView",["$rootScope","mybooks","collections","stateHelper","libraryModel","inventory","sync","BaseUtil","user",function(a,b,c,d,e,f,g,h,i){"use strict";return{restrict:"E",scope:{},templateUrl:"../states/mybooks/collections/collection-view.tpl.html",link:function(j){function k(a){function b(b,c){function d(a,b){return a.id===e.items[b].id}var e=a[c];return b.id===e.id&&b.items.length===e.items.length&&b.items.every(d)}return j.collections&&a?j.collections.length!==a.length||!j.collections.every(b):j.collections!==a}function l(){var a=c.getWithDeliverables(p);a&&r&&(a=a.filter(function(a){return r.test(a.title)}),0===a.length&&(a=null)),k(a)&&(j.collections=a)}function m(a){a&&a.stopPropagation&&a.stopPropagation(),h.debounce(function(){g.sync(f.getDeliverables()).finally(l)},1e3),"boolean"==typeof b.isEmptyBookshelf()&&l()}function n(a,c){d.goToState(b.getStateName("collections.titles"),{name:c,action:o.action})}var o=d.getCurrentState().params,p=/audiobook/i.test(d.getCurrentState().state.name)?"AUDIOBOOK":"EBOOK",q=[],r=null;j.collections=null,j.libModel=e,j.demoMode=!i.isLoggedIn(),j.onLoginClick=function(){return i.login()},j.onCreateClick=function(){a.$emit("tw.collection.dialog.create")},q.push(a.$on("tw.collection.open",n)),q.push(a.$on("tw.collection.rename",m)),j.$on("open",function(a,b){a.stopPropagation(),n(a,b)}),q.push(a.$on("tw.collection.update",function(a,b){"string"==typeof b&&(r=b?new RegExp(b.replace(/[-*+?.()[\]{}\\^$|#]/g,"\\$&"),"i"):null),m(a)})),j.$watch(b.getCurrentDeliverables,m),j.$on("$destroy",function(){for(var a;a=q.pop();)a()}),b.isInit()||b.init()}}}]),angular.module("mybooks").filter("collection",[function(){"use strict";return function(a,b){if(!b||""===b)return a;b=b.replace(/[-*+?.()[\]{}\\^$|#]/g,"\\$&");var c=new RegExp(b,"i"),d=function(a){return c.test(a)};return a.filter(d)}}]),angular.module("mybooks").directive("twCollectionsSelectionCheckbox",["collections","stateHelper","$timeout",function(a,b,c){"use strict";return{restrict:"E",scope:{},template:'<tw-selection-checkbox ng-if="isEnabled" options="options"></tw-selection-checkbox>',link:function(d){function e(b){return!a.selection.isDisabled(b)}function f(){return a.getByType(g).filter(e)}d.options={isChecked:!1,label:gettext("SELECT_ALL")},d.isEnabled=!b.getCurrentState().params.singleSelect,d.selection=a.selection;var g=/audiobook/i.test(b.getCurrentState().state.name)?"AUDIOBOOK":"EBOOK";d.$on("selection-checkbox",function(b,d){b.stopPropagation(),c(function(){f().forEach(function(b){a.selection.setSelected(b,d)})})}),d.$watch("selection.numSelectedItems",function(a){d.options.isChecked=a>=f().length})}}}]),angular.module("mybooks").directive("twCollectionsSelectionHeaderBar",["$rootScope","stateHelper","mybooks","collections",function(a,b,c,d){"use strict";var e={DELETE:gettext("DELETE_COLLECTIONS"),ADDTOCOLLECTION:gettext("ADD_TO_COLLECTION")};return{restrict:"E",scope:{},template:'<tw-library-bar tw-title="{{selectionTitle}}"></tw-library-bar>',link:function(f){function g(){for(var a in k.selectedItems)if(!k.isDisabled(a))return a}function h(d){if(d.stopPropagation(),k.numSelectedItems>0)if("DELETE"===f.action)a.$emit("tw.collection.dialog.delete",Object.keys(k.selectedItems));else if("ADDTOCOLLECTION"===f.action){var e=g();k.reset(),b.goToState(c.getStateName("collections.titles"),{name:e,action:j.action})}}function i(a){a.stopPropagation(),k.reset(),b.goToLastVisitedState()}var j=b.getCurrentState().params;f.action=j.action&&j.action.toUpperCase(),f.selectionTitle=e[f.action];var k=d.selection,l=a.$on("tw.collection.update",i);f.$on("backAction",i),f.$on("cancelAction",i),f.$on("newCollectionAction",function(b){b.stopPropagation(),k.clearSelection(),a.$emit("tw.collection.dialog.create")}),f.$on("addToCollectionAction",h),f.$on("deleteAction",h),f.$on("$destroy",l)}}}]),angular.module("mybooks").directive("twCollectionsSelectionView",["$rootScope","stateHelper","mybooks","collections","libraryModel","user",function(a,b,c,d,e,f){"use strict";return{restrict:"E",replace:!1,scope:{},templateUrl:"../states/mybooks/collections/selection/collections-selection-view.tpl.html",link:function(g){function h(a){function b(b){return a.items.some(function(a){return b===a.id})}for(var c in e.selection.selectedItems)if(!b(c))return;d.selection.setDisabled(a.id,!0)}function i(){"boolean"==typeof c.isEmptyBookshelf()&&(g.collections=d.getWithDeliverables(k),"addToCollection"===j.params.action&&g.collections.forEach(h),d.selection.isSelectionMode=!0,d.selection.isRadioMode=!!b.getCurrentState().params.singleSelect)}g.collections=null,g.libModel=e;var j=b.getCurrentState(),k=/audiobook/i.test(j.state.name)?"AUDIOBOOK":"EBOOK";g.onCreateClick=function(){a.$emit("tw.collection.dialog.create")},g.onLoginClick=function(){return f.login()},g.$watch(c.getFilteredDeliverables,i),c.isInit()?i():c.init()}}}]),angular.module("mybooks").directive("twCollectionsTitlesHeaderBar",["$rootScope","stateHelper","mybooks","collections","libraryModel",function(a,b,c,d,e){"use strict";return{restrict:"E",scope:{},template:'<tw-library-bar tw-title="{{ headline }}"></tw-library-bar>',link:function(f){f.$on("backAction",function(a){return a.stopPropagation(),b.goToState(c.getStateName("collections"))}),f.$on("searchAction",function(a,c){a.stopPropagation(),b.goToState("search",{searchTerm:c})}),f.$on("sortAction",function(a,b,d){a.stopPropagation(),c.sort(b,d)}),f.$on("deleteAction",function(a){a.stopPropagation(),b.setAsKeyState(),b.goToState(c.getStateName("selection"),{action:"delete",ref:g})}),f.$on("newCollectionAction",function(b){b.stopPropagation(),a.$emit("tw.collection.dialog.create")}),f.$on("addToCollectionAction",function(a){a.stopPropagation();var f=e.selection;d.getDeliverables(g).forEach(function(a){f.setSelected(a.id,!0),f.setDisabled(a.id,!0)}),b.setAsKeyState(),b.goToState(c.getStateName("selection"),{action:"addToCollection",ref:g})}),f.$on("removeFromCollectionAction",function(a){return a.stopPropagation(),b.setAsKeyState(),b.goToState(c.getStateName("selection"),{action:"removeFromCollection",deliverables:d.getDeliverables(g),ref:g})});var g=b.getCurrentState().params.name;f.headline=d.getTitle(g)}}}]),angular.module("mybooks").directive("twCollectionsTitleView",["$timeout","$rootScope","inventory","mybooks","stateHelper","libraryModel","collections","sync","user","CONFIG",function(a,b,c,d,e,f,g,h,i,j){"use strict";return{restrict:"E",scope:{},templateUrl:"../states/mybooks/collections/titles/collections-title-view.tpl.html",link:function(k){function l(){b.$emit("tw.activity.indicator.start","root-indicator"),h.sync(c.getDeliverables()).finally(function(){b.$emit("tw.activity.indicator.stop","root-indicator"),"boolean"==typeof d.isEmptyBookshelf()&&(k.deliverables=d.getFilteredDeliverables(),o&&p>0&&b.$emit("tw.collection.items.added",n,p))})}var m=e.getCurrentState().params,n=m.name,o="addToCollection"===m.action,p=0;k.name=n,k.libModel=f,k.deliverables=null,k.isMyAudiobooks=!1,k.isLoggedIn=i.isLoggedIn(),k.onLoginClick=function(){return i.login()},o&&(p=g.addDeliverables(n,f.selection.selectedItems),f.selection.clearSelection(),h.sync(c.getDeliverables())),d.initOrUpdateDeliverables(),k.addTitles=function(){e.setAsKeyState(),e.goToState(d.getStateName("selection"),{action:"addToCollection",ref:k.name})},k.$watchCollection(d.getFilteredDeliverables,l),k.$watch(d.isMyAudiobooks,function(a){k.isMyAudiobooks=a}),k.coverAction=function(a){b.$emit("tw.library.open",a)};var q=[];q.push(b.$on("tw.collection.remove",function(a,b){return g.removeDeliverable(n,b),g.isEmpty(n)&&g.retainCollection(n),d.getFilteredDeliverables(!0),l(),h.sync(c.getDeliverables())})),(Modernizr.isie||Modernizr.isedge)&&q.push(b.$on("tw.library.mark.finished",function(b,d){if(n===j.globals.STORE.TAG_FINISHED_READINGS)return a(function(){g.removeDeliverable(n,d),k.deliverables=null}).then(function(){return h.sync(c.getDeliverables()).then(l)})})),(Modernizr.isie||Modernizr.isedge)&&q.push(b.$on("tw.deliverables.sortOrderChange",function(){return a(function(){k.deliverables=null}).then(function(){l()})})),q.push(b.$on("tw.collection.render",l)),k.$on("$destroy",function(){for(var a;a=q.pop();)a()})}}}]),angular.module("mybooks").directive("twDetailsAbstract",["mybooks","details","stateHelper","$sce",function(a,b,c,d){"use strict";return{restrict:"E",scope:{},template:'<tw-abstract ng-if="abstract" abstract="abstract"></tw-abstract>',link:function(c){a.isInit()||a.init().then(function(){b.init()}),c.abstract=null,c.$watch(b.getPublication,function(a){c.abstract=a&&d.trustAsHtml(a.descAbstract)||""})}}}]),angular.module("mybooks").directive("twDetailsArrows",["details","$window","$timeout","$rootScope",function(a,b,c,d){"use strict";return{restrict:"E",scope:{},transclude:!0,templateUrl:"../states/mybooks/details/details-arrows.tpl.html",link:function(e){var f=angular.element(b),g=function(a){var b=a&&a.keyCode;switch(b){case 37:case 38:e.changePublication(!0);break;case 32:case 39:case 40:e.changePublication(!1)}return c(angular.noop)};e.navigationVisible=!1,e.$on("tw.mybooks.details.deliverablesChange",function(){e.navigationVisible=a.navigationAvailable()}),e.changePublication=function(b){a.changePublication(b)},e.$on("interaction.swipe",function(b,d){return"left"===d.direction?a.changePublication(!1):"right"===d.direction&&a.changePublication(!0),c(angular.noop)});var h=d.$on("tw.library.metadata.finish",function(){f.bind("keyup",g)}),i=d.$on("tw.library.metadata",function(){f.unbind("keyup",g)});e.$on("$destroy",function(){f.unbind("keyup",g),h(),i()}),f.bind("keyup",g)}}}]),angular.module("mybooks").directive("twDetailsCoverInfo",["$window","$rootScope","details","stateHelper","$timeout","CONFIG","bosh","mybooks",function(a,b,c,d,e,f,g,h){"use strict";return{restrict:"E",scope:{},template:'<tw-cover-info deliverable="deliverable"></tw-cover-info>',link:function(a){a.deliverable=null;var d,i,j,k=function(){return c.getDeliverable()};a.$watch(k,function(b){b&&(a.deliverable=b)}),h.isInit()||h.init().then(function(){c.init()});var l=function(){return g.isBoshOnline()?(a.deliverable&&a.deliverable.id&&b.$emit("tw.library.metadata",a.deliverable.id),e(angular.noop)):void b.$emit("tw.component.error",f.globals.ERROR.NETWORK_OFFLINE)},m=function(){a.deliverable&&b.$emit("tw.library.download",a.deliverable.id)},n=function(){return d&&d(),e(angular.noop).then(function(){a.deliverable.isOffline=!1,a.deliverable.isDownloading=!1},1e3)},o=function(c){return c.stopPropagation(),c.preventDefault(),
b.$emit("tw.library.open",a.deliverable.id),e(angular.noop)},p=function(){d&&d(),i(),j()};i=b.$on("tw.contextMenu.action",function(a,b){return"EDIT"===b.action?l():"DOWNLOAD"===b.action?m(a):"OPEN"===b.action?o(a):void 0}),a.$on("cover.info.edit",l),a.$on("cover.info.download",m),j=b.$on("tw.loader.abort",n),a.$on("cover.info.note",o),a.$on("$destroy",p)}}}]),angular.module("mybooks").directive("twDetailsDeleteDialog",["details","$rootScope",function(a,b){"use strict";return{restrict:"E",scope:{},template:"<tw-delete-dialog></tw-delete-dialog>",link:function(c){c.$on("delete-dialog-confirm",function(c,d){c.stopPropagation();var e=d&&d.selectedPub;if(e)return b.$emit("tw.activity.indicator.start","details"),a.deletePublication(e).finally(function(){e=null,b.$emit("tw.activity.indicator.stop","details")})})}}}]),angular.module("mybooks").directive("twDetailsHeaderBar",["$window","details","mybooks","libraryModel","stateHelper",function(a,b,c,d,e){"use strict";return{restrict:"E",scope:{},template:"<tw-library-bar></tw-library-bar>",link:function(a){a.delId=null,a.libModel=d,a.$on("backAction",function(){return e.goToLastKeyState()}),a.$on("contextAction",function(b,c){var e={clientX:c.clientX,clientY:c.clientY,target:{getAttribute:function(){return a.delId}}};d.showContextMenu(e)});var f=function(){return b.getDeliverable()};a.$watch(f,function(b){b&&b.id&&(a.delId=b.id)}),c.isInit()||c.init().then(function(){b.init()})}}}]),angular.module("mybooks").directive("twDetailsPubDetails",["details","mybooks",function(a,b){"use strict";return{restrict:"E",scope:{},template:'<tw-pub-details publication="publication" deliverable="deliverable"></tw-pub-details>',link:function(c){c.deliverable=null,c.publication=null;var d=function(){return a.getPublication()};c.$watch(d,function(a){a&&(c.publication=a)});var e=function(){return a.getDeliverable()};c.$watch(e,function(a){a&&(c.deliverable=a)}),b.isInit()||b.init().then(function(){a.init()})}}}]),angular.module("mybooks").directive("twDetailsReadButton",["$rootScope","details",function(a,b){"use strict";return{restrict:"E",scope:{},template:'<button class="raised" ng-click="open()" translate>COMMON_READ</button>',link:function(c){c.open=function(){var c={id:b.getDeliverable().id};c&&c.id&&a.$emit("tw.library.open",c.id)}}}}]),angular.module("mybooks").directive("twDetailsRecommendations",["details","mybooks",function(a,b){"use strict";return{restrict:"E",scope:{},template:'<tw-recommendations class="embedded" amount="15" deliverable="deliverable" visible="true" showshoplink="false"></tw-recommendations>',link:function(c){c.deliverable=null;var d=function(){return a.getDeliverable()};c.$watch(d,function(a){a&&(c.deliverable=a)}),b.isInit()||b.init().then(function(){a.init()})}}}]),angular.module("mybooks").directive("twDetailsSidebarMenu",["mybooks",function(a){"use strict";return{restrict:"E",scope:{},template:'<tw-sidebar-menu ng-class="{\'visible\' : menuVisible}" close-menu="service.setMenuVisible(value)"></tw-sidebar-menu>',link:function(b){b.service=a,b.menuVisible=!1;var c=function(){return a.isMenuVisible()};b.$watch(c,function(a){b.menuVisible=a})}}}]),angular.module("mybooks").directive("twDetailsStateWatcher",["details","mybooks","$rootScope","$state","libraryModel",function(a,b,c,d,e){"use strict";return{restrict:"A",link:function(){var f=c.$on("$viewContentLoaded",function(){d.includes("details.**")?e.setContextMenuActive(!0):(e.setContextMenuActive(!1),f())}),g=c.$on("$stateChangeSuccess",function(){d.includes("details.**")||(a.reset(),b.reset(),g())})}}}]),angular.module("mybooks").factory("details",["$rootScope","$location","stateHelper","inventory","mybooks","collections","loader","delete","libraryModel",function(a,b,c,d,e,f,g,h,i){"use strict";var j,k=null,l=null,m=null,n=!1,o=function(){return m},p=function(){return l},q=function(a){var c=j.indexOf(l);c=a?c<=0?j.length-1:c-1:c>=j.length-1?0:c+1,k=j[c].id,l=j[c],m=d.getPubForDeliverable(k),v(l),b.search("id",k)},r=function(){return g.fetchDeliverable(k,{}).then(function(){var a=d.deliverables[k];a.isOffline=!0,d.saveDeliverable(k)})},s=function(){return h.deleteDeliverables([k]).finally(q)},t=function(){return n},u=function(a){n=a},v=function(a){a.subscriptionId&&(a.subscriptionNames=a.tags.filter(function(a){return"subscription"===a.category}).map(function(a){return a.displayName}).join(", "))},w=function(a){return"AUDIOBOOK"!==a.type},x=function(){j=null,k=null,m=null,l=null},y=function(){return j&&j.length>1},z=function(){var b=c.getCurrentState(),g=b.params.state,h=b.params.name;if(g.indexOf("author")>-1)j=e.getDeliverablesByAuthor(h);else if(g.indexOf("collection")>-1){var n=i.getSortOrder();j=d.sortDeliverables(n,f.getDeliverables(h))}else j=e.getFilteredDeliverables().filter(w);a.$broadcast("tw.mybooks.details.deliverablesChange"),Boolean(k)===!1&&(k=c.getCurrentState().params.id),k&&(l=d.deliverables[k],m=d.getPubForDeliverable(k),v(l))};return{reset:x,getPublication:o,getDeliverable:p,changePublication:q,cachePublication:r,deletePublication:s,isMenuVisible:t,setMenuVisible:u,navigationAvailable:y,init:z}}]),angular.module("mybooks").filter("hearables",[function(){"use strict";return function(a){if(!a)return null;var b=function(a){return"AUDIOBOOK"===a.type};return a.filter(b)}}]),angular.module("mybooks").directive("twMybooksDeleteDialog",["mybooks",function(a){"use strict";return{restrict:"E",scope:{},template:"<tw-delete-dialog></tw-delete-dialog>",link:function(b){b.$on("delete-dialog-confirm",function(b,c){b.stopPropagation();var d=c&&c.selectedPub;return d?a.deletePub(d).finally(function(){d=null}):a.deleteSelectedPubs()})}}}]),angular.module("mybooks").directive("twMybooksHeaderBar",["$window","$rootScope","$timeout","libraryModel","mybooks","user","CONFIG","stateHelper",function(a,b,c,d,e,f,g,h){"use strict";return{restrict:"E",scope:{},template:"<tw-library-bar></tw-library-bar>",link:function(c){c.isUploadDisabled=a.Modernizr.ios||a.Modernizr.android,c.isLoggedIn=f.isLoggedIn(),c.$on("menuAction",function(a){a.stopPropagation(),e.isMenuVisible()||e.setMenuVisible(!0)}),c.$on("searchAction",function(a,b){a.stopPropagation(),h.goToState("search",{searchTerm:b})}),c.$on("sortAction",function(a,b,c){a.stopPropagation(),e.sort(b,c)}),c.$on("deleteAction",function(a){a.stopPropagation(),h.setAsKeyState(),h.goToState(e.getStateName("selection"),{action:"delete"})}),c.$on("newCollectionAction",function(a){a.stopPropagation(),b.$emit("tw.collection.dialog.create")}),c.$on("deleteCollectionsAction",function(a){a.stopPropagation(),h.goToState(e.getStateName("collections.selection"),{action:"delete"})}),c.$on("addToCollectionAction",function(a){a.stopPropagation(),h.setAsKeyState(),h.goToState(e.getStateName("selection"),{action:"addToCollection"})}),c.headline=e.isMyAudiobooks()?gettext("COMMON_MY_AUDIOBOOKS"):gettext("COMMON_MY_BOOKS"),c.service=d}}}]),angular.module("mybooks").directive("twMybooksModal",["mybooks",function(a){"use strict";return{restrict:"E",scope:{},template:'<div ng-click="hideMenu()" ng-class="{visible: menuVisible}" class="container-inner-modal"></div>',link:function(b){b.menuVisible=!1,b.hideMenu=function(){a.isMenuVisible()&&a.setMenuVisible(!1)},b.$watch(a.isMenuVisible,function(a){b.menuVisible=a}),window.addEventListener("resize",function(){a.isMenuVisible()&&(b.menuVisible=window.innerWidth<1200)},!1)}}}]),angular.module("mybooks").directive("twMybooksSidebarMenu",["mybooks",function(a){"use strict";return{restrict:"E",scope:{},template:'<tw-sidebar-menu ng-class="{\'visible\' : menuVisible}" close-menu="service.setMenuVisible(value)"></tw-sidebar-menu>',link:function(b){b.service=a,b.menuVisible=!1;var c=function(){return a.isMenuVisible()};b.$watch(c,function(a){b.menuVisible=a})}}}]),angular.module("mybooks").directive("twMybooksStateWatcher",["mybooks","$rootScope","$state","libraryModel",function(a,b,c,d){"use strict";return{restrict:"A",link:function(e){var f=b.$on("$viewContentLoaded",function(){var a=(c.includes("mybooks.**")||c.includes("myaudiobooks.**"))&&!/selection/i.test(c.current.name);d.setContextMenuActive(a)}),g=b.$on("$stateChangeSuccess",function(){(c.includes("mybooks.**")||c.includes("myaudiobooks.**"))&&a.setSelectionMode(!1)});e.$on("$destroy",function(){a.reset(),a.setSelectionMode(!1),f(),g()})}}}]),angular.module("mybooks").directive("twMybooksTabBar",["mybooks",function(a){"use strict";return{restrict:"E",replace:!1,scope:{},templateUrl:"../states/mybooks/mybooks-tab-bar.tpl.html",link:function(b){b.$watch(a.isMyAudiobooks,function(a){var c=a?"myaudiobooks.":"mybooks.";b.tabsConfig=[{id:c+"titles",title:gettext("COMMON_TITLE")},{id:c+"authors",title:gettext("COMMON_AUTHOR")},{id:c+"collections",title:gettext("COMMON_COLLECTIONS")}]})}}}]),angular.module("mybooks").controller("myBooksController",["$scope","$rootScope","libraryModel","mybooks","collections",function(a,b,c,d,e){"use strict";var f=[];a.noOfCurrentlySelectedItems=0,f.push(b.$on("selection-header-bar",function(a,b,d){"ADDTOCOLLECTION"===b&&(e.addDeliverables(d,c.selection.selectedItems),c.selection.clearDisabledItems(),c.selection.clearSelection())})),f.push(b.$on("tw.upload.done",function(a,b){b||d.init()})),a.$on("interaction.key.info",function(){var a="|";console.info("Deliverables"),console.log(["id","title","author","crypt","type","format"].join(a)+"\n"+d.getFilteredDeliverables().map(function(b){return[b.id,b.title,b.author,b.isCrypt?"Y":"N",b.type,b.format+("ePub"===b.format?(b.epubVersion||"").substr(0,1):"")].join(a)}).join("\n"))}),a.$on("$destroy",function(){for(var a;a=f.pop();)a()})}]),angular.module("mybooks").factory("mybooks",["$q","$rootScope","$filter","$timeout","inventory","delete","StringUtil","libraryModel","error","CONFIG","stateHelper","sync","collections","time","bosh",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){"use strict";var p=null,q=null,r=null,s="",t=null,u=!1,v=[],w=null,x=!1,y=h.selection,z=!1,A=function(){return e.deliverables},B=function(){var a=x?"hearables":"readables",b=h.getSortOrder(),d=c(a)(e.getDeliverables());K(d),h.showFinishedItems()||(d=c("notFinishedItems")(d)),q=e.sortDeliverables(b,d),w=!q||0===q.length,N()},C=function(){return x},D=function(a){var b=C()?"myaudiobooks":"mybooks";return a?b+"."+a:b},E=function(){return w},F=function(a){var c="tw.activity.indicator."+(a?"start":"stop");b.$emit(c,"root-indicator")},G=function(a){return F(!0),f.deleteDeliverables([a]).finally(function(){F(!1)})},H=function(){var a=Object.keys(y.selectedItems);return F(!0),f.deleteDeliverables(a).finally(function(){y.clearSelection(),S()})},I=function(a){var b=r||[];b.forEach(function(b){y.setSelected(b.id,a)})},J=function(){var a=r||[];return y.numSelectedItems===Object.keys(a).length},K=function(a){var b=Object.create(null);a.forEach(function(a){b[a.resellername]=!0}),p=Object.keys(b).length>1},L=function(){return p},M=function(){u?N():S()},N=function(){var a=x?"hearables":"readables",b=k.getCurrentState(),d="addToCollection"!==b.params.action&&b.params.ref||b.state.name.endsWith(".collections.titles")&&b.params.name,f=b.state.name.endsWith(".authors.titles")&&b.params.name,g=d?m.getDeliverables(d):f?Z(f):c(a)(e.getDeliverables());h.showFinishedItems()||d||(g=c("notFinishedItems")(g)),t&&(g=g.filter(function(a){return t.test(a.title)||t.test(a.author)||t.test(a.subtitle)||x&&(t.test(a.reader)||t.test(a.speaker))})),r=e.sortDeliverables(h.getSortOrder(),g)},O=function(a){return"string"==typeof a?(s=a,t=a?new RegExp(a.replace(/[-*+?.()[\]{}\\^$|#]/g,"\\$&"),"i"):null,N()):"boolean"==typeof a&&N(),r},P=function(){return s},Q=function(){return q},R=function(a,b){y.clearSelection(),y.toggle(b),k.setAsKeyState(),k.goToState(D("collections.selection"),{action:"addToCollection",singleSelect:!0})},S=function(){u=!0;var a=k.getCurrentState().state.name;return x=null!==a.match("myaudiobooks"),0===v.length&&(v.push(b.$on("tw.library.metadata.finish",T)),v.push(b.$on("tw.library.mark.finished",B)),v.push(b.$on("tw.collection.add",R)),v.push(b.$watchCollection(A,B))),e.fetchLocalPublications().then(function(a){return a&&Object.keys(a).length>0&&(z=!0),o.isBoshOnline()?(n.setTime(),d(angular.noop).then(function(){return F(!0),e.fetchPublications().catch(V)})):d(angular.noop)}).finally(function(){return F(!1),e.deliverables&&Object.keys(e.deliverables).forEach(function(a){b.$broadcast("tw.metadata.update",a)}),U()})},T=function(a,b){var c=k.getCurrentState();c.state.name.endsWith(".authors.titles")&&0===Z(c.params.name).length&&k.goToState(D("authors.titles"),{name:b.author})},U=function(){return l.sync(e.getDeliverables())},V=function(a){var b=a&&a.status;if(b&&401===b)return i.handleError({type:j.globals.ERROR.APP_INVALID_TOKEN,httpStatusCode:a.status,details:{httpError:a}}).then(function(){return e.fetchPublications()});if(F(!1),!z)return i.handleError(a)},W=function(){return u},X=function(){for(var a;a=v.pop();)a();return u=!1,q=null,x=!1,w=null,I(!1),y.isSelectionMode=!1,d(angular.noop)},Y=function(a){var b={};for(var c in a){var d=a[c],e=d.author||"unknown";b[e]||(b[e]=[]),b[e].push(d)}return b},Z=function(a){return q&&q.filter(function(b){return a===(b.author||"unknown")})},$=!1,_=function(){return $},aa=function(a){$=a},ba=function(a,c){var d={order:a,isDescending:c},e=k.getCurrentState().state.name,f="mybooks.collections"===e;f?(m.setSortCriteria(d),h.setCollectionsSortOrder(d),b.$emit("tw.collection.update")):(h.setSortOrder(a,c),B())},ca=function(a){y.isSelectionMode=a},da=function(){return y.numSelectedItems};return{hasMultipleResellers:L,isMyAudiobooks:C,getStateName:D,isEmptyBookshelf:E,setSelectionMode:ca,numSelectedItems:da,init:S,reset:X,isInit:W,sort:ba,deletePub:G,deleteSelectedPubs:H,createAuthorMap:Y,initOrUpdateDeliverables:M,updateFilteredDeliverables:N,getCurrentSearchTerm:P,getCurrentDeliverables:Q,getFilteredDeliverables:O,getDeliverablesByAuthor:Z,isMenuVisible:_,setMenuVisible:aa,selectAll:I,isAllSelected:J}}]),angular.module("mybooks").filter("readables",[function(){"use strict";return function(a){if(!a)return null;var b=function(a){return"AUDIOBOOK"!==a.type};return a.filter(b)}}]),angular.module("mybooks").directive("twMybooksSelectionCheckbox",["mybooks","$timeout",function(a,b){"use strict";return{restrict:"E",scope:{},template:'<tw-selection-checkbox options="options"></tw-selection-checkbox>',link:function(c){c.options={isChecked:!1,label:gettext("SELECT_ALL")},c.$on("selection-checkbox",function(c,d){c.stopPropagation(),b(function(){a.selectAll(d)})}),c.$watch(a.isAllSelected,function(a){c.options.isChecked=a})}}}]),angular.module("mybooks").directive("twMybooksSelectionHeaderBar",["$rootScope","stateHelper","mybooks","libraryModel",function(a,b,c,d){"use strict";var e={DELETE:gettext("TOOLTIP_COMPONENT_LIBRARY_CONTEXTDELETE"),ADDTOCOLLECTION:gettext("ADD_TO_COLLECTION"),REMOVEFROMCOLLECTION:gettext("REMOVE_FROM_COLLECTION")};return{restrict:"E",scope:{},template:'<tw-library-bar tw-title="{{selectionTitle}}"></tw-library>',link:function(f){var g=b.getCurrentState().params;f.action=g.action&&g.action.toUpperCase(),f.selectionTitle=e[f.action];var h=function(d){if(d.stopPropagation(),c.numSelectedItems()>0){if(!g.ref&&"DELETE"!==f.action)return void b.goToState(c.getStateName("collections.selection"),{action:g.action,singleSelect:!0});a.$emit("selection-header-bar",f.action,g.ref)}"REMOVEFROMCOLLECTION"!==f.action&&b.goToLastKeyState()},i=function(a){a.stopPropagation(),d.selection.reset(),b.goToLastKeyState()};f.$on("backAction",i),f.$on("cancelAction",i),f.$on("addToCollectionAction",h),f.$on("removeFromCollectionAction",h),f.$on("deleteAction",h)}}}]),angular.module("mybooks").directive("twSelectionView",["$rootScope","stateHelper","mybooks","libraryModel",function(a,b,c,d){"use strict";return{restrict:"E",replace:!1,scope:{},templateUrl:"../states/mybooks/selection/selection-view.tpl.html",link:function(a){var e=b.getCurrentState().params;a.deliverables=e.deliverables,a.deliverables?d.selection.isSelectionMode=!0:a.$watch(c.getFilteredDeliverables,function(b){a.deliverables=b,d.selection.isSelectionMode=!0}),c.initOrUpdateDeliverables(),a.isMyAudiobooks=c.isMyAudiobooks(),a.libModel=d}}}]),angular.module("mybooks").filter("title",[function(){"use strict";return function(a,b){if(!b||""===b)return a;b=b.replace(/[-*+?.()[\]{}\\^$|#]/g,"\\$&");var c=new RegExp(b,"gi"),d=function(a){if(a){var b="";if(a.title&&(b+=a.title+" "),a.subtitle&&(b+=a.subtitle+" "),b.match(c))return a}};return a.filter(d)}}]),angular.module("mybooks").directive("twTitlesView",["$window","$timeout","$rootScope","BaseUtil","mybooks","libraryModel",function(a,b,c,d,e,f){"use strict";return{restrict:"E",replace:!1,scope:{},templateUrl:"../states/mybooks/titles/titles-view.tpl.html",link:function(a){e.initOrUpdateDeliverables(),a.deliverables=null,a.isEmptyBookshelf=!1,a.libModel=f,a.isMyAudiobooks=!1,a.coverAction=f.openDeliverable,a.$watch(e.isMyAudiobooks,function(b){a.isMyAudiobooks=b}),a.$watch(e.isEmptyBookshelf,function(b){a.isEmptyBookshelf=b}),a.$watch(e.getFilteredDeliverables,function(c){return b(function(){a.deliverables=c},0,!0)})}}}]),angular.module("pdf").controller("PdfAnnotationsPanelCtrl",["$rootScope","$scope","$timeout","pdfInfo",function(a,b,c,d){"use strict";var e=function(e){"boolean"!=typeof e&&(e=!b.isAnnotationsPanelVisible),e||c(angular.noop).then(function(){a.showVersion=null}),b.isAnnotationsPanelVisible!==e&&(b.isAnnotationsPanelVisible=e,e&&b.isToCPaneVisible&&(d.sendMessage("reader","expandToCurrentPage"),a.showVersion=!0))};this.name=function(){return"PdfAnnotationsPanelCtrl"},this.messageHandler=function(a,b){if("annotationsPanel"===a)switch(b){case"show":e(!0);break;case"hide":e(!1);break;case"toggle":e()}},b.isAnnotationsPanelVisible=!1,b.isToCPaneVisible=!0,b.isBookmarksPaneVisible=!1,b.selectPane=function(a){b.isToCPaneVisible="toc"===a,b.isBookmarksPaneVisible="bookmarks"===a},d.registerController(this)}]),angular.module("pdf").controller("PdfBookmarkController",["$scope","pdfInfo",function(a,b){"use strict";var c=null,d=function(a){var b=/#pdfloc\([^,]*,(\d*)/.exec(a);return b?parseInt(b[1],10):0},e=function(a,b){return d(a.rmsdkPosition)-d(b.rmsdkPosition)},f=function(){a.isBookmarksPaneVisible&&c&&(a.bookmarks.length=0,c.dogears&&(a.bookmarks=c.dogears.filter(g),a.bookmarks.sort(e)))},g=function(a){return!a.deleted};this.messageHandler=function(a,b,d){"info"===b?(c=d&&d.deliverable,f()):"dogear"===a&&f()},this.name=function(){return"PdfBookmarkController"},a.bookmarks=[],a.$watch("isBookmarksPaneVisible",function(){f()}),b.registerController(this)}]),angular.module("pdf").controller("PdfDogearCtrl",["$timeout","$scope","pdfInfo",function(a,b,c){"use strict";var d="PdfDogearCtrl",e=null,f=null;b.isLibrary=!1;var g=function(){f=e[0].querySelector("svg"),f&&(i.disconnect(),j(Boolean(c.hasDogear())))},h=window.MutationObserver||window.WebKitMutationObserver,i=new h(g);b.toggleDogear=function(){c.handleDogearRequest()},b.$on("$destroy",function(){e.unbind(),e=null,f=null,i.disconnect(),c.unregisterController(d)});var j=function(a){f&&(a?angular.element(f).addClass("active"):angular.element(f).removeClass("active"))};this.name=function(){return d},this.init=function(a){e=a,i.observe(e[0],{childList:!0,subtree:!0,attributes:!1}),a.bind("touchstart",function(b){var c=b.timeStamp,d=a.data("lastTouch")||c,e=c-d,f=b.touches.length;a.data("lastTouch",c),!e||e>500||f>1||b.preventDefault()}),c.registerController(this)},this.messageHandler=function(a,c,d){"dogear"===a&&j("set"===c),"all"===a&&"info"===c&&(b.isLibrary=d.isLibrary)}}]),angular.module("pdf").controller("PdfFooterCtrl",["$scope","pdfInfo",function(a,b){"use strict";var c="PdfFooterCtrl",d=!1,e=null,f=null,g=null,h=null,i=null;a.isSliderVisible=!1,a.sliderCeiling=null,a.sliderValue=null,a.chapterAction=function(a){a?b.getNextChapter():b.getPreviousChapter()},a.pagerAction=function(){b.sendMessage("pager","action")},this.init=function(a){e=a,f=angular.element(e[0].querySelector(".section-label")),g=angular.element(e[0].querySelector(".page-info")),h=e[0].querySelector(".chapter-next"),i=e[0].querySelector(".chapter-previous"),b.registerController(this)},this.name=function(){return c},this.messageHandler=function(b,c,e){"all"===b&&"paging"===c&&k(e),"toolbar"===b&&("toggle"===c&&(d=!d,a.isSliderVisible=d),"pages"===c&&k(),"buttons"===c&&e&&j(e))};var j=function(a){a&&(a.next?(h.removeAttribute("disabled"),h.classList.remove("disabled")):(h.setAttribute("disabled","true"),h.classList.add("disabled")),a.previous?(i.removeAttribute("disabled"),i.classList.remove("disabled")):(i.setAttribute("disabled","true"),i.classList.add("disabled")))},k=function(c){if(c||(c=b.getCurrentPage()),c.tocEntry&&c.tocEntry.title&&f.text(c.tocEntry.title),c.numPages&&c.index){if(c.isSinglePage)g.text(c.index+" / "+c.numPages);else{var d;c.index%b.MAX_PAGES===1?(d=c.index-1,g.text(d+" & "+c.index+" / "+c.numPages)):(d=c.index+1,g.text(c.index+" & "+d+" / "+c.numPages))}a.sliderCeiling||(a.sliderCeiling=c.numPages),a.sliderValue=c.index}},l=function(c,d){var e=parseInt(d,10);isNaN(e)?b.jumpToPage(parseInt(d.value,10)):b.jumpToPage(parseInt(d,10)),a.$apply()},m=a.$on("tw.slider.update",l),n=a.$on("tw.slider.step",l);a.$on("$destroy",function(){e=null,f=null,g=null,h=null,i=null,m(),n(),a.sliderCeiling=null,b.unregisterController(c)})}]),angular.module("pdf").controller("PdfNavigationCtrl",["$scope","pdfInfo","$window",function(a,b,c){"use strict";var d="PdfNavigationCtrl",e=null,f=null,g=null,h=function(){f.style.opacity=0,g.style.opacity=0},i=function(){f.style.opacity=1,g.style.opacity=1};this.init=function(a){c.document.addEventListener("mouseleave",h,!1),c.document.addEventListener("mouseenter",i,!1),e=a,b.registerController(this),f=e[0].querySelector(".right-arrow"),g=e[0].querySelector(".left-arrow")},this.name=function(){return d},this.messageHandler=function(a,b){if("navigation"===a)switch(b){case"left":g.style.opacity=1;break;case"right":f.style.opacity=1;break;default:f.style.opacity=0,g.style.opacity=0}"toolbar"===a&&"toggle"===b&&(f.style.opacity=1,g.style.opacity=1)},a.pageAction=function(a){a?b.getNextPage():b.getPreviousPage()},a.$on("$destroy",function(){c.document.removeEventListener("mouseleave",h),c.document.removeEventListener("mouseenter",i),e=null,g=null,f=null,b.unregisterController(d)})}]),angular.module("pdf").controller("PdfPagerCtrl",["$scope","$timeout","pdfInfo",function(a,b,c){"use strict";var d="PdfPagerCtrl",e=null,f=null,g=null;a.visible=!1,a.maxPages=null,a.requestedPage=null,a.clearVisible=!1;var h=function(a){"TW-PDF-PAGER"===a.target.nodeName&&i()},i=function(){a.visible=!1,a.requestedPage=null,e.removeClass("active"),b(function(){g.blur()})};a.resetSearch=function(){a.requestedPage=null,b(function(){g.focus()})},a.handleInputKeyEvent=function(b){13===b.keyCode&&a.jump()},a.jump=function(){return isNaN(parseInt(a.requestedPage,10))?(a.requestedPage=null,void b(function(){g.focus()})):void(a.requestedPage!==f&&(c.jumpToPage(a.requestedPage),i()))},this.name=function(){return d},this.init=function(a){e=a,e.bind("click",h),g=e[0].querySelector("input"),c.registerController(this)},this.messageHandler=function(c,d,h){"pager"===c&&"action"===d&&(a.visible?(a.visible=!1,a.requestedPage=null,e.removeClass("active")):(a.visible=!0,e.addClass("active"),b(function(){g.focus()}))),"toolbar"===c&&"toggle"===d&&(a.visible=!1),"all"===c&&("paging"===d&&(f=h.index),"info"===d&&(a.maxPages=h.numPages))};var j=a.$watch("requestedPage",function(b){b||void 0===b?a.clearVisible=!0:a.clearVisible=!1});a.$on("$destroy",function(){e.unbind("click",i),j(),a.visible=!1,a.maxPages=null,a.requestedPage=null,e=null,g=null,f=null,c.unregisterController(d)})}]),angular.module("pdf").controller("PdfReaderCtrl",["$window","$rootScope","$scope","$injector","pdfInfo","$q","$state","$location","BaseUtil","pdfScroller",function(a,b,c,d,e,f,g,h,i,j){"use strict";var k=angular.element(a),l=500,m=null,n=null,o=null,p=[],q=null,r=!1,s=!1,t=null,u="PdfReaderCtrl";this.name=function(){return u};var v=function(){var a=j.getRotation();if(90===a||270===a)return void x(!0);j.resetPosition();var b=n.getBoundingClientRect().width,c=o[0].getElementsByTagName("canvas")[0],d=c.getBoundingClientRect().width,f=b/d;if(s)j.zoom(f);else{var g=n.getBoundingClientRect().width/e.MAX_PAGES;j.scrollTo(g,null,f)}},w=function(){j.resetPosition();var a=n.getBoundingClientRect().height,b=n.getBoundingClientRect().height,c=a/b;j.zoom(c)},x=function(a){j.resetPosition();var b=n.getBoundingClientRect().height,c=n.getBoundingClientRect().width,d=Math.min(b,c)/Math.max(b,c);a&&(d=b/c),j.zoom(d)},y=function(a){j.zoom(a)},z=function(a){for(var b=[],c=e.getCurrentPage(),g=d.get("CONFIG"),h=0;h<a.length;h++)b.push(a[h]);if(q&&1!==c.index&&c.index!==c.numPages)return f.reject(g.globals.ERROR.RENDER_IN_PROGRESS);q=!0;var i=c.index;return s||i%e.MAX_PAGES!==1||1===i||(i-=1),A(b,b.shift(),i)},A=function(a,b,c){var d=e.getLoadedPdf();return d?d.getPage(c).then(function(d){return B(b,d).then(function(){return a.length>0?A(a,a.shift(),++c):(j.reflow(),void(q=!1))},null)},function(b){return a.length=0,q=!1,f.reject(b)}):f.reject("no pdf loaded")},B=function(b,c){var d,e,f=b.getElementsByTagName("canvas")[0],g=b.getBoundingClientRect().width,h=b.getBoundingClientRect().height;d=c.getViewport(1);var i=d.height-d.width;e=g+i>=h?h/d.height:g/d.width;var j=2;a.devicePixelRatio&&a.devicePixelRatio>1&&(j=2);var k=c.getViewport(e*j);f.height=k.height,f.width=k.width,f.style.height=k.height/j+"px",f.style.width=k.width/j+"px",s?t.removeClass("multi").addClass("single"):t.removeClass("single").addClass("multi");var l={canvasContext:f.getContext("2d"),viewport:k};return c.render(l).then(function(){})},C=function(a){var b=d.get("CONFIG");a!==b.globals.ERROR.RENDER_IN_PROGRESS&&console.warn(a)},D=function(){if(b.$emit("tw.activity.indicator.stop","pdf-indicator"),e.getCurrentPage()){var c;c=0===a.outerWidth?a.innerWidth<a.innerHeight:a.outerWidth<a.outerHeight;var d=Boolean(e.getToc());d&&e.hasTocEntries()?e.sendMessage("toolbar","buttons",{next:!0,previous:!0}):e.sendMessage("toolbar","buttons",{next:!1,previous:!1}),1===e.getCurrentPage().index&&(c=!0,d&&e.hasTocEntries()&&e.sendMessage("toolbar","buttons",{next:!0,previous:!1})),e.getCurrentPage().numPages===e.getCurrentPage().index&&e.getCurrentPage().numPages%e.MAX_PAGES===0?(c=!0,d&&e.sendMessage("toolbar","buttons",{next:!1,previous:!0})):e.getCurrentPage().numPages===e.getCurrentPage().index&&d&&e.sendMessage("toolbar","buttons",{next:!1,previous:!0}),c?(r=!1,s=!0,e.setSinglePage(s),e.sendMessage("toolbar","pages",3)):r?(c=!0,s=!0,e.setSinglePage(s),e.sendMessage("toolbar","pages",1)):(s=!1,e.setSinglePage(s),e.sendMessage("toolbar","pages",2));var f,g,h;if(c){for(f=1;f<o.length;f++)o[f].style.display="none";return g=n.getBoundingClientRect().width,h=n.getBoundingClientRect().height,o[0].style.width=g+"px",o[0].style.height=h+"px",z([o[0]]).catch(C)}for(g=n.getBoundingClientRect().width/o.length,h=n.getBoundingClientRect().height,f=0;f<o.length;f++)o[f].style.width=g+"px",o[f].style.height=h+"px",o[f].style.display="inline-block";return z(o).catch(C)}},E=function(){var a=c.deliverableid;if("library"===c.state&&a){var g=d.get("inventory"),h=g.deliverables[a];if(!h.isFinished&&e.isFinished()){var i=f.defer();return b.$emit("tw.reader.finished",{id:a,deferred:i}),i.promise}}return f.resolve()},F=i.getDebouncedFunction(function(){j.resetPosition(D)},l);this.messageHandler=function(b,d,e){if("reader"===b)switch(d){case"exit":if("library"!==c.state){var f=h.search();f.backref?a.location=f.backref:a.history.back(),c.$destroy()}else E().then(function(){c.close(),c.$destroy()});break;case"zoom":y(e);break;case"fit.width":v();break;case"fit.height":w();break;case"rotate":j.rotate();break;case"render":j.resetPosition(D);break;case"pages":r=!r,j.resetPosition(D)}};var G=function(){p.push(c.$on("interaction.key.space",function(){j.resetPosition(),e.getNextPage()})),p.push(c.$on("interaction.key.left",function(){j.resetPosition(),e.getPreviousPage()})),p.push(c.$on("interaction.key.right",function(){j.resetPosition(),e.getNextPage()}))},H=function(){if(Modernizr.objecturl){var f=d.get("error"),g=d.get("CONFIG");return f.handleError({type:g.globals.ERROR.APP_CONTENT_DELIVERABLE_FAIL,details:{deliverableId:c.deliverableid},ui:{message:a.gettext("CONTENT_ERROR_MESSAGE"),headline:a.gettext("SERVER_ERROR_TITLE")},bosh:!0},!0).catch(function(){I(),e.sendMessage("reader","exit")})}b.$emit("tw.component.error","FEATURE_MISSING")},I=function(){var b=c.deliverableid;if("library"===c.state&&b){var e=a.infoforage,f=d.get("inventory"),g=f.deliverables[b];g&&(a.localforage.removeItem(b),e.removeItem(b),g.isOffline=!1,f.saveDeliverable(b)),c.deliverableid=null}};c.$on("$destroy",function(){c.deliverableid=null,j.clear(),e.unregisterController(u),e.cleanup(),k.unbind("resize",F);for(var a=0;a<p.length;a++)p[a]&&p[a]();p=null,o=null,n=null,t=null,q=null,k=null,r=!1,s=!1}),this.init=function(){c.state=window.tw.app,e.setState(c.state),e.registerController(this),k.bind("resize",F),n=document.getElementById("pagecontainer");var a=document.getElementById("rotationcontainer");o=document.getElementsByClassName("page"),t=angular.element(o[0].getElementsByTagName("canvas")[0]),m=document.getElementById("pdfinterface"),j.init(m,n,a),G();var b="demo";return"library"!==c.state||(b=c.deliverableid)?e.open(b).then(D,H):f.reject("deliverable identifier missing: Unable to retrieve publication")}}]),angular.module("pdf").controller("PdfToCController",["$scope","$element","$timeout","TreeNode","pdfInfo",function(a,b,c,d,e){"use strict";var f,g="PdfToCController",h=function(a){f&&f.setActive(!1),a&&(f=a,f.setActive(!0))},i=function(a){if(!a||!a.title)return null;var b=new d(a.title,{start:a.start});a.start<0&&(b.isEnabled=!1);for(var c=a.children?a.children.length:0,e=0;e<c;e++){var f=i(a.children[e]);f&&(f.isVisible=!1,b.addChild(f))}return b},j=function(b){a.nodes.length=0,b?b.forEach(function(b){a.nodes.push(i(b))}):a.nodes.push(new d(gettext("COMMON_TABLE_OF_CONTENTS_NOT_AVAILABLE"),null,null,!0))},k=function(a,b){a.stopPropagation();var c=b&&b.data;h(b),c&&c.start>0&&(e.jumpToPage(c.start),e.sendMessage("reader","toc.toggle"))},l=function(a){return a&&"DIV"===a.nodeName&&a.hasAttribute("ng-repeat")},m=function(a,b){return{node:a,element:b}},n=function(a,b,c){for(var d,e,f,g=a&&a.length||0,h=Array.prototype.filter.call(b.children,l),i=0;i<g;i++){if(f=h[i],d=a[i],e=d.data.start,e===c)return m(d,f);if(e>c&&i>0)return f=h[i-1],d=a[i-1],d.toggleExpand(!0),d.nodes.length>0?n(d.nodes,f.children[0],c):m(d,f)}return m(d,f)},o=function(a){if(a){var c=b[0].parentNode,d=c.getBoundingClientRect().bottom,e=a.getBoundingClientRect().bottom;e>=d&&(c.scrollTop=e-d)}},p=function(){var d=e.getCurrentPage().index,f=n(a.nodes,b[0],d);h(f.node),c(o.bind(this,f.element))};this.messageHandler=function(a,b,c){switch(b){case"toc":j(c);break;case"expandToCurrentPage":p()}},this.name=function(){return g},a.nodes=[],a.$on("tw.treeNodeAction",k),a.$on("$destroy",function(){a.nodes.length=0,e.unregisterController(g)}),e.registerController(this)}]),angular.module("pdf").controller("PdfToolbarCtrl",["$window","$scope","$timeout","$location","pdfInfo",function(a,b,c,d,e){"use strict";var f="PdfToolbarCtrl",g=null,h=null,i=null;this.init=function(a){g=a,h=g[0].querySelector(".page-switcher");var b=h.querySelectorAll("svg");i=[],i.push(angular.element(b[0])),i.push(angular.element(b[1])),e.registerController(this)},this.name=function(){return f},this.messageHandler=function(a,f,k){var l;if("toolbar"===a){if("hide.back"===f){var m=g[0].querySelector(".close-reader");m&&(m.style.visibility="hidden")}if("toggle"===f&&(j=!j,b.isToolbarVisible=j,b.isToolbarVisible||e.sendMessage("annotationsPanel","hide")),"show"===f)return void(b.isToolbarVisible=j=!0);"zoom"===f&&c(function(){b.sliderValue=k},0,!0),"pages"===f&&(3===k?h.classList.add("disabled"):h.classList.remove("disabled"),
2===k?(i[1].removeClass("hide").addClass("show"),i[0].removeClass("show").addClass("hide"),b.pageLayoutTooltip=gettext("TOOLTIP_COMPONENT_PDF_ACTION_PAGELAYOUTSINGLE")):(i[0].removeClass("hide").addClass("show"),i[1].removeClass("show").addClass("hide"),b.pageLayoutTooltip=gettext("TOOLTIP_COMPONENT_PDF_ACTION_PAGELAYOUTDOUBLE"))),"toc.active"===f&&(l=g[0].querySelector(".btn-toc"),k?l.classList.remove("disabled"):l.classList.add("disabled"))}if("toc.toggle"===f&&(l=g[0].querySelector(".btn-toc"),l.classList.contains("disabled")||e.sendMessage("annotationsPanel","toggle")),"all"===a&&"info"===f&&(b.publicationTitle=k&&k.metaData&&k.metaData.Title||k.deliverable.title,!k.isLibrary)){var n=d.search();n.purchaseurl&&(b.purchaseUrl=n.purchaseurl)}};var j=!1,k=function(a,b){e.sendMessage("reader","zoom",b/2)};b.isToolbarVisible=!1,b.sliderValue=2,b.purchaseUrl=null,b.pageLayoutTooltip="",b.shopJump=function(){a.location=b.purchaseUrl},b.zoomAction=function(a){var c=b.sliderValue;a?(c+=1,c>6&&(c=6)):(c-=1,c<1&&(c=1)),e.sendMessage("reader","zoom",c/2)},b.emitAction=function(a){a&&e.sendMessage("reader",a)},b.$on("$destroy",function(){g=null,h=null,i=null,e.unregisterController(f)}),b.$on("tw.slider.update",k),b.$on("tw.pdfreader.toolbar.toogle",function(){j=!j,b.isToolbarVisible=j})}]),angular.module("pdf").directive("twDogearListItem",["pdfInfo",function(a){"use strict";return{restrict:"E",replace:!0,scope:{model:"="},templateUrl:"../states/pdf/partials/dogear-list-item.tpl.html",link:function(b){b.removeBookmark=function(c){c.stopPropagation(),a.removeBookmark(b.model.rmsdkPosition)},b.goToBookmark=function(){var c=/#pdfloc\([^,]*,(\d*)/.exec(b.model.rmsdkPosition);if(c){var d=parseInt(c[1],10);a.jumpToPage(d),a.sendMessage("reader","toc.toggle")}}}}}]),angular.module("pdf").directive("twPdf",["$rootScope","stateHelper",function(a,b){"use strict";return{restrict:"E",controller:"PdfReaderCtrl",scope:{},templateUrl:"../states/pdf/partials/reader.tpl.html",link:function(c,d,e,f){var g=b.getCurrentState().params;return a.$emit("tw.audio.mini.player",{show:!1}),a.$emit("tw.activity.indicator.start","pdf-indicator"),c.state="library",a.currentDeliverable=c.deliverableid=g&&g.id,c.$on("$destroy",function(){a.currentDeliverable=null,a.$emit("tw.activity.indicator.stop","pdf-indicator")}),c.close=function(){return b.goToLastVisitedState()},f.init()}}}]),angular.module("pdf").directive("twPdfDogear",function(){"use strict";return{restrict:"E",controller:"PdfDogearCtrl",scope:{},templateUrl:"../states/pdf/partials/dogear.tpl.html",link:function(a,b,c,d){d.init(b)}}}),angular.module("pdf").directive("twPdfFooter",function(){"use strict";return{restrict:"E",controller:"PdfFooterCtrl",scope:{},templateUrl:"../states/pdf/partials/footer.tpl.html",link:function(a,b,c,d){d.init(b)}}}),angular.module("pdf").directive("twPdfNavigation",function(){"use strict";return{restrict:"E",controller:"PdfNavigationCtrl",scope:{},templateUrl:"../states/pdf/partials/navigation.tpl.html",link:function(a,b,c,d){d.init(b)}}}),angular.module("pdf").directive("twPdfPager",function(){"use strict";return{restrict:"E",controller:"PdfPagerCtrl",scope:{},templateUrl:"../states/pdf/partials/pager.tpl.html",link:function(a,b,c,d){d.init(b)}}}),angular.module("pdf").directive("twPdfToolbar",function(){"use strict";return{restrict:"E",controller:"PdfToolbarCtrl",scope:{},templateUrl:"../states/pdf/partials/toolbar.tpl.html",link:function(a,b,c,d){d.init(b)}}}),angular.module("pdf").factory("pdfInfo",["$window","$q","$injector","loader","URLManager","time","BaseUtil",function(a,b,c,d,e,f,g){"use strict";var h=1e3,i=null,j=null,k=null,l=null,m=null,n=null,o=0,p=null,q=2,r=!1,s={epuburl:'parameter "epuburl" not available: Unable to show publication sample',purchaseurl:'parameter "purchaseUrl" not available: Unable to purchase the publication',backref:'parameter "backref" not available: Unable to jump back',lang:'parameter "lang" not available: No language setting'},t=function(a){m||(m={}),a.name&&a.messageHandler&&(m[a.name()]=a)},u=function(a){m&&a&&m[a]&&(m[a]=null,delete m[a])},v=function(a,b,c){if(m&&a&&b)for(var d in m)m&&m[d]&&m[d].messageHandler(a,b,c)},w=function(a){r="library"===a},x=function(){return n},y=function(){return o>=2},z=function(){var a=i&&i.dogears;return!!n||a&&a.length>0},A=function(a){var c=b.defer();return a.getOutline().then(function(d){if(d&&d.length&&d.length>0){1===d.length&&d[0].items&&d[0].items.length>0&&(console.warn("The toc of this publication only has one entry. Using child entries instead"),d=d[0].items);for(var e,f=[],g=[],h=0;h<d.length;h++)e={title:d[h].title},o+=1,f.push(C(d[h],a,e)),g.push(e),B(d[h],e,a,f);b.allComplete(f).finally(function(){n=g,v("toolbar","toc.active",z()),c.resolve(g)}).catch(function(a){console.warn("TOC ERROR ->",a&&a.fail)})}else c.reject("no outline")},function(a){c.reject(a)}),c.promise},B=function(a,b,c,d){if(a.items&&a.items.length&&a.items.length>0){b.children=[];for(var e,f=0;f<a.items.length;f++)e={title:a.items[f].title},o+=1,d.push(C(a.items[f],c,e)),b.children.push(e),B(a.items[f],e,c,d)}},C=function(a,c,d){var e=b.defer();return"string"==typeof a.dest?c.getDestination(a.dest).then(function(a){a&&a.length&&a.length>0?c.getPageIndex(a[0]).then(function(a){d.start=a+1,e.resolve()},function(a){e.reject(a)}):e.resolve()},function(a){e.reject(a)}):a.dest&&a.dest.length&&a.dest.length>0?c.getPageIndex(a.dest[0]).then(function(a){d.start=a+1,e.resolve()},function(a){e.reject(a)}):(d.start=-1,o-=1,e.reject("unknown format or destination is empty")),e.promise},D=function(a){if(!r){var b=c.get("$location"),e=b.search();for(var f in s)e[f]||console.warn(s[f]);return i={},k={index:1,isSinglePage:!0,tocEntry:null,numPages:null},d.fetchSample(e.epuburl).then(E)}var h=c.get("inventory"),j=c.get("sync");return g.fetchDeliverable(a).then(function(b){var c=function(){return i=b,k={index:parseInt(F(b),10),isSinglePage:!0,tocEntry:null,numPages:null},d.fetchDeliverable(a,{}).then(E)};return j.sync(h.getDeliverables()).then(c,c)})},E=function(b){if(b&&b.buffer){var d=e.createURL(b.id,b.buffer,"application/pdf");b.buffer=null,j=b&&b.info&&b.info.fileSize;var g=b&&b.crypto,h=null;if(r&&g){var m=c.get("Crypto");m.setDeviceKey(g.devKey);var n=m.decryptPassword(g.key);h={url:d,password:n,length:j}}else h={url:d,length:j};if(!a.PDFJS.workerSrc)for(var o=a.document.getElementsByTagName("script"),q=0;q<o.length;q++){var s=o.item(q)&&o.item(q).src;if(s&&s.indexOf("pdf.js")>-1){var t=s.toString().replace(/\pdf.js/i,"pdf.worker.js");a.PDFJS.workerSrc=t,console.info("Set PDF workerSrc at "+t)}}return a.PDFJS.getDocument(h).then(function(a){return l=a,k.numPages=l.numPages,ba()?v("dogear","set"):v("dogear","remove"),A(a).then(function(b){return k.tocEntry=G(k.index),v("toolbar","toc.active",!0),v("all","toc",b),a},function(){return v("toolbar","toc.active",z()),v("toolbar","buttons",{next:!1,previous:!1}),a}).finally(function(){if(v("all","paging",k),p={numPages:l.numPages,deliverable:i,isLibrary:r},r){var b=c.get("inventory");i.bookmark.modified=f.getTime(),b.saveDeliverable(i.id)}else{var d=c.get("$location"),e=d.search();e.backref||v("toolbar","hide.back")}a.getMetadata().then(function(a){p.metaData=a&&a.info,v("all","info",p)})})})}},F=function(a){var b=a.bookmark.rmsdkPosition;if(b){var c=b.match(/#pdfloc\((.*?),(\d*)\)/);if(c)return c[c.length-1]}return 1},G=function(a){if(n){0===a&&(console.warn("page 0 was requested"),a=1);var b=n[n.length-1];return b&&b.start&&b.start<a?b.title:H(a,n)}},H=function(a,b){for(var c,d=0;d<b.length;d++)if(b[d].start>a&&b[d-1]?c=b[d-1]:b[d].start===a&&(c=b[d]),c){if(c.children&&c.children.length>0){var e=H(a,c.children);return e?e:c}return c}},I=function(){return k},J=function(){return l},K=function(){return p},L=function(a){if(a!==k.index){if(!k.isSinglePage){var b;if(b=k.index%q===1?k.index-1:k.index+1,b===a)return}a>0&&a<=k.numPages&&(k.index=a,V(),ba()?v("dogear","set"):v("dogear","remove"),k.tocEntry=G(k.index),v("all","paging",k),v("reader","render"))}},M=function(){if(k.index<k.numPages){var a;a=k.isSinglePage||k.index===k.numPages-1?k.index+1:k.index+q,L(a)}else L(k.numPages)},N=function(){if(k.index>1){var a;a=k.isSinglePage||2===k.index?k.index-1:k.index-q,L(a)}else L(1)},O=function(a,b){for(var c=null,d=0;d<a.length;d++)if(!(a[d].start<=b)||a[d].children)if(a[d].start<=b&&a[d].children){if(c=O(a[d].children,b))break}else if(a[d].start>b){c=a[d];break}return c},P=function(a,b){for(var c,d=0;d<a.length&&!(a[d].start>=b);d++)a[d].start>0&&(a[d].start<b&&a[d].children?(c=P(a[d].children,b),c||(c=a[d])):a[d].start<b&&(c=a[d]));return c},Q=function(a,b){var c;return b?(c=k.isSinglePage||k.index%q===1?k.index:k.index+1,O(a,c)):(c=k.isSinglePage||k.index%q!==1?k.index:k.index-1,P(a,c))},R=function(){var a,b=k.tocEntry,c=n;c&&b&&(a=Q(c,!0),a&&a.start&&L(a.start))},S=function(){var a,b=k.tocEntry,c=n;c&&b&&(a=Q(c,!1),a&&a.start&&L(a.start))},T=function(a){return a||(a=k.index),j>=0&&a>=0?"#pdfloc("+j.toString(16).substr(-4)+","+a+")":"#pdfloc("+j.toString(16).substr(-4)+",1)"},U=function(){if(r){var a=c.get("inventory");if(i.id){var b=Math.abs(k.index/k.numPages),d=T();if(d){i.bookmark.rmsdkPosition=d,i.bookmark.progress=b,i.bookmark.currentPage=String(k.index),i.bookmark.lastPage=String(k.numPages),i.bookmark.modified=f.getTime(),a.saveDeliverable(i.id);var e=c.get("sync");return e.sync(a.getDeliverables())}}}},V=g.getDebouncedFunction(U,h),W=function(){if(i.id){var a=T();if(a){var b={rmsdkPosition:a,modified:f.getTime(),deleted:!1,displayName:k.index};i.dogears.push(b),i.bookmark.modified=f.getTime(),X(),v("dogear","set"),v("toolbar","toc.active",z())}}},X=function(){if(r){var a=c.get("inventory"),b=c.get("sync");a.saveDeliverable(i.id),g.debounce(function(){return b.sync(a.getDeliverables())},h)}},Y=function(a){if(!i||!i.dogears||0===i.dogears.length)return!1;var b=i.dogears.findIndex(function(b){return ca(b.rmsdkPosition,a)});return b>=0?(i.dogears[b].deleted=!0,i.bookmark.modified=f.getTime(),X(),!0):(console.warn('removeDogEar: No object with position "',a,'" found!'),!1)},Z=function(a){var b=ba();if(Y(a)){var c=ca(a,b)?"remove":"update";v("dogear",c);var d=i&&i.dogears;d&&0!==d.length||v("reader","toc.toggle"),v("toolbar","toc.active",z())}},$=function(a){i.id&&a&&(Y(a),k.isSinglePage||(a=ba(),a&&Y(a)&&console.warn("Removed 2 dogears")),v("dogear","remove"),v("toolbar","toc.active",z()))},_=function(){var a=ba();return a?$(a):W()},aa=function(a){k.isSinglePage=a},ba=function(){if(r){if(i.id){var a=T(),b=i.dogears;if(!k.isSinglePage){var c;c=k.index%q===1?k.index-1:k.index+1,a=T(c);var d=da(a,b);if(d)return d}return a=T(),da(a,b)}return null}},ca=function(a,b){var c=/#pdfloc\(.*,([0-9]*)\)/;if(a&&b){var d=a.match(c),e=b.match(c);if(d&&e)return d[0]===e[0]}return!1},da=function(a,b){if(a&&b)for(var c=0;c<b.length;c++)if(ca(b[c].rmsdkPosition,a)&&!b[c].deleted)return a;return null},ea=function(){return k.numPages-k.index<=4},fa=function(){i&&e.revokeURL(i.id),l&&(l.cleanup(),l.destroy()),h=null,i=null,j=null,l=null,n=null,o=null,k=null,p=null,r=null,m=null},ga=function(a){v("navigation",a)};return{isFinished:ea,handleMouseMove:ga,setState:w,isLibrary:r,registerController:t,unregisterController:u,sendMessage:v,open:D,cleanup:fa,getToc:x,removeBookmark:Z,handleDogearRequest:_,hasDogear:ba,hasTocEntries:y,getNextPage:M,getPreviousPage:N,getNextChapter:R,getPreviousChapter:S,getLoadedPdf:J,getCurrentPage:I,getInfo:K,setSinglePage:aa,jumpToPage:L,MAX_PAGES:q}}]),angular.module("pdf").factory("pdfScroller",["$window","CONFIG","pdfInfo","$timeout",function(a,b,c,d){"use strict";var e=48,f=48,g=b.globals.MISC.TAP_TRESHOLD,h=b.globals.MISC.DOUBLE_TAP_MAX_DELAY,i=b.globals.MISC.SWIPE_TRESHOLD,j=!1,k=null,l=null,m=null,n=null,o=null,p=null,q=null,r=null,s=null,t=null,u=null,v=0,w=null,x=null,y=function(){v+=90,v%=360;var b=a.Modernizr.prefixed("transform");u.style[b]="rotate( "+v+"deg )"},z=function(a){k.scrollTo(0,0,!1),k.zoomTo(1,!1,0,0,a),c.sendMessage("toolbar","zoom",2)},A=function(b,c,d){d<1?m.style.transformOrigin="center center 0":m.style.transformOrigin="left top 0";var e=a.Modernizr.prefixed("transform");m.style[e]="translate3d("+-b+"px,"+-c+"px,0) scale("+d+")"},B=function(a){k.zoomTo(a,!0),c.sendMessage("toolbar","zoom",2*a)},C=function(a,b,c){var d=k.getValues();a||(a=d.left),b||(b=d.top),c||(c=d.zoom),k.scrollTo(a,b,!0,c)},D=function(a){var b=a.changedTouches&&a.changedTouches.length>0?a.changedTouches:a.touches,c=a.screenX||b&&b[0]&&b[0].screenX,d=a.screenY||b&&b[0]&&b[0].screenY,e=c-n,f=d-o,g=Math.abs(e),h=Math.abs(f);if(g>i||h>i){var j=g>h?e<0?"left":"right":f<0?"up":"down";return{direction:j}}return!1},E=function(a){var b=a.changedTouches&&a.changedTouches.length>0?a.changedTouches:a.touches,c=a.screenX||b&&b[0]&&b[0].screenX,d=a.screenY||b&&b[0]&&b[0].screenY;return Math.abs(c-n)>g||Math.abs(d-o)>g},F=function(){var a=window.matchMedia&&window.matchMedia("screen and (min-width: 0px) and (max-width: 479px)").matches,b=a?40:75;return(100-b)/200},G=function(b){if(b.clientY<e)return"top";if(a.innerHeight-b.clientY<f)return"bottom";var c=b.clientX/a.innerWidth;return c<t?"left":c>1-t?"right":"center"},H=function(){console.info("enabled pdf interaction"),"ontouchstart"in a?(l.addEventListener("touchstart",M,!1),l.addEventListener("touchmove",N,!1),l.addEventListener("touchend",O,!1),l.addEventListener("touchcancel",O,!1)):(l.addEventListener(a.normalizeWheel.getEventType(),J,!1),l.addEventListener("mousedown",M,!1),l.addEventListener("mouseup",O,!1),l.addEventListener("mousemove",N,!1),l.addEventListener("mouseleave",O,!1))},I=function(){console.info("disabled pdf interaction"),"ontouchstart"in a?(l.removeEventListener("touchstart",M),l.removeEventListener("touchmove",N),l.removeEventListener("touchend",O),l.removeEventListener("touchcancel",O)):(l.removeEventListener(a.normalizeWheel.getEventType(),J),l.removeEventListener("mousedown",M),l.removeEventListener("mouseup",O),l.removeEventListener("mousemove",N),l.removeEventListener("mouseleave",O))},J=function(b){b.stopPropagation(),b.preventDefault();var d=b.pageX||b.touches&&b.touches[0]&&b.touches[0].pageX,e=b.pageY||b.touches&&b.touches[0]&&b.touches[0].pageY,f=a.normalizeWheel.normalize(b);k.doMouseZoom(f.spinY,b.timeStamp,d,e);var g=k.getValues(),h=f.spinY>0?.97:1.03,i=g.zoom*h;i<.5&&(i=.5),i>3&&(i=3),c.sendMessage("toolbar","zoom",2*i)},K=function(a){if(!a||a.length<2)return null;w.centerX=(a[0].clientX+a[1].clientX)/2,w.centerY=(a[0].clientY+a[1].clientY)/2;var b=a[0].clientX-a[1].clientX,c=a[0].clientY-a[1].clientY;return Math.sqrt(b*b+c*c)},L=function(a){var b=K(a.touches);return a.scale||b/w.initDistance},M=function(a){a.stopPropagation(),a.preventDefault(),j=!0,a.touches&&a.touches.length>1?(w.initDistance=K(a.touches),w.scale=1):w.initDistance=null;var b=k.getValues();b.zoom&&b.zoom<=1?(k.options.locking=!0,k.options.bouncing=!1):(k.options.locking=!1,k.options.bouncing=!0);var c=a.changedTouches&&a.changedTouches.length>0?a.changedTouches:a.touches,d=a.pageX||c&&c[0]&&c[0].pageX,e=a.pageY||c&&c[0]&&c[0].pageY;n=a.screenX||c&&c[0]&&c[0].screenX,o=a.screenY||c&&c[0]&&c[0].screenY,p=G(a),k.doTouchStart([{pageX:d,pageY:e}],a.timeStamp)},N=function(a){a.stopPropagation(),a.preventDefault();var b=a.changedTouches&&a.changedTouches.length>0?a.changedTouches:a.touches,d=a.pageX||b&&b[0]&&b[0].pageX,e=a.pageY||b&&b[0]&&b[0].pageY;if(!j){var f=G(a),g=k.getValues();return void(f===q&&g.zoom===r||(q=f,r=g.zoom,g.zoom&&g.zoom>1?c.handleMouseMove("center"):c.handleMouseMove(f)))}if(E(a)){if(w.initDistance){var h=L(a);return void(Math.abs(h-w.scale)>.001&&(w.scale=h,k.zoomBy(h,!0)))}k.doTouchMove([{pageX:d,pageY:e}],a.timeStamp)}},O=function(a){if(a.stopPropagation(),a.preventDefault(),j){k.doTouchEnd(a.timeStamp),x||(x=a.type);var b=k.getValues(),d=b.zoom&&b.zoom>1,e=a.changedTouches&&a.changedTouches.length>0?a.changedTouches:a.touches,f=a.pageX||e&&e[0]&&e[0].pageX,g=a.pageY||e&&e[0]&&e[0].pageY;if(!w.initDistance)if(E(a)){var i=D(a);i&&i.direction&&!d&&("left"===i.direction&&(z(),c.getNextPage()),"right"===i.direction&&(z(),c.getPreviousPage()))}else s&&a.type===x?(clearTimeout(s),s=null,x=null,d?z():(k.zoomBy(2,!0,f,g),c.sendMessage("toolbar","zoom",4))):a.type===x&&(s=setTimeout(P,h));j=!1}},P=function(){var a=k.getValues(),b=a.zoom&&a.zoom>1;if(s=null,x=null,p)switch(p){case"right":if(b)return c.sendMessage("toolbar","toggle"),d(angular.noop);z(),c.getNextPage();break;case"left":if(b)return c.sendMessage("toolbar","toggle"),d(angular.noop);z(),c.getPreviousPage();break;default:return c.sendMessage("toolbar","toggle"),d(angular.noop)}},Q=function(){k.setDimensions(l.clientWidth,l.clientHeight,m.clientWidth,m.clientHeight)},R=function(b,c,d){l=b,m=c,u=d,t=F(),k=new a.Scroller(A,{zooming:!0,locking:!1}),Q(),w={},H()},S=function(){I(),w=null,u=null,j=!1,l=null,m=null,k=null,p=null,s=null,t=null,v=0,n=null,o=null},T=function(){return v};return{reflow:Q,scrollTo:C,getRotation:T,init:R,zoom:B,rotate:y,resetPosition:z,clear:S}}]),angular.module("read").directive("twReadStateWatcher",["read","$rootScope","$state","stateHelper",function(a,b,c,d){"use strict";return{restrict:"E",link:function(){var e=b.$on("$viewContentLoaded",function(){if(c.includes("read.**")){var b=d.getCurrentState().params;return b&&b.id?a.isInit(b.id)?d.goToState("home"):(a.init(b.id),a.openPublication(b).then(null,function(){return d.goToState("home")})):d.goToState("home")}e()})}}}]),angular.module("read").factory("read",["$q","$rootScope","inventory",function(a,b,c){"use strict";var d=null,e=function(a){return!(!d||d!==a)},f=function(a){d=a},g=function(d){return b.$emit("tw.activity.indicator.start","read"),c.fetchPublications().then(function(){b.$emit("tw.library.open",d.id),b.$emit("tw.activity.indicator.stop","read")},function(c){return b.$emit("tw.activity.indicator.stop","read"),a.reject(c)})};return{isInit:e,init:f,openPublication:g}}]),angular.module("reseller").directive("twResellerButtonList",["$rootScope","reseller","stateHelper",function(a,b,c){"use strict";return{restrict:"E",replace:!1,scope:{},templateUrl:"../states/reseller/reseller-button-list.tpl.html",link:function(d){d.setReseller=function(d){if(d)return a.$emit("tw.activity.indicator.start","reseller"),b.setReseller(d),c.goToLastVisitedState()},d.service=b,d.$on("$destroy",function(){a.$emit("tw.activity.indicator.stop","reseller")})}}}]),angular.module("reseller").directive("twResellerHeader",["reseller","stateHelper",function(a,b){"use strict";return{restrict:"E",replace:!1,scope:{},templateUrl:"../states/reseller/reseller-header.tpl.html",link:function(c){c.country=a.getCountry().country,c.back=function(){return a.fetchCountries().then(function(){return a.unsetCountry(),b.goToState("country").catch(angular.noop)}).catch(angular.noop)}}}}]),angular.module("reseller").directive("twResellerStateWatcher",["$rootScope",function(a){"use strict";return{restrict:"A",link:function(){var b=a.$on("$viewContentLoaded",function(){a.$emit("tw.activity.indicator.stop","reseller"),b()})}}}]),angular.module("search").directive("twAudioView",["$window","$timeout","$rootScope","BaseUtil","search","libraryModel",function(a,b,c,d,e,f){"use strict";return{restrict:"E",replace:!1,scope:{},templateUrl:"../states/search/audio/audio-view.tpl.html",link:function(a){e.isInit()||e.init(),a.deliverables=null,a.libModel=f,a.coverAction=f.openDeliverable;var b=function(){return e.getAudioSearchResults()};a.$watch(b,function(b){a.deliverables=b})}}}]),angular.module("search").filter("audio",[function(){"use strict";return function(a,b){if(!a)return null;if(!b||""===b)return a;b=b.replace(/[-*+?.()[\]{}\\^$|#]/g,"\\$&");var c=new RegExp(b,"gi"),d=function(a){if(a&&"AUDIOBOOK"===a.type){var b="";if(a.title&&(b+=a.title+" "),a.subtitle&&(b+=a.subtitle+" "),a.author&&(b+=a.author+" "),a.reader&&(b+=a.reader+" "),a.speaker&&(b+=a.speaker+" "),b.match(c))return a}};return a.filter(d)}}]),angular.module("search").directive("twBooksView",["$window","$timeout","$rootScope","BaseUtil","search","libraryModel",function(a,b,c,d,e,f){"use strict";return{restrict:"E",replace:!1,scope:{},templateUrl:"../states/search/books/books-view.tpl.html",link:function(a){e.isInit()||e.init(),a.deliverables=null,a.libModel=f,a.coverAction=f.openDeliverable,a.$watch(e.getBookSearchResults,function(b){a.deliverables=b})}}}]),angular.module("search").filter("books",[function(){"use strict";return function(a,b){if(!a)return null;if(!b||""===b)return a;b=b.replace(/[-*+?.()[\]{}\\^$|#]/g,"\\$&");var c=new RegExp(b,"gi"),d=function(a){if(!a||"AUDIOBOOK"===a.type)return!1;var b="";return a.title&&(b+=a.title+" "),a.subtitle&&(b+=a.subtitle+" "),a.author&&(b+=a.author+" "),b.match(c)?a:void 0};return a.filter(d)}}]),angular.module("search").directive("twSearchDeleteDialog",["search",function(a){"use strict";return{restrict:"E",scope:{},template:"<tw-delete-dialog></tw-delete-dialog>",link:function(b){b.$on("delete-dialog-confirm",function(b,c){b.stopPropagation();var d=c&&c.selectedPub;if(d)return a.deletePub(d).finally(function(){d=null})})}}}]),angular.module("search").directive("twSearchBar",["$rootScope","search","stateHelper","$timeout",function(a,b,c,d){"use strict";return{restrict:"E",scope:{},templateUrl:"../states/search/search-header-bar.tpl.html",link:function(e){var f=function(){b.search(""),a.$emit("tw.search.clear")},g=c.getCurrentState().params.searchTerm||"";e.searchInput={searchTerm:g,hasAutoFocus:!0,hasLiveUpdate:!0,cbSearch:b.search,cbClear:f},g&&d(b.search.bind(null,g),400,!0),e.back=function(){f(),c.goToLastKeyState()}}}}]),angular.module("search").directive("twSearchStateWatcher",["search","$rootScope","$state","libraryModel",function(a,b,c,d){"use strict";return{restrict:"A",link:function(){var e=b.$on("$viewContentLoaded",function(){c.includes("search.**")?d.setContextMenuActive(!0):(d.setContextMenuActive(!1),e())}),f=b.$on("$stateChangeSuccess",function(){c.includes("search.**")||(a.reset(),f())})}}}]),angular.module("search").directive("twSearchTabBar",["search","$translate",function(a,b){"use strict";return{restrict:"E",replace:!1,scope:{},templateUrl:"../states/mybooks/mybooks-tab-bar.tpl.html",link:function(c){function d(){var c=a.getBookSearchResults(),d=c?c.length:0;return b.instant(gettext("COMMON_READ"))+" ("+d+")"}function e(){var c=a.getAudioSearchResults(),d=c?c.length:0;return b.instant(gettext("COMMON_LISTEN"))+" ("+d+")"}a.isInit()||a.init(),c.tabsConfig=[{id:"search.books",cbTitle:d},{id:"search.audio",cbTitle:e}]}}}]),angular.module("search").factory("search",["$rootScope","inventory","$filter","delete","stateHelper","$timeout",function(a,b,c,d,e,f){"use strict";var g,h=!1,i=null,j=null,k=null,l=function(){return h=!0,q(!0),b.fetchPublications().then(function(){i=b.getDeliverables(),q(!1)},function(a){return q(!1),e.goToState("sorry",{reason:a})})},m=function(){return h},n=function(){return h=!1,i=null,j=null,k=null,f(angular.noop)},o=function(){return j},p=function(){return k},q=function(b){var c="tw.activity.indicator."+(b?"start":"stop");a.$emit(c,"activity-search")},r=function(a){a?(g=a,j=c("books")(i,a)||[],k=c("audio")(i,a)||[]):k=j=null},s=function(a){return q(!0),d.deleteDeliverables([a]).then(function(){return n(),l().then(function(){return r(g)})})};return{deletePub:s,isInit:m,init:l,reset:n,search:r,getBookSearchResults:o,getAudioSearchResults:p}}]),angular.module("sorry").controller("SorryCtrl",["$window","$scope","reseller",function(a,b,c){"use strict";var d=gettext("SERVER_ERROR_TEXT"),e=gettext("SERVER_ERROR_TITLE"),f=gettext("SERVER_ERROR_TEXT"),g=[],h=function(a,c,g){if("sorry"===c.name&&(b.errorInfo.type=g.type||d,b.errorInfo.headline=g.headline||e,b.errorInfo.message=g.message||f,b.errorInfo.details=g.details||null,b.errorInfo.details&&"object"==typeof b.errorInfo.details))try{b.errorInfo.details=JSON.stringify(b.errorInfo.details)}catch(a){b.errorInfo.details="SorryCtrl: Invalid error details object"}},i=function(){for(var a;a=g.pop();)a();b.translationData=null,b.errorInfo=null,b.showErrorDetails=null,b.iconBtnShowErrorDetails=null};b.translationData={resellerName:""},b.errorInfo={type:null,headline:null,message:null,details:null},b.showErrorDetails=!1,b.iconBtnShowErrorDetails="arrow-down",b.toggleShowErrorDetails=function(){b.showErrorDetails=!b.showErrorDetails,b.iconBtnShowErrorDetails=b.showErrorDetails?"arrow-up":"arrow-down"},b.jumpToDeviceMgmt=function(){return c.fetchConfig().then(function(b){var c=b.URL_HANDSHAKE+"?reseller="+b.reseller_id+"&lang="+b.DEFAULT_LANGUAGE+"&action=logindevicelimit#devices";a.location=c})},g.push(b.$on("$stateChangeSuccess",h)),g.push(b.$on("$destroy",i))}]);